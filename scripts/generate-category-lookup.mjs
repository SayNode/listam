#!/usr/bin/env node
// Generates app/components/categoryTranslations.ts from assets/data/grocery_categories_translated.csv

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const csvPath = path.join(__dirname, '../assets/data/grocery_categories_translated.csv')
const outPath = path.join(__dirname, '../app/components/categoryTranslations.ts')

const LANGS = ['en', 'it', 'de', 'nl', 'es', 'pt', 'fr', 'zh', 'ru', 'ja', 'ko', 'ar', 'hi']

const text = fs.readFileSync(csvPath, 'utf8')
const lines = text.split('\n').filter(l => l.trim())

// Parse header to get column indices
const header = lines[0].split(',')
const colIdx = {}
for (const lang of LANGS) {
    colIdx[`cat_${lang}`] = header.indexOf(`category_${lang}`)
    colIdx[`item_${lang}`] = header.indexOf(`item_${lang}`)
}

// itemToCategory: normalized_item_text -> canonical_en_category
const itemToCategory = {}
// categoryTranslations: en_category -> { lang: translated_category_name }
const categoryTranslations = {}
// langItems: lang -> Set<normalized_item_string> (for language detection)
const langItems = {}
for (const lang of LANGS) langItems[lang] = new Set()

for (let i = 1; i < lines.length; i++) {
    const line = lines[i]
    // Simple CSV split (values have no commas in this dataset)
    const cols = line.split(',')
    if (cols.length < 2) continue

    const enCategory = cols[colIdx['cat_en']]?.trim()
    if (!enCategory) continue

    // Build category translation map for this English category
    if (!categoryTranslations[enCategory]) {
        categoryTranslations[enCategory] = {}
        for (const lang of LANGS) {
            const catVal = cols[colIdx[`cat_${lang}`]]?.trim()
            if (catVal) categoryTranslations[enCategory][lang] = catVal
        }
    }

    // Add all language items to the item lookup and per-language sets
    for (const lang of LANGS) {
        const itemVal = cols[colIdx[`item_${lang}`]]?.trim()
        if (itemVal) {
            const normalized = itemVal.toLowerCase()
            langItems[lang].add(normalized)
            if (!itemToCategory[normalized]) {
                itemToCategory[normalized] = enCategory
            }
        }
    }
}

// Determine canonical category order (same as existing CATEGORY_ORDER)
const KNOWN_ORDER = [
    'Fruits', 'Vegetables', 'Bread & Bakery', 'Deli', 'Meat', 'Fish & Seafood',
    'Dairy', 'Canned Goods', 'Pasta/Rice/Cereal', 'Condiments & Spices', 'Baking',
    'Snacks', 'Beverages', 'Frozen Foods', 'Personal Care', 'Household & Cleaning',
    'Baby Items', 'Pet Care', 'Others',
]

// Log stats
console.log(`Items in lookup: ${Object.keys(itemToCategory).length}`)
console.log(`Categories found: ${Object.keys(categoryTranslations).length}`)
for (const [cat, trans] of Object.entries(categoryTranslations)) {
    console.log(`  ${cat}: ${JSON.stringify(trans)}`)
}

// Generate TypeScript output
const itemEntries = Object.entries(itemToCategory)
    .map(([k, v]) => `    ${JSON.stringify(k)}: ${JSON.stringify(v)},`)
    .join('\n')

const catTransEntries = Object.entries(categoryTranslations)
    .map(([k, v]) => {
        const inner = Object.entries(v).map(([l, n]) => `        ${l}: ${JSON.stringify(n)},`).join('\n')
        return `    ${JSON.stringify(k)}: {\n${inner}\n    },`
    })
    .join('\n')

// Per-language item sets as arrays for language detection
const langItemsEntries = LANGS.map(lang => {
    const items = Array.from(langItems[lang]).map(i => JSON.stringify(i)).join(',')
    return `    ${lang}: new Set([${items}]),`
}).join('\n')

const output = `// AUTO-GENERATED by scripts/generate-category-lookup.mjs â€” do not edit manually
// Source: assets/data/grocery_categories_translated.csv

export const SUPPORTED_LANGS = ${JSON.stringify(LANGS)} as const
export type SupportedLang = typeof SUPPORTED_LANGS[number]

// Maps any item text (in any supported language, lowercased) to its canonical English category key
export const MULTILANG_ITEM_TO_CATEGORY: Record<string, string> = {
${itemEntries}
}

// Maps canonical English category key to translated category names per language
export const CATEGORY_TRANSLATIONS: Record<string, Partial<Record<SupportedLang, string>>> = {
${catTransEntries}
}

// Per-language item sets used for detecting the dominant language from a list of items
export const LANG_ITEM_SETS: Record<SupportedLang, Set<string>> = {
${langItemsEntries}
}
`

fs.writeFileSync(outPath, output)
console.log(`\nWrote ${outPath}`)
console.log(`Item entries: ${itemEntries.split('\n').length}`)
