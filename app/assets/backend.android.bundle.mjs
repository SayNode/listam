// Auto-generated. Do not edit.
const chunks = ["MTAxOTUzCnsidmVyc2lvbiI6MCwiaWQiOiI5NzU3ZDNiZWE4NGYwOTJkMTcwODVhMmEwNWE4NTZjYmJhNTA0ZGVhOTJmNmMzY2M0Y2ExMmEyNTVmZjMyMjg1IiwibWFpbiI6Ii9iYWNrZW5kL2JhY2tlbmQubWpzIiwiaW1wb3J0cyI6e30sInJlc29sdXRpb25zIjp7Ii9iYWNrZW5kL2JhY2tlbmQubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsIi4uL3JwYy1jb21tYW5kcy5tanMiOiIvcnBjLWNvbW1hbmRzLm1qcyIsIi4vbGliL2l0ZW0ubWpzIjoiL2JhY2tlbmQvbGliL2l0ZW0ubWpzIiwiLi9saWIva2V5Lm1qcyI6Ii9iYWNrZW5kL2xpYi9rZXkubWpzIiwiLi9saWIvbmV0d29yay5tanMiOiIvYmFja2VuZC9saWIvbmV0d29yay5tanMiLCIuL2xpYi9zdGF0ZS5tanMiOiIvYmFja2VuZC9saWIvc3RhdGUubWpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJiYXJlLWZzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwiYmFyZS1wYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiLCJiYXJlLXJwYyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvaW5kZXguanMiLCJiYXJlLXVybCI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvaW5kZXguanMifSwiL2JhY2tlbmQvbGliL2l0ZW0ubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsIi4uLy4uL3JwYy1jb21tYW5kcy5tanMiOiIvcnBjLWNvbW1hbmRzLm1qcyIsIi4vc3RhdGUubWpzIjoiL2JhY2tlbmQvbGliL3N0YXRlLm1qcyIsIi4vdXRpbC5tanMiOiIvYmFja2VuZC9saWIvdXRpbC5tanMifSwiL2JhY2tlbmQvbGliL2tleS5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiYmFyZS1mcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyJ9LCIvYmFja2VuZC9saWIvbmV0d29yay5tanMiOnsiI3BhY2thZ2UiOiIvcGFja2FnZS5qc29uIiwiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI6Ii9ycGMtY29tbWFuZHMubWpzIiwiLi4vYmFja2VuZC5tanMiOiIvYmFja2VuZC9iYWNrZW5kLm1qcyIsIi4vaXRlbS5tanMiOiIvYmFja2VuZC9saWIvaXRlbS5tanMiLCIuL2tleS5tanMiOiIvYmFja2VuZC9saWIva2V5Lm1qcyIsIi4vc3RhdGUubWpzIjoiL2JhY2tlbmQvbGliL3N0YXRlLm1qcyIsImF1dG9iYXNlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9pbmRleC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiYmFyZS1mcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsImJsaW5kLXBhaXJpbmciOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXBhaXJpbmcvaW5kZXguanMiLCJjb3Jlc3RvcmUiOiIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcnN3YXJtIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2luZGV4LmpzIiwiejMyIjoiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMifSwiL2JhY2tlbmQvbGliL3N0YXRlLm1qcyI6eyIjcGFja2FnZSI6Ii9wYWNrYWdlLmpzb24ifSwiL2JhY2tlbmQvbGliL3V0aWwubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiIsImJhcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vcGFja2FnZS5qc29uIiwiLi9saWIvYnJpZGdlIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2xpYi9icmlkZ2UuanMiLCIuL2xpYi9oYW5kc2hha2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2hhbmRzaGFrZS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInNvZGl1bS1zZWNyZXRzdHJlYW0iOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1zZWNyZXRzdHJlYW0vaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyIsInRpbWVvdXQtcmVmcmVzaCI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2xpYi9icmlkZ2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vcGFja2FnZS5qc29uIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2hhbmRzaGFrZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5vaXNlLWN1cnZlLWVkIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9pbmRleC5qcyIsIm5vaXNlLWhhbmRzaGFrZSI6Ii9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL25vaXNlLmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9lbmNvZGluZy9sZWdhY3kuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJpbmRleC1lbmNvZGVyIjoiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi4vLi4vbGVnYWN5LmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9lbmNvZGluZy9sZWdhY3kuanMiLCJoeXBlcnNjaGVtYS9ydW50aW1lIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9hY3RpdmUtd3JpdGVycy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FjdGl2ZS13cml0ZXJzLmpzIiwiLi9saWIvYXBwZW5kLWJhdGNoLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwZW5kLWJhdGNoLmpzIiwiLi9saWIvYXBwbHktY2FsbHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1jYWxscy5qcyIsIi4vbGliL2FwcGx5LXN0YXRlLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktc3RhdGUuanMiLCIuL2xpYi9ib290LmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYm9vdC5qcyIsIi4vbGliL2NhcHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIiwiLi9saWIvZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL2xpYi9mYXN0LWZvcndhcmQuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mYXN0LWZvcndhcmQuanMiLCIuL2xpYi9saW5lYXJpemVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbGluZWFyaXplci5qcyIsIi4vbGliL2xvY2FsLXN0YXRlLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbG9jYWwtc3RhdGUuanMiLCIuL2xpYi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiLi9saWIvc3RvcmUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zdG9yZS5qcyIsIi4vbGliL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsIi4vbGliL3RpbWVyLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdGltZXIuanMiLCIuL2xpYi91cGRhdGVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyIsIi4vbGliL3ZhbHVlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3ZhbHVlcy5qcyIsIi4vbGliL3dha2V1cC5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dha2V1cC5qcyIsIi4vbGliL3dyaXRlci5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dyaXRlci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImNvcmUtY291cGxlciI6Ii9ub2RlX21vZHVsZXMvY29yZS1jb3VwbGVyL2luZGV4LmpzIiwiZGVib3VuY2VpZnkiOiIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L2luZGV4LmpzIiwiaHlwZXJjb3JlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvaW5kZXguanMiLCJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJwcm90b211eC13YWtldXAiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInNjb3BlLWxvY2siOiIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svaW5kZXguanMiLCJzaWduYWwtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYWN0aXZlLXdyaXRlcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGVuZC1iYXRjaC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwic2lnbmFsLXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2FwcGx5LWNhbGxzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktc3RhdGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vYXBwbHktY2FsbHMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBseS1jYWxscy5qcyIsIi4vY2Fwcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiLCIuL2VuY3J5cHRpb24uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9lbmNyeXB0aW9uLmpzIiwiLi9mb3JrLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvZm9yay5qcyIsIi4vbG9jYWwtc3RhdGUuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9sb2NhbC1zdGF0ZS5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsIi4vc3lzdGVtLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIiwiLi91cGRhdGVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyIsIi4vdmFsdWVzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdmFsdWVzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYm9vdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jYXBzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJ0aW55LWJ1ZmZlci1tYXAiOiIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jb25zZW5zdXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vY2xvY2suanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jbG9jay5qcyIsInRpbnktYnVmZmVyLW1hcCI6Ii9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vY2Fwcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2NhcHMuanMiLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCIuL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZXNvbHZlLXJlamVjdC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9yZXNvbHZlLXJlamVjdC1wcm9taXNlL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mYXN0LWZvcndhcmQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL3N5c3RlbS5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mb3JrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2VuY3J5cHRpb24uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9lbmNyeXB0aW9uLmpzIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiLi9zeXN0ZW0uanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zeXN0ZW0uanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xpbmVhcml6ZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4vY2xvY2suanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9jbG9jay5qcyIsIi4vY29uc2Vuc3VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY29uc2Vuc3VzLmpzIiwiLi90b3BvbGlzdC5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3RvcG9saXN0LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xvY2FsLXN0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsIi4uL2VuY29kaW5nL3NwZWMvYXV0b2Jhc2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2VuY29kaW5nL3NwZWMvYXV0b2Jhc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbm9kZS1idWZmZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zdG9yZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9tZXNzYWdlcy5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaHlwZXJjb3JlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3N5c3RlbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyYmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJzdWItZW5jb2RlciI6Ii9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdGltZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3RvcG9saXN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvdXBkYXRlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3ZhbHVlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiLi9jYXBzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyIsIi4vZW5jcnlwdGlvbi5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2VuY3J5cHRpb24uanMiLCIuL21lc3NhZ2VzLmpzIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3dha2V1cC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd3JpdGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9wYWNrYWdlLmpzb24iLCIuL2xpbmVhcml6ZXIuanMiOiIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9saW5lYXJpemVyLmpzIiwiLi9ub2RlLWJ1ZmZlci5qcyI6Ii9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL25vZGUtYnVmZmVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iNGEvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYjRhL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpsaWJiYXJlLWNyeXB0by4xLjEyLjAuc28ifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi9saWIvY2lwaGVyIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY2lwaGVyLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIiwiLi9saWIvaGFzaCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2hhc2guanMiLCIuL2xpYi9obWFjIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaG1hYy5qcyIsIi4vbGliL2tleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2tleS5qcyIsIi4vbGliL3Bia2RmMiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3Bia2RmMi5qcyIsIi4vbGliL3JhbmRvbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3JhbmRvbS5qcyIsIi4vbGliL3NpZ25hdHVyZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3NpZ25hdHVyZS5qcyIsIi4vd2ViIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by93ZWIuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY2lwaGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMiLCJiYXJlLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaGFzaC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vYmluZGluZy5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY29uc3RhbnRzLmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2htYWMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyIsImJhcmUtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9rZXkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9wYmtkZjIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9yYW5kb20uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvc2lnbmF0dXJlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9lZDI1NTE5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi8uLi8uLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiLCIuLi8uLi8uLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9iaW5kaW5nLmpzIiwiLi4vLi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIiwiLi4vLi4va2V5IjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIva2V5LmpzIiwiLi4vY3J5cHRvLWtleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vaG1hYy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiLi4vLi4vLi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIiwiLi4vLi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIiwiLi4vY3J5cHRvLWtleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vcGJrZGYyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9wYWNrYWdlLmpzb24iLCIuLi8uLi8uLiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiLCIuLi8uLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMiLCIuLi9jcnlwdG8ta2V5IjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9zaGEuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4uLy4uLy4uIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvY3J5cHRvLWtleS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by93ZWIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiIsIi4iOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2luZGV4LmpzIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvZXJyb3JzLmpzIiwiLi9saWIvd2ViL2FsZ29yaXRobS9lZDI1NTE5IjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9lZDI1NTE5LmpzIiwiLi9saWIvd2ViL2FsZ29yaXRobS9obWFjIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9obWFjLmpzIiwiLi9saWIvd2ViL2FsZ29yaXRobS9wYmtkZjIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL3Bia2RmMi5qcyIsIi4vbGliL3dlYi9hbGdvcml0aG0vc2hhIjoiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9zaGEuanMiLCIuL2xpYi93ZWIvY3J5cHRvLWtleSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9jcnlwdG8ta2V5LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL3BhY2thZ2UuanNvbiIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvbGliL2Vycm9ycy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2xpYi9lcnJvcnMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6bGliYmFyZS1mcy40LjUuMi5zbyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIiwiLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2JpbmRpbmcuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvZXJyb3JzLmpzIiwiLi9wcm9taXNlcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wcm9taXNlcy5qcyIsImJhcmUtZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsImJhcmUtcGF0aCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIiwiYmFyZS11cmwiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2luZGV4LmpzIiwiZmFzdC1maWZvIjoiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiIsImJhcmUtb3MiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9wcm9taXNlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iLCIuIjoiL25vZGVfbW9kdWxlcy9iYXJlLWZzL2luZGV4LmpzIiwiYmFyZS1ldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6bGliYmFyZS1vcy4zLjYuMi5zbyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvcGFja2FnZS5qc29uIiwiLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2JpbmRpbmcuanMiLCIuL2xpYi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9saWIvZXJyb3JzLmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9saWIvY29uc3RhbnRzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvYmluZGluZy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIiwiLi9saWIvcG9zaXgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvcG9zaXguanMiLCIuL2xpYi93aW4zMiI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi93aW4zMi5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvY29uc3RhbnRzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9wb3NpeC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL2NvbnN0YW50cy5qcyIsIi4vc2hhcmVkIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3NoYXJlZC5qcyIsIi4vd2luMzIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvd2luMzIuanMiLCJiYXJlLW9zIjoiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9zaGFyZWQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9jb25zdGFudHMuanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3dpbjMyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvY29uc3RhbnRzLmpzIiwiLi9wb3NpeCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9wb3NpeC5qcyIsIi4vc2hhcmVkIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3NoYXJlZC5qcyIsImJhcmUtb3MiOiIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIiwiLi9saWIvY29tbWFuZC1yb3V0ZXIiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb21tYW5kLXJvdXRlci5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2luY29taW5nLXJlcXVlc3QiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1yZXF1ZXN0LmpzIiwiLi9saWIvaW5jb21pbmctc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvaW5jb21pbmctc3RyZWFtLmpzIiwiLi9saWIvbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9tZXNzYWdlcy5qcyIsIi4vbGliL291dGdvaW5nLXJlcXVlc3QiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1yZXF1ZXN0LmpzIiwiLi9saWIvb3V0Z29pbmctc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvb3V0Z29pbmctc3RyZWFtLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29tbWFuZC1yb3V0ZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvaW5jb21pbmctcmVxdWVzdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9lcnJvcnMuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXN0cmVhbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiLCJiYXJlLXN0cmVhbSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9lcnJvcnMuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL291dGdvaW5nLXJlcXVlc3QuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvZXJyb3JzLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1zdHJlYW0uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLXJwYy9saWIvY29uc3RhbnRzLmpzIiwiYmFyZS1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9iYXJlLXN0cmVhbS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vcGFja2FnZS5qc29uIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvYmluZGluZy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpsaWJiYXJlLXVybC4yLjMuMi5zbyJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9wYWNrYWdlLmpzb24iLCIuL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2JpbmRpbmcuanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi9lcnJvcnMuanMiLCIuL2xpYi91cmwtc2VhcmNoLXBhcmFtcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS11cmwvbGliL3VybC1zZWFyY2gtcGFyYW1zLmpzIiwiYmFyZS1wYXRoIjoiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9saWIvdXJsLXNlYXJjaC1wYXJhbXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ibGluZC1wYWlyaW5nLWNvcmUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXBhaXJpbmctY29yZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXBhaXJpbmctY29yZS9saWIvZXJyb3JzLmpzIiwiLi9saWIvbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXBhaXJpbmctY29yZS9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ibGluZC1wYWlyaW5nLWNvcmUvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcGFpcmluZy1jb3JlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXBhaXJpbmctY29yZS9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXBhaXJpbmctY29yZS9wYWNrYWdlLmpzb24iLCJib2dvbiI6Ii9ub2RlX21vZHVsZXMvYm9nb24vaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcGFpcmluZy1jb3JlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmxpbmQtcGFpcmluZy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcGFpcmluZy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJsaW5kLXBhaXJpbmctY29yZSI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcGFpcmluZy1jb3JlL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImRlYm91bmNlaWZ5IjoiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJpcy1vcHRpb25zIjoiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL2luZGV4LmpzIiwicHJvdG9tdXgiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ4YWNoZSI6Ii9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ibGluZC1wYWlyaW5nL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L3BhY2thZ2UuanNvbiIsIi4vbGliL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvbGliL2Vycm9ycy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiYml0cy10by1ieXRlcyI6Ii9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsInByb3RvbXV4IjoiL25vZGVfbW9kdWxlcy9wcm90b211eC9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ib2dvbi9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvYm9nb24vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZy1uZXQiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvYm9nb24vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9jb2RlY3MvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvZGVjcy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvZGVjcy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9lbmRpYW4uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9wYWNrYWdlLmpzb24iLCIuL2VuZGlhbiI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9lbmRpYW4uanMiLCIuL2xleGludCI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9sZXhpbnQuanMiLCIuL3JhdyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9yYXcuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvbGV4aW50LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3Jhdy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9wYWNrYWdlLmpzb24iLCIuL2VuZGlhbiI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9lbmRpYW4uanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2NvcmUtY291cGxlci9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29yZS1jb3VwbGVyL3BhY2thZ2UuanNvbiIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvY29yZS1jb3VwbGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvY29yZXN0b3JlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvcGFja2FnZS5qc29uIiwiLi9saWIvYXVkaXQuanMiOiIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9saWIvYXVkaXQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImh5cGVyY29yZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJ3aGljaC1ydW50aW1lIjoiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvY29yZXN0b3JlL2xpYi9hdWRpdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvY29yZXN0b3JlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2NvcmVzdG9yZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2RldmljZS1maWxlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kZXZpY2UtZmlsZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZkLWxvY2siOiIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svaW5kZXguanMiLCJmcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsImZzLW5hdGl2ZS1leHRlbnNpb25zIjoiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9pbmRleC5qcyIsInBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyIsInJlYWR5LXJlc291cmNlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2RldmljZS1maWxlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24iLCIuL2xpYi9jb21tYW5kcyI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvY29tbWFuZHMuanMiLCIuL2xpYi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2Vycm9ycy5qcyIsIi4vbGliL2lvIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9pby5qcyIsIi4vbGliL3BlZXIiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3BlZXIuanMiLCIuL2xpYi9xdWVyeSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcXVlcnkuanMiLCIuL2xpYi9zZXNzaW9uIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9zZXNzaW9uLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsImthZGVtbGlhLXJvdXRpbmctdGFibGUiOiIvbm9kZV9tb2R1bGVzL2thZGVtbGlhLXJvdXRpbmctdGFibGUvaW5kZXguanMiLCJuYXQtc2FtcGxlciI6Ii9ub2RlX21vZHVsZXMvbmF0LXNhbXBsZXIvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIiwidGltZS1vcmRlcmVkLXNldCI6Ii9ub2RlX21vZHVsZXMvdGltZS1vcmRlcmVkLXNldC9pbmRleC5qcyIsInVkeC1uYXRpdmUiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3VkeC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2NvbW1hbmRzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2Vycm9ycy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9pby5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24iLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvZXJyb3JzLmpzIiwiLi9wZWVyIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9wZWVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZmFzdC1maWZvIjoiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcGVlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nLW5ldCI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvcXVlcnkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIiwiLi9jb21tYW5kcyI6Ii9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvY29tbWFuZHMuanMiLCIuL3BlZXIiOiIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3BlZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9zZXNzaW9uLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ldmVudHMtdW5pdmVyc2FsL2JhcmUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwiYmFyZS1ldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9maXhlZC1zaXplLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vcGFja2FnZS5qc29uIiwiLi9maXhlZC1zaXplIjoiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vZml4ZWQtc2l6ZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2ZkLWxvY2svcGFja2FnZS5qc29uIiwiZnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiLCJmcy1uYXRpdmUtZXh0ZW5zaW9ucyI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZXNvdXJjZS1vbi1leGl0IjoiL25vZGVfbW9kdWxlcy9yZXNvdXJjZS1vbi1leGl0L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvZmQtbG9jay9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6bGliZnMtbmF0aXZlLWV4dGVuc2lvbnMuMS40LjUuc28iLCJyZXF1aXJlLWFkZG9uIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIn0sIi9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvYmluZGluZy5qcyIsIndoaWNoLXJ1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iLCIuL2l0ZXJhdG9ycy9kaWZmIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvZGlmZi5qcyIsIi4vaXRlcmF0b3JzL2hpc3RvcnkiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9oaXN0b3J5LmpzIiwiLi9pdGVyYXRvcnMvbG9jYWwiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9sb2NhbC5qcyIsIi4vaXRlcmF0b3JzL3JhbmdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvcmFuZ2UuanMiLCIuL2xpYi9leHRlbnNpb24iOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9leHRlbnNpb24uanMiLCIuL2xpYi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvbGliL21lc3NhZ2VzLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb2RlY3MiOiIvbm9kZV9tb2R1bGVzL2NvZGVjcy9pbmRleC5qcyIsImRlYm91bmNlaWZ5IjoiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJtdXRleGlmeS9wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wcm9taXNlLmpzIiwicmFjaGUiOiIvbm9kZV9tb2R1bGVzL3JhY2hlL2luZGV4LmpzIiwicmVhZHktcmVzb3VyY2UiOiIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2RpZmYuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2hpc3RvcnkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9sb2NhbC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL3JhbmdlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9leHRlbnNpb24uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL3BhY2thZ2UuanNvbiIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9tZXNzYWdlcy5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJwcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncyI6Ii9ub2RlX21vZHVsZXMvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL3BhY2thZ2UuanNvbiIsImh5cGVyY29yZS1pZC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiejMyIjoiL25vZGVfbW9kdWxlcy96MzIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiLi9saWIva2V5cy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2tleXMuanMiLCIuL2xpYi9zdHJlYW1zLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvc3RyZWFtcy5qcyIsIi4vbGliL3R4LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdHguanMiLCIuL2xpYi92aWV3LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyIsIi4vbWlncmF0aW9ucy8wIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9taWdyYXRpb25zLzAvaW5kZXguanMiLCJkZXZpY2UtZmlsZSI6Ii9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvaW5kZXguanMiLCJmcyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1mcy9pbmRleC5qcyIsInBhdGgiOiIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9pbmRleC5qcyIsInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiLCJyb2Nrc2RiLW5hdGl2ZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvaW5kZXguanMiLCJzY29wZS1sb2NrIjoiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuL2tleXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9rZXlzLmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9jbG9zZS1lcnJvci1zdHJlYW0uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsInN0cmVhbXgiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiaW5kZXgtZW5jb2RlciI6Ii9ub2RlX21vZHVsZXMvaW5kZXgtZW5jb2Rlci9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi9zdHJlYW1zLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuLi9zcGVjL2h5cGVyc2NoZW1hIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIiwiLi9ibG9jay1kZXBlbmRlbmN5LXN0cmVhbS5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzIiwiLi9rZXlzLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3R4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuLi9zcGVjL2h5cGVyc2NoZW1hIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIiwiLi9rZXlzLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIva2V5cy5qcyIsIi4vdmlldy5qcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3ZpZXcuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL3ZpZXcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL3BhY2thZ2UuanNvbiIsIi4vY2xvc2UtZXJyb3Itc3RyZWFtLmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvY2xvc2UtZXJyb3Itc3RyZWFtLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCIuLi8uLi9saWIvdHguanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi90eC5qcyIsIi4uLy4uL2xpYi92aWV3LmpzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvdmlldy5qcyIsIi4vbWVzc2FnZXMuanMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiZnMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwicGF0aCI6Ii9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9tZXNzYWdlcy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iLCJoeXBlcnNjaGVtYS9ydW50aW1lIjoiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vbGliL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsIi4vbGliL2NvcmUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29yZS5qcyIsIi4vbGliL2RlZmF1bHQtZW5jcnlwdGlvbiI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiLCIuL2xpYi9kb3dubG9hZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kb3dubG9hZC5qcyIsIi4vbGliL2luZm8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaW5mby5qcyIsIi4vbGliL2luc3BlY3QiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaW5zcGVjdC5qcyIsIi4vbGliL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9saWIvcmVwbGljYXRvciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZXBsaWNhdG9yLmpzIiwiLi9saWIvc3RyZWFtcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zdHJlYW1zLmpzIiwiLi9saWIvdmVyaWZpZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvdmVyaWZpZXIuanMiLCJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtc3RvcmFnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvaW5kZXguanMiLCJpcy1vcHRpb25zIjoiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL2luZGV4LmpzIiwicHJvdG9tdXgiOiIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYXVkaXQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2JpdC1pbnRlcmx1ZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NvbXBhdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0ZmllbGQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NvbXBhdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb21wYXQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJpZy1zcGFyc2UtYXJyYXkiOiIvbm9kZV9tb2R1bGVzL2JpZy1zcGFyc2UtYXJyYXkvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NhcHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29tcGF0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwicXVpY2tiaXQtdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMiLCJxdWlja2JpdC11bml2ZXJzYWwvZmFsbGJhY2siOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjay5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29weS1wcm9sb2d1ZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vYml0ZmllbGQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvYml0ZmllbGQuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInF1aWNrYml0LXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3JlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9hdWRpdCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9hdWRpdC5qcyIsIi4vYml0LWludGVybHVkZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXQtaW50ZXJsdWRlLmpzIiwiLi9iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyIsIi4vY29weS1wcm9sb2d1ZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3B5LXByb2xvZ3VlLmpzIiwiLi9tZXJrbGUtdHJlZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXJrbGUtdHJlZS5qcyIsIi4vbXV0ZXgiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiLCIuL3JlbW90ZS1iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZW1vdGUtYml0ZmllbGQuanMiLCIuL3JlcGxpY2F0b3IiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVwbGljYXRvci5qcyIsIi4vc2Vzc2lvbi1zdGF0ZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zZXNzaW9uLXN0YXRlLmpzIiwiLi92ZXJpZmllciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi92ZXJpZmllci5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyIsInozMiI6Ii9ub2RlX21vZHVsZXMvejMyL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9kZWZhdWx0LWVuY3J5cHRpb24uanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2Rvd25sb2FkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9ob3Rzd2FwLXF1ZXVlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbmZvLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9pbnNwZWN0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9jYXBzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NhcHMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXVsdGlzaWcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsImZsYXQtdHJlZSI6Ii9ub2RlX21vZHVsZXMvZmxhdC10cmVlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdXRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVjZWl2ZXItcXVldWUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCJmYXN0LWZpZm8iOiIvbm9kZV9tb2R1bGVzL2Zhc3QtZmlmby9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVtb3RlLWJpdGZpZWxkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9jb21wYXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY29tcGF0LmpzIiwiYmlnLXNwYXJzZS1hcnJheSI6Ii9ub2RlX21vZHVsZXMvYmlnLXNwYXJzZS1hcnJheS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVwbGljYXRvci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiIsIi4vY2FwcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jYXBzLmpzIiwiLi9ob3Rzd2FwLXF1ZXVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2hvdHN3YXAtcXVldWUuanMiLCIuL21lcmtsZS10cmVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL21lcmtsZS10cmVlLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyIsIi4vbXV0ZXgiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbXV0ZXguanMiLCIuL3JlY2VpdmVyLXF1ZXVlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3JlY2VpdmVyLXF1ZXVlLmpzIiwiLi9yZW1vdGUtYml0ZmllbGQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVtb3RlLWJpdGZpZWxkLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1lcnJvcnMvaW5kZXguanMiLCJyYW5kb20tYXJyYXktaXRlcmF0b3IiOiIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zZXNzaW9uLXN0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwiLi9iaXRmaWVsZCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyIsIi4vbWVya2xlLXRyZWUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVya2xlLXRyZWUuanMiLCIuL211dGV4IjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211dGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJmbGF0LXRyZWUiOiIvbm9kZV9tb2R1bGVzL2ZsYXQtdHJlZS9pbmRleC5qcyIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMiLCJoeXBlcmNvcmUtZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIiwibmFub2Fzc2VydCI6Ii9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyIsInF1aWNrYml0LXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9zdHJlYW1zLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvcGFja2FnZS5qc29uIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvdmVyaWZpZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iLCIuL2NhcHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvY2Fwcy5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvbWVzc2FnZXMuanMiLCIuL211bHRpc2lnIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211bHRpc2lnLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwiZmxhdC10cmVlIjoiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiLCJoeXBlcmNvcmUtY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtY3J5cHRvL2luZGV4LmpzIiwiaHlwZXJjb3JlLWVycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9pbmRleC5qcyIsInVuc2xhYiI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vbGliL2Nvbm5lY3QiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0LmpzIiwiLi9saWIvY29ubmVjdGlvbi1wb29sIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdGlvbi1wb29sLmpzIiwiLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9saWIvY3J5cHRvIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY3J5cHRvLmpzIiwiLi9saWIvZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9saWIvbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsIi4vbGliL3BlcnNpc3RlbnQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9wZXJzaXN0ZW50LmpzIiwiLi9saWIvcmF3LXN0cmVhbS1zZXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9yYXctc3RyZWFtLXNldC5qcyIsIi4vbGliL3JvdXRlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3JvdXRlci5qcyIsIi4vbGliL3NlcnZlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlcnZlci5qcyIsIi4vbGliL3NvY2tldC1wb29sIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc29ja2V0LXBvb2wuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJkaHQtcnBjIjoiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2luZGV4LmpzIiwiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtaWQtZW5jb2RpbmcvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJ4YWNoZSI6Ii9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvYW5ub3VuY2VyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyIsIi4vZW5jb2RlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZW5jb2RlLmpzIiwiLi9tZXNzYWdlcyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL21lc3NhZ2VzLmpzIiwiLi9wZXJzaXN0ZW50IjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvcGVyc2lzdGVudC5qcyIsIi4vc2xlZXBlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NsZWVwZXIuanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMiLCJzaWduYWwtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvc2lnbmFsLXByb21pc2UvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2NyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NyeXB0by5qcyIsIi4vZXJyb3JzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIiwiLi9ob2xlcHVuY2hlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2hvbGVwdW5jaGVyLmpzIiwiLi9ub2lzZS13cmFwIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbm9pc2Utd3JhcC5qcyIsIi4vc2VjdXJlLXBheWxvYWQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZWN1cmUtcGF5bG9hZC5qcyIsIi4vc2VtYXBob3JlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VtYXBob3JlLmpzIiwiLi9zbGVlcGVyIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyIsIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vaW5kZXguanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImJsaW5kLXJlbGF5IjoiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9pbmRleC5qcyIsImJvZ29uIjoiL25vZGVfbW9kdWxlcy9ib2dvbi9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29ubmVjdGlvbi1wb29sLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImh5cGVyY29yZS1jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY3J5cHRvLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZW5jb2RlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvZXJyb3JzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvaG9sZXB1bmNoZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9uYXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9uYXQuanMiLCIuL3NsZWVwZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zbGVlcGVyLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nLW5ldCI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1uZXQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbmF0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuLi9saWIvY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25vaXNlLXdyYXAuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9lcnJvcnMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwibm9pc2UtY3VydmUtZWQiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL2luZGV4LmpzIiwibm9pc2UtaGFuZHNoYWtlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3BlcnNpc3RlbnQuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9lbmNvZGUiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lbmNvZGUuanMiLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJyZWNvcmQtY2FjaGUiOiIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyIsInhhY2hlIjoiL25vZGVfbW9kdWxlcy94YWNoZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9yYXctc3RyZWFtLXNldC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3JvdXRlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25zdGFudHMuanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsIi4vbWVzc2FnZXMiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9tZXNzYWdlcy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwieGFjaGUiOiIvbm9kZV9tb2R1bGVzL3hhY2hlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlY3VyZS1wYXlsb2FkLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL21lc3NhZ2VzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VtYXBob3JlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VydmVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCIuL2Fubm91bmNlciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Fubm91bmNlci5qcyIsIi4vY29uc3RhbnRzIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY29uc3RhbnRzLmpzIiwiLi9jcnlwdG8iOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jcnlwdG8uanMiLCIuL2Vycm9ycyI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Vycm9ycy5qcyIsIi4vaG9sZXB1bmNoZXIiOiIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9ob2xlcHVuY2hlci5qcyIsIi4vbm9pc2Utd3JhcCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25vaXNlLXdyYXAuanMiLCIuL3NlY3VyZS1wYXlsb2FkIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2VjdXJlLXBheWxvYWQuanMiLCJAaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtIjoiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL2luZGV4LmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJibGluZC1yZWxheSI6Ii9ub2RlX21vZHVsZXMvYmxpbmQtcmVsYXkvaW5kZXguanMiLCJib2dvbiI6Ii9ub2RlX21vZHVsZXMvYm9nb24vaW5kZXguanMiLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIiwic2FmZXR5LWNhdGNoIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc2xlZXBlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NvY2tldC1wb29sLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcGFja2FnZS5qc29uIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiLi9saWIvY29ubmVjdGlvbi1zZXQiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2Nvbm5lY3Rpb24tc2V0LmpzIiwiLi9saWIvcGVlci1kaXNjb3ZlcnkiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItZGlzY292ZXJ5LmpzIiwiLi9saWIvcGVlci1pbmZvIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9wZWVyLWluZm8uanMiLCIuL2xpYi9yZXRyeS10aW1lciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcmV0cnktdGltZXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJoeXBlcmRodCI6Ii9ub2RlX21vZHVsZXMvaHlwZXJkaHQvaW5kZXguanMiLCJzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSI6Ii9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL2xpYi9idWxrLXRpbWVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2Nvbm5lY3Rpb24tc2V0LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1kaXNjb3ZlcnkuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzYWZldHktY2F0Y2giOiIvbm9kZV9tb2R1bGVzL3NhZmV0eS1jYXRjaC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3BlZXItaW5mby5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsImV2ZW50cyI6Ii9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvaW5kZXguanMiLCJ1bnNsYWIiOiIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3JldHJ5LXRpbWVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9oeXBlcnN3YXJtL3BhY2thZ2UuanNvbiIsIi4vYnVsay10aW1lciI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvYnVsay10aW1lci5qcyJ9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9pbmRleC1lbmNvZGVyL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvaW5kZXgtZW5jb2Rlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL2lzLW9wdGlvbnMvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9wYWNrYWdlLmpzb24iLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMva2FkZW1saWEtcm91dGluZy10YWJsZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL211dGV4aWZ5L2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wYWNrYWdlLmpzb24iLCJxdWV1ZS10aWNrIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3Byb2Nlc3MtbmV4dC10aWNrLmpzIn0sIi9ub2RlX21vZHVsZXMvbXV0ZXhpZnkvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wcm9taXNlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wYWNrYWdlLmpzb24iLCIuIjoiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25hdC1zYW1wbGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9uYXQtc2FtcGxlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWN1cnZlLWVkL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1jdXJ2ZS1lZC9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvY2lwaGVyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJzb2RpdW0tdW5pdmVyc2FsIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tdW5pdmVyc2FsL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2RoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9oa2RmLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiLi9obWFjIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvaG1hYy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2htYWMuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvbm9pc2UuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iLCIuL2hrZGYiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9oa2RmLmpzIiwiLi9zeW1tZXRyaWMtc3RhdGUiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9zeW1tZXRyaWMtc3RhdGUuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsIm5hbm9hc3NlcnQiOiIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvc3ltbWV0cmljLXN0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvcGFja2FnZS5qc29uIiwiLi9jaXBoZXIiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9jaXBoZXIuanMiLCIuL2RoIjoiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvZGguanMiLCIuL2hrZGYiOiIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9oa2RmLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJuYW5vYXNzZXJ0IjoiL25vZGVfbW9kdWxlcy9uYW5vYXNzZXJ0L2luZGV4LmpzIiwic29kaXVtLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNpZ25lZC12YXJpbnQiOiIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvaW5kZXguanMiLCJ2YXJpbnQiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvcGFja2FnZS5qc29uIiwiLi9zcGVjL2h5cGVyc2NoZW1hIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvc3BlYy9oeXBlcnNjaGVtYS9pbmRleC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiaHlwZXJjb3JlLWNyeXB0byI6Ii9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyIsInByb3RvbXV4IjoiL25vZGVfbW9kdWxlcy9wcm90b211eC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9wcm90b211eC13YWtldXAvcGFja2FnZS5qc29uIiwiaHlwZXJzY2hlbWEvcnVudGltZSI6Ii9ub2RlX21vZHVsZXMvaHlwZXJzY2hlbWEvcnVudGltZS5janMifSwiL25vZGVfbW9kdWxlcy9wcm90b211eC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcHJvdG9tdXgvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb21wYWN0LWVuY29kaW5nIjoiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL2luZGV4LmpzIiwicXVldWUtdGljayI6Ii9ub2RlX21vZHVsZXMvcXVldWUtdGljay9wcm9jZXNzLW5leHQtdGljay5qcyIsInNhZmV0eS1jYXRjaCI6Ii9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIiwidW5zbGFiIjoiL25vZGVfbW9kdWxlcy91bnNsYWIvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9wcm90b211eC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3Byb2Nlc3MtbmV4dC10aWNrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3BhY2thZ2UuanNvbiIsIi4vcXVldWUtbWljcm90YXNrIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3F1ZXVlLW1pY3JvdGFzay5qcyJ9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcXVldWUtbWljcm90YXNrLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvcGFja2FnZS5qc29uIiwiLiI6ImxpbmtlZDpsaWJxdWlja2JpdC1uYXRpdmUuMi40Ljguc28iLCJyZXF1aXJlLWFkZG9uIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIn0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvYmluZGluZy5qcyJ9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9mYWxsYmFjay5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcXVpY2tiaXQtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiIsInNpbWRsZS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCIuL2ZhbGxiYWNrIjoiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvZmFsbGJhY2suanMiLCJxdWlja2JpdC1uYXRpdmUiOiIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3JhY2hlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yYWNoZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9yYWNoZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JhbmRvbS1hcnJheS1pdGVyYXRvci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yZWFkeS1yZXNvdXJjZS9wYWNrYWdlLmpzb24iLCJldmVudHMiOiIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9yZWNvcmQtY2FjaGUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3JlZmNvdW50ZXIvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JlZmNvdW50ZXIvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcmVmY291bnRlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Jlc291cmNlLW9uLWV4aXQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Jlc291cmNlLW9uLWV4aXQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2JpbmRpbmcuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6bGlicm9ja3NkYi1uYXRpdmUuMy4xMS40LnNvIiwicmVxdWlyZS1hZGRvbiI6Ii9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuL2xpYi9jb2x1bW4tZmFtaWx5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyIsIi4vbGliL2NvbnN0YW50cyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyIsIi4vbGliL2ZpbHRlci1wb2xpY3kiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIiwiLi9saWIvaXRlcmF0b3IiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9pdGVyYXRvci5qcyIsIi4vbGliL3NuYXBzaG90IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvc25hcHNob3QuanMiLCIuL2xpYi9zdGF0ZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2JhdGNoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiY29tcGFjdC1lbmNvZGluZyI6Ii9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb2x1bW4tZmFtaWx5LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiLi9jb25zdGFudHMiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb25zdGFudHMuanMiLCIuL2ZpbHRlci1wb2xpY3kiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2NvbnN0YW50cy5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2ZpbHRlci1wb2xpY3kuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9pdGVyYXRvci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvcGFja2FnZS5qc29uIiwiLi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJzdHJlYW14IjoiL25vZGVfbW9kdWxlcy9zdHJlYW14L2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3NuYXBzaG90LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIn0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL3N0YXRlLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9iaW5kaW5nLmpzIiwiLi9iYXRjaCI6Ii9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2JhdGNoLmpzIiwiLi9jb2x1bW4tZmFtaWx5IjoiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9saWIvY29sdW1uLWZhbWlseS5qcyIsImNvbXBhY3QtZW5jb2RpbmciOiIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiLCJyZWFkeS1yZXNvdXJjZSI6Ii9ub2RlX21vZHVsZXMvcmVhZHktcmVzb3VyY2UvaW5kZXguanMiLCJyZWZjb3VudGVyIjoiL25vZGVfbW9kdWxlcy9yZWZjb3VudGVyL2luZGV4LmpzIiwicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6Ii9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyIsInNpZ25hbC1wcm9taXNlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zYWZldHktY2F0Y2gvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9zY29wZS1sb2NrL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlL3BhY2thZ2UuanNvbiIsInVub3JkZXJlZC1zZXQiOiIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpZ25hbC1wcm9taXNlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpZ25lZC12YXJpbnQvcGFja2FnZS5qc29uIiwidmFyaW50IjoiL25vZGVfbW9kdWxlcy92YXJpbnQvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6bGlic2ltZGxlLW5hdGl2ZS4xLjMuOS5zbyIsInJlcXVpcmUtYWRkb24iOiIvbm9kZV9tb2R1bGVzL3JlcXVpcmUtYWRkb24vbGliL2JhcmUuanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4vYmluZGluZyI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9iaW5kaW5nLmpzIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9mYWxsYmFjay5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCIuL3NjYWxhciI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9zY2FsYXIuanMiLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIiwiLi9mYWxsYmFjayI6Ii9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9mYWxsYmFjay5qcyIsInNpbWRsZS1uYXRpdmUiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9zY2FsYXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3NpbWRsZS11bml2ZXJzYWwvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6bGlic29kaXVtLW5hdGl2ZS41LjAuMTAuc28iLCJyZXF1aXJlLWFkZG9uIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvYmluZGluZy5qcyIsIndoaWNoLXJ1bnRpbWUiOiIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyIsInNvZGl1bS11bml2ZXJzYWwiOiIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tc2VjcmV0c3RyZWFtL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iLCJzb2RpdW0tbmF0aXZlIjoiL25vZGVfbW9kdWxlcy9zb2RpdW0tbmF0aXZlL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvcGFja2FnZS5qc29uIiwiZXZlbnRzLXVuaXZlcnNhbCI6Ii9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9iYXJlLmpzIiwiZmFzdC1maWZvIjoiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vaW5kZXguanMiLCJ0ZXh0LWRlY29kZXIiOiIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvcGFja2FnZS5qc29uIjp7fSwiL25vZGVfbW9kdWxlcy9zdWItZW5jb2Rlci9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMiLCJjb2RlY3MiOiIvbm9kZV9tb2R1bGVzL2NvZGVjcy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3N1Yi1lbmNvZGVyL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvcGFja2FnZS5qc29uIiwiLi9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIiOiIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiLCIuL2xpYi91dGY4LWRlY29kZXIiOiIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvdXRmOC1kZWNvZGVyLmpzIn0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2xpYi9wYXNzLXRocm91Z2gtZGVjb2Rlci5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2xpYi91dGY4LWRlY29kZXIuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9wYWNrYWdlLmpzb24iLCJiNGEiOiIvbm9kZV9tb2R1bGVzL2I0YS9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3RpbWUtb3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdGltZS1vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9icm93c2VyLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvcGFja2FnZS5qc29uIiwiLi9icm93c2VyIjoiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvYnJvd3Nlci5qcyIsIi4vbm9kZSI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL25vZGUuanMifSwiL25vZGVfbW9kdWxlcy90aW1lb3V0LXJlZnJlc2gvbm9kZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdGlueS1idWZmZXItbWFwL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9iaW5kaW5nLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4iOiJsaW5rZWQ6bGlidWR4LW5hdGl2ZS4xLjE5LjIuc28iLCJyZXF1aXJlLWFkZG9uIjoiL25vZGVfbW9kdWxlcy9yZXF1aXJlLWFkZG9uL2xpYi9iYXJlLmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvaXAuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvbmV0d29yay1pbnRlcmZhY2VzLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL3BhY2thZ2UuanNvbiIsIi4uL2JpbmRpbmciOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvYmluZGluZy5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3NvY2tldC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiLCIuL2lwIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwiZXZlbnRzIjoiL25vZGVfbW9kdWxlcy9iYXJlLWV2ZW50cy9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3N0cmVhbS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiLCIuL2lwIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIiwic3RyZWFteCI6Ii9ub2RlX21vZHVsZXMvc3RyZWFteC9pbmRleC5qcyJ9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3VkeC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iLCIuLi9iaW5kaW5nIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiLCIuL2lwIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9pcC5qcyIsIi4vbmV0d29yay1pbnRlcmZhY2VzIjoiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9uZXR3b3JrLWludGVyZmFjZXMuanMiLCIuL3NvY2tldCI6Ii9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc29ja2V0LmpzIiwiLi9zdHJlYW0iOiIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL3N0cmVhbS5qcyIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9wYWNrYWdlLmpzb24iOnt9LCIvbm9kZV9tb2R1bGVzL3Vuc2xhYi9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdW5zbGFiL3BhY2thZ2UuanNvbiIsImI0YSI6Ii9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIn0sIi9ub2RlX21vZHVsZXMvdW5zbGFiL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvdmFyaW50L2RlY29kZS5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9lbmNvZGUuanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy92YXJpbnQvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9wYWNrYWdlLmpzb24iLCIuL2RlY29kZS5qcyI6Ii9ub2RlX21vZHVsZXMvdmFyaW50L2RlY29kZS5qcyIsIi4vZW5jb2RlLmpzIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvZW5jb2RlLmpzIiwiLi9sZW5ndGguanMiOiIvbm9kZV9tb2R1bGVzL3ZhcmludC9sZW5ndGguanMifSwiL25vZGVfbW9kdWxlcy92YXJpbnQvbGVuZ3RoLmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy92YXJpbnQvcGFja2FnZS5qc29uIn0sIi9ub2RlX21vZHVsZXMvdmFyaW50L3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9pbmRleC5qcyI6eyIjcGFja2FnZSI6Ii9ub2RlX21vZHVsZXMvd2hpY2gtcnVudGltZS9wYWNrYWdlLmpzb24ifSwiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMiOnsiI3BhY2thZ2UiOiIvbm9kZV9tb2R1bGVzL3hhY2hlL3BhY2thZ2UuanNvbiJ9LCIvbm9kZV9tb2R1bGVzL3hhY2hlL3BhY2thZ2UuanNvbiI6e30sIi9ub2RlX21vZHVsZXMvejMyL2luZGV4LmpzIjp7IiNwYWNrYWdlIjoiL25vZGVfbW9kdWxlcy96MzIvcGFja2FnZS5qc29uIiwiYjRhIjoiL25vZGVfbW9kdWxlcy9iNGEvaW5kZXguanMifSwiL25vZGVfbW9kdWxlcy96MzIvcGFja2FnZS5qc29uIjp7fSwiL3BhY2thZ2UuanNvbiI6e30sIi9ycGMtY29tbWFuZHMubWpzIjp7IiNwYWNrYWdlIjoiL3BhY2thZ2UuanNvbiJ9fSwiYWRkb25zIjpbImxpbmtlZDpsaWJiYXJlLWNyeXB0by4xLjEyLjAuc28iLCJsaW5rZWQ6bGliYmFyZS1mcy40LjUuMi5zbyIsImxpbmtlZDpsaWJiYXJlLW9zLjMuNi4yLnNvIiwibGlua2VkOmxpYmJhcmUtdXJsLjIuMy4yLnNvIiwibGlua2VkOmxpYmZzLW5hdGl2ZS1leHRlbnNpb25zLjEuNC41LnNvIiwibGlua2VkOmxpYnF1aWNrYml0LW5hdGl2ZS4yLjQuOC5zbyIsImxpbmtlZDpsaWJyb2Nrc2RiLW5hdGl2ZS4zLjExLjQuc28iLCJsaW5rZWQ6bGlic2ltZGxlLW5hdGl2ZS4xLjMuOS5zbyIsImxpbmtlZDpsaWJzb2RpdW0tbmF0aXZlLjUuMC4xMC5zbyIsImxpbmtlZDpsaWJ1ZHgtbmF0aXZlLjEuMTkuMi5zbyJdLCJhc3NldHMiOltdLCJmaWxlcyI6eyIvYmFja2VuZC9iYWNrZW5kLm1qcyI6eyJvZmZzZXQiOjAsImxlbmd0aCI6MTEzMzYsIm1vZGUiOjQyMH0sIi9iYWNrZW5kL2xpYi9pdGVtLm1qcyI6eyJvZmZzZXQiOjExMzM2LCJsZW5ndGgiOjg1NjgsIm1vZGUiOjQyMH0sIi9iYWNrZW5kL2xpYi9rZXkubWpzIjp7Im9mZnNldCI6MTk5MDQsImxlbmd0aCI6NDEwMCwibW9kZSI6NDIwfSwiL2JhY2tlbmQvbGliL25ldHdvcmsubWpzIjp7Im9mZnNldCI6MjQwMDQsImxlbmd0aCI6MTUwODMsIm1vZGUiOjQyMH0sIi9iYWNrZW5kL2xpYi9zdGF0ZS5tanMiOnsib2Zmc2V0IjozOTA4NywibGVuZ3RoIjoyMzk1LCJtb2RlIjo0MjB9LCIvYmFja2VuZC9saWIvdXRpbC5tanMiOnsib2Zmc2V0Ijo0MTQ4MiwibGVuZ3RoIjoxNjQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9pbmRleC5qcyI6eyJvZmZzZXQiOjQxNjQ2LCJsZW5ndGgiOjE2NzIyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0vbGliL2JyaWRnZS5qcyI6eyJvZmZzZXQiOjU4MzY4LCJsZW5ndGgiOjEyNzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbS9saWIvaGFuZHNoYWtlLmpzIjp7Im9mZnNldCI6NTk2NDEsImxlbmd0aCI6MTk1MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9AaHlwZXJzd2FybS9zZWNyZXQtc3RyZWFtL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjYxNTkxLCJsZW5ndGgiOjExMzIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvZW5jb2RpbmcvbGVnYWN5LmpzIjp7Im9mZnNldCI6NjI3MjMsImxlbmd0aCI6ODg0OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9lbmNvZGluZy9zcGVjL2F1dG9iYXNlL2luZGV4LmpzIjp7Im9mZnNldCI6NzE1NzEsImxlbmd0aCI6MTg5MTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvaW5kZXguanMiOnsib2Zmc2V0Ijo5MDQ4OSwibGVuZ3RoIjo1ODE0OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYWN0aXZlLXdyaXRlcnMuanMiOnsib2Zmc2V0IjoxNDg2MzcsImxlbmd0aCI6NzM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9hcHBlbmQtYmF0Y2guanMiOnsib2Zmc2V0IjoxNDkzNzMsImxlbmd0aCI6MTQyNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktY2FsbHMuanMiOnsib2Zmc2V0IjoxNTA3OTksImxlbmd0aCI6MjI3NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvYXBwbHktc3RhdGUuanMiOnsib2Zmc2V0IjoxNTMwNzQsImxlbmd0aCI6NDUyMzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Jvb3QuanMiOnsib2Zmc2V0IjoxOTgzMTAsImxlbmd0aCI6MzQ2MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY2Fwcy5qcyI6eyJvZmZzZXQiOjIwMTc3MSwibGVuZ3RoIjo1MDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Nsb2NrLmpzIjp7Im9mZnNldCI6MjAyMjc2LCJsZW5ndGgiOjc0OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvY29uc2Vuc3VzLmpzIjp7Im9mZnNldCI6MjAzMDI1LCJsZW5ndGgiOjExNzU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9lbmNyeXB0aW9uLmpzIjp7Im9mZnNldCI6MjE0Nzc5LCJsZW5ndGgiOjk0NDQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2Zhc3QtZm9yd2FyZC5qcyI6eyJvZmZzZXQiOjIyNDIyMywibGVuZ3RoIjo1NzE0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9mb3JrLmpzIjp7Im9mZnNldCI6MjI5OTM3LCJsZW5ndGgiOjQyMzAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL2xpbmVhcml6ZXIuanMiOnsib2Zmc2V0IjoyMzQxNjcsImxlbmd0aCI6OTY5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbG9jYWwtc3RhdGUuanMiOnsib2Zmc2V0IjoyNDM4NjMsImxlbmd0aCI6MjAxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0IjoyNDU4NzYsImxlbmd0aCI6ODI3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9ub2RlLWJ1ZmZlci5qcyI6eyJvZmZzZXQiOjI0NjcwMywibGVuZ3RoIjoxNTYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi9zdG9yZS5qcyI6eyJvZmZzZXQiOjI0ODI2NiwibGVuZ3RoIjoxNDEwNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvc3lzdGVtLmpzIjp7Im9mZnNldCI6MjYyMzczLCJsZW5ndGgiOjIwMTc2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90aW1lci5qcyI6eyJvZmZzZXQiOjI4MjU0OSwibGVuZ3RoIjoyOTM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi90b3BvbGlzdC5qcyI6eyJvZmZzZXQiOjI4NTQ4NiwibGVuZ3RoIjo1MTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi91cGRhdGVzLmpzIjp7Im9mZnNldCI6MjkwNTk0LCJsZW5ndGgiOjExNDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvbGliL3ZhbHVlcy5qcyI6eyJvZmZzZXQiOjI5MTc0MiwibGVuZ3RoIjoxNTM5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2F1dG9iYXNlL2xpYi93YWtldXAuanMiOnsib2Zmc2V0IjoyOTMyODEsImxlbmd0aCI6NDAzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9hdXRvYmFzZS9saWIvd3JpdGVyLmpzIjp7Im9mZnNldCI6Mjk3MzE1LCJsZW5ndGgiOjg5MDEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYXV0b2Jhc2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MzA2MjE2LCJsZW5ndGgiOjIyNDksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYjRhL2luZGV4LmpzIjp7Im9mZnNldCI6MzA4NDY1LCJsZW5ndGgiOjQwNTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYjRhL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjMxMjUxOSwibGVuZ3RoIjoxMTQwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2JpbmRpbmcuanMiOnsib2Zmc2V0IjozMTM2NTksImxlbmd0aCI6MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vaW5kZXguanMiOnsib2Zmc2V0IjozMTM2OTIsImxlbmd0aCI6MTYxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvY2lwaGVyLmpzIjp7Im9mZnNldCI6MzE1MzAzLCJsZW5ndGgiOjczNjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjMyMjY2OSwibGVuZ3RoIjoyMzEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0IjozMjQ5ODIsImxlbmd0aCI6OTU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9oYXNoLmpzIjp7Im9mZnNldCI6MzI1OTM5LCJsZW5ndGgiOjgyOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvaG1hYy5qcyI6eyJvZmZzZXQiOjMyNjc2OCwibGVuZ3RoIjoxMDE1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi9rZXkuanMiOnsib2Zmc2V0IjozMjc3ODMsImxlbmd0aCI6MTA2NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcGJrZGYyLmpzIjp7Im9mZnNldCI6MzI4ODUwLCJsZW5ndGgiOjcxMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvcmFuZG9tLmpzIjp7Im9mZnNldCI6MzI5NTYzLCJsZW5ndGgiOjE3MDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3NpZ25hdHVyZS5qcyI6eyJvZmZzZXQiOjMzMTI3MCwibGVuZ3RoIjoxMDEwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL2xpYi93ZWIvYWxnb3JpdGhtL2VkMjU1MTkuanMiOnsib2Zmc2V0IjozMzIyODAsImxlbmd0aCI6NjkxOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2FsZ29yaXRobS9obWFjLmpzIjp7Im9mZnNldCI6MzM5MTk4LCJsZW5ndGgiOjQ5MjUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vcGJrZGYyLmpzIjp7Im9mZnNldCI6MzQ0MTIzLCJsZW5ndGgiOjE0NjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1jcnlwdG8vbGliL3dlYi9hbGdvcml0aG0vc2hhLmpzIjp7Im9mZnNldCI6MzQ1NTkwLCJsZW5ndGgiOjI5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWNyeXB0by9saWIvd2ViL2NyeXB0by1rZXkuanMiOnsib2Zmc2V0IjozNDU4ODksImxlbmd0aCI6OTcwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjM0Njg1OSwibGVuZ3RoIjoxNDc1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtY3J5cHRvL3dlYi5qcyI6eyJvZmZzZXQiOjM0ODMzNCwibGVuZ3RoIjo3MzkzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZXZlbnRzL2luZGV4LmpzIjp7Im9mZnNldCI6MzU1NzI3LCJsZW5ndGgiOjgwMzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjM2Mzc2MCwibGVuZ3RoIjo2NzEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ldmVudHMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MzY0NDMxLCJsZW5ndGgiOjEzOTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MzY1ODMwLCJsZW5ndGgiOjMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtZnMvaW5kZXguanMiOnsib2Zmc2V0IjozNjU4NjMsImxlbmd0aCI6NDgyNjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDE0MTMwLCJsZW5ndGgiOjE0OTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9saWIvZXJyb3JzLmpzIjp7Im9mZnNldCI6NDE1NjI0LCJsZW5ndGgiOjExNjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1mcy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0MTY3ODcsImxlbmd0aCI6MTU0NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLWZzL3Byb21pc2VzLmpzIjp7Im9mZnNldCI6NDE4MzMzLCJsZW5ndGgiOjE4NjYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9iaW5kaW5nLmpzIjp7Im9mZnNldCI6NDIwMTk5LCJsZW5ndGgiOjMzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvaW5kZXguanMiOnsib2Zmc2V0Ijo0MjAyMzIsImxlbmd0aCI6MjQzMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLW9zL2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0Ijo0MjI2NjUsImxlbmd0aCI6MTEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtb3MvbGliL2Vycm9ycy5qcyI6eyJvZmZzZXQiOjQyMjc3OCwibGVuZ3RoIjo0NzksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1vcy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0MjMyNTcsImxlbmd0aCI6MTAyMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvaW5kZXguanMiOnsib2Zmc2V0Ijo0MjQyODAsImxlbmd0aCI6MzA2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9saWIvY29uc3RhbnRzLmpzIjp7Im9mZnNldCI6NDI0NTg2LCJsZW5ndGgiOjI0NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3Bvc2l4LmpzIjp7Im9mZnNldCI6NDI0ODMzLCJsZW5ndGgiOjU5OTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1wYXRoL2xpYi9zaGFyZWQuanMiOnsib2Zmc2V0Ijo0MzA4MjQsImxlbmd0aCI6MTg4OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXBhdGgvbGliL3dpbjMyLmpzIjp7Im9mZnNldCI6NDMyNzEyLCJsZW5ndGgiOjEzNDI3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcGF0aC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo0NDYxMzksImxlbmd0aCI6Nzk2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2luZGV4LmpzIjp7Im9mZnNldCI6NDQ2OTM1LCJsZW5ndGgiOjEwMTk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb21tYW5kLXJvdXRlci5qcyI6eyJvZmZzZXQiOjQ1NzEzNCwibGVuZ3RoIjoxMDczLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0Ijo0NTgyMDcsImxlbmd0aCI6MjcwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo0NTg0NzcsImxlbmd0aCI6NTk3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9pbmNvbWluZy1yZXF1ZXN0LmpzIjp7Im9mZnNldCI6NDU5MDc0LCJsZW5ndGgiOjEyNDEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL2luY29taW5nLXN0cmVhbS5qcyI6eyJvZmZzZXQiOjQ2MDMxNSwibGVuZ3RoIjoxMjYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjQ2MTU3OCwibGVuZ3RoIjozOTM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL2xpYi9vdXRnb2luZy1yZXF1ZXN0LmpzIjp7Im9mZnNldCI6NDY1NTEyLCJsZW5ndGgiOjE2NzAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1ycGMvbGliL291dGdvaW5nLXN0cmVhbS5qcyI6eyJvZmZzZXQiOjQ2NzE4MiwibGVuZ3RoIjoyMzc0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtcnBjL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjQ2OTU1NiwibGVuZ3RoIjoxMjA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtc3RyZWFtL2luZGV4LmpzIjp7Im9mZnNldCI6NDcwNzY0LCJsZW5ndGgiOjc2NTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS1zdHJlYW0vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NDc4NDIyLCJsZW5ndGgiOjEzMDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmFyZS11cmwvYmluZGluZy5qcyI6eyJvZmZzZXQiOjQ3OTcyOSwibGVuZ3RoIjozMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iYXJlLXVybC9pbmRleC5qcyI6eyJvZmZzZXQiOjQ3OTc2MiwibGVuZ3RoIjo5MjYxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo0ODkwMjMsImxlbmd0aCI6Nzc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL2xpYi91cmwtc2VhcmNoLXBhcmFtcy5qcyI6eyJvZmZzZXQiOjQ4OTgwMSwibGVuZ3RoIjozODY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JhcmUtdXJsL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjQ5MzY2OCwibGVuZ3RoIjoxMTA1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JpZy1zcGFyc2UtYXJyYXkvaW5kZXguanMiOnsib2Zmc2V0Ijo0OTQ3NzMsImxlbmd0aCI6MjQ3MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9iaWctc3BhcnNlLWFycmF5L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjQ5NzI0NCwibGVuZ3RoIjo2MzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYml0cy10by1ieXRlcy9pbmRleC5qcyI6eyJvZmZzZXQiOjQ5Nzg4MCwibGVuZ3RoIjozMDgzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JpdHMtdG8tYnl0ZXMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTAwOTYzLCJsZW5ndGgiOjcwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ibGluZC1wYWlyaW5nLWNvcmUvaW5kZXguanMiOnsib2Zmc2V0Ijo1MDE2NzEsImxlbmd0aCI6MTA5NjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcGFpcmluZy1jb3JlL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo1MTI2MzIsImxlbmd0aCI6NzI1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXBhaXJpbmctY29yZS9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0Ijo1MTMzNTcsImxlbmd0aCI6NTkyOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ibGluZC1wYWlyaW5nLWNvcmUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTE5Mjg1LCJsZW5ndGgiOjEwNjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvYmxpbmQtcGFpcmluZy9pbmRleC5qcyI6eyJvZmZzZXQiOjUyMDM0OCwibGVuZ3RoIjoxNjkxMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ibGluZC1wYWlyaW5nL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjUzNzI1OCwibGVuZ3RoIjoxMDAwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2luZGV4LmpzIjp7Im9mZnNldCI6NTM4MjU4LCJsZW5ndGgiOjEwODUxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JsaW5kLXJlbGF5L2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo1NDkxMDksImxlbmd0aCI6MTA0MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ibGluZC1yZWxheS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo1NTAxNTIsImxlbmd0aCI6MTA0NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ib2dvbi9pbmRleC5qcyI6eyJvZmZzZXQiOjU1MTE5OCwibGVuZ3RoIjozOTYxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2JvZ29uL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU1NTE1OSwibGVuZ3RoIjo2NTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29kZWNzL2luZGV4LmpzIjp7Im9mZnNldCI6NTU1ODE2LCJsZW5ndGgiOjI0MTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29kZWNzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU1ODIzMiwibGVuZ3RoIjo2NTUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZC9pbmRleC5qcyI6eyJvZmZzZXQiOjU1ODg4NywibGVuZ3RoIjoxOTYzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NTYwODUwLCJsZW5ndGgiOjgyNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nLW5ldC9pbmRleC5qcyI6eyJvZmZzZXQiOjU2MTY3NywibGVuZ3RoIjo0MTA5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmctbmV0L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU2NTc4NiwibGVuZ3RoIjo3MzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9lbmRpYW4uanMiOnsib2Zmc2V0Ijo1NjY1MjAsImxlbmd0aCI6MTA1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2NvbXBhY3QtZW5jb2RpbmcvaW5kZXguanMiOnsib2Zmc2V0Ijo1NjY2MjUsImxlbmd0aCI6MjM2MzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9sZXhpbnQuanMiOnsib2Zmc2V0Ijo1OTAyNTksImxlbmd0aCI6Mjg1MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb21wYWN0LWVuY29kaW5nL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjU5MzExMCwibGVuZ3RoIjo4MDEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29tcGFjdC1lbmNvZGluZy9yYXcuanMiOnsib2Zmc2V0Ijo1OTM5MTEsImxlbmd0aCI6NDA5MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvaW5kZXguanMiOnsib2Zmc2V0Ijo1OTgwMDQsImxlbmd0aCI6MjI0MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb3JlLWNvdXBsZXIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NjAwMjQ3LCJsZW5ndGgiOjU5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9jb3Jlc3RvcmUvaW5kZXguanMiOnsib2Zmc2V0Ijo2MDA4NDYsImxlbmd0aCI6MTc4NjIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29yZXN0b3JlL2xpYi9hdWRpdC5qcyI6eyJvZmZzZXQiOjYxODcwOCwibGVuZ3RoIjo0NzUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvY29yZXN0b3JlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjYxOTE4MywibGVuZ3RoIjoxMDg1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RlYm91bmNlaWZ5L2luZGV4LmpzIjp7Im9mZnNldCI6NjIwMjY4LCJsZW5ndGgiOjU4NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kZWJvdW5jZWlmeS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2MjA4NTMsImxlbmd0aCI6NTY3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RldmljZS1maWxlL2luZGV4LmpzIjp7Im9mZnNldCI6NjIxNDIwLCJsZW5ndGgiOjU5MDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGV2aWNlLWZpbGUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NjI3MzIwLCJsZW5ndGgiOjEwNjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9pbmRleC5qcyI6eyJvZmZzZXQiOjYyODM4MywibGVuZ3RoIjoyNTQwMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9jb21tYW5kcy5qcyI6eyJvZmZzZXQiOjY1Mzc4NiwibGVuZ3RoIjo4MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9kaHQtcnBjL2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0Ijo2NTM4NjgsImxlbmd0aCI6NzE5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL2lvLmpzIjp7Im9mZnNldCI6NjU0NTg3LCJsZW5ndGgiOjE1OTI2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3BlZXIuanMiOnsib2Zmc2V0Ijo2NzA1MTMsImxlbmd0aCI6NjMxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvbGliL3F1ZXJ5LmpzIjp7Im9mZnNldCI6NjcxMTQ0LCJsZW5ndGgiOjk5MTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZGh0LXJwYy9saWIvc2Vzc2lvbi5qcyI6eyJvZmZzZXQiOjY4MTA1NywibGVuZ3RoIjoxMTAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2RodC1ycGMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NjgyMTYwLCJsZW5ndGgiOjEzNTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZXZlbnRzLXVuaXZlcnNhbC9iYXJlLmpzIjp7Im9mZnNldCI6NjgzNTE2LCJsZW5ndGgiOjQwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2V2ZW50cy11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NjgzNTU2LCJsZW5ndGgiOjkwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vZml4ZWQtc2l6ZS5qcyI6eyJvZmZzZXQiOjY4NDQ2NCwibGVuZ3RoIjo4NzUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZmFzdC1maWZvL2luZGV4LmpzIjp7Im9mZnNldCI6Njg1MzM5LCJsZW5ndGgiOjk3MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mYXN0LWZpZm8vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6Njg2MzExLCJsZW5ndGgiOjY4MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mZC1sb2NrL2luZGV4LmpzIjp7Im9mZnNldCI6Njg2OTkzLCJsZW5ndGgiOjE2NjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZmQtbG9jay9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo2ODg2NTQsImxlbmd0aCI6MTA5OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvaW5kZXguanMiOnsib2Zmc2V0Ijo2ODk3NTMsImxlbmd0aCI6ODE2NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mbGF0LXRyZWUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6Njk3OTE3LCJsZW5ndGgiOjYzMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9iaW5kaW5nLmpzIjp7Im9mZnNldCI6Njk4NTQ4LCJsZW5ndGgiOjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2ZzLW5hdGl2ZS1leHRlbnNpb25zL2luZGV4LmpzIjp7Im9mZnNldCI6Njk4NjM4LCJsZW5ndGgiOjU3MTgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvZnMtbmF0aXZlLWV4dGVuc2lvbnMvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6NzA0MzU2LCJsZW5ndGgiOjE2OTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaW5kZXguanMiOnsib2Zmc2V0Ijo3MDYwNTUsImxlbmd0aCI6NDYxMjAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvaXRlcmF0b3JzL2RpZmYuanMiOnsib2Zmc2V0Ijo3NTIxNzUsImxlbmd0aCI6NTM2OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9pdGVyYXRvcnMvaGlzdG9yeS5qcyI6eyJvZmZzZXQiOjc1NzU0MywibGVuZ3RoIjoxNjQyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9sb2NhbC5qcyI6eyJvZmZzZXQiOjc1OTE4NSwibGVuZ3RoIjoxMTgwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2l0ZXJhdG9ycy9yYW5nZS5qcyI6eyJvZmZzZXQiOjc2MDM2NSwibGVuZ3RoIjo0NzM0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyYmVlL2xpYi9leHRlbnNpb24uanMiOnsib2Zmc2V0Ijo3NjUwOTksImxlbmd0aCI6MzQ0NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmJlZS9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0Ijo3Njg1NDQsImxlbmd0aCI6MjgxNjIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJiZWUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6Nzk2NzA2LCJsZW5ndGgiOjEyMTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWNyeXB0by9pbmRleC5qcyI6eyJvZmZzZXQiOjc5NzkyMiwibGVuZ3RoIjo1MDQwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1jcnlwdG8vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6ODAyOTYyLCJsZW5ndGgiOjc3MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtZXJyb3JzL2luZGV4LmpzIjp7Im9mZnNldCI6ODAzNzMzLCJsZW5ndGgiOjQ4OTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWVycm9ycy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo4MDg2MjksImxlbmd0aCI6Njg4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1pZC1lbmNvZGluZy9pbmRleC5qcyI6eyJvZmZzZXQiOjgwOTMxNywibGVuZ3RoIjo5MjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLWlkLWVuY29kaW5nL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjgxMDI0MCwibGVuZ3RoIjo3OTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvaW5kZXguanMiOnsib2Zmc2V0Ijo4MTEwMzksImxlbmd0aCI6Mjc1NTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Jsb2NrLWRlcGVuZGVuY3ktc3RyZWFtLmpzIjp7Im9mZnNldCI6ODM4NTkwLCJsZW5ndGgiOjI1NTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2Nsb3NlLWVycm9yLXN0cmVhbS5qcyI6eyJvZmZzZXQiOjg0MTE0NywibGVuZ3RoIjoyNzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbGliL2tleXMuanMiOnsib2Zmc2V0Ijo4NDE0MjMsImxlbmd0aCI6NzQ1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9saWIvc3RyZWFtcy5qcyI6eyJvZmZzZXQiOjg0ODg3NywibGVuZ3RoIjo0ODIwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi90eC5qcyI6eyJvZmZzZXQiOjg1MzY5NywibGVuZ3RoIjo4NDE2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL2xpYi92aWV3LmpzIjp7Im9mZnNldCI6ODYyMTEzLCJsZW5ndGgiOjgzNzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlLXN0b3JhZ2UvbWlncmF0aW9ucy8wL2luZGV4LmpzIjp7Im9mZnNldCI6ODcwNDkxLCJsZW5ndGgiOjIwMTI1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS1zdG9yYWdlL21pZ3JhdGlvbnMvMC9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjg5MDYxNiwibGVuZ3RoIjoyNjIxMCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0Ijo5MTY4MjYsImxlbmd0aCI6MTI0OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUtc3RvcmFnZS9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIjp7Im9mZnNldCI6OTE4MDc0LCJsZW5ndGgiOjEzMTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9pbmRleC5qcyI6eyJvZmZzZXQiOjkzMTE4MiwibGVuZ3RoIjozMzg1NSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2F1ZGl0LmpzIjp7Im9mZnNldCI6OTY1MDM3LCJsZW5ndGgiOjM4MzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXQtaW50ZXJsdWRlLmpzIjp7Im9mZnNldCI6OTY4ODcxLCJsZW5ndGgiOjQyNTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9iaXRmaWVsZC5qcyI6eyJvZmZzZXQiOjk3MzEyOCwibGVuZ3RoIjoxMTg1NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NhcHMuanMiOnsib2Zmc2V0Ijo5ODQ5ODIsImxlbmd0aCI6MTUzNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2NvbXBhdC5qcyI6eyJvZmZzZXQiOjk4NjUxOSwibGVuZ3RoIjo0NzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3B5LXByb2xvZ3VlLmpzIjp7Im9mZnNldCI6OTg2OTk2LCJsZW5ndGgiOjU5OTksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9jb3JlLmpzIjp7Im9mZnNldCI6OTkyOTk1LCJsZW5ndGgiOjI0NDE5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvZGVmYXVsdC1lbmNyeXB0aW9uLmpzIjp7Im9mZnNldCI6MTAxNzQxNCwibGVuZ3RoIjozNDUzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvZG93bmxvYWQuanMiOnsib2Zmc2V0IjoxMDIwODY3LCJsZW5ndGgiOjEyNzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9ob3Rzd2FwLXF1ZXVlLmpzIjp7Im9mZnNldCI6MTAyMjE0NSwibGVuZ3RoIjoxNDk4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvaW5mby5qcyI6eyJvZmZzZXQiOjEwMjM2NDMsImxlbmd0aCI6MTUxNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL2luc3BlY3QuanMiOnsib2Zmc2V0IjoxMDI1MTYwLCJsZW5ndGgiOjE5ODMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXJrbGUtdHJlZS5qcyI6eyJvZmZzZXQiOjEwMjcxNDMsImxlbmd0aCI6MzM5MTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tZXNzYWdlcy5qcyI6eyJvZmZzZXQiOjEwNjEwNTMsImxlbmd0aCI6Mjc2MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcyI6eyJvZmZzZXQiOjEwODg2ODYsImxlbmd0aCI6Mjg1MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL211dGV4LmpzIjp7Im9mZnNldCI6MTA5MTUzNywibGVuZ3RoIjoxMDI4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvcmVjZWl2ZXItcXVldWUuanMiOnsib2Zmc2V0IjoxMDkyNTY1LCJsZW5ndGgiOjE0MTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZW1vdGUtYml0ZmllbGQuanMiOnsib2Zmc2V0IjoxMDkzOTc4LCJsZW5ndGgiOjgwNzksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJjb3JlL2xpYi9yZXBsaWNhdG9yLmpzIjp7Im9mZnNldCI6MTEwMjA1NywibGVuZ3RoIjo4MDc4MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3Nlc3Npb24tc3RhdGUuanMiOnsib2Zmc2V0IjoxMTgyODM4LCJsZW5ndGgiOjMyMjI1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9saWIvc3RyZWFtcy5qcyI6eyJvZmZzZXQiOjEyMTUwNjMsImxlbmd0aCI6MzAzNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmNvcmUvbGliL3ZlcmlmaWVyLmpzIjp7Im9mZnNldCI6MTIxODA5NywibGVuZ3RoIjo5Njc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyY29yZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxMjI3Nzc1LCJsZW5ndGgiOjIxOTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvaW5kZXguanMiOnsib2Zmc2V0IjoxMjI5OTcyLCJsZW5ndGgiOjE2MDk5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9hbm5vdW5jZXIuanMiOnsib2Zmc2V0IjoxMjQ2MDcxLCJsZW5ndGgiOjc1MzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2Nvbm5lY3QuanMiOnsib2Zmc2V0IjoxMjUzNjA0LCJsZW5ndGgiOjIzNjY4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9jb25uZWN0aW9uLXBvb2wuanMiOnsib2Zmc2V0IjoxMjc3MjcyLCJsZW5ndGgiOjMwNTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2NvbnN0YW50cy5qcyI6eyJvZmZzZXQiOjEyODAzMjIsImxlbmd0aCI6MTIxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvY3J5cHRvLmpzIjp7Im9mZnNldCI6MTI4MTUzMywibGVuZ3RoIjo2MzIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2VuY29kZS5qcyI6eyJvZmZzZXQiOjEyODIxNjUsImxlbmd0aCI6NDQ2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9lcnJvcnMuanMiOnsib2Zmc2V0IjoxMjgyNjExLCJsZW5ndGgiOjM3MTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL2hvbGVwdW5jaGVyLmpzIjp7Im9mZnNldCI6MTI4NjMyMywibGVuZ3RoIjoxMDAwMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvbWVzc2FnZXMuanMiOnsib2Zmc2V0IjoxMjk2MzI2LCJsZW5ndGgiOjExMjY2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9uYXQuanMiOnsib2Zmc2V0IjoxMzA3NTkyLCJsZW5ndGgiOjQ3MTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL25vaXNlLXdyYXAuanMiOnsib2Zmc2V0IjoxMzEyMzA2LCJsZW5ndGgiOjE2NjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3BlcnNpc3RlbnQuanMiOnsib2Zmc2V0IjoxMzEzOTc1LCJsZW5ndGgiOjgwODYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3Jhdy1zdHJlYW0tc2V0LmpzIjp7Im9mZnNldCI6MTMyMjA2MSwibGVuZ3RoIjoxNTExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9yb3V0ZXIuanMiOnsib2Zmc2V0IjoxMzIzNTcyLCJsZW5ndGgiOjY5NzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlY3VyZS1wYXlsb2FkLmpzIjp7Im9mZnNldCI6MTMzMDU1MCwibGVuZ3RoIjoxNDkxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyZGh0L2xpYi9zZW1hcGhvcmUuanMiOnsib2Zmc2V0IjoxMzMyMDQxLCJsZW5ndGgiOjE1NzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NlcnZlci5qcyI6eyJvZmZzZXQiOjEzMzM2MTgsImxlbmd0aCI6MjExNTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvbGliL3NsZWVwZXIuanMiOnsib2Zmc2V0IjoxMzU0Nzc0LCJsZW5ndGgiOjY5MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcmRodC9saWIvc29ja2V0LXBvb2wuanMiOnsib2Zmc2V0IjoxMzU1NDY0LCJsZW5ndGgiOjQzNDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJkaHQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTM1OTgwNywibGVuZ3RoIjoyMDExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc2NoZW1hL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjEzNjE4MTgsImxlbmd0aCI6MTU1NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9oeXBlcnNjaGVtYS9ydW50aW1lLmNqcyI6eyJvZmZzZXQiOjEzNjMzNzQsImxlbmd0aCI6NTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9pbmRleC5qcyI6eyJvZmZzZXQiOjEzNjM0MjgsImxlbmd0aCI6MTg0MjksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvYnVsay10aW1lci5qcyI6eyJvZmZzZXQiOjEzODE4NTcsImxlbmd0aCI6NzI4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL2Nvbm5lY3Rpb24tc2V0LmpzIjp7Im9mZnNldCI6MTM4MjU4NSwibGVuZ3RoIjo4MjMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1kaXNjb3ZlcnkuanMiOnsib2Zmc2V0IjoxMzgzNDA4LCJsZW5ndGgiOjkyODYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaHlwZXJzd2FybS9saWIvcGVlci1pbmZvLmpzIjp7Im9mZnNldCI6MTM5MjY5NCwibGVuZ3RoIjoyNjg4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vbGliL3JldHJ5LXRpbWVyLmpzIjp7Im9mZnNldCI6MTM5NTM4MiwibGVuZ3RoIjoxODg5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2h5cGVyc3dhcm0vcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTM5NzI3MSwibGVuZ3RoIjoxMjI4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2luZGV4LWVuY29kZXIvaW5kZXguanMiOnsib2Zmc2V0IjoxMzk4NDk5LCJsZW5ndGgiOjY3NjIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaW5kZXgtZW5jb2Rlci9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDA1MjYxLCJsZW5ndGgiOjcyOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9pcy1vcHRpb25zL2luZGV4LmpzIjp7Im9mZnNldCI6MTQwNTk5MCwibGVuZ3RoIjoxNDAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvaXMtb3B0aW9ucy9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDA2MTMwLCJsZW5ndGgiOjYwNSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL2luZGV4LmpzIjp7Im9mZnNldCI6MTQwNjczNSwibGVuZ3RoIjo0MTQ1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL2thZGVtbGlhLXJvdXRpbmctdGFibGUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQxMDg4MCwibGVuZ3RoIjo5NjcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbXV0ZXhpZnkvaW5kZXguanMiOnsib2Zmc2V0IjoxNDExODQ3LCJsZW5ndGgiOjUzNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDEyMzgzLCJsZW5ndGgiOjY3OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9tdXRleGlmeS9wcm9taXNlLmpzIjp7Im9mZnNldCI6MTQxMzA2MiwibGVuZ3RoIjozMjQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbmFub2Fzc2VydC9pbmRleC5qcyI6eyJvZmZzZXQiOjE0MTMzODYsImxlbmd0aCI6NDM4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25hbm9hc3NlcnQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQxMzgyNCwibGVuZ3RoIjo2NDcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbmF0LXNhbXBsZXIvaW5kZXguanMiOnsib2Zmc2V0IjoxNDE0NDcxLCJsZW5ndGgiOjE1NTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbmF0LXNhbXBsZXIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQxNjAyMSwibGVuZ3RoIjo2MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvaW5kZXguanMiOnsib2Zmc2V0IjoxNDE2NjI5LCJsZW5ndGgiOjE2NDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtY3VydmUtZWQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTQxODI3MSwibGVuZ3RoIjo4MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2NpcGhlci5qcyI6eyJvZmZzZXQiOjE0MTkwNzksImxlbmd0aCI6MjgxNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2UvZGguanMiOnsib2Zmc2V0IjoxNDIxODk2LCJsZW5ndGgiOjE0MzksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2hrZGYuanMiOnsib2Zmc2V0IjoxNDIzMzM1LCJsZW5ndGgiOjEwOTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL2htYWMuanMiOnsib2Zmc2V0IjoxNDI0NDI3LCJsZW5ndGgiOjEyNzMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvbm9pc2UtaGFuZHNoYWtlL25vaXNlLmpzIjp7Im9mZnNldCI6MTQyNTcwMCwibGVuZ3RoIjo2NDM3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL25vaXNlLWhhbmRzaGFrZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDMyMTM3LCJsZW5ndGgiOjYzOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9ub2lzZS1oYW5kc2hha2Uvc3ltbWV0cmljLXN0YXRlLmpzIjp7Im9mZnNldCI6MTQzMjc3NSwibGVuZ3RoIjoyMjA2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL2luZGV4LmpzIjp7Im9mZnNldCI6MTQzNDk4MSwibGVuZ3RoIjo2NDg5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NDE0NzAsImxlbmd0aCI6NzE5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9pbmRleC5qcyI6eyJvZmZzZXQiOjE0NDIxODksImxlbmd0aCI6MTY4MjQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcHJvdG9tdXgtd2FrZXVwL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0NTkwMTMsImxlbmd0aCI6OTcyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4LXdha2V1cC9zcGVjL2h5cGVyc2NoZW1hL2luZGV4LmpzIjp7Im9mZnNldCI6MTQ1OTk4NSwibGVuZ3RoIjozMzM1LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Byb3RvbXV4L2luZGV4LmpzIjp7Im9mZnNldCI6MTQ2MzMyMCwibGVuZ3RoIjoxODk5NiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9wcm90b211eC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNDgyMzE2LCJsZW5ndGgiOjgxNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0ODMxMzIsImxlbmd0aCI6NjY5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1ZXVlLXRpY2svcHJvY2Vzcy1uZXh0LXRpY2suanMiOnsib2Zmc2V0IjoxNDgzODAxLCJsZW5ndGgiOjE2MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWV1ZS10aWNrL3F1ZXVlLW1pY3JvdGFzay5qcyI6eyJvZmZzZXQiOjE0ODM5NjEsImxlbmd0aCI6MTA4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LW5hdGl2ZS9iaW5kaW5nLmpzIjp7Im9mZnNldCI6MTQ4NDA2OSwibGVuZ3RoIjo5MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC1uYXRpdmUvaW5kZXguanMiOnsib2Zmc2V0IjoxNDg0MTU5LCJsZW5ndGgiOjQ2ODMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcXVpY2tiaXQtbmF0aXZlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE0ODg4NDIsImxlbmd0aCI6MTEwNCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9xdWlja2JpdC11bml2ZXJzYWwvZmFsbGJhY2suanMiOnsib2Zmc2V0IjoxNDg5OTQ2LCJsZW5ndGgiOjEwMjA0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MDAxNTAsImxlbmd0aCI6NDQyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3F1aWNrYml0LXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTAwNTkyLCJsZW5ndGgiOjkwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yYWNoZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MDE1MDAsImxlbmd0aCI6MjQ2MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yYWNoZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTAzOTYzLCJsZW5ndGgiOjYwMiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yYW5kb20tYXJyYXktaXRlcmF0b3IvaW5kZXguanMiOnsib2Zmc2V0IjoxNTA0NTY1LCJsZW5ndGgiOjEwMDEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmFuZG9tLWFycmF5LWl0ZXJhdG9yL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDU1NjYsImxlbmd0aCI6NzAwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL2luZGV4LmpzIjp7Im9mZnNldCI6MTUwNjI2NiwibGVuZ3RoIjoxMDkxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlYWR5LXJlc291cmNlL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1MDczNTcsImxlbmd0aCI6ODEyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlY29yZC1jYWNoZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MDgxNjksImxlbmd0aCI6MzY2OCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yZWNvcmQtY2FjaGUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTUxMTgzNywibGVuZ3RoIjo2MTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVmY291bnRlci9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MTI0NDksImxlbmd0aCI6NjExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JlZmNvdW50ZXIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTUxMzA2MCwibGVuZ3RoIjo0NTEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9saWIvYmFyZS5qcyI6eyJvZmZzZXQiOjE1MTM1MTEsImxlbmd0aCI6NDUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVxdWlyZS1hZGRvbi9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTEzNTU2LCJsZW5ndGgiOjE0NDksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MTUwMDUsImxlbmd0aCI6NDQzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Jlc29sdmUtcmVqZWN0LXByb21pc2UvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTUxNTQ0OCwibGVuZ3RoIjo1ODEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcmVzb3VyY2Utb24tZXhpdC9pbmRleC5qcyI6eyJvZmZzZXQiOjE1MTYwMjksImxlbmd0aCI6MzYxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Jlc291cmNlLW9uLWV4aXQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTUxNjM5MCwibGVuZ3RoIjo0OTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvYmluZGluZy5qcyI6eyJvZmZzZXQiOjE1MTY4ODYsImxlbmd0aCI6OTAsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvaW5kZXguanMiOnsib2Zmc2V0IjoxNTE2OTc2LCJsZW5ndGgiOjQ3MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2JhdGNoLmpzIjp7Im9mZnNldCI6MTUyMTY4NCwibGVuZ3RoIjo4ODEyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb2x1bW4tZmFtaWx5LmpzIjp7Im9mZnNldCI6MTUzMDQ5NiwibGVuZ3RoIjoyNjc0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9jb25zdGFudHMuanMiOnsib2Zmc2V0IjoxNTMzMTcwLCJsZW5ndGgiOjk0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9maWx0ZXItcG9saWN5LmpzIjp7Im9mZnNldCI6MTUzMzI2NCwibGVuZ3RoIjo0MzcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvcm9ja3NkYi1uYXRpdmUvbGliL2l0ZXJhdG9yLmpzIjp7Im9mZnNldCI6MTUzMzcwMSwibGVuZ3RoIjo0MzExLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9zbmFwc2hvdC5qcyI6eyJvZmZzZXQiOjE1MzgwMTIsImxlbmd0aCI6NTAzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3JvY2tzZGItbmF0aXZlL2xpYi9zdGF0ZS5qcyI6eyJvZmZzZXQiOjE1Mzg1MTUsImxlbmd0aCI6OTc2MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9yb2Nrc2RiLW5hdGl2ZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTQ4Mjc3LCJsZW5ndGgiOjE1MzksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL2luZGV4LmpzIjp7Im9mZnNldCI6MTU0OTgxNiwibGVuZ3RoIjo1MDYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2FmZXR5LWNhdGNoL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE1NTAzMjIsImxlbmd0aCI6NTQ3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Njb3BlLWxvY2svaW5kZXguanMiOnsib2Zmc2V0IjoxNTUwODY5LCJsZW5ndGgiOjE4MjEsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2NvcGUtbG9jay9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTUyNjkwLCJsZW5ndGgiOjYxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1NTMzMDEsImxlbmd0aCI6MjYwNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTU1OTA4LCJsZW5ndGgiOjY5MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1NTY1OTksImxlbmd0aCI6MTI1MiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaWduYWwtcHJvbWlzZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTU3ODUxLCJsZW5ndGgiOjUwMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaWduZWQtdmFyaW50L2luZGV4LmpzIjp7Im9mZnNldCI6MTU1ODM1NCwibGVuZ3RoIjo0MzUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2lnbmVkLXZhcmludC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTU4Nzg5LCJsZW5ndGgiOjUyMywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtbmF0aXZlL2JpbmRpbmcuanMiOnsib2Zmc2V0IjoxNTU5MzEyLCJsZW5ndGgiOjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NpbWRsZS1uYXRpdmUvaW5kZXguanMiOnsib2Zmc2V0IjoxNTU5NDAyLCJsZW5ndGgiOjM0NzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLW5hdGl2ZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTYyODc2LCJsZW5ndGgiOjExMTUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9mYWxsYmFjay5qcyI6eyJvZmZzZXQiOjE1NjM5OTEsImxlbmd0aCI6NTEzNywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL2luZGV4LmpzIjp7Im9mZnNldCI6MTU2OTEyOCwibGVuZ3RoIjoxMDMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc2ltZGxlLXVuaXZlcnNhbC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNTY5MjMxLCJsZW5ndGgiOjg3OSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zaW1kbGUtdW5pdmVyc2FsL3NjYWxhci5qcyI6eyJvZmZzZXQiOjE1NzAxMTAsImxlbmd0aCI6NDY5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS1uYXRpdmUvYmluZGluZy5qcyI6eyJvZmZzZXQiOjE1NzA1NzksImxlbmd0aCI6ODksIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9pbmRleC5qcyI6eyJvZmZzZXQiOjE1NzA2NjgsImxlbmd0aCI6NjYzMjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLW5hdGl2ZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjM2OTk2LCJsZW5ndGgiOjEzNTYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc29kaXVtLXNlY3JldHN0cmVhbS9pbmRleC5qcyI6eyJvZmZzZXQiOjE2MzgzNTIsImxlbmd0aCI6MjI1NywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy9zb2RpdW0tc2VjcmV0c3RyZWFtL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2NDA2MDksImxlbmd0aCI6NjU3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvaW5kZXguanMiOnsib2Zmc2V0IjoxNjQxMjY2LCJsZW5ndGgiOjQyLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3NvZGl1bS11bml2ZXJzYWwvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY0MTMwOCwibGVuZ3RoIjoxMjE3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvaW5kZXguanMiOnsib2Zmc2V0IjoxNjQyNTI1LCJsZW5ndGgiOjMzMzUwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3N0cmVhbXgvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY3NTg3NSwibGVuZ3RoIjo4MzYsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvaW5kZXguanMiOnsib2Zmc2V0IjoxNjc2NzExLCJsZW5ndGgiOjE5NjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvc3ViLWVuY29kZXIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY3ODY3OSwibGVuZ3RoIjo5MDgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGV4dC1kZWNvZGVyL2luZGV4LmpzIjp7Im9mZnNldCI6MTY3OTU4NywibGVuZ3RoIjoxMzc4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RleHQtZGVjb2Rlci9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiOnsib2Zmc2V0IjoxNjgwOTY1LCJsZW5ndGgiOjI3MywibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvbGliL3V0ZjgtZGVjb2Rlci5qcyI6eyJvZmZzZXQiOjE2ODEyMzgsImxlbmd0aCI6MjUyOSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90ZXh0LWRlY29kZXIvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTY4Mzc2NywibGVuZ3RoIjo5ODcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZS1vcmRlcmVkLXNldC9pbmRleC5qcyI6eyJvZmZzZXQiOjE2ODQ3NTQsImxlbmd0aCI6MTQ0NCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy90aW1lLW9yZGVyZWQtc2V0L3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2ODYxOTgsImxlbmd0aCI6NjY2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9icm93c2VyLmpzIjp7Im9mZnNldCI6MTY4Njg2NCwibGVuZ3RoIjoxMDk4LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9pbmRleC5qcyI6eyJvZmZzZXQiOjE2ODc5NjIsImxlbmd0aCI6MTg0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbWVvdXQtcmVmcmVzaC9ub2RlLmpzIjp7Im9mZnNldCI6MTY4ODE0NiwibGVuZ3RoIjo5MjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdGltZW91dC1yZWZyZXNoL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE2ODkwNzQsImxlbmd0aCI6NjE5LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9pbmRleC5qcyI6eyJvZmZzZXQiOjE2ODk2OTMsImxlbmd0aCI6OTM2LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3RpbnktYnVmZmVyLW1hcC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNjkwNjI5LCJsZW5ndGgiOjY1MCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2JpbmRpbmcuanMiOnsib2Zmc2V0IjoxNjkxMjc5LCJsZW5ndGgiOjkwLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL2lwLmpzIjp7Im9mZnNldCI6MTY5MTM2OSwibGVuZ3RoIjoyMjA0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3VkeC1uYXRpdmUvbGliL25ldHdvcmstaW50ZXJmYWNlcy5qcyI6eyJvZmZzZXQiOjE2OTM1NzMsImxlbmd0aCI6MTM0MSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi9zb2NrZXQuanMiOnsib2Zmc2V0IjoxNjk0OTE0LCJsZW5ndGgiOjc1NTcsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9saWIvc3RyZWFtLmpzIjp7Im9mZnNldCI6MTcwMjQ3MSwibGVuZ3RoIjoxMjcwNiwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy91ZHgtbmF0aXZlL2xpYi91ZHguanMiOnsib2Zmc2V0IjoxNzE1MTc3LCJsZW5ndGgiOjI4NjgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdWR4LW5hdGl2ZS9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNzE4MDQ1LCJsZW5ndGgiOjE2MTUsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdW5vcmRlcmVkLXNldC9pbmRleC5qcyI6eyJvZmZzZXQiOjE3MTk2NjAsImxlbmd0aCI6Njc3LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3Vub3JkZXJlZC1zZXQvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTcyMDMzNywibGVuZ3RoIjo2NTQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdW5zbGFiL2luZGV4LmpzIjp7Im9mZnNldCI6MTcyMDk5MSwibGVuZ3RoIjo5MTMsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdW5zbGFiL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE3MjE5MDQsImxlbmd0aCI6NjEzLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9kZWNvZGUuanMiOnsib2Zmc2V0IjoxNzIyNTE3LCJsZW5ndGgiOjUwOCwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy92YXJpbnQvZW5jb2RlLmpzIjp7Im9mZnNldCI6MTcyMzAyNSwibGVuZ3RoIjo0NTIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdmFyaW50L2luZGV4LmpzIjp7Im9mZnNldCI6MTcyMzQ3NywibGVuZ3RoIjoxMzQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvdmFyaW50L2xlbmd0aC5qcyI6eyJvZmZzZXQiOjE3MjM2MTEsImxlbmd0aCI6NDcxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ZhcmludC9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNzI0MDgyLCJsZW5ndGgiOjUxMSwibW9kZSI6NDIwfSwiL25vZGVfbW9kdWxlcy93aGljaC1ydW50aW1lL2luZGV4LmpzIjp7Im9mZnNldCI6MTcyNDU5MywibGVuZ3RoIjoxMjMxLCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3doaWNoLXJ1bnRpbWUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTcyNTgyNCwibGVuZ3RoIjo2MDIsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMveGFjaGUvaW5kZXguanMiOnsib2Zmc2V0IjoxNzI2NDI2LCJsZW5ndGgiOjIzNzgsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMveGFjaGUvcGFja2FnZS5qc29uIjp7Im9mZnNldCI6MTcyODgwNCwibGVuZ3RoIjo1ODQsIm1vZGUiOjQyMH0sIi9ub2RlX21vZHVsZXMvejMyL2luZGV4LmpzIjp7Im9mZnNldCI6MTcyOTM4OCwibGVuZ3RoIjoyNjU0LCJtb2RlIjo0MjB9LCIvbm9kZV9tb2R1bGVzL3ozMi9wYWNrYWdlLmpzb24iOnsib2Zmc2V0IjoxNzMyMDQyLCJsZW5ndGgiOjcwMSwibW9kZSI6NDIwfSwiL3BhY2thZ2UuanNvbiI6eyJvZmZzZXQiOjE3MzI3NDMsImxlbmd0aCI6MjQwNSwibW9kZSI6NDIwfSwiL3JwYy1jb21tYW5kcy5tanMiOnsib2Zmc2V0IjoxNzM1MTQ4LCJsZW5ndGgiOjQxNSwibW9kZSI6NDIwfX19CmltcG9ydCBSUEMgZnJvbSAnYmFyZS1ycGMnCmltcG9ydCBVUkwgZnJvbSAnYmFyZS11cmwnCmltcG9ydCB7IGpvaW4gfSBmcm9tICdiYXJlLXBhdGgnCmltcG9ydCB7CiAgICBSUENfVVBEQVRFLAogICAgUlBDX0FERCwKICAgIFJQQ19ERUxFVEUsCiAgICBSUENfR0VUX0tFWSwKICAgIFJQQ19KT0lOX0tFWSwKICAgIFJQQ19BRERfRlJPTV9CQUNLRU5ELAogICAgUlBDX1VQREFURV9GUk9NX0JBQ0tFTkQsCiAgICBSUENfREVMRVRFX0ZST01fQkFDS0VORCwKICAgIFNZTkNfTElTVCwKICAgIFJQQ19SRVFVRVNUX1NZTkMsCiAgICBSUENfQ1JFQVRFX0lOVklURQp9IGZyb20gJy4uL3JwYy1jb21tYW5kcy5tanMnCmltcG9ydCBiNGEgZnJvbSAnYjRhJwppbXBvcnQge3N5bmNMaXN0VG9Gcm9udGVuZCwgdmFsaWRhdGVJdGVtLCBhZGRJdGVtLCB1cGRhdGVJdGVtLCBkZWxldGVJdGVtfSBmcm9tICcuL2xpYi9pdGVtLm1qcycKY29uc3QgeyBJUEMgfSA9IEJhcmVLaXQKaW1wb3J0IHtsb2FkQXV0b2Jhc2VLZXksIHNhdmVBdXRvYmFzZUtleSwgbG9hZEVuY3J5cHRpb25LZXl9IGZyb20gIi4vbGliL2tleS5tanMiCmltcG9ydCB7aW5pdEF1dG9iYXNlLCBqb2luVmlhSW52aXRlLCBjcmVhdGVJbnZpdGV9IGZyb20gIi4vbGliL25ldHdvcmsubWpzIgppbXBvcnQgewogICAgYXV0b2Jhc2UsCiAgICBzdG9yZSwKICAgIHN3YXJtLAogICAgZGlzY292ZXJ5LAogICAgcGFpcmluZywKICAgIHJwYywKICAgIGN1cnJlbnRMaXN0LAogICAgYmFzZUtleSwKICAgIHNldFJwYywKICAgIHNldEN1cnJlbnRMaXN0LAogICAgc2V0QmFzZUtleSwKICAgIHNldEVuY3J5cHRpb25LZXkKfSBmcm9tICIuL2xpYi9zdGF0ZS5tanMiCmltcG9ydCBmcyBmcm9tICJiYXJlLWZzIgoKY29uc3QgSU5TVEFOQ0VfSUQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyLCA4KQpjb25zb2xlLmVycm9yKCdbSU5GT10gQkFDS0VORCBJTlNUQU5DRTonLCBJTlNUQU5DRV9JRCkKCmNvbnN0IGFyZ3YwID0gdHlwZW9mIEJhcmU/LmFyZ3Y/LlswXSA9PT0gJ3N0cmluZycgPyBCYXJlLmFyZ3ZbMF0gOiAnJzsKbGV0IGJhc2VEaXIgPSAnJzsKaWYgKGFyZ3YwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBiYXNlRGlyID0gYXJndjAuc3RhcnRzV2l0aCgnZmlsZTovLycpID8gVVJMLmZpbGVVUkxUb1BhdGgoYXJndjApIDogYXJndjA7CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgYmFzZURpciA9ICcnOwogICAgICAgICAgfQogICAgfQpleHBvcnQgY29uc3Qgc3RvcmFnZVBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEnKSA6ICcuL2RhdGEnOwpleHBvcnQgY29uc3QgcGVlcktleXNTdHJpbmcgPSBCYXJlLmFyZ3ZbMV0gfHwgJycgLy8gQ29tbWEtc2VwYXJhdGVkIHBlZXIga2V5cwpjb25zdCBiYXNlS2V5SGV4ID0gQmFyZS5hcmd2WzJdIHx8ICcnIC8vIE9wdGlvbmFsIEF1dG9iYXNlIGtleSAodG8gam9pbiBhbiBleGlzdGluZyBiYXNlKQpleHBvcnQgY29uc3Qga2V5RmlsZVBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEtYXV0b2Jhc2Uta2V5LnR4dCcpIDogJy4vYXV0b2Jhc2Uta2V5LnR4dCc7CmNvbnN0IGxvY2FsV3JpdGVyS2V5RmlsZVBhdGggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEtbG9jYWwtd3JpdGVyLWtleS50eHQnKSA6ICcuL2xvY2FsLXdyaXRlci1rZXkudHh0JzsKZXhwb3J0IGNvbnN0IGVuY0tleUZpbGVQYXRoID0gYmFzZURpciA/IGpvaW4oYmFzZURpciwgJ2xpc3RhLWVuY3J5cHRpb24ta2V5LnR4dCcpIDogJy4vZW5jcnlwdGlvbi1rZXkudHh0JzsKZXhwb3J0IGNvbnN0IGludml0ZUZpbGVQYXRoID0gYmFzZURpciA/IGpvaW4oYmFzZURpciwgJ2xpc3RhLWludml0ZS5qc29uJykgOiAnLi9pbnZpdGUuanNvbic7Cgpjb25zdCBMT0NLX1BBVEggPSBiYXNlRGlyID8gam9pbihiYXNlRGlyLCAnbGlzdGEubG9jaycpIDogJy4vbGlzdGEubG9jaycKCi8vIFN0YWdnZXIgbG9jayBhY3F1aXNpdGlvbiB3aXRoIHJhbmRvbSBkZWxheSB0byBkZXRlY3QgZHVwbGljYXRlIGluc3RhbmNlcwpjb25zdCBsb2NrRGVsYXkgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1MDApICsgMTAwIC8vIDEwMC02MDBtcwpjb25zb2xlLmVycm9yKGBbSU5GT10gWyR7SU5TVEFOQ0VfSUR9XSBXYWl0aW5nICR7bG9ja0RlbGF5fW1zIGJlZm9yZSBhY3F1aXJpbmcgbG9jay4uLmApCmF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBsb2NrRGVsYXkpKQoKbGV0IGxvY2tGZCA9IG51bGwKdHJ5IHsKICAgIC8vICd3eCcgPT4gY3JlYXRlIGV4Y2x1c2l2ZWx5LCBmYWlsIGlmIGV4aXN0cwogICAgbG9ja0ZkID0gZnMub3BlblN5bmMoTE9DS19QQVRILCAnd3gnKQogICAgZnMud3JpdGVTeW5jKGxvY2tGZCwgSU5TVEFOQ0VfSUQgKyAnXG4nKQogICAgY29uc29sZS5lcnJvcihgW0lORk9dIFske0lOU1RBTkNFX0lEfV0gQWNxdWlyZWQgbG9jazpgLCBMT0NLX1BBVEgpCn0gY2F0Y2ggKGUpIHsKICAgIC8vIENoZWNrIHdobyBvd25zIHRoZSBsb2NrCiAgICB0cnkgewogICAgICAgIGNvbnN0IG93bmVyID0gZnMucmVhZEZpbGVTeW5jKExPQ0tfUEFUSCwgJ3V0Zi04JykudHJpbSgpCiAgICAgICAgY29uc29sZS5lcnJvcihgW1dBUk5JTkddIFske0lOU1RBTkNFX0lEfV0gTG9jayBvd25lZCBieSBpbnN0YW5jZTogJHtvd25lcn1gKQogICAgfSBjYXRjaCB7fQogICAgY29uc29sZS5lcnJvcihgW0VSUk9SXSBbJHtJTlNUQU5DRV9JRH1dIEFub3RoZXIgYmFja2VuZCBpbnN0YW5jZSBpcyBhbHJlYWR5IHJ1bm5pbmcgKGxvY2sgZXhpc3RzKTpgLCBMT0NLX1BBVEgpCiAgICAvLyBIYXJkLWV4aXQgdGhpcyBiYWNrZW5kIGluc3RhbmNlIHNvIGl0IGNhbid0IHRvdWNoIHN0b3JhZ2UKICAgIHRocm93IGUKfQoKLy8gT3B0aW9uYWwgQXV0b2Jhc2Uga2V5IGZyb20gYXJndiAoaW5pdGlhbCBiYXNlKSBvciBsb2FkZWQgZnJvbSBmaWxlCmlmIChiYXNlS2V5SGV4KSB7CiAgICB0cnkgewogICAgICAgIHNldEJhc2VLZXkoQnVmZmVyLmZyb20oYmFzZUtleUhleC50cmltKCksICdoZXgnKSkKICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gVXNpbmcgZXhpc3RpbmcgQXV0b2Jhc2Uga2V5IGZyb20gYXJndlsyXTonLCBiYXNlS2V5SGV4LnRyaW0oKSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gSW52YWxpZCBiYXNlIGtleSBoZXgsIGNyZWF0aW5nIG5ldyBiYXNlIGluc3RlYWQ6JywgZXJyLm1lc3NhZ2UpCiAgICAgICAgc2V0QmFzZUtleShudWxsKQogICAgfQp9CgovLyBJZiBubyBrZXkgZnJvbSBhcmd2LCB0cnkgbG9hZGluZyBmcm9tIGZpbGUgKGZvciByZXN0YXJ0IHBlcnNpc3RlbmNlKQppZiAoIWJhc2VLZXkpIHsKICAgIHNldEJhc2VLZXkobG9hZEF1dG9iYXNlS2V5KGtleUZpbGVQYXRoKSkKfQoKLy8gTG9hZCBlbmNyeXB0aW9uIGtleSBpZiB3ZSBoYXZlIGEgYmFzZSBrZXkgKGZvciByZXN0YXJ0IHBlcnNpc3RlbmNlKQppZiAoYmFzZUtleSkgewogICAgY29uc3QgbG9hZGVkRW5jS2V5ID0gbG9hZEVuY3J5cHRpb25LZXkoZW5jS2V5RmlsZVBhdGgpCiAgICBpZiAobG9hZGVkRW5jS2V5KSB7CiAgICAgICAgc2V0RW5jcnlwdGlvbktleShsb2FkZWRFbmNLZXkpCiAgICB9Cn0KCi8vIENyZWF0ZSBSUEMgc2VydmVyCmxldCBycGNHZW5lcmF0ZWQgPSBuZXcgUlBDKElQQywgYXN5bmMgKHJlcSwgZXJyb3IpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBHb3QgYSByZXF1ZXN0IGZyb20gcmVhY3QnLCByZXEpCiAgICBpZiAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEdvdCBhbiBlcnJvciBmcm9tIHJlYWN0JywgZXJyb3IpCiAgICB9CiAgICB0cnkgewogICAgICAgIHN3aXRjaCAocmVxLmNvbW1hbmQpIHsKICAgICAgICAgICAgY2FzZSBSUENfQUREOiB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gSlNPTi5wYXJzZShiNGEudG9TdHJpbmcocmVxLmRhdGEpKQogICAgICAgICAgICAgICAgYXdhaXQgYWRkSXRlbSh0ZXh0KQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJQQ19VUERBVEU6IHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHJlcS5kYXRhLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVJdGVtKGRhdGEuaXRlbSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSUENfREVMRVRFOiB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyZXEuZGF0YS50b1N0cmluZygpKQogICAgICAgICAgICAgICAgYXdhaXQgZGVsZXRlSXRlbShkYXRhLml0ZW0pCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUlBDX0dFVF9LRVk6IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBDb21tYW5kIFJQQ19HRVRfS0VZJykKICAgICAgICAgICAgICAgIGlmICghYXV0b2Jhc2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbV0FSTklOR10gUlBDX0dFVF9LRVkgcmVxdWVzdGVkIGJlZm9yZSBBdXRvYmFzZSBpcyByZWFkeScpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHozMkludml0ZSA9IGNyZWF0ZUludml0ZSgpCiAgICAgICAgICAgICAgICBpZiAoejMySW52aXRlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5UmVxID0gcnBjLnJlcXVlc3QoUlBDX0dFVF9LRVkpCiAgICAgICAgICAgICAgICAgICAga2V5UmVxLnNlbmQoejMySW52aXRlKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJQQ19KT0lOX0tFWTogewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIENvbW1hbmQgUlBDX0pPSU5fS0VZJykKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHJlcS5kYXRhLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gSm9pbmluZyB2aWEgaW52aXRlIGZyb20gUlBDOicsIGRhdGEua2V5KQogICAgICAgICAgICAgICAgYXdhaXQgam9pblZpYUludml0ZShkYXRhLmtleSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSUENfQ1JFQVRFX0lOVklURTogewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIENvbW1hbmQgUlBDX0NSRUFURV9JTlZJVEUnKQogICAgICAgICAgICAgICAgY29uc3QgejMySW52aXRlID0gY3JlYXRlSW52aXRlKCkKICAgICAgICAgICAgICAgIGlmICh6MzJJbnZpdGUgJiYgcnBjKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5UmVxID0gcnBjLnJlcXVlc3QoUlBDX0dFVF9LRVkpCiAgICAgICAgICAgICAgICAgICAga2V5UmVxLnNlbmQoejMySW52aXRlKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJQQ19SRVFVRVNUX1NZTkM6IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBDb21tYW5kIFJQQ19SRVFVRVNUX1NZTkMgLSBmcm9udGVuZCByZXF1ZXN0aW5nIGN1cnJlbnQgbGlzdCcpCiAgICAgICAgICAgICAgICBzeW5jTGlzdFRvRnJvbnRlbmQoKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRXJyb3IgaGFuZGxpbmcgUlBDIHJlcXVlc3Q6JywgZXJyKQogICAgfQp9KQpzZXRScGMocnBjR2VuZXJhdGVkKQoKLy8gSW5pdGlhbGl6ZSBBdXRvYmFzZSBmb3IgdGhlIGluaXRpYWwgYmFzZUtleSAoZnJvbSBhcmd2IG9yIG5ldykKYXdhaXQgaW5pdEF1dG9iYXNlKGJhc2VLZXkpLnRoZW4oKCkgPT4gewogICAgY29uc29sZS5lcnJvcignW0lORk9dIEF1dG9iYXNlIHJlYWR5IDEyMycpCn0pLmNhdGNoKChlcnIpID0+IHsKICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gaW5pdEF1dG9iYXNlIGZhaWxlZCBhdCBzdGFydHVwOicsIGVycikKICAgIHRocm93IGVycgp9KQoKLy8gQmFja2VuZCByZWFkeQoKCi8vIENsZWFudXAgb24gdGVhcmRvd24KQmFyZS5vbigndGVhcmRvd24nLCBhc3luYyAoKSA9PiB7CiAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gQmFja2VuZCBzaHV0dGluZyBkb3duLi4uJykKICAgIGlmIChwYWlyaW5nKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgcGFpcmluZy5jbG9zZSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEVycm9yIGNsb3NpbmcgYmxpbmQgcGFpcmluZzonLCBlKQogICAgICAgIH0KICAgIH0KICAgIGlmIChzd2FybSkgewogICAgICAgIHN3YXJtLnJlbW92ZUFsbExpc3RlbmVycygnY29ubmVjdGlvbicpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgc3dhcm0uZGVzdHJveSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEVycm9yIGRlc3Ryb3lpbmcgcmVwbGljYXRpb24gc3dhcm06JywgZSkKICAgICAgICB9CiAgICB9CiAgICBpZiAoYXV0b2Jhc2UpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5jbG9zZSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEVycm9yIGNsb3NpbmcgYXV0b2Jhc2U6JywgZSkKICAgICAgICB9CiAgICB9CiAgICBpZiAoZGlzY292ZXJ5KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgZGlzY292ZXJ5LmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBFcnJvciBkZXN0cm95aW5nIGRpc2NvdmVyeTonLCBlKQogICAgICAgIH0KICAgIH0KICAgIGlmKHN0b3JlKXsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBzdG9yZS5mbHVzaCgpCiAgICAgICAgICAgIGF3YWl0IHN0b3JlLmNsb3NlKCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRXJyb3IgY2xvc2luZyBzdG9yZTonLCBlKQogICAgICAgIH0KICAgIH0KICAgIHRyeSB7CiAgICAgICAgaWYgKGxvY2tGZCkgZnMuY2xvc2VTeW5jKGxvY2tGZCkKICAgICAgICBmcy5ybVN5bmMoTE9DS19QQVRILCB7IGZvcmNlOiB0cnVlIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBFcnJvciByZWxlYXNpbmcgbG9jazonLCBlKQogICAgfQogICAgY29uc29sZS5lcnJvcignW0lORk9dIEJhY2tlbmQgc2h1dGRvd24gY29tcGxldGUnKQp9KQoKZXhwb3J0IGZ1bmN0aW9uIG9wZW4gKHN0b3JlKSB7CiAgICBjb25zdCB2aWV3ID0gc3RvcmUuZ2V0KHsKICAgICAgICBuYW1lOiAndGVzdCcsCiAgICAgICAgdmFsdWVFbmNvZGluZzogJ2pzb24nCiAgICB9KQogICAgY29uc29sZS5lcnJvcignW0lORk9dIE9wZW5pbmcgc3RvcmUuLi4nLCB2aWV3KQogICAgcmV0dXJuIHZpZXcKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFwcGx5IChub2RlcywgdmlldywgaG9zdCkgewogICAgY29uc29sZS5lcnJvcignW0lORk9dIEFwcGx5IHN0YXJ0ZWQnKQogICAgZm9yIChjb25zdCB7IHZhbHVlIH0gb2Ygbm9kZXMpIHsKICAgICAgICBpZiAoIXZhbHVlKSBjb250aW51ZQoKICAgICAgICAvLyBIYW5kbGUgd3JpdGVyIG1lbWJlcnNoaXAgdXBkYXRlcyBjb21pbmcgZnJvbSBibGluZCBwYWlyaW5nCiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09ICdhZGQtd3JpdGVyJyAmJiB0eXBlb2YgdmFsdWUua2V5ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3Qgd3JpdGVyS2V5ID0gQnVmZmVyLmZyb20odmFsdWUua2V5LCAnaGV4JykKICAgICAgICAgICAgICAgIGF3YWl0IGhvc3QuYWRkV3JpdGVyKHdyaXRlcktleSwgeyBpbmRleGVyOiBmYWxzZSB9KQogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIEFkZGVkIHdyaXRlciBmcm9tIGFkZC13cml0ZXIgb3A6JywgdmFsdWUua2V5KQoKICAgICAgICAgICAgICAgIC8vIElmIHdlIGp1c3QgYmVjYW1lIHdyaXRhYmxlIChvdXIga2V5IHdhcyBhZGRlZCksIHNhdmUgdGhlIGJhc2Uga2V5CiAgICAgICAgICAgICAgICBpZiAoYXV0b2Jhc2UgJiYgYXV0b2Jhc2UubG9jYWwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvdXJLZXlIZXggPSBhdXRvYmFzZS5sb2NhbC5rZXkudG9TdHJpbmcoJ2hleCcpCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLmtleSA9PT0gb3VyS2V5SGV4ICYmIGF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVBdXRvYmFzZUtleShhdXRvYmFzZS5rZXksIGtleUZpbGVQYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gV2UgYmVjYW1lIHdyaXRhYmxlISBTYXZlZCBhdXRvYmFzZSBrZXkgZm9yIHBlcnNpc3RlbmNlLicpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRmFpbGVkIHRvIGFkZCB3cml0ZXIgZnJvbSBhZGQtd3JpdGVyIG9wOicsIGVycikKICAgICAgICAgICAgfQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09ICdhZGQnKSB7CiAgICAgICAgICAgIGlmICghdmFsaWRhdGVJdGVtKHZhbHVlLnZhbHVlKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIEludmFsaWQgaXRlbSBzY2hlbWEgaW4gYWRkIG9wZXJhdGlvbjonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIEFwcGx5aW5nIGFkZCBvcGVyYXRpb24gZm9yIGl0ZW06JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgIC8vIFBlcnNpc3QgaXRlbSB0byB2aWV3CiAgICAgICAgICAgIGF3YWl0IHZpZXcuYXBwZW5kKHZhbHVlLnZhbHVlKQogICAgICAgICAgICAvLyBVcGRhdGUgaW4tbWVtb3J5IGxpc3QKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoW3ZhbHVlLnZhbHVlLCAuLi5jdXJyZW50TGlzdC5maWx0ZXIoaSA9PiBpLnRleHQgIT09IHZhbHVlLnZhbHVlLnRleHQpXSkKICAgICAgICAgICAgY29uc3QgYWRkUmVxID0gcnBjLnJlcXVlc3QoUlBDX0FERF9GUk9NX0JBQ0tFTkQpCiAgICAgICAgICAgIGFkZFJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHZhbHVlLnZhbHVlKSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAnZGVsZXRlJykgewogICAgICAgICAgICBpZiAoIXZhbGlkYXRlSXRlbSh2YWx1ZS52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXQVJOSU5HXSBJbnZhbGlkIGl0ZW0gc2NoZW1hIGluIGRlbGV0ZSBvcGVyYXRpb246JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBBcHBseWluZyBkZWxldGUgb3BlcmF0aW9uIGZvciBpdGVtOicsIHZhbHVlLnZhbHVlKQogICAgICAgICAgICAvLyBVcGRhdGUgaW4tbWVtb3J5IGxpc3QKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoY3VycmVudExpc3QuZmlsdGVyKGkgPT4gaS50ZXh0ICE9PSB2YWx1ZS52YWx1ZS50ZXh0KSkKICAgICAgICAgICAgY29uc3QgZGVsZXRlUmVxID0gcnBjLnJlcXVlc3QoUlBDX0RFTEVURV9GUk9NX0JBQ0tFTkQpCiAgICAgICAgICAgIGRlbGV0ZVJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHZhbHVlLnZhbHVlKSkKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAndXBkYXRlJykgewogICAgICAgICAgICBpZiAoIXZhbGlkYXRlSXRlbSh2YWx1ZS52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXQVJOSU5HXSBJbnZhbGlkIGl0ZW0gc2NoZW1hIGluIHVwZGF0ZSBvcGVyYXRpb246JywgdmFsdWUudmFsdWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBBcHBseWluZyB1cGRhdGUgb3BlcmF0aW9uIGZvciBpdGVtOicsIHZhbHVlLnZhbHVlKQogICAgICAgICAgICAvLyBVcGRhdGUgaW4tbWVtb3J5IGxpc3QKICAgICAgICAgICAgc2V0Q3VycmVudExpc3QoY3VycmVudExpc3QubWFwKGkgPT4KICAgICAgICAgICAgICAgIGkudGV4dCA9PT0gdmFsdWUudmFsdWUudGV4dCA/IHZhbHVlLnZhbHVlIDogaQogICAgICAgICAgICApKQogICAgICAgICAgICBjb25zdCB1cGRhdGVSZXEgPSBycGMucmVxdWVzdChSUENfVVBEQVRFX0ZST01fQkFDS0VORCkKICAgICAgICAgICAgdXBkYXRlUmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkodmFsdWUudmFsdWUpKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUudmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbV0FSTklOR10gSW52YWxpZCBsaXN0IG9wZXJhdGlvbiBwYXlsb2FkLCBleHBlY3RlZCBhcnJheTonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIEFwcGx5aW5nIGxpc3Qgb3BlcmF0aW9uIGZvciBpdGVtczonLCB2YWx1ZS52YWx1ZSkKICAgICAgICAgICAgY29uc3QgdXBkYXRlUmVxID0gcnBjLnJlcXVlc3QoU1lOQ19MSVNUKQogICAgICAgICAgICB1cGRhdGVSZXEuc2VuZChKU09OLnN0cmluZ2lmeSh2YWx1ZS52YWx1ZSkpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICAvLyBBbGwgb3RoZXIgdmFsdWVzIGFyZSBhcHBlbmRlZCB0byB0aGUgdmlldyAoZm9yIGZ1dHVyZSB1c2UpCiAgICAgICAgYXdhaXQgdmlldy5hcHBlbmQodmFsdWUpCiAgICB9Cn0KCi8vIEFkZCBpdGVtIG9wZXJhdGlvbiAoYmFja2VuZCBjcmVhdGVzIHRoZSBjYW5vbmljYWwgaXRlbSkKaW1wb3J0IHtSUENfTUVTU0FHRX0gZnJvbSAiLi4vLi4vcnBjLWNvbW1hbmRzLm1qcyI7CmltcG9ydCB7Z2VuZXJhdGVJZH0gZnJvbSAiLi91dGlsLm1qcyI7CmltcG9ydCB7YXV0b2Jhc2UsIHN0b3JlLCBycGMsIGN1cnJlbnRMaXN0fSBmcm9tICcuL3N0YXRlLm1qcycKaW1wb3J0IHtTWU5DX0xJU1R9IGZyb20gIi4uLy4uL3JwYy1jb21tYW5kcy5tanMiOwoKLy8gLS0tIFdSSVRFIFNFUklBTElaQVRJT04gKHByZXZlbnRzIGNvbmN1cnJlbnQgYXV0b2Jhc2UuYXBwZW5kIC8gZmx1c2ggcmFjZXMpIC0tLQpsZXQgX3dyaXRlQ2hhaW4gPSBQcm9taXNlLnJlc29sdmUoKQoKZnVuY3Rpb24gZW5xdWV1ZVdyaXRlIChmbikgewogICAgLy8gZW5zdXJlcyB3cml0ZXMgcnVuIG9uZS1hdC1hLXRpbWUgZXZlbiBpZiBSUEMgY2FsbHMgYXJyaXZlIGNvbmN1cnJlbnRseQogICAgX3dyaXRlQ2hhaW4gPSBfd3JpdGVDaGFpbi50aGVuKGZuLCBmbikKICAgIHJldHVybiBfd3JpdGVDaGFpbgp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gYWRkSXRlbSAodGV4dCwgbGlzdElkKSB7CiAgICBpZiAoIWF1dG9iYXNlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIGFkZEl0ZW0gY2FsbGVkIGJlZm9yZSBBdXRvYmFzZSBpcyBpbml0aWFsaXplZCcpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKCFhdXRvYmFzZS53cml0YWJsZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXQVJOSU5HXSBhZGRJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHdyaXRhYmxlIHlldCAtIHdhaXRpbmcgdG8gYmUgYWRkZWQgYXMgd3JpdGVyJykKICAgICAgICAvLyBOb3RpZnkgZnJvbnRlbmQgYWJvdXQgbm90IGJlaW5nIHdyaXRhYmxlCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogJ25vdC13cml0YWJsZScsIG1lc3NhZ2U6ICdXYWl0aW5nIHRvIGJlIGFkZGVkIGFzIGEgd3JpdGVyIGJ5IHRoZSBob3N0Li4uJyB9KSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRmFpbGVkIHRvIHNlbmQgbm90LXdyaXRhYmxlIG1lc3NhZ2U6JywgZSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc29sZS5lcnJvcignW0lORk9dIENvbW1hbmQgUlBDX0FERCBhZGRJdGVtIHRleHQnLCB0ZXh0KQoKICAgIGNvbnN0IGl0ZW0gPSB7CiAgICAgICAgaWQ6IGdlbmVyYXRlSWQoKSwgICAgICAgICAgICAgICAgICAgIC8vIGV4dHJhIG1ldGFkYXRhLCBmcm9udGVuZCBjYW4gaWdub3JlCiAgICAgICAgdGV4dCwKICAgICAgICBpc0RvbmU6IGZhbHNlLAogICAgICAgIGxpc3RJZDogbGlzdElkIHx8IG51bGwsCiAgICAgICAgdGltZU9mQ29tcGxldGlvbjogMCwKICAgICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCksCiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgfQoKICAgIGNvbnN0IG9wID0gewogICAgICAgIHR5cGU6ICdhZGQnLAogICAgICAgIHZhbHVlOiBpdGVtCiAgICB9CgogICAgcmV0dXJuIGVucXVldWVXcml0ZShhc3luYyAoKSA9PiB7CiAgICAgICAgaWYgKCFhdXRvYmFzZSkgcmV0dXJuIGZhbHNlCiAgICAgICAgaWYgKGF1dG9iYXNlLmNsb3NpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIE11dGF0aW9uIHJlcXVlc3RlZCB3aGlsZSBBdXRvYmFzZSBpcyBjbG9zaW5nOyBpZ25vcmluZy4nKQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgICAgLy8gR2V0IGxlbmd0aCBiZWZvcmUgYXBwZW5kIHRvIHZlcmlmeSBpdCBpbmNyZWFzZXMKICAgICAgICAvLyBjb25zdCBsZW5ndGhCZWZvcmUgPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKCiAgICAgICAgYXdhaXQgYXV0b2Jhc2UuYXBwZW5kKG9wKQoKICAgICAgICAvLyBGbHVzaCB0byBkaXNrIGFuZCB2ZXJpZnkgcGVyc2lzdGVuY2UKICAgICAgICAvLyBjb25zdCBwZXJzaXN0ZWQgPSBhd2FpdCBwZXJzaXN0QW5kVmVyaWZ5KGxlbmd0aEJlZm9yZSArIDEsICdBREQnKQogICAgICAgIC8vIGlmICghcGVyc2lzdGVkKSB7CiAgICAgICAgLy8gICAgIGNvbnNvbGUuZXJyb3IoJ1tXQVJOSU5HXSBBZGQgb3BlcmF0aW9uIG1heSBub3QgaGF2ZSBiZWVuIHBlcnNpc3RlZCB0byBkaXNrIScpCiAgICAgICAgLy8gfQoKICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gQWRkZWQgaXRlbTonLCB0ZXh0KQogICAgICAgIHJldHVybiB0cnVlCiAgICB9KQp9CgovLyBVcGRhdGUgaXRlbSBvcGVyYXRpb246IEFVVE9OT01PVVMsIE5PIEJBQ0tFTkQgTUVNT1JZCmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVJdGVtIChpdGVtKSB7CiAgICBpZiAoIWF1dG9iYXNlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIHVwZGF0ZUl0ZW0gY2FsbGVkIGJlZm9yZSBBdXRvYmFzZSBpcyBpbml0aWFsaXplZCcpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKCFhdXRvYmFzZS53cml0YWJsZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXQVJOSU5HXSB1cGRhdGVJdGVtIGNhbGxlZCBidXQgYXV0b2Jhc2UgaXMgbm90IHdyaXRhYmxlIHlldCcpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcmVxID0gcnBjLnJlcXVlc3QoUlBDX01FU1NBR0UpCiAgICAgICAgICAgIHJlcS5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogJ25vdC13cml0YWJsZScsIG1lc3NhZ2U6ICdXYWl0aW5nIHRvIGJlIGFkZGVkIGFzIGEgd3JpdGVyIGJ5IHRoZSBob3N0Li4uJyB9KSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRmFpbGVkIHRvIHNlbmQgbm90LXdyaXRhYmxlIG1lc3NhZ2U6JywgZSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc29sZS5lcnJvcignW0lORk9dIENvbW1hbmQgUlBDX1VQREFURSB1cGRhdGVJdGVtIGl0ZW0nLCBpdGVtKQoKICAgIGNvbnN0IG9wID0gewogICAgICAgIHR5cGU6ICd1cGRhdGUnLAogICAgICAgIHZhbHVlOiBpdGVtCiAgICB9CgogICAgcmV0dXJuIGVucXVldWVXcml0ZShhc3luYyAoKSA9PiB7CiAgICAgICAgaWYgKCFhdXRvYmFzZSkgcmV0dXJuIGZhbHNlCiAgICAgICAgaWYgKGF1dG9iYXNlLmNsb3NpbmcpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIE11dGF0aW9uIHJlcXVlc3RlZCB3aGlsZSBBdXRvYmFzZSBpcyBjbG9zaW5nOyBpZ25vcmluZy4nKQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoQmVmb3JlID0gYXV0b2Jhc2UubG9jYWwubGVuZ3RoCgogICAgICAgIGF3YWl0IGF1dG9iYXNlLmFwcGVuZChvcCkKCiAgICAgICAgLy8gY29uc3QgcGVyc2lzdGVkID0gYXdhaXQgcGVyc2lzdEFuZFZlcmlmeShsZW5ndGhCZWZvcmUgKyAxLCAnVVBEQVRFJykKICAgICAgICAvLyBpZiAoIXBlcnNpc3RlZCkgewogICAgICAgIC8vICAgICBjb25zb2xlLmVycm9yKCdbV0FSTklOR10gVXBkYXRlIG9wZXJhdGlvbiBtYXkgbm90IGhhdmUgYmVlbiBwZXJzaXN0ZWQgdG8gZGlzayEnKQogICAgICAgIC8vIH0KCiAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIFVwZGF0ZWQgaXRlbTonLCBpdGVtLnRleHQpCiAgICAgICAgcmV0dXJuIHRydWUKICAgIH0pCn0KCi8vIERlbGV0ZSBpdGVtIG9wZXJhdGlvbjogQVVUT05PTU9VUywgTk8gQkFDS0VORCBNRU1PUlkKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUl0ZW0gKGl0ZW0pIHsKICAgIGlmICghYXV0b2Jhc2UpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbV0FSTklOR10gZGVsZXRlSXRlbSBjYWxsZWQgYmVmb3JlIEF1dG9iYXNlIGlzIGluaXRpYWxpemVkJykKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAoIWF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIGRlbGV0ZUl0ZW0gY2FsbGVkIGJ1dCBhdXRvYmFzZSBpcyBub3Qgd3JpdGFibGUgeWV0JykKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICAgICAgcmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAnbm90LXdyaXRhYmxlJywgbWVzc2FnZTogJ1dhaXRpbmcgdG8gYmUgYWRkZWQgYXMgYSB3cml0ZXIgYnkgdGhlIGhvc3QuLi4nIH0pKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBGYWlsZWQgdG8gc2VuZCBub3Qtd3JpdGFibGUgbWVzc2FnZTonLCBlKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gQ29tbWFuZCBSUENfREVMRVRFIGRlbGV0ZUl0ZW0gaXRlbScsIGl0ZW0pCgogICAgY29uc3Qgb3AgPSB7CiAgICAgICAgdHlwZTogJ2RlbGV0ZScsCiAgICAgICAgdmFsdWU6IGl0ZW0KICAgIH0KCiAgICByZXR1cm4gZW5xdWV1ZVdyaXRlKGFzeW5jICgpID0+IHsKICAgICAgICBpZiAoIWF1dG9iYXNlKSByZXR1cm4gZmFsc2UKICAgICAgICBpZiAoYXV0b2Jhc2UuY2xvc2luZykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbV0FSTklOR10gTXV0YXRpb24gcmVxdWVzdGVkIHdoaWxlIEF1dG9iYXNlIGlzIGNsb3Npbmc7IGlnbm9yaW5nLicpCiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGhCZWZvcmUgPSBhdXRvYmFzZS5sb2NhbC5sZW5ndGgKCiAgICAgICAgYXdhaXQgYXV0b2Jhc2UuYXBwZW5kKG9wKQoKICAgICAgICAvLyBjb25zdCBwZXJzaXN0ZWQgPSBhd2FpdCBwZXJzaXN0QW5kVmVyaWZ5KGxlbmd0aEJlZm9yZSArIDEsICdERUxFVEUnKQogICAgICAgIC8vIGlmICghcGVyc2lzdGVkKSB7CiAgICAgICAgLy8gICAgIGNvbnNvbGUuZXJyb3IoJ1tXQVJOSU5HXSBEZWxldGUgb3BlcmF0aW9uIG1heSBub3QgaGF2ZSBiZWVuIHBlcnNpc3RlZCB0byBkaXNrIScpCiAgICAgICAgLy8gfQoKICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gRGVsZXRlZCBpdGVtOicsIGl0ZW0udGV4dCkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgfSkKfQoKLy8gU2ltcGxlIGlubGluZSBzY2hlbWEgdmFsaWRhdGlvbiBtYXRjaGluZyB0aGUgbW9iaWxlIExpc3RFbnRyeQpleHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVJdGVtIChpdGVtKSB7CiAgICBpZiAodHlwZW9mIGl0ZW0gIT09ICdvYmplY3QnIHx8IGl0ZW0gPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgaWYgKHR5cGVvZiBpdGVtLnRleHQgIT09ICdzdHJpbmcnKSByZXR1cm4gZmFsc2UKICAgIGlmICh0eXBlb2YgaXRlbS5pc0RvbmUgIT09ICdib29sZWFuJykgcmV0dXJuIGZhbHNlCiAgICBpZiAodHlwZW9mIGl0ZW0udGltZU9mQ29tcGxldGlvbiAhPT0gJ251bWJlcicpIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHRydWUKfQoKLy8gU2VuZCBjdXJyZW50IGxpc3QgdG8gZnJvbnRlbmQKZXhwb3J0IGZ1bmN0aW9uIHN5bmNMaXN0VG9Gcm9udGVuZCAoY3VycmVudExpc3QpIHsKICAgIGlmICghcnBjIHx8ICFjdXJyZW50TGlzdCkgcmV0dXJuCiAgICB0cnkgewogICAgICAgIGNvbnN0IHJlcSA9IHJwYy5yZXF1ZXN0KFNZTkNfTElTVCkKICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeShjdXJyZW50TGlzdCkpCiAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIFN5bmNlZCBsaXN0IHRvIGZyb250ZW5kOicsIGN1cnJlbnRMaXN0Lmxlbmd0aCwgJ2l0ZW1zJykKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEZhaWxlZCB0byBzeW5jIGxpc3QgdG8gZnJvbnRlbmQ6JywgZSkKICAgIH0KfQoKLy8gUGVyc2lzdCBhbmQgdmVyaWZ5IHRoYXQgYW4gb3BlcmF0aW9uIHdhcyB3cml0dGVuIHRvIGRpc2sKLy8gUmV0dXJucyB0cnVlIGlmIGZsdXNoIHN1Y2NlZWRlZCBhbmQgbGVuZ3RoIGlzIGNvcnJlY3QsIGZhbHNlIG90aGVyd2lzZQphc3luYyBmdW5jdGlvbiBwZXJzaXN0QW5kVmVyaWZ5IChleHBlY3RlZExlbmd0aCwgb3BlcmF0aW9uVHlwZSkgewogICAgaWYgKCFhdXRvYmFzZSB8fCAhYXV0b2Jhc2UubG9jYWwgfHwgIXN0b3JlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgW0VSUk9SXSBwZXJzaXN0QW5kVmVyaWZ5ICgke29wZXJhdGlvblR5cGV9KTogYXV0b2Jhc2UsIGxvY2FsIGNvcmUsIG9yIHN0b3JlIG5vdCBhdmFpbGFibGVgKQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgLy8gRm9yY2Ugd3JpdGUgdG8gZGlzayB2aWEgQ29yZXN0b3JlIC0gdGhpcyBmbHVzaGVzIGFsbCBjb3JlcyB0byBzdG9yYWdlCiAgICAgICAgLy8gQ29yZXN0b3JlLmZsdXNoKCkgZW5zdXJlcyBhbGwgcGVuZGluZyB3cml0ZXMgYXJlIHBlcnNpc3RlZAogICAgICAgIGlmICh0eXBlb2Ygc3RvcmUuZmx1c2ggPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgYXdhaXQgc3RvcmUuZmx1c2goKQogICAgICAgIH0KCiAgICAgICAgY29uc3QgYWN0dWFsTGVuZ3RoID0gYXV0b2Jhc2UubG9jYWwubGVuZ3RoCiAgICAgICAgY29uc3Qga2V5SGV4ID0gYXV0b2Jhc2UubG9jYWwua2V5LnRvU3RyaW5nKCdoZXgnKS5zbGljZSgwLCAxNikKCiAgICAgICAgaWYgKGFjdHVhbExlbmd0aCA+PSBleHBlY3RlZExlbmd0aCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbSU5GT10gcGVyc2lzdEFuZFZlcmlmeSAoJHtvcGVyYXRpb25UeXBlfSk6IFNVQ0NFU1MgLSBmbHVzaGVkIHRvIGRpc2ssIGNvcmUgJHtrZXlIZXh9Li4uIGxlbmd0aD0ke2FjdHVhbExlbmd0aH1gKQogICAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtXQVJOSU5HXSBwZXJzaXN0QW5kVmVyaWZ5ICgke29wZXJhdGlvblR5cGV9KTogTEVOR1RIIE1JU01BVENIIC0gY29yZSAke2tleUhleH0uLi4gbGVuZ3RoPSR7YWN0dWFsTGVuZ3RofSwgZXhwZWN0ZWQgPj0gJHtleHBlY3RlZExlbmd0aH1gKQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgW0VSUk9SXSBwZXJzaXN0QW5kVmVyaWZ5ICgke29wZXJhdGlvblR5cGV9KTogRkxVU0ggRkFJTEVEIC1gLCBlLm1lc3NhZ2UpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWJ1aWxkTGlzdEZyb21QZXJzaXN0ZWRPcHMoKSB7CiAgICBhd2FpdCBhdXRvYmFzZS51cGRhdGUoKQogICAgaWYgKCFhdXRvYmFzZSB8fCAhYXV0b2Jhc2UudmlldykgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tXQVJOSU5HXSByZWJ1aWxkTGlzdEZyb21QZXJzaXN0ZWRPcHM6IGF1dG9iYXNlIG9yIHZpZXcgbm90IGF2YWlsYWJsZScpCiAgICAgICAgcmV0dXJuIFtdCiAgICB9CgogICAgY29uc3QgcmVidWlsdExpc3QgPSBbXQogICAgY29uc3QgdmlldyA9IGF1dG9iYXNlLnZpZXcKICAgIGNvbnN0IGxlbmd0aCA9IHZpZXcubGVuZ3RoCgogICAgY29uc29sZS5lcnJvcihgW0lORk9dIHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wczogcmVhZGluZyAke2xlbmd0aH0gZW50cmllcyBmcm9tIG1lcmdlZCB2aWV3Li4uYCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgaXRlbSA9IGF3YWl0IHZpZXcuZ2V0KGkpCiAgICAgICAgICAgIGlmICghaXRlbSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW1dBUk5JTkddIGVudHJ5ICR7aX06IG51bGwvdW5kZWZpbmVkYCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpdGVtLnRleHQgIT09IHVuZGVmaW5lZCAmJiB2YWxpZGF0ZUl0ZW0oaXRlbSkpIHsKICAgICAgICAgICAgICAgIHJlYnVpbHRMaXN0LnB1c2goaXRlbSkKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtJTkZPXSBlbnRyeSAke2l9OiAiJHtpdGVtLnRleHR9ImApCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbV0FSTklOR10gZW50cnkgJHtpfTogdW5rbm93biBmb3JtYXRgKQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbRVJST1JdIHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wczogZXJyb3IgcmVhZGluZyBlbnRyeSAke2l9OmAsIGUubWVzc2FnZSkKICAgICAgICB9CiAgICB9CgogICAgY29uc29sZS5lcnJvcihgW0lORk9dIHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wczogcmVidWlsdCBsaXN0IHdpdGggJHtyZWJ1aWx0TGlzdC5sZW5ndGh9IGl0ZW1zYCkKICAgIHJldHVybiByZWJ1aWx0TGlzdAp9CgoKaW1wb3J0IGZzIGZyb20gJ2JhcmUtZnMnCgoKZXhwb3J0IGZ1bmN0aW9uIHNhdmVBdXRvYmFzZUtleShrZXksIGtleUZpbGVQYXRoKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IGtleUhleCA9IGtleS50b1N0cmluZygnaGV4JykKICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGtleUZpbGVQYXRoLCBrZXlIZXgpCiAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIFNhdmVkIGF1dG9iYXNlIGtleSB0byBmaWxlOicsIGtleUhleCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEZhaWxlZCB0byBzYXZlIGF1dG9iYXNlIGtleTonLCBlKQogICAgfQp9CgovLyBMb2FkIGF1dG9iYXNlIGtleSBmcm9tIGZpbGUgaWYgaXQgZXhpc3RzCmV4cG9ydCBmdW5jdGlvbiBsb2FkQXV0b2Jhc2VLZXkoa2V5RmlsZVBhdGgpIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoa2V5RmlsZVBhdGgpKSB7CiAgICAgICAgICAgIGNvbnN0IGtleUhleCA9IGZzLnJlYWRGaWxlU3luYyhrZXlGaWxlUGF0aCwgJ3V0ZjgnKS50cmltKCkKICAgICAgICAgICAgaWYgKGtleUhleCAmJiBrZXlIZXgubGVuZ3RoID09PSA2NCkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIExvYWRlZCBhdXRvYmFzZSBrZXkgZnJvbSBmaWxlOicsIGtleUhleCkKICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShrZXlIZXgsICdoZXgnKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRmFpbGVkIHRvIGxvYWQgYXV0b2Jhc2Uga2V5OicsIGUpCiAgICB9CiAgICByZXR1cm4gbnVsbAp9CgovLyBTYXZlIGxvY2FsIHdyaXRlciBrZXkgdG8gZmlsZSBmb3IgcGVyc2lzdGVuY2UKZXhwb3J0IGZ1bmN0aW9uIHNhdmVMb2NhbFdyaXRlcktleShrZXksIGxvY2FsV3JpdGVyS2V5RmlsZVBhdGgpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3Qga2V5SGV4ID0ga2V5LnRvU3RyaW5nKCdoZXgnKQogICAgICAgIGZzLndyaXRlRmlsZVN5bmMobG9jYWxXcml0ZXJLZXlGaWxlUGF0aCwga2V5SGV4KQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBTYXZlZCBsb2NhbCB3cml0ZXIga2V5IHRvIGZpbGU6Jywga2V5SGV4KQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRmFpbGVkIHRvIHNhdmUgbG9jYWwgd3JpdGVyIGtleTonLCBlKQogICAgfQp9CgovLyBMb2FkIGxvY2FsIHdyaXRlciBrZXkgZnJvbSBmaWxlIGlmIGl0IGV4aXN0cwpleHBvcnQgZnVuY3Rpb24gbG9hZExvY2FsV3JpdGVyS2V5KGxvY2FsV3JpdGVyS2V5RmlsZVBhdGgpIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobG9jYWxXcml0ZXJLZXlGaWxlUGF0aCkpIHsKICAgICAgICAgICAgY29uc3Qga2V5SGV4ID0gZnMucmVhZEZpbGVTeW5jKGxvY2FsV3JpdGVyS2V5RmlsZVBhdGgsICd1dGY4JykudHJpbSgpCiAgICAgICAgICAgIGlmIChrZXlIZXggJiYga2V5SGV4Lmxlbmd0aCA9PT0gNjQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBMb2FkZWQgbG9jYWwgd3JpdGVyIGtleSBmcm9tIGZpbGU6Jywga2V5SGV4KQogICAgICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGtleUhleCwgJ2hleCcpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBGYWlsZWQgdG8gbG9hZCBsb2NhbCB3cml0ZXIga2V5OicsIGUpCiAgICB9CiAgICByZXR1cm4gbnVsbAp9CgovLyBTYXZlIGVuY3J5cHRpb24ga2V5IChoZXgtZW5jb2RlZCAzMi1ieXRlIGJ1ZmZlcikKZXhwb3J0IGZ1bmN0aW9uIHNhdmVFbmNyeXB0aW9uS2V5KGtleSwgZmlsZVBhdGgpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3Qga2V5SGV4ID0ga2V5LnRvU3RyaW5nKCdoZXgnKQogICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIGtleUhleCkKICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gU2F2ZWQgZW5jcnlwdGlvbiBrZXkgdG8gZmlsZScpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBGYWlsZWQgdG8gc2F2ZSBlbmNyeXB0aW9uIGtleTonLCBlKQogICAgfQp9CgovLyBMb2FkIGVuY3J5cHRpb24ga2V5IGZyb20gZmlsZSBpZiBpdCBleGlzdHMKZXhwb3J0IGZ1bmN0aW9uIGxvYWRFbmNyeXB0aW9uS2V5KGZpbGVQYXRoKSB7CiAgICB0cnkgewogICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkgewogICAgICAgICAgICBjb25zdCBrZXlIZXggPSBmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsICd1dGY4JykudHJpbSgpCiAgICAgICAgICAgIGlmIChrZXlIZXggJiYga2V5SGV4Lmxlbmd0aCA9PT0gNjQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBMb2FkZWQgZW5jcnlwdGlvbiBrZXkgZnJvbSBmaWxlJykKICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShrZXlIZXgsICdoZXgnKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRmFpbGVkIHRvIGxvYWQgZW5jcnlwdGlvbiBrZXk6JywgZSkKICAgIH0KICAgIHJldHVybiBudWxsCn0KCi8vIFNhdmUgaW52aXRlIHRvIGZpbGUgKEpTT04gd2l0aCBoZXgtZW5jb2RlZCBidWZmZXJzKQpleHBvcnQgZnVuY3Rpb24gc2F2ZUludml0ZShpbnZpdGUsIGZpbGVQYXRoKSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSB7CiAgICAgICAgICAgIGlkOiBpbnZpdGUuaWQudG9TdHJpbmcoJ2hleCcpLAogICAgICAgICAgICBpbnZpdGU6IGludml0ZS5pbnZpdGUudG9TdHJpbmcoJ2hleCcpLAogICAgICAgICAgICBwdWJsaWNLZXk6IGludml0ZS5wdWJsaWNLZXkudG9TdHJpbmcoJ2hleCcpLAogICAgICAgICAgICBleHBpcmVzOiBpbnZpdGUuZXhwaXJlcyB8fCAwCiAgICAgICAgfQogICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KHNlcmlhbGl6ZWQpKQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBTYXZlZCBpbnZpdGUgdG8gZmlsZScpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBGYWlsZWQgdG8gc2F2ZSBpbnZpdGU6JywgZSkKICAgIH0KfQoKLy8gTG9hZCBpbnZpdGUgZnJvbSBmaWxlIGlmIGl0IGV4aXN0cwpleHBvcnQgZnVuY3Rpb24gbG9hZEludml0ZShmaWxlUGF0aCkgewogICAgdHJ5IHsKICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHsKICAgICAgICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCAndXRmOCcpKQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaWQ6IEJ1ZmZlci5mcm9tKGRhdGEuaWQsICdoZXgnKSwKICAgICAgICAgICAgICAgIGludml0ZTogQnVmZmVyLmZyb20oZGF0YS5pbnZpdGUsICdoZXgnKSwKICAgICAgICAgICAgICAgIHB1YmxpY0tleTogQnVmZmVyLmZyb20oZGF0YS5wdWJsaWNLZXksICdoZXgnKSwKICAgICAgICAgICAgICAgIGV4cGlyZXM6IGRhdGEuZXhwaXJlcyB8fCAwCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBGYWlsZWQgdG8gbG9hZCBpbnZpdGU6JywgZSkKICAgIH0KICAgIHJldHVybiBudWxsCn0KCi8vIERlbGV0ZSBpbnZpdGUgZmlsZQpleHBvcnQgZnVuY3Rpb24gZGVsZXRlSW52aXRlKGZpbGVQYXRoKSB7CiAgICB0cnkgewogICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkgewogICAgICAgICAgICBmcy51bmxpbmtTeW5jKGZpbGVQYXRoKQogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gRGVsZXRlZCBpbnZpdGUgZmlsZScpCiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRmFpbGVkIHRvIGRlbGV0ZSBpbnZpdGU6JywgZSkKICAgIH0KfQppbXBvcnQgSHlwZXJzd2FybSBmcm9tICJoeXBlcnN3YXJtIgppbXBvcnQgZnMgZnJvbSAiYmFyZS1mcyIKaW1wb3J0IEJsaW5kUGFpcmluZyBmcm9tICJibGluZC1wYWlyaW5nIgppbXBvcnQgejMyIGZyb20gInozMiIKaW1wb3J0IHsgYXBwbHksIG9wZW4sIHN0b3JhZ2VQYXRoLCBwZWVyS2V5c1N0cmluZywga2V5RmlsZVBhdGgsIGVuY0tleUZpbGVQYXRoLCBpbnZpdGVGaWxlUGF0aCB9IGZyb20gIi4uL2JhY2tlbmQubWpzIgppbXBvcnQgeyBzYXZlQXV0b2Jhc2VLZXksIHNhdmVFbmNyeXB0aW9uS2V5LCBzYXZlSW52aXRlLCBkZWxldGVJbnZpdGUgfSBmcm9tICIuL2tleS5tanMiCmltcG9ydCB7IFJQQ19NRVNTQUdFLCBSUENfR0VUX0tFWSwgUlBDX1JFU0VULCBTWU5DX0xJU1QgfSBmcm9tICIuLi8uLi9ycGMtY29tbWFuZHMubWpzIgppbXBvcnQgQ29yZXN0b3JlIGZyb20gImNvcmVzdG9yZSIKaW1wb3J0IEF1dG9iYXNlIGZyb20gImF1dG9iYXNlIgppbXBvcnQgYjRhIGZyb20gImI0YSIKaW1wb3J0IHsgcmFuZG9tQnl0ZXMgfSBmcm9tICJoeXBlcmNvcmUtY3J5cHRvIgppbXBvcnQgewogICAgYXV0b2Jhc2UsCiAgICBycGMsCiAgICBhZGRlZFN0YXRpY1BlZXJzLAogICAgc3dhcm0sCiAgICBiYXNlS2V5LAogICAgc3RvcmUsCiAgICBkaXNjb3ZlcnksCiAgICBrbm93bldyaXRlcnMsCiAgICBwZWVyQ291bnQsCiAgICBjdXJyZW50TGlzdCwKICAgIHBhaXJpbmcsCiAgICBjdXJyZW50SW52aXRlLAogICAgZW5jcnlwdGlvbktleSwKICAgIHNldEF1dG9iYXNlLAogICAgc2V0QWRkZWRTdGF0aWNQZWVycywKICAgIHNldFN3YXJtLAogICAgc2V0RGlzY292ZXJ5LAogICAgc2V0UGVlckNvdW50LAogICAgc2V0U3RvcmUsCiAgICBzZXRCYXNlS2V5LAogICAgc2V0UGFpcmluZywKICAgIHNldFBhaXJpbmdNZW1iZXIsCiAgICBzZXRDdXJyZW50SW52aXRlLAogICAgc2V0RW5jcnlwdGlvbktleQp9IGZyb20gIi4vc3RhdGUubWpzIgppbXBvcnQgeyByZWJ1aWxkTGlzdEZyb21QZXJzaXN0ZWRPcHMsIHN5bmNMaXN0VG9Gcm9udGVuZCB9IGZyb20gIi4vaXRlbS5tanMiCgpsZXQgX2luaXRQcm9taXNlID0gbnVsbAoKZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUludml0ZSgpIHsKICAgIGlmICghYXV0b2Jhc2UpIHJldHVybiBudWxsCgogICAgLy8gUmV0dXJuIGV4aXN0aW5nIGludml0ZSBpZiBub3QgeWV0IGNvbnN1bWVkCiAgICBpZiAoY3VycmVudEludml0ZSkgcmV0dXJuIHozMi5lbmNvZGUoY3VycmVudEludml0ZS5pbnZpdGUpCgogICAgY29uc3QgaW52ID0gQmxpbmRQYWlyaW5nLmNyZWF0ZUludml0ZShhdXRvYmFzZS5rZXkpCiAgICBzZXRDdXJyZW50SW52aXRlKGludikKICAgIHNhdmVJbnZpdGUoaW52LCBpbnZpdGVGaWxlUGF0aCkKCiAgICByZXR1cm4gejMyLmVuY29kZShpbnYuaW52aXRlKQp9CgpleHBvcnQgZnVuY3Rpb24gc2V0dXBCbGluZFBhaXJpbmcoKSB7CiAgICBpZiAoIWF1dG9iYXNlIHx8ICFzd2FybSkgcmV0dXJuCgogICAgc2V0UGFpcmluZyhuZXcgQmxpbmRQYWlyaW5nKHN3YXJtKSkKCiAgICBzZXRQYWlyaW5nTWVtYmVyKHBhaXJpbmcuYWRkTWVtYmVyKHsKICAgICAgICBkaXNjb3ZlcnlLZXk6IGF1dG9iYXNlLmRpc2NvdmVyeUtleSwKICAgICAgICBvbmFkZDogYXN5bmMgKGNhbmRpZGF0ZSkgPT4gewogICAgICAgICAgICAvLyBNYXRjaCBpbnZpdGUKICAgICAgICAgICAgaWYgKCFjdXJyZW50SW52aXRlIHx8ICFiNGEuZXF1YWxzKGN1cnJlbnRJbnZpdGUuaWQsIGNhbmRpZGF0ZS5pbnZpdGVJZCkpIHJldHVybgoKICAgICAgICAgICAgLy8gT3BlbiB3aXRoIGludml0ZSdzIHB1YmxpYyBrZXkKICAgICAgICAgICAgY2FuZGlkYXRlLm9wZW4oY3VycmVudEludml0ZS5wdWJsaWNLZXkpCgogICAgICAgICAgICAvLyBHZXQgam9pbmVyJ3Mgd3JpdGVyIGtleSBmcm9tIHVzZXJEYXRhCiAgICAgICAgICAgIGNvbnN0IHdyaXRlcktleUhleCA9IGNhbmRpZGF0ZS51c2VyRGF0YS50b1N0cmluZygnaGV4JykKCiAgICAgICAgICAgIC8vIEFkZCBhcyB3cml0ZXIKICAgICAgICAgICAgaWYgKGF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5hcHBlbmQoeyB0eXBlOiAnYWRkLXdyaXRlcicsIGtleTogd3JpdGVyS2V5SGV4IH0pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNlbmQgb3VyIGJhc2Uga2V5ICsgZW5jcnlwdGlvbiBrZXkKICAgICAgICAgICAgY2FuZGlkYXRlLmNvbmZpcm0oewogICAgICAgICAgICAgICAga2V5OiBhdXRvYmFzZS5rZXksCiAgICAgICAgICAgICAgICBlbmNyeXB0aW9uS2V5OiBhdXRvYmFzZS5lbmNyeXB0aW9uS2V5CiAgICAgICAgICAgIH0pCgogICAgICAgICAgICAvLyBDb25zdW1lIGludml0ZSAob25lLXRpbWUgdXNlKQogICAgICAgICAgICBzZXRDdXJyZW50SW52aXRlKG51bGwpCiAgICAgICAgICAgIGRlbGV0ZUludml0ZShpbnZpdGVGaWxlUGF0aCkKCiAgICAgICAgICAgIC8vIFRyYWNrIHBlZXIgKyBhdXRvLWNyZWF0ZSBuZXh0IGludml0ZQogICAgICAgICAgICBzZXRQZWVyQ291bnQocGVlckNvdW50ICsgMSkKICAgICAgICAgICAgYnJvYWRjYXN0UGVlckNvdW50KCkKCiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGZyZXNoIGludml0ZSBmb3IgdGhlIG5leHQgam9pbmVyCiAgICAgICAgICAgIGNvbnN0IG5ld1ozMiA9IGNyZWF0ZUludml0ZSgpCiAgICAgICAgICAgIGlmIChuZXdaMzIgJiYgcnBjKSB7CiAgICAgICAgICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfR0VUX0tFWSkKICAgICAgICAgICAgICAgIHJlcS5zZW5kKG5ld1ozMikKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pKQp9Cgphc3luYyBmdW5jdGlvbiB0ZWFyRG93bkF1dG9iYXNlU3dhcm1TdG9yZSgpIHsKICAgIC8vIDEuIENsZWFuIHVwIEJsaW5kUGFpcmluZwogICAgaWYgKHBhaXJpbmcpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBwYWlyaW5nLmNsb3NlKCkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0gRXJyb3IgY2xvc2luZyBibGluZCBwYWlyaW5nOicsIGUpCiAgICAgICAgfQogICAgICAgIHNldFBhaXJpbmcobnVsbCkKICAgICAgICBzZXRQYWlyaW5nTWVtYmVyKG51bGwpCiAgICB9CgogICAgLy8gMi4gQ2xlYW4gdXAgcHJldmlvdXMgQXV0b2Jhc2UgaW5zdGFuY2UgKGlmIGFueSkKICAgIGlmIChhdXRvYmFzZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF1dG9iYXNlLnJlbW92ZUFsbExpc3RlbmVycygnYXBwZW5kJykKICAgICAgICAgICAgaWYgKHR5cGVvZiBhdXRvYmFzZS5jbG9zZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIENsb3NpbmcgcHJldmlvdXMgQXV0b2Jhc2UgaW5zdGFuY2UuLi4nKQogICAgICAgICAgICAgICAgYXdhaXQgYXV0b2Jhc2UuY2xvc2UoKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIFByZXZpb3VzIEF1dG9iYXNlIGhhcyBubyBjbG9zZSgpIG1ldGhvZCwgc2tpcHBpbmcgY2xvc2UnKQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEVycm9yIHdoaWxlIGNsb3NpbmcgcHJldmlvdXMgQXV0b2Jhc2U6JywgZSkKICAgICAgICB9CiAgICAgICAgc2V0QXV0b2Jhc2UobnVsbCkKICAgIH0KCiAgICAvLyAzLiBUZWFyIGRvd24gbmV0d29ya2luZyBib3VuZCB0byBvbGQgc3RvcmUKICAgIGlmIChkaXNjb3ZlcnkpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBkaXNjb3ZlcnkuZGVzdHJveSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEVycm9yIGRlc3Ryb3lpbmcgZGlzY292ZXJ5OicsIGUpCiAgICAgICAgfQogICAgICAgIHNldERpc2NvdmVyeShudWxsKQogICAgfQoKICAgIGlmIChzd2FybSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHN3YXJtLmRlc3Ryb3koKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0VSUk9SXSBFcnJvciBkZXN0cm95aW5nIHN3YXJtOicsIGUpCiAgICAgICAgfQogICAgICAgIHNldFN3YXJtKG51bGwpCiAgICB9CgogICAgLy8gNC4gQ2xvc2Ugb2xkIHN0b3JlCiAgICBpZiAoc3RvcmUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBzdG9yZS5jbG9zZSgpCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEVycm9yIGNsb3NpbmcgQ29yZXN0b3JlOicsIGUpCiAgICAgICAgfQogICAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdEF1dG9iYXNlKG5ld0Jhc2VLZXkpIHsKICAgIGlmIChfaW5pdFByb21pc2UpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbV0FSTklOR10gaW5pdEF1dG9iYXNlIGFscmVhZHkgcnVubmluZyDigJQgcmV0dXJuaW5nIGV4aXN0aW5nIGluaXQgcHJvbWlzZScpCiAgICAgICAgcmV0dXJuIF9pbml0UHJvbWlzZQogICAgfQoKICAgIF9pbml0UHJvbWlzZSA9IChhc3luYyAoKSA9PiB7CgogICAgICAgIGF3YWl0IHRlYXJEb3duQXV0b2Jhc2VTd2FybVN0b3JlKCkKCiAgICAgICAgY29uc3QgYmFzZVN0b3JhZ2VQYXRoID0gYCR7c3RvcmFnZVBhdGh9LWxvY2FsYAoKICAgICAgICBzZXRTdG9yZShuZXcgQ29yZXN0b3JlKGJhc2VTdG9yYWdlUGF0aCkpCiAgICAgICAgYXdhaXQgc3RvcmUucmVhZHkoKQogICAgICAgIHNldEJhc2VLZXkobmV3QmFzZUtleSB8fCBudWxsKQogICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICdbSU5GT10gSW5pdGlhbGl6aW5nIGEgbmV3IGF1dG9iYXNlIHdpdGgga2V5OicsCiAgICAgICAgICAgIGJhc2VLZXkgPyBiYXNlS2V5LnRvU3RyaW5nKCdoZXgnKSA6ICcobmV3IGJhc2UpJwogICAgICAgICkKCiAgICAgICAgY29uc3QgYXV0b2Jhc2VPcHRzID0gewogICAgICAgICAgICBhcHBseSwgb3BlbiwKICAgICAgICAgICAgdmFsdWVFbmNvZGluZzogJ2pzb24nLAogICAgICAgICAgICBlbmNyeXB0OiB0cnVlLAogICAgICAgICAgICBlbmNyeXB0aW9uS2V5OiBlbmNyeXB0aW9uS2V5IHx8IHVuZGVmaW5lZAogICAgICAgIH0KICAgICAgICBzZXRBdXRvYmFzZShuZXcgQXV0b2Jhc2Uoc3RvcmUsIGJhc2VLZXksIGF1dG9iYXNlT3B0cykpCiAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIENhbGxpbmcgYXV0b2Jhc2UucmVhZHkoKS4uLicpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgYXV0b2Jhc2UucmVhZHkoKQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc3QgbXNnID0gU3RyaW5nKGU/LnN0YWNrIHx8IGU/Lm1lc3NhZ2UgfHwgZSkKICAgICAgICAgICAgaWYgKG1zZy5pbmNsdWRlcygicmVhZGluZyAnc2lnbmVycyciKSB8fCBtc2cuaW5jbHVkZXMoJ2F1dG9iYXNlL2xpYi9zdG9yZS5qcycpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEF1dG9iYXNlIGFwcGVhcnMgY29ycnVwdGVkLiBXaXBpbmcgbG9jYWwgc3RhdGUgYW5kIHJlY3JlYXRpbmcgYSBuZXcgYmFzZS4uLicpCiAgICAgICAgICAgICAgICBybXJmU2FmZShrZXlGaWxlUGF0aCkKICAgICAgICAgICAgICAgIHJtcmZTYWZlKGJhc2VTdG9yYWdlUGF0aCkKICAgICAgICAgICAgICAgIC8vIENsZWFyIHRoZSBwcm9taXNlIHNvIHJlY3Vyc2l2ZSBjYWxsIGNhbiBzdGFydCBmcmVzaAogICAgICAgICAgICAgICAgX2luaXRQcm9taXNlID0gbnVsbAogICAgICAgICAgICAgICAgcmV0dXJuIGluaXRBdXRvYmFzZShudWxsKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IGUKICAgICAgICB9CiAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgICAgJ1tJTkZPXSBhdXRvYmFzZS5yZWFkeSgpIHJlc29sdmVkLiBBdXRvYmFzZSByZWFkeSwgd3JpdGFibGU/JywKICAgICAgICAgICAgYXV0b2Jhc2Uud3JpdGFibGUsCiAgICAgICAgICAgICcga2V5OicsCiAgICAgICAgICAgIGF1dG9iYXNlLmtleT8udG9TdHJpbmcoJ2hleCcpLAogICAgICAgICkKCiAgICAgICAgLy8gU2F2ZSB0aGUgYXV0b2Jhc2Uga2V5IGZvciBwZXJzaXN0ZW5jZSBhY3Jvc3MgcmVzdGFydHMKICAgICAgICBpZiAoYXV0b2Jhc2Uua2V5ICYmIGF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgICAgIHNhdmVBdXRvYmFzZUtleShhdXRvYmFzZS5rZXksIGtleUZpbGVQYXRoKQogICAgICAgIH0KCiAgICAgICAgLy8gU2F2ZSBlbmNyeXB0aW9uIGtleSBhZnRlciBhdXRvYmFzZSBpcyByZWFkeQogICAgICAgIGlmIChhdXRvYmFzZS5lbmNyeXB0aW9uS2V5ICYmIGF1dG9iYXNlLndyaXRhYmxlKSB7CiAgICAgICAgICAgIHNldEVuY3J5cHRpb25LZXkoYXV0b2Jhc2UuZW5jcnlwdGlvbktleSkKICAgICAgICAgICAgc2F2ZUVuY3J5cHRpb25LZXkoYXV0b2Jhc2UuZW5jcnlwdGlvbktleSwgZW5jS2V5RmlsZVBhdGgpCiAgICAgICAgfQoKICAgICAgICBhdXRvYmFzZS5vbignYXBwZW5kJywgYXN5bmMgKCkgPT4gewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gTmV3IGRhdGEgYXBwZW5kZWQsIHVwZGF0aW5nIHZpZXcuLi4nKQogICAgICAgIH0pCgogICAgICAgIC8vIExvYWQgZXhpc3RpbmcgaXRlbXMgZnJvbSB2aWV3IGFuZCBzeW5jIHRvIGZyb250ZW5kCiAgICAgICAgYXdhaXQgYXV0b2Jhc2UudXBkYXRlKCkKICAgICAgICBjb25zdCByZWJ1aWx0TGlzdCA9IGF3YWl0IHJlYnVpbGRMaXN0RnJvbVBlcnNpc3RlZE9wcygpCiAgICAgICAgc3luY0xpc3RUb0Zyb250ZW5kKHJlYnVpbHRMaXN0KQoKICAgICAgICAvLyBBZGQgc3RhdGljIHBlZXJzIG9ubHkgb25jZQogICAgICAgIGlmICghYWRkZWRTdGF0aWNQZWVycyAmJiBwZWVyS2V5c1N0cmluZykgewogICAgICAgICAgICBjb25zdCBwZWVyS2V5cyA9IHBlZXJLZXlzU3RyaW5nLnNwbGl0KCcsJykuZmlsdGVyKGsgPT4gay50cmltKCkpCiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5SGV4IG9mIHBlZXJLZXlzKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlZXJLZXkgPSBCdWZmZXIuZnJvbShrZXlIZXgudHJpbSgpLCAnaGV4JykKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZWVyQ29yZSA9IHN0b3JlLmdldCh7IGtleTogcGVlcktleSB9KQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHBlZXJDb3JlLnJlYWR5KCkKICAgICAgICAgICAgICAgICAgICBhd2FpdCBhdXRvYmFzZS5hZGRJbnB1dChwZWVyQ29yZSkKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gQWRkZWQgcGVlciB3cml0ZXIgZnJvbSBhcmd2WzFdOicsIGtleUhleC50cmltKCkpCiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEZhaWxlZCB0byBhZGQgcGVlciBmcm9tIGFyZ3ZbMV06Jywga2V5SGV4LCBlcnIubWVzc2FnZSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRBZGRlZFN0YXRpY1BlZXJzKHRydWUpCiAgICAgICAgfQoKICAgICAgICAvLyBSZXNldCBwZWVyIGNvdW50IG9uIG5ldyBiYXNlCiAgICAgICAgc2V0UGVlckNvdW50KDApCiAgICAgICAgYnJvYWRjYXN0UGVlckNvdW50KCkKCiAgICAgICAgLy8gVXNlIGRpc2NvdmVyeUtleSBhcyBzd2FybSB0b3BpYyAoTk9UIGF1dG9iYXNlLmtleSkKICAgICAgICBjb25zdCB0b3BpYyA9IGF1dG9iYXNlLmRpc2NvdmVyeUtleQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tJTkZPXSBEaXNjb3ZlcnkgdG9waWMgKHJlcGxpY2F0aW9uIHN3YXJtKTonLCB0b3BpYy50b1N0cmluZygnaGV4JykpCgogICAgICAgIC8vIFN3aXRjaCBkaXNjb3ZlcnkgdG8gbmV3IHRvcGljCiAgICAgICAgaWYgKGRpc2NvdmVyeSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYXdhaXQgZGlzY292ZXJ5LmRlc3Ryb3koKQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEVycm9yIGRlc3Ryb3lpbmcgcHJldmlvdXMgZGlzY292ZXJ5OicsIGUpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldFN3YXJtKG5ldyBIeXBlcnN3YXJtKCkpCiAgICAgICAgc3dhcm0ub24oJ2Vycm9yJywgKGVycikgPT4gewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIFJlcGxpY2F0aW9uIHN3YXJtIGVycm9yOicsIGVycikKICAgICAgICB9KQogICAgICAgIHN3YXJtLm9uKCdjb25uZWN0aW9uJywgKGNvbm4pID0+IHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0lORk9dIE5ldyBwZWVyIGNvbm5lY3RlZCAocmVwbGljYXRpb24gc3dhcm0pJywgYjRhLmZyb20oY29ubi5wdWJsaWNLZXkpLnRvU3RyaW5nKCdoZXgnKSkKICAgICAgICAgICAgY29ubi5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIFJlcGxpY2F0aW9uIGNvbm5lY3Rpb24gZXJyb3I6JywgZXJyKQogICAgICAgICAgICB9KQogICAgICAgICAgICBzZXRQZWVyQ291bnQocGVlckNvdW50ICsgMSkKICAgICAgICAgICAgYnJvYWRjYXN0UGVlckNvdW50KCkKICAgICAgICAgICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBzZXRQZWVyQ291bnQoTWF0aC5tYXgoMCwgcGVlckNvdW50IC0gMSkpCiAgICAgICAgICAgICAgICBicm9hZGNhc3RQZWVyQ291bnQoKQogICAgICAgICAgICB9KQogICAgICAgICAgICBpZiAoYXV0b2Jhc2UpIHsKICAgICAgICAgICAgICAgIGF1dG9iYXNlLnJlcGxpY2F0ZShjb25uKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1dBUk5JTkddIE5vIEF1dG9iYXNlIHlldCB0byByZXBsaWNhdGUgd2l0aCcpCiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIHNldERpc2NvdmVyeShzd2FybS5qb2luKHRvcGljLCB7IHNlcnZlcjogdHJ1ZSwgY2xpZW50OiB0cnVlIH0pKQogICAgICAgIGF3YWl0IGRpc2NvdmVyeS5mbHVzaGVkKCkKICAgICAgICBjb25zb2xlLmVycm9yKCdbSU5GT10gSm9pbmVkIHJlcGxpY2F0aW9uIHN3YXJtIGZvciBjdXJyZW50IGJhc2UnKQoKICAgICAgICAvLyBTZXQgdXAgYmxpbmQgcGFpcmluZyBmb3IgYWNjZXB0aW5nIGpvaW5lcnMKICAgICAgICBzZXR1cEJsaW5kUGFpcmluZygpCgogICAgICAgIC8vIENyZWF0ZSBpbnZpdGUgYW5kIHNlbmQgdG8gZnJvbnRlbmQKICAgICAgICBjb25zdCB6MzJJbnZpdGUgPSBjcmVhdGVJbnZpdGUoKQogICAgICAgIGlmICh6MzJJbnZpdGUgJiYgcnBjKSB7CiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19HRVRfS0VZKQogICAgICAgICAgICByZXEuc2VuZCh6MzJJbnZpdGUpCiAgICAgICAgfQogICAgfSkoKQoKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9pbml0UHJvbWlzZQogICAgfSBmaW5hbGx5IHsKICAgICAgICBfaW5pdFByb21pc2UgPSBudWxsCiAgICB9Cn0KCmxldCBfam9pblByb21pc2UgPSBudWxsCgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gam9pblZpYUludml0ZSh6MzJJbnZpdGVTdHIpIHsKICAgIGlmIChfam9pblByb21pc2UpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbV0FSTklOR10gam9pblZpYUludml0ZSBhbHJlYWR5IHJ1bm5pbmcg4oCUIHJldHVybmluZyBleGlzdGluZyBqb2luIHByb21pc2UnKQogICAgICAgIHJldHVybiBfam9pblByb21pc2UKICAgIH0KCiAgICBfam9pblByb21pc2UgPSAoYXN5bmMgKCkgPT4gewogICAgICAgIGNvbnN0IHByZXZpb3VzTGlzdCA9IFsuLi5jdXJyZW50TGlzdF0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gMS4gVGVhciBkb3duIGV4aXN0aW5nCiAgICAgICAgICAgIGF3YWl0IHRlYXJEb3duQXV0b2Jhc2VTd2FybVN0b3JlKCkKICAgICAgICAgICAgaWYgKHJwYykgewogICAgICAgICAgICAgICAgY29uc3QgcmVzZXRSZXEgPSBycGMucmVxdWVzdChSUENfUkVTRVQpCiAgICAgICAgICAgICAgICByZXNldFJlcS5zZW5kKCcnKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAyLiBGcmVzaCBzdG9yZSDigJQgd2lwZSBvbGQgZGF0YSBzbyB0aGUgbmV3IGJhc2Ugc3RhcnRzIGNsZWFuCiAgICAgICAgICAgIGNvbnN0IGpvaW5TdG9yYWdlUGF0aCA9IGAke3N0b3JhZ2VQYXRofS1sb2NhbGAKICAgICAgICAgICAgcm1yZlNhZmUoam9pblN0b3JhZ2VQYXRoKQogICAgICAgICAgICBzZXRTdG9yZShuZXcgQ29yZXN0b3JlKGpvaW5TdG9yYWdlUGF0aCkpCiAgICAgICAgICAgIGF3YWl0IHN0b3JlLnJlYWR5KCkKCiAgICAgICAgICAgIC8vIDMuIEZyZXNoIHN3YXJtCiAgICAgICAgICAgIHNldFN3YXJtKG5ldyBIeXBlcnN3YXJtKHsKICAgICAgICAgICAgICAgIGtleVBhaXI6IGF3YWl0IHN0b3JlLmNyZWF0ZUtleVBhaXIoJ2h5cGVyc3dhcm0nKQogICAgICAgICAgICB9KSkKICAgICAgICAgICAgc3dhcm0ub24oJ2Nvbm5lY3Rpb24nLCAoY29ubikgPT4gewogICAgICAgICAgICAgICAgc3RvcmUucmVwbGljYXRlKGNvbm4pICAvLyBzdG9yZS1sZXZlbCByZXBsaWNhdGlvbiBkdXJpbmcgcGFpcmluZwogICAgICAgICAgICB9KQoKICAgICAgICAgICAgLy8gNC4gR2V0IGxvY2FsIHdyaXRlciBrZXkgKGJlZm9yZSBBdXRvYmFzZSBleGlzdHMpCiAgICAgICAgICAgIGNvbnN0IGxvY2FsQ29yZSA9IEF1dG9iYXNlLmdldExvY2FsQ29yZShzdG9yZSkKICAgICAgICAgICAgYXdhaXQgbG9jYWxDb3JlLnJlYWR5KCkKICAgICAgICAgICAgY29uc3QgbG9jYWxXcml0ZXJLZXkgPSBsb2NhbENvcmUua2V5CiAgICAgICAgICAgIGF3YWl0IGxvY2FsQ29yZS5jbG9zZSgpCgogICAgICAgICAgICAvLyA1LiBCbGluZCBwYWlyaW5nIGFzIGNhbmRpZGF0ZQogICAgICAgICAgICBjb25zdCBqb2luUGFpcmluZyA9IG5ldyBCbGluZFBhaXJpbmcoc3dhcm0pCgogICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY2FuZGlkYXRlLmNsb3NlKCkKICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdQYWlyaW5nIHRpbWVkIG91dCcpKQogICAgICAgICAgICAgICAgfSwgMTIwMDAwKSAgLy8gMiBtaW4gdGltZW91dAoKICAgICAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZSA9IGpvaW5QYWlyaW5nLmFkZENhbmRpZGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgaW52aXRlOiB6MzIuZGVjb2RlKHozMkludml0ZVN0ciksCiAgICAgICAgICAgICAgICAgICAgdXNlckRhdGE6IGxvY2FsV3JpdGVyS2V5LAogICAgICAgICAgICAgICAgICAgIG9uYWRkOiBhc3luYyAocGFpcmVkKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHBhaXJlZCkKICAgICAgICAgICAgICAgICAgICAgICAgY2FuZGlkYXRlLmNsb3NlKCkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KQoKICAgICAgICAgICAgLy8gNi4gUGFpcmluZyBzdWNjZWVkZWQg4oCUIHJlc3VsdCA9IHsga2V5LCBlbmNyeXB0aW9uS2V5IH0KICAgICAgICAgICAgYXdhaXQgam9pblBhaXJpbmcuY2xvc2UoKQoKICAgICAgICAgICAgLy8gNy4gTm93IGluaXQgYXV0b2Jhc2Ugd2l0aCB0aGUgcmVjZWl2ZWQga2V5ICsgZW5jcnlwdGlvbgogICAgICAgICAgICBzZXRCYXNlS2V5KHJlc3VsdC5rZXkpCiAgICAgICAgICAgIHNldEVuY3J5cHRpb25LZXkocmVzdWx0LmVuY3J5cHRpb25LZXkpCiAgICAgICAgICAgIHNhdmVBdXRvYmFzZUtleShyZXN1bHQua2V5LCBrZXlGaWxlUGF0aCkKICAgICAgICAgICAgc2F2ZUVuY3J5cHRpb25LZXkocmVzdWx0LmVuY3J5cHRpb25LZXksIGVuY0tleUZpbGVQYXRoKQoKICAgICAgICAgICAgLy8gUmUtaW5pdCB3aXRoIHByb3BlciBhdXRvYmFzZSByZXBsaWNhdGlvbgogICAgICAgICAgICAvLyBSZW1vdmUgc3RvcmUtbGV2ZWwgcmVwbGljYXRpb24sIHN3aXRjaCB0byBhdXRvYmFzZS1sZXZlbAogICAgICAgICAgICBzd2FybS5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2Nvbm5lY3Rpb24nKQoKICAgICAgICAgICAgY29uc3QgYXV0b2Jhc2VPcHRzID0gewogICAgICAgICAgICAgICAgYXBwbHksIG9wZW4sCiAgICAgICAgICAgICAgICB2YWx1ZUVuY29kaW5nOiAnanNvbicsCiAgICAgICAgICAgICAgICBlbmNyeXB0OiB0cnVlLAogICAgICAgICAgICAgICAgZW5jcnlwdGlvbktleTogcmVzdWx0LmVuY3J5cHRpb25LZXkKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRBdXRvYmFzZShuZXcgQXV0b2Jhc2Uoc3RvcmUsIHJlc3VsdC5rZXksIGF1dG9iYXNlT3B0cykpCiAgICAgICAgICAgIGF3YWl0IGF1dG9iYXNlLnJlYWR5KCkKCiAgICAgICAgICAgIC8vIFNldCB1cCBhdXRvYmFzZSByZXBsaWNhdGlvbiBvbiBzd2FybQogICAgICAgICAgICBzd2FybS5vbignY29ubmVjdGlvbicsIChjb25uKSA9PiB7CiAgICAgICAgICAgICAgICBjb25uLm9uKCdlcnJvcicsIChlcnIpID0+IGNvbnNvbGUuZXJyb3IoJ1tFUlJPUl0nLCBlcnIpKQogICAgICAgICAgICAgICAgc2V0UGVlckNvdW50KHBlZXJDb3VudCArIDEpCiAgICAgICAgICAgICAgICBicm9hZGNhc3RQZWVyQ291bnQoKQogICAgICAgICAgICAgICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0UGVlckNvdW50KE1hdGgubWF4KDAsIHBlZXJDb3VudCAtIDEpKQogICAgICAgICAgICAgICAgICAgIGJyb2FkY2FzdFBlZXJDb3VudCgpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgYXV0b2Jhc2UucmVwbGljYXRlKGNvbm4pCiAgICAgICAgICAgIH0pCgogICAgICAgICAgICAvLyBSZXBsaWNhdGUgYXV0b2Jhc2Ugb3ZlciBjb25uZWN0aW9ucyB0aGF0IGFscmVhZHkgZXhpc3QgZnJvbSBwYWlyaW5nCiAgICAgICAgICAgIGZvciAoY29uc3QgY29ubiBvZiBzd2FybS5jb25uZWN0aW9ucykgewogICAgICAgICAgICAgICAgY29ubi5vbignZXJyb3InLCAoZXJyKSA9PiBjb25zb2xlLmVycm9yKCdbRVJST1JdJywgZXJyKSkKICAgICAgICAgICAgICAgIGNvbm4ub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFBlZXJDb3VudChNYXRoLm1heCgwLCBwZWVyQ291bnQgLSAxKSkKICAgICAgICAgICAgICAgICAgICBicm9hZGNhc3RQZWVyQ291bnQoKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGF1dG9iYXNlLnJlcGxpY2F0ZShjb25uKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFBlZXJDb3VudChzd2FybS5jb25uZWN0aW9ucy5zaXplKQogICAgICAgICAgICBicm9hZGNhc3RQZWVyQ291bnQoKQoKICAgICAgICAgICAgLy8gSm9pbiBkaXNjb3ZlcnkgdG9waWMKICAgICAgICAgICAgc2V0RGlzY292ZXJ5KHN3YXJtLmpvaW4oYXV0b2Jhc2UuZGlzY292ZXJ5S2V5LCB7IHNlcnZlcjogdHJ1ZSwgY2xpZW50OiB0cnVlIH0pKQogICAgICAgICAgICBhd2FpdCBkaXNjb3ZlcnkuZmx1c2hlZCgpCgogICAgICAgICAgICAvLyBTZXQgdXAgYmxpbmQgcGFpcmluZyBmb3IgZnV0dXJlIGpvaW5lcnMKICAgICAgICAgICAgc2V0dXBCbGluZFBhaXJpbmcoKQoKICAgICAgICAgICAgLy8gUmVidWlsZCBsaXN0CiAgICAgICAgICAgIGF3YWl0IGF1dG9iYXNlLnVwZGF0ZSgpCiAgICAgICAgICAgIGNvbnN0IHJlYnVpbHRMaXN0ID0gYXdhaXQgcmVidWlsZExpc3RGcm9tUGVyc2lzdGVkT3BzKCkKICAgICAgICAgICAgc3luY0xpc3RUb0Zyb250ZW5kKHJlYnVpbHRMaXN0KQoKICAgICAgICAgICAgLy8gU2VuZCBpbnZpdGUgdG8gZnJvbnRlbmQKICAgICAgICAgICAgY29uc3QgejMySW52aXRlID0gY3JlYXRlSW52aXRlKCkKICAgICAgICAgICAgaWYgKHozMkludml0ZSAmJiBycGMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlcSA9IHJwYy5yZXF1ZXN0KFJQQ19HRVRfS0VZKQogICAgICAgICAgICAgICAgcmVxLnNlbmQoejMySW52aXRlKQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIGpvaW5WaWFJbnZpdGUgZmFpbGVkOicsIGUpCiAgICAgICAgICAgIGlmIChycGMgJiYgcHJldmlvdXNMaXN0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN5bmNSZXEgPSBycGMucmVxdWVzdChTWU5DX0xJU1QpCiAgICAgICAgICAgICAgICBzeW5jUmVxLnNlbmQoSlNPTi5zdHJpbmdpZnkocHJldmlvdXNMaXN0KSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pKCkKCiAgICB0cnkgeyByZXR1cm4gYXdhaXQgX2pvaW5Qcm9taXNlIH0KICAgIGZpbmFsbHkgeyBfam9pblByb21pc2UgPSBudWxsIH0KfQoKZnVuY3Rpb24gYnJvYWRjYXN0UGVlckNvdW50KCkgewogICAgaWYgKCFycGMpIHJldHVybgogICAgdHJ5IHsKICAgICAgICBjb25zdCByZXEgPSBycGMucmVxdWVzdChSUENfTUVTU0FHRSkKICAgICAgICByZXEuc2VuZChKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICdwZWVyLWNvdW50JywgY291bnQ6IHBlZXJDb3VudCB9KSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIEZhaWxlZCB0byBicm9hZGNhc3QgcGVlciBjb3VudCcsIGUpCiAgICB9Cn0KCmZ1bmN0aW9uIHJtcmZTYWZlKHApIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMocCkpIGZzLnJtU3luYyhwLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdbRVJST1JdIHJtcmZTYWZlIGZhaWxlZCBmb3InLCBwLCBlKQogICAgfQp9Ci8vIFNoYXJlZCBtdXRhYmxlIHN0YXRlIGV4cG9ydHMKLy8gQWxsIG1vZHVsZXMgaW1wb3J0IGZyb20gaGVyZSBhbmQgdXNlIHNldHRlcnMgdG8gbW9kaWZ5IHN0YXRlCgovLyBDb3JlIFAyUCBpbnN0YW5jZXMKZXhwb3J0IGxldCBhdXRvYmFzZSA9IG51bGwKZXhwb3J0IGxldCBzdG9yZSA9IG51bGwKZXhwb3J0IGxldCBzd2FybSA9IG51bGwKZXhwb3J0IGxldCBkaXNjb3ZlcnkgPSBudWxsCgovLyBSUEMgaW5zdGFuY2UKZXhwb3J0IGxldCBycGMgPSBudWxsCgovLyBLZXlzIGFuZCB0b3BpY3MKZXhwb3J0IGxldCBiYXNlS2V5ID0gbnVsbApleHBvcnQgbGV0IGN1cnJlbnRUb3BpYyA9IG51bGwKZXhwb3J0IGxldCBlbmNyeXB0aW9uS2V5ID0gbnVsbCAgICAgICAvLyBCdWZmZXIg4oCUIEF1dG9iYXNlIGVuY3J5cHRpb24ga2V5CgovLyBCbGluZCBwYWlyaW5nCmV4cG9ydCBsZXQgcGFpcmluZyA9IG51bGwgICAgICAgICAgICAgLy8gQmxpbmRQYWlyaW5nIGluc3RhbmNlCmV4cG9ydCBsZXQgcGFpcmluZ01lbWJlciA9IG51bGwgICAgICAgLy8gQmxpbmRQYWlyaW5nIG1lbWJlciAoaG9zdC1zaWRlIGhhbmRsZXIpCmV4cG9ydCBsZXQgY3VycmVudEludml0ZSA9IG51bGwgICAgICAgLy8geyBpZCwgaW52aXRlLCBwdWJsaWNLZXksIGV4cGlyZXMgfSBvciBudWxsCgovLyBJbi1tZW1vcnkgZGF0YQpleHBvcnQgbGV0IGN1cnJlbnRMaXN0ID0gW10KZXhwb3J0IGxldCBwZWVyQ291bnQgPSAwCgovLyBXcml0ZXIgdHJhY2tpbmcKZXhwb3J0IGNvbnN0IGtub3duV3JpdGVycyA9IG5ldyBTZXQoKQpleHBvcnQgbGV0IGFkZGVkU3RhdGljUGVlcnMgPSBmYWxzZQoKLy8gU3RhdGUgZmxhZ3MKZXhwb3J0IGxldCBpc1Jlc2V0dGluZ1N0YXRlID0gZmFsc2UKCi8vIFRyYW5zaWVudCBlcnJvciB0cmFja2luZwpleHBvcnQgbGV0IHRyYW5zaWVudEVycm9yQ291bnQgPSAwCmV4cG9ydCBsZXQgbGFzdFRyYW5zaWVudEVycm9yVGltZSA9IDAKZXhwb3J0IGNvbnN0IE1BWF9UUkFOU0lFTlRfRVJST1JTID0gMTAKZXhwb3J0IGNvbnN0IERFRkFVTFRfTElTVCA9IFsKICAgIHsgdGV4dDogJ1RhcCB0byBtYXJrIGFzIGRvbmUnLCBpc0RvbmU6IGZhbHNlLCB0aW1lT2ZDb21wbGV0aW9uOiAwIH0sCiAgICB7IHRleHQ6ICdEb3VibGUgdGFwIHRvIGFkZCBuZXcnLCBpc0RvbmU6IGZhbHNlLCB0aW1lT2ZDb21wbGV0aW9uOiAwIH0sCiAgICB7IHRleHQ6ICdTbGlkZSByaWdodCBzbG93bHkgdG8gZGVsZXRlJywgaXNEb25lOiBmYWxzZSwgdGltZU9mQ29tcGxldGlvbjogMCB9LApdCgoKLy8gU2V0dGVycyBmb3IgbXV0YWJsZSBzdGF0ZQpleHBvcnQgZnVuY3Rpb24gc2V0QXV0b2Jhc2UodmFsKSB7IGF1dG9iYXNlID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldFN0b3JlKHZhbCkgeyBzdG9yZSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRTd2FybSh2YWwpIHsgc3dhcm0gPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0RGlzY292ZXJ5KHZhbCkgeyBkaXNjb3ZlcnkgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0UnBjKHZhbCkgeyBycGMgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0QmFzZUtleSh2YWwpIHsgYmFzZUtleSA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRDdXJyZW50VG9waWModmFsKSB7IGN1cnJlbnRUb3BpYyA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRFbmNyeXB0aW9uS2V5KHZhbCkgeyBlbmNyeXB0aW9uS2V5ID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldFBhaXJpbmcodmFsKSB7IHBhaXJpbmcgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0UGFpcmluZ01lbWJlcih2YWwpIHsgcGFpcmluZ01lbWJlciA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRDdXJyZW50SW52aXRlKHZhbCkgeyBjdXJyZW50SW52aXRlID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldEN1cnJlbnRMaXN0KHZhbCkgeyBjdXJyZW50TGlzdCA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRQZWVyQ291bnQodmFsKSB7IHBlZXJDb3VudCA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRBZGRlZFN0YXRpY1BlZXJzKHZhbCkgeyBhZGRlZFN0YXRpY1BlZXJzID0gdmFsIH0KZXhwb3J0IGZ1bmN0aW9uIHNldElzUmVzZXR0aW5nU3RhdGUodmFsKSB7IGlzUmVzZXR0aW5nU3RhdGUgPSB2YWwgfQpleHBvcnQgZnVuY3Rpb24gc2V0VHJhbnNpZW50RXJyb3JDb3VudCh2YWwpIHsgdHJhbnNpZW50RXJyb3JDb3VudCA9IHZhbCB9CmV4cG9ydCBmdW5jdGlvbiBzZXRMYXN0VHJhbnNpZW50RXJyb3JUaW1lKHZhbCkgeyBsYXN0VHJhbnNpZW50RXJyb3JUaW1lID0gdmFsIH0KCi8vIEhlbHBlciB0byBjbGVhciBrbm93biB3cml0ZXJzCmV4cG9ydCBmdW5jdGlvbiBjbGVhcktub3duV3JpdGVycygpIHsga25vd25Xcml0ZXJzLmNsZWFyKCkgfQovLyBHZW5lcmF0ZSB1bmlxdWUgSUQgKHVzZWQgb25seSBmb3IgYWRkSXRlbSkKaW1wb3J0IHtyYW5kb21CeXRlc30gZnJvbSAiYmFyZS1jcnlwdG8iOwoKZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlSWQgKCkgewogICAgcmV0dXJuIHJhbmRvbUJ5dGVzKDE2KS50b1N0cmluZygnaGV4JykKfWNvbnN0IHsgUHVsbCwgUHVzaCwgSEVBREVSQllURVMsIEtFWUJZVEVTLCBBQllURVMgfSA9IHJlcXVpcmUoJ3NvZGl1bS1zZWNyZXRzdHJlYW0nKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IHsgRHVwbGV4LCBXcml0YWJsZSwgZ2V0U3RyZWFtRXJyb3IgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBUaW1lb3V0ID0gcmVxdWlyZSgndGltZW91dC1yZWZyZXNoJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKY29uc3QgQnJpZGdlID0gcmVxdWlyZSgnLi9saWIvYnJpZGdlJykKY29uc3QgSGFuZHNoYWtlID0gcmVxdWlyZSgnLi9saWIvaGFuZHNoYWtlJykKCmNvbnN0IElESEVBREVSQllURVMgPSBIRUFERVJCWVRFUyArIDMyCmNvbnN0IFtOU19JTklUSUFUT1IsIE5TX1JFU1BPTkRFUiwgTlNfU0VORF0gPSBjcnlwdG8ubmFtZXNwYWNlKCdoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nLCAzKQpjb25zdCBNQVhfQVRPTUlDX1dSSVRFID0gMjU2ICogMjU2ICogMjU2IC0gMQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOb2lzZVNlY3JldFN0cmVhbSBleHRlbmRzIER1cGxleCB7CiAgY29uc3RydWN0b3IoaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcih7IG1hcFdyaXRhYmxlOiB0b0J1ZmZlciB9KQoKICAgIGlmICh0eXBlb2YgaXNJbml0aWF0b3IgIT09ICdib29sZWFuJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lzSW5pdGlhdG9yIHNob3VsZCBiZSBhIGJvb2xlYW4nKQogICAgfQoKICAgIHRoaXMubm9pc2VTdHJlYW0gPSB0aGlzCiAgICB0aGlzLmlzSW5pdGlhdG9yID0gaXNJbml0aWF0b3IKICAgIHRoaXMucmF3U3RyZWFtID0gbnVsbAoKICAgIHRoaXMucHVibGljS2V5ID0gb3B0cy5wdWJsaWNLZXkgfHwgbnVsbAogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSBvcHRzLnJlbW90ZVB1YmxpY0tleSB8fCBudWxsCiAgICB0aGlzLmhhbmRzaGFrZUhhc2ggPSBudWxsCiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlCiAgICB0aGlzLmtlZXBBbGl2ZSA9IG9wdHMua2VlcEFsaXZlIHx8IDAKICAgIHRoaXMudGltZW91dCA9IDAKICAgIHRoaXMuZW5hYmxlU2VuZCA9IG9wdHMuZW5hYmxlU2VuZCAhPT0gZmFsc2UKCiAgICAvLyBwb2ludGVyIGZvciB1cHN0cmVhbSB0byBzZXQgZGF0YSBoZXJlIGlmIHRoZXkgd2FudAogICAgdGhpcy51c2VyRGF0YSA9IG51bGwKCiAgICBsZXQgb3BlbmVkRG9uZSA9IG51bGwKICAgIHRoaXMub3BlbmVkID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgb3BlbmVkRG9uZSA9IHJlc29sdmUKICAgIH0pCgogICAgdGhpcy5yYXdCeXRlc1dyaXR0ZW4gPSAwCiAgICB0aGlzLnJhd0J5dGVzUmVhZCA9IDAKCiAgICAvLyBtZXRhZGF0YSB1c2VkIGJ5ICdoeXBlcmRodCcKICAgIHRoaXMucmVsYXkgPSBudWxsCiAgICB0aGlzLnB1bmNoZXIgPSBudWxsCgogICAgLy8gdW53cmFwcGVkIHJhdyBzdHJlYW0KICAgIHRoaXMuX3Jhd1N0cmVhbSA9IG51bGwKCiAgICAvLyBoYW5kc2hha2Ugc3RhdGUKICAgIHRoaXMuX2hhbmRzaGFrZSA9IG51bGwKICAgIHRoaXMuX2hhbmRzaGFrZVBhdHRlcm4gPSBvcHRzLnBhdHRlcm4gfHwgbnVsbAogICAgdGhpcy5faGFuZHNoYWtlRG9uZSA9IG51bGwKCiAgICAvLyBtZXNzYWdlIHBhcnNpbmcgc3RhdGUKICAgIHRoaXMuX3N0YXRlID0gMAogICAgdGhpcy5fbGVuID0gMAogICAgdGhpcy5fdG1wID0gMQogICAgdGhpcy5fbWVzc2FnZSA9IG51bGwKCiAgICB0aGlzLl9vcGVuZWREb25lID0gb3BlbmVkRG9uZQogICAgdGhpcy5fc3RhcnREb25lID0gbnVsbAogICAgdGhpcy5fZHJhaW5Eb25lID0gbnVsbAogICAgdGhpcy5fb3V0Z29pbmdQbGFpbiA9IG51bGwKICAgIHRoaXMuX291dGdvaW5nV3JhcHBlZCA9IG51bGwKICAgIHRoaXMuX3V0cCA9IG51bGwKICAgIHRoaXMuX3NldHVwID0gdHJ1ZQogICAgdGhpcy5fZW5kZWQgPSAyCiAgICB0aGlzLl9lbmNyeXB0ID0gbnVsbAogICAgdGhpcy5fZGVjcnlwdCA9IG51bGwKICAgIHRoaXMuX3RpbWVvdXRUaW1lciA9IG51bGwKICAgIHRoaXMuX2tlZXBBbGl2ZVRpbWVyID0gbnVsbAogICAgdGhpcy5fc2VuZFN0YXRlID0gbnVsbAoKICAgIGlmIChvcHRzLmF1dG9TdGFydCAhPT0gZmFsc2UpIHRoaXMuc3RhcnQocmF3U3RyZWFtLCBvcHRzKQoKICAgIC8vIHdpZ2dsZSBpdCB0byB0cmlnZ2VyIG9wZW4gaW1tZWRpYXRlbHkgKFRPRE8gYWRkIHN0cmVhbXggb3B0aW9uIGZvciB0aGlzKQogICAgdGhpcy5yZXN1bWUoKQogICAgdGhpcy5wYXVzZSgpCiAgfQoKICBzdGF0aWMga2V5UGFpcihzZWVkKSB7CiAgICByZXR1cm4gSGFuZHNoYWtlLmtleVBhaXIoc2VlZCkKICB9CgogIHN0YXRpYyBpZChoYW5kc2hha2VIYXNoLCBpc0luaXRpYXRvciwgaWQpIHsKICAgIHJldHVybiBzdHJlYW1JZChoYW5kc2hha2VIYXNoLCBpc0luaXRpYXRvciwgaWQpCiAgfQoKICBzZXRUaW1lb3V0KG1zKSB7CiAgICBpZiAoIW1zKSBtcyA9IDAKCiAgICB0aGlzLl9jbGVhclRpbWVvdXQoKQogICAgdGhpcy50aW1lb3V0ID0gbXMKCiAgICBpZiAoIW1zIHx8IHRoaXMucmF3U3RyZWFtID09PSBudWxsKSByZXR1cm4KCiAgICB0aGlzLl90aW1lb3V0VGltZXIgPSBUaW1lb3V0Lm9uY2UobXMsIGRlc3Ryb3lUaW1lb3V0LCB0aGlzKQogICAgdGhpcy5fdGltZW91dFRpbWVyLnVucmVmKCkKICB9CgogIHNldEtlZXBBbGl2ZShtcykgewogICAgaWYgKCFtcykgbXMgPSAwCgogICAgdGhpcy5fY2xlYXJLZWVwQWxpdmUoKQoKICAgIHRoaXMua2VlcEFsaXZlID0gbXMKCiAgICBpZiAoIW1zIHx8IHRoaXMucmF3U3RyZWFtID09PSBudWxsKSByZXR1cm4KCiAgICB0aGlzLl9rZWVwQWxpdmVUaW1lciA9IFRpbWVvdXQub24obXMsIHNlbmRLZWVwQWxpdmUsIHRoaXMpCiAgICB0aGlzLl9rZWVwQWxpdmVUaW1lci51bnJlZigpCiAgfQoKICBzZW5kS2VlcEFsaXZlKCkgewogICAgY29uc3QgZW1wdHkgPSB0aGlzLmFsbG9jKDApCiAgICB0aGlzLndyaXRlKGVtcHR5KQogIH0KCiAgc3RhcnQocmF3U3RyZWFtLCBvcHRzID0ge30pIHsKICAgIGlmIChyYXdTdHJlYW0pIHsKICAgICAgdGhpcy5yYXdTdHJlYW0gPSByYXdTdHJlYW0KICAgICAgdGhpcy5fcmF3U3RyZWFtID0gcmF3U3RyZWFtCiAgICAgIGlmICh0eXBlb2YgdGhpcy5yYXdTdHJlYW0uc2V0Q29udGVudFNpemUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLl91dHAgPSByYXdTdHJlYW0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5yYXdTdHJlYW0gPSBuZXcgQnJpZGdlKHRoaXMpCiAgICAgIHRoaXMuX3Jhd1N0cmVhbSA9IHRoaXMucmF3U3RyZWFtLnJldmVyc2UKICAgIH0KCiAgICB0aGlzLnJhd1N0cmVhbS5vbignZXJyb3InLCB0aGlzLl9vbnJhd2Vycm9yLmJpbmQodGhpcykpCiAgICB0aGlzLnJhd1N0cmVhbS5vbignY2xvc2UnLCB0aGlzLl9vbnJhd2Nsb3NlLmJpbmQodGhpcykpCgogICAgdGhpcy5fc3RhcnRIYW5kc2hha2Uob3B0cy5oYW5kc2hha2UsIG9wdHMua2V5UGFpciB8fCBudWxsKQogICAgdGhpcy5fY29udGludWVPcGVuKG51bGwpCgogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuCgogICAgaWYgKG9wdHMuZGF0YSkgdGhpcy5fb25yYXdkYXRhKG9wdHMuZGF0YSkKICAgIGlmIChvcHRzLmVuZGVkKSB0aGlzLl9vbnJhd2VuZCgpCgogICAgaWYgKHRoaXMua2VlcEFsaXZlID4gMCAmJiB0aGlzLl9rZWVwQWxpdmVUaW1lciA9PT0gbnVsbCkgewogICAgICB0aGlzLnNldEtlZXBBbGl2ZSh0aGlzLmtlZXBBbGl2ZSkKICAgIH0KCiAgICBpZiAodGhpcy50aW1lb3V0ID4gMCAmJiB0aGlzLl90aW1lb3V0VGltZXIgPT09IG51bGwpIHsKICAgICAgdGhpcy5zZXRUaW1lb3V0KHRoaXMudGltZW91dCkKICAgIH0KICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKChhd2FpdCB0aGlzLm9wZW5lZCkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKICAgIGlmICgoYXdhaXQgV3JpdGFibGUuZHJhaW5lZCh0aGlzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLnJhd1N0cmVhbSAhPT0gbnVsbCAmJiB0aGlzLnJhd1N0cmVhbS5mbHVzaCkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5yYXdTdHJlYW0uZmx1c2goKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfY29udGludWVPcGVuKGVycikgewogICAgaWYgKGVycikgdGhpcy5kZXN0cm95KGVycikKICAgIGlmICh0aGlzLl9zdGFydERvbmUgPT09IG51bGwpIHJldHVybgogICAgY29uc3QgZG9uZSA9IHRoaXMuX3N0YXJ0RG9uZQogICAgdGhpcy5fc3RhcnREb25lID0gbnVsbAogICAgdGhpcy5fb3Blbihkb25lKQogIH0KCiAgX29ua2V5cGFpcnByb21pc2UocCkgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgIGNvbnN0IGNvbnQgPSB0aGlzLl9jb250aW51ZU9wZW4uYmluZCh0aGlzKQoKICAgIHAudGhlbihvbmtleXBhaXIsIGNvbnQpCgogICAgZnVuY3Rpb24gb25rZXlwYWlyKGtwKSB7CiAgICAgIHNlbGYuX29ua2V5cGFpcihrcCkKICAgICAgY29udChudWxsKQogICAgfQogIH0KCiAgX29ua2V5cGFpcihrZXlQYWlyKSB7CiAgICBjb25zdCBwYXR0ZXJuID0gdGhpcy5faGFuZHNoYWtlUGF0dGVybiB8fCAnWFgnCiAgICBjb25zdCByZW1vdGVQdWJsaWNLZXkgPSB0aGlzLnJlbW90ZVB1YmxpY0tleQoKICAgIHRoaXMuX2hhbmRzaGFrZSA9IG5ldyBIYW5kc2hha2UodGhpcy5pc0luaXRpYXRvciwga2V5UGFpciwgcmVtb3RlUHVibGljS2V5LCBwYXR0ZXJuKQogICAgdGhpcy5wdWJsaWNLZXkgPSB0aGlzLl9oYW5kc2hha2Uua2V5UGFpci5wdWJsaWNLZXkKICB9CgogIF9zdGFydEhhbmRzaGFrZShoYW5kc2hha2UsIGtleVBhaXIpIHsKICAgIGlmIChoYW5kc2hha2UpIHsKICAgICAgY29uc3QgeyB0eCwgcngsIGhhc2gsIHB1YmxpY0tleSwgcmVtb3RlUHVibGljS2V5IH0gPSBoYW5kc2hha2UKICAgICAgdGhpcy5fc2V0dXBTZWNyZXRTdHJlYW0odHgsIHJ4LCBoYXNoLCBwdWJsaWNLZXksIHJlbW90ZVB1YmxpY0tleSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCFrZXlQYWlyKSBrZXlQYWlyID0gSGFuZHNoYWtlLmtleVBhaXIoKQoKICAgIGlmICh0eXBlb2Yga2V5UGFpci50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuX29ua2V5cGFpcnByb21pc2Uoa2V5UGFpcikKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX29ua2V5cGFpcihrZXlQYWlyKQogICAgfQogIH0KCiAgX29ucmF3ZXJyb3IoZXJyKSB7CiAgICB0aGlzLmRlc3Ryb3koZXJyKQogIH0KCiAgX29ucmF3Y2xvc2UoKSB7CiAgICBpZiAodGhpcy5fZW5kZWQgIT09IDApIHRoaXMuZGVzdHJveSgpCiAgfQoKICBfb25yYXdkYXRhKGRhdGEpIHsKICAgIGxldCBvZmZzZXQgPSAwCgogICAgaWYgKHRoaXMuX3RpbWVvdXRUaW1lciAhPT0gbnVsbCkgewogICAgICB0aGlzLl90aW1lb3V0VGltZXIucmVmcmVzaCgpCiAgICB9CgogICAgZG8gewogICAgICBzd2l0Y2ggKHRoaXMuX3N0YXRlKSB7CiAgICAgICAgY2FzZSAwOiB7CiAgICAgICAgICB3aGlsZSAodGhpcy5fdG1wICE9PSAweDEwMDAwMDAgJiYgb2Zmc2V0IDwgZGF0YS5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbnN0IHYgPSBkYXRhW29mZnNldCsrXQogICAgICAgICAgICB0aGlzLl9sZW4gKz0gdGhpcy5fdG1wICogdgogICAgICAgICAgICB0aGlzLl90bXAgKj0gMjU2CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRoaXMuX3RtcCA9PT0gMHgxMDAwMDAwKSB7CiAgICAgICAgICAgIHRoaXMuX3RtcCA9IDAKICAgICAgICAgICAgdGhpcy5fc3RhdGUgPSAxCiAgICAgICAgICAgIGNvbnN0IHVucHJvY2Vzc2VkID0gZGF0YS5ieXRlTGVuZ3RoIC0gb2Zmc2V0CiAgICAgICAgICAgIGlmICh1bnByb2Nlc3NlZCA8IHRoaXMuX2xlbiAmJiB0aGlzLl91dHAgIT09IG51bGwpCiAgICAgICAgICAgICAgdGhpcy5fdXRwLnNldENvbnRlbnRTaXplKHRoaXMuX2xlbiAtIHVucHJvY2Vzc2VkKQogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBjYXNlIDE6IHsKICAgICAgICAgIGNvbnN0IG1pc3NpbmcgPSB0aGlzLl9sZW4gLSB0aGlzLl90bXAKICAgICAgICAgIGNvbnN0IGVuZCA9IG1pc3NpbmcgKyBvZmZzZXQKCiAgICAgICAgICBpZiAodGhpcy5fbWVzc2FnZSA9PT0gbnVsbCAmJiBlbmQgPD0gZGF0YS5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIHRoaXMuX21lc3NhZ2UgPSBkYXRhLnN1YmFycmF5KG9mZnNldCwgZW5kKQogICAgICAgICAgICBvZmZzZXQgKz0gbWlzc2luZwogICAgICAgICAgICB0aGlzLl9pbmNvbWluZygpCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgdW5wcm9jZXNzZWQgPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKCiAgICAgICAgICBpZiAodGhpcy5fbWVzc2FnZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLl9tZXNzYWdlID0gYjRhLmFsbG9jVW5zYWZlKHRoaXMuX2xlbikKICAgICAgICAgIH0KCiAgICAgICAgICBiNGEuY29weShkYXRhLCB0aGlzLl9tZXNzYWdlLCB0aGlzLl90bXAsIG9mZnNldCkKICAgICAgICAgIHRoaXMuX3RtcCArPSB1bnByb2Nlc3NlZAoKICAgICAgICAgIGlmIChlbmQgPD0gZGF0YS5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIG9mZnNldCArPSBtaXNzaW5nCiAgICAgICAgICAgIHRoaXMuX2luY29taW5nKCkKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9mZnNldCArPSB1bnByb2Nlc3NlZAogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICB9IHdoaWxlIChvZmZzZXQgPCBkYXRhLmJ5dGVMZW5ndGggJiYgIXRoaXMuZGVzdHJveWluZykKICB9CgogIF9vbnJhd2VuZCgpIHsKICAgIHRoaXMuX2VuZGVkLS0KICAgIHRoaXMucHVzaChudWxsKQogIH0KCiAgX29ucmF3ZHJhaW4oKSB7CiAgICBjb25zdCBkcmFpbiA9IHRoaXMuX2RyYWluRG9uZQogICAgaWYgKGRyYWluID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMuX2RyYWluRG9uZSA9IG51bGwKICAgIGRyYWluKCkKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLnJhd1N0cmVhbS5yZXN1bWUoKQogICAgY2IobnVsbCkKICB9CgogIF9pbmNvbWluZygpIHsKICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLl9tZXNzYWdlCgogICAgdGhpcy5fc3RhdGUgPSAwCiAgICB0aGlzLl9sZW4gPSAwCiAgICB0aGlzLl90bXAgPSAxCiAgICB0aGlzLl9tZXNzYWdlID0gbnVsbAoKICAgIGlmICh0aGlzLl9zZXR1cCA9PT0gdHJ1ZSkgewogICAgICBpZiAodGhpcy5faGFuZHNoYWtlKSB7CiAgICAgICAgdGhpcy5fb25oYW5kc2hha2VydCh0aGlzLl9oYW5kc2hha2UucmVjdihtZXNzYWdlKSkKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobWVzc2FnZS5ieXRlTGVuZ3RoICE9PSBJREhFQURFUkJZVEVTKSB7CiAgICAgICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIGhlYWRlciBtZXNzYWdlIHJlY2VpdmVkJykpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGNvbnN0IHJlbW90ZUlkID0gbWVzc2FnZS5zdWJhcnJheSgwLCAzMikKICAgICAgICBjb25zdCBleHBlY3RlZElkID0gc3RyZWFtSWQodGhpcy5oYW5kc2hha2VIYXNoLCAhdGhpcy5pc0luaXRpYXRvcikKICAgICAgICBjb25zdCBoZWFkZXIgPSBtZXNzYWdlLnN1YmFycmF5KDMyKQoKICAgICAgICBpZiAoIWI0YS5lcXVhbHMoZXhwZWN0ZWRJZCwgcmVtb3RlSWQpKSB7CiAgICAgICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIGhlYWRlciByZWNlaXZlZCcpKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICB0aGlzLl9kZWNyeXB0LmluaXQoaGVhZGVyKQogICAgICAgIHRoaXMuX3NldHVwID0gZmFsc2UgLy8gc2V0dXAgaXMgbm93IGRvbmUKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobWVzc2FnZS5ieXRlTGVuZ3RoIDwgQUJZVEVTKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgbWVzc2FnZSByZWNlaXZlZCcpKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLnJhd0J5dGVzUmVhZCArPSBtZXNzYWdlLmJ5dGVMZW5ndGgKCiAgICBjb25zdCBwbGFpbiA9IG1lc3NhZ2Uuc3ViYXJyYXkoMSwgbWVzc2FnZS5ieXRlTGVuZ3RoIC0gQUJZVEVTICsgMSkKCiAgICB0cnkgewogICAgICB0aGlzLl9kZWNyeXB0Lm5leHQobWVzc2FnZSwgcGxhaW4pCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5kZXN0cm95KGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gSWYga2VlcCBhbGl2ZSBpcyBzZWxlY3RpdmUsIGVhdCB0aGUgZW1wdHkgYnVmZmVycyAoaWUgYXNzdW1lIHRoZSBvdGhlciBzaWRlIGhhcyBpdCBlbmFibGVkIGFsc28pCiAgICBpZiAocGxhaW4uYnl0ZUxlbmd0aCA9PT0gMCAmJiB0aGlzLmtlZXBBbGl2ZSAhPT0gMCkgcmV0dXJuCgogICAgaWYgKHRoaXMucHVzaChwbGFpbikgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMucmF3U3RyZWFtLnBhdXNlKCkKICAgIH0KICB9CgogIF9vbmhhbmRzaGFrZXJ0KGgpIHsKICAgIGlmICh0aGlzLl9oYW5kc2hha2VEb25lID09PSBudWxsKSByZXR1cm4KCiAgICBpZiAoaCAhPT0gbnVsbCkgewogICAgICBpZiAoaC5kYXRhKSB0aGlzLl9yYXdTdHJlYW0ud3JpdGUoaC5kYXRhKQogICAgICBpZiAoIWgudHgpIHJldHVybgogICAgfQoKICAgIGNvbnN0IGRvbmUgPSB0aGlzLl9oYW5kc2hha2VEb25lCiAgICBjb25zdCBwdWJsaWNLZXkgPSB0aGlzLl9oYW5kc2hha2Uua2V5UGFpci5wdWJsaWNLZXkKCiAgICB0aGlzLl9oYW5kc2hha2VEb25lID0gbnVsbAogICAgdGhpcy5faGFuZHNoYWtlID0gbnVsbAoKICAgIGlmIChoID09PSBudWxsKSByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ05vaXNlIGhhbmRzaGFrZSBmYWlsZWQnKSkKCiAgICB0aGlzLl9zZXR1cFNlY3JldFN0cmVhbShoLnR4LCBoLnJ4LCBoLmhhc2gsIHB1YmxpY0tleSwgaC5yZW1vdGVQdWJsaWNLZXkpCiAgICB0aGlzLl9yZXNvbHZlT3BlbmVkKHRydWUpCiAgICBkb25lKG51bGwpCiAgfQoKICBfc2V0dXBTZWNyZXRTdHJlYW0odHgsIHJ4LCBoYW5kc2hha2VIYXNoLCBwdWJsaWNLZXksIHJlbW90ZVB1YmxpY0tleSkgewogICAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzICsgSURIRUFERVJCWVRFUykKICAgIHdyaXRlVWludDI0bGUoSURIRUFERVJCWVRFUywgYnVmKQoKICAgIHRoaXMuX2VuY3J5cHQgPSBuZXcgUHVzaCh1bnNsYWIodHguc3ViYXJyYXkoMCwgS0VZQllURVMpKSwgdW5kZWZpbmVkLCBidWYuc3ViYXJyYXkoMyArIDMyKSkKICAgIHRoaXMuX2RlY3J5cHQgPSBuZXcgUHVsbCh1bnNsYWIocnguc3ViYXJyYXkoMCwgS0VZQllURVMpKSkKCiAgICB0aGlzLnB1YmxpY0tleSA9IHB1YmxpY0tleQogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSByZW1vdGVQdWJsaWNLZXkKICAgIHRoaXMuaGFuZHNoYWtlSGFzaCA9IGhhbmRzaGFrZUhhc2gKCiAgICBjb25zdCBpZCA9IGJ1Zi5zdWJhcnJheSgzLCAzICsgMzIpCiAgICBzdHJlYW1JZChoYW5kc2hha2VIYXNoLCB0aGlzLmlzSW5pdGlhdG9yLCBpZCkKCiAgICAvLyBpbml0aWFsaXplIHNlY3JldGJveCBzdGF0ZSBmb3IgdW5vcmRlcmVkIG1lc3NhZ2VzCiAgICB0aGlzLl9zZXR1cFNlY3JldFNlbmQoaGFuZHNoYWtlSGFzaCkKCiAgICB0aGlzLmVtaXQoJ2hhbmRzaGFrZScpCiAgICAvLyBpZiByYXdTdHJlYW0gaXMgYSBicmlkZ2UsIGFsc28gZW1pdCBpdCB0aGVyZQogICAgaWYgKHRoaXMucmF3U3RyZWFtICE9PSB0aGlzLl9yYXdTdHJlYW0pIHRoaXMucmF3U3RyZWFtLmVtaXQoJ2hhbmRzaGFrZScpCgogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuCgogICAgdGhpcy5fcmF3U3RyZWFtLndyaXRlKGJ1ZikKICB9CgogIF9zZXR1cFNlY3JldFNlbmQoaGFuZHNoYWtlSGFzaCkgewogICAgdGhpcy5fc2VuZFN0YXRlID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMiArIDMyICsgOCArIDgpCiAgICBjb25zdCBlbmNyeXB0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDAsIDMyKSAvLyBzZWNyZXRzCiAgICBjb25zdCBkZWNyeXB0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDMyLCA2NCkKICAgIGNvbnN0IGNvdW50ZXIgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoNjQsIDcyKSAvLyBub25jZQogICAgY29uc3QgaW5pdGlhbCA9IHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSg3MikKCiAgICBjb25zdCBpbnB1dHMgPSB0aGlzLmlzSW5pdGlhdG9yCiAgICAgID8gWwogICAgICAgICAgW05TX0lOSVRJQVRPUiwgTlNfU0VORF0sCiAgICAgICAgICBbTlNfUkVTUE9OREVSLCBOU19TRU5EXQogICAgICAgIF0KICAgICAgOiBbCiAgICAgICAgICBbTlNfUkVTUE9OREVSLCBOU19TRU5EXSwKICAgICAgICAgIFtOU19JTklUSUFUT1IsIE5TX1NFTkRdCiAgICAgICAgXQoKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goZW5jcnlwdCwgaW5wdXRzWzBdLCBoYW5kc2hha2VIYXNoKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChkZWNyeXB0LCBpbnB1dHNbMV0sIGhhbmRzaGFrZUhhc2gpCgogICAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1Zihpbml0aWFsKQogICAgY291bnRlci5zZXQoaW5pdGlhbCkKICB9CgogIF9vcGVuKGNiKSB7CiAgICAvLyBubyBhdXRvc3RhcnQgb3Igbm8gaGFuZHNoYWtlIHlldAogICAgaWYgKHRoaXMuX3Jhd1N0cmVhbSA9PT0gbnVsbCB8fCAodGhpcy5faGFuZHNoYWtlID09PSBudWxsICYmIHRoaXMuX2VuY3J5cHQgPT09IG51bGwpKSB7CiAgICAgIHRoaXMuX3N0YXJ0RG9uZSA9IGNiCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX3Jhd1N0cmVhbS5vbignZGF0YScsIHRoaXMuX29ucmF3ZGF0YS5iaW5kKHRoaXMpKQogICAgdGhpcy5fcmF3U3RyZWFtLm9uKCdlbmQnLCB0aGlzLl9vbnJhd2VuZC5iaW5kKHRoaXMpKQogICAgdGhpcy5fcmF3U3RyZWFtLm9uKCdkcmFpbicsIHRoaXMuX29ucmF3ZHJhaW4uYmluZCh0aGlzKSkKCiAgICBpZiAodGhpcy5lbmFibGVTZW5kKSB0aGlzLl9yYXdTdHJlYW0ub24oJ21lc3NhZ2UnLCB0aGlzLl9vbm1lc3NhZ2UuYmluZCh0aGlzKSkKCiAgICBpZiAodGhpcy5fZW5jcnlwdCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9yZXNvbHZlT3BlbmVkKHRydWUpCiAgICAgIHJldHVybiBjYihudWxsKQogICAgfQoKICAgIHRoaXMuX2hhbmRzaGFrZURvbmUgPSBjYgoKICAgIGlmICh0aGlzLmlzSW5pdGlhdG9yKSB0aGlzLl9vbmhhbmRzaGFrZXJ0KHRoaXMuX2hhbmRzaGFrZS5zZW5kKCkpCiAgfQoKICBfcHJlZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLnJhd1N0cmVhbSkgewogICAgICBjb25zdCBlcnJvciA9IGdldFN0cmVhbUVycm9yKHRoaXMpCiAgICAgIHRoaXMucmF3U3RyZWFtLmRlc3Ryb3koZXJyb3IpCiAgICB9CgogICAgaWYgKHRoaXMuX3N0YXJ0RG9uZSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkb25lID0gdGhpcy5fc3RhcnREb25lCiAgICAgIHRoaXMuX3N0YXJ0RG9uZSA9IG51bGwKICAgICAgZG9uZShuZXcgRXJyb3IoJ1N0cmVhbSBkZXN0cm95ZWQnKSkKICAgIH0KCiAgICBpZiAodGhpcy5faGFuZHNoYWtlRG9uZSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkb25lID0gdGhpcy5faGFuZHNoYWtlRG9uZQogICAgICB0aGlzLl9oYW5kc2hha2VEb25lID0gbnVsbAogICAgICBkb25lKG5ldyBFcnJvcignU3RyZWFtIGRlc3Ryb3llZCcpKQogICAgfQoKICAgIGlmICh0aGlzLl9kcmFpbkRvbmUgIT09IG51bGwpIHsKICAgICAgY29uc3QgZG9uZSA9IHRoaXMuX2RyYWluRG9uZQogICAgICB0aGlzLl9kcmFpbkRvbmUgPSBudWxsCiAgICAgIGRvbmUobmV3IEVycm9yKCdTdHJlYW0gZGVzdHJveWVkJykpCiAgICB9CiAgfQoKICBfd3JpdGUoZGF0YSwgY2IpIHsKICAgIGxldCB3cmFwcGVkID0gdGhpcy5fb3V0Z29pbmdXcmFwcGVkCgogICAgaWYgKGRhdGEgIT09IHRoaXMuX291dGdvaW5nUGxhaW4pIHsKICAgICAgd3JhcHBlZCA9IGI0YS5hbGxvY1Vuc2FmZShkYXRhLmJ5dGVMZW5ndGggKyAzICsgQUJZVEVTKQogICAgICB3cmFwcGVkLnNldChkYXRhLCA0KQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fb3V0Z29pbmdXcmFwcGVkID0gdGhpcy5fb3V0Z29pbmdQbGFpbiA9IG51bGwKICAgIH0KCiAgICBpZiAod3JhcHBlZC5ieXRlTGVuZ3RoIC0gMyA+IE1BWF9BVE9NSUNfV1JJVEUpIHsKICAgICAgcmV0dXJuIGNiKAogICAgICAgIG5ldyBFcnJvcigKICAgICAgICAgICdNZXNzYWdlIGlzIHRvbyBsYXJnZSBmb3IgYW4gYXRvbWljIHdyaXRlLiBNYXggc2l6ZSBpcyAnICsgTUFYX0FUT01JQ19XUklURSArICcgYnl0ZXMuJwogICAgICAgICkKICAgICAgKQogICAgfQogICAgdGhpcy5yYXdCeXRlc1dyaXR0ZW4gKz0gd3JhcHBlZC5ieXRlTGVuZ3RoCgogICAgd3JpdGVVaW50MjRsZSh3cmFwcGVkLmJ5dGVMZW5ndGggLSAzLCB3cmFwcGVkKQogICAgLy8gb2Zmc2V0IDQgc28gd2UgY2FuIGRvIGl0IGluLXBsYWNlCiAgICB0aGlzLl9lbmNyeXB0Lm5leHQod3JhcHBlZC5zdWJhcnJheSg0LCA0ICsgZGF0YS5ieXRlTGVuZ3RoKSwgd3JhcHBlZC5zdWJhcnJheSgzKSkKCiAgICBpZiAodGhpcy5fa2VlcEFsaXZlVGltZXIgIT09IG51bGwpIHRoaXMuX2tlZXBBbGl2ZVRpbWVyLnJlZnJlc2goKQoKICAgIGlmICh0aGlzLl9yYXdTdHJlYW0ud3JpdGUod3JhcHBlZCkgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX2RyYWluRG9uZSA9IGNiCiAgICB9IGVsc2UgewogICAgICBjYihudWxsKQogICAgfQogIH0KCiAgX2ZpbmFsKGNiKSB7CiAgICB0aGlzLl9jbGVhcktlZXBBbGl2ZSgpCiAgICB0aGlzLl9lbmRlZC0tCiAgICB0aGlzLl9yYXdTdHJlYW0uZW5kKCkKICAgIGNiKG51bGwpCiAgfQoKICBfcmVzb2x2ZU9wZW5lZCh2YWwpIHsKICAgIGlmICh0aGlzLl9vcGVuZWREb25lID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IG9wZW5lZCA9IHRoaXMuX29wZW5lZERvbmUKICAgIHRoaXMuX29wZW5lZERvbmUgPSBudWxsCiAgICBvcGVuZWQodmFsKQogICAgaWYgKCF2YWwpIHJldHVybgogICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2Nvbm5lY3QnKQogIH0KCiAgX2NsZWFyVGltZW91dCgpIHsKICAgIGlmICh0aGlzLl90aW1lb3V0VGltZXIgPT09IG51bGwpIHJldHVybgogICAgdGhpcy5fdGltZW91dFRpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5fdGltZW91dFRpbWVyID0gbnVsbAogICAgdGhpcy50aW1lb3V0ID0gMAogIH0KCiAgX2NsZWFyS2VlcEFsaXZlKCkgewogICAgaWYgKHRoaXMuX2tlZXBBbGl2ZVRpbWVyID09PSBudWxsKSByZXR1cm4KICAgIHRoaXMuX2tlZXBBbGl2ZVRpbWVyLmRlc3Ryb3koKQogICAgdGhpcy5fa2VlcEFsaXZlVGltZXIgPSBudWxsCiAgICB0aGlzLmtlZXBBbGl2ZSA9IDAKICB9CgogIF9kZXN0cm95KGNiKSB7CiAgICB0aGlzLl9jbGVhcktlZXBBbGl2ZSgpCiAgICB0aGlzLl9jbGVhclRpbWVvdXQoKQogICAgdGhpcy5fcmVzb2x2ZU9wZW5lZChmYWxzZSkKICAgIGNiKG51bGwpCiAgfQoKICBfYm94TWVzc2FnZShidWZmZXIpIHsKICAgIGNvbnN0IE1CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMgLy8gMTYKICAgIGNvbnN0IE5CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUyAvLyAyNAoKICAgIGNvbnN0IGNvdW50ZXIgPSB0aGlzLl9zZW5kU3RhdGUuc3ViYXJyYXkoNjQsIDcyKQogICAgc29kaXVtLnNvZGl1bV9pbmNyZW1lbnQoY291bnRlcikKICAgIGlmIChiNGEuZXF1YWxzKGNvdW50ZXIsIHRoaXMuX3NlbmRTdGF0ZS5zdWJhcnJheSg3MikpKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ3VkcCBzZW5kIG5vbmNlIGV4Y2hhdXN0ZWQnKSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3Qgc2VjcmV0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDAsIDMyKQogICAgY29uc3QgZW52ZWxvcGUgPSBiNGEuYWxsb2NVbnNhZmUoOCArIE1CICsgYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICBjb25zdCBub25jZSA9IGVudmVsb3BlLnN1YmFycmF5KDAsIE5CKQogICAgY29uc3QgY2lwaGVydGV4dCA9IGVudmVsb3BlLnN1YmFycmF5KDgpCgogICAgYjRhLmZpbGwobm9uY2UsIDApIC8vIHBhZCBzdWZmaXgKICAgIG5vbmNlLnNldChjb3VudGVyKQoKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X2Vhc3koY2lwaGVydGV4dCwgYnVmZmVyLCBub25jZSwgc2VjcmV0KQogICAgcmV0dXJuIGVudmVsb3BlCiAgfQoKICBzZW5kKGJ1ZmZlcikgewogICAgaWYgKCF0aGlzLl9zZW5kU3RhdGUpIHJldHVybgogICAgaWYgKCF0aGlzLnJhd1N0cmVhbT8uc2VuZCkgcmV0dXJuIC8vIHVkeC1zdHJlYW0gZXhwZWN0ZWQKCiAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5fYm94TWVzc2FnZShidWZmZXIpCiAgICByZXR1cm4gdGhpcy5yYXdTdHJlYW0uc2VuZChtZXNzYWdlKQogIH0KCiAgdHJ5U2VuZChidWZmZXIpIHsKICAgIGlmICghdGhpcy5fc2VuZFN0YXRlKSByZXR1cm4KICAgIGlmICghdGhpcy5yYXdTdHJlYW0/LnRyeVNlbmQpIHJldHVybiAvLyB1ZHgtc3RyZWFtIGV4cGVjdGVkCgogICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuX2JveE1lc3NhZ2UoYnVmZmVyKQogICAgdGhpcy5yYXdTdHJlYW0udHJ5U2VuZChtZXNzYWdlKQogIH0KCiAgX29ubWVzc2FnZShidWZmZXIpIHsKICAgIGlmICghdGhpcy5fc2VuZFN0YXRlKSByZXR1cm4gLy8gbWVzc2FnZXMgYmVmb3JlIGhhbmRzaGFrZSBhcmUgZHJvcHBlZAoKICAgIGNvbnN0IE1CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMgLy8gMTYKICAgIGNvbnN0IE5CID0gc29kaXVtLmNyeXB0b19zZWNyZXRib3hfTk9OQ0VCWVRFUyAvLyAyNAoKICAgIGlmIChidWZmZXIuYnl0ZUxlbmd0aCA8IE5CKSByZXR1cm4gLy8gSW52YWxpZCBtZXNzYWdlCgogICAgY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2NVbnNhZmUoTkIpCiAgICBiNGEuZmlsbChub25jZSwgMCkKICAgIG5vbmNlLnNldChidWZmZXIuc3ViYXJyYXkoMCwgOCkpCgogICAgY29uc3Qgc2VjcmV0ID0gdGhpcy5fc2VuZFN0YXRlLnN1YmFycmF5KDMyLCA2NCkKICAgIGNvbnN0IGNpcGhlcnRleHQgPSBidWZmZXIuc3ViYXJyYXkoOCkKICAgIGNvbnN0IHBsYWluID0gYnVmZmVyLnN1YmFycmF5KDgsIGJ1ZmZlci5ieXRlTGVuZ3RoIC0gTUIpCgogICAgaWYgKGNpcGhlcnRleHQuYnl0ZUxlbmd0aCA8IE1CKSByZXR1cm4gLy8gaW52YWxpZCBtZXNzYWdlCgogICAgY29uc3Qgc3VjY2VzcyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZWFzeShwbGFpbiwgY2lwaGVydGV4dCwgbm9uY2UsIHNlY3JldCkKCiAgICBpZiAoc3VjY2VzcykgdGhpcy5lbWl0KCdtZXNzYWdlJywgcGxhaW4pCiAgfQoKICBhbGxvYyhsZW4pIHsKICAgIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShsZW4gKyAzICsgQUJZVEVTKQogICAgdGhpcy5fb3V0Z29pbmdXcmFwcGVkID0gYnVmCiAgICB0aGlzLl9vdXRnb2luZ1BsYWluID0gYnVmLnN1YmFycmF5KDQsIGJ1Zi5ieXRlTGVuZ3RoIC0gQUJZVEVTICsgMSkKICAgIHJldHVybiB0aGlzLl9vdXRnb2luZ1BsYWluCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBpc0luaXRpYXRvcjogdGhpcy5pc0luaXRpYXRvciwKICAgICAgcHVibGljS2V5OiB0aGlzLnB1YmxpY0tleSAmJiBiNGEudG9TdHJpbmcodGhpcy5wdWJsaWNLZXksICdoZXgnKSwKICAgICAgcmVtb3RlUHVibGljS2V5OiB0aGlzLnJlbW90ZVB1YmxpY0tleSAmJiBiNGEudG9TdHJpbmcodGhpcy5yZW1vdGVQdWJsaWNLZXksICdoZXgnKSwKICAgICAgY29ubmVjdGVkOiB0aGlzLmNvbm5lY3RlZCwKICAgICAgZGVzdHJveWluZzogdGhpcy5kZXN0cm95aW5nLAogICAgICBkZXN0cm95ZWQ6IHRoaXMuZGVzdHJveWVkLAogICAgICByYXdTdHJlYW06IHRoaXMucmF3U3RyZWFtICYmIHRoaXMucmF3U3RyZWFtLnRvSlNPTiA/IHRoaXMucmF3U3RyZWFtLnRvSlNPTigpIDogbnVsbAogICAgfQogIH0KfQoKZnVuY3Rpb24gd3JpdGVVaW50MjRsZShuLCBidWYpIHsKICBidWZbMF0gPSBuICYgMjU1CiAgYnVmWzFdID0gKG4gPj4+IDgpICYgMjU1CiAgYnVmWzJdID0gKG4gPj4+IDE2KSAmIDI1NQp9CgpmdW5jdGlvbiBzdHJlYW1JZChoYW5kc2hha2VIYXNoLCBpc0luaXRpYXRvciwgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKSkgewogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBpc0luaXRpYXRvciA/IE5TX0lOSVRJQVRPUiA6IE5TX1JFU1BPTkRFUiwgaGFuZHNoYWtlSGFzaCkKICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIHRvQnVmZmVyKGRhdGEpIHsKICByZXR1cm4gdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnID8gYjRhLmZyb20oZGF0YSkgOiBkYXRhCn0KCmZ1bmN0aW9uIGRlc3Ryb3lUaW1lb3V0KCkgewogIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ1N0cmVhbSB0aW1lZCBvdXQnKSkKfQoKZnVuY3Rpb24gc2VuZEtlZXBBbGl2ZSgpIHsKICBjb25zdCBlbXB0eSA9IHRoaXMuYWxsb2MoMCkKICB0aGlzLndyaXRlKGVtcHR5KQp9CmNvbnN0IHsgRHVwbGV4LCBXcml0YWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCgpjbGFzcyBSZXZlcnNlUGFzc1Rocm91Z2ggZXh0ZW5kcyBEdXBsZXggewogIGNvbnN0cnVjdG9yKHMpIHsKICAgIHN1cGVyKCkKICAgIHRoaXMuX3N0cmVhbSA9IHMKICAgIHRoaXMuX29uZHJhaW4gPSBudWxsCiAgfQoKICBfd3JpdGUoZGF0YSwgY2IpIHsKICAgIGlmICh0aGlzLl9zdHJlYW0ucHVzaChkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fc3RyZWFtLl9vbmRyYWluID0gY2IKICAgIH0gZWxzZSB7CiAgICAgIGNiKG51bGwpCiAgICB9CiAgfQoKICBfZmluYWwoY2IpIHsKICAgIHRoaXMuX3N0cmVhbS5wdXNoKG51bGwpCiAgICBjYihudWxsKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIGNvbnN0IG9uZHJhaW4gPSB0aGlzLl9vbmRyYWluCiAgICB0aGlzLl9vbmRyYWluID0gbnVsbAogICAgaWYgKG9uZHJhaW4pIG9uZHJhaW4oKQogICAgY2IobnVsbCkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQnJpZGdlIGV4dGVuZHMgRHVwbGV4IHsKICBjb25zdHJ1Y3Rvcihub2lzZVN0cmVhbSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMubm9pc2VTdHJlYW0gPSBub2lzZVN0cmVhbQoKICAgIHRoaXMuX29uZHJhaW4gPSBudWxsCiAgICB0aGlzLnJldmVyc2UgPSBuZXcgUmV2ZXJzZVBhc3NUaHJvdWdoKHRoaXMpCiAgfQoKICBnZXQgcHVibGljS2V5KCkgewogICAgcmV0dXJuIHRoaXMubm9pc2VTdHJlYW0ucHVibGljS2V5CiAgfQoKICBnZXQgcmVtb3RlUHVibGljS2V5KCkgewogICAgcmV0dXJuIHRoaXMubm9pc2VTdHJlYW0ucmVtb3RlUHVibGljS2V5CiAgfQoKICBnZXQgaGFuZHNoYWtlSGFzaCgpIHsKICAgIHJldHVybiB0aGlzLm5vaXNlU3RyZWFtLmhhbmRzaGFrZUhhc2gKICB9CgogIGZsdXNoKCkgewogICAgcmV0dXJuIFdyaXRhYmxlLmRyYWluZWQodGhpcykKICB9CgogIF9yZWFkKGNiKSB7CiAgICBjb25zdCBvbmRyYWluID0gdGhpcy5fb25kcmFpbgogICAgdGhpcy5fb25kcmFpbiA9IG51bGwKICAgIGlmIChvbmRyYWluKSBvbmRyYWluKCkKICAgIGNiKG51bGwpCiAgfQoKICBfd3JpdGUoZGF0YSwgY2IpIHsKICAgIGlmICh0aGlzLnJldmVyc2UucHVzaChkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5yZXZlcnNlLl9vbmRyYWluID0gY2IKICAgIH0gZWxzZSB7CiAgICAgIGNiKG51bGwpCiAgICB9CiAgfQoKICBfZmluYWwoY2IpIHsKICAgIHRoaXMucmV2ZXJzZS5wdXNoKG51bGwpCiAgICBjYihudWxsKQogIH0KfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgY3VydmUgPSByZXF1aXJlKCdub2lzZS1jdXJ2ZS1lZCcpCmNvbnN0IE5vaXNlID0gcmVxdWlyZSgnbm9pc2UtaGFuZHNoYWtlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhhbmRzaGFrZSB7CiAgY29uc3RydWN0b3IoaXNJbml0aWF0b3IsIGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSwgcGF0dGVybikgewogICAgdGhpcy5pc0luaXRpYXRvciA9IGlzSW5pdGlhdG9yCiAgICB0aGlzLmtleVBhaXIgPSBrZXlQYWlyCiAgICB0aGlzLm5vaXNlID0gbmV3IE5vaXNlKHBhdHRlcm4sIGlzSW5pdGlhdG9yLCBrZXlQYWlyLCB7IGN1cnZlIH0pCiAgICB0aGlzLm5vaXNlLmluaXRpYWxpc2UoRU1QVFksIHJlbW90ZVB1YmxpY0tleSkKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICB9CgogIHN0YXRpYyBrZXlQYWlyKHNlZWQpIHsKICAgIGNvbnN0IHB1YmxpY0tleSA9IGI0YS5hbGxvYygzMikKICAgIGNvbnN0IHNlY3JldEtleSA9IGI0YS5hbGxvYyg2NCkKICAgIGlmIChzZWVkKSBzb2RpdW0uY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5LCBzZWVkKQogICAgZWxzZSBzb2RpdW0uY3J5cHRvX3NpZ25fa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSkKICAgIHJldHVybiB7IHB1YmxpY0tleSwgc2VjcmV0S2V5IH0KICB9CgogIHJlY3YoZGF0YSkgewogICAgdHJ5IHsKICAgICAgdGhpcy5ub2lzZS5yZWN2KGRhdGEpCiAgICAgIGlmICh0aGlzLm5vaXNlLmNvbXBsZXRlKSByZXR1cm4gdGhpcy5fcmV0dXJuKG51bGwpCiAgICAgIHJldHVybiB0aGlzLnNlbmQoKQogICAgfSBjYXRjaCB7CiAgICAgIHRoaXMuZGVzdHJveSgpCiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICAvLyBub3RlIHRoYXQgdGhlIGRhdGEgcmV0dXJuZWQgaGVyZSBpcyBmcmFtZWQgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyBhbiBleHRyYSBjb3B5CiAgLy8gd2hlbiBzZW5kaW5nIGl0Li4uCiAgc2VuZCgpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLm5vaXNlLnNlbmQoKQogICAgICBjb25zdCB3cmFwID0gYjRhLmFsbG9jVW5zYWZlKGRhdGEuYnl0ZUxlbmd0aCArIDMpCgogICAgICB3cml0ZVVpbnQyNGxlKGRhdGEuYnl0ZUxlbmd0aCwgd3JhcCkKICAgICAgd3JhcC5zZXQoZGF0YSwgMykKCiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm4od3JhcCkKICAgIH0gY2F0Y2ggewogICAgICB0aGlzLmRlc3Ryb3koKQogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICB9CgogIF9yZXR1cm4oZGF0YSkgewogICAgY29uc3QgdHggPSB0aGlzLm5vaXNlLmNvbXBsZXRlID8gYjRhLnRvQnVmZmVyKHRoaXMubm9pc2UudHgpIDogbnVsbAogICAgY29uc3QgcnggPSB0aGlzLm5vaXNlLmNvbXBsZXRlID8gYjRhLnRvQnVmZmVyKHRoaXMubm9pc2UucngpIDogbnVsbAogICAgY29uc3QgaGFzaCA9IHRoaXMubm9pc2UuY29tcGxldGUgPyBiNGEudG9CdWZmZXIodGhpcy5ub2lzZS5oYXNoKSA6IG51bGwKICAgIGNvbnN0IHJlbW90ZVB1YmxpY0tleSA9IHRoaXMubm9pc2UuY29tcGxldGUgPyBiNGEudG9CdWZmZXIodGhpcy5ub2lzZS5ycykgOiBudWxsCgogICAgcmV0dXJuIHsKICAgICAgZGF0YSwKICAgICAgcmVtb3RlUHVibGljS2V5LAogICAgICBoYXNoLAogICAgICB0eCwKICAgICAgcngKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHdyaXRlVWludDI0bGUobiwgYnVmKSB7CiAgYnVmWzBdID0gbiAmIDI1NQogIGJ1ZlsxXSA9IChuID4+PiA4KSAmIDI1NQogIGJ1ZlsyXSA9IChuID4+PiAxNikgJiAyNTUKfQp7CiAgIm5hbWUiOiAiQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbSIsCiAgInZlcnNpb24iOiAiNi45LjEiLAogICJkZXNjcmlwdGlvbiI6ICJTZWNyZXQgc3RyZWFtIGJhY2tlZCBieSBOb2lzZSBhbmQgbGlic29kaXVtJ3Mgc2VjcmV0c3RyZWFtIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJsaWIvKiouanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4xLjAiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuMy4xIiwKICAgICJub2lzZS1jdXJ2ZS1lZCI6ICJeMi4wLjEiLAogICAgIm5vaXNlLWhhbmRzaGFrZSI6ICJeNC4wLjAiLAogICAgInNvZGl1bS1zZWNyZXRzdHJlYW0iOiAiXjEuMS4wIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIsCiAgICAic3RyZWFteCI6ICJeMi4xNC4wIiwKICAgICJ0aW1lb3V0LXJlZnJlc2giOiAiXjIuMC4wIiwKICAgICJ1bnNsYWIiOiAiXjEuMy4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAidWR4LW5hdGl2ZSI6ICJeMS4xMy4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgInRlc3QiOiAiYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybS1zZWNyZXQtc3RyZWFtLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtLXNlY3JldC1zdHJlYW0vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtLXNlY3JldC1zdHJlYW0iCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBJbmRleEVuY29kZXIgPSByZXF1aXJlKCdpbmRleC1lbmNvZGVyJykKCmNvbnN0IENoZWNrb3V0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgQ2xvY2sgPSBjLmFycmF5KENoZWNrb3V0KQoKY29uc3QgSW5kZXhDaGVja3BvaW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgS2V5VjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGtleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogLTEKICAgIH0KICB9Cn0KCmNvbnN0IEtleXNWMCA9IGMuYXJyYXkoS2V5VjApCgpjb25zdCBXYWtldXBWMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDApIC8vIHZlcnNpb24KICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udHlwZSkKCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIEtleXNWMC5wcmVlbmNvZGUoc3RhdGUsIG0ud3JpdGVycykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkgLy8gdmVyc2lvbgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50eXBlKQoKICAgIGlmIChtLnR5cGUgPT09IDEpIHsKICAgICAgS2V5c1YwLmVuY29kZShzdGF0ZSwgbS53cml0ZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmICh2ICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb246ICcgKyB2KQoKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgbSA9IHsgdmVyc2lvbjogMCwgdHlwZSwgd3JpdGVyczogbnVsbCB9CgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBtLndyaXRlcnMgPSBLZXlzVjAuZGVjb2RlKHN0YXRlKQogICAgfQoKICAgIHJldHVybiBtCiAgfQp9Cgpjb25zdCBXYWtldXAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gV2FrZXVwVjAucHJlZW5jb2RlKHN0YXRlLCBtKQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpIC8vIHZlcnNpb24KICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udHlwZSkKCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIENsb2NrLnByZWVuY29kZShzdGF0ZSwgbS53cml0ZXJzKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gV2FrZXVwVjAuZW5jb2RlKHN0YXRlLCBtKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpIC8vIHZlcnNpb24KICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udHlwZSkKCiAgICBpZiAobS50eXBlID09PSAxKSB7CiAgICAgIENsb2NrLmVuY29kZShzdGF0ZSwgbS53cml0ZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgICBjb25zdCB2ID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAodiA+IDEpIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbjogJyArIHYpCgogICAgaWYgKHYgPT09IDApIHsKICAgICAgc3RhdGUuc3RhcnQgPSBzdGFydAogICAgICByZXR1cm4gV2FrZXVwVjAuZGVjb2RlKHN0YXRlKQogICAgfQoKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgbSA9IHsgdmVyc2lvbjogMSwgdHlwZSwgd3JpdGVyczogbnVsbCB9CgogICAgaWYgKG0udHlwZSA9PT0gMSkgewogICAgICBtLndyaXRlcnMgPSBDbG9jay5kZWNvZGUoc3RhdGUpCiAgICB9CgogICAgcmV0dXJuIG0KICB9Cn0KCmNvbnN0IEJvb3RSZWNvcmRWMCA9IHsKICBwcmVlbmNvZGUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3ZlcnNpb24gMCByZWNvcmRzIGNhbm5vdCBiZSBlbmNvZGVkJykKICB9LAogIGVuY29kZSgpIHsKICAgIHRocm93IG5ldyBFcnJvcigndmVyc2lvbiAwIHJlY29yZHMgY2Fubm90IGJlIGVuY29kZWQnKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBpbmRleGVkID0gQ2hlY2tvdXQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaGVhZHMgPSBDbG9jay5kZWNvZGUoc3RhdGUpCgogICAgLy8gb25lIGNhdXNlIGluaXRpYWwgcmVjb3ZlciBpcyBub3QgZmYgcmVjb3ZlcnkKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDAsCiAgICAgIGtleTogaW5kZXhlZC5rZXksCiAgICAgIHN5c3RlbUxlbmd0aDogaW5kZXhlZC5sZW5ndGgsCiAgICAgIGluZGV4ZXJzVXBkYXRlZDogZmFsc2UsCiAgICAgIGZhc3RGb3J3YXJkaW5nOiBmYWxzZSwKICAgICAgcmVjb3ZlcmllczogMSwKICAgICAgbWlncmF0aW5nOiBmYWxzZSwKICAgICAgaGVhZHMKICAgIH0KICB9Cn0KCmNvbnN0IENoZWNrcG9pbnRlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGlkeCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnRlcikKICAgIGlmIChpZHguY2hlY2twb2ludCAhPT0gbnVsbCkgSW5kZXhDaGVja3BvaW50LnByZWVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGlkeCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnRlcikKICAgIGlmIChpZHguY2hlY2twb2ludCAhPT0gbnVsbCkgSW5kZXhDaGVja3BvaW50LmVuY29kZShzdGF0ZSwgaWR4LmNoZWNrcG9pbnQpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGNoZWNrcG9pbnRlciA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBjaGVja3BvaW50ID0gY2hlY2twb2ludGVyID8gbnVsbCA6IEluZGV4Q2hlY2twb2ludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgY2hlY2twb2ludGVyLAogICAgICBjaGVja3BvaW50CiAgICB9CiAgfQp9Cgpjb25zdCBDaGVja3BvaW50ZXJBcnJheSA9IGMuYXJyYXkoQ2hlY2twb2ludGVyKQoKY29uc3QgSW5kZXhlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBuYW1lc3BhY2U6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBJbmRleGVycyA9IGMuYXJyYXkoSW5kZXhlcikKCmNvbnN0IERpZ2VzdFYwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5wb2ludGVyKQogICAgaWYgKG0ucG9pbnRlciA9PT0gMCkgewogICAgICBJbmRleGVycy5wcmVlbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgSW5kZXhlcnMuZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBwb2ludGVyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHBvaW50ZXIsCiAgICAgIGluZGV4ZXJzOiBwb2ludGVyID09PSAwID8gSW5kZXhlcnMuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IERpZ2VzdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucG9pbnRlcikKICAgIGlmIChtLnBvaW50ZXIgPT09IDApIHsKICAgICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHBvaW50ZXIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgcG9pbnRlciwKICAgICAga2V5OiBwb2ludGVyID09PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBOb2RlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgQ2xvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgQ2xvY2suZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgaGVhZHM6IENsb2NrLmRlY29kZShzdGF0ZSksCiAgICAgIGJhdGNoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IEFkZGl0aW9uYWwgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIEFkZGl0aW9uYWxEYXRhLnByZWVuY29kZShzdGF0ZSwgbS5kYXRhKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5wb2ludGVyID09PSAwKSB7CiAgICAgIEFkZGl0aW9uYWxEYXRhLmVuY29kZShzdGF0ZSwgbS5kYXRhKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBwb2ludGVyID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHBvaW50ZXIsCiAgICAgIGRhdGE6IHBvaW50ZXIgPT09IDAgPyBBZGRpdGlvbmFsRGF0YS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgQWRkaXRpb25hbERhdGEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAwKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKSAvLyBlbXB0eSBmb3Igbm93LCBmb3IgdGhlIGZ1dHVyZQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBlbmNyeXB0aW9uSWQ6IGZsYWdzICYgMSA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwgLy8gdG8gaGVscCB2YWxpZGF0ZSB0aGUgZW5jcnlwdGlvbiBrZXkgdXNlZAogICAgICBhYmk6IGZsYWdzICYgMiA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKY29uc3QgT3Bsb2dNZXNzYWdlVjEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBtYXhTdXBwb3J0ZWRWZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgaXNDaGVja3BvaW50ZXIgPSAoZmxhZ3MgJiAxKSAhPT0gMAoKICAgIGNvbnN0IGNoayA9IGlzQ2hlY2twb2ludGVyID8gQ2hlY2twb2ludGVyQXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIGNvbnN0IGRpZ2VzdCA9IGlzQ2hlY2twb2ludGVyID8gRGlnZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgY29uc3Qgbm9kZSA9IE5vZGUuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDEsCiAgICAgIG1heFN1cHBvcnRlZFZlcnNpb24sCiAgICAgIGRpZ2VzdCwKICAgICAgY2hlY2twb2ludDogY2hrID8geyBzeXN0ZW06IGNoa1swXSwgZW5jcnlwdGlvbjogbnVsbCwgdXNlcjogY2hrLnNsaWNlKDEpIH0gOiBudWxsLAogICAgICBvcHRpbWlzdGljOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgbm9kZQogICAgfQogIH0KfQoKY29uc3QgT3Bsb2dNZXNzYWdlVjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kaW5nIG5vdCBzdXBwb3J0ZWQnKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgaXNDaGVja3BvaW50ZXIgPSAoZmxhZ3MgJiAxKSAhPT0gMAoKICAgIGlmIChpc0NoZWNrcG9pbnRlcikgRGlnZXN0VjAuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgY2hrID0gaXNDaGVja3BvaW50ZXIgPyBDaGVja3BvaW50ZXJBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3Qgbm9kZSA9IE5vZGUuZGVjb2RlKHN0YXRlKQogICAgQWRkaXRpb25hbC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBtYXhTdXBwb3J0ZWRWZXJzaW9uID0gc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiAwLAogICAgICBtYXhTdXBwb3J0ZWRWZXJzaW9uLAogICAgICBkaWdlc3Q6IG51bGwsCiAgICAgIGNoZWNrcG9pbnQ6IGNoayA/IHsgc3lzdGVtOiBjaGtbMF0sIGVuY3J5cHRpb246IG51bGwsIHVzZXI6IGNoay5zbGljZSgxKSB9IDogbnVsbCwKICAgICAgb3B0aW1pc3RpYzogbnVsbCwKICAgICAgbm9kZQogICAgfQogIH0KfQoKLy8gcHJlZml4IDAgaXMgcmVzZXJ2ZWQgZm9yIGZ1dHVyZSBtYW5pZmVzdApjb25zdCBMSU5FQVJJWkVSX1BSRUZJWCA9IDEKCmNvbnN0IExpbmVhcml6ZXJLZXkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzZXEpIHsKICAgIEluZGV4RW5jb2Rlci5VSU5ULnByZWVuY29kZShzdGF0ZSwgTElORUFSSVpFUl9QUkVGSVgpCiAgICBJbmRleEVuY29kZXIuVUlOVC5wcmVlbmNvZGUoc3RhdGUsIHNlcSkKICB9LAogIGVuY29kZShzdGF0ZSwgc2VxKSB7CiAgICBJbmRleEVuY29kZXIuVUlOVC5lbmNvZGUoc3RhdGUsIExJTkVBUklaRVJfUFJFRklYKQogICAgSW5kZXhFbmNvZGVyLlVJTlQuZW5jb2RlKHN0YXRlLCBzZXEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIEluZGV4RW5jb2Rlci5VSU5ULmRlY29kZShzdGF0ZSkKICAgIHJldHVybiBJbmRleEVuY29kZXIuVUlOVC5kZWNvZGUoc3RhdGUpCiAgfQp9CgpmdW5jdGlvbiBpbmZvTGVnYWN5TWFwKGluZm8pIHsKICByZXR1cm4gewogICAgdmVyc2lvbjogaW5mby52ZXJzaW9uLAogICAgbWVtYmVyczogaW5mby5tZW1iZXJzLAogICAgcGVuZGluZ0luZGV4ZXJzOiBpbmZvLnBlbmRpbmdJbmRleGVycywKICAgIGluZGV4ZXJzOiBpbmZvLmluZGV4ZXJzLAogICAgaGVhZHM6IGluZm8uaGVhZHMsCiAgICB2aWV3czogaW5mby52aWV3cywKICAgIGVuY3J5cHRpb25MZW5ndGg6IDAsCiAgICBlbnRyb3B5OiBudWxsCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBXYWtldXAsCiAgQm9vdFJlY29yZFYwLAogIE9wbG9nTWVzc2FnZVYwLAogIE9wbG9nTWVzc2FnZVYxLAogIExpbmVhcml6ZXJLZXksCiAgaW5mb0xlZ2FjeU1hcAp9Ci8vIFRoaXMgZmlsZSBpcyBhdXRvZ2VuZXJhdGVkIGJ5IHRoZSBoeXBlcnNjaGVtYSBjb21waWxlcgovLyBTY2hlbWEgVmVyc2lvbjogMQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KLyogZXNsaW50LWRpc2FibGUgcXVvdGVzICovCgpjb25zdCB7IGMgfSA9IHJlcXVpcmUoJ2h5cGVyc2NoZW1hL3J1bnRpbWUnKQpjb25zdCBleHRlcm5hbDAgPSByZXF1aXJlKCcuLi8uLi9sZWdhY3kuanMnKQoKY29uc3QgVkVSU0lPTiA9IDEKCi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycwpsZXQgdmVyc2lvbiA9IFZFUlNJT04KCi8vIEBhdXRvYmFzZS9jaGVja291dApjb25zdCBlbmNvZGluZzAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAga2V5OiByMCwKICAgICAgbGVuZ3RoOiByMQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2Nsb2NrCmNvbnN0IGVuY29kaW5nMSA9IGMuYXJyYXkoZW5jb2RpbmcwKQoKLy8gQGF1dG9iYXNlL2luZGV4LWNoZWNrcG9pbnQKY29uc3QgZW5jb2RpbmcyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogcjAsCiAgICAgIGxlbmd0aDogcjEKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nMyA9IGV4dGVybmFsMC5XYWtldXAKCmNvbnN0IGVuY29kaW5nNCA9IGV4dGVybmFsMC5Cb290UmVjb3JkVjAKCi8vIEBhdXRvYmFzZS9ib290LXJlY29yZC1yYXcKY29uc3QgZW5jb2Rpbmc1ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN5c3RlbUxlbmd0aCkKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDQgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0ucmVjb3ZlcmllcykgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZWNvdmVyaWVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmluZGV4ZXJzVXBkYXRlZCA/IDEgOiAwKSB8IChtLmZhc3RGb3J3YXJkaW5nID8gMiA6IDApIHwgKG0ucmVjb3ZlcmllcyA/IDQgOiAwKQoKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zeXN0ZW1MZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5yZWNvdmVyaWVzKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlY292ZXJpZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUsIHZlcnNpb24pIHsKICAgIGlmICh2ZXJzaW9uID09PSB1bmRlZmluZWQpIHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIGtleTogcjAsCiAgICAgIHN5c3RlbUxlbmd0aDogcjEsCiAgICAgIGluZGV4ZXJzVXBkYXRlZDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIGZhc3RGb3J3YXJkaW5nOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgcmVjb3ZlcmllczogKGZsYWdzICYgNCkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9ib290LXJlY29yZApjb25zdCBlbmNvZGluZzYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgZW5jb2Rpbmc0LnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgMjoKICAgICAgY2FzZSAzOgogICAgICAgIGVuY29kaW5nNS5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBzd2l0Y2ggKG0udmVyc2lvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgZW5jb2Rpbmc0LmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgMjoKICAgICAgY2FzZSAzOgogICAgICAgIGVuY29kaW5nNS5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlIDA6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2Rpbmc0LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGNhc2UgMToKICAgICAgY2FzZSAyOgogICAgICBjYXNlIDM6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2Rpbmc1LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9jaGVja3BvaW50ZXIKY29uc3QgZW5jb2Rpbmc3ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMiBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5jaGVja3BvaW50ZXIpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludGVyKQogICAgaWYgKG0uY2hlY2twb2ludCkgZW5jb2RpbmcyLnByZWVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLmNoZWNrcG9pbnRlciA/IDEgOiAwKSB8IChtLmNoZWNrcG9pbnQgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5jaGVja3BvaW50ZXIpIGMudWludC5lbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludGVyKQogICAgaWYgKG0uY2hlY2twb2ludCkgZW5jb2RpbmcyLmVuY29kZShzdGF0ZSwgbS5jaGVja3BvaW50KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgY2hlY2twb2ludGVyOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMCwKICAgICAgY2hlY2twb2ludDogKGZsYWdzICYgMikgIT09IDAgPyBlbmNvZGluZzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9jaGVja3BvaW50LnVzZXIKY29uc3QgZW5jb2Rpbmc4XzIgPSBjLmFycmF5KGVuY29kaW5nNykKCi8vIEBhdXRvYmFzZS9jaGVja3BvaW50CmNvbnN0IGVuY29kaW5nOCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDQgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uc3lzdGVtKSBlbmNvZGluZzcucHJlZW5jb2RlKHN0YXRlLCBtLnN5c3RlbSkKICAgIGlmIChtLmVuY3J5cHRpb24pIGVuY29kaW5nNy5wcmVlbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbikKICAgIGlmIChtLnVzZXIpIGVuY29kaW5nOF8yLnByZWVuY29kZShzdGF0ZSwgbS51c2VyKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLnN5c3RlbSA/IDEgOiAwKSB8IChtLmVuY3J5cHRpb24gPyAyIDogMCkgfCAobS51c2VyID8gNCA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uc3lzdGVtKSBlbmNvZGluZzcuZW5jb2RlKHN0YXRlLCBtLnN5c3RlbSkKICAgIGlmIChtLmVuY3J5cHRpb24pIGVuY29kaW5nNy5lbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbikKICAgIGlmIChtLnVzZXIpIGVuY29kaW5nOF8yLmVuY29kZShzdGF0ZSwgbS51c2VyKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGVuY29kaW5nNy5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZW5jcnlwdGlvbjogKGZsYWdzICYgMikgIT09IDAgPyBlbmNvZGluZzcuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXI6IChmbGFncyAmIDQpICE9PSAwID8gZW5jb2Rpbmc4XzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9kaWdlc3QKY29uc3QgZW5jb2Rpbmc5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMiBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5wb2ludGVyKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5rZXkpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLnBvaW50ZXIgPyAxIDogMCkgfCAobS5rZXkgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5wb2ludGVyKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnBvaW50ZXIpCiAgICBpZiAobS5rZXkpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgcG9pbnRlcjogKGZsYWdzICYgMSkgIT09IDAgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAsCiAgICAgIGtleTogKGZsYWdzICYgMikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9ub2RlCmNvbnN0IGVuY29kaW5nMTAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5iYXRjaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYmF0Y2gpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGhlYWRzOiByMCwKICAgICAgYmF0Y2g6IHIxLAogICAgICB2YWx1ZTogcjIKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS90cmFjZS5zeXN0ZW0KY29uc3QgZW5jb2RpbmcxMV8wID0gYy5hcnJheShjLnVpbnQpCi8vIEBhdXRvYmFzZS90cmFjZS5lbmNyeXB0aW9uCmNvbnN0IGVuY29kaW5nMTFfMSA9IGVuY29kaW5nMTFfMAoKLy8gQGF1dG9iYXNlL3RyYWNlCmNvbnN0IGVuY29kaW5nMTEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzExXzAucHJlZW5jb2RlKHN0YXRlLCBtLnN5c3RlbSkKICAgIGVuY29kaW5nMTFfMS5wcmVlbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbikKICAgIGVuY29kaW5nMTFfMi5wcmVlbmNvZGUoc3RhdGUsIG0udXNlcikKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgZW5jb2RpbmcxMV8wLmVuY29kZShzdGF0ZSwgbS5zeXN0ZW0pCiAgICBlbmNvZGluZzExXzEuZW5jb2RlKHN0YXRlLCBtLmVuY3J5cHRpb24pCiAgICBlbmNvZGluZzExXzIuZW5jb2RlKHN0YXRlLCBtLnVzZXIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gZW5jb2RpbmcxMV8wLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gZW5jb2RpbmcxMV8xLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gZW5jb2RpbmcxMV8yLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBzeXN0ZW06IHIwLAogICAgICBlbmNyeXB0aW9uOiByMSwKICAgICAgdXNlcjogcjIKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nMTIgPSBleHRlcm5hbDAuT3Bsb2dNZXNzYWdlVjAKCmNvbnN0IGVuY29kaW5nMTMgPSBleHRlcm5hbDAuT3Bsb2dNZXNzYWdlVjEKCi8vIEBhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYyLmNoZWNrcG9pbnQKY29uc3QgZW5jb2RpbmcxNF8xID0gYy5mcmFtZShlbmNvZGluZzgpCi8vIEBhdXRvYmFzZS9vcGxvZy1tZXNzYWdlLXYyLmRpZ2VzdApjb25zdCBlbmNvZGluZzE0XzIgPSBjLmZyYW1lKGVuY29kaW5nOSkKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjIudHJhY2UKY29uc3QgZW5jb2RpbmcxNF80ID0gYy5mcmFtZShlbmNvZGluZzExKQoKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UtdjIKY29uc3QgZW5jb2RpbmcxNCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nMTAucHJlZW5jb2RlKHN0YXRlLCBtLm5vZGUpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyA4IHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmNoZWNrcG9pbnQpIGVuY29kaW5nMTRfMS5wcmVlbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludCkKICAgIGlmIChtLmRpZ2VzdCkgZW5jb2RpbmcxNF8yLnByZWVuY29kZShzdGF0ZSwgbS5kaWdlc3QpCiAgICBpZiAobS50cmFjZSkgZW5jb2RpbmcxNF80LnByZWVuY29kZShzdGF0ZSwgbS50cmFjZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5jaGVja3BvaW50ID8gMSA6IDApIHwgKG0uZGlnZXN0ID8gMiA6IDApIHwgKG0ub3B0aW1pc3RpYyA/IDQgOiAwKSB8IChtLnRyYWNlID8gOCA6IDApCgogICAgZW5jb2RpbmcxMC5lbmNvZGUoc3RhdGUsIG0ubm9kZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmNoZWNrcG9pbnQpIGVuY29kaW5nMTRfMS5lbmNvZGUoc3RhdGUsIG0uY2hlY2twb2ludCkKICAgIGlmIChtLmRpZ2VzdCkgZW5jb2RpbmcxNF8yLmVuY29kZShzdGF0ZSwgbS5kaWdlc3QpCiAgICBpZiAobS50cmFjZSkgZW5jb2RpbmcxNF80LmVuY29kZShzdGF0ZSwgbS50cmFjZSkKICB9LAogIGRlY29kZShzdGF0ZSwgdmVyc2lvbikgewogICAgaWYgKHZlcnNpb24gPT09IHVuZGVmaW5lZCkgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMCA9IGVuY29kaW5nMTAuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIG5vZGU6IHIwLAogICAgICBjaGVja3BvaW50OiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGVuY29kaW5nMTRfMS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZGlnZXN0OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nMTRfMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgb3B0aW1pc3RpYzogKGZsYWdzICYgNCkgIT09IDAsCiAgICAgIHRyYWNlOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGVuY29kaW5nMTRfNC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL29wbG9nLW1lc3NhZ2UKY29uc3QgZW5jb2RpbmcxNSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBlbmNvZGluZzEyLnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDE6CiAgICAgICAgZW5jb2RpbmcxMy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgY2FzZSAyOgogICAgICAgIGVuY29kaW5nMTQucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3dpdGNoIChtLnZlcnNpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIGVuY29kaW5nMTIuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMToKICAgICAgICBlbmNvZGluZzEzLmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBjYXNlIDI6CiAgICAgICAgZW5jb2RpbmcxNC5lbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHZlcnNpb24nKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlIDA6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxMi5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBjYXNlIDE6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxMy5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBjYXNlIDI6IHsKICAgICAgICBjb25zdCBkZWNvZGVkID0gZW5jb2RpbmcxNC5kZWNvZGUoc3RhdGUsIHZlcnNpb24pCiAgICAgICAgcmV0dXJuIGRlY29kZWQKICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvaW5mby12MS5wZW5kaW5nSW5kZXhlcnMKY29uc3QgZW5jb2RpbmcxNl8xID0gYy5hcnJheShjLmZpeGVkMzIpCgovLyBAYXV0b2Jhc2UvaW5mby12MQpjb25zdCBlbmNvZGluZzE2ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5tZW1iZXJzKQogICAgZW5jb2RpbmcxNl8xLnByZWVuY29kZShzdGF0ZSwgbS5wZW5kaW5nSW5kZXhlcnMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLmluZGV4ZXJzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS5oZWFkcykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0udmlld3MpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubWVtYmVycykKICAgIGVuY29kaW5nMTZfMS5lbmNvZGUoc3RhdGUsIG0ucGVuZGluZ0luZGV4ZXJzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLnZpZXdzKQogIH0sCiAgZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKSB7CiAgICBpZiAodmVyc2lvbiA9PT0gdW5kZWZpbmVkKSB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gZW5jb2RpbmcxNl8xLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIzID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHI0ID0gZW5jb2RpbmcxLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBtZW1iZXJzOiByMCwKICAgICAgcGVuZGluZ0luZGV4ZXJzOiByMSwKICAgICAgaW5kZXhlcnM6IHIyLAogICAgICBoZWFkczogcjMsCiAgICAgIHZpZXdzOiByNAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2luZm8tdjIucGVuZGluZ0luZGV4ZXJzCmNvbnN0IGVuY29kaW5nMTdfMSA9IGVuY29kaW5nMTZfMQoKLy8gQGF1dG9iYXNlL2luZm8tdjIKY29uc3QgZW5jb2RpbmcxNyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubWVtYmVycykKICAgIGVuY29kaW5nMTdfMS5wcmVlbmNvZGUoc3RhdGUsIG0ucGVuZGluZ0luZGV4ZXJzKQogICAgZW5jb2RpbmcxLnByZWVuY29kZShzdGF0ZSwgbS5pbmRleGVycykKICAgIGVuY29kaW5nMS5wcmVlbmNvZGUoc3RhdGUsIG0uaGVhZHMpCiAgICBlbmNvZGluZzEucHJlZW5jb2RlKHN0YXRlLCBtLnZpZXdzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uTGVuZ3RoKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5lbnRyb3B5KSBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmVudHJvcHkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5lbnRyb3B5ID8gMSA6IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLm1lbWJlcnMpCiAgICBlbmNvZGluZzE3XzEuZW5jb2RlKHN0YXRlLCBtLnBlbmRpbmdJbmRleGVycykKICAgIGVuY29kaW5nMS5lbmNvZGUoc3RhdGUsIG0uaW5kZXhlcnMpCiAgICBlbmNvZGluZzEuZW5jb2RlKHN0YXRlLCBtLmhlYWRzKQogICAgZW5jb2RpbmcxLmVuY29kZShzdGF0ZSwgbS52aWV3cykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbkxlbmd0aCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmVudHJvcHkpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uZW50cm9weSkKICB9LAogIGRlY29kZShzdGF0ZSwgdmVyc2lvbikgewogICAgaWYgKHZlcnNpb24gPT09IHVuZGVmaW5lZCkgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGVuY29kaW5nMTdfMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMyA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByNCA9IGVuY29kaW5nMS5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByNSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbiwKICAgICAgbWVtYmVyczogcjAsCiAgICAgIHBlbmRpbmdJbmRleGVyczogcjEsCiAgICAgIGluZGV4ZXJzOiByMiwKICAgICAgaGVhZHM6IHIzLAogICAgICB2aWV3czogcjQsCiAgICAgIGVuY3J5cHRpb25MZW5ndGg6IHI1LAogICAgICBlbnRyb3B5OiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL2luZm8KY29uc3QgZW5jb2RpbmcxOCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgY2FzZSAxOgogICAgICAgIGVuY29kaW5nMTYucHJlZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMjoKICAgICAgICBlbmNvZGluZzE3LnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN3aXRjaCAobS52ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgY2FzZSAxOgogICAgICAgIGVuY29kaW5nMTYuZW5jb2RlKHN0YXRlLCBtKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgMjoKICAgICAgICBlbmNvZGluZzE3LmVuY29kZShzdGF0ZSwgbSkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgY2FzZSAxOiB7CiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGVuY29kaW5nMTYuZGVjb2RlKHN0YXRlLCB2ZXJzaW9uKQogICAgICAgIGNvbnN0IG1hcCA9IGV4dGVybmFsMC5pbmZvTGVnYWN5TWFwCiAgICAgICAgcmV0dXJuIG1hcChkZWNvZGVkKQogICAgICB9CiAgICAgIGNhc2UgMjogewogICAgICAgIGNvbnN0IGRlY29kZWQgPSBlbmNvZGluZzE3LmRlY29kZShzdGF0ZSwgdmVyc2lvbikKICAgICAgICByZXR1cm4gZGVjb2RlZAogICAgICB9CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCB2ZXJzaW9uJykKICAgIH0KICB9Cn0KCi8vIEBhdXRvYmFzZS9tZW1iZXIKY29uc3QgZW5jb2RpbmcxOSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDIgc28gYWx3YXlzIG9uZSBieXRlCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5pc0luZGV4ZXIgPyAxIDogMCkgfCAobS5pc1JlbW92ZWQgPyAyIDogMCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaXNJbmRleGVyOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgaXNSZW1vdmVkOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZW5jb2RpbmcyMCA9IGV4dGVybmFsMC5MaW5lYXJpemVyS2V5CgovLyBAYXV0b2Jhc2UvbGluZWFyaXplci11cGRhdGUKY29uc3QgZW5jb2RpbmcyMSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zeXN0ZW1MZW5ndGgpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uaW5kZXhlcnMgPyAxIDogMAoKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ua2V5KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmJhdGNoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zeXN0ZW1MZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjMgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGtleTogcjAsCiAgICAgIGxlbmd0aDogcjEsCiAgICAgIGJhdGNoOiByMiwKICAgICAgc3lzdGVtTGVuZ3RoOiByMywKICAgICAgaW5kZXhlcnM6IChmbGFncyAmIDEpICE9PSAwCiAgICB9CiAgfQp9CgovLyBAYXV0b2Jhc2UvZW5jcnlwdGlvbi1kZXNjcmlwdG9yCmNvbnN0IGVuY29kaW5nMjIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnR5cGUpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0ucGF5bG9hZCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50eXBlKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnBheWxvYWQpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IHIwLAogICAgICBwYXlsb2FkOiByMQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL21hbmlmZXN0LWRhdGEKY29uc3QgZW5jb2RpbmcyMyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDIgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0ubGVnYWN5QmxvY2tzKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlZ2FjeUJsb2NrcykKICAgIGlmIChtLm5hbWVzcGFjZSkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gKG0ubGVnYWN5QmxvY2tzID8gMSA6IDApIHwgKG0ubmFtZXNwYWNlID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0ubGVnYWN5QmxvY2tzKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlZ2FjeUJsb2NrcykKICAgIGlmIChtLm5hbWVzcGFjZSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiByMCwKICAgICAgbGVnYWN5QmxvY2tzOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMCwKICAgICAgbmFtZXNwYWNlOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL3VzZXItdmlldy10cmFjZS5ibG9ja3MKY29uc3QgZW5jb2RpbmcyNF8xID0gZW5jb2RpbmcxMV8wCgovLyBAYXV0b2Jhc2UvdXNlci12aWV3LXRyYWNlCmNvbnN0IGVuY29kaW5nMjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZpZXcpCiAgICBlbmNvZGluZzI0XzEucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrcykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52aWV3KQogICAgZW5jb2RpbmcyNF8xLmVuY29kZShzdGF0ZSwgbS5ibG9ja3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gZW5jb2RpbmcyNF8xLmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2aWV3OiByMCwKICAgICAgYmxvY2tzOiByMQogICAgfQogIH0KfQoKLy8gQGF1dG9iYXNlL3RyYWNlLnVzZXIsIGRlZmVycmVkIGR1ZSB0byByZWN1c2l2ZSB1c2UKY29uc3QgZW5jb2RpbmcxMV8yID0gYy5hcnJheShlbmNvZGluZzI0KQoKZnVuY3Rpb24gc2V0VmVyc2lvbih2KSB7CiAgdmVyc2lvbiA9IHYKfQoKZnVuY3Rpb24gZW5jb2RlKG5hbWUsIHZhbHVlLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZW5jb2RlKGdldEVuY29kaW5nKG5hbWUpLCB2YWx1ZSkKfQoKZnVuY3Rpb24gZGVjb2RlKG5hbWUsIGJ1ZmZlciwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmRlY29kZShnZXRFbmNvZGluZyhuYW1lKSwgYnVmZmVyKQp9CgpmdW5jdGlvbiBnZXRFbnVtKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW51bSBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRFbmNvZGluZyhuYW1lKSB7CiAgc3dpdGNoIChuYW1lKSB7CiAgICBjYXNlICdAYXV0b2Jhc2UvY2hlY2tvdXQnOgogICAgICByZXR1cm4gZW5jb2RpbmcwCiAgICBjYXNlICdAYXV0b2Jhc2UvY2xvY2snOgogICAgICByZXR1cm4gZW5jb2RpbmcxCiAgICBjYXNlICdAYXV0b2Jhc2UvaW5kZXgtY2hlY2twb2ludCc6CiAgICAgIHJldHVybiBlbmNvZGluZzIKICAgIGNhc2UgJ0BhdXRvYmFzZS93YWtldXAnOgogICAgICByZXR1cm4gZW5jb2RpbmczCiAgICBjYXNlICdAYXV0b2Jhc2UvYm9vdC1yZWNvcmQtdjAnOgogICAgICByZXR1cm4gZW5jb2Rpbmc0CiAgICBjYXNlICdAYXV0b2Jhc2UvYm9vdC1yZWNvcmQtcmF3JzoKICAgICAgcmV0dXJuIGVuY29kaW5nNQogICAgY2FzZSAnQGF1dG9iYXNlL2Jvb3QtcmVjb3JkJzoKICAgICAgcmV0dXJuIGVuY29kaW5nNgogICAgY2FzZSAnQGF1dG9iYXNlL2NoZWNrcG9pbnRlcic6CiAgICAgIHJldHVybiBlbmNvZGluZzcKICAgIGNhc2UgJ0BhdXRvYmFzZS9jaGVja3BvaW50JzoKICAgICAgcmV0dXJuIGVuY29kaW5nOAogICAgY2FzZSAnQGF1dG9iYXNlL2RpZ2VzdCc6CiAgICAgIHJldHVybiBlbmNvZGluZzkKICAgIGNhc2UgJ0BhdXRvYmFzZS9ub2RlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTAKICAgIGNhc2UgJ0BhdXRvYmFzZS90cmFjZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzExCiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12MCc6CiAgICAgIHJldHVybiBlbmNvZGluZzEyCiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12MSc6CiAgICAgIHJldHVybiBlbmNvZGluZzEzCiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZS12Mic6CiAgICAgIHJldHVybiBlbmNvZGluZzE0CiAgICBjYXNlICdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzE1CiAgICBjYXNlICdAYXV0b2Jhc2UvaW5mby12MSc6CiAgICAgIHJldHVybiBlbmNvZGluZzE2CiAgICBjYXNlICdAYXV0b2Jhc2UvaW5mby12Mic6CiAgICAgIHJldHVybiBlbmNvZGluZzE3CiAgICBjYXNlICdAYXV0b2Jhc2UvaW5mbyc6CiAgICAgIHJldHVybiBlbmNvZGluZzE4CiAgICBjYXNlICdAYXV0b2Jhc2UvbWVtYmVyJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTkKICAgIGNhc2UgJ0BhdXRvYmFzZS9saW5lYXJpemVyLWtleSc6CiAgICAgIHJldHVybiBlbmNvZGluZzIwCiAgICBjYXNlICdAYXV0b2Jhc2UvbGluZWFyaXplci11cGRhdGUnOgogICAgICByZXR1cm4gZW5jb2RpbmcyMQogICAgY2FzZSAnQGF1dG9iYXNlL2VuY3J5cHRpb24tZGVzY3JpcHRvcic6CiAgICAgIHJldHVybiBlbmNvZGluZzIyCiAgICBjYXNlICdAYXV0b2Jhc2UvbWFuaWZlc3QtZGF0YSc6CiAgICAgIHJldHVybiBlbmNvZGluZzIzCiAgICBjYXNlICdAYXV0b2Jhc2UvdXNlci12aWV3LXRyYWNlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMjQKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW5jb2RlciBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRTdHJ1Y3QobmFtZSwgdiA9IFZFUlNJT04pIHsKICBjb25zdCBlbmMgPSBnZXRFbmNvZGluZyhuYW1lKQogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgcmV0dXJuIGVuYy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXNvbHZlU3RydWN0ID0gZ2V0U3RydWN0IC8vIGNvbXBhdAoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcmVzb2x2ZVN0cnVjdCwKICBnZXRTdHJ1Y3QsCiAgZ2V0RW51bSwKICBnZXRFbmNvZGluZywKICBlbmNvZGUsCiAgZGVjb2RlLAogIHNldFZlcnNpb24sCiAgdmVyc2lvbgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IGRlYm91bmNlaWZ5ID0gcmVxdWlyZSgnZGVib3VuY2VpZnknKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgaHlwZXJjb3JlSWQgPSByZXF1aXJlKCdoeXBlcmNvcmUtaWQtZW5jb2RpbmcnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgU2lnbmFsUHJvbWlzZSA9IHJlcXVpcmUoJ3NpZ25hbC1wcm9taXNlJykKY29uc3QgQ29yZUNvdXBsZXIgPSByZXF1aXJlKCdjb3JlLWNvdXBsZXInKQpjb25zdCBQcm90b211eFdha2V1cCA9IHJlcXVpcmUoJ3Byb3RvbXV4LXdha2V1cCcpCmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBIeXBlcmNvcmUgPSByZXF1aXJlKCdoeXBlcmNvcmUnKQpjb25zdCBTY29wZUxvY2sgPSByZXF1aXJlKCdzY29wZS1sb2NrJykKCmNvbnN0IExvY2FsU3RhdGUgPSByZXF1aXJlKCcuL2xpYi9sb2NhbC1zdGF0ZS5qcycpCmNvbnN0IExpbmVhcml6ZXIgPSByZXF1aXJlKCcuL2xpYi9saW5lYXJpemVyLmpzJykKY29uc3QgU3lzdGVtVmlldyA9IHJlcXVpcmUoJy4vbGliL3N5c3RlbS5qcycpCmNvbnN0IHsgRW5jcnlwdGlvblZpZXcgfSA9IHJlcXVpcmUoJy4vbGliL2VuY3J5cHRpb24uanMnKQpjb25zdCBVcGRhdGVDaGFuZ2VzID0gcmVxdWlyZSgnLi9saWIvdXBkYXRlcy5qcycpCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9saWIvbWVzc2FnZXMuanMnKQpjb25zdCBUaW1lciA9IHJlcXVpcmUoJy4vbGliL3RpbWVyLmpzJykKY29uc3QgV3JpdGVyID0gcmVxdWlyZSgnLi9saWIvd3JpdGVyLmpzJykKY29uc3QgeyBlbmNvZGVWYWx1ZSwgZGVjb2RlVmFsdWUgfSA9IHJlcXVpcmUoJy4vbGliL3ZhbHVlcy5qcycpCmNvbnN0IEFjdGl2ZVdyaXRlcnMgPSByZXF1aXJlKCcuL2xpYi9hY3RpdmUtd3JpdGVycy5qcycpCmNvbnN0IEF1dG9XYWtldXAgPSByZXF1aXJlKCcuL2xpYi93YWtldXAuanMnKQoKY29uc3QgRmFzdEZvcndhcmQgPSByZXF1aXJlKCcuL2xpYi9mYXN0LWZvcndhcmQuanMnKQpjb25zdCBBdXRvU3RvcmUgPSByZXF1aXJlKCcuL2xpYi9zdG9yZS5qcycpCmNvbnN0IEFwcGx5U3RhdGUgPSByZXF1aXJlKCcuL2xpYi9hcHBseS1zdGF0ZS5qcycpCmNvbnN0IEFwcGVuZEJhdGNoID0gcmVxdWlyZSgnLi9saWIvYXBwZW5kLWJhdGNoLmpzJykKY29uc3QgeyBQdWJsaWNBcHBseUNhbGxzIH0gPSByZXF1aXJlKCcuL2xpYi9hcHBseS1jYWxscy5qcycpCmNvbnN0IGJvb3QgPSByZXF1aXJlKCcuL2xpYi9ib290LmpzJykKY29uc3QgeyBNQVhfQVVUT0JBU0VfVkVSU0lPTiwgQk9PVF9SRUNPUkRfVkVSU0lPTiB9ID0gcmVxdWlyZSgnLi9saWIvY2Fwcy5qcycpCgpjb25zdCBpbnNwZWN0ID0gU3ltYm9sLmZvcignbm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b20nKQpjb25zdCBJTlRFUlJVUFQgPSBuZXcgRXJyb3IoJ0FwcGx5IGludGVycnVwdGVkJykKY29uc3QgQklOQVJZX0VOQ09ESU5HID0gYy5mcm9tKCdiaW5hcnknKQoKY29uc3QgUkVDT1ZFUklFUyA9IDMKCi8vIGRlZmF1bHQgaXMgdG8gYXV0b21hdGljYWxseSBhY2sKY29uc3QgREVGQVVMVF9BQ0tfSU5URVJWQUwgPSAxMF8wMDAKY29uc3QgREVGQVVMVF9BQ0tfVEhSRVNIT0xEID0gNAoKY29uc3QgUkVNT1RFX0FERF9CQVRDSCA9IDY0CmNvbnN0IFJFTU9URV9BRERfQkFUQ0hfU0FOSVRZID0gNDA5Ngpjb25zdCBNSU5fRkZfV0FJVCA9IDMwMF8wMDAgLy8gd2FpdCBhdCBsZWFzdCA1bWluIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGZmIGFnYWluIGFmdGVyIGZhaWx1cmUKCmNsYXNzIFdha2V1cEhhbmRsZXIgewogIGNvbnN0cnVjdG9yKGJhc2UsIGRpc2NvdmVyeUtleSkgewogICAgdGhpcy5hY3RpdmUgPSB0cnVlCiAgICB0aGlzLmRpc2NvdmVyeUtleSA9IGRpc2NvdmVyeUtleQogICAgdGhpcy5iYXNlID0gYmFzZQogIH0KCiAgb25wZWVyYWN0aXZlKHBlZXIsIHNlc3Npb24pIHsKICAgIHRoaXMuYmFzZS5fYnVtcFdha2V1cFBlZXIocGVlcikKICB9CgogIG9ubG9va3VwKHJlcSwgcGVlciwgc2Vzc2lvbikgewogICAgY29uc3Qgd2FrZXVwID0gdGhpcy5iYXNlLl9nZXRXYWtldXAoKQogICAgaWYgKHdha2V1cC5sZW5ndGggPT09IDApIHJldHVybgogICAgc2Vzc2lvbi5hbm5vdW5jZShwZWVyLCB3YWtldXApCiAgfQoKICBvbmFubm91bmNlKHdha2V1cCwgcGVlciwgc2Vzc2lvbikgewogICAgaWYgKHRoaXMuYmFzZS5pc0Zhc3RGb3J3YXJkaW5nKCkpIHsKICAgICAgdGhpcy5iYXNlLl9uZWVkc1dha2V1cFJlcXVlc3QgPSB0cnVlCiAgICAgIHJldHVybgogICAgfQogICAgdGhpcy5iYXNlLmhpbnRXYWtldXAod2FrZXVwKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBdXRvYmFzZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKHN0b3JlLCBib290c3RyYXAsIGhhbmRsZXJzID0ge30pIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGJvb3RzdHJhcCkpIGJvb3RzdHJhcCA9IGJvb3RzdHJhcFswXSAvLyBUT0RPOiBqdXN0IGEgcXVpY2sgY29tcGF0LCBsZXRzIHJlbW92ZSBzb29uCgogICAgaWYgKGJvb3RzdHJhcCAmJiB0eXBlb2YgYm9vdHN0cmFwICE9PSAnc3RyaW5nJyAmJiAhYjRhLmlzQnVmZmVyKGJvb3RzdHJhcCkpIHsKICAgICAgaGFuZGxlcnMgPSBib290c3RyYXAKICAgICAgYm9vdHN0cmFwID0gbnVsbAogICAgfQoKICAgIHN1cGVyKCkKCiAgICBjb25zdCBrZXkgPSBib290c3RyYXAgPyB0b0tleShib290c3RyYXApIDogbnVsbAoKICAgIHRoaXMuaWQgPSBudWxsCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBudWxsCiAgICB0aGlzLmJhY2tvZmYgPSBoYW5kbGVycy5iYWNrb2ZmIHx8IG51bGwKCiAgICB0aGlzLmtleVBhaXIgPSBudWxsCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBjLmZyb20oaGFuZGxlcnMudmFsdWVFbmNvZGluZyB8fCAnYmluYXJ5JykKICAgIHRoaXMuc3RvcmUgPSBzdG9yZQogICAgdGhpcy5nbG9iYWxDYWNoZSA9IHN0b3JlLmdsb2JhbENhY2hlIHx8IG51bGwKICAgIHRoaXMubWlncmF0ZWQgPSBmYWxzZQoKICAgIHRoaXMuZW5jcnlwdGVkID0gaGFuZGxlcnMuZW5jcnlwdGVkIHx8ICEhaGFuZGxlcnMuZW5jcnlwdGlvbktleQogICAgdGhpcy5lbmNyeXB0ID0gISFoYW5kbGVycy5lbmNyeXB0CiAgICB0aGlzLmVuY3J5cHRpb25LZXkgPSBudWxsCiAgICB0aGlzLmVuY3J5cHRpb24gPSBudWxsCgogICAgdGhpcy5hY3RpdmVCYXRjaCA9IG51bGwgLy8gbWFpbnRhaW5lZCBieSB0aGUgYXBwZW5kLWJhdGNoCgogICAgdGhpcy5sb2NhbCA9IG51bGwKICAgIHRoaXMubG9jYWxXcml0ZXIgPSBudWxsCiAgICB0aGlzLmlzSW5kZXhlciA9IGZhbHNlCgogICAgdGhpcy5hY3RpdmVXcml0ZXJzID0gbmV3IEFjdGl2ZVdyaXRlcnMoKQogICAgdGhpcy5saW5lYXJpemVyID0gbnVsbAogICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCgogICAgdGhpcy5udWtlVGlwID0gISFoYW5kbGVycy5udWtlVGlwCgogICAgdGhpcy53YWtldXBPd25lciA9ICFoYW5kbGVycy53YWtldXAKICAgIHRoaXMud2FrZXVwQ2FwYWJpbGl0eSA9IG51bGwKICAgIHRoaXMud2FrZXVwUHJvdG9jb2wgPSBoYW5kbGVycy53YWtldXAgfHwgbmV3IFByb3RvbXV4V2FrZXVwKCkKICAgIHRoaXMud2FrZXVwU2Vzc2lvbiA9IG51bGwKCiAgICB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwID0gbnVsbAoKICAgIHRoaXMuZmFzdEZvcndhcmRFbmFibGVkID0gaGFuZGxlcnMuZmFzdEZvcndhcmQgIT09IGZhbHNlCiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gbnVsbAogICAgdGhpcy5mYXN0Rm9yd2FyZFRvID0gbnVsbAogICAgdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0ID0gMAogICAgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gPSBGYXN0Rm9yd2FyZC5NSU5JTVVNCgogICAgdGhpcy5iaWdCYXRjaGVzID0gISFoYW5kbGVycy5iaWdCYXRjaGVzCgogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVycyA9IFtdIC8vIG1pZ2h0IGNvbnRhaW4gZHVwcywgYnV0IHRoYXRzIG9rCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzQ2hhbmdlZCA9IGZhbHNlCgogICAgdGhpcy5fZmx1c2hTaWduYWwgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCiAgICB0aGlzLl9mbHVzaGluZyA9IDAKCiAgICB0aGlzLl9jaGVja1dyaXRlcnMgPSBbXQogICAgdGhpcy5fb3B0aW1pc3RpYyA9IC0xCiAgICB0aGlzLl9hcHBlbmRlZCA9IDAKICAgIHRoaXMuX2FwcGVuZGluZyA9IG51bGwKICAgIHRoaXMuX3dha2V1cCA9IG5ldyBBdXRvV2FrZXVwKHRoaXMpCiAgICB0aGlzLl93YWtldXBIaW50cyA9IG5ldyBNYXAoKQogICAgdGhpcy5fd2FrZXVwUGVlckJvdW5kID0gdGhpcy5fd2FrZXVwUGVlci5iaW5kKHRoaXMpCiAgICB0aGlzLl9jb3VwbGVyID0gbnVsbAoKICAgIHRoaXMuX3VwZGF0ZUxvY2FsQ29yZSA9IG51bGwKICAgIHRoaXMuX2xvY2sgPSBuZXcgU2NvcGVMb2NrKCkKCiAgICB0aGlzLl9uZWVkc1dha2V1cFJlcXVlc3QgPSBmYWxzZQogICAgdGhpcy5fbmVlZHNXYWtldXAgPSB0cnVlCiAgICB0aGlzLl9uZWVkc1dha2V1cEhlYWRzID0gdHJ1ZQoKICAgIHRoaXMuX3VwZGF0ZXMgPSBbXQogICAgdGhpcy5faGFuZGxlcnMgPSBoYW5kbGVycyB8fCB7fQogICAgdGhpcy5fd2FybiA9IGVtaXRXYXJuaW5nLmJpbmQodGhpcykKICAgIHRoaXMuX2xhc3RFcnJvciA9IG51bGwKCiAgICB0aGlzLl9kcmFpbmluZyA9IGZhbHNlCiAgICB0aGlzLl93cml0YWJsZSA9IG51bGwKICAgIHRoaXMuX2FkdmFuY2luZyA9IG51bGwKICAgIHRoaXMuX2ludGVycnVwdGluZyA9IGZhbHNlCiAgICB0aGlzLl9jYXVnaHR1cCA9IGZhbHNlCgogICAgdGhpcy5wYXVzZWQgPSBmYWxzZQoKICAgIHRoaXMuX2J1bXAgPSBkZWJvdW5jZWlmeSgoKSA9PiB7CiAgICAgIHRoaXMuX2FkdmFuY2luZyA9IHRoaXMuX2FkdmFuY2UoKQogICAgICByZXR1cm4gdGhpcy5fYWR2YW5jaW5nCiAgICB9KQoKICAgIHRoaXMuX29ucmVtb3Rld3JpdGVyY2hhbmdlQm91bmQgPSB0aGlzLl9vbnJlbW90ZXdyaXRlcmNoYW5nZS5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmxvY2Fsd3JpdGVyY2hhbmdlQm91bmQgPSB0aGlzLl9vbmxvY2Fsd3JpdGVyY2hhbmdlLmJpbmQodGhpcykKCiAgICB0aGlzLl9wcmVvcGVuID0gbnVsbAoKICAgIHRoaXMuX2hhc09wZW4gPSAhIXRoaXMuX2hhbmRsZXJzLm9wZW4KICAgIHRoaXMuX2hhc0FwcGx5ID0gISF0aGlzLl9oYW5kbGVycy5hcHBseQogICAgdGhpcy5faGFzT3B0aW1pc3RpY0FwcGx5ID0gISF0aGlzLl9oYW5kbGVycy5vcHRpbWlzdGljCiAgICB0aGlzLl9oYXNVcGRhdGUgPSAhIXRoaXMuX2hhbmRsZXJzLnVwZGF0ZQogICAgdGhpcy5faGFzQ2xvc2UgPSAhIXRoaXMuX2hhbmRsZXJzLmNsb3NlCgogICAgdGhpcy5fdmlld1N0b3JlID0gbmV3IEF1dG9TdG9yZSh0aGlzKQogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG51bGwKCiAgICB0aGlzLnZpZXcgPSBudWxsCiAgICB0aGlzLmNvcmUgPSBudWxsCiAgICB0aGlzLnZlcnNpb24gPSAtMQogICAgdGhpcy5pbnRlcnJ1cHRlZCA9IG51bGwKICAgIHRoaXMucmVjb3ZlcmllcyA9IFJFQ09WRVJJRVMKCiAgICBjb25zdCB7IGFja0ludGVydmFsID0gREVGQVVMVF9BQ0tfSU5URVJWQUwsIGFja1RocmVzaG9sZCA9IERFRkFVTFRfQUNLX1RIUkVTSE9MRCB9ID0gaGFuZGxlcnMKCiAgICB0aGlzLl9hY2tJbnRlcnZhbCA9IGFja0ludGVydmFsCiAgICB0aGlzLl9hY2tUaHJlc2hvbGQgPSBhY2tUaHJlc2hvbGQKICAgIHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQgPSBhY2tUaHJlc2hvbGQKICAgIHRoaXMuX2Fja1RpY2sgPSAwCgogICAgdGhpcy5fYWNrVGltZXIgPSBudWxsCiAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQoKICAgIHRoaXMuX3dhaXRpbmcgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCgogICAgdGhpcy52aWV3ID0gdGhpcy5faGFzT3BlbgogICAgICA/IHRoaXMuX2hhbmRsZXJzLm9wZW4odGhpcy5fdmlld1N0b3JlLCBuZXcgUHVibGljQXBwbHlDYWxscyh0aGlzKSkKICAgICAgOiBudWxsCiAgICB0aGlzLmNvcmUgPSB0aGlzLl92aWV3U3RvcmUuZ2V0KHsgbmFtZTogJ19zeXN0ZW0nIH0pCgogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRFbmFibGVkICYmIGlzT2JqZWN0KGhhbmRsZXJzLmZhc3RGb3J3YXJkKSkgewogICAgICB0aGlzLl9ydW5GYXN0Rm9yd2FyZCgKICAgICAgICBuZXcgRmFzdEZvcndhcmQodGhpcywgaGFuZGxlcnMuZmFzdEZvcndhcmQua2V5LCB7IHZlcmlmaWVkOiBmYWxzZSB9KQogICAgICApLmNhdGNoKG5vb3ApCiAgICB9CgogICAgdGhpcy5yZWFkeSgpLmNhdGNoKHNhZmV0eUNhdGNoKQogIH0KCiAgW2luc3BlY3RdKGRlcHRoLCBvcHRzKSB7CiAgICBsZXQgaW5kZW50ID0gJycKICAgIGlmICh0eXBlb2Ygb3B0cy5pbmRlbnRhdGlvbkx2bCA9PT0gJ251bWJlcicpIHsKICAgICAgd2hpbGUgKGluZGVudC5sZW5ndGggPCBvcHRzLmluZGVudGF0aW9uTHZsKSBpbmRlbnQgKz0gJyAnCiAgICB9CgogICAgcmV0dXJuIGluZGVudCArICdBdXRvYmFzZSB7IC4uLiB9JwogIH0KCiAgLy8ganVzdCBjb21wYXQsIHVzZSAua2V5CiAgZ2V0IGJvb3RzdHJhcCgpIHsKICAgIHJldHVybiB0aGlzLmtleQogIH0KCiAgLy8gVE9ETzogY29tcGF0LCB3aWxsIGJlIHJlbW92ZWQKICBnZXQgYm9vdHN0cmFwcygpIHsKICAgIHJldHVybiBbdGhpcy5ib290c3RyYXBdCiAgfQoKICBnZXQgYXBwZW5kaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2FwcGVuZGluZyAhPT0gbnVsbCAmJiB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoID4gMAogIH0KCiAgZ2V0IHdyaXRhYmxlKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxXcml0ZXIgIT09IG51bGwgJiYgIXRoaXMubG9jYWxXcml0ZXIuaXNSZW1vdmVkCiAgfQoKICBnZXQgYWNrYWJsZSgpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsICYmIHRoaXMubG9jYWxXcml0ZXIuaXNBY3RpdmVJbmRleGVyCiAgfQoKICBnZXQgc2lnbmVkTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5zaWduZWRMZW5ndGgKICB9CgogIGdldCBpbmRleGVkTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2FwcGx5U3RhdGUgPyB0aGlzLl9hcHBseVN0YXRlLmluZGV4ZWRMZW5ndGggOiAwCiAgfQoKICBnZXQgbGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5sZW5ndGgKICB9CgogIGdldCBmbHVzaGluZygpIHsKICAgIHJldHVybiB0aGlzLl9mbHVzaGluZyA+IDAKICB9CgogIGhhc2goKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLnRyZWVIYXNoKCkKICB9CgogIC8vIGRlcHJlY2F0ZWQsIHVzZSAuY29yZS5rZXkKICBnZXRTeXN0ZW1LZXkoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmtleQogIH0KCiAgZ2V0IHN5c3RlbSgpIHsKICAgIHJldHVybiB0aGlzLl9hcHBseVN0YXRlICYmIHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtCiAgfQoKICAvLyBkZXByZWNhdGVkCiAgYXN5bmMgZ2V0SW5kZXhlZEluZm8oKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIHJldHVybiAoCiAgICAgIHRoaXMuX2FwcGx5U3RhdGUgJiYgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8odGhpcy5fYXBwbHlTdGF0ZS5pbmRleGVkTGVuZ3RoKQogICAgKQogIH0KCiAgX2lzQWN0aXZlSW5kZXhlcigpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsV3JpdGVyID8gdGhpcy5sb2NhbFdyaXRlci5pc0FjdGl2ZUluZGV4ZXIgOiBmYWxzZQogIH0KCiAgcmVwbGljYXRlKGlzSW5pdGlhdG9yLCBvcHRzKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0b3JlLnJlcGxpY2F0ZShpc0luaXRpYXRvciwgb3B0cykKICAgIHRoaXMud2FrZXVwUHJvdG9jb2wuYWRkU3RyZWFtKHN0cmVhbSkKICAgIHJldHVybiBzdHJlYW0KICB9CgogIGhlYWRzKCkgewogICAgaWYgKCF0aGlzLl9hcHBseVN0YXRlIHx8ICF0aGlzLl9hcHBseVN0YXRlLm9wZW5lZCkgcmV0dXJuIFtdCiAgICBjb25zdCBub2RlcyA9IG5ldyBBcnJheSh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5oZWFkcy5sZW5ndGgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzLmxlbmd0aDsgaSsrKQogICAgICBub2Rlc1tpXSA9IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzW2ldCiAgICByZXR1cm4gbm9kZXMuc29ydChjb21wYXJlTm9kZXMpCiAgfQoKICBhc3luYyBleHBvcnQoKSB7CiAgICBjb25zdCBleHBvcnRpbmcgPSBbdGhpcy5zdG9yZS5zdG9yYWdlLmV4cG9ydCh0aGlzLmxvY2FsLmRpc2NvdmVyeUtleSksIHRoaXMuX3ZpZXdTdG9yZS5leHBvcnQoKV0KCiAgICBjb25zdCBbbG9jYWwsIHZpZXdzXSA9IGF3YWl0IFByb21pc2UuYWxsKGV4cG9ydGluZykKCiAgICByZXR1cm4gewogICAgICBsb2NhbCwKICAgICAgdmlld3MKICAgIH0KICB9CgogIGhpbnRXYWtldXAoaGludHMpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheShoaW50cykpIGhpbnRzID0gW2hpbnRzXQogICAgZm9yIChjb25zdCB7IGtleSwgbGVuZ3RoIH0gb2YgaGludHMpIHsKICAgICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICAgIGNvbnN0IHByZXYgPSB0aGlzLl93YWtldXBIaW50cy5nZXQoaGV4KQogICAgICBpZiAoIXByZXYgfHwgbGVuZ3RoID09PSAtMSB8fCBwcmV2IDwgbGVuZ3RoKSB0aGlzLl93YWtldXBIaW50cy5zZXQoaGV4LCBsZW5ndGgpCiAgICB9CiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgc2V0QmlnQmF0Y2hlcyhib29sID0gdHJ1ZSkgewogICAgdGhpcy5iaWdCYXRjaGVzID0gYm9vbAogIH0KCiAgX3F1ZXVlQnVtcCgpIHsKICAgIHRoaXMuX2J1bXAoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIGFzeW5jIF9ydW5QcmVPcGVuKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZXJzLndhaXQpIGF3YWl0IHRoaXMuX2hhbmRsZXJzLndhaXQoKQoKICAgIGF3YWl0IHRoaXMuc3RvcmUucmVhZHkoKQoKICAgIHRoaXMua2V5UGFpciA9IChhd2FpdCB0aGlzLl9oYW5kbGVycy5rZXlQYWlyKSB8fCBudWxsCgogICAgaWYgKHRoaXMuX2hhbmRsZXJzLmVuY3J5cHRpb25LZXkgIT09IG51bGwpIHsKICAgICAgdGhpcy5lbmNyeXB0aW9uS2V5ID0gYXdhaXQgdGhpcy5faGFuZGxlcnMuZW5jcnlwdGlvbktleQogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJvb3QodGhpcy5zdG9yZSwgdGhpcy5rZXksIHsKICAgICAgZW5jcnlwdGlvbktleTogdGhpcy5lbmNyeXB0aW9uS2V5LAogICAgICBlbmNyeXB0OiB0aGlzLmVuY3J5cHQsCiAgICAgIGtleVBhaXI6IHRoaXMua2V5UGFpcgogICAgfSkKCiAgICB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwID0gcmVzdWx0LmJvb3RzdHJhcAogICAgdGhpcy5sb2NhbCA9IHJlc3VsdC5sb2NhbAoKICAgIHRoaXMua2V5ID0gcmVzdWx0LmJvb3RzdHJhcC5rZXkKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gcmVzdWx0LmJvb3RzdHJhcC5kaXNjb3ZlcnlLZXkKICAgIHRoaXMuaWQgPSByZXN1bHQuYm9vdHN0cmFwLmlkCgogICAgdGhpcy5lbmNyeXB0aW9uS2V5ID0gcmVzdWx0LmVuY3J5cHRpb25LZXkKCiAgICBpZiAodGhpcy5lbmNyeXB0ZWQpIHsKICAgICAgYXNzZXJ0KHRoaXMuZW5jcnlwdGlvbktleSAhPT0gbnVsbCwgJ0VuY3J5cHRpb24ga2V5IGlzIGV4cGVjdGVkJykKICAgIH0KCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uS2V5KSB7CiAgICAgIHRoaXMuZW5jcnlwdGlvbiA9IG5ldyBFbmNyeXB0aW9uVmlldyh0aGlzLCBudWxsKQoKICAgICAgdGhpcy5sb2NhbC5zZXRFbmNyeXB0aW9uKHRoaXMuZ2V0V3JpdGVyRW5jcnlwdGlvbigpKQogICAgICB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwLnNldEVuY3J5cHRpb24odGhpcy5nZXRXcml0ZXJFbmNyeXB0aW9uKCkpCiAgICB9CgogICAgaWYgKHRoaXMubnVrZVRpcCkgYXdhaXQgdGhpcy5fbnVrZVRpcCgpCgogICAgdGhpcy5sb2NhbC5vbignYXBwZW5kJywgdGhpcy5fb25sb2NhbHdyaXRlcmNoYW5nZUJvdW5kKQoKICAgIHRoaXMud2FrZXVwQ2FwYWJpbGl0eSA9IChhd2FpdCB0aGlzLl9oYW5kbGVycy53YWtldXBDYXBhYmlsaXR5KSB8fCB7CiAgICAgIGtleTogdGhpcy5rZXksCiAgICAgIGRpc2NvdmVyeUtleTogdGhpcy5kaXNjb3ZlcnlLZXkKICAgIH0KICAgIHRoaXMuc2V0V2FrZXVwKHRoaXMud2FrZXVwQ2FwYWJpbGl0eS5rZXksIHRoaXMud2FrZXVwQ2FwYWJpbGl0eS5kaXNjb3ZlcnlLZXkpCiAgfQoKICBhc3luYyBfbnVrZVRpcEJhdGNoKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJyB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQogICAgaWYgKGJhdGNoLmxlbmd0aCA+IGxlbmd0aCkgYXdhaXQgYmF0Y2gudHJ1bmNhdGUobGVuZ3RoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQoKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogIH0KCiAgLy8gVE9ETzogbm90IGF0b21pYyBhdG0sIHNvIG1vcmUgb2YgYSAodmVyeSB1c2VmdWwpIGRlYnVnIGhlbHBlcgogIGFzeW5jIF9udWtlVGlwKCkgewogICAgY29uc3QgcG9pbnRlciA9IGF3YWl0IHRoaXMubG9jYWwuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnKQogICAgaWYgKCFwb2ludGVyKSByZXR1cm4KCiAgICBjb25zdCBib290ID0gYy5kZWNvZGUobWVzc2FnZXMuQm9vdFJlY29yZCwgcG9pbnRlcikKCiAgICBhd2FpdCBMb2NhbFN0YXRlLmNsZWFyKHRoaXMubG9jYWwpCgogICAgYXdhaXQgdGhpcy5fbnVrZVRpcEJhdGNoKGJvb3Qua2V5LCBib290LnN5c3RlbUxlbmd0aCkKCiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXk6IGJvb3Qua2V5LCBhY3RpdmU6IGZhbHNlLCBlbmNyeXB0aW9uOiBudWxsIH0pCiAgICBjb25zdCBlbmNDb3JlID0gYXdhaXQgRW5jcnlwdGlvblZpZXcuc2V0U3lzdGVtRW5jcnlwdGlvbih0aGlzLCBjb3JlKQoKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJyB9KQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQoKICAgIGNvbnN0IGluZm8gPSBhd2FpdCBTeXN0ZW1WaWV3LmdldEluZGV4ZWRJbmZvKGJhdGNoLCBib290LnN5c3RlbUxlbmd0aCkKICAgIGF3YWl0IGJhdGNoLmNsb3NlKCkKCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgaW5mby52aWV3cykgewogICAgICAvLyBlbnN1cmUgYW55IHZpZXdzIHJlZidlZCBieSBzeXN0ZW0gYXJlIGNvbnNpc3RlbnQgYXMgd2VsbAogICAgICBhd2FpdCB0aGlzLl9udWtlVGlwQmF0Y2godmlldy5rZXksIHZpZXcubGVuZ3RoKQogICAgfQoKICAgIGlmIChib290LmhlYWRzKSB0aGlzLmhpbnRXYWtldXAoYm9vdC5oZWFkcykKICAgIGlmICh0aGlzLmxvY2FsLmxlbmd0aCkgdGhpcy5oaW50V2FrZXVwKFt7IGtleTogdGhpcy5sb2NhbC5rZXksIGxlbmd0aDogdGhpcy5sb2NhbC5sZW5ndGggfV0pCgogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICBpZiAoZW5jQ29yZSkgYXdhaXQgZW5jQ29yZS5jbG9zZSgpCiAgfQoKICBfYnVtcFdha2V1cFBlZXIocGVlcikgewogICAgaWYgKHRoaXMuX2NvdXBsZXIpIHRoaXMuX2NvdXBsZXIudXBkYXRlKHBlZXIuc3RyZWFtKQogIH0KCiAgYXN5bmMgX3JvdGF0ZUxvY2FsV3JpdGVyKG5ld0xvY2FsKSB7CiAgICBhc3NlcnQoIXRoaXMuYXBwZW5kaW5nLCAnQ2Fubm90IHJvdGF0ZSBhIG5ld0xvY2FsIHdyaXRlciBpZiBhbiBhcHBlbmQgaXMgaW4gcHJvZ3Jlc3MnKQoKICAgIGNvbnN0IG9sZExvY2FsID0gdGhpcy5sb2NhbAoKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlKSBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNsb3NlKCkKCiAgICB0aGlzLmxvY2FsID0gbmV3TG9jYWwKICAgIHRoaXMubG9jYWwub24oJ2FwcGVuZCcsIHRoaXMuX29ubG9jYWx3cml0ZXJjaGFuZ2VCb3VuZCkKCiAgICB0aGlzLmxvY2FsV3JpdGVyID0gbnVsbAogICAgdGhpcy5fdXBkYXRlTG9jYWxDb3JlID0gbnVsbAoKICAgIGNvbnN0IHN0b3JlID0gdGhpcy5fdmlld1N0b3JlLmF0b21pemUoKQoKICAgIGNvbnN0IGxvY2FsID0gc3RvcmUuZ2V0TG9jYWwoKQogICAgYXdhaXQgbG9jYWwucmVhZHkoKQoKICAgIGF3YWl0IExvY2FsU3RhdGUubW92ZVRvKG9sZExvY2FsLCBsb2NhbCkKCiAgICBhd2FpdCBsb2NhbC5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCB0aGlzLmtleSkKICAgIGlmICh0aGlzLmVuY3J5cHRpb25LZXkpIGF3YWl0IGxvY2FsLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9lbmNyeXB0aW9uJywgdGhpcy5lbmNyeXB0aW9uS2V5KQoKICAgIGF3YWl0IHN0b3JlLmZsdXNoKCkKICAgIGF3YWl0IHN0b3JlLmNsb3NlKCkKCiAgICBhd2FpdCB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9sb2NhbCcsIGxvY2FsLmtleSkKCiAgICBhd2FpdCB0aGlzLl9jbGVhcldyaXRlcnMoKQogICAgYXdhaXQgb2xkTG9jYWwuY2xvc2UoKQoKICAgIC8vIGRvbmUsIHNvZnQgcmVib290CgogICAgYXdhaXQgdGhpcy5fdmlld1N0b3JlLnVwZGF0ZUxvY2FsKCkKCiAgICBhd2FpdCB0aGlzLl9jbGVhcldyaXRlcnMoKQoKICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBuZXcgQXBwbHlTdGF0ZSh0aGlzKQogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplckZyb21WaWV3U3RhdGUoKQoKICAgIHRoaXMuX2NhdWdodHVwID0gZmFsc2UKCiAgICB0aGlzLl9yZWJvb3RlZCgpCgogICAgdGhpcy5lbWl0KCdyb3RhdGUtbG9jYWwtd3JpdGVyJykKICB9CgogIGFzeW5jIHNldExvY2FsKGtleSwgeyBrZXlQYWlyIH0gPSB7fSkgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgY29uc3QgbWFuaWZlc3QgPSBrZXlQYWlyCiAgICAgID8geyB2ZXJzaW9uOiB0aGlzLnN0b3JlLm1hbmlmZXN0VmVyc2lvbiwgc2lnbmVyczogW3sgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSB9XSB9CiAgICAgIDogbnVsbAogICAgaWYgKCFrZXkpIGtleSA9IEh5cGVyY29yZS5rZXkobWFuaWZlc3QpCiAgICAvLyBJZiB0aGUga2V5cyBhcmUgdGhlIHNhbWUsIG5vIG5lZWQgdG8gcm90YXRlCiAgICBpZiAoYjRhLmVxdWFscyhrZXksIHRoaXMubG9jYWwua2V5KSkgcmV0dXJuCgogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuZW5jcnlwdGlvbktleSA/IHRoaXMuZ2V0V3JpdGVyRW5jcnlwdGlvbigpIDogbnVsbAoKICAgIGNvbnN0IGxvY2FsID0gdGhpcy5zdG9yZS5nZXQoewogICAgICBrZXksCiAgICAgIG1hbmlmZXN0LAogICAgICBhY3RpdmU6IGZhbHNlLAogICAgICBleGNsdXNpdmU6IHRydWUsCiAgICAgIGVuY3J5cHRpb24sCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZQogICAgfSkKICAgIGF3YWl0IGxvY2FsLnJlYWR5KCkKCiAgICB0aGlzLl91cGRhdGVMb2NhbENvcmUgPSBsb2NhbAoKICAgIGxldCBydW5zID0gMAogICAgd2hpbGUgKCF0aGlzLl9pbnRlcnJ1cHRpbmcgJiYgdGhpcy5hcHBlbmRpbmcgJiYgcnVucysrIDwgMTYpIGF3YWl0IHRoaXMudXBkYXRlKCkKICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogIH0KCiAgc2V0V2FrZXVwKGNhcCwgZGlzY292ZXJ5S2V5KSB7CiAgICBpZiAodGhpcy53YWtldXBTZXNzaW9uKSB0aGlzLndha2V1cFNlc3Npb24uZGVzdHJveSgpCiAgICBpZiAoIWRpc2NvdmVyeUtleSAmJiBiNGEuZXF1YWxzKGNhcCwgdGhpcy5rZXkpKSBkaXNjb3ZlcnlLZXkgPSB0aGlzLmRpc2NvdmVyeUtleQogICAgdGhpcy53YWtldXBTZXNzaW9uID0gdGhpcy53YWtldXBQcm90b2NvbC5zZXNzaW9uKAogICAgICBjYXAsCiAgICAgIG5ldyBXYWtldXBIYW5kbGVyKHRoaXMsIGRpc2NvdmVyeUtleSB8fCBudWxsKQogICAgKQoKICAgIC8vIGluY2FzZSB0aGlzIHNlc3Npb24gaGFzIGFjdGl2ZSBwZWVycyBhbHJlYWR5LCBidW1wIHRoZSBjb3VwbGVyCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy53YWtldXBTZXNzaW9uLnBlZXJzKSB7CiAgICAgIGlmIChwZWVyLmFjdGl2ZSkgdGhpcy5fYnVtcFdha2V1cFBlZXIocGVlcikKICAgIH0KICB9CgogIGFzeW5jIF9nZXRNaWdyYXRpb25Qb2ludGVyKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UsIGVuY3J5cHRpb246IG51bGwgfSkKICAgIGNvbnN0IGVuY0NvcmUgPSBhd2FpdCBFbmNyeXB0aW9uVmlldy5zZXRTeXN0ZW1FbmNyeXB0aW9uKHRoaXMsIGNvcmUpCgogICAgY29uc3QgbWluID0gY29yZS5tYW5pZmVzdCAmJiBjb3JlLm1hbmlmZXN0LnByb2xvZ3VlID8gY29yZS5tYW5pZmVzdC5wcm9sb2d1ZS5sZW5ndGggOiAwCgogICAgZm9yIChsZXQgaSA9IGxlbmd0aCAtIDE7IGkgPj0gbWluOyBpLS0pIHsKICAgICAgaWYgKCEoYXdhaXQgY29yZS5oYXMoaSkpKSBjb250aW51ZQoKICAgICAgY29uc3Qgc3lzID0gbmV3IFN5c3RlbVZpZXcoY29yZSwgeyBjaGVja291dDogaSArIDEgfSkKICAgICAgYXdhaXQgc3lzLnJlYWR5KCkKCiAgICAgIGxldCBnb29kID0gdHJ1ZQoKICAgICAgZm9yIChjb25zdCB2IG9mIHN5cy52aWV3cykgewogICAgICAgIGNvbnN0IHZjID0gdGhpcy5zdG9yZS5nZXQoeyBrZXk6IHYua2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICAgICAgYXdhaXQgdmMucmVhZHkoKQogICAgICAgIGlmICh2Yy5sZW5ndGggPCB2Lmxlbmd0aCkgZ29vZCA9IGZhbHNlCiAgICAgICAgYXdhaXQgdmMuY2xvc2UoKQogICAgICB9CgogICAgICBhd2FpdCBzeXMuY2xvc2UoKQogICAgICBpZiAoIWdvb2QpIGNvbnRpbnVlCgogICAgICByZXR1cm4gaSArIDEKICAgIH0KCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIGlmIChlbmNDb3JlKSBhd2FpdCBlbmNDb3JlLmNsb3NlKCkKCiAgICByZXR1cm4gbWluCiAgfQoKICAvLyBtaWdyYXRpbmcgZnJvbSA2IC0+IGxhdGVzdAogIGFzeW5jIF9taWdyYXRlNihrZXksIGxlbmd0aCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJywgb3ZlcndyaXRlOiB0cnVlLCBjaGVja291dDogbGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICB9CgogIC8vIGNhbGxlZCBieSB2aWV3LXN0b3JlIGZvciBib290c3RyYXBwaW5nCiAgYXN5bmMgX2dldFN5c3RlbUluZm8oKSB7CiAgICBjb25zdCBib290ID0gYXdhaXQgdGhpcy5fZ2V0Qm9vdFJlY29yZCgpCiAgICBpZiAoIWJvb3Qua2V5KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IG1pZ3JhdGVkID0gISFib290LmhlYWRzCiAgICBjb25zdCBpbmRleGVkTGVuZ3RoID0gYm9vdC5zeXN0ZW1MZW5ndGgKCiAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgLy8gZW5zdXJlIHN5c3RlbSBiYXRjaCBpcyBjb25zaXN0ZW50IG9uIGluaXRpYWwgbWlncmF0aW9uCiAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGU2KGJvb3Qua2V5LCBpbmRleGVkTGVuZ3RoKQogICAgfQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleTogYm9vdC5rZXksIGVuY3J5cHRpb246IG51bGwsIGFjdGl2ZTogZmFsc2UgfSkKICAgIGF3YWl0IGNvcmUucmVhZHkoKQoKICAgIGNvbnN0IGJhdGNoID0gY29yZS5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJyB9KQogICAgY29uc3QgZW5jQ29yZSA9IGF3YWl0IEVuY3J5cHRpb25WaWV3LnNldFN5c3RlbUVuY3J5cHRpb24odGhpcywgYmF0Y2gpCgogICAgY29uc3QgaW5mbyA9IGF3YWl0IFN5c3RlbVZpZXcuZ2V0SW5kZXhlZEluZm8oYmF0Y2gsIGluZGV4ZWRMZW5ndGgpCgogICAgaWYgKGVuY0NvcmUpIGF3YWl0IGVuY0NvcmUuY2xvc2UoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQogICAgYXdhaXQgY29yZS5jbG9zZSgpCgogICAgaWYgKGluZm8udmVyc2lvbiA+IE1BWF9BVVRPQkFTRV9WRVJTSU9OKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgdXBncmFkZSByZXF1aXJlZC4nKQogICAgfQoKICAgIC8vIGp1c3QgY29tcGF0CiAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgdGhpcy5taWdyYXRlZCA9IHRydWUKCiAgICAgIGZvciAoY29uc3QgdmlldyBvZiBpbmZvLnZpZXdzKSB7CiAgICAgICAgLy8gZW5zdXJlIGFueSB2aWV3cyByZWYnZWQgYnkgc3lzdGVtIGFyZSBjb25zaXN0ZW50IGFzIHdlbGwKICAgICAgICBhd2FpdCB0aGlzLl9taWdyYXRlNih2aWV3LmtleSwgdmlldy5sZW5ndGgpCiAgICAgIH0KCiAgICAgIGlmIChib290LmhlYWRzKSB0aGlzLmhpbnRXYWtldXAoYm9vdC5oZWFkcykKICAgICAgaWYgKHRoaXMubG9jYWwubGVuZ3RoKSB0aGlzLmhpbnRXYWtldXAoW3sga2V5OiB0aGlzLmxvY2FsLmtleSwgbGVuZ3RoOiB0aGlzLmxvY2FsLmxlbmd0aCB9XSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICBrZXk6IGJvb3Qua2V5LAogICAgICBpbmRleGVyczogaW5mby5pbmRleGVycywKICAgICAgdmlld3M6IGluZm8udmlld3MsCiAgICAgIGVudHJvcHk6IGluZm8uZW50cm9weQogICAgfQogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBhcHBseSBzdGF0ZSBmb3IgYm9vdHN0cmFwcGluZwogIGFzeW5jIF9nZXRCb290UmVjb3JkKCkgewogICAgYXdhaXQgdGhpcy5fcHJlb3BlbgoKICAgIGNvbnN0IHBvaW50ZXIgPSBhd2FpdCB0aGlzLmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JykKCiAgICBjb25zdCBib290ID0gcG9pbnRlcgogICAgICA/IGMuZGVjb2RlKG1lc3NhZ2VzLkJvb3RSZWNvcmQsIHBvaW50ZXIpCiAgICAgIDogewogICAgICAgICAgdmVyc2lvbjogQk9PVF9SRUNPUkRfVkVSU0lPTiwKICAgICAgICAgIGtleTogbnVsbCwKICAgICAgICAgIHN5c3RlbUxlbmd0aDogMCwKICAgICAgICAgIGluZGV4ZXJzVXBkYXRlZDogZmFsc2UsCiAgICAgICAgICBmYXN0Rm9yd2FyZGluZzogZmFsc2UsCiAgICAgICAgICByZWNvdmVyaWVzOiBSRUNPVkVSSUVTLAogICAgICAgICAgaGVhZHM6IG51bGwKICAgICAgICB9CgogICAgaWYgKGJvb3QuaGVhZHMpIHsKICAgICAgY29uc3QgbGVuID0gYXdhaXQgdGhpcy5fZ2V0TWlncmF0aW9uUG9pbnRlcihib290LmtleSwgYm9vdC5zeXN0ZW1MZW5ndGgpCiAgICAgIGlmIChsZW4gIT09IGJvb3Quc3lzdGVtTGVuZ3RoKQogICAgICAgIHRoaXMuX3dhcm4oCiAgICAgICAgICBuZXcgRXJyb3IoCiAgICAgICAgICAgICdJbnZhbGlkIHBvaW50ZXIgaW4gbWlncmF0aW9uLCBjb3JyZWN0aW5nICgnICsgbGVuICsgJyB2cyAnICsgYm9vdC5zeXN0ZW1MZW5ndGggKyAnKScKICAgICAgICAgICkKICAgICAgICApCiAgICAgIGJvb3Quc3lzdGVtTGVuZ3RoID0gbGVuCiAgICB9CgogICAgcmV0dXJuIGJvb3QKICB9CgogIHN0YXRpYyBhc3luYyBnZXRCb290UmVjb3JkKHN0b3JlLCBrZXkpIHsKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJvb3Qoc3RvcmUsIGtleSwgeyBleGNsdXNpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLmNsb3NlKCkKICAgIGF3YWl0IHJlc3VsdC5sb2NhbC5jbG9zZSgpCiAgICByZXR1cm4gcmVzdWx0LmJvb3QKICB9CgogIF9pbnRlcnJ1cHQocmVhc29uKSB7CiAgICBhc3NlcnQoISF0aGlzLl9hcHBseVN0YXRlLmFwcGx5aW5nLCAnSW50ZXJydXB0IGlzIG9ubHkgYWxsb3dlZCBpbiBhcHBseScpCiAgICB0aGlzLl9pbnRlcnJ1cHRpbmcgPSB0cnVlCiAgICBpZiAocmVhc29uKSB0aGlzLmludGVycnVwdGVkID0gcmVhc29uCiAgICB0aHJvdyBJTlRFUlJVUFQKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuX2ZsdXNoaW5nID09PSAwKSByZXR1cm4KICAgIHJldHVybiB0aGlzLl9mbHVzaFNpZ25hbC53YWl0KCkKICB9CgogIGFzeW5jIGFkdmFuY2UoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGF3YWl0IHRoaXMuX2FkdmFuY2luZwogIH0KCiAgcmVjb3VwbGUoKSB7CiAgICBpZiAodGhpcy5fY291cGxlcikgdGhpcy5fY291cGxlci5kZXN0cm95KCkKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl92aWV3U3RvcmUuZ2V0U3lzdGVtQ29yZSgpCiAgICB0aGlzLl9jb3VwbGVyID0gbmV3IENvcmVDb3VwbGVyKGNvcmUsIHRoaXMuX3dha2V1cFBlZXJCb3VuZCkKICB9CgogIF91cGRhdGVCb290c3RyYXBXcml0ZXJzKCkgewogICAgY29uc3Qgd3JpdGVycyA9IHRoaXMubGluZWFyaXplci5nZXRCb290c3RyYXBXcml0ZXJzKCkKCiAgICAvLyBmaXJzdCBjbGVhciBhbGwsIGJ1dCB3aXRob3V0IGFwcGx5aW5nIGl0IGZvciBjaHVybiByZWFzb25zCiAgICBmb3IgKGNvbnN0IHdyaXRlciBvZiB0aGlzLl9ib290c3RyYXBXcml0ZXJzKSB7CiAgICAgIHdyaXRlci5pc0Jvb3RzdHJhcCA9IGZhbHNlCiAgICAgIHdyaXRlci5pc0NvdXBsZWQgPSBmYWxzZQogICAgfQoKICAgIC8vIGFsbCBwYXNzZWQgYXJlIGJvb3RzdHJhcHMKICAgIGZvciAoY29uc3Qgd3JpdGVyIG9mIHdyaXRlcnMpIHsKICAgICAgd3JpdGVyLmlzQ291cGxlZCA9IHRydWUKICAgICAgd3JpdGVyLnNldEJvb3RzdHJhcCh0cnVlKQogICAgfQoKICAgIC8vIHJlc2V0IGFjdGl2aXR5IG9uIG9sZCBvbmVzLCBhbGwgc2hvdWxkIGJlIGluIHN5bmMgbm93CiAgICBmb3IgKGNvbnN0IHdyaXRlciBvZiB0aGlzLl9ib290c3RyYXBXcml0ZXJzKSB7CiAgICAgIGlmICh3cml0ZXIuaXNCb290c3RyYXAgPT09IGZhbHNlKSB3cml0ZXIuc2V0Qm9vdHN0cmFwKGZhbHNlKQogICAgfQoKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnMgPSB3cml0ZXJzCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzQ2hhbmdlZCA9IGZhbHNlCiAgfQoKICBhc3luYyBfb3BlbkxpbmVhcml6ZXIoKSB7CiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uYm9vdHN0cmFwcGluZykgewogICAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplcihudWxsKQogICAgICB0aGlzLl9ib290c3RyYXBMaW5lYXJpemVyKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgYXdhaXQgdGhpcy5fbWFrZUxpbmVhcml6ZXJGcm9tVmlld1N0YXRlKCkKICB9CgogIGFzeW5jIF9jYXRjaHVwQXBwbHlTdGF0ZSgpIHsKICAgIGlmIChhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnNob3VsZE1pZ3JhdGUoKSkgewogICAgICBhd2FpdCB0aGlzLl9taWdyYXRlKCkKICAgIH0gZWxzZSBpZiAoIShhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNhdGNodXAodGhpcy5saW5lYXJpemVyKSkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5fY2F1Z2h0dXAgPSB0cnVlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICB0aGlzLl9wcmVvcGVuID0gdGhpcy5fcnVuUHJlT3BlbigpCiAgICBhd2FpdCB0aGlzLl9wcmVvcGVuCgogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG5ldyBBcHBseVN0YXRlKHRoaXMpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWFkeSgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuY2xvc2UoKQogICAgICB9IGNhdGNoIHt9CgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICAgIH0gY2F0Y2gge30KCiAgICAgIHRoaXMuX2FwcGx5U3RhdGUgPSBudWxsCiAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fb3BlbkxpbmVhcml6ZXIoKQogICAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgICBhd2FpdCB0aGlzLl93YWtldXAucmVhZHkoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybgogICAgICB0aHJvdyBlcnIKICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCAtIHRoaXMuX2FwcGx5U3RhdGUuaW5kZXhlZExlbmd0aCA+IHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQpIHsKICAgICAgdGhpcy5fYWNrVGljayA9IHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQKICAgIH0KICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICYmIHRoaXMuX2Fja0ludGVydmFsKSB7CiAgICAgIHRoaXMuX3N0YXJ0QWNrVGltZXIoKQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZUJvb3RzdHJhcFdyaXRlcnMoKQoKICAgIHRoaXMucmVjb3VwbGUoKQogICAgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCgogICAgLy8gcXVldWUgYSBmdWxsIGJ1bXAgdGhhdCBoYW5kbGVzIHdha2V1cCBldGMgKG5vdCBsZWdhbCB0byB3YWl0IGZvciB0aGF0IGhlcmUpCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgYXdhaXQgdGhpcy5mbHVzaCgpIC8vIGZsdXNoIGFsbCBwZW5kaW5nIG5vbiBuZXR3b3JrIGlvCiAgICB0aGlzLl9pbnRlcnJ1cHRpbmcgPSB0cnVlCiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKSAvLyBkZWZlciBvbmUgdGljawoKICAgIGlmICh0aGlzLndha2V1cFNlc3Npb24pIHRoaXMud2FrZXVwU2Vzc2lvbi5kZXN0cm95KCkKICAgIGlmICh0aGlzLndha2V1cE93bmVyKSB0aGlzLndha2V1cFByb3RvY29sLmRlc3Ryb3koKQoKICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkaW5nKSBhd2FpdCB0aGlzLmZhc3RGb3J3YXJkaW5nLmNsb3NlKCkKCiAgICBpZiAodGhpcy5fY291cGxlcikgdGhpcy5fY291cGxlci5kZXN0cm95KCkKICAgIHRoaXMuX2NvdXBsZXIgPSBudWxsCiAgICB0aGlzLl93YWl0aW5nLm5vdGlmeShudWxsKQoKICAgIGF3YWl0IHRoaXMuYWN0aXZlV3JpdGVycy5jbGVhcigpCgogICAgY29uc3QgY2xvc2luZyA9IHRoaXMuX2FkdmFuY2luZyA/IHRoaXMuX2FkdmFuY2luZy5jYXRjaChzYWZldHlDYXRjaCkgOiBudWxsCgogICAgYXdhaXQgdGhpcy5fY2xlYXJXcml0ZXJzKCkKICAgIGlmICh0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwKSBhd2FpdCB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMubG9jYWwuY2xvc2UoKQoKICAgIGlmICh0aGlzLl9hY2tUaW1lcikgewogICAgICB0aGlzLl9hY2tUaW1lci5zdG9wKCkKICAgICAgYXdhaXQgdGhpcy5fYWNrVGltZXIuZmx1c2goKQogICAgfQoKICAgIGF3YWl0IHRoaXMuX3dha2V1cC5jbG9zZSgpCgogICAgaWYgKHRoaXMuX2hhc0Nsb3NlKSBhd2FpdCB0aGlzLl9oYW5kbGVycy5jbG9zZSh0aGlzLnZpZXcpCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCgogICAgYXdhaXQgdGhpcy5fdmlld1N0b3JlLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLnN0b3JlLmNsb3NlKCkKCiAgICBpZiAodGhpcy5fd3JpdGFibGUpIHRoaXMuX3dyaXRhYmxlLnJlc29sdmUoZmFsc2UpCgogICAgYXdhaXQgY2xvc2luZwogIH0KCiAgZ2V0TGFzdEVycm9yKCkgewogICAgcmV0dXJuIHRoaXMuX2xhc3RFcnJvcgogIH0KCiAgX29uRXJyb3IoZXJyKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICB0aGlzLl9sYXN0RXJyb3IgPSBlcnIKCiAgICBpZiAoZXJyID09PSBJTlRFUlJVUFQpIHsKICAgICAgdGhpcy5lbWl0KCdpbnRlcnJ1cHQnLCB0aGlzLmludGVycnVwdGVkKQogICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuY2xvc2UoKS5jYXRjaChzYWZldHlDYXRjaCkKCiAgICAvLyBpZiBubyBvbmUgaXMgbGlzdGVuaW5nIHdlIHNob3VsZCBjcmFzaCEgd2UgY2Fubm90IHJlbHkgb24gdGhlIEVFIGhlcmUKICAgIC8vIGFzIHRoaXMgaXMgd3JhcHBlZCBpbiBhIHByb21pc2Ugc28gaW5zdGVhZCBvZiBuZXh0VGljayB0aHJvdyBpdAogICAgaWYgKFJlYWR5UmVzb3VyY2UubGlzdGVuZXJDb3VudCh0aGlzLCAnZXJyb3InKSA9PT0gMCkgewogICAgICBjcmFzaFNvb24oZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKQogIH0KCiAgYXN5bmMgX2Nsb3NlV3JpdGVyKHcpIHsKICAgIHRoaXMuYWN0aXZlV3JpdGVycy5kZWxldGUodykKICAgIGF3YWl0IHcuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2djV3JpdGVycygpIHsKICAgIC8vIGp1c3QgcmV0dXJuIGVhcmx5LCB3aHkgbm90CiAgICBpZiAodGhpcy5fY2hlY2tXcml0ZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuCgogICAgd2hpbGUgKHRoaXMuX2NoZWNrV3JpdGVycy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHcgPSB0aGlzLl9jaGVja1dyaXRlcnMucG9wKCkKCiAgICAgIC8vIGRvZXNudCBodXJ0CiAgICAgIHcudXBkYXRlQWN0aXZpdHkoKQoKICAgICAgaWYgKCF3LmZsdXNoZWQoKSkgY29udGludWUKCiAgICAgIGNvbnN0IHVucXVldWVkID0gdGhpcy5fd2FrZXVwLnVucXVldWUody5jb3JlLmtleSwgdy5jb3JlLmxlbmd0aCkKCiAgICAgIGlmICghdW5xdWV1ZWQgfHwgdy5pc0FjdGl2ZUluZGV4ZXIpIGNvbnRpbnVlCiAgICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyID09PSB3KSBjb250aW51ZQoKICAgICAgYXdhaXQgdGhpcy5fY2xvc2VXcml0ZXIodykKICAgIH0KCiAgICBhd2FpdCB0aGlzLl93YWtldXAuZmx1c2goKQogIH0KCiAgX3N0YXJ0QWNrVGltZXIoKSB7CiAgICBpZiAodGhpcy5fYWNrVGltZXIpIHJldHVybgogICAgdGhpcy5fYWNrVGltZXIgPSBuZXcgVGltZXIodGhpcy5fYmFja2dyb3VuZEFjay5iaW5kKHRoaXMpLCB0aGlzLl9hY2tJbnRlcnZhbCkKICAgIHRoaXMuX2J1bXBBY2tUaW1lcigpCiAgfQoKICBfYnVtcEFja1RpbWVyKCkgewogICAgaWYgKCF0aGlzLl9hY2tUaW1lcikgcmV0dXJuCiAgICB0aGlzLl9hY2tUaW1lci5idW1wKCkKICB9CgogIGFzeW5jIHVwZGF0ZSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogICAgICBpZiAodGhpcy5fYWNraW5nKSBhd2FpdCB0aGlzLl9idW1wKCkgLy8gaWYgYWNraW5nIGp1c3QgcmVidW1wIGluY2FzZSBpdCB3YXMgdHJpZ2dlcmVkIGZyb20gYWJvdmUuLi4KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICAvLyBydW5zIGluIGJnLCBub3QgYWxsb3dlZCB0byB0aHJvdwogIC8vIFRPRE86IHJlZmFjdG9yIHNvIHRoaXMgb25seSBtb3ZlcyB0aGUgd3JpdGVyIGFmZmVjdGVkIHRvIGEgdXBkYXRlZCBzZXQKICBhc3luYyBfb25yZW1vdGV3cml0ZXJjaGFuZ2UoKSB7CiAgICB0aGlzLl9idW1wQWNrVGltZXIoKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2J1bXAoKQogICAgfSBjYXRjaCB7fQogIH0KCiAgX29ubG9jYWx3cml0ZXJjaGFuZ2UoKSB7CiAgICBpZiAoIXRoaXMubG9jYWxXcml0ZXIgfHwgdGhpcy5sb2NhbFdyaXRlci5pc1JlbW92ZWQpIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICBfb253YWtldXAoKSB7CiAgICB0aGlzLl9uZWVkc1dha2V1cCA9IHRydWUKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICBpc0Zhc3RGb3J3YXJkaW5nKCkgewogICAgaWYgKHRoaXMuZmFzdEZvcndhcmRUbyAhPT0gbnVsbCkgcmV0dXJuIHRydWUKICAgIHJldHVybiB0aGlzLmZhc3RGb3J3YXJkRW5hYmxlZCAmJiB0aGlzLmZhc3RGb3J3YXJkaW5nICE9PSBudWxsCiAgfQoKICBfYmFja2dyb3VuZEFjaygpIHsKICAgIHJldHVybiB0aGlzLmFjayh0cnVlKQogIH0KCiAgYXN5bmMgYWNrKGJnID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIgPT09IG51bGwgfHwgdGhpcy5fYWNraW5nIHx8IHRoaXMuX2ludGVycnVwdGluZyB8fCB0aGlzLl9hcHBlbmRpbmcgIT09IG51bGwpCiAgICAgIHJldHVybgoKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlID09PSBudWxsKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICAgIH0gY2F0Y2gge30KICAgICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUgPT09IG51bGwgfHwgdGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KICAgIH0KCiAgICBjb25zdCBhcHBseVN0YXRlID0gdGhpcy5fYXBwbHlTdGF0ZQogICAgaWYgKGFwcGx5U3RhdGUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgYXBwbHlTdGF0ZS5yZWFkeSgpCgogICAgY29uc3QgaXNQZW5kaW5nSW5kZXhlciA9IGFwcGx5U3RhdGUuaXNMb2NhbFBlbmRpbmdJbmRleGVyKCkKCiAgICAvLyBpZiBubyBvbmUgaXMgd2FpdGluZyBmb3Igb3VyIGluZGV4IG1hbmlmZXN0LCB3YWl0IGZvciBGRiBiZWZvcmUgcHVzaGluZyBhbiBhY2sKICAgIGlmICgoIWlzUGVuZGluZ0luZGV4ZXIgJiYgdGhpcy5pc0Zhc3RGb3J3YXJkaW5nKCkpIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgY29uc3QgaXNJbmRleGVyID0gYXBwbHlTdGF0ZS5pc0xvY2FsSW5kZXhlcigpIHx8IGlzUGVuZGluZ0luZGV4ZXIKICAgIGlmICghaXNJbmRleGVyKSByZXR1cm4KCiAgICB0aGlzLl9hY2tpbmcgPSB0cnVlCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IGVycgogICAgfQoKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcgfHwgIXRoaXMubG9jYWxXcml0ZXIgfHwgdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQpIHsKICAgICAgdGhpcy5fYWNraW5nID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gYXZvaWQgbHVtcGluZyBhY2tzIHRvZ2V0aGVyIGR1ZSB0byB0aGUgYnVtcCB3YWl0IGhlcmUKICAgIGlmICh0aGlzLl9hY2tUaW1lciAmJiBiZykgYXdhaXQgdGhpcy5fYWNrVGltZXIuYXNhcFN0YW5kYWxvbmUoKQogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZyB8fCBhcHBseVN0YXRlLmNsb3NpbmcpIHsKICAgICAgdGhpcy5fYWNraW5nID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgYWx3YXlzV3JpdGUgPSBpc1BlbmRpbmdJbmRleGVyIHx8IChhd2FpdCBhcHBseVN0YXRlLnNob3VsZFdyaXRlKCkpCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nIHx8IGFwcGx5U3RhdGUuY2xvc2luZykgewogICAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBoYXNQZW5kaW5nSW5kZXhlcnMgPSBhcHBseVN0YXRlLnN5c3RlbS5pbmRleGVycy5sZW5ndGggPiB0aGlzLmxpbmVhcml6ZXIuaW5kZXhlcnMubGVuZ3RoCgogICAgaWYgKGFsd2F5c1dyaXRlIHx8IHRoaXMubGluZWFyaXplci5zaG91bGRBY2sodGhpcy5sb2NhbFdyaXRlciwgaGFzUGVuZGluZ0luZGV4ZXJzKSkgewogICAgICB0cnkgewogICAgICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICYmICF0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgYXdhaXQgdGhpcy5hcHBlbmQobnVsbCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIHsKICAgICAgdGhpcy5fdXBkYXRlQWNrVGhyZXNob2xkKCkKICAgICAgdGhpcy5fYnVtcEFja1RpbWVyKCkKICAgIH0KCiAgICB0aGlzLl9hY2tpbmcgPSBmYWxzZQogIH0KCiAgdmlld3MoKSB7CiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgcmV0dXJuIHRoaXMuX2FwcGx5U3RhdGUuc3RvcmUubGlzdFZpZXdzKCkKICAgIHJldHVybiB0aGlzLl92aWV3U3RvcmUubGlzdFZpZXdzKCkKICB9CgogIGJhdGNoKCkgewogICAgcmV0dXJuIG5ldyBBcHBlbmRCYXRjaCh0aGlzKQogIH0KCiAgYXN5bmMgYXBwZW5kKHZhbHVlLCBvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLl9hZHZhbmNpbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuX2FkdmFuY2luZwogICAgd2hpbGUgKHRoaXMuYWN0aXZlQmF0Y2gpIGF3YWl0IHRoaXMuYWN0aXZlQmF0Y2guZmx1c2hlZCgpCiAgICByZXR1cm4gdGhpcy5fYXBwZW5kQmF0Y2godmFsdWUsIG9wdHMpCiAgfQoKICBhc3luYyBfYXBwZW5kQmF0Y2godmFsdWUsIG9wdHMpIHsKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgaXMgY2xvc2luZycpCiAgICBpZiAodmFsdWUgJiYgdGhpcy52YWx1ZUVuY29kaW5nICE9PSBCSU5BUllfRU5DT0RJTkcpCiAgICAgIHZhbHVlID0gbm9ybWFsaXplKHRoaXMudmFsdWVFbmNvZGluZywgdmFsdWUpCgogICAgY29uc3Qgb3B0aW1pc3RpYyA9ICEhb3B0cyAmJiAhIW9wdHMub3B0aW1pc3RpYyAmJiAhIXZhbHVlCgogICAgLy8gd2Ugd2FubmEgYWxsb3cgYWNrcyBzbyBpbnRlcmRleGVycyBjYW4gZmx1c2gKICAgIGlmICgKICAgICAgIW9wdGltaXN0aWMgJiYKICAgICAgKHRoaXMubG9jYWxXcml0ZXIgPT09IG51bGwgfHwgKHRoaXMubG9jYWxXcml0ZXIuaXNSZW1vdmVkICYmIHZhbHVlICE9PSBudWxsKSkKICAgICkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCB3cml0YWJsZScpCiAgICB9CgogICAgaWYgKHRoaXMuX2FwcGVuZGluZyA9PT0gbnVsbCkgdGhpcy5fYXBwZW5kaW5nID0gW10KCiAgICBsZXQgbGVuID0gMAogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGZvciAoY29uc3QgdiBvZiB2YWx1ZSkgbGVuID0gdGhpcy5fYXBwZW5kKHYpCiAgICB9IGVsc2UgewogICAgICBsZW4gPSB0aGlzLl9hcHBlbmQodmFsdWUpCiAgICB9CgogICAgY29uc3QgbG9jYWxMZW5ndGggPSB0aGlzLmxvY2FsLmxlbmd0aAoKICAgIGlmIChvcHRpbWlzdGljKSB0aGlzLl9vcHRpbWlzdGljID0gdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCAtIDEKICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2FwcGVuZGVkICsgdGhpcy5fYXBwZW5kaW5nLmxlbmd0aAoKICAgIC8vIGF3YWl0IGluIGNhc2UgYXBwZW5kIGlzIGluIGN1cnJlbnQgdGljawogICAgaWYgKHRoaXMuX2FkdmFuY2luZykgYXdhaXQgdGhpcy5fYWR2YW5jaW5nCgogICAgbGV0IHJ1bnMgPSAwCgogICAgLy8gYnVtcCB1bnRpbCB3ZSd2ZSBmbHVzaGVkIHRoZSBub2RlcwogICAgd2hpbGUgKHRoaXMuX2FwcGVuZGVkIDwgdGFyZ2V0ICYmICF0aGlzLl9pbnRlcnJ1cHRpbmcpIHsKICAgICAgYXdhaXQgdGhpcy5fYnVtcCgpCiAgICAgIC8vIHNhZmV0eQogICAgICBpZiAocnVucysrID49IDE2ICYmIHRoaXMubG9jYWxXcml0ZXIgJiYgdGhpcy5sb2NhbFdyaXRlci5pZGxlKCkpIGJyZWFrCiAgICB9CgogICAgaWYgKHRoaXMuX2FkdmFuY2luZykgYXdhaXQgdGhpcy5fYWR2YW5jaW5nCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0F1dG9iYXNlIGlzIGNsb3NpbmcnKQoKICAgIHJldHVybiBsb2NhbExlbmd0aCArIGxlbgogIH0KCiAgX2FwcGVuZCh2YWx1ZSkgewogICAgLy8gaWYgcHJldiB2YWx1ZSBpcyBhbiBhY2sgdGhhdCBoYXNudCBiZWVuIGZsdXNoZWQsIHNraXAgaXQKICAgIGlmICh0aGlzLl9hcHBlbmRpbmcubGVuZ3RoID4gMCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoCiAgICAgIGlmICh0aGlzLl9hcHBlbmRpbmdbdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCAtIDFdID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fYXBwZW5kaW5nLnBvcCgpCiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLl9hcHBlbmRpbmcucHVzaCh2YWx1ZSkKICB9CgogIHN0YXRpYyBkZWNvZGVWYWx1ZSh2YWx1ZSwgb3B0cykgewogICAgcmV0dXJuIGRlY29kZVZhbHVlKHZhbHVlLCBvcHRzKQogIH0KCiAgc3RhdGljIGVuY29kZVZhbHVlKHZhbHVlLCBvcHRzKSB7CiAgICByZXR1cm4gZW5jb2RlVmFsdWUodmFsdWUsIG9wdHMpCiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0TG9jYWxLZXkoc3RvcmUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgY29yZSA9IG9wdHMua2V5UGFpcgogICAgICA/IHN0b3JlLmdldCh7IC4uLm9wdHMsIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgOiBzdG9yZS5nZXQoeyAuLi5vcHRzLCBuYW1lOiAnbG9jYWwnLCBhY3RpdmU6IGZhbHNlIH0pCiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGNvbnN0IGtleSA9IGNvcmUua2V5CiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIHJldHVybiBrZXkKICB9CgogIHN0YXRpYyBnZXRMb2NhbENvcmUoc3RvcmUsIGhhbmRsZXJzLCBlbmNyeXB0aW9uS2V5KSB7CiAgICBjb25zdCBlbmNyeXB0aW9uID0gIWVuY3J5cHRpb25LZXkgPyBudWxsIDogeyBrZXk6IGVuY3J5cHRpb25LZXkgfQogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgLi4uaGFuZGxlcnMsCiAgICAgIGNvbXBhdDogZmFsc2UsCiAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgIGV4Y2x1c2l2ZTogdHJ1ZSwKICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLAogICAgICBlbmNyeXB0aW9uCiAgICB9CiAgICByZXR1cm4gb3B0cy5rZXlQYWlyID8gc3RvcmUuZ2V0KG9wdHMpIDogc3RvcmUuZ2V0KHsgLi4ub3B0cywgbmFtZTogJ2xvY2FsJyB9KQogIH0KCiAgc3RhdGljIGFzeW5jIGdldFVzZXJEYXRhKGNvcmUpIHsKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCBjb3JlLmdldFVzZXJEYXRhKCdhdXRvYmFzZS92aWV3JykKCiAgICByZXR1cm4gewogICAgICByZWZlcnJlcjogYXdhaXQgY29yZS5nZXRVc2VyRGF0YSgncmVmZXJyZXInKSwKICAgICAgdmlldzogdmlldyA/IGI0YS50b1N0cmluZyh2aWV3KSA6IG51bGwKICAgIH0KICB9CgogIHN0YXRpYyBhc3luYyBpc0F1dG9iYXNlKGNvcmUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgYmxvY2sgPSBhd2FpdCBjb3JlLmdldCgwLCBvcHRzKQogICAgaWYgKCFibG9jaykgdGhyb3cgbmV3IEVycm9yKCdDb3JlIGlzIGVtcHR5LicpCiAgICBpZiAoIWI0YS5pc0J1ZmZlcihibG9jaykpIHJldHVybiBpc0F1dG9iYXNlTWVzc2FnZShibG9jaykKCiAgICB0cnkgewogICAgICBjb25zdCBtID0gYy5kZWNvZGUobWVzc2FnZXMuT3Bsb2dNZXNzYWdlLCBibG9jaykKICAgICAgcmV0dXJuIGlzQXV0b2Jhc2VNZXNzYWdlKG0pCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICAvLyBubyBndWFyYW50ZWVzIHdoZXJlIHRoZSB1c2VyIGRhdGEgaXMgc3RvcmVkLCBqdXN0IHRoYXQgaXRzIGFzc29jaWF0ZWQgd2l0aCB0aGUgYmFzZQogIGFzeW5jIHNldFVzZXJEYXRhKGtleSwgdmFsKSB7CiAgICBhd2FpdCB0aGlzLl9wcmVvcGVuCiAgICBjb25zdCBjb3JlID0gdGhpcy5fcHJpbWFyeUJvb3RzdHJhcCA9PT0gbnVsbCA/IHRoaXMubG9jYWwgOiB0aGlzLl9wcmltYXJ5Qm9vdHN0cmFwCgogICAgYXdhaXQgY29yZS5zZXRVc2VyRGF0YShrZXksIHZhbCkKICB9CgogIGFzeW5jIGdldFVzZXJEYXRhKGtleSkgewogICAgYXdhaXQgdGhpcy5fcHJlb3BlbgogICAgY29uc3QgY29yZSA9IHRoaXMuX3ByaW1hcnlCb290c3RyYXAgPT09IG51bGwgPyB0aGlzLmxvY2FsIDogdGhpcy5fcHJpbWFyeUJvb3RzdHJhcAoKICAgIHJldHVybiBhd2FpdCBjb3JlLmdldFVzZXJEYXRhKGtleSkKICB9CgogIF9uZWVkc0xvY2FsV3JpdGVyKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxXcml0ZXIgPT09IG51bGwgfHwgdGhpcy5sb2NhbFdyaXRlci5jbG9zZWQKICB9CgogIC8vIG5vIGd1YXJhbnRlZXMgYWJvdXQgd3JpdGVyLmlzQWN0aXZlSW5kZXhlciBwcm9wZXJ0eSBoZXJlCiAgYXN5bmMgX2dldFdyaXRlckJ5S2V5KGtleSwgbGVuLCBzZWVuLCBhbGxvd0dDLCBpc0FkZGVkLCBzeXN0ZW0pIHsKICAgIGFzc2VydCh0aGlzLl9kcmFpbmluZyA9PT0gdHJ1ZSB8fCAodGhpcy5vcGVuaW5nICYmICF0aGlzLm9wZW5lZCkgfHwgdGhpcy5fb3B0aW1pc3RpYyA+IC0xKQoKICAgIGF3YWl0IHRoaXMuX2xvY2subG9jaygpCgogICAgaWYgKHRoaXMuX2ludGVycnVwdGluZykgewogICAgICB0aGlzLl9sb2NrLnVubG9jaygpCiAgICAgIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgaXMgY2xvc2luZycpCiAgICB9CgogICAgdHJ5IHsKICAgICAgbGV0IHcgPSB0aGlzLmFjdGl2ZVdyaXRlcnMuZ2V0KGtleSkKCiAgICAgIGNvbnN0IGFscmVhZHlBY3RpdmUgPSAhIXcKICAgICAgY29uc3Qgc3lzID0gc3lzdGVtIHx8IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtCiAgICAgIGNvbnN0IHdyaXRlckluZm8gPSBhd2FpdCBzeXMuZ2V0KGtleSkKCiAgICAgIGlmIChsZW4gPT09IC0xKSB7CiAgICAgICAgaWYgKCFhbGxvd0dDICYmIHdyaXRlckluZm8gPT09IG51bGwpIHsKICAgICAgICAgIGlmICh3KSB3LmlzUmVtb3ZlZCA9ICFpc0FkZGVkCiAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgIH0KCiAgICAgICAgbGVuID0gd3JpdGVySW5mbyA9PT0gbnVsbCA/IDAgOiB3cml0ZXJJbmZvLmxlbmd0aAogICAgICB9CgogICAgICBjb25zdCBpc0FjdGl2ZSA9IHdyaXRlckluZm8gIT09IG51bGwgJiYgKGlzQWRkZWQgfHwgIXdyaXRlckluZm8uaXNSZW1vdmVkKQogICAgICBjb25zdCBpc1JlbW92ZWQgPSAhaXNBY3RpdmUKCiAgICAgIGlmICh3KSB7CiAgICAgICAgdy5pc1JlbW92ZWQgPSBpc1JlbW92ZWQKICAgICAgfSBlbHNlIHsKICAgICAgICB3ID0gdGhpcy5fbWFrZVdyaXRlcihrZXksIGxlbiwgaXNBY3RpdmUsIGlzUmVtb3ZlZCkKICAgICAgICBpZiAoIXcpIHJldHVybiBudWxsCiAgICAgIH0KCiAgICAgIGlmIChpc1JlbW92ZWQgJiYgc3lzLmJvb3RzdHJhcHBpbmcgJiYgYjRhLmVxdWFscyh3LmNvcmUua2V5LCB0aGlzLmtleSkpIHsKICAgICAgICB3LmlzUmVtb3ZlZCA9IGZhbHNlCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9pc0xvY2FsQ29yZSh3LmNvcmUpICYmIHRoaXMuX25lZWRzTG9jYWxXcml0ZXIoKSkgewogICAgICAgIHRoaXMuX3NldExvY2FsV3JpdGVyKHcpCiAgICAgIH0KCiAgICAgIHcuc2VlbihzZWVuKQoKICAgICAgaWYgKGFscmVhZHlBY3RpdmUpIHJldHVybiB3CgogICAgICBhd2FpdCB3LnJlYWR5KCkKCiAgICAgIGlmICh0aGlzLl9pc0xvY2FsQ29yZSh3LmNvcmUpICYmIHRoaXMuX25lZWRzTG9jYWxXcml0ZXIoKSkgewogICAgICAgIHRoaXMuX3NldExvY2FsV3JpdGVyKHcpCiAgICAgIH0KCiAgICAgIGlmIChhbGxvd0dDICYmIHcuZmx1c2hlZCgpKSB7CiAgICAgICAgdGhpcy5fd2FrZXVwLnVucXVldWUoa2V5LCBsZW4pCiAgICAgICAgaWYgKHcgIT09IHRoaXMubG9jYWxXcml0ZXIpIHsKICAgICAgICAgIGF3YWl0IHcuY2xvc2UoKQogICAgICAgICAgcmV0dXJuIHcKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuYWN0aXZlV3JpdGVycy5hZGQodykKICAgICAgdGhpcy5fY2hlY2tXcml0ZXJzLnB1c2godykKCiAgICAgIGFzc2VydCh3Lm9wZW5lZCkKICAgICAgYXNzZXJ0KCF3LmNsb3NlZCkKCiAgICAgIHcudXBkYXRlQWN0aXZpdHkoKQogICAgICByZXR1cm4gdwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fbG9jay51bmxvY2soKQogICAgfQogIH0KCiAgX3VwZGF0ZUFsbCgpIHsKICAgIGNvbnN0IHAgPSBbXQogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuYWN0aXZlV3JpdGVycykgcC5wdXNoKHcudXBkYXRlKG51bGwpLmNhdGNoKHNhZmV0eUNhdGNoKSkKICAgIHJldHVybiBQcm9taXNlLmFsbChwKQogIH0KCiAgZ2V0V3JpdGVyRW5jcnlwdGlvbigpIHsKICAgIGlmICghdGhpcy5lbmNyeXB0aW9uS2V5KSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuZW5jcnlwdGlvbi5nZXRXcml0ZXJFbmNyeXB0aW9uKCkKICB9CgogIF9tYWtlV3JpdGVyQ29yZShrZXkpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignQXV0b2Jhc2UgaXMgY2xvc2luZycpCiAgICBpZiAodGhpcy5faW50ZXJydXB0aW5nKSB0aHJvdyBJTlRFUlJVUFQoKQoKICAgIGNvbnN0IGxvY2FsID0gYjRhLmVxdWFscyhrZXksIHRoaXMubG9jYWwua2V5KQogICAgY29uc3QgZW5jcnlwdGlvbiA9IHRoaXMuZ2V0V3JpdGVyRW5jcnlwdGlvbigpCgogICAgY29uc3QgY29yZSA9IGxvY2FsCiAgICAgID8gdGhpcy5sb2NhbC5zZXNzaW9uKHsgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLCBlbmNyeXB0aW9uLCBhY3RpdmU6IGZhbHNlIH0pCiAgICAgIDogdGhpcy5zdG9yZS5nZXQoewogICAgICAgICAga2V5LAogICAgICAgICAgY29tcGF0OiBmYWxzZSwKICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwKICAgICAgICAgIGVuY3J5cHRpb24sCiAgICAgICAgICBhY3RpdmU6IGZhbHNlCiAgICAgICAgfSkKCiAgICByZXR1cm4gY29yZQogIH0KCiAgX21ha2VXcml0ZXIoa2V5LCBsZW5ndGgsIGlzQWN0aXZlLCBpc1JlbW92ZWQpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9tYWtlV3JpdGVyQ29yZShrZXkpCiAgICBjb25zdCB3ID0gbmV3IFdyaXRlcih0aGlzLCBjb3JlLCBsZW5ndGgsIGlzUmVtb3ZlZCkKCiAgICBpZiAodGhpcy5faXNMb2NhbENvcmUoY29yZSkpIHsKICAgICAgaWYgKGlzQWN0aXZlKSB0aGlzLl9zZXRMb2NhbFdyaXRlcih3KSAvLyBvbmx5IHNldCBhY3RpdmUgd3JpdGVyCiAgICAgIHJldHVybiB3CiAgICB9CgogICAgY29yZS5vbignYXBwZW5kJywgdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2VCb3VuZCkKICAgIGNvcmUub24oJ2Rvd25sb2FkJywgdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2VCb3VuZCkKICAgIGNvcmUub24oJ21hbmlmZXN0JywgdGhpcy5fb25yZW1vdGV3cml0ZXJjaGFuZ2VCb3VuZCkKCiAgICByZXR1cm4gdwogIH0KCiAgX3VwZGF0ZUxpbmVhcml6ZXIoaW5kZXhlcnMsIGhlYWRzKSB7CiAgICAvLyBvbmx5IGN1cnJlbnQgYWN0aXZlIGluZGV4ZXJzIGFyZSByZXNldCB0byB0cnVlIGJlbG93CiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5hY3RpdmVXcml0ZXJzKSB3LmlzQWN0aXZlSW5kZXhlciA9IGZhbHNlCiAgICBpZiAodGhpcy5sb2NhbFdyaXRlcikgdGhpcy5sb2NhbFdyaXRlci5pc0FjdGl2ZUluZGV4ZXIgPSBmYWxzZQoKICAgIGZvciAoY29uc3Qgd3JpdGVyIG9mIGluZGV4ZXJzKSB3cml0ZXIuaXNBY3RpdmVJbmRleGVyID0gdHJ1ZQoKICAgIGlmICh0aGlzLl9pc0FjdGl2ZUluZGV4ZXIoKSAmJiAhdGhpcy5pc0luZGV4ZXIpIHsKICAgICAgdGhpcy5fc2V0TG9jYWxJbmRleGVyKCkKICAgIH0gZWxzZSBpZiAoIXRoaXMuX2lzQWN0aXZlSW5kZXhlcigpICYmIHRoaXMuaXNJbmRleGVyKSB7CiAgICAgIHRoaXMuX2NsZWFyTG9jYWxJbmRleGVyKCkKICAgIH0KCiAgICB0aGlzLmxpbmVhcml6ZXIgPSBuZXcgTGluZWFyaXplcihpbmRleGVycywgeyBoZWFkcywgd3JpdGVyczogdGhpcy5hY3RpdmVXcml0ZXJzIH0pCgogICAgdGhpcy5fdXBkYXRlQWNrVGhyZXNob2xkKCkKICB9CgogIGFzeW5jIF91cGRhdGVMb2NhbFdyaXRlcihzeXMpIHsKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsICYmICF0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleSh0aGlzLmxvY2FsLmtleSwgLTEsIDAsIHRydWUsIGZhbHNlLCBzeXMpCiAgfQoKICBhc3luYyBfYm9vdHN0cmFwTGluZWFyaXplcigpIHsKICAgIGNvbnN0IGJvb3RzdHJhcCA9IHRoaXMuX21ha2VXcml0ZXIodGhpcy5rZXksIDAsIHRydWUsIGZhbHNlKQoKICAgIHRoaXMuYWN0aXZlV3JpdGVycy5hZGQoYm9vdHN0cmFwKQogICAgdGhpcy5fY2hlY2tXcml0ZXJzLnB1c2goYm9vdHN0cmFwKQogICAgYXdhaXQgYm9vdHN0cmFwLnJlYWR5KCkKICAgIHRoaXMuX2Vuc3VyZVdha2V1cChib290c3RyYXApCgogICAgdGhpcy5fdXBkYXRlTGluZWFyaXplcihbYm9vdHN0cmFwXSwgW10pCiAgfQoKICBhc3luYyBfbWFrZUxpbmVhcml6ZXIoc3lzKSB7CiAgICBpZiAoc3lzID09PSBudWxsKSB7CiAgICAgIHJldHVybiB0aGlzLl9ib290c3RyYXBMaW5lYXJpemVyKCkKICAgIH0KCiAgICBpZiAodGhpcy5vcGVuZWQgfHwgKGF3YWl0IHN5cy5oYXNMb2NhbCh0aGlzLmxvY2FsLmtleSkpKSB7CiAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZUxvY2FsV3JpdGVyKHN5cykKICAgIH0KCiAgICBjb25zdCBpbmRleGVycyA9IFtdCgogICAgZm9yIChjb25zdCBoZWFkIG9mIHN5cy5pbmRleGVycykgewogICAgICBjb25zdCB3cml0ZXIgPSBhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleShoZWFkLmtleSwgaGVhZC5sZW5ndGgsIDAsIGZhbHNlLCBmYWxzZSwgc3lzKQogICAgICBpbmRleGVycy5wdXNoKHdyaXRlcikKICAgIH0KCiAgICBpZiAoIXRoaXMuX2lzQWN0aXZlSW5kZXhlcigpKSB7CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIHN5cy5wZW5kaW5nSW5kZXhlcnMpIHsKICAgICAgICBpZiAoYjRhLmVxdWFscyhrZXksIHRoaXMubG9jYWwua2V5KSkgewogICAgICAgICAgdGhpcy5fc2V0TG9jYWxJbmRleGVyKCkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdGhpcy5fdXBkYXRlTGluZWFyaXplcihpbmRleGVycywgc3lzLmhlYWRzKQoKICAgIGZvciAoY29uc3QgeyBrZXksIGxlbmd0aCB9IG9mIHN5cy5oZWFkcykgewogICAgICBhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleShrZXksIGxlbmd0aCwgMCwgZmFsc2UsIGZhbHNlLCBzeXMpCiAgICB9CiAgfQoKICBhc3luYyBfY2xlYXJXcml0ZXJzKCkgewogICAgYXdhaXQgdGhpcy5hY3RpdmVXcml0ZXJzLmNsZWFyKCkKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICE9PSBudWxsKSBhd2FpdCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlKCkKICAgIHRoaXMuX2NoZWNrV3JpdGVycyA9IFtdCiAgfQoKICBhc3luYyBfbWFrZUxpbmVhcml6ZXJGcm9tVmlld1N0YXRlKCkgewogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5nZXRJbmRleGVkU3lzdGVtKCkKICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyKHN5cykKICAgIGF3YWl0IHN5cy5jbG9zZSgpCiAgfQoKICBhc3luYyBfcnVuRm9yY2VGYXN0Rm9yd2FyZCgpIHsKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KICAgIGNvbnN0IHJlYyA9IHRoaXMuX2FwcGx5U3RhdGUgPyBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnJlY292ZXJBdCgpIDogbnVsbAogICAgYXdhaXQgdGhpcy5fcnVuRmFzdEZvcndhcmQoCiAgICAgIG5ldyBGYXN0Rm9yd2FyZCh0aGlzLCB0aGlzLmNvcmUua2V5LCB7IGZvcmNlOiB0cnVlLCBsZW5ndGg6IHJlYyA/IHJlYy5sZW5ndGggOiAwIH0pCiAgICApCiAgfQoKICAvLyBnZW5lcmFsIHJlcGFpciBtZXRob2QgZm9yIHRyeWluZyB0byByZWNvdmVyCiAgYXN5bmMgcmVwYWlyKCkgewogICAgYXdhaXQgdGhpcy5mb3JjZUZhc3RGb3J3YXJkKCkKICB9CgogIGFzeW5jIGZvcmNlRmFzdEZvcndhcmQoKSB7CiAgICBpZiAodGhpcy5pc0Zhc3RGb3J3YXJkaW5nKCkpIHJldHVybgogICAgYXdhaXQgdGhpcy5fcnVuRm9yY2VGYXN0Rm9yd2FyZCgpCiAgICBhd2FpdCB0aGlzLnVwZGF0ZSgpCiAgfQoKICBhc3luYyBfYXBwbHlGYXN0Rm9yd2FyZCgpIHsKICAgIGlmICgKICAgICAgIXRoaXMuZmFzdEZvcndhcmRUby5mb3JjZSAmJgogICAgICB0aGlzLmZhc3RGb3J3YXJkVG8ubGVuZ3RoIDwgdGhpcy5jb3JlLmxlbmd0aCArIHRoaXMuZmFzdEZvcndhcmRUby5taW5pbXVtCiAgICApIHsKICAgICAgdGhpcy5mYXN0Rm9yd2FyZFRvID0gbnVsbAogICAgICB0aGlzLl91cGRhdGVBY3Rpdml0eSgpCiAgICAgIC8vIHN0aWxsIG5vdCB3b3J0aCBpdAogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5faGFzVXBkYXRlID8gbmV3IFVwZGF0ZUNoYW5nZXModGhpcykgOiBudWxsCiAgICBpZiAoY2hhbmdlcykgY2hhbmdlcy50cmFjayh0aGlzLl9hcHBseVN0YXRlKQoKICAgIC8vIGNsb3NlIGV4aXN0aW5nIHN0YXRlCiAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZSkgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCgogICAgY29uc3QgeyBrZXksIGxlbmd0aCwgdmlld3MsIGluZGV4ZXJzLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHkgfSA9IHRoaXMuZmFzdEZvcndhcmRUbwoKICAgIGNvbnN0IGZyb20gPSB0aGlzLmNvcmUuc2lnbmVkTGVuZ3RoCiAgICBjb25zdCBmZmVkID0gbmV3IFNldCgpCgogICAgdGhpcy5fZmx1c2hpbmcrKwogICAgdHJ5IHsKICAgICAgY29uc3Qgc3RvcmUgPSB0aGlzLl92aWV3U3RvcmUuYXRvbWl6ZSgpCgogICAgICBjb25zdCBtaWdyYXRlZCA9ICFiNGEuZXF1YWxzKGtleSwgdGhpcy5jb3JlLmtleSkKCiAgICAgIGNvbnN0IHN5c3RlbVJlZiA9IGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5maW5kVmlld0J5S2V5KGtleSwgaW5kZXhlcnMsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSkKICAgICAgZmZlZC5hZGQoc3lzdGVtUmVmKQoKICAgICAgaWYgKG1pZ3JhdGVkKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlGYXN0Rm9yd2FyZE1pZ3JhdGlvbihzeXN0ZW1SZWYsIHsga2V5LCBsZW5ndGggfSkKICAgICAgfSBlbHNlIHsKICAgICAgICBhd2FpdCBzeXN0ZW1SZWYuY2F0Y2h1cChzdG9yZS5hdG9tLCBsZW5ndGgpCiAgICAgIH0KCiAgICAgIGZvciAoY29uc3QgdiBvZiB2aWV3cykgewogICAgICAgIGNvbnN0IHJlZiA9IGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5maW5kVmlld0J5S2V5KHYua2V5LCBpbmRleGVycywgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5KQogICAgICAgIGlmICghcmVmKSBjb250aW51ZSAvLyB1bmtub3duLCB2aWV3IGlnbm9yZWQKICAgICAgICBmZmVkLmFkZChyZWYpCgogICAgICAgIGlmIChtaWdyYXRlZCkgewogICAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlGYXN0Rm9yd2FyZE1pZ3JhdGlvbihyZWYsIHYpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGF3YWl0IHJlZi5jYXRjaHVwKHN0b3JlLmF0b20sIHYubGVuZ3RoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGZmZWQuc2l6ZSAhPT0gc3RvcmUuZ2V0Vmlld0NvdW50KCkpIHsKICAgICAgICBmb3IgKGNvbnN0IHJlZiBvZiBzdG9yZS5nZXRWaWV3cygpKSB7CiAgICAgICAgICBpZiAoZmZlZC5oYXMocmVmKSkgY29udGludWUKICAgICAgICAgIGF3YWl0IHJlZi5jYXRjaHVwKHN0b3JlLmF0b20sIDApIC8vIGl0cyBnb25lCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBtaWdyYXRlIHplcm8gbGVuZ3RoIGNvcmVzCiAgICAgIGlmIChtaWdyYXRlZCkgewogICAgICAgIGNvbnN0IG1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuX3ZpZXdTdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKGluZGV4ZXJzKQoKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCByZWZdIG9mIHRoaXMuX3ZpZXdTdG9yZS5ieU5hbWUpIHsKICAgICAgICAgIGlmIChmZmVkLmhhcyhyZWYpKSBjb250aW51ZQogICAgICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZVZpZXcobWFuaWZlc3RzLCBudWxsLCBuYW1lLCAwLCBtYW5pZmVzdFZlcnNpb24sIGVudHJvcHksIFtdLCBudWxsKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdmFsdWUgPSBjLmVuY29kZShtZXNzYWdlcy5Cb290UmVjb3JkLCB7CiAgICAgICAgdmVyc2lvbjogQk9PVF9SRUNPUkRfVkVSU0lPTiwKICAgICAgICBrZXksCiAgICAgICAgc3lzdGVtTGVuZ3RoOiBsZW5ndGgsCiAgICAgICAgaW5kZXhlcnNVcGRhdGVkOiBmYWxzZSwKICAgICAgICBmYXN0Rm9yd2FyZGluZzogdHJ1ZSwKICAgICAgICByZWNvdmVyaWVzOiBSRUNPVkVSSUVTCiAgICAgIH0pCgogICAgICBjb25zdCBsb2NhbCA9IHN0b3JlLmdldExvY2FsKCkKICAgICAgYXdhaXQgbG9jYWwucmVhZHkoKQogICAgICBhd2FpdCBsb2NhbC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcsIHZhbHVlKQoKICAgICAgYXdhaXQgTG9jYWxTdGF0ZS5jbGVhcihsb2NhbCkKCiAgICAgIGlmIChjaGFuZ2VzKSBjaGFuZ2VzLmZpbmFsaXNlKCkKCiAgICAgIGF3YWl0IHN0b3JlLmZsdXNoKCkKICAgICAgYXdhaXQgc3RvcmUuY2xvc2UoKQogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKC0tdGhpcy5fZmx1c2hpbmcgPT09IDApIHRoaXMuX2ZsdXNoU2lnbmFsLm5vdGlmeSgpCiAgICB9CgogICAgY29uc3QgdG8gPSB0aGlzLmNvcmUuc2lnbmVkTGVuZ3RoCgogICAgZm9yIChjb25zdCByZWYgb2YgZmZlZCkgYXdhaXQgcmVmLnJlbGVhc2UoKQoKICAgIHRoaXMucmVjb3ZlcmllcyA9IFJFQ09WRVJJRVMKICAgIHRoaXMuZmFzdEZvcndhcmRUbyA9IG51bGwKICAgIHRoaXMuX3F1ZXVlRmFzdEZvcndhcmQoKQoKICAgIGF3YWl0IHRoaXMuX2NsZWFyV3JpdGVycygpCgogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG5ldyBBcHBseVN0YXRlKHRoaXMpCiAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnJlYWR5KCkKCiAgICBpZiAoY2hhbmdlcykgYXdhaXQgdGhpcy5faGFuZGxlcnMudXBkYXRlKHRoaXMuX2FwcGx5U3RhdGUudmlldywgY2hhbmdlcykKCiAgICBpZiAoYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5zaG91bGRNaWdyYXRlKCkpIHsKICAgICAgYXdhaXQgdGhpcy5fbWlncmF0ZSgpCiAgICB9IGVsc2UgewogICAgICBhd2FpdCB0aGlzLl9tYWtlTGluZWFyaXplckZyb21WaWV3U3RhdGUoKQogICAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNhdGNodXAodGhpcy5saW5lYXJpemVyKQogICAgfQoKICAgIGlmICghdGhpcy5sb2NhbFdyaXRlciB8fCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgewogICAgICBhd2FpdCB0aGlzLl91cGRhdGVMb2NhbFdyaXRlcih0aGlzLl9hcHBseVN0YXRlLnN5c3RlbSkKICAgIH0KCiAgICB0aGlzLl9jYXVnaHR1cCA9IHRydWUKCiAgICB0aGlzLl9yZWJvb3RlZCgpCiAgICB0aGlzLmVtaXQoJ2Zhc3QtZm9yd2FyZCcsIHRvLCBmcm9tKQogIH0KCiAgLy8gVE9ETzogbm90IGF0b21pYyBpbiByZWdhcmRzIHRvIHRoZSBmZiwgZml4IHRoYXQKICBhc3luYyBfYXBwbHlGYXN0Rm9yd2FyZE1pZ3JhdGlvbihyZWYsIHYpIHsKICAgIGNvbnN0IG5leHQgPSB0aGlzLnN0b3JlLmdldCh2LmtleSkKICAgIGF3YWl0IG5leHQucmVhZHkoKQoKICAgIGNvbnN0IHByb2xvZ3VlID0gbmV4dC5tYW5pZmVzdCAmJiBuZXh0Lm1hbmlmZXN0LnByb2xvZ3VlCgogICAgaWYgKHByb2xvZ3VlICYmIHByb2xvZ3VlLmxlbmd0aCA+IDAgJiYgcmVmLmNvcmUubGVuZ3RoID49IHByb2xvZ3VlLmxlbmd0aCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IG5leHQuY29yZS5jb3B5UHJvbG9ndWUocmVmLmNvcmUuc3RhdGUpCiAgICAgIH0gY2F0Y2ggewogICAgICAgIC8vIHdlIG1pZ2h0IGJlIG1pc3Npbmcgc29tZSBub2RlcyBmb3IgdGhpcywganVzdCBpZ25vcmUsIG9ubHkgYW4gb3B0aW1pc2F0aW9uCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBiYXRjaCA9IG5leHQuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcsIG92ZXJ3cml0ZTogdHJ1ZSwgY2hlY2tvdXQ6IHYubGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgLy8gcmVtYWtlIHRoZSBiYXRjaCwgcmVzZXQgZnJvbSBvdXIgcHJvbG9ndWUgaW4gY2FzZSBpdCByZXBsaWNhdGVkIGluYmV0d2VlbgogICAgLy8gVE9ETzogd2Ugc2hvdWxkIHJlYWxseSBoYXZlIGFuIEhDIGZ1bmN0aW9uIGZvciB0aGlzCgogICAgYXdhaXQgcmVmLmJhdGNoLnN0YXRlLm1vdmVUbyhiYXRjaCwgYmF0Y2gubGVuZ3RoKQogICAgYXdhaXQgYmF0Y2guY2xvc2UoKQoKICAgIHJlZi5taWdyYXRlZCh0aGlzLCBuZXh0KQogIH0KCiAgYXN5bmMgX21pZ3JhdGVWaWV3KAogICAgaW5kZXhlck1hbmlmZXN0cywKICAgIHNvdXJjZSwKICAgIG5hbWUsCiAgICBpbmRleGVkTGVuZ3RoLAogICAgbWFuaWZlc3RWZXJzaW9uLAogICAgZW50cm9weSwKICAgIGxpbmtlZCwKICAgIG1hbmlmZXN0RGF0YQogICkgewogICAgY29uc3QgcmVmID0gdGhpcy5fdmlld1N0b3JlLmJ5TmFtZS5nZXQobmFtZSkKCiAgICBjb25zdCBwcm9sb2d1ZSA9CiAgICAgIGluZGV4ZWRMZW5ndGggPT09IDAKICAgICAgICA/IG51bGwKICAgICAgICA6IHsgbGVuZ3RoOiBpbmRleGVkTGVuZ3RoLCBoYXNoOiBhd2FpdCBzb3VyY2UudHJlZUhhc2goaW5kZXhlZExlbmd0aCkgfQoKICAgIGlmIChtYW5pZmVzdERhdGEgPT09IG51bGwgJiYgcmVmLmNvcmUubWFuaWZlc3QudXNlckRhdGEgIT09IG51bGwpIHsKICAgICAgbWFuaWZlc3REYXRhID0gcmVmLmNvcmUubWFuaWZlc3QudXNlckRhdGEKICAgIH0KCiAgICBjb25zdCBuZXh0ID0gdGhpcy5fdmlld1N0b3JlLmdldFZpZXdDb3JlKAogICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICBuYW1lLAogICAgICBwcm9sb2d1ZSwKICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICBlbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQogICAgYXdhaXQgbmV4dC5yZWFkeSgpCgogICAgaWYgKGluZGV4ZWRMZW5ndGggPiAwKSB7CiAgICAgIGF3YWl0IG5leHQuY29yZS5jb3B5UHJvbG9ndWUoc291cmNlLnN0YXRlKQogICAgfQoKICAgIC8vIHJlbWFrZSB0aGUgYmF0Y2gsIHJlc2V0IGZyb20gb3VyIHByb2xvZ3VlIGluIGNhc2UgaXQgcmVwbGljYXRlZCBpbmJldHdlZW4KICAgIC8vIFRPRE86IHdlIHNob3VsZCByZWFsbHkgaGF2ZSBhbiBIQyBmdW5jdGlvbiBmb3IgdGhpcwogICAgY29uc3QgYmF0Y2ggPSBuZXh0LnNlc3Npb24oeyBuYW1lOiAnYmF0Y2gnLCBvdmVyd3JpdGU6IHRydWUsIGNoZWNrb3V0OiBpbmRleGVkTGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgaWYgKHNvdXJjZSAhPT0gbnVsbCkgewogICAgICB3aGlsZSAoYmF0Y2gubGVuZ3RoIDwgc291cmNlLmxlbmd0aCkgewogICAgICAgIGF3YWl0IGJhdGNoLmFwcGVuZChhd2FpdCBzb3VyY2UuZ2V0KGJhdGNoLmxlbmd0aCkpCiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCByZWYuYmF0Y2guc3RhdGUubW92ZVRvKGJhdGNoLCBiYXRjaC5sZW5ndGgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCgogICAgcmVmLm1pZ3JhdGVkKHRoaXMsIG5leHQpCgogICAgcmV0dXJuIHJlZgogIH0KCiAgYXN5bmMgX3ByZW1pZ3JhdGUoKSB7CiAgICB0aGlzLl9mbHVzaGluZysrCiAgICB0cnkgewogICAgICBjb25zdCBsZW5ndGggPSB0aGlzLl9hcHBseVN0YXRlLmluZGV4ZWRMZW5ndGgKICAgICAgY29uc3Qgc3lzdGVtID0gdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0KCiAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCBzeXN0ZW0uZ2V0SW5kZXhlZEluZm8obGVuZ3RoKQogICAgICBjb25zdCBpbmRleGVyTWFuaWZlc3RzID0gYXdhaXQgdGhpcy5fdmlld1N0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHMoaW5mby5pbmRleGVycykKCiAgICAgIGNvbnN0IHsgdmlld3MsIHN5c3RlbVZpZXcsIGVuY3J5cHRpb25WaWV3IH0gPSB0aGlzLl9hcHBseVN0YXRlCgogICAgICBjb25zdCBtYW5pZmVzdFZlcnNpb24gPSB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnZlcnNpb24KCiAgICAgIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykgewogICAgICAgIGNvbnN0IHYgPSB0aGlzLl9hcHBseVN0YXRlLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcsIGluZm8pCiAgICAgICAgY29uc3QgaW5kZXhlZExlbmd0aCA9IHYgPyB2Lmxlbmd0aCA6IDAKCiAgICAgICAgY29uc3QgcmVmID0gdGhpcy5fdmlld1N0b3JlLmdldFZpZXdCeU5hbWUodmlldy5uYW1lKQogICAgICAgIGNvbnN0IHNvdXJjZSA9IHJlZi5nZXRDb3JlKCkKICAgICAgICBhd2FpdCBzb3VyY2UucmVhZHkoKQoKICAgICAgICBhd2FpdCB0aGlzLl9taWdyYXRlVmlldygKICAgICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgICBzb3VyY2UsCiAgICAgICAgICB2aWV3Lm5hbWUsCiAgICAgICAgICBpbmRleGVkTGVuZ3RoLAogICAgICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICAgICAgaW5mby5lbnRyb3B5LAogICAgICAgICAgbnVsbCwKICAgICAgICAgIG51bGwKICAgICAgICApCiAgICAgIH0KCiAgICAgIGNvbnN0IHNvdXJjZSA9IGVuY3J5cHRpb25WaWV3LnJlZi5nZXRDb3JlKCkKICAgICAgYXdhaXQgc291cmNlLnJlYWR5KCkKCiAgICAgIGNvbnN0IGVuYyA9IGF3YWl0IHRoaXMuX21pZ3JhdGVWaWV3KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgc291cmNlLAogICAgICAgICdfZW5jcnlwdGlvbicsCiAgICAgICAgaW5mby5lbmNyeXB0aW9uTGVuZ3RoLAogICAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgICBpbmZvLmVudHJvcHksCiAgICAgICAgbnVsbCwKICAgICAgICBudWxsCiAgICAgICkKCiAgICAgIGNvbnN0IGxpbmtlZCA9IFtlbmMuY29yZS5rZXldCgogICAgICBjb25zdCBzeXNDb3JlID0gc3lzdGVtVmlldy5yZWYuZ2V0Q29yZSgpCiAgICAgIGNvbnN0IHJlZiA9IGF3YWl0IHRoaXMuX21pZ3JhdGVWaWV3KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgc3lzQ29yZSwKICAgICAgICAnX3N5c3RlbScsCiAgICAgICAgbGVuZ3RoLAogICAgICAgIG1hbmlmZXN0VmVyc2lvbiwKICAgICAgICBpbmZvLmVudHJvcHksCiAgICAgICAgbGlua2VkLAogICAgICAgIG51bGwsCiAgICAgICAgbnVsbAogICAgICApCgogICAgICByZXR1cm4gcmVmLmNvcmUua2V5CiAgICB9IGZpbmFsbHkgewogICAgICBpZiAoLS10aGlzLl9mbHVzaGluZyA9PT0gMCkgdGhpcy5fZmx1c2hTaWduYWwubm90aWZ5KCkKICAgIH0KICB9CgogIGFzeW5jIF9taWdyYXRlKCkgewogICAgcmV0dXJuIHRoaXMuX3JlYm9vdChhd2FpdCB0aGlzLl9wcmVtaWdyYXRlKCkpCiAgfQoKICBhc3luYyBfcmVib290KGtleSkgewogICAgYXdhaXQgdGhpcy5fY2xlYXJXcml0ZXJzKCkKICAgIGF3YWl0IHRoaXMuX21ha2VMaW5lYXJpemVyRnJvbVZpZXdTdGF0ZSgpCgogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5maW5hbGl6ZShrZXkpCgogICAgdGhpcy5fYXBwbHlTdGF0ZSA9IG5ldyBBcHBseVN0YXRlKHRoaXMpCgogICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLmNhdGNodXAodGhpcy5saW5lYXJpemVyKQoKICAgIC8vIGVuZCBzb2Z0IHNodXRkb3duCgogICAgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCgogICAgdGhpcy5fcmVib290ZWQoKQogIH0KCiAgX3JlYm9vdGVkKCkgewogICAgdGhpcy5yZWNvdXBsZSgpCiAgICB0aGlzLl91cGRhdGVBY3Rpdml0eSgpCgogICAgdGhpcy5lbWl0KCdyZWJvb3QnKQoKICAgIC8vIGVuc3VyZSB3ZSByZS1ldmFsdXRlIG91ciBzdGF0ZQogICAgdGhpcy5fYm9vdHN0cmFwV3JpdGVyc0NoYW5nZWQgPSB0cnVlCiAgICB0aGlzLl9uZWVkc1dha2V1cCA9IHRydWUKCiAgICB0aGlzLnVwZGF0aW5nID0gdHJ1ZQogICAgdGhpcy5fcXVldWVCdW1wKCkKICB9CgogIF9zZXRMb2NhbFdyaXRlcih3KSB7CiAgICB0aGlzLmxvY2FsV3JpdGVyID0gdwogICAgaWYgKHRoaXMuX2Fja0ludGVydmFsKSB0aGlzLl9zdGFydEFja1RpbWVyKCkKICB9CgogIF91bnNldExvY2FsV3JpdGVyKCkgewogICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyKSByZXR1cm4KCiAgICB0aGlzLl9jbG9zZVdyaXRlcih0aGlzLmxvY2FsV3JpdGVyKQogICAgaWYgKHRoaXMubG9jYWxXcml0ZXIuaXNBY3RpdmVJbmRleGVyKSB0aGlzLl9jbGVhckxvY2FsSW5kZXhlcigpCgogICAgdGhpcy5sb2NhbFdyaXRlciA9IG51bGwKICB9CgogIF9zZXRMb2NhbEluZGV4ZXIoKSB7CiAgICBhc3NlcnQodGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCkKCiAgICB0aGlzLmlzSW5kZXhlciA9IHRydWUKICAgIHRoaXMuZW1pdCgnaXMtaW5kZXhlcicpCiAgfQoKICBfY2xlYXJMb2NhbEluZGV4ZXIoKSB7CiAgICBhc3NlcnQodGhpcy5sb2NhbFdyaXRlciAhPT0gbnVsbCkKCiAgICBpZiAodGhpcy5fYWNrVGltZXIpIHRoaXMuX2Fja1RpbWVyLnN0b3AoKQoKICAgIHRoaXMuaXNJbmRleGVyID0gZmFsc2UKICAgIHRoaXMuX2Fja1RpbWVyID0gbnVsbAoKICAgIHRoaXMuZW1pdCgnaXMtbm9uLWluZGV4ZXInKQogIH0KCiAgX2lzTG9jYWxDb3JlKGNvcmUpIHsKICAgIHJldHVybiBjb3JlLndyaXRhYmxlICYmIGNvcmUuaWQgPT09IHRoaXMubG9jYWwuaWQKICB9CgogIF9hZGRMb2NhbEhlYWRzKCkgewogICAgLy8gbm90IHdyaXRhYmxlIGF0bSwgd2lsbCBwcm9wIGJlIHdyaXRhYmxlIGluIGEgc3Vic2VxdWVudCBidW1wIHRobwogICAgaWYgKCF0aGlzLmxvY2FsV3JpdGVyIHx8IHRoaXMubG9jYWxXcml0ZXIuY2xvc2VkKSByZXR1cm4gbnVsbAogICAgLy8gc2FmZXR5LCBsb2NhbHdyaXRlciBpcyBzdGlsbCBwcm9jZXNzaW5nLCBzaG91bGQgcHJvcCBiZSBhbiBhc3NlcnRpb24KICAgIGlmICghdGhpcy5sb2NhbFdyaXRlci5pZGxlKCkpIHJldHVybiBudWxsCgogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fb3B0aW1pc3RpYyA9PT0gLTEgPyB0aGlzLl9hcHBlbmRpbmcubGVuZ3RoIDogdGhpcy5fb3B0aW1pc3RpYyB8fCAxCgogICAgY29uc3Qgbm9kZXMgPSBuZXcgQXJyYXkobGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBoZWFkcyA9IHRoaXMubGluZWFyaXplci5nZXRIZWFkcygpCiAgICAgIGNvbnN0IGRlcHMgPSBuZXcgU2V0KHRoaXMubGluZWFyaXplci5oZWFkcykKICAgICAgY29uc3QgYmF0Y2ggPSBsZW5ndGggLSBpCiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fYXBwZW5kaW5nW2ldCgogICAgICBjb25zdCBub2RlID0gdGhpcy5sb2NhbFdyaXRlci5hcHBlbmQodmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwcywgdGhpcy5fb3B0aW1pc3RpYyA9PT0gMCkKCiAgICAgIHRoaXMubGluZWFyaXplci5hZGRIZWFkKG5vZGUpCiAgICAgIG5vZGVzW2ldID0gbm9kZQogICAgfQoKICAgIHJldHVybiBub2RlcwogIH0KCiAgX2ZsdXNoTG9jYWxIZWFkcyhsZW5ndGgpIHsKICAgIHRoaXMuX2FwcGVuZGluZyA9IGxlbmd0aCA9PT0gdGhpcy5fYXBwZW5kaW5nLmxlbmd0aCA/IG51bGwgOiB0aGlzLl9hcHBlbmRpbmcuc2xpY2UobGVuZ3RoKQogICAgdGhpcy5fYXBwZW5kZWQgKz0gbGVuZ3RoCgogICAgaWYgKHRoaXMuX29wdGltaXN0aWMgPiAtMSAmJiB0aGlzLl9vcHRpbWlzdGljIDwgbGVuZ3RoKSB0aGlzLl9vcHRpbWlzdGljID0gLTEKICB9CgogIGFzeW5jIF9hZGRSZW1vdGVIZWFkcygpIHsKICAgIGxldCBhZGRlZCA9IDAKCiAgICB3aGlsZSAoCiAgICAgIGFkZGVkIDwgUkVNT1RFX0FERF9CQVRDSCB8fAogICAgICAodGhpcy5iaWdCYXRjaGVzICYmICF0aGlzLl9pbmRleGVyc0lkbGUoKSAmJiBhZGRlZCA8IFJFTU9URV9BRERfQkFUQ0hfU0FOSVRZKQogICAgKSB7CiAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZUFsbCgpCgogICAgICBsZXQgYWR2YW5jZWQgPSAwCgogICAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5hY3RpdmVXcml0ZXJzKSB7CiAgICAgICAgbGV0IG5vZGUgPSB3LmFkdmFuY2UoKQogICAgICAgIGlmIChub2RlID09PSBudWxsKSBjb250aW51ZQoKICAgICAgICBhZHZhbmNlZCArPSBub2RlLmJhdGNoCgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICB0aGlzLmxpbmVhcml6ZXIuYWRkSGVhZChub2RlKQogICAgICAgICAgaWYgKG5vZGUuYmF0Y2ggPT09IDEpIGJyZWFrCiAgICAgICAgICBub2RlID0gdy5hZHZhbmNlKCkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChhZHZhbmNlZCA9PT0gMCkgewogICAgICAgIGlmICh0aGlzLmJpZ0JhdGNoZXMgJiYgIXRoaXMuX2luZGV4ZXJzSWRsZSgpICYmIChhd2FpdCB0aGlzLl93YWl0Rm9ySW5kZXhlcnMoKSkpIGNvbnRpbnVlCiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgYWRkZWQgKz0gYWR2YW5jZWQKICAgIH0KCiAgICByZXR1cm4gYWRkZWQKICB9CgogIGFzeW5jIF93YWl0Rm9ySW5kZXhlcnMoKSB7CiAgICBjb25zdCBwcm9taXNlcyA9IFtdCgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMubGluZWFyaXplci5pbmRleGVycykgewogICAgICBpZiAody5pZGxlKCkpIGNvbnRpbnVlCiAgICAgIGlmIChhd2FpdCB3LmNvcmUuaGFzKHcubGVuZ3RoKSkgY29udGludWUKICAgICAgcHJvbWlzZXMucHVzaCh3LmNvcmUuZ2V0KHcubGVuZ3RoLCB7IHRpbWVvdXQ6IDMwMDAgfSkpCiAgICB9CgogICAgZm9yIChjb25zdCByZXN1bHQgb2YgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHByb21pc2VzKSkgewogICAgICBpZiAocmVzdWx0LnN0YXR1cyAhPT0gJ3JlamVjdGVkJykgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9pbmRleGVyc0lkbGUoKSB7CiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5saW5lYXJpemVyLmluZGV4ZXJzKSB7CiAgICAgIGlmICghdy5pZGxlKCkpIHJldHVybiBmYWxzZQogICAgfQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF9kcmFpbigpIHsKICAgIGNvbnN0IHdyaXRhYmxlID0gdGhpcy53cml0YWJsZQoKICAgIHdoaWxlICghdGhpcy5faW50ZXJydXB0aW5nICYmICF0aGlzLnBhdXNlZCkgewogICAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZFRvICE9PSBudWxsKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fYXBwbHlGYXN0Rm9yd2FyZCgpCiAgICAgICAgY29udGludWUgLy8gcmV2YWx1YXRlIGNvbmRpdGlvbnMuLi4KICAgICAgfQoKICAgICAgLy8gd2UgZGVmZXIgdGhpcyB0byBwb3N0IHJlYWR5IHNvIGl0cyBub3QgYmxvY2tpbmcgcmVhZGluZyB0aGUgdmlld3MKICAgICAgaWYgKHRoaXMuX2NhdWdodHVwID09PSBmYWxzZSkgewogICAgICAgIC8vIGlmIHRoZSBjYXRjaHVwIGZhaWxzLCBqdXN0IGZvcmNlIGZmIGl0IHRvIHJlY292ZXIsIGxlc3MgdXNlciBwYWluCiAgICAgICAgaWYgKCEoYXdhaXQgdGhpcy5fY2F0Y2h1cEFwcGx5U3RhdGUoKSkpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX3J1bkZvcmNlRmFzdEZvcndhcmQoKQogICAgICAgIH0KICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCByZW1vdGVBZGRlZCA9IGF3YWl0IHRoaXMuX2FkZFJlbW90ZUhlYWRzKCkKICAgICAgY29uc3QgbG9jYWxOb2RlcyA9IHRoaXMuX2FwcGVuZGluZyAhPT0gbnVsbCA/IHRoaXMuX2FkZExvY2FsSGVhZHMoKSA6IG51bGwKCiAgICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgoKICAgICAgaWYgKHJlbW90ZUFkZGVkID4gMCB8fCBsb2NhbE5vZGVzICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy51cGRhdGluZyA9IHRydWUKICAgICAgfQoKICAgICAgY29uc3QgdSA9IHRoaXMubGluZWFyaXplci51cGRhdGUoKQogICAgICBjb25zdCB1cGRhdGUgPSB1CiAgICAgICAgPyBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnVwZGF0ZSh1LCBsb2NhbE5vZGVzKQogICAgICAgIDogeyByZWJvb3Q6IGZhbHNlLCBtaWdyYXRlZDogZmFsc2UgfQoKICAgICAgaWYgKGxvY2FsTm9kZXMpIHRoaXMuX2ZsdXNoTG9jYWxIZWFkcyhsb2NhbE5vZGVzLmxlbmd0aCkKCiAgICAgIGlmICghdXBkYXRlLnJlYm9vdCkgewogICAgICAgIGlmICh0aGlzLl9hcHBseVN0YXRlLnNob3VsZEZsdXNoKCkpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuZmx1c2goKQogICAgICAgICAgdGhpcy51cGRhdGluZyA9IHRydWUKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9jaGVja1dyaXRlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgYXdhaXQgdGhpcy5fZ2NXcml0ZXJzKCkKICAgICAgICAgIGNvbnRpbnVlIC8vIHJlcnVuIHRoZSB1cGRhdGUgbG9vcCBhcyBhIHdyaXRlciBtaWdodCBoYXZlIGJlZW4gYWRkZWQKICAgICAgICB9CiAgICAgICAgaWYgKHJlbW90ZUFkZGVkID49IFJFTU9URV9BRERfQkFUQ0gpIGNvbnRpbnVlCiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgYXdhaXQgdGhpcy5fZ2NXcml0ZXJzKCkKICAgICAgYXdhaXQgdGhpcy5fcmVib290KHRoaXMuX2FwcGx5U3RhdGUua2V5KQogICAgfQoKICAgIC8vIGVtaXQgc3RhdGUgY2hhbmdlcyBwb3N0IGRyYWluCiAgICBpZiAod3JpdGFibGUgIT09IHRoaXMud3JpdGFibGUpIHsKICAgICAgaWYgKHRoaXMud3JpdGFibGUgJiYgdGhpcy5fd3JpdGFibGUpIHRoaXMuX3dyaXRhYmxlLnJlc29sdmUodHJ1ZSkKICAgICAgdGhpcy5lbWl0KHdyaXRhYmxlID8gJ3Vud3JpdGFibGUnIDogJ3dyaXRhYmxlJykKICAgIH0KICB9CgogIF93YWtldXBQZWVyKHN0cmVhbSkgewogICAgaWYgKCF0aGlzLndha2V1cFNlc3Npb24pIHJldHVybgogICAgY29uc3Qgd2FrZXVwID0gdGhpcy5fZ2V0V2FrZXVwKCkKICAgIGlmICh3YWtldXAubGVuZ3RoID09PSAwKSByZXR1cm4KICAgIHRoaXMud2FrZXVwU2Vzc2lvbi5hbm5vdW5jZUJ5U3RyZWFtKHN0cmVhbSwgd2FrZXVwKQogIH0KCiAgX2dldFdha2V1cCgpIHsKICAgIGNvbnN0IHdyaXRlcnMgPSBbXQoKICAgIGZvciAoY29uc3QgdyBvZiB0aGlzLmFjdGl2ZVdyaXRlcnMpIHsKICAgICAgaWYgKHcuaXNBY3RpdmVJbmRleGVyIHx8IHcuZmx1c2hlZCgpKSBjb250aW51ZQogICAgICB3cml0ZXJzLnB1c2goeyBrZXk6IHcuY29yZS5rZXksIGxlbmd0aDogdy5sZW5ndGggfSkKICAgIH0KCiAgICByZXR1cm4gd3JpdGVycwogIH0KCiAgYXN5bmMgX3dha2V1cFdyaXRlcihrZXksIGxlbmd0aCkgewogICAgdGhpcy5fZW5zdXJlV2FrZXVwKGF3YWl0IHRoaXMuX2dldFdyaXRlckJ5S2V5KGtleSwgLTEsIGxlbmd0aCwgdHJ1ZSwgZmFsc2UsIG51bGwpKQogIH0KCiAgLy8gZW5zdXJlIHdha2V1cCBvbiBhbiBleGlzdGluZyB3cml0ZXIgKHRoZSB3cml0ZXIgY2FsbHMgdGhpcyBpbiBhZGRpdGlvbiB0byBhYm92ZSkKICBfZW5zdXJlV2FrZXVwKHcpIHsKICAgIGlmICh3ID09PSBudWxsIHx8IHcuaXNCb290c3RyYXAgPT09IHRydWUpIHJldHVybgogICAgdy5zZXRCb290c3RyYXAodHJ1ZSkgLy8gZXZlbiBpZiB0dXJuIGZhbHNlIGF0IGVuZCBvZiBkcmFpbiwgaHlwZXJjb3JlIG1ha2VzIHRoZW0gbGluZ2VyIGEgYml0IHNvIG5vIGNodXJuCiAgICB0aGlzLl9ib290c3RyYXBXcml0ZXJzLnB1c2godykKICAgIHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnNDaGFuZ2VkID0gdHJ1ZQogIH0KCiAgYXN5bmMgX2RyYWluV2FrZXVwKCkgewogICAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICAgIC8vIHdhcm11cCBhbGwgdGhlIGJlbG93IGdldHMKICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cCkgewogICAgICBmb3IgKGNvbnN0IHsga2V5LCBsZW5ndGggfSBvZiB0aGlzLl93YWtldXApIHsKICAgICAgICBjb25zdCB3ID0gdGhpcy5hY3RpdmVXcml0ZXJzLmdldChrZXkpCiAgICAgICAgaWYgKHcpIHsKICAgICAgICAgIGlmICh3Lmxlbmd0aCA8IGxlbmd0aCkgdy5zZWVuKGxlbmd0aCkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICAgIHByb21pc2VzLnB1c2godGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uZ2V0KGtleSkpCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cEhlYWRzKSB7CiAgICAgICAgZm9yIChjb25zdCB7IGtleSB9IG9mIGF3YWl0IHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtLmhlYWRzKSB7CiAgICAgICAgICBpZiAodGhpcy5hY3RpdmVXcml0ZXJzLmhhcyhrZXkpKSBjb250aW51ZQogICAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXQoa2V5KSkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgW2hleCwgbGVuZ3RoXSBvZiB0aGlzLl93YWtldXBIaW50cykgewogICAgICBjb25zdCBrZXkgPSBiNGEuZnJvbShoZXgsICdoZXgnKQogICAgICBpZiAobGVuZ3RoICE9PSAtMSkgewogICAgICAgIGNvbnN0IHcgPSB0aGlzLmFjdGl2ZVdyaXRlcnMuZ2V0KGtleSkKICAgICAgICBpZiAodykgewogICAgICAgICAgaWYgKHcubGVuZ3RoIDwgbGVuZ3RoKSB3LnNlZW4obGVuZ3RoKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXQoa2V5KSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocHJvbWlzZXMpCgogICAgaWYgKHRoaXMuX25lZWRzV2FrZXVwID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX25lZWRzV2FrZXVwID0gZmFsc2UKCiAgICAgIGZvciAoY29uc3QgeyBrZXksIGxlbmd0aCB9IG9mIHRoaXMuX3dha2V1cCkgewogICAgICAgIGlmICh0aGlzLmFjdGl2ZVdyaXRlcnMuaGFzKGtleSkpIGNvbnRpbnVlCiAgICAgICAgYXdhaXQgdGhpcy5fd2FrZXVwV3JpdGVyKGtleSwgbGVuZ3RoKQogICAgICB9CgogICAgICBpZiAodGhpcy5fbmVlZHNXYWtldXBIZWFkcyA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuX25lZWRzV2FrZXVwSGVhZHMgPSBmYWxzZQoKICAgICAgICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5zeXN0ZW0uaGVhZHMpIHsKICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVdyaXRlcnMuaGFzKGtleSkpIGNvbnRpbnVlCiAgICAgICAgICBhd2FpdCB0aGlzLl93YWtldXBXcml0ZXIoa2V5LCAwKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgW2hleCwgbGVuZ3RoXSBvZiB0aGlzLl93YWtldXBIaW50cykgewogICAgICBjb25zdCBrZXkgPSBiNGEuZnJvbShoZXgsICdoZXgnKQogICAgICBpZiAodGhpcy5hY3RpdmVXcml0ZXJzLmhhcyhrZXkpKSBjb250aW51ZQogICAgICBpZiAobGVuZ3RoICE9PSAtMSkgewogICAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLl9hcHBseVN0YXRlLnN5c3RlbS5nZXQoa2V5KQogICAgICAgIGlmIChpbmZvICYmIGxlbmd0aCA8PSBpbmZvLmxlbmd0aCkgY29udGludWUgLy8gc3RhbGUgaGludAogICAgICB9CiAgICAgIGF3YWl0IHRoaXMuX3dha2V1cFdyaXRlcihrZXksIGxlbmd0aCA9PT0gLTEgPyAwIDogbGVuZ3RoKQogICAgfQoKICAgIHRoaXMuX3dha2V1cEhpbnRzLmNsZWFyKCkKICB9CgogIHBhdXNlKCkgewogICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgfQoKICByZXN1bWUoKSB7CiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgd2FpdEZvcldyaXRhYmxlKCkgewogICAgaWYgKHRoaXMud3JpdGFibGUpIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSkKICAgIGlmICghdGhpcy5fd3JpdGFibGUpIHRoaXMuX3dyaXRhYmxlID0gcnJwKCkKICAgIHJldHVybiB0aGlzLl93cml0YWJsZS5wcm9taXNlCiAgfQoKICBhc3luYyBfZHJhaW5XaXRoSW50ZXJ1cHQoKSB7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX2RyYWluKCkKICAgICAgICByZXR1cm4KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKHRoaXMuY2xvc2luZyB8fCAhdGhpcy5mYXN0Rm9yd2FyZFRvKSB0aHJvdyBlcnIKICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA8IE1JTl9GRl9XQUlUKSB0aHJvdyBlcnIKICAgICAgICB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPSBEYXRlLm5vdygpCiAgICAgICAgLy8gaWYgYW4gRkYgaXMgZW5hYmxlZCByZXRyeQogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBfYWR2YW5jZSgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMucGF1c2VkIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgdGhpcy5fZHJhaW5pbmcgPSB0cnVlCgogICAgaWYgKHRoaXMuX3VwZGF0ZUxvY2FsQ29yZSAhPT0gbnVsbCkgewogICAgICBhd2FpdCB0aGlzLl9yb3RhdGVMb2NhbFdyaXRlcih0aGlzLl91cGRhdGVMb2NhbENvcmUpCiAgICB9CgogICAgY29uc3QgbG9jYWwgPSB0aGlzLmxvY2FsLmxlbmd0aAoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2RyYWluV2l0aEludGVydXB0KCkKCiAgICAgIC8vIG11c3QgcnVuIHBvc3QgZHJhaW4gc28gdGhlIGxpbmVhcml6ZXIgaXMgY2F1Z2h0IHVwCiAgICAgIGlmICh0aGlzLl9jYXVnaHR1cCAmJiAodGhpcy5fbmVlZHNXYWtldXAgPT09IHRydWUgfHwgdGhpcy5fd2FrZXVwSGludHMuc2l6ZSA+IDApKQogICAgICAgIGF3YWl0IHRoaXMuX2RyYWluV2FrZXVwKCkKCiAgICAgIC8vIGNoZWNrIGlmIHdlIHNob3VsZCB1cGRhdGUgbG9jYWwgd3JpdGVyCiAgICAgIGlmICghdGhpcy5sb2NhbFdyaXRlciB8fCB0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgewogICAgICAgIGF3YWl0IHRoaXMuX3VwZGF0ZUxvY2FsV3JpdGVyKHRoaXMuX2FwcGx5U3RhdGUuc3lzdGVtKQogICAgICB9CgogICAgICB0aGlzLl9kcmFpbmluZyA9IGZhbHNlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fb25FcnJvcihlcnIpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLl9pbnRlcnJ1cHRpbmcpIHJldHVybgoKICAgIGlmICh0aGlzLmxvY2FsV3JpdGVyICYmICF0aGlzLmxvY2FsV3JpdGVyLmNsb3NlZCkgewogICAgICBpZiAodGhpcy5fYXBwbHlTdGF0ZS5pc0xvY2FsUGVuZGluZ0luZGV4ZXIoKSkgdGhpcy5hY2soKS5jYXRjaChub29wKQogICAgICBlbHNlIGlmICh0aGlzLl90cmlnZ2VyQWNrQXNhcCgpKSB0aGlzLl9hY2tUaW1lci5hc2FwKCkKICAgIH0KCiAgICAvLyBrZWVwIGJvb3RzdHJhcHMgaW4gc3luYyB3aXRoIGxpbmVhcml6ZXIKICAgIGlmICh0aGlzLnVwZGF0aW5nID09PSB0cnVlIHx8IHRoaXMuX2Jvb3RzdHJhcFdyaXRlcnNDaGFuZ2VkID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX3VwZGF0ZUJvb3RzdHJhcFdyaXRlcnMoKQogICAgfQoKICAgIGlmICh0aGlzLnVwZGF0aW5nID09PSB0cnVlKSB7CiAgICAgIHRoaXMudXBkYXRpbmcgPSBmYWxzZQoKICAgICAgaWYgKGxvY2FsICE9PSB0aGlzLmxvY2FsLmxlbmd0aCkgdGhpcy5fcmVzZXRBY2tUaWNrKCkKICAgICAgZWxzZSB0aGlzLl9hY2tUaWNrKysKCiAgICAgIGlmICghdGhpcy5faW50ZXJydXB0aW5nKSB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICAgIHRoaXMuX3dhaXRpbmcubm90aWZ5KG51bGwpCiAgICB9CgogICAgaWYgKCF0aGlzLl9pbnRlcnJ1cHRpbmcpIGF3YWl0IHRoaXMuX2djV3JpdGVycygpCiAgfQoKICBfdHJpZ2dlckFja0FzYXAoKSB7CiAgICBpZiAoIXRoaXMuX2Fja1RpbWVyKSByZXR1cm4gZmFsc2UKCiAgICAvLyBmbHVzaCBpZiB0aHJlc2hvbGQgaXMgcmVhY2hlZCBhbmQgd2UgYXJlIG5vdCBhbHJlYWR5IGFja2luZwogICAgaWYgKHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQgJiYgIXRoaXMuX2Fja2luZyAmJiB0aGlzLl9hY2tUaWNrID49IHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQpIHsKICAgICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB7CiAgICAgICAgZm9yIChjb25zdCB3IG9mIHRoaXMubGluZWFyaXplci5pbmRleGVycykgewogICAgICAgICAgaWYgKHcuY29yZS5sZW5ndGggPiB3Lmxlbmd0aCkgcmV0dXJuIGZhbHNlIC8vIHdhaXQgZm9yIHRoZSBub3JtYWwgYWNrIGN5Y2xlIGluIHRoaXMgY2FzZQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9xdWV1ZUZhc3RGb3J3YXJkKCkgewogICAgaWYgKCF0aGlzLmNvcmUub3BlbmVkKSByZXR1cm4KICAgIC8vIHNob3VsZCBoYXZlIGEgYmV0dGVyIHdheSB0byBnZXQgdGhpcwogICAgY29uc3QgbGF0ZXN0U2lnbmVkTGVuZ3RoID0gdGhpcy5jb3JlLmNvcmUuc3RhdGUubGVuZ3RoCgogICAgaWYgKCF0aGlzLmZhc3RGb3J3YXJkRW5hYmxlZCB8fCB0aGlzLmZhc3RGb3J3YXJkaW5nICE9PSBudWxsIHx8IHRoaXMuX2ludGVycnVwdGluZykgcmV0dXJuCgogICAgaWYgKGxhdGVzdFNpZ25lZExlbmd0aCAtIHRoaXMuY29yZS5sZW5ndGggPCB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSkgcmV0dXJuCiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZFRvICE9PSBudWxsKSByZXR1cm4KICAgIGlmIChEYXRlLm5vdygpIC0gdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0IDwgTUlOX0ZGX1dBSVQpIHJldHVybgoKICAgIHRoaXMuX3J1bkZhc3RGb3J3YXJkKAogICAgICBuZXcgRmFzdEZvcndhcmQodGhpcywgdGhpcy5jb3JlLmtleSwgeyBtaW5pbXVtOiB0aGlzLmZhc3RGb3J3YXJkTWluaW11bSB9KQogICAgKS5jYXRjaChub29wKQogIH0KCiAgX3F1ZXVlU3RhdGljRmFzdEZvcndhcmQoa2V5KSB7CiAgICBpZiAoIXRoaXMuZmFzdEZvcndhcmRFbmFibGVkIHx8IHRoaXMuZmFzdEZvcndhcmRpbmcgIT09IG51bGwgfHwgdGhpcy5faW50ZXJydXB0aW5nKSByZXR1cm4KICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkVG8gIT09IG51bGwpIHJldHVybgogICAgaWYgKERhdGUubm93KCkgLSB0aGlzLmZhc3RGb3J3YXJkRmFpbGVkQXQgPCBNSU5fRkZfV0FJVCkgcmV0dXJuCgogICAgdGhpcy5fcnVuRmFzdEZvcndhcmQobmV3IEZhc3RGb3J3YXJkKHRoaXMsIGtleSwgeyB2ZXJpZmllZDogZmFsc2UgfSkpLmNhdGNoKG5vb3ApCiAgfQoKICBfdXBkYXRlQWN0aXZpdHkoKSB7CiAgICB0aGlzLmFjdGl2ZVdyaXRlcnMudXBkYXRlQWN0aXZpdHkoKQogICAgaWYgKHRoaXMuX2FwcGx5U3RhdGUpIHsKICAgICAgaWYgKHRoaXMuaXNGYXN0Rm9yd2FyZGluZygpKSB0aGlzLl9hcHBseVN0YXRlLnBhdXNlKCkKICAgICAgZWxzZSB0aGlzLl9hcHBseVN0YXRlLnJlc3VtZSgpCiAgICB9CgogICAgLy8gaW4gY2FzZSB3ZSBpZ25vcmVkIHdha2V1cHMgY2FzZSB3ZSB3ZXJlIGZhc3QgZm9yd2FyZGluZywgcmVxdWVzdCB0aGVtIG5vdyBpZiBub3QKICAgIGlmICh0aGlzLl9uZWVkc1dha2V1cFJlcXVlc3QgJiYgIXRoaXMuaXNGYXN0Rm9yd2FyZGluZygpICYmIHRoaXMud2FrZXVwU2Vzc2lvbikgewogICAgICB0aGlzLl9uZWVkc1dha2V1cFJlcXVlc3QgPSBmYWxzZQoKICAgICAgdGhpcy53YWtldXBTZXNzaW9uLmJyb2FkY2FzdExvb2t1cCh7fSkKICAgIH0KICB9CgogIF9wcmVmZXJGYXN0Rm9yd2FyZCgpIHsKICAgIHRoaXMuZmFzdEZvcndhcmRNaW5pbXVtID0gMQogICAgdGhpcy5fcXVldWVGYXN0Rm9yd2FyZCgpCiAgfQoKICBfcG9zdEFwcGx5KCkgewogICAgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gPSBGYXN0Rm9yd2FyZC5NSU5JTVVNCiAgfQoKICBhc3luYyBfcnVuRmFzdEZvcndhcmQoZmYpIHsKICAgIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBmZgoKICAgIHRoaXMuX3VwZGF0ZUFjdGl2aXR5KCkKCiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmZi51cGdyYWRlKCkKICAgIGF3YWl0IGZmLmNsb3NlKCkKCiAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZGluZyA9PT0gZmYpIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBudWxsCgogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgaWYgKGZmLmZhaWxlZCkgdGhpcy5mYXN0Rm9yd2FyZEZhaWxlZEF0ID0gRGF0ZS5ub3coKQogICAgICBlbHNlIHRoaXMuX3F1ZXVlRmFzdEZvcndhcmQoKQogICAgICB0aGlzLl91cGRhdGVBY3Rpdml0eSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuZmFzdEZvcndhcmRGYWlsZWRBdCA9IDAKICAgIHRoaXMuZmFzdEZvcndhcmRUbyA9IHJlc3VsdAoKICAgIGlmICh0aGlzLl9hcHBseVN0YXRlICYmIHRoaXMuX2FwcGx5U3RhdGUuYXBwbHlpbmcgJiYgdGhpcy5mYXN0Rm9yd2FyZE1pbmltdW0gPT09IDEpIHsKICAgICAgYXdhaXQgdGhpcy5fYXBwbHlTdGF0ZS5jbG9zZSgpCiAgICB9CgogICAgdGhpcy5fYnVtcEFja1RpbWVyKCkKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICAvLyB0cmlnZ2VyZWQgZnJvbSBhcHBseQogIGFzeW5jIF9hZGRXcml0ZXIoa2V5LCBzeXMpIHsKICAgIC8vIGp1c3QgY29tcGF0IGZvciBvbGQgdmVyc2lvbgogICAgYXNzZXJ0KCEhdGhpcy5fYXBwbHlTdGF0ZS5hcHBseWluZywgJ1N5c3RlbSBjaGFuZ2VzIGFyZSBvbmx5IGFsbG93ZWQgaW4gYXBwbHknKQoKICAgIGNvbnN0IHdyaXRlciA9CiAgICAgIChhd2FpdCB0aGlzLl9nZXRXcml0ZXJCeUtleShrZXksIC0xLCAwLCBmYWxzZSwgdHJ1ZSwgc3lzKSkgfHwKICAgICAgdGhpcy5fbWFrZVdyaXRlcihrZXksIDAsIHRydWUsIGZhbHNlKQogICAgYXdhaXQgd3JpdGVyLnJlYWR5KCkKCiAgICBpZiAoIXRoaXMuYWN0aXZlV3JpdGVycy5oYXMoa2V5KSkgewogICAgICB0aGlzLmFjdGl2ZVdyaXRlcnMuYWRkKHdyaXRlcikKICAgICAgdGhpcy5fY2hlY2tXcml0ZXJzLnB1c2god3JpdGVyKQogICAgICB0aGlzLl9lbnN1cmVXYWtldXAod3JpdGVyKQogICAgfQoKICAgIC8vIGZldGNoIGFueSBub2RlcyBuZWVkZWQgZm9yIGRlcGVuZGVudHMKICAgIHRoaXMuX3F1ZXVlQnVtcCgpCiAgfQoKICAvLyB0cmlnZ2VyZWQgZnJvbSBhcHBseQogIF9yZW1vdmVXcml0ZXIoa2V5KSB7CiAgICAvLyBqdXN0IGNvbXBhdCBmb3Igb2xkIHZlcnNpb24KICAgIGNvbnN0IHcgPSB0aGlzLmFjdGl2ZVdyaXRlcnMuZ2V0KGtleSkKICAgIGlmICh3KSB3LmlzUmVtb3ZlZCA9IHRydWUKCiAgICB0aGlzLl9xdWV1ZUJ1bXAoKQogIH0KCiAgcmVtb3ZlYWJsZShrZXkpIHsKICAgIHJldHVybiB0aGlzLl9hcHBseVN0YXRlID8gdGhpcy5fYXBwbHlTdGF0ZS5yZW1vdmVhYmxlKGtleSkgOiBmYWxzZQogIH0KCiAgX3VwZGF0ZUFja1RocmVzaG9sZCgpIHsKICAgIGlmICh0aGlzLl9hY2tUaHJlc2hvbGQgPT09IDApIHJldHVybgogICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB0aGlzLl9hY2tUaW1lci5iYXUoKQogICAgdGhpcy5fYWNrVGljayA9IDAKICAgIHRoaXMuX2Fja1RpY2tUaHJlc2hvbGQgPSByYW5kb20yb3ZlcjEodGhpcy5saW5lYXJpemVyLmluZGV4ZXJzLmxlbmd0aCAqIHRoaXMuX2Fja1RocmVzaG9sZCkKICB9CgogIF9yZXNldEFja1RpY2soKSB7CiAgICB0aGlzLl9hY2tUaWNrID0gMAogICAgaWYgKHRoaXMuX2Fja1RpbWVyKSB0aGlzLl9hY2tUaW1lci5iYXUoKQogIH0KCiAgX3NoaWZ0V3JpdGVyKHcpIHsKICAgIHcuc2hpZnQoKQogICAgaWYgKHcuZmx1c2hlZCgpKSB0aGlzLl9jaGVja1dyaXRlcnMucHVzaCh3KQogIH0KfQoKZnVuY3Rpb24gdG9LZXkoaykgewogIHJldHVybiBiNGEuaXNCdWZmZXIoaykgPyBrIDogaHlwZXJjb3JlSWQuZGVjb2RlKGspCn0KCmZ1bmN0aW9uIGlzQXV0b2Jhc2VNZXNzYWdlKG1zZykgewogIHJldHVybiBtc2cuY2hlY2twb2ludCA/IG1zZy5jaGVja3BvaW50Lmxlbmd0aCA+IDAgOiBtc2cuY2hlY2twb2ludCA9PT0gbnVsbAp9CgpmdW5jdGlvbiBjb21wYXJlTm9kZXMoYSwgYikgewogIHJldHVybiBiNGEuY29tcGFyZShhLmtleSwgYi5rZXkpCn0KCmZ1bmN0aW9uIHJhbmRvbTJvdmVyMShuKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IobiArIE1hdGgucmFuZG9tKCkgKiBuKQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGNyYXNoU29vbihlcnIpIHsKICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7CiAgICB0aHJvdyBlcnIKICB9KQogIHRocm93IGVycgp9CgpmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsCn0KCmZ1bmN0aW9uIGVtaXRXYXJuaW5nKGVycikgewogIHNhZmV0eUNhdGNoKGVycikKICB0aGlzLmVtaXQoJ3dhcm5pbmcnLCBlcnIpCn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZSh2YWx1ZUVuY29kaW5nLCB2YWx1ZSkgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAwLCBlbmQ6IDAgfQogIHZhbHVlRW5jb2RpbmcucHJlZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIHZhbHVlRW5jb2RpbmcuZW5jb2RlKHN0YXRlLCB2YWx1ZSkKICBzdGF0ZS5zdGFydCA9IDAKICByZXR1cm4gdmFsdWVFbmNvZGluZy5kZWNvZGUoc3RhdGUpCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQWN0aXZlV3JpdGVycyB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm1hcCA9IG5ldyBNYXAoKQogIH0KCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5tYXAuc2l6ZQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5tYXAudmFsdWVzKCkKICB9CgogIGdldChrZXkpIHsKICAgIHJldHVybiB0aGlzLm1hcC5nZXQoYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpKSB8fCBudWxsCiAgfQoKICBoYXMoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5nZXQoa2V5KSAhPT0gbnVsbAogIH0KCiAgYWRkKHdyaXRlcikgewogICAgdGhpcy5tYXAuc2V0KGI0YS50b1N0cmluZyh3cml0ZXIuY29yZS5rZXksICdoZXgnKSwgd3JpdGVyKQogIH0KCiAgZGVsZXRlKHdyaXRlcikgewogICAgdGhpcy5tYXAuZGVsZXRlKGI0YS50b1N0cmluZyh3cml0ZXIuY29yZS5rZXksICdoZXgnKSkKICB9CgogIHVwZGF0ZUFjdGl2aXR5KCkgewogICAgZm9yIChjb25zdCB3IG9mIHRoaXMubWFwLnZhbHVlcygpKSB3LnVwZGF0ZUFjdGl2aXR5KCkKICB9CgogIGNsZWFyKCkgewogICAgY29uc3QgcCA9IFtdCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHAucHVzaCh3LmNsb3NlKCkpCiAgICB0aGlzLm1hcC5jbGVhcigpCgogICAgcmV0dXJuIFByb21pc2UuYWxsKHApCiAgfQp9CmNvbnN0IFNpZ25hbFByb21pc2UgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEFwcGVuZEJhdGNoIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmJsb2NrcyA9IFtdCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgICB0aGlzLmZsdXNoaW5nID0gZmFsc2UKICAgIHRoaXMuX2ZsdXNoZWQgPSBudWxsCiAgfQoKICBhc3luYyBfYWNxdWlyZSgpIHsKICAgIHdoaWxlICh0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggIT09IG51bGwgJiYgdGhpcy5iYXNlLmFjdGl2ZUJhdGNoICE9PSB0aGlzKQogICAgICBhd2FpdCB0aGlzLmJhc2UuYWN0aXZlQmF0Y2guZmx1c2hlZCgpCiAgICB0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggPSB0aGlzCiAgfQoKICBhc3luYyBhcHBlbmQodmFsdWUpIHsKICAgIGlmICh0aGlzLmJhc2Uub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5iYXNlLnJlYWR5KCkKICAgIGlmICh0aGlzLmJhc2UuX2FkdmFuY2luZyAhPT0gbnVsbCkgYXdhaXQgdGhpcy5iYXNlLl9hZHZhbmNpbmcKCiAgICBpZiAodGhpcy5jbG9zZWQpIHRocm93IG5ldyBFcnJvcignQmF0Y2ggaXMgY2xvc2VkJykKICAgIGlmICh0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggIT09IHRoaXMpIGF3YWl0IHRoaXMuX2FjcXVpcmUoKQogICAgaWYgKHRoaXMuY2xvc2VkKSB0aHJvdyBuZXcgRXJyb3IoJ0JhdGNoIGlzIGNsb3NlZCcpCgogICAgdGhpcy5ibG9ja3MucHVzaCh2YWx1ZSkKICAgIHJldHVybiB0aGlzLmJhc2UubG9jYWwubGVuZ3RoICsgdGhpcy5ibG9ja3MubGVuZ3RoCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLmNsb3NlZCkgdGhyb3cgbmV3IEVycm9yKCdCYXRjaCBpcyBjbG9zZWQnKQogICAgaWYgKHRoaXMuZmx1c2hpbmcpIHJldHVybiB0aGlzLmZsdXNoZWQoKQogICAgdGhpcy5mbHVzaGluZyA9IHRydWUKICAgIGlmICh0aGlzLmJsb2Nrcy5sZW5ndGgpIGF3YWl0IHRoaXMuYmFzZS5fYXBwZW5kQmF0Y2godGhpcy5ibG9ja3MpCiAgICByZXR1cm4gdGhpcy5jbG9zZSgpCiAgfQoKICBmbHVzaGVkKCkgewogICAgaWYgKHRoaXMuY2xvc2VkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIGlmICh0aGlzLl9mbHVzaGVkKSByZXR1cm4gdGhpcy5fZmx1c2hlZC53YWl0KCkKICAgIHRoaXMuX2ZsdXNoZWQgPSBuZXcgU2lnbmFsUHJvbWlzZSgpCiAgICByZXR1cm4gdGhpcy5fZmx1c2hlZC53YWl0KCkKICB9CgogIGNsb3NlKCkgewogICAgaWYgKHRoaXMuYmFzZS5hY3RpdmVCYXRjaCAhPT0gdGhpcykgcmV0dXJuCiAgICB0aGlzLmJhc2UuYWN0aXZlQmF0Y2ggPSBudWxsCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIGlmICh0aGlzLl9mbHVzaGVkKSB0aGlzLl9mbHVzaGVkLm5vdGlmeShudWxsKQogIH0KfQpjbGFzcyBQdWJsaWNBcHBseUNhbGxzIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmludGVybmFsID0gZmFsc2UKICB9CgogIGdldCBkaXNjb3ZlcnlLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmRpc2NvdmVyeUtleQogIH0KCiAgZ2V0IGtleSgpIHsKICAgIHJldHVybiB0aGlzLmJhc2Uua2V5CiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmlkCiAgfQoKICBhc3luYyBhZGRXcml0ZXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBhc3luYyBhY2tXcml0ZXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBhc3luYyByZW1vdmVXcml0ZXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBwcmVmZXJGYXN0Rm9yd2FyZCgpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIGludGVycnVwdCgpIHsKICAgIHRocm93IG5ldyBFcnJvcignTm90IGFsbG93ZWQgb24gdGhlIHB1YmxpYyB2aWV3JykKICB9CgogIHJlbW92ZWFibGUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIG9uIHRoZSBwdWJsaWMgdmlldycpCiAgfQoKICBmb3JrKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KCiAgYW5jaG9yKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgYWxsb3dlZCBvbiB0aGUgcHVibGljIHZpZXcnKQogIH0KfQoKY2xhc3MgUHJpdmF0ZUFwcGx5Q2FsbHMgZXh0ZW5kcyBQdWJsaWNBcHBseUNhbGxzIHsKICBjb25zdHJ1Y3RvcihzdGF0ZSkgewogICAgc3VwZXIoc3RhdGUuYmFzZSkKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5pbnRlcm5hbCA9IHRydWUKICB9CgogIGdldCBzeXN0ZW0oKSB7CiAgICByZXR1cm4gdGhpcy5zdGF0ZS5zeXN0ZW0KICB9CgogIGFzeW5jIGFkZFdyaXRlcihrZXksIHsgaW5kZXhlciA9IHRydWUsIGlzSW5kZXhlciA9IGluZGV4ZXIgfSA9IHt9KSB7CiAgICAvLyBqdXN0IGNvbXBhdCBmb3Igb2xkIHZlcnNpb24KICAgIGF3YWl0IHRoaXMuc3RhdGUuc3lzdGVtLmFkZChrZXksIHsgaXNJbmRleGVyIH0pCiAgICBhd2FpdCB0aGlzLmJhc2UuX2FkZFdyaXRlcihrZXksIHRoaXMuc3RhdGUuc3lzdGVtKQogIH0KCiAgYXN5bmMgYWNrV3JpdGVyKGtleSkgewogICAgYXdhaXQgdGhpcy5zdGF0ZS5zeXN0ZW0uYWNrKGtleSkKICB9CgogIGFzeW5jIHJlbW92ZVdyaXRlcihrZXkpIHsKICAgIC8vIGp1c3QgY29tcGF0IGZvciBvbGQgdmVyc2lvbgogICAgaWYgKCF0aGlzLnN0YXRlLnJlbW92ZWFibGUoa2V5KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhbGxvd2VkIHRvIHJlbW92ZSB0aGUgbGFzdCBpbmRleGVyJykKICAgIH0KCiAgICBhd2FpdCB0aGlzLnN0YXRlLnN5c3RlbS5yZW1vdmUoa2V5KQogICAgdGhpcy5iYXNlLl9yZW1vdmVXcml0ZXIoa2V5KQogIH0KCiAgcHJlZmVyRmFzdEZvcndhcmQoKSB7CiAgICB0aGlzLmJhc2UuX3ByZWZlckZhc3RGb3J3YXJkKCkKICB9CgogIGludGVycnVwdChyZWFzb24pIHsKICAgIHRoaXMuYmFzZS5faW50ZXJydXB0KHJlYXNvbikKICB9CgogIHJlbW92ZWFibGUoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5zdGF0ZS5yZW1vdmVhYmxlKGtleSkKICB9CgogIGFzeW5jIGZvcmsoaW5kZXhlcktleXMsIHN5c3RlbSkgewogICAgaWYgKCEoYXdhaXQgdGhpcy5zdGF0ZS52YWxpZGF0ZUZvcmsoaW5kZXhlcktleXMsIHN5c3RlbSkpKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBpbmRleGVycyA9IGluZGV4ZXJLZXlzLm1hcCh0b0luZGV4ZXIpCgogICAgdGhpcy5zdGF0ZS5wZW5kaW5nRm9yayA9IHsgaW5kZXhlcnMsIGxlbmd0aDogc3lzdGVtLmxlbmd0aCB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGNyZWF0ZUFuY2hvcigpIHsKICAgIHJldHVybiBhd2FpdCB0aGlzLnN0YXRlLmNyZWF0ZUFuY2hvcigpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgUHVibGljQXBwbHlDYWxscywgUHJpdmF0ZUFwcGx5Q2FsbHMgfQoKZnVuY3Rpb24gdG9JbmRleGVyKGtleSkgewogIHJldHVybiB7IGtleSwgbGVuZ3RoOiAwIH0gLy8gbGVuZ3RoIGlzIG5vdCB1c2VkLCBqdXN0IGZvciBhcGkgY29tcGF0Cn0KY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKCmNvbnN0IHsgcGFydGlhbFNpZ25hdHVyZSB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlL2xpYi9tdWx0aXNpZy5qcycpCgpjb25zdCBTeXN0ZW1WaWV3ID0gcmVxdWlyZSgnLi9zeXN0ZW0uanMnKQpjb25zdCB7IEF1dG9iYXNlRW5jcnlwdGlvbiB9ID0gcmVxdWlyZSgnLi9lbmNyeXB0aW9uLmpzJykKY29uc3QgVXBkYXRlQ2hhbmdlcyA9IHJlcXVpcmUoJy4vdXBkYXRlcy5qcycpCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgUHJpdmF0ZUFwcGx5Q2FsbHMgfSA9IHJlcXVpcmUoJy4vYXBwbHktY2FsbHMuanMnKQpjb25zdCB7IGVuY29kZVZhbHVlIH0gPSByZXF1aXJlKCcuL3ZhbHVlcy5qcycpCmNvbnN0IEZvcmsgPSByZXF1aXJlKCcuL2ZvcmsuanMnKQpjb25zdCBMb2NhbFN0YXRlID0gcmVxdWlyZSgnLi9sb2NhbC1zdGF0ZS5qcycpCmNvbnN0IHsgT1BMT0dfVkVSU0lPTiwgQk9PVF9SRUNPUkRfVkVSU0lPTiB9ID0gcmVxdWlyZSgnLi9jYXBzLmpzJykKCi8vIHRvZG86IGV4cG9zZSB0aGlzIGFzIGFuIG9wdGlvbgpjb25zdCBTSE9VTERfU0lHTl9USFJFU0hPTEQgPSAwCgpjbGFzcyBDaGVja3BvaW50Q29yZSB7CiAgY29uc3RydWN0b3IodmlldywgY29yZSwgc2lnbmVyLCBwYXVzZWQpIHsKICAgIHRoaXMudmlldyA9IHZpZXcKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuc2lnbmVyID0gc2lnbmVyCiAgICB0aGlzLmxlbmd0aCA9IDAKICAgIHRoaXMuZGlnZXN0ID0gbnVsbAogICAgdGhpcy5zaWduYXR1cmVzID0geyBzeXN0ZW06IG51bGwsIGVuY3J5cHRpb246IG51bGwsIHVzZXI6IFtdIH0KICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICAgIHRoaXMucGF1c2VkID0gcGF1c2VkCiAgfQoKICBwYXVzZSgpIHsKICAgIHRoaXMucGF1c2VkID0gdHJ1ZQogIH0KCiAgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLnBhdXNlZCkgcmV0dXJuCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICB0aGlzLnVwZGF0ZUJhY2tncm91bmQoKQogIH0KCiAgYXN5bmMgdXBkYXRlKCkgewogICAgaWYgKGF3YWl0IHRoaXMudXBkYXRlQ2hlY2twb2ludHMoKSkgYXdhaXQgdGhpcy52aWV3Lm1heWJlU2lnbmVkKCkKICB9CgogIGFzeW5jIHVwZGF0ZUNoZWNrcG9pbnRzKCkgewogICAgaWYgKHRoaXMuY29yZS5sZW5ndGggPD0gdGhpcy5sZW5ndGggfHwgdGhpcy5jbG9zZWQgfHwgdGhpcy5wYXVzZWQpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuY29yZS5sZW5ndGgKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5jb3JlLmdldChsZW5ndGggLSAxKQoKICAgIGlmIChsZW5ndGggPD0gdGhpcy5sZW5ndGggfHwgdGhpcy5jbG9zZWQgfHwgIXZhbHVlLmRpZ2VzdCB8fCB0aGlzLnBhdXNlZCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgW2RpZ2VzdCwgY2hlY2twb2ludHNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICB0aGlzLl9pbmZsYXRlRGlnZXN0KGxlbmd0aCwgdmFsdWUuZGlnZXN0KSwKICAgICAgdGhpcy5faW5mbGF0ZUFsbENoZWNrcG9pbnRzKGxlbmd0aCwgdmFsdWUuY2hlY2twb2ludCkKICAgIF0pCgogICAgaWYgKGxlbmd0aCA8PSB0aGlzLmxlbmd0aCB8fCB0aGlzLmNsb3NlZCB8fCAhZGlnZXN0IHx8ICFjaGVja3BvaW50cyB8fCB0aGlzLnBhdXNlZCkgcmV0dXJuIGZhbHNlCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoZWNrcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChjaGVja3BvaW50c1tpXSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuZGlnZXN0ID0gZGlnZXN0CiAgICB0aGlzLnNpZ25hdHVyZXMgPSBjaGVja3BvaW50cwoKICAgIHJldHVybiB0cnVlCiAgfQoKICB1cGRhdGVCYWNrZ3JvdW5kKCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICB1cGRhdGVJbnRlcm5hbFNpZ25hdHVyZXMobGVuZ3RoLCBzaWduYXR1cmVzKSB7CiAgICB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtID0gdXBkYXRlU2lnbmF0dXJlKGxlbmd0aCwgc2lnbmF0dXJlcy5zeXN0ZW0sIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0pCiAgICB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbiA9IHVwZGF0ZVNpZ25hdHVyZSgKICAgICAgbGVuZ3RoLAogICAgICBzaWduYXR1cmVzLmVuY3J5cHRpb24sCiAgICAgIHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uCiAgICApCiAgfQoKICB1cGRhdGVVc2VyU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMpIHsKICAgIHRoaXMuc2lnbmF0dXJlcy51c2VyID0gdXBkYXRlU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMsIHRoaXMuc2lnbmF0dXJlcy51c2VyKQogIH0KCiAgbWFrZUNoZWNrcG9pbnRzKGxlbmd0aCkgewogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiBtYWtlQ2hlY2twb2ludChsZW5ndGgsIHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0pLAogICAgICBlbmNyeXB0aW9uOiBtYWtlQ2hlY2twb2ludChsZW5ndGgsIHRoaXMuc2lnbmF0dXJlcy5lbmNyeXB0aW9uKSwKICAgICAgdXNlcjogbWFrZUNoZWNrcG9pbnRzKGxlbmd0aCwgdGhpcy5zaWduYXR1cmVzLnVzZXIpCiAgICB9CiAgfQoKICBtYWtlRGlnZXN0KGxlbmd0aCwga2V5KSB7CiAgICBpZiAodGhpcy5kaWdlc3QgJiYgKHRoaXMuZGlnZXN0LmtleSA9PT0ga2V5IHx8IGI0YS5lcXVhbHModGhpcy5kaWdlc3Qua2V5LCBrZXkpKSkgewogICAgICByZXR1cm4geyBrZXk6IG51bGwsIHBvaW50ZXI6IGxlbmd0aCAtIHRoaXMuZGlnZXN0LmF0IH0KICAgIH0KICAgIHRoaXMuZGlnZXN0ID0geyBrZXksIGF0OiBsZW5ndGggfQogICAgcmV0dXJuIHsga2V5LCBwb2ludGVyOiAwIH0KICB9CgogIGFzeW5jIHJlYWR5KCkgewogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIHRoaXMuY29yZS5vbignYXBwZW5kJywgdGhpcy51cGRhdGVCYWNrZ3JvdW5kLmJpbmQodGhpcykpCiAgICBpZiAodGhpcy5jb3JlLndyaXRhYmxlKSBhd2FpdCB0aGlzLnVwZGF0ZUNoZWNrcG9pbnRzKCkKICAgIHRoaXMudXBkYXRlQmFja2dyb3VuZCgpCiAgfQoKICBzaWduZWRMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5zaWduYXR1cmVzLnN5c3RlbSA/IHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0ubGVuZ3RoIDogMAogIH0KCiAgY2xvc2UoKSB7CiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIHJldHVybiB0aGlzLmNvcmUuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2luZmxhdGVEaWdlc3QobGVuZ3RoLCBkaWcpIHsKICAgIGlmICghZGlnKSByZXR1cm4gbnVsbAoKICAgIGlmIChkaWcucG9pbnRlciA9PT0gMCkgewogICAgICByZXR1cm4geyBrZXk6IGRpZy5rZXksIGF0OiBsZW5ndGggfQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGxlbmd0aCAtIGRpZy5wb2ludGVyCgogICAgaWYgKHRoaXMuZGlnZXN0ICYmIGxlbiA9PT0gdGhpcy5kaWdlc3QuYXQpIHJldHVybiB0aGlzLmRpZ2VzdAogICAgaWYgKGxlbiA8PSAwKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgZGlnZXN0IH0gPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KGxlbiAtIDEpCiAgICBpZiAoIWRpZ2VzdCB8fCAhZGlnZXN0LmtleSkgcmV0dXJuIG51bGwKCiAgICByZXR1cm4geyBrZXk6IGRpZ2VzdC5rZXksIGF0OiBsZW4gfQogIH0KCiAgX3NhbWVTaWduYXR1cmVzKGIsIGEpIHsKICAgIHJldHVybiAoCiAgICAgIHNhbWVTaWduYXR1cmUoYS5zeXN0ZW0sIGIuc3lzdGVtKSAmJgogICAgICBzYW1lU2lnbmF0dXJlKGEuZW5jcnlwdGlvbiwgYi5lbmNyeXB0aW9uKSAmJgogICAgICBzYW1lU2lnbmF0dXJlcyhhLnVzZXIsIGIudXNlcikKICAgICkKICB9CgogIGFzeW5jIF9pbmZsYXRlQWxsQ2hlY2twb2ludHMobGVuZ3RoLCBjaGVja3BvaW50cykgewogICAgaWYgKCFjaGVja3BvaW50cykgcmV0dXJuIHsgc3lzdGVtOiBudWxsLCBlbmNyeXB0aW9uOiBudWxsLCB1c2VyOiBbXSB9CiAgICBpZiAodGhpcy5fc2FtZVNpZ25hdHVyZXMoY2hlY2twb2ludHMsIHRoaXMuc2lnbmF0dXJlcykpIHJldHVybiB0aGlzLnNpZ25hdHVyZXMKCiAgICBjb25zdCBzeXN0ZW0gPSB0aGlzLl9pbmZsYXRlU3lzdGVtQ2hlY2twb2ludChjaGVja3BvaW50cy5zeXN0ZW0sIGxlbmd0aCkKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLl9pbmZsYXRlRW5jcnlwdGlvbkNoZWNrcG9pbnQoY2hlY2twb2ludHMuZW5jcnlwdGlvbiwgbGVuZ3RoKQoKICAgIGNvbnN0IHVzZXIgPSBjaGVja3BvaW50cy51c2VyID8gbmV3IEFycmF5KGNoZWNrcG9pbnRzLnVzZXIubGVuZ3RoKSA6IFtdCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1c2VyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNoayA9IGNoZWNrcG9pbnRzLnVzZXJbaV0KICAgICAgdXNlcltpXSA9IHRoaXMuX2luZmxhdGVVc2VyQ2hlY2twb2ludChjaGssIGksIGxlbmd0aCkKICAgIH0KCiAgICBjb25zdCBbc3lzdGVtQ2hlY2twb2ludCwgZW5jcnlwdGlvbkNoZWNrcG9pbnQsIHVzZXJDaGVja3BvaW50c10gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICAgIHN5c3RlbSwKICAgICAgZW5jcnlwdGlvbiwKICAgICAgUHJvbWlzZS5hbGwodXNlcikKICAgIF0pCgogICAgcmV0dXJuIHsKICAgICAgc3lzdGVtOiBzeXN0ZW1DaGVja3BvaW50LAogICAgICBlbmNyeXB0aW9uOiBlbmNyeXB0aW9uQ2hlY2twb2ludCwKICAgICAgdXNlcjogdXNlckNoZWNrcG9pbnRzCiAgICB9CiAgfQoKICBhc3luYyBfaW5mbGF0ZVN5c3RlbUNoZWNrcG9pbnQoY2hrLCBjb3JlTGVuZ3RoKSB7CiAgICBpZiAoY2hrLmNoZWNrcG9pbnQpIHsKICAgICAgY29uc3QgeyBzaWduYXR1cmUsIGxlbmd0aCB9ID0gY2hrLmNoZWNrcG9pbnQKICAgICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBjb3JlTGVuZ3RoIH0KICAgIH0KCiAgICBjb25zdCBsZW4gPSBjb3JlTGVuZ3RoIC0gY2hrLmNoZWNrcG9pbnRlcgogICAgaWYgKHRoaXMuc2lnbmF0dXJlcy5zeXN0ZW0gJiYgdGhpcy5zaWduYXR1cmVzLnN5c3RlbS5hdCA9PT0gbGVuKSB7CiAgICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZXMuc3lzdGVtCiAgICB9CgogICAgaWYgKGxlbiA8PSAwKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgY2hlY2twb2ludCB9ID0gYXdhaXQgdGhpcy5jb3JlLmdldChsZW4gLSAxKQogICAgaWYgKCFjaGVja3BvaW50IHx8ICFjaGVja3BvaW50LnN5c3RlbSB8fCAhY2hlY2twb2ludC5zeXN0ZW0uY2hlY2twb2ludCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGVja3BvaW50LnN5c3RlbS5jaGVja3BvaW50CiAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGxlbiB9CiAgfQoKICBhc3luYyBfaW5mbGF0ZUVuY3J5cHRpb25DaGVja3BvaW50KGNoaywgY29yZUxlbmd0aCkgewogICAgaWYgKCFjaGspIHJldHVybiB7IGxlbmd0aDogMCwgc2lnbmF0dXJlOiBudWxsLCBhdDogMCB9CgogICAgaWYgKGNoay5jaGVja3BvaW50KSB7CiAgICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoay5jaGVja3BvaW50CiAgICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoLCBhdDogY29yZUxlbmd0aCB9CiAgICB9CgogICAgY29uc3QgbGVuID0gY29yZUxlbmd0aCAtIGNoay5jaGVja3BvaW50ZXIKICAgIGlmICh0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbiAmJiB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbi5hdCA9PT0gbGVuKSB7CiAgICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZXMuZW5jcnlwdGlvbgogICAgfQoKICAgIGlmIChsZW4gPD0gMCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IGNoZWNrcG9pbnQgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQobGVuIC0gMSkKICAgIGlmICghY2hlY2twb2ludCB8fCAhY2hlY2twb2ludC5lbmNyeXB0aW9uIHx8ICFjaGVja3BvaW50LmVuY3J5cHRpb24uY2hlY2twb2ludCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGVja3BvaW50LmVuY3J5cHRpb24uY2hlY2twb2ludAogICAgcmV0dXJuIHsgc2lnbmF0dXJlLCBsZW5ndGgsIGF0OiBsZW4gfQogIH0KCiAgYXN5bmMgX2luZmxhdGVVc2VyQ2hlY2twb2ludChjaGssIGksIGNvcmVMZW5ndGgpIHsKICAgIGlmIChjaGsuY2hlY2twb2ludCkgewogICAgICBjb25zdCB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0gPSBjaGsuY2hlY2twb2ludAogICAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGNvcmVMZW5ndGggfQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGNvcmVMZW5ndGggLSBjaGsuY2hlY2twb2ludGVyCiAgICBpZiAoaSA8IHRoaXMuc2lnbmF0dXJlcy51c2VyLmxlbmd0aCAmJiB0aGlzLnNpZ25hdHVyZXMudXNlcltpXS5hdCA9PT0gbGVuKSB7CiAgICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZXMudXNlcltpXQogICAgfQoKICAgIGlmIChsZW4gPD0gMCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB7IGNoZWNrcG9pbnQgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQobGVuIC0gMSkKICAgIGlmICghY2hlY2twb2ludCB8fCBpID49IGNoZWNrcG9pbnQudXNlci5sZW5ndGggfHwgIWNoZWNrcG9pbnQudXNlcltpXS5jaGVja3BvaW50KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHsgc2lnbmF0dXJlLCBsZW5ndGggfSA9IGNoZWNrcG9pbnQudXNlcltpXS5jaGVja3BvaW50CiAgICByZXR1cm4geyBzaWduYXR1cmUsIGxlbmd0aCwgYXQ6IGxlbiB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEFwcGx5U3RhdGUgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5lbmNyeXB0aW9uID0gdGhpcy5iYXNlLmVuY3J5cHRpb24KICAgIHRoaXMudmFsdWVFbmNvZGluZyA9IGJhc2UudmFsdWVFbmNvZGluZwogICAgdGhpcy5zdG9yZSA9IGJhc2UuX3ZpZXdTdG9yZS5hdG9taXplKCkKICAgIHRoaXMua2V5ID0gbnVsbAogICAgdGhpcy5zeXN0ZW0gPSBudWxsCiAgICB0aGlzLnZpZXcgPSBudWxsCiAgICB0aGlzLnZpZXdzID0gW10KICAgIHRoaXMuc3lzdGVtVmlldyA9IG51bGwKICAgIHRoaXMuZW5jcnlwdGlvblZpZXcgPSBudWxsCiAgICB0aGlzLmhvc3RjYWxscyA9IG51bGwKICAgIHRoaXMuY2hhbmdlcyA9IGJhc2UuX2hhc1VwZGF0ZSA/IG5ldyBVcGRhdGVDaGFuZ2VzKGJhc2UpIDogbnVsbAoKICAgIHRoaXMudXBkYXRlcyA9IFtdCgogICAgdGhpcy5sb2NhbCA9IG51bGwKICAgIHRoaXMubG9jYWxTdGF0ZSA9IG51bGwKCiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gZmFsc2UKICAgIHRoaXMuaW5kZXhlcnNVcGRhdGVkID0gZmFsc2UKICAgIHRoaXMucXVvcnVtID0gMAogICAgdGhpcy5uZWVkc0luZGV4ZWRMZW5ndGhVcGRhdGUgPSBmYWxzZQogICAgdGhpcy5pbnRlcnJ1cHRlZCA9IGZhbHNlCiAgICB0aGlzLmFwcGx5aW5nID0gbnVsbAogICAgdGhpcy5hcHBseUJhdGNoID0gbnVsbAoKICAgIHRoaXMubG9jYWxDaGVja3BvaW50ID0gbnVsbAogICAgdGhpcy5sb2NhbEluZGV4ZXIgPSBmYWxzZQoKICAgIHRoaXMuc3lzdGVtVXBncmFkZSA9IG51bGwKCiAgICB0aGlzLmNoZWNrcG9pbnRzID0gW10KICAgIHRoaXMucGVuZGluZ1ZpZXdzID0gbnVsbAogICAgdGhpcy5wZW5kaW5nRm9yayA9IG51bGwKICAgIHRoaXMuZGlydHkgPSBmYWxzZQogIH0KCiAgc2hvdWxkRmx1c2goKSB7CiAgICByZXR1cm4gdGhpcy5kaXJ0eQogIH0KCiAgYXN5bmMgc2hvdWxkV3JpdGUoKSB7CiAgICBpZiAoIXRoaXMubG9jYWxJbmRleGVyIHx8ICF0aGlzLmxvY2FsQ2hlY2twb2ludCB8fCAhdGhpcy5sb2NhbENoZWNrcG9pbnQuY29yZS5vcGVuZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldEluZGV4ZWRJbmZvKHRoaXMuaW5kZXhlZExlbmd0aCkKICAgIGlmICghaW5mby52aWV3cy5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHsgZW5jcnlwdGlvbiwgdXNlciB9ID0gdGhpcy5sb2NhbENoZWNrcG9pbnQuc2lnbmF0dXJlcwoKICAgIC8vIHRvZG86IGRvZXMgdGhpcyBjb25kaXRpb24gaG9sZCBmb3Igc29mdC1mb3JrPwogICAgaWYgKGluZm8udmlld3MubGVuZ3RoID4gdXNlci5sZW5ndGgpIHJldHVybiB0cnVlCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmZvLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh1c2VyW2ldLmxlbmd0aCArIFNIT1VMRF9TSUdOX1RIUkVTSE9MRCA8IGluZm8udmlld3NbaV0ubGVuZ3RoKSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIC8vIGFsd2F5cyBmbHVzaCBlbmNyeXB0aW9uIHNpZ25hdHVyZQogICAgaWYgKGluZm8uZW5jcnlwdGlvbkxlbmd0aCAhPT0gMCkgewogICAgICBpZiAoIWVuY3J5cHRpb24gfHwgZW5jcnlwdGlvbi5sZW5ndGggPCBpbmZvLmVuY3J5cHRpb25MZW5ndGgpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBnZXQgaW5kZXhlZExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLnN5c3RlbVZpZXcgPyB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCA6IDAKICB9CgogIGdldCBzeXN0ZW1SZWYoKSB7CiAgICByZXR1cm4gdGhpcy5zeXN0ZW1WaWV3ID8gdGhpcy5zeXN0ZW1WaWV3LnJlZiA6IG51bGwKICB9CgogIGFzeW5jIHZhbGlkYXRlRm9yayhpbmRleGVyS2V5cywgc3lzdGVtKSB7CiAgICBpZiAoIWI0YS5lcXVhbHMoc3lzdGVtLmtleSwgdGhpcy5zeXN0ZW0uY29yZS5rZXkpKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLnBlbmRpbmdJbmRleGVkTGVuZ3RoKCkgPCBzeXN0ZW0ubGVuZ3RoKSByZXR1cm4gZmFsc2UKICAgIGZvciAoY29uc3Qga2V5IG9mIGluZGV4ZXJLZXlzKSB7CiAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXQoa2V5KQoKICAgICAgLy8gd3JpdGVyIHNob3VsZCBiZSBhY3RpdmUgYW5kIHdlIG5lZWQgbWFuaWZlc3QKICAgICAgaWYgKCFpbmZvIHx8ICFpbmZvLmxlbmd0aCB8fCBpbmZvLmlzUmVtb3ZlZCkgcmV0dXJuIGZhbHNlCiAgICB9CiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgc2hvdWxkTWlncmF0ZSgpIHsKICAgIGlmICghdGhpcy5mYXN0Rm9yd2FyZGluZyAmJiAhdGhpcy5pbmRleGVyc1VwZGF0ZWQpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuc3lzdGVtLmluZGV4ZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlIC8vIGdlbmVzaXMKCiAgICAvLyBzYW5pdHksIHByZWZlciBtaWdyYXRpb24KICAgIGlmICghdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdCB8fCAhdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC5zaWduZXJzKSByZXR1cm4gdHJ1ZQoKICAgIC8vIGVhc3kgbW9kZQogICAgaWYgKHRoaXMuc3lzdGVtLmluZGV4ZXJzLmxlbmd0aCAhPT0gdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC5zaWduZXJzLmxlbmd0aCkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGNvbnN0IG1hbmlmZXN0cyA9IGF3YWl0IHRoaXMuc3RvcmUuZ2V0SW5kZXhlck1hbmlmZXN0cyh0aGlzLnN5c3RlbS5pbmRleGVycykKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3Quc2lnbmVycy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IHB1YmxpY0tleSB9ID0gdGhpcy5zeXN0ZW0uY29yZS5tYW5pZmVzdC5zaWduZXJzW2ldCiAgICAgIGlmICghYjRhLmVxdWFscyhwdWJsaWNLZXksIG1hbmlmZXN0c1tpXS5zaWduZXJzWzBdLnB1YmxpY0tleSkpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBpc0xvY2FsUGVuZGluZ0luZGV4ZXIoKSB7CiAgICBpZiAodGhpcy5zeXN0ZW0ucGVuZGluZ0luZGV4ZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBrZXkgPSB0aGlzLmJhc2UubG9jYWwua2V5CiAgICBmb3IgKGNvbnN0IGsgb2YgdGhpcy5zeXN0ZW0ucGVuZGluZ0luZGV4ZXJzKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKGssIGtleSkpIHJldHVybiAhYjRhLmVxdWFscyh0aGlzLmJhc2Uua2V5LCBrZXkpICYmIHRoaXMuYmFzZS5sb2NhbC5sZW5ndGggPT09IDAKICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgcmVtb3ZlYWJsZShrZXkpIHsKICAgIGlmICh0aGlzLnN5c3RlbS5pbmRleGVycy5sZW5ndGggIT09IDEpIHJldHVybiB0cnVlCiAgICByZXR1cm4gIWI0YS5lcXVhbHModGhpcy5zeXN0ZW0uaW5kZXhlcnNbMF0ua2V5LCBrZXkpCiAgfQoKICBpc0xvY2FsSW5kZXhlcigpIHsKICAgIHJldHVybiAhIXRoaXMubG9jYWxDaGVja3BvaW50CiAgfQoKICBfY3JlYXRlQ2hlY2twb2ludENvcmUoa2V5LCBhY3RpdmUsIHNpZ25lciwgcGF1c2VkKSB7CiAgICBjb25zdCBlbmNyeXB0aW9uID0gdGhpcy5iYXNlLmdldFdyaXRlckVuY3J5cHRpb24oa2V5KQoKICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsKICAgICAga2V5LAogICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UsCiAgICAgIGVuY3J5cHRpb24sCiAgICAgIGFjdGl2ZQogICAgfSkKCiAgICByZXR1cm4gbmV3IENoZWNrcG9pbnRDb3JlKHRoaXMsIHNlc3Npb24sIHNpZ25lciwgcGF1c2VkKQogIH0KCiAgYXN5bmMgX29wZW5JbnRlcm5hbFZpZXcobmFtZSwgaW5kZXhlZExlbmd0aCkgewogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsgbmFtZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBhd2FpdCBjb3JlLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHRoaXMuYmFzZS5rZXkpCiAgICBhd2FpdCBjb3JlLnNldFVzZXJEYXRhKCdhdXRvYmFzZS92aWV3JywgYjRhLmZyb20obmFtZSkpCgogICAgY29uc3QgcmVmID0gdGhpcy5zdG9yZS5nZXRWaWV3QnlOYW1lKG5hbWUpCgogICAgcmV0dXJuIHsgcmVmLCBjb3JlLCBpbmRleGVkTGVuZ3RoIH0KICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYm9vdCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYXdhaXQgdGhpcy5fZnJlZSgpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgYXN5bmMgX2Jvb3QoKSB7CiAgICBjb25zdCBib290ID0gYXdhaXQgdGhpcy5iYXNlLl9nZXRCb290UmVjb3JkKCkKCiAgICB0aGlzLnN5c3RlbVZpZXcgPSBhd2FpdCB0aGlzLl9vcGVuSW50ZXJuYWxWaWV3KCdfc3lzdGVtJywgYm9vdC5zeXN0ZW1MZW5ndGgpCiAgICB0aGlzLmVuY3J5cHRpb25WaWV3ID0gYXdhaXQgdGhpcy5fb3BlbkludGVybmFsVmlldygnX2VuY3J5cHRpb24nLCAtMSkKCiAgICBjb25zdCBzeXNDb3JlID0gdGhpcy5zeXN0ZW1WaWV3LmNvcmUKICAgIGlmIChzeXNDb3JlLm1hbmlmZXN0LnZlcnNpb24gPj0gMikgewogICAgICBpZiAodGhpcy5lbmNyeXB0aW9uICE9PSBudWxsKSBhd2FpdCB0aGlzLmVuY3J5cHRpb24ucmVsb2FkKHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZSkKICAgIH0KCiAgICBjb25zdCBzeXN0ZW0gPSBuZXcgU3lzdGVtVmlldyhzeXNDb3JlKQogICAgYXdhaXQgc3lzdGVtLnJlYWR5KCkKCiAgICAvLyByZXNldCBzbyB3ZSBkb250IHRyYWNrIF9zeXN0ZW0gb3IgX2VuY3J5cHRpb24KICAgIHRoaXMuc3RvcmUub3BlbmVkID0gW10KCiAgICB0aGlzLmhvc3RjYWxscyA9IG5ldyBQcml2YXRlQXBwbHlDYWxscyh0aGlzKQogICAgY29uc3QgdmlldyA9IHRoaXMuYmFzZS5faGFzT3BlbiA/IHRoaXMuYmFzZS5faGFuZGxlcnMub3Blbih0aGlzLnN0b3JlLCB0aGlzLmhvc3RjYWxscykgOiBudWxsCgogICAgdGhpcy52aWV3ID0gdmlldwogICAgdGhpcy5zeXN0ZW0gPSBzeXN0ZW0KCiAgICAvLyBlbnN1cmUgYWxsIGFyZSByZWFkeQogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuc3RvcmUub3BlbmVkKSBhd2FpdCB2LmF0b21pY0JhdGNoLnJlYWR5KCkKCiAgICB0aGlzLmtleSA9IHN5c3RlbS5jb3JlLmtleQoKICAgIHRoaXMuZmFzdEZvcndhcmRpbmcgPSBib290LmZhc3RGb3J3YXJkaW5nCiAgICB0aGlzLmluZGV4ZXJzVXBkYXRlZCA9IGJvb3QuaW5kZXhlcnNVcGRhdGVkCiAgICB0aGlzLnF1b3J1bSA9IHN5c0NvcmUubWFuaWZlc3QgPyBzeXNDb3JlLm1hbmlmZXN0LnF1b3J1bSA6IDAKCiAgICBjb25zdCBhZGRlZCA9IG5ldyBTZXQoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3lzdGVtLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHsga2V5LCBsZW5ndGggfSA9IHN5c3RlbS52aWV3c1tpXQogICAgICBjb25zdCB2ID0gYXdhaXQgdGhpcy5zdG9yZS5maW5kVmlld0J5S2V5KAogICAgICAgIGtleSwKICAgICAgICBzeXN0ZW0uaW5kZXhlcnMsCiAgICAgICAgc3lzQ29yZS5tYW5pZmVzdC52ZXJzaW9uLAogICAgICAgIHN5c3RlbS5lbnRyb3B5CiAgICAgICkKCiAgICAgIGlmICh2ID09PSBudWxsKSB7CiAgICAgICAgdGhpcy52aWV3cy5wdXNoKHsgbmFtZTogbnVsbCwga2V5LCBsZW5ndGgsIGNvcmU6IG51bGwsIHJlZjogbnVsbCwgbWFwcGVkSW5kZXg6IGkgfSkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBhd2FpdCB2LmF0b21pY0JhdGNoLnJlYWR5KCkKICAgICAgYXdhaXQgdi5jb3JlLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHRoaXMuYmFzZS5rZXkpCiAgICAgIGF3YWl0IHYuY29yZS5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvdmlldycsIGI0YS5mcm9tKHYubmFtZSkpCgogICAgICB0aGlzLnZpZXdzLnB1c2goeyBuYW1lOiB2Lm5hbWUsIGtleSwgbGVuZ3RoLCBjb3JlOiB2LmF0b21pY0JhdGNoLCByZWY6IHYsIG1hcHBlZEluZGV4OiBpIH0pCgogICAgICBhZGRlZC5hZGQodikKICAgIH0KCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5zdG9yZS5vcGVuZWQpIHsKICAgICAgaWYgKGFkZGVkLmhhcyh2KSkgY29udGludWUKICAgICAgY29uc3QgY29yZSA9IHYuYXRvbWljQmF0Y2gKCiAgICAgIHRoaXMudmlld3MucHVzaCh7CiAgICAgICAgbmFtZTogdi5uYW1lLAogICAgICAgIGtleTogY29yZS5rZXksCiAgICAgICAgbGVuZ3RoOiBjb3JlLmxlbmd0aCwKICAgICAgICBjb3JlLAogICAgICAgIHJlZjogdiwKICAgICAgICBtYXBwZWRJbmRleDogLTEKICAgICAgfSkKICAgIH0KCiAgICB0aGlzLmxvY2FsID0gdGhpcy5zdG9yZS5nZXRMb2NhbCgpCiAgICBhd2FpdCB0aGlzLmxvY2FsLnJlYWR5KCkKCiAgICB0aGlzLmxvY2FsU3RhdGUgPSBuZXcgTG9jYWxTdGF0ZSh0aGlzLmxvY2FsKQoKICAgIGxldCBpc0xvY2FsSW5kZXhlciA9IGZhbHNlCgogICAgY29uc3QgcGF1c2VkID0gdGhpcy5iYXNlLmlzRmFzdEZvcndhcmRpbmcoKQogICAgY29uc3QgaW5mID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8oKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mLmluZGV4ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGlkeCA9IGluZi5pbmRleGVyc1tpXQogICAgICBjb25zdCBjaGsgPSB0aGlzLl9jcmVhdGVDaGVja3BvaW50Q29yZShpZHgua2V5LCB0cnVlLCBpLCBwYXVzZWQpCiAgICAgIGF3YWl0IGNoay5yZWFkeSgpCiAgICAgIHRoaXMuY2hlY2twb2ludHMucHVzaChjaGspCiAgICAgIGlmIChiNGEuZXF1YWxzKGlkeC5rZXksIHRoaXMuYmFzZS5sb2NhbC5rZXkpKSBpc0xvY2FsSW5kZXhlciA9IHRydWUKICAgIH0KCiAgICBjb25zdCBzaG91bGRTaWduID0gdGhpcy5xdW9ydW0gPiAwICYmIGlzTG9jYWxJbmRleGVyCgogICAgaWYgKHNob3VsZFNpZ24pIHsKICAgICAgdGhpcy5sb2NhbEluZGV4ZXIgPSB0cnVlCiAgICAgIGF3YWl0IHRoaXMuX3N0YXJ0TG9jYWxDaGVja3BvaW50KCkKICAgIH0KCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCgogICAgLy8gZGVmZXJyZWQKICAgIHRoaXMubWF5YmVTaWduZWQoKS5jYXRjaChub29wKQogIH0KCiAgYXN5bmMgX3N0YXJ0TG9jYWxDaGVja3BvaW50KCkgewogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgewogICAgICBpZiAoY2hrLmNvcmUuaWQgPT09IHRoaXMuYmFzZS5sb2NhbC5pZCkgewogICAgICAgIHRoaXMubG9jYWxDaGVja3BvaW50ID0gY2hrCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmxvY2FsQ2hlY2twb2ludCA9IHRoaXMuX2NyZWF0ZUNoZWNrcG9pbnRDb3JlKHRoaXMuYmFzZS5sb2NhbC5rZXksIGZhbHNlLCAwLCBmYWxzZSkKICAgIGF3YWl0IHRoaXMubG9jYWxDaGVja3BvaW50LnJlYWR5KCkKICB9CgogIGludGVycnVwdCgpIHsKICAgIHRoaXMuaW50ZXJydXB0ZWQgPSB0cnVlCiAgICB0aGlzLnBhdXNlKCkKICB9CgogIHBhdXNlKCkgewogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgewogICAgICBpZiAoY2hrICE9PSB0aGlzLmxvY2FsQ2hlY2twb2ludCkgY2hrLnBhdXNlKCkKICAgIH0KICB9CgogIHJlc3VtZSgpIHsKICAgIGZvciAoY29uc3QgY2hrIG9mIHRoaXMuY2hlY2twb2ludHMpIHsKICAgICAgaWYgKGNoayAhPT0gdGhpcy5sb2NhbENoZWNrcG9pbnQpIGNoay5yZXN1bWUoKQogICAgfQogIH0KCiAgX2NoZWNrU3lzdGVtVXBncmFkZSgpIHsKICAgIGlmICh0aGlzLnN5c3RlbVVwZ3JhZGUpIHJldHVybgoKICAgIGNvbnN0IHRhbGx5ID0gbmV3IE1hcCgpCgogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgewogICAgICBpZiAoY2hrLnNpZ25lZExlbmd0aCgpIDw9IHRoaXMuc3lzdGVtLmNvcmUuc2lnbmVkTGVuZ3RoKSBjb250aW51ZQogICAgICBpZiAoIWNoay5kaWdlc3QpIGNvbnRpbnVlCgogICAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyhjaGsuZGlnZXN0LmtleSwgJ2hleCcpCiAgICAgIGNvbnN0IGNudCA9ICh0YWxseS5nZXQoaWQpIHx8IDApICsgMQoKICAgICAgaWYgKGNudCA+PSB0aGlzLnF1b3J1bSkgewogICAgICAgIHRoaXMuc3lzdGVtVXBncmFkZSA9IGNoay5kaWdlc3Qua2V5CiAgICAgICAgdGhpcy5iYXNlLl9xdWV1ZVN0YXRpY0Zhc3RGb3J3YXJkKHRoaXMuc3lzdGVtVXBncmFkZSkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgdGFsbHkuc2V0KGlkLCBjbnQpCiAgICB9CiAgfQoKICBtYXBJbmRleFRvVmlldyhpbmRleCkgewogICAgZm9yIChjb25zdCB7IG1hcHBlZEluZGV4LCByZWYgfSBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGlmIChtYXBwZWRJbmRleCA9PT0gaW5kZXgpIHJldHVybiByZWYKICAgIH0KICB9CgogIGFzeW5jIG1heWJlU2lnbmVkKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAodGhpcy5pbnRlcnJ1cHRlZCkgcmV0dXJuCgogICAgY29uc3QgdGhyZXMgPSB0aGlzLmNoZWNrcG9pbnRzLmxlbmd0aCAtIHRoaXMucXVvcnVtCiAgICBpZiAodGhyZXMgPCAwIHx8IHRoaXMuY2hlY2twb2ludHMubGVuZ3RoIDw9IHRocmVzKSByZXR1cm4KCiAgICB0aGlzLmNoZWNrcG9pbnRzLnNvcnQoY21wQ2hlY2twb2ludHMpCgogICAgY29uc3Qgc2lnbmFibGVMZW5ndGggPSB0aGlzLmNoZWNrcG9pbnRzW3RocmVzXS5zaWduZWRMZW5ndGgoKQogICAgaWYgKHNpZ25hYmxlTGVuZ3RoIDw9IHRoaXMuc3lzdGVtLmNvcmUuc2lnbmVkTGVuZ3RoKSByZXR1cm4KCiAgICBjb25zdCBleHBlY3RlZCA9IHRoaXMuc3lzdGVtLmNvcmUua2V5CgogICAgaWYgKHNpZ25hYmxlTGVuZ3RoID4gdGhpcy5pbmRleGVkTGVuZ3RoKSB7CiAgICAgIGlmICghYjRhLmVxdWFscyhleHBlY3RlZCwgdGhpcy5jaGVja3BvaW50c1t0aHJlc10uZGlnZXN0LmtleSkpIHRoaXMuX2NoZWNrU3lzdGVtVXBncmFkZSgpCiAgICAgIHRoaXMubmVlZHNJbmRleGVkTGVuZ3RoVXBkYXRlID0gdHJ1ZQogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKGxldCBpID0gdGhyZXM7IGkgPCB0aGlzLmNoZWNrcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNoayA9IHRoaXMuY2hlY2twb2ludHNbaV0KICAgICAgLy8gd2UgbXVzdCBhZ3JlZSBvbiB3aGF0IHRoZSBzeXN0ZW0gaXMgb2J2cwogICAgICBpZiAoIWI0YS5lcXVhbHMoZXhwZWN0ZWQsIGNoay5kaWdlc3Qua2V5KSkgewogICAgICAgIHRoaXMuX2NoZWNrU3lzdGVtVXBncmFkZSgpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgLy8gaWYgd2UgZG9udCBoYXZlIHRoZSBpbmRleGVkIHN0YXRlIG91cnNlbGYsIHRoZW4gbm8gd2F5IGZvciB1cyB0byB2ZXJpZnkgLyBwYXRjaAogICAgICBpZiAoIWNoay5zaWduYXR1cmVzLnN5c3RlbSB8fCBjaGsuc2lnbmF0dXJlcy5zeXN0ZW0ubGVuZ3RoID4gdGhpcy5pbmRleGVkTGVuZ3RoKSB7CiAgICAgICAgdGhpcy5uZWVkc0luZGV4ZWRMZW5ndGhVcGRhdGUgPSB0cnVlCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLm5lZWRzSW5kZXhlZExlbmd0aFVwZGF0ZSA9IGZhbHNlCgogICAgY29uc3QgY2hrID0gW10KICAgIGZvciAobGV0IGkgPSB0aHJlczsgaSA8IHRoaXMuY2hlY2twb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgY2hrLnB1c2goeyBzaWduZXI6IHRoaXMuY2hlY2twb2ludHNbaV0uc2lnbmVyLCBzaWduYXR1cmVzOiB0aGlzLmNoZWNrcG9pbnRzW2ldLnNpZ25hdHVyZXMgfSkKICAgIH0KCiAgICBjb25zdCB7IHN5c3RlbSB9ID0gdGhpcy5jaGVja3BvaW50c1t0aHJlc10uc2lnbmF0dXJlcwoKICAgIGF3YWl0IHRoaXMuX2Fzc2VtYmxlTXVsdGlzaWcoc3lzdGVtLmxlbmd0aCwgY2hrKQogIH0KCiAgYXN5bmMgX2Fzc2VtYmxlTXVsdGlzaWcoc2lnbmFibGVMZW5ndGgsIGNoZWNrcG9pbnRzKSB7CiAgICBjb25zdCB2aWV3cyA9IG5ldyBBcnJheSh0aGlzLnZpZXdzLmxlbmd0aCArIDIpIC8vICsyIGlzIHN5c3RlbSArIGVuY3J5cHRpb24KCiAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXRJbmRleGVkSW5mbyhzaWduYWJsZUxlbmd0aCkKCiAgICBpZiAodGhpcy5pbnRlcnJ1cHRlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMucGVuZGluZ1ZpZXdzICYmIHRoaXMucGVuZGluZ1ZpZXdzWzBdLmxlbmd0aCA+PSBzaWduYWJsZUxlbmd0aCkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB2aWV3c1swXSA9IGNyZWF0ZUNoZWNrcG9pbnRTaWduYXR1cmUoc2lnbmFibGVMZW5ndGgsIHRoaXMuc3lzdGVtVmlldywgY2hlY2twb2ludHMubGVuZ3RoKQoKICAgIGlmIChzeXMuZW5jcnlwdGlvbkxlbmd0aCkgewogICAgICB2aWV3c1sxXSA9IGNyZWF0ZUNoZWNrcG9pbnRTaWduYXR1cmUoCiAgICAgICAgc3lzLmVuY3J5cHRpb25MZW5ndGgsCiAgICAgICAgdGhpcy5lbmNyeXB0aW9uVmlldywKICAgICAgICBjaGVja3BvaW50cy5sZW5ndGgKICAgICAgKQogICAgfQoKICAgIGNvbnN0IG9mZnNldCA9IDIgLy8gc3lzdGVtICsgZW5jcnlwdGlvbgoKICAgIGZvciAobGV0IGkgPSBvZmZzZXQ7IGkgPCB2aWV3cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3c1tpIC0gb2Zmc2V0XQogICAgICBjb25zdCBjb3JlID0gdmlldy5jb3JlCgogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCBzeXMpCiAgICAgIGNvbnN0IGxlbmd0aCA9IHYgPyB2Lmxlbmd0aCA6IDAKCiAgICAgIGlmICghY29yZSB8fCBsZW5ndGggPD0gY29yZS5zaWduZWRMZW5ndGgpIGNvbnRpbnVlCgogICAgICBjb25zdCB2aWV3SW5kZXggPSB2aWV3Lm1hcHBlZEluZGV4ICsgb2Zmc2V0CiAgICAgIHZpZXdzW3ZpZXdJbmRleF0gPSBjcmVhdGVDaGVja3BvaW50U2lnbmF0dXJlKGxlbmd0aCwgdmlldywgY2hlY2twb2ludHMubGVuZ3RoKQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hlY2twb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgYWRkQ2hlY2twb2ludFNpZ25hdHVyZXModmlld3MsIGNoZWNrcG9pbnRzLCBpKQogICAgfQoKICAgIGNvbnN0IHByb21pc2VzID0gW10KICAgIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykgewogICAgICBpZiAoIXZpZXcpIGNvbnRpbnVlCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZpZXcuc2lnbmF0dXJlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb21pc2VzLnB1c2goc2V0UGFydGlhbFNpZ25hdHVyZSh2aWV3LCBpKSkKICAgICAgfQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQoKICAgIC8vIGNoZWNrIHRoYXQgdGhlIHN0YXRlIHN0aWxsIGxvb2tzIGdvb2QsIGNvdXBsZSByZXBsaWNhdGUgaW5iZXR3ZWVuLi4uCiAgICBmb3IgKGNvbnN0IHYgb2Ygdmlld3MpIHsKICAgICAgaWYgKCF2KSBjb250aW51ZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2LnNpZ25hdHVyZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIXYucGFydGlhbHNbaV0pIHJldHVybgogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuaW50ZXJydXB0ZWQpIHJldHVybgoKICAgIGlmICh0aGlzLnBlbmRpbmdWaWV3cyAmJiB0aGlzLnBlbmRpbmdWaWV3c1swXS5sZW5ndGggPj0gc2lnbmFibGVMZW5ndGgpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICAvLyBza2lwcGVkIHN5c3RlbSBmb3Igd2hhdGV2ZXIgcmVhc29uLi4uCiAgICBpZiAoIXZpZXdzWzBdKSByZXR1cm4KCiAgICB0aGlzLnBlbmRpbmdWaWV3cyA9IHZpZXdzCiAgICB0aGlzLmRpcnR5ID0gdHJ1ZQoKICAgIC8vIFRPRE86IG9ubHkgbmVlZGVkIGlmIG5vdCB1cGRhdGluZywgd29udCBjcmFzaCBzbyBrZWVwaW5nIGZvciBub3csIGp1c3QgbGVzcyBlZmZpY2llbnQKICAgIHRoaXMuYmFzZS5fcXVldWVCdW1wKCkKICB9CgogIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLmludGVycnVwdGVkKSByZXR1cm4KICAgIHJldHVybiB0aGlzLl9mcmVlKCkKICB9CgogIGFzeW5jIF9mcmVlKCkgewogICAgdGhpcy5pbnRlcnJ1cHRlZCA9IHRydWUKICAgIGlmICh0aGlzLmFwcGx5aW5nKSB0aGlzLl9wb3N0QXBwbHkoKQogICAgZm9yIChjb25zdCBjaGsgb2YgdGhpcy5jaGVja3BvaW50cykgYXdhaXQgY2hrLmNsb3NlKCkKICAgIGlmICh0aGlzLmxvY2FsQ2hlY2twb2ludCkgYXdhaXQgdGhpcy5sb2NhbENoZWNrcG9pbnQuY2xvc2UoKQogICAgaWYgKHRoaXMudmlldyAmJiB0aGlzLmJhc2UuX2hhc0Nsb3NlKSBhd2FpdCB0aGlzLmJhc2UuX2hhbmRsZXJzLmNsb3NlKHRoaXMudmlldykKICAgIGlmICh0aGlzLnN5c3RlbSkgYXdhaXQgdGhpcy5zeXN0ZW0uY2xvc2UoKQoKICAgIGNvbnN0IHByb21pc2VzID0gW10KICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGlmICh2LnJlZikgcHJvbWlzZXMucHVzaCh2LnJlZi5yZWxlYXNlKCkpCiAgICB9CgogICAgaWYgKHRoaXMuc3lzdGVtVmlldykgcHJvbWlzZXMucHVzaCh0aGlzLnN5c3RlbVZpZXcucmVmLnJlbGVhc2UoKSkKICAgIGlmICh0aGlzLmVuY3J5cHRpb25WaWV3KSBwcm9taXNlcy5wdXNoKHRoaXMuZW5jcnlwdGlvblZpZXcucmVmLnJlbGVhc2UoKSkKCiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICAgIGF3YWl0IHRoaXMuc3RvcmUuY2xvc2UoKQogIH0KCiAgX3B1c2hVcGRhdGUodSkgewogICAgdS52ZXJzaW9uID0gMQogICAgdS5zZXEgPSB0aGlzLnVwZGF0ZXMubGVuZ3RoID09PSAwID8gMCA6IHRoaXMudXBkYXRlc1t0aGlzLnVwZGF0ZXMubGVuZ3RoIC0gMV0uc2VxICsgMQogICAgdS5zeXN0ZW1MZW5ndGggPSB0aGlzLnN5c3RlbVZpZXcuY29yZS5sZW5ndGgKICAgIHRoaXMudXBkYXRlcy5wdXNoKHUpCiAgICB0aGlzLmxvY2FsU3RhdGUuaW5zZXJ0VXBkYXRlKHUpCiAgfQoKICBhc3luYyBjYXRjaHVwKGxpbmVhcml6ZXIpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKCF0aGlzLnN5c3RlbS5oZWFkcy5sZW5ndGgpIHJldHVybiB0cnVlCgogICAgY29uc3Qgd3JpdGVycyA9IG5ldyBNYXAoKQoKICAgIC8vIGxvYWQgbGluZWFyaXplci4uLgogICAgY29uc3QgdXBkYXRlcyA9IGF3YWl0IHRoaXMubG9jYWxTdGF0ZS5saXN0VXBkYXRlcygpCiAgICBjb25zdCBzeXMgPSBhd2FpdCB0aGlzLnN5c3RlbS5jaGVja291dCh0aGlzLmluZGV4ZWRMZW5ndGgpCgogICAgZm9yIChjb25zdCBub2RlIG9mIHVwZGF0ZXMpIHsKICAgICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKG5vZGUua2V5LCAnaGV4JykKCiAgICAgIGxldCB3ID0gd3JpdGVycy5nZXQoaGV4KQoKICAgICAgaWYgKHcgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIFRPRE86IHdlIGFjdHVhbGx5IGhhdmUgYWxsIHRoZSB3cml0ZXIgaW5mbyBhbHJlYWR5IGJ1dCBvdXIgY3VycmVudCBtZXRob2RzIG1ha2UgaXQgaGFyZCB0byByZXVzZSB0aGF0CiAgICAgICAgdyA9IGF3YWl0IHRoaXMuYmFzZS5fZ2V0V3JpdGVyQnlLZXkobm9kZS5rZXksIC0xLCAwLCB0cnVlLCBmYWxzZSwgc3lzKQogICAgICAgIHdyaXRlcnMuc2V0KGhleCwgdykKICAgICAgfQoKICAgICAgaWYgKHcubGVuZ3RoID49IG5vZGUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5iYXNlLl93YXJuKG5ldyBFcnJvcignVXBkYXRlIGV4cGVjdHMgd3JpdGVyIHRvIGJlIGNvbnN1bWVkIGhlcmUnKSkKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgd2hpbGUgKHcubGVuZ3RoIDwgbm9kZS5sZW5ndGgpIHsKICAgICAgICBhd2FpdCB3LnVwZGF0ZShzeXMpCgogICAgICAgIGNvbnN0IG5leHQgPSB3LmFkdmFuY2UoKQogICAgICAgIGlmICghbmV4dCkgewogICAgICAgICAgdGhpcy5iYXNlLl93YXJuKG5ldyBFcnJvcignTm9kZSBtdXN0IGV4aXN0IGZvciBjYXRjaHVwJykpCiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CgogICAgICAgIGxpbmVhcml6ZXIuYWRkSGVhZChuZXh0KQogICAgICB9CiAgICB9CgogICAgYXdhaXQgc3lzLmNsb3NlKCkKCiAgICB0aGlzLnVwZGF0ZXMgPSB1cGRhdGVzCgogICAgaWYgKHRoaXMuaW5kZXhlcnNVcGRhdGVkKSB7CiAgICAgIHRoaXMuaW5kZXhlcnNVcGRhdGVkID0gZmFsc2UKICAgICAgLy8gaWYgd2UgdXBkYXRlZCB0aGUgaW5kZXhlcnMsIGludmFsaWRhdGUgYWxsIHRoZSBpbnRlcm5hbCBzdGF0ZSBhbmQgcmVhcHBseSBpdAogICAgICBhd2FpdCB0aGlzLnRydW5jYXRlKHRoaXMuaW5kZXhlZExlbmd0aCkKICAgICAgYXdhaXQgdGhpcy5fcm9sbGJhY2tWaWV3cygpCgogICAgICBpZiAodGhpcy50eCA9PT0gbnVsbCkgdGhpcy50eCA9IHRoaXMubG9jYWwuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgICB3aGlsZSAoCiAgICAgICAgdGhpcy51cGRhdGVzLmxlbmd0aCA+IDAgJiYKICAgICAgICB0aGlzLnVwZGF0ZXNbdGhpcy51cGRhdGVzLmxlbmd0aCAtIDFdLnN5c3RlbUxlbmd0aCA+PSB0aGlzLmluZGV4ZWRMZW5ndGgKICAgICAgKSB7CiAgICAgICAgY29uc3QgdSA9IHRoaXMudXBkYXRlcy5wb3AoKQogICAgICAgIHRoaXMubG9jYWxTdGF0ZS5kZWxldGVVcGRhdGUodSkKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gb3RoZXJ3aXNlIHdlIGtub3cgdGhlIGludGVybmFsIHN0YXRlIGlzIGNvcnJlY3QsIHNvIHdlIGNhcnJ5IG9uCiAgICAgIGxpbmVhcml6ZXIudXBkYXRlKCkKICAgIH0KCiAgICAvLyBtdXN0IHJlZnJlc2ggdGhlIHdyaXRlcnMgaGVyZSBzbyBpc1JlbW92ZWQgaXMgdXAgdG8gZGF0ZQogICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGdldEluZGV4ZWRTeXN0ZW0oKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBjb25zdCBpbmRleGVkTGVuZ3RoID0gdGhpcy5wZW5kaW5nRm9yayA/IHRoaXMucGVuZGluZ0ZvcmsubGVuZ3RoIDogdGhpcy5pbmRleGVkTGVuZ3RoCgogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5zeXN0ZW0uY2hlY2tvdXQoaW5kZXhlZExlbmd0aCkKICAgIGF3YWl0IHN5cy5yZWFkeSgpCiAgICByZXR1cm4gc3lzCiAgfQoKICBnZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCBzeXMgPSB0aGlzLnN5c3RlbSkgewogICAgaWYgKHZpZXcubWFwcGVkSW5kZXggPT09IC0xIHx8IHZpZXcubWFwcGVkSW5kZXggPj0gc3lzLnZpZXdzLmxlbmd0aCkgcmV0dXJuIG51bGwKICAgIHJldHVybiBzeXMudmlld3Nbdmlldy5tYXBwZWRJbmRleF0KICB9CgogIGFzeW5jIHJlY292ZXJBdCgpIHsKICAgIGlmICghdGhpcy5zeXN0ZW1SZWYpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGF3YWl0IHRoaXMuc3lzdGVtUmVmLmNvcmUucmVhZHkoKQoKICAgIGNvbnN0IGx0ID0gdGhpcy5zeXN0ZW1SZWYuY29yZS5jb3JlLnN0YXRlLmxlbmd0aAoKICAgIGZvciBhd2FpdCAoY29uc3QgeyBsZW5ndGgsIGluZm8gfSBvZiBTeXN0ZW1WaWV3LmZsdXNoZXModGhpcy5zeXN0ZW1SZWYuY29yZS5zZXNzaW9uKCksIHsKICAgICAgcmV2ZXJzZTogdHJ1ZSwKICAgICAgbHQKICAgIH0pKSB7CiAgICAgIGxldCBjb25zaXN0ZW50ID0gdHJ1ZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmZvLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGkgPj0gdGhpcy52aWV3cy5sZW5ndGgpIGNvbnRpbnVlCiAgICAgICAgaWYgKCFiNGEuZXF1YWxzKGluZm8udmlld3NbaV0ua2V5LCB0aGlzLnZpZXdzW2ldLmtleSkpIGNvbnRpbnVlCgogICAgICAgIGlmIChpbmZvLnZpZXdzW2ldLmxlbmd0aCA+IHRoaXMudmlld3NbaV0uY29yZS5jb3JlLnN0YXRlLmxlbmd0aCkgewogICAgICAgICAgY29uc2lzdGVudCA9IGZhbHNlCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNvbnNpc3RlbnQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgZm9yY2U6IHRydWUsCiAgICAgICAgICBrZXk6IHRoaXMuc3lzdGVtLmNvcmUua2V5LAogICAgICAgICAgaW5kZXhlcnM6IGluZm8uaW5kZXhlcnMsCiAgICAgICAgICB2aWV3czogaW5mby52aWV3cwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBib290c3RyYXAoKSB7CiAgICByZXR1cm4gdGhpcy5zeXN0ZW0uYWRkKHRoaXMuYmFzZS5rZXksIHsgaXNJbmRleGVyOiB0cnVlLCBpc1BlbmRpbmc6IGZhbHNlIH0pCiAgfQoKICBhc3luYyB1bmRvKHBvcHBlZCkgewogICAgaWYgKCFwb3BwZWQpIHJldHVybgoKICAgIGxldCBpbmRleGVyc1VwZGF0ZWQgPSBmYWxzZQogICAgd2hpbGUgKHBvcHBlZCA+IDApIHsKICAgICAgY29uc3QgdSA9IHRoaXMudXBkYXRlcy5wb3AoKQogICAgICB0aGlzLmxvY2FsU3RhdGUuZGVsZXRlVXBkYXRlKHUpCiAgICAgIHBvcHBlZCAtPSB1LmJhdGNoCiAgICAgIGlmICh1LmluZGV4ZXJzKSBpbmRleGVyc1VwZGF0ZWQgPSB0cnVlCiAgICB9CgogICAgY29uc3QgdSA9IHRoaXMudXBkYXRlcy5sZW5ndGggPT09IDAgPyBudWxsIDogdGhpcy51cGRhdGVzW3RoaXMudXBkYXRlcy5sZW5ndGggLSAxXQogICAgY29uc3Qgc3lzdGVtTGVuZ3RoID0gdSA/IHUuc3lzdGVtTGVuZ3RoIDogdGhpcy5pbmRleGVkTGVuZ3RoCgogICAgYXdhaXQgdGhpcy50cnVuY2F0ZShzeXN0ZW1MZW5ndGgpCiAgICBpZiAoaW5kZXhlcnNVcGRhdGVkKSBhd2FpdCB0aGlzLl9yb2xsYmFja1ZpZXdzKCkKICB9CgogIGFzeW5jIHRydW5jYXRlKHN5c3RlbUxlbmd0aCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAoc3lzdGVtTGVuZ3RoID09PSB0aGlzLnN5c3RlbS5jb3JlLmxlbmd0aCkgcmV0dXJuCgogICAgYXdhaXQgdGhpcy5zeXN0ZW0uY29yZS50cnVuY2F0ZShzeXN0ZW1MZW5ndGgpCgogICAgY29uc3QgbWlncmF0ZWQgPSBhd2FpdCB0aGlzLnN5c3RlbS51cGRhdGUoKQoKICAgIGlmICh0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUubGVuZ3RoICE9PSB0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoKSB7CiAgICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvblZpZXcuY29yZS50cnVuY2F0ZSh0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoKQogICAgfQoKICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGlmICghdmlldy5jb3JlKSBjb250aW51ZQoKICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0Vmlld0Zyb21TeXN0ZW0odmlldykKCiAgICAgIGlmICh2ICYmIHZpZXcuY29yZS5sZW5ndGggPT09IHYubGVuZ3RoKSBjb250aW51ZQogICAgICBpZiAodiA9PT0gbnVsbCkgdmlldy5tYXBwZWRJbmRleCA9IC0xIC8vIHVubWFwCgogICAgICBhd2FpdCB2aWV3LmNvcmUudHJ1bmNhdGUodiA/IHYubGVuZ3RoIDogMCkKICAgIH0KCiAgICBpZiAoIW1pZ3JhdGVkKSByZXR1cm4KCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCiAgICBhd2FpdCB0aGlzLl9yb2xsYmFja1ZpZXdzKCkKICB9CgogIGFzeW5jIF9yZWZyZXNoV3JpdGVycygpIHsKICAgIC8vIFRPRE86IGFkZCB0aGUgc2VxIGF0IHdoaWNoIHdlIHVwZGF0ZWQgdGhlIHN0YXRlIHRvIHRoZSB3cml0ZXIgaW5zdGFuY2UuCiAgICAvLyB0aGVuIHdlIGtub3cgaWYgaXQgd2FzIHRydW5jYXRlZCBvdXQgd2l0aG91dCB0aGUgbG9va3VwLCBtZWFuaW5nIGZhc3RlciB0cnVuY2F0aW9ucwogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuYmFzZS5hY3RpdmVXcml0ZXJzKSB7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnN5c3RlbS5nZXQody5jb3JlLmtleSkKICAgICAgY29uc3QgYm9vdHN0cmFwcGVyID0gdGhpcy5zeXN0ZW0uY29yZS5sZW5ndGggPT09IDAgJiYgYjRhLmVxdWFscyh3LmNvcmUua2V5LCB0aGlzLmJhc2Uua2V5KQogICAgICBjb25zdCBpc1JlbW92ZWQgPSBkYXRhID8gZGF0YS5pc1JlbW92ZWQgOiAhYm9vdHN0cmFwcGVyCiAgICAgIHcuaXNSZW1vdmVkID0gaXNSZW1vdmVkCiAgICB9CiAgfQoKICBhc3luYyBfdXBkYXRlU3lzdGVtKCkgewogICAgaWYgKCEoYXdhaXQgdGhpcy5zeXN0ZW0udXBkYXRlKCkpKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuX3JlZnJlc2hXcml0ZXJzKCkKICAgIGF3YWl0IHRoaXMuX3JvbGxiYWNrVmlld3MoKQogIH0KCiAgYXN5bmMgX3NpZ25WaWV3Q29yZShjb3JlLCBsZW5ndGgpIHsKICAgIGNvbnN0IHMgPSBhd2FpdCBjb3JlLnNpZ25hYmxlKGxlbmd0aCwgMCkKICAgIGNvbnN0IHNpZ25hdHVyZSA9IGNyeXB0by5zaWduKHMsIHRoaXMuYmFzZS5sb2NhbC5rZXlQYWlyLnNlY3JldEtleSkKICAgIHJldHVybiB7IHNpZ25hdHVyZSwgbGVuZ3RoIH0KICB9CgogIGFzeW5jIF9zaWduSW50ZXJuYWxWaWV3Q29yZXMoc3lzKSB7CiAgICByZXR1cm4gewogICAgICBzeXN0ZW06IGF3YWl0IHRoaXMuX3NpZ25WaWV3Q29yZSh0aGlzLnN5c3RlbVZpZXcuY29yZSwgdGhpcy5zeXN0ZW1WaWV3LmluZGV4ZWRMZW5ndGgpLAogICAgICBlbmNyeXB0aW9uOiBhd2FpdCB0aGlzLl9zaWduVmlld0NvcmUodGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLCBzeXMuZW5jcnlwdGlvbkxlbmd0aCkKICAgIH0KICB9CgogIGFzeW5jIF9zaWduVXNlclZpZXdDb3JlcyhzeXMpIHsKICAgIGNvbnN0IHByb21pc2VzID0gbmV3IEFycmF5KHN5cy52aWV3cy5sZW5ndGgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnZpZXdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXdzW2ldCgogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCBzeXMpCiAgICAgIGNvbnN0IGluZGV4ZWRMZW5ndGggPSB2ID8gdi5sZW5ndGggOiAwCgogICAgICBpZiAoIWluZGV4ZWRMZW5ndGgpIGNvbnRpbnVlCgogICAgICBjb25zdCB2aWV3SW5kZXggPSB2aWV3Lm1hcHBlZEluZGV4CiAgICAgIHByb21pc2VzW3ZpZXdJbmRleF0gPSB0aGlzLl9zaWduVmlld0NvcmUodmlldy5yZWYuYXRvbWljQmF0Y2gsIGluZGV4ZWRMZW5ndGgpCiAgICB9CgogICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKQogIH0KCiAgYXN5bmMgZmluYWxpemUoa2V5KSB7CiAgICB0aGlzLmxvY2FsU3RhdGUuc2V0Qm9vdFJlY29yZCh7CiAgICAgIHZlcnNpb246IEJPT1RfUkVDT1JEX1ZFUlNJT04sCiAgICAgIGtleSwKICAgICAgc3lzdGVtTGVuZ3RoOiB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCwKICAgICAgaW5kZXhlcnNVcGRhdGVkOiB0cnVlLAogICAgICBmYXN0Rm9yd2FyZGluZzogZmFsc2UsCiAgICAgIHJlY292ZXJpZXM6IHRoaXMuYmFzZS5yZWNvdmVyaWVzCiAgICB9KQoKICAgIGF3YWl0IHRoaXMubG9jYWxTdGF0ZS5mbHVzaCgpCgogICAgYXdhaXQgdGhpcy5zdG9yZS5mbHVzaCgpCiAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICB9CgogIGFzeW5jIF9mbHVzaChsb2NhbE5vZGVzKSB7CiAgICBpZiAobG9jYWxOb2RlcykgYXdhaXQgdGhpcy5fYXBwZW5kTG9jYWxOb2Rlcyhsb2NhbE5vZGVzKQoKICAgIHRoaXMubG9jYWxTdGF0ZS5zZXRCb290UmVjb3JkKHsKICAgICAgdmVyc2lvbjogQk9PVF9SRUNPUkRfVkVSU0lPTiwKICAgICAga2V5OiB0aGlzLmtleSwKICAgICAgc3lzdGVtTGVuZ3RoOiB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCwKICAgICAgaW5kZXhlcnNVcGRhdGVkOiBmYWxzZSwKICAgICAgZmFzdEZvcndhcmRpbmc6IGZhbHNlLAogICAgICByZWNvdmVyaWVzOiB0aGlzLmJhc2UucmVjb3ZlcmllcwogICAgfSkKCiAgICBhd2FpdCB0aGlzLmxvY2FsU3RhdGUuZmx1c2goKQoKICAgIGlmICh0aGlzLmxvY2FsQ2hlY2twb2ludCkgewogICAgICAvLyB3ZSBoYXZlIHRvIGZsdXNoIGhlcmUgc28gdGhlIGNoa3BvaW50IGNhbiB1cGRhdGUKICAgICAgLy8gY291bGQgcnVuIHRoZSBjaGVja3BvaW50IG9uIHRoZSBiYXRjaCBidXQgYWxzbyBubyBiaWcgZGVhZAogICAgICAvLyBhcyB0aGUgInNob3VsZCB3ZSBzaWduIiBjaGVjayBpcyByZXJ1biBvbiBib290Li4uCiAgICAgIGF3YWl0IHRoaXMuc3RvcmUuZmx1c2goKQogICAgICBhd2FpdCB0aGlzLmxvY2FsQ2hlY2twb2ludC51cGRhdGUoKQogICAgfQoKICAgIGlmICh0aGlzLnBlbmRpbmdWaWV3cykgewogICAgICBjb25zdCB2aWV3cyA9IHRoaXMucGVuZGluZ1ZpZXdzCiAgICAgIHRoaXMucGVuZGluZ1ZpZXdzID0gbnVsbAoKICAgICAgZm9yIChsZXQgaSA9IHZpZXdzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgdiA9IHZpZXdzW2ldCiAgICAgICAgaWYgKCF2IHx8IHYubGVuZ3RoIDw9IHYuY29yZS5zaWduZWRMZW5ndGgpIGNvbnRpbnVlCiAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gdi5jb3JlLmNvcmUudmVyaWZpZXIuYXNzZW1ibGUodi5wYXJ0aWFscykKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgdi5yZWYuY29tbWl0KHRoaXMuc3RvcmUuYXRvbSwgdi5sZW5ndGgsIHNpZ25hdHVyZSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIC8vIFRPRE86IHdlIHNob3VsZCBwcmV2YWxpZGF0ZSBhbGwgc2lnbmF0dXJlcyBpbnN0ZWFkIG9mIGR1cmluZyBjb21taXQgc28gaXQgY2FuIGJlIGFsbCBvciBub3RoaW5nLCBqdXN0IHNsaWdobHkKICAgICAgICAgIC8vIGZyaWVuZGxpZXIgdXguIG1pc3NpbmcgaGMgYXBpIGZvciB0aGF0CiAgICAgICAgICBpZiAoIXRoaXMuYmFzZS5jbG9zaW5nKSB0aGlzLmJhc2UuX3dhcm4oZXJyKQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCB0aGlzLnN0b3JlLmZsdXNoKCkKCiAgICB0aGlzLmZhc3RGb3J3YXJkaW5nID0gZmFsc2UKICAgIGlmICh0aGlzLnBlbmRpbmdWaWV3cyA9PT0gbnVsbCkgdGhpcy5kaXJ0eSA9IGZhbHNlCiAgfQoKICBfaW5kZXhVcGRhdGVzKGluZGV4ZWQpIHsKICAgIGxldCBzaGlmdCA9IDAKICAgIHdoaWxlIChpbmRleGVkID4gMCkgaW5kZXhlZCAtPSB0aGlzLnVwZGF0ZXNbc2hpZnQrK10uYmF0Y2gKCiAgICBjb25zdCBsYXN0ID0gdGhpcy51cGRhdGVzW3NoaWZ0IC0gMV0KCiAgICB0aGlzLnN5c3RlbVZpZXcuaW5kZXhlZExlbmd0aCA9IGxhc3Quc3lzdGVtTGVuZ3RoCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaGlmdDsgaSsrKSB0aGlzLmxvY2FsU3RhdGUuZGVsZXRlVXBkYXRlKHRoaXMudXBkYXRlc1tpXSkKICAgIHRoaXMudXBkYXRlcy5zcGxpY2UoMCwgc2hpZnQpCgogICAgaWYgKCF0aGlzLm5lZWRzSW5kZXhlZExlbmd0aFVwZGF0ZSkgcmV0dXJuCiAgICB0aGlzLm1heWJlU2lnbmVkKCkuY2F0Y2gobm9vcCkKICB9CgogIHBlbmRpbmdJbmRleGVkTGVuZ3RoKCkgewogICAgbGV0IGluZGV4ZWQgPSB0aGlzLmFwcGx5aW5nLmluZGV4ZWQubGVuZ3RoCiAgICBpZiAoIXRoaXMuYXBwbHlpbmcgfHwgIXRoaXMudXBkYXRlcy5sZW5ndGggfHwgIWluZGV4ZWQpIHJldHVybiB0aGlzLmluZGV4ZWRMZW5ndGgKCiAgICBsZXQgcG9zID0gMAogICAgd2hpbGUgKGluZGV4ZWQgPiAwICYmIHBvcyA8IHRoaXMudXBkYXRlcy5sZW5ndGgpIHsKICAgICAgaW5kZXhlZCAtPSB0aGlzLnVwZGF0ZXNbcG9zKytdLmJhdGNoCiAgICB9CgogICAgY29uc3QgbGFzdCA9IHRoaXMudXBkYXRlc1twb3MgLSAxXQogICAgcmV0dXJuIGxhc3Quc3lzdGVtTGVuZ3RoCiAgfQoKICBhc3luYyBfYXNzZXJ0Tm9kZShub2RlLCBiYXRjaCkgewogICAgLy8gaGVscGZ1bCBkYWcgaGVscGVyLCBzbyBrZXB0IGhlcmUKCiAgICBjb25zdCB2ID0gKGF3YWl0IHRoaXMuc3lzdGVtLmdldChub2RlLndyaXRlci5jb3JlLmtleSkpIHx8IHsgbGVuZ3RoOiAwLCBpc1JlbW92ZWQ6IGZhbHNlIH0KICAgIGNvbnN0IGV4cGVjdGVkID0gdi5sZW5ndGggKyBiYXRjaAogICAgaWYgKG5vZGUubGVuZ3RoID09PSBleHBlY3RlZCkgcmV0dXJuCgogICAgY29uc29sZS50cmFjZSgKICAgICAgJ0lOVkFMSURfSU5TRVJUSU9OJywKICAgICAgJ2xlbmd0aD0nLAogICAgICBub2RlLmxlbmd0aCwKICAgICAgJ2tleT0nLAogICAgICBub2RlLndyaXRlci5jb3JlLmtleSwKICAgICAgJ2xvY2FsPScsCiAgICAgIG5vZGUud3JpdGVyLmNvcmUud3JpdGFibGUsCiAgICAgICdiYXRjaD0nLAogICAgICBiYXRjaCwKICAgICAgJ2RhZz0nLAogICAgICB2CiAgICApCgogICAgcHJvY2Vzcy5leGl0KDEpCiAgfQoKICBfcG9zdEFwcGx5KCkgewogICAgdGhpcy5hcHBseUJhdGNoID0gdGhpcy5hcHBseWluZyA9IG51bGwKICAgIHRoaXMuYmFzZS5fcG9zdEFwcGx5KCkKICB9CgogIGFzeW5jIF9vcHRpbWlzdGljQXBwbHkodSwgbm9kZSwgaW5kZXhlZCkgewogICAgY29uc3QgY2hlY2twb2ludCA9IHRoaXMuc3lzdGVtLmNoZWNrcG9pbnQoKQoKICAgIHRoaXMuc3lzdGVtLmFkZEhlYWQobm9kZSkKCiAgICBjb25zdCBhcHBseUJhdGNoID0gW10KICAgIGNvbnN0IGtleSA9IG5vZGUud3JpdGVyLmNvcmUua2V5CgogICAgYXBwbHlCYXRjaC5wdXNoKHsKICAgICAgaW5kZXhlZCwKICAgICAgb3B0aW1pc3RpYzogdHJ1ZSwKICAgICAgZnJvbTogbm9kZS53cml0ZXIuY29yZSwKICAgICAgbGVuZ3RoOiBub2RlLmxlbmd0aCwKICAgICAgdmFsdWU6IG5vZGUudmFsdWUsCiAgICAgIGhlYWRzOiBub2RlLmFjdHVhbEhlYWRzCiAgICB9KQoKICAgIGNvbnN0IHByZSA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldChrZXkpCiAgICBjb25zdCBwcmVMZW5ndGggPSBwcmUgPyBwcmUubGVuZ3RoIDogMAoKICAgIGxldCBmYWlsZWQgPSBmYWxzZQoKICAgIHRoaXMuYXBwbHlpbmcgPSB1CiAgICB0aGlzLmFwcGx5QmF0Y2ggPSBhcHBseUJhdGNoCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmJhc2UuX2hhbmRsZXJzLmFwcGx5KGFwcGx5QmF0Y2gsIHRoaXMudmlldywgdGhpcy5ob3N0Y2FsbHMpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuYmFzZS5jbG9zaW5nKSB0aHJvdyBlcnIKICAgICAgZmFpbGVkID0gdHJ1ZQogICAgfQogICAgdGhpcy5fcG9zdEFwcGx5KCkKCiAgICBpZiAoIWZhaWxlZCkgewogICAgICBjb25zdCBwb3N0ID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0KGtleSkKICAgICAgLy8gY2hlY2sgaWYgYWNrZWQgYnkgYWRkV3JpdGVyL3JlbW92ZVdyaXRlci9hY2tXcml0ZXIKICAgICAgaWYgKCFwb3N0IHx8IHByZUxlbmd0aCA9PT0gcG9zdC5sZW5ndGgpIGZhaWxlZCA9IHRydWUKICAgIH0KCiAgICBpZiAoIWZhaWxlZCkgewogICAgICAvLyB0ZWNobmljYWxseSB3ZSBvbmx5IG5lZWQgdG8gdG8gdGhpcyBpcyB0aGUgd3JpdGVyIHdhcyByZW1vdmVkLCBidXQgaGV5LCB0cmlja3kgbG9naWMKICAgICAgYXdhaXQgdGhpcy5fcmVmcmVzaFdyaXRlcnMoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIC8vIGl0IGZhaWxlZCEgcm9sbGJhY2suLi4KCiAgICB0aGlzLnN5c3RlbS5hcHBseUNoZWNrcG9pbnQoY2hlY2twb2ludCkKCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uVmlldy5jb3JlLmxlbmd0aCAhPT0gdGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCkgewogICAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUudHJ1bmNhdGUodGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy52aWV3cykgewogICAgICBjb25zdCB2aWV3TGVuZ3RoID0gdmlldy5jb3JlID8gdmlldy5jb3JlLmxlbmd0aCA6IHZpZXcubGVuZ3RoCiAgICAgIGNvbnN0IHZpZXdMb29rdXAgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcpCiAgICAgIGNvbnN0IHZpZXdTeXN0ZW1MZW5ndGggPSB2aWV3TG9va3VwID8gdmlld0xvb2t1cC5sZW5ndGggOiAwCiAgICAgIGlmICh2aWV3U3lzdGVtTGVuZ3RoID09PSB2aWV3TGVuZ3RoKSBjb250aW51ZQogICAgICBhd2FpdCB2aWV3LmNvcmUudHJ1bmNhdGUodmlld1N5c3RlbUxlbmd0aCkKICAgIH0KCiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoV3JpdGVycygpCgogICAgYXdhaXQgdGhpcy5fcm9sbGJhY2tWaWV3cygpCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9zdGFydFRyYWNlKG5vZGUpIHsKICAgIHRoaXMuc3lzdGVtUmVmLnRyYWNlci5zdGFydCgpCiAgICB0aGlzLmVuY3J5cHRpb25WaWV3LnJlZi50cmFjZXIuc3RhcnQoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnZpZXdzLmxlbmd0aDsgaSsrKSB0aGlzLnZpZXdzW2ldLnJlZi50cmFjZXIuc3RhcnQoKQogIH0KCiAgX2VuZFRyYWNlKG5vZGUpIHsKICAgIGNvbnN0IHRyYWNlID0gewogICAgICBzeXN0ZW06IHRoaXMuc3lzdGVtUmVmLnRyYWNlci5lbmQoKSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5lbmNyeXB0aW9uVmlldy5yZWYudHJhY2VyLmVuZCgpLAogICAgICB1c2VyOiBbXQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy52aWV3cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBibG9ja3MgPSB0aGlzLnZpZXdzW2ldLnJlZi50cmFjZXIuZW5kKCkKICAgICAgaWYgKGJsb2Nrcy5sZW5ndGgpIHRyYWNlLnVzZXIucHVzaCh7IHZpZXc6IGksIGJsb2NrcyB9KQogICAgfQoKICAgIGlmICh0cmFjZS5zeXN0ZW0ubGVuZ3RoIHx8IHRyYWNlLmVuY3J5cHRpb24ubGVuZ3RoIHx8IHRyYWNlLnVzZXIubGVuZ3RoKSBub2RlLnRyYWNlID0gdHJhY2UKICB9CgogIGFzeW5jIHVwZGF0ZSh1LCBsb2NhbE5vZGVzKSB7CiAgICBpZiAodGhpcy5jaGFuZ2VzICE9PSBudWxsKSB0aGlzLmNoYW5nZXMudHJhY2sodGhpcykKCiAgICBsZXQgYmF0Y2ggPSAwCiAgICBsZXQgYXBwbHlCYXRjaCA9IFtdCiAgICBsZXQgaW5kZXhlcnNVcGRhdGVkID0gMAoKICAgIGxldCBqID0gMAogICAgbGV0IGkgPSAwCiAgICBsZXQgZm9ya2VkQXQgPSAtMQoKICAgIHdoaWxlIChpIDwgTWF0aC5taW4odS5pbmRleGVkLmxlbmd0aCwgdS5zaGFyZWQpKSB7CiAgICAgIGNvbnN0IG5vZGUgPSB1LmluZGV4ZWRbaSsrXQoKICAgICAgaWYgKG5vZGUuYmF0Y2ggPiAxKSBjb250aW51ZQogICAgICB0aGlzLmJhc2UuX3NoaWZ0V3JpdGVyKG5vZGUud3JpdGVyKQoKICAgICAgY29uc3QgdXBkYXRlID0gdGhpcy51cGRhdGVzW2orK10KCiAgICAgIGlmICh1cGRhdGUuaW5kZXhlcnMpIHsKICAgICAgICBpbmRleGVyc1VwZGF0ZWQgPSBpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICh1LnVuZG8pIGF3YWl0IHRoaXMudW5kbyh1LnVuZG8pCgogICAgaWYgKHRoaXMuc3lzdGVtLmJvb3RzdHJhcHBpbmcpIGF3YWl0IHRoaXMuYm9vdHN0cmFwKCkKCiAgICBhd2FpdCB0aGlzLl91cGRhdGVTeXN0ZW0oKQoKICAgIC8vIE9yZ2FuaXplIGJ5IHZpZXcKICAgIGNvbnN0IHdhcm11cFN5c3RlbVZpZXcgPSBbXQogICAgY29uc3Qgd2FybXVwRW5jcnlwdGlvblZpZXcgPSBbXQogICAgY29uc3Qgd2FybXVwVXNlclZpZXcgPSBuZXcgQXJyYXkodGhpcy52aWV3cy5sZW5ndGgpCgogICAgZm9yIChsZXQgayA9IHUuc2hhcmVkOyBrIDwgdS5sZW5ndGg7IGsrKykgewogICAgICBjb25zdCBpbmRleGVkID0gayA8IHUuaW5kZXhlZC5sZW5ndGgKICAgICAgY29uc3Qgbm9kZSA9IGluZGV4ZWQgPyB1LmluZGV4ZWRba10gOiB1LnRpcFtrIC0gdS5pbmRleGVkLmxlbmd0aF0KICAgICAgaWYgKCFub2RlLnRyYWNlKSBjb250aW51ZQoKICAgICAgaWYgKG5vZGUudHJhY2Uuc3lzdGVtLmxlbmd0aCkgd2FybXVwU3lzdGVtVmlldy5wdXNoKC4uLm5vZGUudHJhY2Uuc3lzdGVtKQogICAgICBpZiAobm9kZS50cmFjZS5lbmNyeXB0aW9uLmxlbmd0aCkgd2FybXVwRW5jcnlwdGlvblZpZXcucHVzaCguLi5ub2RlLnRyYWNlLmVuY3J5cHRpb24pCgogICAgICBmb3IgKGNvbnN0IHRyYWNlIG9mIG5vZGUudHJhY2UudXNlcikgewogICAgICAgIC8vIEFzc2VydCAoYXMgd2FybmluZykgdGhhdCB0cmFjZSB2aWV3IHNob3VsZCBvbmx5IGJlIGN1cnJlbnRseSBpbmRleGVkIHZpZXdzCiAgICAgICAgaWYgKHRyYWNlLnZpZXcgPj0gdGhpcy52aWV3cy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAgICAgJ09wbG9nIGJsb2NrIHRyYWNlIGNvbnRhaW5zIE9PQiB2aWV3IGluZGV4JywKICAgICAgICAgICAgJ3RyYWNlIHZpZXcnLAogICAgICAgICAgICB0cmFjZS52aWV3LAogICAgICAgICAgICAndmlld3MubGVuZ3RoJywKICAgICAgICAgICAgdGhpcy52aWV3cy5sZW5ndGgKICAgICAgICAgICkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICB3YXJtdXBVc2VyVmlld1t0cmFjZS52aWV3XSA9IHdhcm11cFVzZXJWaWV3W3RyYWNlLnZpZXddIHx8IFtdCiAgICAgICAgd2FybXVwVXNlclZpZXdbdHJhY2Uudmlld10ucHVzaCguLi50cmFjZS5ibG9ja3MpCiAgICAgIH0KICAgIH0KCiAgICAvLyBSZXF1ZXN0IHBlciB2aWV3CiAgICBpZiAod2FybXVwU3lzdGVtVmlldy5sZW5ndGgpIHRoaXMuc3lzdGVtVmlldy5jb3JlLmRvd25sb2FkKHsgYmxvY2tzOiB3YXJtdXBTeXN0ZW1WaWV3IH0pCiAgICBpZiAod2FybXVwRW5jcnlwdGlvblZpZXcubGVuZ3RoKQogICAgICB0aGlzLmVuY3J5cHRpb25WaWV3LmNvcmUuZG93bmxvYWQoeyBibG9ja3M6IHdhcm11cEVuY3J5cHRpb25WaWV3IH0pCiAgICBmb3IgKGxldCBrID0gMDsgayA8IHdhcm11cFVzZXJWaWV3Lmxlbmd0aDsgaysrKSB7CiAgICAgIGNvbnN0IGJsb2NrcyA9IHdhcm11cFVzZXJWaWV3W2tdCiAgICAgIGlmICghYmxvY2tzKSBjb250aW51ZQoKICAgICAgY29uc3QgdmlldyA9IHRoaXMudmlld3Nba10KICAgICAgdmlldy5jb3JlLmRvd25sb2FkKHsgYmxvY2tzIH0pCiAgICB9CgogICAgZm9yIChpID0gdS5zaGFyZWQ7IGkgPCB1Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLmJhc2UuYmFja29mZiAhPT0gbnVsbCAmJiB0aGlzLmJhc2UuYmFja29mZi5iYWNrb2ZmKCkpIGF3YWl0IHRoaXMuYmFzZS5iYWNrb2ZmLndhaXQoKQoKICAgICAgY29uc3QgaW5kZXhlZCA9IGkgPCB1LmluZGV4ZWQubGVuZ3RoCiAgICAgIGNvbnN0IG5vZGUgPSBpbmRleGVkID8gdS5pbmRleGVkW2ldIDogdS50aXBbaSAtIHUuaW5kZXhlZC5sZW5ndGhdCgogICAgICBiYXRjaCsrCgogICAgICBpZiAobm9kZS53cml0ZXIuY29yZS53cml0YWJsZSkgdGhpcy5fc3RhcnRUcmFjZShub2RlKQoKICAgICAgY29uc3Qgb3B0aW1pc3QgPQogICAgICAgIG5vZGUud3JpdGVyLmlzUmVtb3ZlZCAmJgogICAgICAgIG5vZGUub3B0aW1pc3RpYyAmJgogICAgICAgIGJhdGNoID09PSAxICYmCiAgICAgICAgdGhpcy5iYXNlLl9oYXNPcHRpbWlzdGljQXBwbHkgPT09IHRydWUgJiYKICAgICAgICAoYXdhaXQgdGhpcy5fb3B0aW1pc3RpY0FwcGx5KHUsIG5vZGUsIGluZGV4ZWQpKQoKICAgICAgaWYgKCFvcHRpbWlzdCkgewogICAgICAgIGlmIChub2RlLndyaXRlci5pc1JlbW92ZWQgJiYgIW5vZGUud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgewogICAgICAgICAgaWYgKG5vZGUuYmF0Y2ggPiAxKSBjb250aW51ZQogICAgICAgICAgLy8gaW4gY2FzZSBzb21lb25lIGlzIGxpbmtpbmcgdGhpcyBub2RlIGFuZCB0aGV5IGFyZSBub3QgcmVtb3ZlZAogICAgICAgICAgY29uc3QgdSA9IHsKICAgICAgICAgICAgc2VxOiAwLAogICAgICAgICAgICBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LAogICAgICAgICAgICBsZW5ndGg6IG5vZGUubGVuZ3RoLAogICAgICAgICAgICBiYXRjaCwKICAgICAgICAgICAgc3lzdGVtTGVuZ3RoOiAwLAogICAgICAgICAgICBpbmRleGVyczogZmFsc2UKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3B1c2hVcGRhdGUodSkKICAgICAgICAgIGJhdGNoID0gMAogICAgICAgICAgYXNzZXJ0KGFwcGx5QmF0Y2gubGVuZ3RoID09PSAwLCAnQXBwbHkgYmF0Y2ggc2hvdWxkIG5vdCBoYXZlIGJlZW4gbW9kaWZpZWQnKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIC8vIGluIHByb2Qgd2UgcHJvcCBuZWVkIHRvIGRpc2FibGUgdGhpcyBhc3NlcnRpb24gYXMgaXRzIHByZXR0eSBleHBlbnNpdmUsCiAgICAgICAgLy8gYnV0IGl0IGNhdGNoZXMgYSBsb3Qgb2YgYnVncywgc28gaGVyZSBmb3IgZGVidWdzCiAgICAgICAgLy8gYXdhaXQgdGhpcy5fYXNzZXJ0Tm9kZShub2RlLCBiYXRjaCkKCiAgICAgICAgY29uc3QgZGVwcyA9IG5vZGUuY2F1c2FsRGVwZW5kZW5jaWVzKCkKCiAgICAgICAgLy8gb2xkZXN0IC0+IG5ld2VzdAogICAgICAgIGZvciAobGV0IGkgPSBkZXBzLmxlbmd0aCAtIDE7IGkgPj0gMTsgaS0tKSB7CiAgICAgICAgICBjb25zdCBkID0gZGVwc1tpXQogICAgICAgICAgaWYgKGF3YWl0IHRoaXMuc3lzdGVtLmxpbmthYmxlKGQud3JpdGVyLmNvcmUua2V5LCBkLmxlbmd0aCkpIHsKICAgICAgICAgICAgdGhpcy5zeXN0ZW0uYWRkSGVhZChkZXBzW2ldKQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5zeXN0ZW0uYWRkSGVhZChkZXBzWzBdKQoKICAgICAgICBpZiAobm9kZS52YWx1ZSAhPT0gbnVsbCAmJiAhbm9kZS53cml0ZXIuaXNSZW1vdmVkKSB7CiAgICAgICAgICBhcHBseUJhdGNoLnB1c2goewogICAgICAgICAgICBpbmRleGVkLAogICAgICAgICAgICBvcHRpbWlzdGljOiBmYWxzZSwKICAgICAgICAgICAgZnJvbTogbm9kZS53cml0ZXIuY29yZSwKICAgICAgICAgICAgbGVuZ3RoOiBub2RlLmxlbmd0aCwKICAgICAgICAgICAgdmFsdWU6IG5vZGUudmFsdWUsCiAgICAgICAgICAgIGhlYWRzOiBub2RlLmFjdHVhbEhlYWRzCiAgICAgICAgICB9KQogICAgICAgIH0KCiAgICAgICAgaWYgKG5vZGUuYmF0Y2ggPiAxKSBjb250aW51ZQoKICAgICAgICBpZiAoYXBwbHlCYXRjaC5sZW5ndGggJiYgdGhpcy5iYXNlLl9oYXNBcHBseSA9PT0gdHJ1ZSkgewogICAgICAgICAgdGhpcy5hcHBseWluZyA9IHUKICAgICAgICAgIHRoaXMuYXBwbHlCYXRjaCA9IGFwcGx5QmF0Y2gKICAgICAgICAgIGF3YWl0IHRoaXMuYmFzZS5faGFuZGxlcnMuYXBwbHkoYXBwbHlCYXRjaCwgdGhpcy52aWV3LCB0aGlzLmhvc3RjYWxscykKICAgICAgICAgIGlmIChmb3JrZWRBdCA9PT0gLTEgJiYgdGhpcy5wZW5kaW5nRm9yaykgZm9ya2VkQXQgPSBpCiAgICAgICAgICB0aGlzLl9wb3N0QXBwbHkoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdXBkYXRlID0gewogICAgICAgIHNlcTogMCwKICAgICAgICBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LAogICAgICAgIGxlbmd0aDogbm9kZS5sZW5ndGgsCiAgICAgICAgYmF0Y2gsCiAgICAgICAgc3lzdGVtTGVuZ3RoOiAwLAogICAgICAgIGluZGV4ZXJzOiBmYWxzZQogICAgICB9CgogICAgICB1cGRhdGUuaW5kZXhlcnMgPSAhIXRoaXMuc3lzdGVtLmluZGV4ZXJVcGRhdGUKCiAgICAgIGlmICh0aGlzLnN5c3RlbS5pbmRleGVyVXBkYXRlKSBhd2FpdCB0aGlzLl9nZW5lcmF0ZU5leHRWaWV3cygpCgogICAgICBhd2FpdCB0aGlzLnN5c3RlbS5mbHVzaCh0aGlzLnZpZXdzKQogICAgICBhd2FpdCB0aGlzLnN5c3RlbS51cGRhdGUoKQoKICAgICAgaWYgKG5vZGUud3JpdGVyLmNvcmUud3JpdGFibGUpIHRoaXMuX2VuZFRyYWNlKG5vZGUpCgogICAgICBiYXRjaCA9IDAKICAgICAgYXBwbHlCYXRjaCA9IFtdCgogICAgICB0aGlzLl9wdXNoVXBkYXRlKHVwZGF0ZSkKCiAgICAgIGlmICghaW5kZXhlZCB8fCBpbmRleGVyc1VwZGF0ZWQpIGNvbnRpbnVlCgogICAgICB0aGlzLmJhc2UuX3NoaWZ0V3JpdGVyKG5vZGUud3JpdGVyKQoKICAgICAgaWYgKHVwZGF0ZS5pbmRleGVycykgewogICAgICAgIGluZGV4ZXJzVXBkYXRlZCA9IGkgKyAxCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5wZW5kaW5nRm9yaykgewogICAgICBjb25zdCBwZW5kaW5nID0gdGhpcy5wZW5kaW5nRm9yawogICAgICBpZiAocGVuZGluZy5sZW5ndGggPiB0aGlzLmluZGV4ZWRMZW5ndGgpIHRoaXMuX2luZGV4VXBkYXRlcyh1LmluZGV4ZWQubGVuZ3RoKQoKICAgICAgY29uc3QgZm9yayA9IG5ldyBGb3JrKHRoaXMuYmFzZSwgdGhpcy5zdG9yZSwgdGhpcywgcGVuZGluZykKICAgICAgY29uc3QgZm9ya2VkID0gYXdhaXQgZm9yay51cGdyYWRlKCkKCiAgICAgIGlmICghZm9ya2VkKSB0aHJvdyBuZXcgRXJyb3IoJ0ZvcmsgZmFpbGVkJykKCiAgICAgIGF3YWl0IHRoaXMuX2ZsdXNoKGxvY2FsTm9kZXMpCgogICAgICByZXR1cm4gewogICAgICAgIHJlYm9vdDogdHJ1ZSwKICAgICAgICBtaWdyYXRlZDogZmFsc2UKICAgICAgfQogICAgfQoKICAgIGlmICh1LmluZGV4ZWQubGVuZ3RoKSB7CiAgICAgIHRoaXMuX2luZGV4VXBkYXRlcyhpbmRleGVyc1VwZGF0ZWQgfHwgdS5pbmRleGVkLmxlbmd0aCkKICAgIH0KCiAgICBjb25zdCBtaWdyYXRlZCA9IGluZGV4ZXJzVXBkYXRlZCAhPT0gMAogICAgaWYgKG1pZ3JhdGVkKSB0aGlzLmtleSA9IGF3YWl0IHRoaXMuYmFzZS5fcHJlbWlncmF0ZSgpCgogICAgaWYgKHRoaXMuY2hhbmdlcyAhPT0gbnVsbCkgewogICAgICB0aGlzLmNoYW5nZXMuZmluYWxpc2UoKQogICAgICBhd2FpdCB0aGlzLmJhc2UuX2hhbmRsZXJzLnVwZGF0ZSh0aGlzLnZpZXcsIHRoaXMuY2hhbmdlcykKICAgIH0KCiAgICBhd2FpdCB0aGlzLl9mbHVzaChsb2NhbE5vZGVzKQoKICAgIHJldHVybiB7CiAgICAgIHJlYm9vdDogbWlncmF0ZWQsCiAgICAgIG1pZ3JhdGVkCiAgICB9CiAgfQoKICBmbHVzaCgpIHsKICAgIHJldHVybiB0aGlzLl9mbHVzaChudWxsKQogIH0KCiAgYXN5bmMgX2FwcGVuZExvY2FsTm9kZXMobG9jYWxOb2RlcykgewogICAgaWYgKGxvY2FsTm9kZXMubGVuZ3RoID09PSAwKSByZXR1cm4gLy8ganVzdCBpbiBjYXNlCgogICAgY29uc3QgYmxvY2tzID0gbmV3IEFycmF5KGxvY2FsTm9kZXMubGVuZ3RoKQogICAgY29uc3QgbG9jYWwgPSB0aGlzLmxvY2FsCgogICAgaWYgKCFsb2NhbC5vcGVuZWQpIGF3YWl0IGxvY2FsLnJlYWR5KCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IHZhbHVlLCBoZWFkcywgYmF0Y2gsIG9wdGltaXN0aWMsIHRyYWNlIH0gPSBsb2NhbE5vZGVzW2ldCgogICAgICBibG9ja3NbaV0gPSB7CiAgICAgICAgdmVyc2lvbjogT1BMT0dfVkVSU0lPTiwKICAgICAgICBtYXhTdXBwb3J0ZWRWZXJzaW9uOiB0aGlzLmJhc2UubWF4U3VwcG9ydGVkVmVyc2lvbiwKICAgICAgICBjaGVja3BvaW50OiBudWxsLAogICAgICAgIGRpZ2VzdDogbnVsbCwKICAgICAgICBvcHRpbWlzdGljLAogICAgICAgIG5vZGU6IHsKICAgICAgICAgIGhlYWRzLAogICAgICAgICAgYmF0Y2gsCiAgICAgICAgICB2YWx1ZTogdmFsdWUgPT09IG51bGwgPyBudWxsIDogYy5lbmNvZGUodGhpcy5iYXNlLnZhbHVlRW5jb2RpbmcsIHZhbHVlKQogICAgICAgIH0sCiAgICAgICAgdHJhY2UKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmxvY2FsSW5kZXhlcikgewogICAgICBjb25zdCBzaWduZWRMZW5ndGggPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5zaWduZWRMZW5ndGgoKQogICAgICBjb25zdCBsb2NhbCA9IHRoaXMubG9jYWwKCiAgICAgIGxldCBzaWduZWRBdCA9IDAKICAgICAgbGV0IGludGVybmFsU2lnbmF0dXJlcyA9IG51bGwKICAgICAgbGV0IHNpZ25hdHVyZXMgPSBudWxsCgogICAgICBpZiAodGhpcy5pbmRleGVkTGVuZ3RoID4gc2lnbmVkTGVuZ3RoKSB7CiAgICAgICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5zeXN0ZW0uZ2V0SW5kZXhlZEluZm8odGhpcy5pbmRleGVkTGVuZ3RoKQogICAgICAgIGludGVybmFsU2lnbmF0dXJlcyA9IGF3YWl0IHRoaXMuX3NpZ25JbnRlcm5hbFZpZXdDb3JlcyhzeXMpCiAgICAgICAgc2lnbmF0dXJlcyA9IGF3YWl0IHRoaXMuX3NpZ25Vc2VyVmlld0NvcmVzKHN5cykKICAgICAgICBzaWduZWRBdCA9IGxvY2FsLmxlbmd0aCArIGJsb2Nrcy5sZW5ndGgKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBsb2NhbC5sZW5ndGggKyBpICsgMQogICAgICAgIGlmIChsZW5ndGggPT09IHNpZ25lZEF0KSB7CiAgICAgICAgICB0aGlzLmxvY2FsQ2hlY2twb2ludC51cGRhdGVJbnRlcm5hbFNpZ25hdHVyZXMobGVuZ3RoLCBpbnRlcm5hbFNpZ25hdHVyZXMpCiAgICAgICAgICB0aGlzLmxvY2FsQ2hlY2twb2ludC51cGRhdGVVc2VyU2lnbmF0dXJlcyhsZW5ndGgsIHNpZ25hdHVyZXMpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBibGsgPSBibG9ja3NbaV0KCiAgICAgICAgYmxrLmNoZWNrcG9pbnQgPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5tYWtlQ2hlY2twb2ludHMobGVuZ3RoKQogICAgICAgIGJsay5kaWdlc3QgPSB0aGlzLmxvY2FsQ2hlY2twb2ludC5tYWtlRGlnZXN0KGxlbmd0aCwgdGhpcy5rZXkpCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICghdGhpcy5sb2NhbENoZWNrcG9pbnQpIGF3YWl0IHRoaXMuX3N0YXJ0TG9jYWxDaGVja3BvaW50KCkKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gbG9jYWwubGVuZ3RoICsgaSArIDEKICAgICAgICBibG9ja3NbaV0uZGlnZXN0ID0gdGhpcy5sb2NhbENoZWNrcG9pbnQubWFrZURpZ2VzdChsZW5ndGgsIHRoaXMua2V5KQogICAgICB9CiAgICB9CgogICAgYXdhaXQgbG9jYWwuYXBwZW5kKGJsb2NrcykKICB9CgogIGFzeW5jIF9yb2xsYmFja1ZpZXdzKCkgewogICAgLy8gZW5jcnlwdGlvbiB2aWV3IGtleSBpcyBub3QgaW4gc3lzdGVtIHNvIG5vIG5lZWQgdG8gaGFuZGxlIGhlcmUKICAgIGZvciAoY29uc3QgdmlldyBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLmdldFZpZXdGcm9tU3lzdGVtKHZpZXcpCgogICAgICBpZiAodikgewogICAgICAgIHZpZXcua2V5ID0gdi5rZXkKICAgICAgfSBlbHNlIHsKICAgICAgICBhd2FpdCB0aGlzLl9yZXNldFZpZXcodmlldykKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgY3JlYXRlQW5jaG9yKCkgewogICAgY29uc3Qgbm9kZSA9IHRoaXMuYXBwbHlCYXRjaFt0aGlzLmFwcGx5QmF0Y2gubGVuZ3RoIC0gMV0KICAgIGNvbnN0IGtleSA9IG5vZGUuZnJvbS5rZXkKICAgIGNvbnN0IGxlbmd0aCA9IG5vZGUubGVuZ3RoCgogICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuc3lzdGVtLmdldChrZXksIHsgdW5mbHVzaGVkOiB0cnVlIH0pCgogICAgaWYgKCFpbmZvIHx8IGluZm8ubGVuZ3RoIDwgbGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ0FuY2hvciBub2RlIGlzIG5vdCBpbiBzeXN0ZW0nKQoKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiA0MCwgYnVmZmVyOiBiNGEuYWxsb2MoNDApIH0KICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGtleSkKICAgIGMudWludDY0LmVuY29kZShzdGF0ZSwgbGVuZ3RoKQoKICAgIGNvbnN0IG5hbWVzcGFjZSA9IGNyeXB0by5oYXNoKHN0YXRlLmJ1ZmZlcikKICAgIGNvbnN0IG1hbmlmZXN0RGF0YSA9IGMuZW5jb2RlKG1lc3NhZ2VzLk1hbmlmZXN0RGF0YSwgeyB2ZXJzaW9uOiAwLCBsZWdhY3lCbG9ja3M6IDAsIG5hbWVzcGFjZSB9KQoKICAgIGNvbnN0IHBhZGRpbmcgPSB0aGlzLmVuY3J5cHRpb24gPyBBdXRvYmFzZUVuY3J5cHRpb24uUEFERElORyA6IDAKICAgIGNvbnN0IGJsb2NrID0gZW5jb2RlVmFsdWUobnVsbCwgeyBoZWFkczogW3sga2V5LCBsZW5ndGggfV0sIHBhZGRpbmcgfSkKICAgIGlmICh0aGlzLmVuY3J5cHRpb24pIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5lbmNyeXB0QW5jaG9yKGJsb2NrLCBuYW1lc3BhY2UpCgogICAgY29uc3Qgcm9vdCA9IHsgaW5kZXg6IDAsIHNpemU6IGJsb2NrLmJ5dGVMZW5ndGgsIGhhc2g6IGNyeXB0by5kYXRhKGJsb2NrKSB9CiAgICBjb25zdCBoYXNoID0gY3J5cHRvLnRyZWUoW3Jvb3RdKQogICAgY29uc3QgcHJvbG9ndWUgPSB7IGhhc2gsIGxlbmd0aDogMSB9CgogICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuY3JlYXRlQW5jaG9yQ29yZShwcm9sb2d1ZSwgbWFuaWZlc3REYXRhKQogICAgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgaWYgKGNvcmUubGVuZ3RoID09PSAwKSBhd2FpdCBjb3JlLmFwcGVuZChibG9jaywgeyB3cml0YWJsZTogdHJ1ZSwgbWF4TGVuZ3RoOiAxIH0pCgogICAgYXdhaXQgdGhpcy5zeXN0ZW0uYWRkKGNvcmUua2V5LCB7IGlzSW5kZXhlcjogZmFsc2UsIGxlbmd0aDogMCB9KQogICAgYXdhaXQgdGhpcy5iYXNlLl9hZGRXcml0ZXIoY29yZS5rZXksIHRoaXMuc3lzdGVtKQoKICAgIGNvbnN0IGFuY2hvciA9IHsga2V5OiBjb3JlLmtleSwgbGVuZ3RoOiBjb3JlLmxlbmd0aCB9CgogICAgYXdhaXQgY29yZS5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLmJhc2UuaGludFdha2V1cChhbmNob3IpCgogICAgcmV0dXJuIGFuY2hvcgogIH0KCiAgYXN5bmMgX3Jlc2V0Vmlldyh2aWV3KSB7CiAgICBjb25zdCBtYW5pZmVzdHMgPSBhd2FpdCB0aGlzLnN0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHModGhpcy5zeXN0ZW0uaW5kZXhlcnMpCgogICAgY29uc3QgbWFuaWZlc3REYXRhID0gdmlldy5jb3JlID8gdmlldy5jb3JlLm1hbmlmZXN0LnVzZXJEYXRhIDogbnVsbAogICAgdmlldy5rZXkgPSBhd2FpdCB0aGlzLnN0b3JlLmNyZWF0ZVZpZXcoCiAgICAgIG1hbmlmZXN0cywKICAgICAgdmlldy5uYW1lLAogICAgICBudWxsLAogICAgICB0aGlzLnN5c3RlbS5jb3JlLm1hbmlmZXN0LnZlcnNpb24sCiAgICAgIHRoaXMuc3lzdGVtLmVudHJvcHksCiAgICAgIG51bGwsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKSAvLyB3aWxsIG5ldmVyIGJlIHN5c3RlbSBzbyBubyBsaW5rZWQKICAgIHZpZXcubGVuZ3RoID0gMAogIH0KCiAgYXN5bmMgX2dlbmVyYXRlTmV4dFZpZXdzKCkgewogICAgY29uc3Qgc3lzID0gdGhpcy5zeXN0ZW0KCiAgICAvLyBub3RlLCB0aGlzIGlzIHZlcnkgc3RhdGUgZGVwZW5kZW50IHNvIGNhbiBPTkxZIGJlIGNhbGxlZCBhdCB0aGUgZXhhY3QgdGltZSBhbiBpbmRleGVyIHVwZ3JhZGUgb2NjdXJzCiAgICBjb25zdCBtYW5pZmVzdHMgPSBhd2FpdCB0aGlzLnN0b3JlLmdldEluZGV4ZXJNYW5pZmVzdHMoc3lzLmluZGV4ZXJzKQogICAgY29uc3QgZW50cm9weSA9IHN5cy52ZXJzaW9uIDwgMiA/IG51bGwgOiBzeXMuZ2V0RW50cm9weShzeXMuaW5kZXhlcnMsIHN5cy5mbHVzaExlbmd0aCgpKQoKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnZpZXdzKSB7CiAgICAgIGNvbnN0IG1hbmlmZXN0RGF0YSA9IHYuY29yZSA/IHYuY29yZS5tYW5pZmVzdC51c2VyRGF0YSA6IG51bGwKCiAgICAgIGNvbnN0IHByb2xvZ3VlID0gYXdhaXQgZ2V0UHJvbG9ndWUodikKICAgICAgY29uc3Qga2V5ID0gYXdhaXQgdGhpcy5zdG9yZS5jcmVhdGVWaWV3KAogICAgICAgIG1hbmlmZXN0cywKICAgICAgICB2Lm5hbWUsCiAgICAgICAgcHJvbG9ndWUsCiAgICAgICAgc3lzLmNvcmUubWFuaWZlc3QudmVyc2lvbiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIG51bGwsCiAgICAgICAgbWFuaWZlc3REYXRhCiAgICAgICkKCiAgICAgIHYua2V5ID0ga2V5CiAgICB9CiAgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRQcm9sb2d1ZSh2aWV3KSB7CiAgY29uc3QgbGVuZ3RoID0gdmlldy5jb3JlID8gdmlldy5jb3JlLmxlbmd0aCA6IHZpZXcubGVuZ3RoCiAgaWYgKCFsZW5ndGgpIHJldHVybiBudWxsCgogIGNvbnN0IGhhc2ggPSBhd2FpdCB2aWV3LmNvcmUudHJlZUhhc2gobGVuZ3RoKQoKICByZXR1cm4gewogICAgaGFzaCwKICAgIGxlbmd0aAogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBjbXBDaGVja3BvaW50cyhhLCBiKSB7CiAgcmV0dXJuIGEuc2lnbmVkTGVuZ3RoKCkgLSBiLnNpZ25lZExlbmd0aCgpCn0KCmZ1bmN0aW9uIHNhbWVTaWduYXR1cmUoYSwgYikgewogIGlmICghYSB8fCAhYikgcmV0dXJuIGEgPT09IGIKICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoCn0KCmZ1bmN0aW9uIHNhbWVTaWduYXR1cmVzKGEsIGIpIHsKICBpZiAoIWEgfHwgIWIpIHJldHVybiBhID09PSBiCiAgaWYgKGEubGVuZ3RoICE9PSBiLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoYVtpXS5sZW5ndGggIT09IGJbaV0ubGVuZ3RoKSByZXR1cm4gZmFsc2UKICB9CiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gY3JlYXRlQ2hlY2twb2ludFNpZ25hdHVyZShsZW5ndGgsIHZpZXcsIGNoZWNrcG9pbnRzKSB7CiAgcmV0dXJuIHsKICAgIGxlbmd0aCwKICAgIGNvcmU6IHZpZXcuY29yZSwKICAgIHJlZjogdmlldy5yZWYsCiAgICBzaWduYXR1cmVzOiBuZXcgQXJyYXkoY2hlY2twb2ludHMpLAogICAgcGFydGlhbHM6IG5ldyBBcnJheShjaGVja3BvaW50cykKICB9Cn0KCmZ1bmN0aW9uIGFkZENoZWNrcG9pbnRTaWduYXR1cmVzKHBlbmRpbmcsIGNoZWNrcG9pbnRzLCBpbmRleCkgewogIGNvbnN0IHsgc2lnbmVyLCBzaWduYXR1cmVzIH0gPSBjaGVja3BvaW50c1tpbmRleF0KCiAgcGVuZGluZ1swXS5zaWduYXR1cmVzW2luZGV4XSA9IHsKICAgIHNpZ25hdHVyZTogc2lnbmF0dXJlcy5zeXN0ZW0uc2lnbmF0dXJlLAogICAgbGVuZ3RoOiBzaWduYXR1cmVzLnN5c3RlbS5sZW5ndGgsCiAgICBzaWduZXIKICB9CgogIGlmIChwZW5kaW5nWzFdKSB7CiAgICBwZW5kaW5nWzFdLnNpZ25hdHVyZXNbaW5kZXhdID0gewogICAgICBzaWduYXR1cmU6IHNpZ25hdHVyZXMuZW5jcnlwdGlvbi5zaWduYXR1cmUsCiAgICAgIGxlbmd0aDogc2lnbmF0dXJlcy5lbmNyeXB0aW9uLmxlbmd0aCwKICAgICAgc2lnbmVyCiAgICB9CiAgfQoKICBmb3IgKGxldCBpID0gMjsgaSA8IHBlbmRpbmcubGVuZ3RoOyBpKyspIHsKICAgIGlmICghcGVuZGluZ1tpXSkgY29udGludWUKCiAgICBjb25zdCB7IGxlbmd0aCwgc2lnbmF0dXJlIH0gPSBzaWduYXR1cmVzLnVzZXJbaSAtIDJdCgogICAgcGVuZGluZ1tpXS5zaWduYXR1cmVzW2luZGV4XSA9IHsKICAgICAgc2lnbmF0dXJlLAogICAgICBsZW5ndGgsCiAgICAgIHNpZ25lcgogICAgfQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gc2V0UGFydGlhbFNpZ25hdHVyZSh2aWV3LCBpbmRleCkgewogIGNvbnN0IHNpZyA9IHZpZXcuc2lnbmF0dXJlc1tpbmRleF0KICBpZiAoc2lnLmxlbmd0aCA8IHZpZXcubGVuZ3RoICYmIHNpZy5sZW5ndGggPiAwKSBhd2FpdCB2aWV3LmNvcmUuZ2V0KHNpZy5sZW5ndGggLSAxKQoKICB2aWV3LnBhcnRpYWxzW2luZGV4XSA9IGF3YWl0IHBhcnRpYWxTaWduYXR1cmUoCiAgICB2aWV3LmNvcmUsCiAgICBzaWcuc2lnbmVyLAogICAgdmlldy5sZW5ndGgsCiAgICBzaWcubGVuZ3RoLAogICAgc2lnLnNpZ25hdHVyZQogICkKfQoKZnVuY3Rpb24gdXBkYXRlU2lnbmF0dXJlKGxlbmd0aCwgc2lnLCBleGlzdGluZykgewogIHJldHVybiBzaWcgPyB7IHNpZ25hdHVyZTogc2lnLnNpZ25hdHVyZSwgbGVuZ3RoOiBzaWcubGVuZ3RoLCBhdDogbGVuZ3RoIH0gOiBleGlzdGluZwp9CgpmdW5jdGlvbiB1cGRhdGVTaWduYXR1cmVzKGxlbmd0aCwgc2lnbmF0dXJlcywgZXhpc3RpbmcpIHsKICBjb25zdCB1cGRhdGVkID0gbmV3IEFycmF5KHNpZ25hdHVyZXMubGVuZ3RoKQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHVwZGF0ZWQubGVuZ3RoOyBpKyspIHsKICAgIHVwZGF0ZWRbaV0gPSB1cGRhdGVTaWduYXR1cmUobGVuZ3RoLCBzaWduYXR1cmVzW2ldLCBpIDwgZXhpc3RpbmcubGVuZ3RoID8gZXhpc3RpbmdbaV0gOiBudWxsKQogIH0KCiAgcmV0dXJuIHVwZGF0ZWQKfQoKZnVuY3Rpb24gbWFrZUNoZWNrcG9pbnQobGVuZ3RoLCBjaGspIHsKICBpZiAoIWNoaykgcmV0dXJuIG51bGwKCiAgY29uc3QgY2hlY2twb2ludGVyID0gbGVuZ3RoIC0gY2hrLmF0CgogIHJldHVybiB7CiAgICBjaGVja3BvaW50ZXIsCiAgICBjaGVja3BvaW50OiBjaGVja3BvaW50ZXIgPT09IDAgPyB7IHNpZ25hdHVyZTogY2hrLnNpZ25hdHVyZSwgbGVuZ3RoOiBjaGsubGVuZ3RoIH0gOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBtYWtlQ2hlY2twb2ludHMobGVuZ3RoLCBzaWduYXR1cmVzKSB7CiAgaWYgKCFzaWduYXR1cmVzLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgY29uc3QgY2hlY2twb2ludHMgPSBuZXcgQXJyYXkoc2lnbmF0dXJlcy5sZW5ndGgpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgc2lnbmF0dXJlcy5sZW5ndGg7IGkrKykgewogICAgY2hlY2twb2ludHNbaV0gPSBtYWtlQ2hlY2twb2ludChsZW5ndGgsIHNpZ25hdHVyZXNbaV0pCiAgfQoKICByZXR1cm4gY2hlY2twb2ludHMKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IG1lc3NhZ2VzID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCgptb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uIGJvb3QoCiAgY29yZXN0b3JlLAogIGtleSwKICB7IGVuY3J5cHQsIGVuY3J5cHRpb25LZXksIGtleVBhaXIsIGV4Y2x1c2l2ZSA9IHRydWUgfSA9IHt9CikgewogIGNvbnN0IHJlc3VsdCA9IHsKICAgIGtleTogbnVsbCwKICAgIGxvY2FsOiBudWxsLAogICAgYm9vdHN0cmFwOiBudWxsLAogICAgZW5jcnlwdGlvbktleTogbnVsbCwKICAgIGJvb3Q6IG51bGwKICB9CgogIGNvbnN0IG1hbmlmZXN0ID0ga2V5UGFpcgogICAgPyB7IHZlcnNpb246IGNvcmVzdG9yZS5tYW5pZmVzdFZlcnNpb24sIHNpZ25lcnM6IFt7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXkgfV0gfQogICAgOiBudWxsCgogIGlmIChrZXkpIHsKICAgIHJlc3VsdC5rZXkgPSBrZXkKCiAgICBjb25zdCBib290c3RyYXAgPSBjb3Jlc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IGZhbHNlLCB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UgfSkKICAgIGF3YWl0IGJvb3RzdHJhcC5yZWFkeSgpCgogICAgY29uc3QgbG9jYWxLZXkgPSBhd2FpdCBib290c3RyYXAuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2xvY2FsJykKCiAgICBpZiAoa2V5UGFpcikgewogICAgICByZXN1bHQubG9jYWwgPSBjb3Jlc3RvcmUuZ2V0KHsKICAgICAgICBrZXlQYWlyLAogICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgZXhjbHVzaXZlLAogICAgICAgIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSwKICAgICAgICBtYW5pZmVzdAogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgaWYgKGJvb3RzdHJhcC53cml0YWJsZSAmJiAhbG9jYWxLZXkpIHsKICAgICAgICByZXN1bHQubG9jYWwgPSBib290c3RyYXAuc2Vzc2lvbih7CiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgfSkKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBsb2NhbCA9IGxvY2FsS2V5CiAgICAgICAgICA/IGNvcmVzdG9yZS5nZXQoewogICAgICAgICAgICAgIGtleTogbG9jYWxLZXksCiAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgICAgIH0pCiAgICAgICAgICA6IGNvcmVzdG9yZS5nZXQoewogICAgICAgICAgICAgIG5hbWU6ICdsb2NhbCcsCiAgICAgICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgICAgIH0pCgogICAgICAgIGF3YWl0IGxvY2FsLnJlYWR5KCkKICAgICAgICByZXN1bHQubG9jYWwgPSBsb2NhbAogICAgICB9CiAgICB9CgogICAgcmVzdWx0LmJvb3RzdHJhcCA9IGJvb3RzdHJhcAogIH0gZWxzZSB7CiAgICByZXN1bHQubG9jYWwgPSBrZXlQYWlyCiAgICAgID8gY29yZXN0b3JlLmdldCh7CiAgICAgICAgICBrZXlQYWlyLAogICAgICAgICAgbWFuaWZlc3QsCiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgfSkKICAgICAgOiBjb3Jlc3RvcmUuZ2V0KHsKICAgICAgICAgIG5hbWU6ICdsb2NhbCcsCiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgZXhjbHVzaXZlLAogICAgICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlCiAgICAgICAgfSkKICAgIGF3YWl0IHJlc3VsdC5sb2NhbC5yZWFkeSgpCgogICAgY29uc3Qga2V5ID0gYXdhaXQgcmVzdWx0LmxvY2FsLmdldFVzZXJEYXRhKCdyZWZlcnJlcicpCiAgICBpZiAoa2V5KSB7CiAgICAgIHJlc3VsdC5rZXkgPSBrZXkKICAgICAgcmVzdWx0LmJvb3RzdHJhcCA9IGNvcmVzdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UsIHZhbHVlRW5jb2Rpbmc6IG1lc3NhZ2VzLk9wbG9nTWVzc2FnZSB9KQogICAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnJlYWR5KCkKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5rZXkgPSByZXN1bHQubG9jYWwua2V5CiAgICAgIHJlc3VsdC5ib290c3RyYXAgPSByZXN1bHQubG9jYWwuc2Vzc2lvbih7CiAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICB2YWx1ZUVuY29kaW5nOiBtZXNzYWdlcy5PcGxvZ01lc3NhZ2UKICAgICAgfSkKICAgICAgYXdhaXQgcmVzdWx0LmJvb3RzdHJhcC5zZXRVc2VyRGF0YSgnYXV0b2Jhc2UvbG9jYWwnLCByZXN1bHQubG9jYWwua2V5KQogICAgfQogIH0KCiAgaWYgKGtleSB8fCBrZXlQYWlyKSB7CiAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnNldFVzZXJEYXRhKCdyZWZlcnJlcicsIHJlc3VsdC5rZXkpCiAgICBhd2FpdCByZXN1bHQuYm9vdHN0cmFwLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9sb2NhbCcsIHJlc3VsdC5sb2NhbC5rZXkpCiAgICBhd2FpdCByZXN1bHQubG9jYWwuc2V0VXNlckRhdGEoJ3JlZmVycmVyJywgcmVzdWx0LmtleSkKICB9CgogIGNvbnN0IFtlbmNyeXB0aW9uS2V5QnVmZmVyLCBwb2ludGVyXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgIHJlc3VsdC5sb2NhbC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvZW5jcnlwdGlvbicpLAogICAgcmVzdWx0LmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS9ib290JykKICBdKQoKICBpZiAocG9pbnRlcikgewogICAgcmVzdWx0LmJvb3QgPSBjLmRlY29kZShtZXNzYWdlcy5Cb290UmVjb3JkLCBwb2ludGVyKQogIH0KCiAgaWYgKGVuY3J5cHRpb25LZXlCdWZmZXIpIHsKICAgIHJlc3VsdC5lbmNyeXB0aW9uS2V5ID0gZW5jcnlwdGlvbktleUJ1ZmZlcgogIH0KCiAgaWYgKCFyZXN1bHQuZW5jcnlwdGlvbktleSAmJiAoZW5jcnlwdGlvbktleSB8fCBlbmNyeXB0KSkgewogICAgaWYgKCFlbmNyeXB0aW9uS2V5KQogICAgICBlbmNyeXB0aW9uS2V5ID0gKGF3YWl0IGNvcmVzdG9yZS5jcmVhdGVLZXlQYWlyKCdhdXRvYmFzZS9lbmNyeXB0aW9uJykpLnNlY3JldEtleS5zdWJhcnJheSgKICAgICAgICAwLAogICAgICAgIDMyCiAgICAgICkKICAgIGF3YWl0IHJlc3VsdC5ib290c3RyYXAuc2V0VXNlckRhdGEoJ2F1dG9iYXNlL2VuY3J5cHRpb24nLCBlbmNyeXB0aW9uS2V5KSAvLyBsZWdhY3kgc3VwcG9ydAogICAgYXdhaXQgcmVzdWx0LmxvY2FsLnNldFVzZXJEYXRhKCdhdXRvYmFzZS9lbmNyeXB0aW9uJywgZW5jcnlwdGlvbktleSkKICAgIHJlc3VsdC5lbmNyeXB0aW9uS2V5ID0gZW5jcnlwdGlvbktleQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQoKY29uc3QgT1BMT0dfVkVSU0lPTiA9IDIKY29uc3QgREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OID0gMSAvLyBkZWZhdWx0CmNvbnN0IE1BWF9BVVRPQkFTRV9WRVJTSU9OID0gMiAvLyBvcHRpb25hbCBmb3JrIHN1cHBvcnQKY29uc3QgQk9PVF9SRUNPUkRfVkVSU0lPTiA9IDMKCmNvbnN0IFtOU19TSUdORVJfTkFNRVNQQUNFLCBOU19WSUVXX0JMT0NLX0tFWSwgTlNfSEFTSF9LRVksIE5TX0VOQ1JZUFRJT05dID0gY3J5cHRvLm5hbWVzcGFjZSgKICAnYXV0b2Jhc2UnLAogIDQKKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgT1BMT0dfVkVSU0lPTiwKICBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04sCiAgTUFYX0FVVE9CQVNFX1ZFUlNJT04sCiAgQk9PVF9SRUNPUkRfVkVSU0lPTiwKICBOU19TSUdORVJfTkFNRVNQQUNFLAogIE5TX1ZJRVdfQkxPQ0tfS0VZLAogIE5TX0hBU0hfS0VZLAogIE5TX0VOQ1JZUFRJT04KfQpjb25zdCBCdWZmZXJNYXAgPSByZXF1aXJlKCd0aW55LWJ1ZmZlci1tYXAnKQoKLy8gVGhpcyBpcyBiYXNpY2FsbHkganVzdCBhIE1hcCBhdG0sIGJ1dCBsZWF2aW5nIGl0IGFzIGFuIGFic3RyYWN0aW9uIGZvciBub3cKLy8gaW4gY2FzZSB3ZSB3YW5uYSBvcHRpbWl6ZSBpdCBmb3Igb3VyIGV4YWN0IHVzZWNhc2UKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ2xvY2sgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5zZWVuID0gbmV3IEJ1ZmZlck1hcCgpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLnNlZW4uc2l6ZQogIH0KCiAgaGFzKGtleSkgewogICAgcmV0dXJuIHRoaXMuc2Vlbi5oYXMoa2V5KQogIH0KCiAgaW5jbHVkZXMoa2V5LCBsZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLnNlZW4uaGFzKGtleSkgJiYgdGhpcy5zZWVuLmdldChrZXkpID49IGxlbmd0aAogIH0KCiAgZ2V0KGtleSkgewogICAgcmV0dXJuIHRoaXMuc2Vlbi5nZXQoa2V5KSB8fCAwCiAgfQoKICBzZXQoa2V5LCBsZW4pIHsKICAgIHRoaXMuc2Vlbi5zZXQoa2V5LCBsZW4pCiAgICByZXR1cm4gbGVuCiAgfQoKICBhZGQoY2xvY2spIHsKICAgIGZvciAoY29uc3QgW2tleSwgbF0gb2YgY2xvY2spIHsKICAgICAgaWYgKHRoaXMuZ2V0KGtleSkgPCBsKSB0aGlzLnNldChrZXksIGwpCiAgICB9CiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLnNlZW5bU3ltYm9sLml0ZXJhdG9yXSgpCiAgfQp9CmNvbnN0IEJ1ZmZlck1hcCA9IHJlcXVpcmUoJ3RpbnktYnVmZmVyLW1hcCcpCgpjb25zdCBDbG9jayA9IHJlcXVpcmUoJy4vY2xvY2suanMnKQoKY29uc3QgVU5TRUVOID0gMApjb25zdCBORVdFUiA9IDEKY29uc3QgQUNLRUQgPSAyCgovLyBDb25zZW5zdXMgbWFjaGluZSBmb3IgQXV0b2Jhc2UuIFNvcnQgREFHIG5vZGVzIHVzaW5nCi8vIHZlY3RvciBjbG9ja3MgdG8gZGV0ZXJtaW5lIGEgZ2xvYmFsbHkgY29uc2lzdGVudCB2aWV3Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENvbnNlbnN1cyB7CiAgY29uc3RydWN0b3IoaW5kZXhlcnMpIHsKICAgIHRoaXMubWVyZ2VzID0gbmV3IFNldCgpCiAgICB0aGlzLm1ham9yaXR5ID0gKGluZGV4ZXJzLmxlbmd0aCA+Pj4gMSkgKyAxCiAgICB0aGlzLmluZGV4ZXJzID0gaW5kZXhlcnMKICAgIHRoaXMucmVtb3ZlZCA9IG5ldyBDbG9jaygpCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQoKICAgIHRoaXMud3JpdGVycyA9IG5ldyBCdWZmZXJNYXAoKQogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICB0aGlzLndyaXRlcnMuc2V0KGlkeC5jb3JlLmtleSwgaWR4KQogICAgfQogIH0KCiAgYWRkSGVhZChub2RlKSB7CiAgICBpZiAoIW5vZGUud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgcmV0dXJuCiAgICBpZiAodGhpcy5faXNNZXJnZShub2RlKSkgdGhpcy5tZXJnZXMuYWRkKG5vZGUpCiAgICB0aGlzLnVwZGF0ZWQgPSB0cnVlCiAgICByZXR1cm4gbm9kZQogIH0KCiAgLyogSW5kZXhlciBPbmx5IERBRyBtZXRob2RzICovCgogIF90YWlscyhub2RlLCB0YWlscykgewogICAgY29uc3QgdGFpbFNldCA9IG5ldyBTZXQoKQogICAgZm9yIChjb25zdCB0IG9mIHRhaWxzKSB7CiAgICAgIGlmIChub2RlLmNsb2NrLmluY2x1ZGVzKHQud3JpdGVyLmNvcmUua2V5LCB0Lmxlbmd0aCkpIHRhaWxTZXQuYWRkKHQpCiAgICB9CgogICAgcmV0dXJuIHRhaWxTZXQKICB9CgogIF90YWlsc0FuZE1lcmdlcyhub2RlLCB0YWlscykgewogICAgY29uc3QgYWxsID0gdGhpcy5fdGFpbHMobm9kZSwgdGFpbHMpCiAgICBmb3IgKGNvbnN0IG0gb2YgdGhpcy5tZXJnZXMpIHsKICAgICAgaWYgKG0gIT09IG5vZGUgJiYgbm9kZS5jbG9jay5pbmNsdWRlcyhtLndyaXRlci5jb3JlLmtleSwgbS5sZW5ndGgpKSB7CiAgICAgICAgYWxsLmFkZChtKQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYWxsCiAgfQoKICBfaXNNZXJnZShub2RlKSB7CiAgICBpZiAoIW5vZGUud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgZGVwcyA9IFtdCgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBsZXQgc2VxID0gbm9kZS5jbG9jay5nZXQoaWR4LmNvcmUua2V5KSAtIDEKCiAgICAgIGlmIChpZHggPT09IG5vZGUud3JpdGVyKSBzZXEtLQoKICAgICAgY29uc3QgaGVhZCA9IGlkeC5nZXQoc2VxKQogICAgICBpZiAoIWhlYWQgfHwgdGhpcy5yZW1vdmVkLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIGNvbnRpbnVlCgogICAgICBsZXQgaXNEZXAgPSB0cnVlCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGQgPSBkZXBzW2ldCiAgICAgICAgaWYgKGQgPT09IGhlYWQpIGNvbnRpbnVlCgogICAgICAgIGlmIChkLmNsb2NrLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIHsKICAgICAgICAgIGlzRGVwID0gZmFsc2UKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBpZiAoaGVhZC5jbG9jay5pbmNsdWRlcyhkLndyaXRlci5jb3JlLmtleSwgZC5sZW5ndGgpKSB7CiAgICAgICAgICBjb25zdCBwb3BwZWQgPSBkZXBzLnBvcCgpCiAgICAgICAgICBpZiAoZCA9PT0gcG9wcGVkKSBjb250aW51ZQogICAgICAgICAgZGVwc1tpLS1dID0gcG9wcGVkCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNEZXApIGRlcHMucHVzaChoZWFkKQogICAgfQoKICAgIHJldHVybiBkZXBzLmxlbmd0aCA+IDEKICB9CgogIF9pbmRleGVyVGFpbHMoKSB7CiAgICBjb25zdCB0YWlscyA9IG5ldyBTZXQoKQogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBjb25zdCBsZW5ndGggPSB0aGlzLnJlbW92ZWQuaGFzKGlkeC5jb3JlLmtleSkgPyB0aGlzLnJlbW92ZWQuZ2V0KGlkeC5jb3JlLmtleSkgOiBpZHguaW5kZXhlZAoKICAgICAgY29uc3QgaGVhZCA9IGlkeC5nZXQobGVuZ3RoKQogICAgICBpZiAoIWhlYWQgfHwgdGhpcy5yZW1vdmVkLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIGNvbnRpbnVlCgogICAgICBsZXQgaXNUYWlsID0gdHJ1ZQogICAgICBmb3IgKGNvbnN0IHQgb2YgdGFpbHMpIHsKICAgICAgICBpZiAoaGVhZC5jbG9jay5pbmNsdWRlcyh0LndyaXRlci5jb3JlLmtleSwgdC5sZW5ndGgpKSB7CiAgICAgICAgICBpc1RhaWwgPSBmYWxzZQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGlmICh0LmNsb2NrLmluY2x1ZGVzKGhlYWQud3JpdGVyLmNvcmUua2V5LCBoZWFkLmxlbmd0aCkpIHsKICAgICAgICAgIHRhaWxzLmRlbGV0ZSh0KQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzVGFpbCkgdGFpbHMuYWRkKGhlYWQpCiAgICB9CgogICAgcmV0dXJuIHRhaWxzCiAgfQoKICAvLyBwYXJlbnQgaXMgbmV3ZXIgaWYgZm9yIGFueSBub2RlIGluIHBhcmVudCdzIHZpZXcsCiAgLy8gZWl0aGVyIG5vZGUgY2FuIHNlZSBvYmplY3Qgb3Igb2JqZWN0IGNhbiBzZWUgbm9kZQogIF9zdHJpY3RseU5ld2VyKG9iamVjdCwgcGFyZW50KSB7CiAgICBpZiAoIXBhcmVudC5jbG9jay5pbmNsdWRlcyhvYmplY3Qud3JpdGVyLmNvcmUua2V5LCBvYmplY3QubGVuZ3RoKSkgcmV0dXJuIGZhbHNlCgogICAgZm9yIChjb25zdCBba2V5LCBsYXRlc3RdIG9mIHBhcmVudC5jbG9jaykgewogICAgICBjb25zdCBvbGRlc3QgPSB0aGlzLnJlbW92ZWQuZ2V0KGtleSkKICAgICAgaWYgKGxhdGVzdCA8PSBvbGRlc3QpIGNvbnRpbnVlIC8vIGNoZWNrIHF1aWNrbHkgaWYgd2UgcmVtb3ZlZCBpdAoKICAgICAgLy8gZ2V0IHRoZSBORVhUIG5vZGUgZnJvbSB0aGUgd3JpdGVyIGZyb20gdGhlIG9iamVjdHMgcG92LCBhZGp1c3QgaWYgaXRzIHJlbW92ZWQKICAgICAgbGV0IGxlbmd0aCA9IG9iamVjdC5jbG9jay5nZXQoa2V5KQogICAgICBpZiAobGVuZ3RoIDw9IG9sZGVzdCkgbGVuZ3RoID0gb2xkZXN0CgogICAgICAvLyBzYW5pdHkgY2hlY2ssIGxpa2VseSBub3QgbmVlZGVkIGFzIHNvbWVvbmUgaGFzIGNoZWNrZWQgdGhpcyBiZWZvcmUsIGJ1dCBpdCdzIGZyZWUKICAgICAgaWYgKGxhdGVzdCA8IGxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgICAvLyBpZiB0aGUgc2FtZSwgdGhleSBoYXZlIGJvdGggc2VlbiBpdCwgY29udGludWUKICAgICAgaWYgKGxhdGVzdCA9PT0gbGVuZ3RoKSBjb250aW51ZQoKICAgICAgY29uc3Qgd3JpdGVyID0gdGhpcy53cml0ZXJzLmdldChrZXkpCgogICAgICAvLyBtaWdodCBub3QgYmUgaW4gdGhlIHJlbW92ZWQgc2V0IGJ1dCB0aGUgd3JpdGVyIGNhbiB0ZWxsIHVzIGlmIGl0IHdhcyBpbmRleGVkLi4uCiAgICAgIGNvbnN0IG5leHQgPSB3cml0ZXIgJiYgd3JpdGVyLmdldChsZW5ndGggPj0gd3JpdGVyLmluZGV4ZWQgPyBsZW5ndGggOiB3cml0ZXIuaW5kZXhlZCkKCiAgICAgIC8vIG5vIG5leHQsIGl0cyBiZWVuIGluZGV4ZWQsIGJvdGggc2VlbiBpdAogICAgICBpZiAoIW5leHQpIGNvbnRpbnVlCgogICAgICAvLyBpZiB0aGUgTkVYVCBub2RlIGhhcyBzZWVuIHRoZSBvYmplY3QgaXRzIGZpbmUgLSBuZXdlcgogICAgICBpZiAobmV4dC5jbG9jay5pbmNsdWRlcyhvYmplY3Qud3JpdGVyLmNvcmUua2V5LCBvYmplY3QubGVuZ3RoKSkgY29udGludWUKCiAgICAgIC8vIG90aGVyd2lzZSB0aGUgcGFyZW50IG11c3QgYWxzbyBOT1QgaGF2ZSBzZWVuIHRoZSBuZXh0IG5vZGUKICAgICAgaWYgKGxhdGVzdCA8IG5leHQubGVuZ3RoKSBjb250aW51ZQoKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF9hY2tzKHRhcmdldCkgewogICAgY29uc3QgYWNrcyA9IHRhcmdldC53cml0ZXIuaXNBY3RpdmVJbmRleGVyID8gW3RhcmdldF0gOiBbXSAvLyBUT0RPOiBjYW4gYmUgY2FjaGVkIG9uIHRoZSB0YXJnZXQgbm9kZSBpbiBmdXR1cmUgKGllIGlmIHdlIGFkZCBvbmUgd2UgZG9udCBoYXZlIHRvIGNoZWNrIGl0IGFnYWluKQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaWYgKGlkeCA9PT0gdGFyZ2V0LndyaXRlcikgY29udGludWUKCiAgICAgIGxldCBuZXh0ID0gdGFyZ2V0LmNsb2NrLmdldChpZHguY29yZS5rZXkpCiAgICAgIGlmIChuZXh0IDwgaWR4Lm5vZGVzLm9mZnNldCkgbmV4dCA9IGlkeC5ub2Rlcy5vZmZzZXQKCiAgICAgIGNvbnN0IG5leHRJbmRleE5vZGUgPSBpZHguZ2V0KG5leHQgPj0gaWR4LmluZGV4ZWQgPyBuZXh0IDogaWR4LmluZGV4ZWQpCgogICAgICAvLyBubyBub2RlIC0gbm8gYWNrCiAgICAgIGlmICghbmV4dEluZGV4Tm9kZSkgY29udGludWUKCiAgICAgIC8vIGlmIHRoZSBuZXh0IGluZGV4IG5vZGUgZG9lcyBub3Qgc2VlIHRoZSB0YXJnZXQsIG5vIGFjawogICAgICBpZiAoIW5leHRJbmRleE5vZGUuY2xvY2suaW5jbHVkZXModGFyZ2V0LndyaXRlci5jb3JlLmtleSwgdGFyZ2V0Lmxlbmd0aCkpIGNvbnRpbnVlCgogICAgICAvLyBpZiB0aGUgbmV4dCBpbmRleCBub2RlIGlzIG5vdCBzdHJpY3RseSBuZXdlciwgc2tpcCB0byBhdm9pZCBhbWJpZy4uLgogICAgICBpZiAoIXRoaXMuX3N0cmljdGx5TmV3ZXIodGFyZ2V0LCBuZXh0SW5kZXhOb2RlKSkgY29udGludWUKCiAgICAgIGFja3MucHVzaChuZXh0SW5kZXhOb2RlKQogICAgfQoKICAgIHJldHVybiBhY2tzCiAgfQoKICBhY2tzRnJvbU5vZGUodGFyZ2V0LCB2aWV3KSB7CiAgICBjb25zdCBhY2tzID0gbmV3IFNldCgpCgogICAgaWYgKCF2aWV3IHx8ICF2aWV3LmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpKSByZXR1cm4gYWNrcwoKICAgIGFja3MuYWRkKHZpZXcud3JpdGVyKQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaWYgKGlkeCA9PT0gdmlldy53cml0ZXIpIGNvbnRpbnVlCgogICAgICBjb25zdCBsZW5ndGggPSB2aWV3LmNsb2NrLmdldChpZHguY29yZS5rZXkpCiAgICAgIGlmICghbGVuZ3RoKSBjb250aW51ZQoKICAgICAgaWYgKHRhcmdldC5jbG9jay5pbmNsdWRlcyhpZHguY29yZS5rZXksIGxlbmd0aCkpIGNvbnRpbnVlCgogICAgICBjb25zdCBoZWFkID0gaWR4LmdldChsZW5ndGggLSAxKQogICAgICBpZiAoIWhlYWQpIGNvbnRpbnVlCgogICAgICBpZiAoaGVhZC5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKSkgewogICAgICAgIGFja3MuYWRkKGlkeCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBhY2tzCiAgfQoKICBfYWNrZWRBdChhY2tzLCBwYXJlbnQpIHsKICAgIGxldCBzZWVuID0gMAogICAgbGV0IG1pc3NpbmcgPSBhY2tzLmxlbmd0aAoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBhY2tzKSB7CiAgICAgIG1pc3NpbmctLQoKICAgICAgaWYgKCFwYXJlbnQuY2xvY2suaW5jbHVkZXMobm9kZS53cml0ZXIuY29yZS5rZXksIG5vZGUubGVuZ3RoKSkgewogICAgICAgIGlmIChzZWVuICsgbWlzc2luZyA8IHRoaXMubWFqb3JpdHkpIHJldHVybiBmYWxzZQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmICgrK3NlZW4gPj0gdGhpcy5tYWpvcml0eSkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGNvbmZpcm1zKGluZGV4ZXIsIHRhcmdldCwgYWNrcywgbGVuZ3RoKSB7CiAgICBpZiAoIWxlbmd0aCB8fCB0aGlzLnJlbW92ZWQuZ2V0KGluZGV4ZXIuY29yZS5rZXkpID49IGxlbmd0aCkgcmV0dXJuIFVOU0VFTgogICAgLy8gZGVmIGZlZWxzIGxpa2UgdGhlcmUgaXMgYSBzbWFydGVyIHdheSBvZiBkb2luZyB0aGlzIHBhcnQKICAgIC8vIGllIHdlIGp1c3Qgd2FubmEgZmluZCBhIG5vZGUgZnJvbSB0aGUgaW5kZXhlciB0aGF0IGlzIHN0cmljdGx5IG5ld2VyIHRoYW4gdGFyZ2V0CiAgICAvLyBhbmQgc2VlbnMgYSBtYWogb2YgdGhlIGFja3MgLSB0aGF0cyBpdAoKICAgIGxldCBqdW1wID0gdHJ1ZQogICAgbGV0IG5ld2VyID0gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSBsZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBoZWFkID0gaW5kZXhlci5nZXQoaSkKICAgICAgaWYgKGhlYWQgPT09IG51bGwpIHJldHVybiBVTlNFRU4KCiAgICAgIGxldCBzZWVuID0gMAoKICAgICAgZm9yIChjb25zdCBub2RlIG9mIGFja3MpIHsKICAgICAgICAvLyBpZiAobm9kZS53cml0ZXIgPT09IGluZGV4ZXIpIGNvbnRpbnVlCiAgICAgICAgaWYgKCFoZWFkLmNsb2NrLmluY2x1ZGVzKG5vZGUud3JpdGVyLmNvcmUua2V5LCBub2RlLmxlbmd0aCkpIGNvbnRpbnVlCiAgICAgICAgaWYgKCsrc2VlbiA+PSB0aGlzLm1ham9yaXR5KSBicmVhawogICAgICB9CgogICAgICBpZiAoIW5ld2VyICYmIHNlZW4gPCB0aGlzLm1ham9yaXR5KSB7CiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLl9zdHJpY3RseU5ld2VyKHRhcmdldCwgaGVhZCkpIHsKICAgICAgICAvLyBhbGwgc3RyaWN0bHkgbmV3ZXIgbm9kZXMgYXJlIGNsdXN0ZXJlZCB0b2dldGhlciBzbyBiaXNlY3QgdW50aWwgd2UgZmluZCB0aGUgY2x1c3RlcgogICAgICAgIGlmIChqdW1wKSB7CiAgICAgICAgICBqdW1wID0gZmFsc2UKCiAgICAgICAgICBsZXQgdCA9IGxlbmd0aCAtIDEKICAgICAgICAgIGxldCBiID0gMAoKICAgICAgICAgIHdoaWxlICh0ID4gYikgewogICAgICAgICAgICBjb25zdCBtaWQgPSAodCArIGIpID4+PiAxCiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBpbmRleGVyLmdldChtaWQpCgogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgbm9kZSA9PT0gbnVsbCB8fAogICAgICAgICAgICAgICFub2RlLmNsb2NrLmluY2x1ZGVzKHRhcmdldC53cml0ZXIuY29yZS5rZXksIHRhcmdldC5sZW5ndGgpIHx8CiAgICAgICAgICAgICAgdGhpcy5fc3RyaWN0bHlOZXdlcih0YXJnZXQsIG5vZGUpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGIgPSBtaWQgKyAxCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdCA9IG1pZCAtIDEKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vICsgMiBpbiBjYXNlIHdlIGFyZSBvZmYgYnkgb25lIGFuZCB0aGUgaS0tLiBpdHMgZmluZSwganVzdCBhbiBvcHRpbWlzYXRpb24KICAgICAgICAgIGlmIChiICsgMSA8IGkpIGkgPSBiICsgMgogICAgICAgIH0KCiAgICAgICAgbmV3ZXIgPSBmYWxzZQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0gZWxzZSBpZiAoc2VlbiA8IHRoaXMubWFqb3JpdHkpIHsKICAgICAgICByZXR1cm4gTkVXRVIKICAgICAgfQoKICAgICAgcmV0dXJuIEFDS0VECiAgICB9CgogICAgcmV0dXJuIFVOU0VFTgogIH0KCiAgX2lzQ29uZmlybWVkKHRhcmdldCwgcGFyZW50ID0gbnVsbCkgewogICAgY29uc3QgYWNrcyA9IHRoaXMuX2Fja3ModGFyZ2V0KQogICAgY29uc3QgY29uZnMgPSBuZXcgU2V0KCkKCiAgICBpZiAoYWNrcy5sZW5ndGggPCB0aGlzLm1ham9yaXR5KSByZXR1cm4gZmFsc2UKICAgIGxldCBhbGxOZXdlciA9IHRydWUKCiAgICBmb3IgKGNvbnN0IGluZGV4ZXIgb2YgdGhpcy5pbmRleGVycykgewogICAgICBjb25zdCBsZW5ndGggPSBwYXJlbnQKICAgICAgICA/IHBhcmVudC53cml0ZXIgPT09IGluZGV4ZXIKICAgICAgICAgID8gcGFyZW50Lmxlbmd0aCAtIDEKICAgICAgICAgIDogcGFyZW50LmNsb2NrLmdldChpbmRleGVyLmNvcmUua2V5KQogICAgICAgIDogaW5kZXhlci5sZW5ndGgKCiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY29uZmlybXMoaW5kZXhlciwgdGFyZ2V0LCBhY2tzLCBsZW5ndGgpCgogICAgICBpZiAocmVzdWx0ID09PSBBQ0tFRCkgewogICAgICAgIGNvbmZzLmFkZChpbmRleGVyKQogICAgICAgIGlmIChjb25mcy5zaXplID49IHRoaXMubWFqb3JpdHkpIHsKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocmVzdWx0ID09PSBVTlNFRU4pIGFsbE5ld2VyID0gZmFsc2UKICAgIH0KCiAgICBpZiAocGFyZW50KSByZXR1cm4gdGhpcy5faXNDb25maXJtYWJsZUF0KHRhcmdldCwgcGFyZW50LCBhY2tzLCBjb25mcykKCiAgICByZXR1cm4gYWxsTmV3ZXIKICB9CgogIF9pc0NvbmZpcm1hYmxlQXQodGFyZ2V0LCBwYXJlbnQsIGFja3MsIGNvbmZzKSB7CiAgICBpZiAoIXRoaXMuX2Fja2VkQXQoYWNrcywgcGFyZW50KSkgcmV0dXJuIGZhbHNlCgogICAgbGV0IHBvdGVudGlhbCA9IGNvbmZzLnNpemUKCiAgICBmb3IgKGNvbnN0IGluZGV4ZXIgb2YgdGhpcy5pbmRleGVycykgewogICAgICBpZiAoY29uZnMuaGFzKGluZGV4ZXIpKSBjb250aW51ZQoKICAgICAgY29uc3QgbGVuZ3RoID0gcGFyZW50LmNsb2NrLmdldChpbmRleGVyLmNvcmUua2V5KQogICAgICBjb25zdCBpc1NlZW4gPSB0YXJnZXQuY2xvY2suaW5jbHVkZXMoaW5kZXhlci5jb3JlLmtleSwgbGVuZ3RoKQoKICAgICAgLy8gaWYgdGhlIHRhcmdldCBoYXMgc2VlbiB0aGUgbGF0ZXN0IG5vZGUsIGl0IGNhbiBmcmVlbHkgYmUgdXNlZCB0byBjb25maXJtIHRoZSB0YXJnZXQgbGF0ZXIKICAgICAgLy8gb3RoZXJ3aXNlLCBjaGVjayBpZiBhIG5ld2VyIG5vZGUgaXMgc3RyaWN0bHkgbmV3ZXIuLi4KICAgICAgaWYgKCFpc1NlZW4pIHsKICAgICAgICBjb25zdCBoZWFkID0gaW5kZXhlci5nZXQobGVuZ3RoIC0gMSkKCiAgICAgICAgLy8gdGhlIG5leHQgaW5kZXhlciBoZWFkIEhBUyB0byBiZSBzdHJpY3RseSBuZXdlciAtIG1lYW5pbmcgdGhlIGN1cnJlbnQgb25lIGhhcyB0byBiZSBhbHNvLgogICAgICAgIGlmICgKICAgICAgICAgIGhlYWQgJiYKICAgICAgICAgICF0aGlzLnJlbW92ZWQuaW5jbHVkZXMoaGVhZC53cml0ZXIuY29yZS5rZXksIGhlYWQubGVuZ3RoKSAmJgogICAgICAgICAgIXRoaXMuX3N0cmljdGx5TmV3ZXIodGFyZ2V0LCBoZWFkKQogICAgICAgICkgewogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICgrK3BvdGVudGlhbCA+PSB0aGlzLm1ham9yaXR5KSByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgLy8gdGhpcyBjYW4gZ2V0IGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBmb3Igc2FtZSBub2RlCiAgcmVtb3ZlKG5vZGUpIHsKICAgIHRoaXMubWVyZ2VzLmRlbGV0ZShub2RlKQogICAgdGhpcy5yZW1vdmVkLnNldChub2RlLndyaXRlci5jb3JlLmtleSwgbm9kZS5sZW5ndGgpCiAgICByZXR1cm4gbm9kZQogIH0KCiAgc2hpZnQoKSB7CiAgICBpZiAoIXRoaXMudXBkYXRlZCkgcmV0dXJuIFtdCgogICAgY29uc3QgdGFpbHMgPSB0aGlzLl9pbmRleGVyVGFpbHMoKQoKICAgIGZvciAoY29uc3QgdGFpbCBvZiB0YWlscykgewogICAgICBpZiAodGhpcy5faXNDb25maXJtZWQodGFpbCkpIHsKICAgICAgICByZXR1cm4gW3RoaXMucmVtb3ZlKHRhaWwpXQogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBtZXJnZSBvZiB0aGlzLm1lcmdlcykgewogICAgICBpZiAodGhpcy5faXNDb25maXJtZWQobWVyZ2UpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3lpZWxkTmV4dChtZXJnZSwgdGFpbHMpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQogICAgcmV0dXJuIFtdCiAgfQoKICAvLyB5aWVsZHMgbmV4dCBpbmRleGVyIG5vZGUKICBfeWllbGROZXh0KG5vZGUsIHRhaWxzKSB7CiAgICAvLyBvbmx5IHN0b3Agd2hlbiB3ZSBmaW5kIGEgdGFpbAogICAgd2hpbGUgKCF0YWlscy5oYXMobm9kZSkpIHsKICAgICAgbGV0IG5leHQgPSBudWxsCgogICAgICAvLyBmb3IgbWVyZ2VzIGNoZWNrIGlmIG9uZSBmb3JrIGlzIGNvbmZpcm1lZAogICAgICBmb3IgKGNvbnN0IHQgb2YgdGhpcy5fdGFpbHNBbmRNZXJnZXMobm9kZSwgdGFpbHMpKSB7CiAgICAgICAgaWYgKHRoaXMuX2lzQ29uZmlybWVkKHQsIG5vZGUpKSB7CiAgICAgICAgICBuZXh0ID0gdAogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgbm9kZSA9IG5leHQKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICAvLyBvdGhlcndpc2UgeWllbGQgYWxsIHRhaWxzCiAgICAgIGNvbnN0IHRhaWxTZXQgPSBbXQogICAgICBmb3IgKGNvbnN0IHQgb2YgdGhpcy5fdGFpbHMobm9kZSwgdGFpbHMpKSB7CiAgICAgICAgdGFpbFNldC5wdXNoKHRoaXMucmVtb3ZlKHQpKQogICAgICB9CgogICAgICByZXR1cm4gdGFpbFNldAogICAgfQoKICAgIHJldHVybiBbdGhpcy5yZW1vdmUobm9kZSldCiAgfQoKICBzaG91bGRBY2sod3JpdGVyKSB7CiAgICBmb3IgKGNvbnN0IHQgb2YgdGhpcy5faW5kZXhlclRhaWxzKCkpIHsKICAgICAgaWYgKHQud3JpdGVyID09PSB3cml0ZXIpIGNvbnRpbnVlCiAgICAgIGlmICh0aGlzLl9zaG91bGRBY2tOb2RlKHQsIHdyaXRlcikpIHJldHVybiB0cnVlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfc2hvdWxkQWNrTm9kZSh0YXJnZXQsIHdyaXRlcikgewogICAgY29uc3QgaGVhZCA9IHdyaXRlci5oZWFkKCkKICAgIGNvbnN0IG5leHQgPSB0YXJnZXQuY2xvY2suZ2V0KHdyaXRlci5jb3JlLmtleSkKICAgIGNvbnN0IG5leHRJbmRleE5vZGUgPSB3cml0ZXIuZ2V0KG5leHQgPj0gd3JpdGVyLmluZGV4ZWQgPyBuZXh0IDogd3JpdGVyLmluZGV4ZWQpCgogICAgLy8gaWYgd2UgaGF2ZSBubyBuZXh0IG5vZGUgYW5kIHdlIGRpZG4ndCB3cml0ZSB0YXJnZXQgdGhlbiBhY2sKICAgIGlmICghbmV4dEluZGV4Tm9kZSAmJiB3cml0ZXIgIT09IHRhcmdldC53cml0ZXIpIHJldHVybiB0cnVlCgogICAgLy8gc2hvcnRjdXRzIGlmIHdlIGhhdmUgbmV4dCBub2RlCiAgICBpZiAobmV4dEluZGV4Tm9kZSkgewogICAgICAvLyBpZiB0aGUgbmV4dCBub2RlIGRvZXMgbm90IHNlZSB0aGUgdGFyZ2V0LCBzaG91bGQgYWNrCiAgICAgIGlmICghbmV4dEluZGV4Tm9kZS5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKSkgewogICAgICAgIHJldHVybiAhaGVhZC5jbG9jay5pbmNsdWRlcyh0YXJnZXQud3JpdGVyLmNvcmUua2V5LCB0YXJnZXQubGVuZ3RoKQogICAgICB9CgogICAgICAvLyBpZiB0aGUgbmV4dCBub2RlIGlzIG5vdCBzdHJpY3RseSBuZXdlciwgbm8gcG9pbnQgYWNraW5nCiAgICAgIGlmICghdGhpcy5fc3RyaWN0bHlOZXdlcih0YXJnZXQsIG5leHRJbmRleE5vZGUpKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICAvLyBub3cgY2hlY2sgaWYgd2UgY2FuIGRvdWJsZSBjb25maXJtCiAgICBjb25zdCBhY2tzID0gdGhpcy5fYWNrcyh0YXJnZXQpCgogICAgLy8gbmVlZCBlbm91Z2ggdG8gZG91YmxlIGNvbmZpcm0KICAgIGlmIChhY2tzLmxlbmd0aCA+PSB0aGlzLm1ham9yaXR5KSB7CiAgICAgIHJldHVybiB0aGlzLmNvbmZpcm1zKHdyaXRlciwgdGFyZ2V0LCBhY2tzLCB3cml0ZXIubGVuZ3RoKSA9PT0gVU5TRUVOCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQp9CmNvbnN0IEh5cGVyY29yZUVuY3J5cHRpb24gPSByZXF1aXJlKCdoeXBlcmNvcmUvbGliL2RlZmF1bHQtZW5jcnlwdGlvbi5qcycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKCmNvbnN0IFN5c3RlbVZpZXcgPSByZXF1aXJlKCcuL3N5c3RlbS5qcycpCmNvbnN0IHsgRW5jcnlwdGlvbkRlc2NyaXB0b3IsIE1hbmlmZXN0RGF0YSB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgTlNfVklFV19CTE9DS19LRVksIE5TX0hBU0hfS0VZLCBOU19FTkNSWVBUSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMuanMnKQoKY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19zdHJlYW1fTk9OQ0VCWVRFUykKY29uc3QgaGFzaCA9IG5vbmNlLnN1YmFycmF5KDAsIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfQllURVNfTUlOKQoKY2xhc3MgQXV0b2Jhc2VFbmNyeXB0aW9uIHsKICBzdGF0aWMgUEFERElORyA9IDgKCiAgY29uc3RydWN0b3IoZW5jcnlwdGlvbikgewogICAgdGhpcy5lbmNyeXB0aW9uID0gZW5jcnlwdGlvbgoKICAgIHRoaXMuY29tcGF0ID0gbnVsbAogICAgdGhpcy5rZXlzID0gbnVsbAogICAgdGhpcy5rZXlzQnlJZCA9IG5ldyBNYXAoKQogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMua2V5cyA/IHRoaXMua2V5cy5pZCA6IDAKICB9CgogIHBhZGRpbmcoKSB7CiAgICByZXR1cm4gQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcKICB9CgogIGlzQ29tcGF0KCkgewogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBsb2FkKGtleXMpIHsKICAgIGlmICh0aGlzLmtleXMgPT09IG51bGwpIHRoaXMua2V5cyA9IGtleXMKICB9CgogIGFzeW5jIHVwZGF0ZShjdHgpIHsKICAgIGlmICh0aGlzLmlkICE9PSAwICYmIHRoaXMuaWQgPT09IHRoaXMuZW5jcnlwdGlvbi5pZCkgcmV0dXJuCiAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5nZXQodGhpcy5lbmNyeXB0aW9uLmlkLCBjdHgpCiAgICBpZiAoa2V5cykgdGhpcy5rZXlzID0ga2V5cwogIH0KCiAgYXN5bmMgZ2V0KGlkLCBjdHgpIHsKICAgIGlmICh0aGlzLmtleXNCeUlkLmhhcyhpZCkpIHJldHVybiB0aGlzLmtleXNCeUlkLmdldChpZCkKCiAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5nZXRLZXlzKGlkLCBjdHgpCiAgICB0aGlzLmtleXNCeUlkLnNldChpZCwga2V5cykKCiAgICByZXR1cm4ga2V5cwogIH0KCiAgYXN5bmMgZ2V0S2V5cyhpZCwgY3R4KSB7CiAgICBjb25zdCBlbnRyb3B5ID0gYXdhaXQgdGhpcy5lbmNyeXB0aW9uLmdldChpZCkKICAgIGlmICghZW50cm9weSkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBibG9jayA9IHRoaXMuYmxvY2tLZXkoZW50cm9weSwgY3R4KQogICAgY29uc3QgaGFzaCA9IGNyeXB0by5oYXNoKFtOU19IQVNIX0tFWSwgYmxvY2tdKQoKICAgIHJldHVybiB7CiAgICAgIGlkLAogICAgICBibG9jaywKICAgICAgaGFzaAogICAgfQogIH0KCiAgYmxvY2tLZXkoZW50cm9weSwgY3R4KSB7CiAgICByZXR1cm4gdGhpcy5lbmNyeXB0aW9uLmJsb2NrS2V5KGVudHJvcHksIGN0eCkKICB9CgogIGFzeW5jIF9lbnN1cmVDb21wYXQoY3R4KSB7CiAgICBpZiAoIXRoaXMuY29tcGF0KSB0aGlzLmNvbXBhdCA9IHRoaXMuY29tcGF0S2V5cyhjdHgpCiAgfQoKICBjb21wYXRLZXlzKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdDb21wYXRhYmlsaXR5IG1ldGhvZCBpcyBub3Qgc3BlY2lmaWVkJykKICB9CgogIGFzeW5jIGVuY3J5cHQoaW5kZXgsIGJsb2NrLCBmb3JrLCBjdHgpIHsKICAgIGlmICh0aGlzLmlzQ29tcGF0KGN0eCwgaW5kZXgpKSB7CiAgICAgIHRoaXMuX2Vuc3VyZUNvbXBhdChjdHgpCiAgICAgIHJldHVybiBIeXBlcmNvcmVFbmNyeXB0aW9uLmVuY3J5cHQoCiAgICAgICAgaW5kZXgsCiAgICAgICAgYmxvY2ssCiAgICAgICAgZm9yaywKICAgICAgICB0aGlzLmNvbXBhdC5ibG9jaywKICAgICAgICB0aGlzLmNvbXBhdC5ibGluZGluZwogICAgICApCiAgICB9CgogICAgYXdhaXQgdGhpcy51cGRhdGUoY3R4KQoKICAgIGVuY3J5cHRCbG9jayhpbmRleCwgYmxvY2ssIHRoaXMua2V5cy5pZCwgdGhpcy5rZXlzLmJsb2NrLCB0aGlzLmtleXMuaGFzaCkKICB9CgogIGFzeW5jIGRlY3J5cHQoaW5kZXgsIGJsb2NrLCBjdHgpIHsKICAgIGlmICh0aGlzLmlzQ29tcGF0KGN0eCwgaW5kZXgpKSB7CiAgICAgIHRoaXMuX2Vuc3VyZUNvbXBhdChjdHgpCiAgICAgIHJldHVybiBIeXBlcmNvcmVFbmNyeXB0aW9uLmRlY3J5cHQoaW5kZXgsIGJsb2NrLCB0aGlzLmNvbXBhdC5ibG9jaykKICAgIH0KCiAgICBjb25zdCBwYWRkaW5nID0gYmxvY2suc3ViYXJyYXkoMCwgQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcpCiAgICBibG9jayA9IGJsb2NrLnN1YmFycmF5KEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HKQoKICAgIGNvbnN0IHR5cGUgPSBwYWRkaW5nWzBdCiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiBibG9jayAvLyB1bmVuY3J5cHRlZAoKICAgICAgY2FzZSAxOgogICAgICAgIGJyZWFrCgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pc2VkIGVuY3J5cHRpb24gdHlwZScpCiAgICB9CgogICAgY29uc3QgaWQgPSBjLnVpbnQzMi5kZWNvZGUoeyBzdGFydDogNCwgZW5kOiA4LCBidWZmZXI6IHBhZGRpbmcgfSkKCiAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5nZXQoaWQsIGN0eCkKCiAgICBjLnVpbnQ2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA4LCBidWZmZXI6IG5vbmNlIH0sIGluZGV4KQogICAgbm9uY2Uuc2V0KHBhZGRpbmcsIDgsIDE2KQoKICAgIC8vIERlY3J5cHQgdGhlIGJsb2NrIHVzaW5nIHRoZSBmdWxsIG5vbmNlCiAgICBkZWNyeXB0KGJsb2NrLCBub25jZSwga2V5cy5ibG9jaykKICB9Cn0KCmNsYXNzIFZpZXdFbmNyeXB0aW9uIGV4dGVuZHMgQXV0b2Jhc2VFbmNyeXB0aW9uIHsKICBjb25zdHJ1Y3RvcihlbmNyeXB0aW9uLCBuYW1lKSB7CiAgICBzdXBlcihlbmNyeXB0aW9uKQogICAgdGhpcy5uYW1lID0gbmFtZQogIH0KCiAgaXNDb21wYXQoY3R4LCBpbmRleCkgewogICAgaWYgKGN0eC5tYW5pZmVzdC52ZXJzaW9uIDw9IDEpIHJldHVybiB0cnVlCiAgICBpZiAoIWN0eC5tYW5pZmVzdC51c2VyRGF0YSkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCB7IGxlZ2FjeUJsb2NrcyB9ID0gYy5kZWNvZGUoTWFuaWZlc3REYXRhLCBjdHgubWFuaWZlc3QudXNlckRhdGEpCiAgICByZXR1cm4gaW5kZXggPCBsZWdhY3lCbG9ja3MKICB9CgogIGNvbXBhdEtleXMoKSB7CiAgICBjb25zdCB7IGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSB9ID0gdGhpcy5lbmNyeXB0aW9uLmJhc2UKICAgIGNvbnN0IGJsb2NrID0gZ2V0Q29tcGF0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCB0aGlzLm5hbWUpCiAgICByZXR1cm4gewogICAgICBibG9jaywKICAgICAgYmxpbmRpbmc6IGNyeXB0by5oYXNoKGJsb2NrKQogICAgfQogIH0KCiAgYmxvY2tLZXkoZW50cm9weSkgewogICAgcmV0dXJuIGdldENvbXBhdEJsb2NrS2V5KHRoaXMuZW5jcnlwdGlvbi5iYXNlLmJvb3RzdHJhcCwgZW50cm9weSwgdGhpcy5uYW1lKQogIH0KfQoKY2xhc3MgV3JpdGVyRW5jcnlwdGlvbiBleHRlbmRzIEF1dG9iYXNlRW5jcnlwdGlvbiB7CiAgaXNDb21wYXQoY3R4KSB7CiAgICByZXR1cm4gY3R4Lm1hbmlmZXN0LnZlcnNpb24gPD0gMQogIH0KCiAgY29tcGF0S2V5cyhjdHgpIHsKICAgIHJldHVybiBIeXBlcmNvcmVFbmNyeXB0aW9uLmRlcml2ZUtleXModGhpcy5lbmNyeXB0aW9uLmJhc2UuZW5jcnlwdGlvbktleSwgY3R4LmtleSkKICB9CgogIGJsb2NrS2V5KGVudHJvcHksIGN0eCkgewogICAgaWYgKGN0eC5tYW5pZmVzdC51c2VyRGF0YSkgewogICAgICBjb25zdCB1c2VyRGF0YSA9IGMuZGVjb2RlKE1hbmlmZXN0RGF0YSwgY3R4Lm1hbmlmZXN0LnVzZXJEYXRhKQogICAgICBpZiAodXNlckRhdGEubmFtZXNwYWNlICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5jcnlwdGlvbi5ibG9ja0tleShlbnRyb3B5LCB7IGtleTogdXNlckRhdGEubmFtZXNwYWNlIH0pCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpcy5lbmNyeXB0aW9uLmJsb2NrS2V5KGVudHJvcHksIGN0eCkKICB9Cn0KCmNsYXNzIEVuY3J5cHRpb25WaWV3IGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoYmFzZSwgY29yZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuY29yZSA9IGNvcmUgfHwgbnVsbAoKICAgIHRoaXMuc2Vzc2lvbnMgPSBuZXcgTWFwKCkKCiAgICB0aGlzLl9pbml0aWFsaXNpbmcgPSBudWxsCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGF3YWl0IHRoaXMuaW5pdGlhbGlzZWQoKQogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICB9CgogIGluaXRpYWxpc2VkKCkgewogICAgaWYgKHRoaXMuY29yZSAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuY29yZS5yZWFkeSgpCiAgICBpZiAodGhpcy5faW5pdGlhbGlzaW5nKSByZXR1cm4gdGhpcy5faW5pdGlhbGlzaW5nCgogICAgdGhpcy5faW5pdGlhbGlzaW5nID0gcnJwKCkKCiAgICByZXR1cm4gdGhpcy5faW5pdGlhbGlzaW5nLnByb21pc2UKICB9CgogIF9jbG9zZSgpIHsKICAgIGlmICh0aGlzLl9pbml0aWFsaXNpbmcpIHsKICAgICAgdGhpcy5faW5pdGlhbGlzaW5nLnJlamVjdChuZXcgRXJyb3IoJ0VuY3J5cHRpb24gY2xvc2VkJykpCiAgICAgIHRoaXMuX2luaXRpYWxpc2luZyA9IG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5jb3JlKSByZXR1cm4gdGhpcy5jb3JlLmNsb3NlKCkKICB9CgogIGdldCBib290c3RyYXBwZWQoKSB7CiAgICByZXR1cm4gISEodGhpcy5jb3JlICYmIHRoaXMuY29yZS5sZW5ndGggPiAwKQogIH0KCiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA/IHRoaXMuY29yZS5sZW5ndGggOiAwCiAgfQoKICBfY3JlYXRlUGF5bG9hZChrZXkpIHsKICAgIHJldHVybiBrZXkKICB9CgogIGFzeW5jIHJlbG9hZChjb3JlKSB7CiAgICBpZiAodGhpcy5jb3JlKSBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQoKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCgogICAgaWYgKHRoaXMuX2luaXRpYWxpc2luZykgewogICAgICB0aGlzLl9pbml0aWFsaXNpbmcucmVzb2x2ZSgpCiAgICAgIHRoaXMuX2luaXRpYWxpc2luZyA9IG51bGwKICAgIH0KICB9CgogIHVucGFjayh0eXBlLCBwYXlsb2FkKSB7CiAgICBpZiAodHlwZSA+IDApIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgdmVyc2lvbicpCiAgICByZXR1cm4gcGF5bG9hZAogIH0KCiAgYXN5bmMgdXBkYXRlKGtleSkgewogICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IHRoaXMuX2NyZWF0ZVBheWxvYWQoa2V5KQogICAgY29uc3QgZGVzYyA9IHsgdHlwZTogMCwgcGF5bG9hZCB9CgogICAgYXdhaXQgdGhpcy5jb3JlLmFwcGVuZChjLmVuY29kZShFbmNyeXB0aW9uRGVzY3JpcHRvciwgZGVzYykpCiAgfQoKICBhc3luYyBfcHJlbG9hZCgpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQogICAgcmV0dXJuIHRoaXMuaWQoKQogIH0KCiAgZ2V0Vmlld0VuY3J5cHRpb24obmFtZSkgewogICAgaWYgKHRoaXMuc2Vzc2lvbnMuaGFzKG5hbWUpKSByZXR1cm4gdGhpcy5zZXNzaW9ucy5nZXQobmFtZSkKCiAgICBjb25zdCBlbmNyeXB0aW9uID0gbmV3IFZpZXdFbmNyeXB0aW9uKHRoaXMsIG5hbWUpCiAgICB0aGlzLnNlc3Npb25zLnNldChuYW1lLCBlbmNyeXB0aW9uKQoKICAgIHJldHVybiBlbmNyeXB0aW9uCiAgfQoKICBnZXRXcml0ZXJFbmNyeXB0aW9uKCkgewogICAgcmV0dXJuIG5ldyBXcml0ZXJFbmNyeXB0aW9uKHRoaXMpCiAgfQoKICBhc3luYyBlbmNyeXB0QW5jaG9yKGJsb2NrLCBuYW1lc3BhY2UpIHsKICAgIGNvbnN0IGVudHJvcHkgPSBhd2FpdCB0aGlzLmdldCh0aGlzLmlkKQogICAgaWYgKCFlbnRyb3B5KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGJsb2NrS2V5ID0gdGhpcy5ibG9ja0tleShlbnRyb3B5LCB7IGtleTogbmFtZXNwYWNlIH0pCiAgICBjb25zdCBoYXNoS2V5ID0gY3J5cHRvLmhhc2goW05TX0hBU0hfS0VZLCBibG9ja10pCgogICAgZW5jcnlwdEJsb2NrKDAsIGJsb2NrLCB0aGlzLmlkLCBibG9ja0tleSwgaGFzaEtleSkKICB9CgogIGJsb2NrS2V5KGVudHJvcHksIGN0eCkgewogICAgcmV0dXJuIGdldEJsb2NrS2V5KHRoaXMuYmFzZS5ib290c3RyYXAsIHRoaXMuYmFzZS5lbmNyeXB0aW9uS2V5LCBlbnRyb3B5LCBjdHgua2V5KQogIH0KCiAgYXN5bmMgZ2V0KGVuY3J5cHRpb25JZCkgewogICAgaWYgKGVuY3J5cHRpb25JZCA9PT0gMCkgcmV0dXJuIFN5c3RlbVZpZXcuR0VORVNJU19FTlRST1BZCgogICAgaWYgKCF0aGlzLmNvcmUpIGF3YWl0IHRoaXMuaW5pdGlhbGlzZWQoKQoKICAgIGNvbnN0IGluZGV4ID0gZW5jcnlwdGlvbklkIC0gMQogICAgY29uc3QgZGVzYyA9IGF3YWl0IHRoaXMuY29yZS5nZXQoaW5kZXgpCiAgICBjb25zdCB7IHR5cGUsIHBheWxvYWQgfSA9IGMuZGVjb2RlKEVuY3J5cHRpb25EZXNjcmlwdG9yLCBkZXNjKQoKICAgIGNvbnN0IGtleSA9IHRoaXMudW5wYWNrKHR5cGUsIHBheWxvYWQpCiAgICByZXR1cm4ga2V5CiAgfQoKICBnZXRTeXN0ZW1FbmNyeXB0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Vmlld0VuY3J5cHRpb24oJ19zeXN0ZW0nKQogIH0KCiAgc3RhdGljIG5hbWVzcGFjZShlbnRyb3B5KSB7CiAgICByZXR1cm4gY3J5cHRvLmhhc2goW05TX0VOQ1JZUFRJT04sIGVudHJvcHldKQogIH0KCiAgc3RhdGljIGdldEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgZW50cm9weSwgaHlwZXJjb3JlS2V5KSB7CiAgICByZXR1cm4gZ2V0QmxvY2tLZXkoYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBlbnRyb3B5LCBoeXBlcmNvcmVLZXkpCiAgfQoKICBzdGF0aWMgZ2V0U3lzdGVtRW5jcnlwdGlvbihiYXNlLCBjb3JlKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IEVuY3J5cHRpb25WaWV3KGJhc2UsIGNvcmUpCiAgICByZXR1cm4gdmlldy5nZXRTeXN0ZW1FbmNyeXB0aW9uKCkKICB9CgogIHN0YXRpYyBhc3luYyBzZXRTeXN0ZW1FbmNyeXB0aW9uKGJhc2UsIGNvcmUsIG9wdHMpIHsKICAgIGlmIChiYXNlLmVuY3J5cHRpb25LZXkgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBpZiAoY29yZS5tYW5pZmVzdC52ZXJzaW9uID09PSAxKSB7CiAgICAgIGNvbnN0IGtleSA9IGdldENvbXBhdEJsb2NrS2V5KGJhc2UuYm9vdHN0cmFwLCBiYXNlLmVuY3J5cHRpb25LZXksICdfc3lzdGVtJykKICAgICAgcmV0dXJuIGNvcmUuc2V0RW5jcnlwdGlvbktleShrZXksIHsgYmxvY2s6IHRydWUgfSkKICAgIH0KCiAgICBpZiAoIWNvcmUubWFuaWZlc3QubGlua2VkLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N5c3RlbSBtYW5pZmVzdCBkb2VzIG5vdCBsaW5rIGVuY3J5cHRpb24gdmlldycpCiAgICB9CgogICAgY29uc3QgZW5jID0gYmFzZS5zdG9yZS5nZXQoeyBrZXk6IGNvcmUubWFuaWZlc3QubGlua2VkWzBdLCBhY3RpdmU6IGZhbHNlIH0pCiAgICBjb25zdCBlbmNyeXB0aW9uID0gRW5jcnlwdGlvblZpZXcuZ2V0U3lzdGVtRW5jcnlwdGlvbihiYXNlLCBlbmMpCgogICAgYXdhaXQgY29yZS5zZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24sIG9wdHMpCgogICAgcmV0dXJuIGVuYwogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgQXV0b2Jhc2VFbmNyeXB0aW9uLAogIEVuY3J5cHRpb25WaWV3Cn0KCmZ1bmN0aW9uIGVuY3J5cHQoYmxvY2ssIG5vbmNlLCBrZXkpIHsKICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IoYmxvY2ssIGJsb2NrLCBub25jZSwga2V5KQp9CgpmdW5jdGlvbiBkZWNyeXB0KGJsb2NrLCBub25jZSwga2V5KSB7CiAgcmV0dXJuIGVuY3J5cHQoYmxvY2ssIG5vbmNlLCBrZXkpIC8vIHN5bW1ldHJpYwp9CgpmdW5jdGlvbiBnZXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIGVudHJvcHksIGh5cGVyY29yZUtleSkgewogIHJldHVybiAoCiAgICBlbmNyeXB0aW9uS2V5ICYmCiAgICBjcnlwdG8uaGFzaChbTlNfVklFV19CTE9DS19LRVksIGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgZW50cm9weSwgaHlwZXJjb3JlS2V5XSkKICApCn0KCmZ1bmN0aW9uIGdldENvbXBhdEJsb2NrS2V5KGJvb3RzdHJhcCwgZW5jcnlwdGlvbktleSwgbmFtZSkgewogIGlmICh0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpIHJldHVybiBnZXRDb21wYXRCbG9ja0tleShib290c3RyYXAsIGVuY3J5cHRpb25LZXksIGI0YS5mcm9tKG5hbWUpKQogIHJldHVybiBlbmNyeXB0aW9uS2V5ICYmIGNyeXB0by5oYXNoKFtOU19WSUVXX0JMT0NLX0tFWSwgYm9vdHN0cmFwLCBlbmNyeXB0aW9uS2V5LCBuYW1lXSkKfQoKZnVuY3Rpb24gYmxvY2toYXNoKGJsb2NrLCBwYWRkaW5nLCBoYXNoS2V5KSB7CiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChoYXNoLCBibG9jaywgaGFzaEtleSkKICBwYWRkaW5nLnNldChoYXNoLnN1YmFycmF5KDAsIDgpKSAvLyBjb3B5IGZpcnN0IDggYnl0ZXMgb2YgaGFzaAogIGhhc2guZmlsbCgwKSAvLyBjbGVhciBub25jZSBidWZmZXIKfQoKZnVuY3Rpb24gZW5jcnlwdEJsb2NrKGluZGV4LCBibG9jaywgaWQsIGJsb2NrS2V5LCBoYXNoS2V5KSB7CiAgY29uc3QgcGFkZGluZyA9IGJsb2NrLnN1YmFycmF5KDAsIEF1dG9iYXNlRW5jcnlwdGlvbi5QQURESU5HKQogIGJsb2NrID0gYmxvY2suc3ViYXJyYXkoQXV0b2Jhc2VFbmNyeXB0aW9uLlBBRERJTkcpCgogIGJsb2NraGFzaChibG9jaywgcGFkZGluZywgaGFzaEtleSkKICBjLnVpbnQzMi5lbmNvZGUoeyBzdGFydDogNCwgZW5kOiA4LCBidWZmZXI6IHBhZGRpbmcgfSwgaWQpCgogIGMudWludDY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDgsIGJ1ZmZlcjogbm9uY2UgfSwgaW5kZXgpCgogIHBhZGRpbmdbMF0gPSAxIC8vIHZlcnNpb24gaW4gcGxhaW50ZXh0CgogIG5vbmNlLnNldChwYWRkaW5nLCA4LCAxNikKCiAgLy8gVGhlIGNvbWJpbmF0aW9uIG9mIGluZGV4LCBrZXkgaWQsIGZvcmsgaWQgYW5kIGJsb2NrIGhhc2ggaXMgdmVyeSBsaWtlbHkKICAvLyB0byBiZSB1bmlxdWUgZm9yIGEgZ2l2ZW4gSHlwZXJjb3JlIGFuZCB0aGVyZWZvcmUgb3VyIG5vbmNlIGlzIHN1aXRhYmxlCiAgZW5jcnlwdChibG9jaywgbm9uY2UsIGJsb2NrS2V5KQp9CmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCgpjb25zdCBTeXN0ZW1WaWV3ID0gcmVxdWlyZSgnLi9zeXN0ZW0uanMnKQpjb25zdCB7IEVuY3J5cHRpb25WaWV3IH0gPSByZXF1aXJlKCcuL2VuY3J5cHRpb24uanMnKQoKY29uc3QgREVGQVVMVF9PUF9USU1FT1VUID0gNV8wMDAKY29uc3QgREVGQVVMVF9NSU5fRkYgPSAxNgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGYXN0Rm9yd2FyZCB7CiAgY29uc3RydWN0b3IoCiAgICBiYXNlLAogICAga2V5LAogICAgewogICAgICB0aW1lb3V0ID0gREVGQVVMVF9PUF9USU1FT1VULAogICAgICB2ZXJpZmllZCA9IHRydWUsCiAgICAgIG1pbmltdW0gPSBERUZBVUxUX01JTl9GRiwKICAgICAgZm9yY2UgPSBmYWxzZSwKICAgICAgbGVuZ3RoID0gMAogICAgfSA9IHt9CiAgKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy50aW1lb3V0ID0gdGltZW91dAogICAgdGhpcy5mb3JjZSA9IGZvcmNlCiAgICB0aGlzLmNvcmUgPSBiYXNlLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiB0cnVlLCBlbmNyeXB0aW9uOiBudWxsIH0pCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy52aWV3cyA9IFtdCiAgICB0aGlzLmVuY3J5cHRpb24gPSBudWxsCiAgICB0aGlzLmVudHJvcHkgPSBudWxsCiAgICB0aGlzLmluZGV4ZXJzID0gW10KICAgIHRoaXMubWluaW11bSA9IG1pbmltdW0KICAgIHRoaXMudmVyaWZpZWQgPSB2ZXJpZmllZAogICAgdGhpcy53YWl0aW5nID0gbmV3IFNldCgpCiAgICB0aGlzLmNvcmVzID0gW3RoaXMuY29yZV0KICAgIHRoaXMuc3lzdGVtID0gbnVsbAogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy51cGdyYWRpbmcgPSBudWxsCiAgICB0aGlzLmZhaWxlZCA9IGZhbHNlCiAgfQoKICBzdGF0aWMgTUlOSU1VTSA9IERFRkFVTFRfTUlOX0ZGCgogIGFzeW5jIHVwZ3JhZGUoKSB7CiAgICB0cnkgewogICAgICBpZiAoIXRoaXMudXBncmFkaW5nKSB0aGlzLnVwZ3JhZGluZyA9IHRoaXMuX3VwZ3JhZGUoKQoKICAgICAgaWYgKCEoYXdhaXQgdGhpcy51cGdyYWRpbmcpKSByZXR1cm4gbnVsbAoKICAgICAgcmV0dXJuIHsKICAgICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLAogICAgICAgIGZvcmNlOiB0aGlzLmZvcmNlLAogICAgICAgIGtleTogdGhpcy5rZXksCiAgICAgICAgaW5kZXhlcnM6IHRoaXMuaW5kZXhlcnMsCiAgICAgICAgdmlld3M6IHRoaXMudmlld3MsCiAgICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5LAogICAgICAgIG1hbmlmZXN0VmVyc2lvbjogdGhpcy5jb3JlLm1hbmlmZXN0LnZlcnNpb24sCiAgICAgICAgbWluaW11bTogdGhpcy5taW5pbXVtCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIHRoaXMuZmFpbGVkID0gdHJ1ZQogICAgICByZXR1cm4gbnVsbAogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgICB9CiAgfQoKICBfd2FpdEZvckFwcGVuZChjb3JlKSB7CiAgICBpZiAoY29yZS5sZW5ndGggPiAwKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKCiAgICBjb25zdCBwcm9taXNlID0gcnJwKCkKICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuY2xvc2UuYmluZCh0aGlzKSwgdGhpcy50aW1lb3V0KQogICAgY29uc3Qgd2FpdCA9IHsgcHJvbWlzZSwgdGltZW91dCB9CgogICAgdGhpcy53YWl0aW5nLmFkZCh3YWl0KQoKICAgIGNvcmUub25jZSgnYXBwZW5kJywgKCkgPT4gewogICAgICB0aGlzLndhaXRpbmcuZGVsZXRlKHdhaXQpCiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICBwcm9taXNlLnJlc29sdmUoKQogICAgfSkKCiAgICByZXR1cm4gcHJvbWlzZS5wcm9taXNlCiAgfQoKICBfbWluTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5jb3JlLmxlbmd0aCArIHRoaXMubWluaW11bQogIH0KCiAgYXN5bmMgX3VwZ3JhZGUoKSB7CiAgICBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIGlmICghdGhpcy52ZXJpZmllZCkgYXdhaXQgdGhpcy5fd2FpdEZvckFwcGVuZCh0aGlzLmNvcmUpCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBmYWxzZQoKICAgIGlmICh0aGlzLmNvcmUubWFuaWZlc3QubGlua2VkKSB7CiAgICAgIGNvbnN0IGFwcGVuZHMgPSBbXQoKICAgICAgZm9yIChjb25zdCBrZXkgb2YgdGhpcy5jb3JlLm1hbmlmZXN0LmxpbmtlZCkgewogICAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsga2V5LCBhY3RpdmU6IHRydWUgfSkKICAgICAgICB0aGlzLmNvcmVzLnB1c2goY29yZSkKCiAgICAgICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICAgICAgYXBwZW5kcy5wdXNoKHRoaXMuX3dhaXRGb3JBcHBlbmQoY29yZSkpCiAgICAgIH0KCiAgICAgIGF3YWl0IFByb21pc2UuYWxsKGFwcGVuZHMpCiAgICB9CgogICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSB0aGlzLmxlbmd0aCA9IHRoaXMuY29yZS5sZW5ndGgKCiAgICAvLyBub3RlIHdlIHVzZSB0aGUgcGVyc2lzdGVkIGxlbmd0aCBoZXJlLCBhcyB3ZSBtaWdodCBhcyB3ZWxsIGNvbnRpbnVlIHRoYXQgd29yayBhcyB0aGF0cyB+IHRoZSBzYW1lIGxlbmd0aAogICAgaWYgKCF0aGlzLmZvcmNlICYmIHRoaXMubGVuZ3RoIDwgdGhpcy5fbWluTGVuZ3RoKCkpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2UKCiAgICBhd2FpdCB0aGlzLmNvcmUuZ2V0KHRoaXMubGVuZ3RoIC0gMSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkKICAgIGF3YWl0IHRoaXMuYmFzZS5yZWFkeSgpCgogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5iYXNlLmVuY3J5cHRpb25LZXkgJiYgIShhd2FpdCB0aGlzLl9lbnN1cmVFbmNyeXB0aW9uKCkpKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5zeXN0ZW0gPSBuZXcgU3lzdGVtVmlldyh0aGlzLmNvcmUsIHsgY2hlY2tvdXQ6IHRoaXMubGVuZ3RoIH0pCiAgICBhd2FpdCB0aGlzLnN5c3RlbS5yZWFkeSgpCiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuZW50cm9weSA9IHRoaXMuc3lzdGVtLmVudHJvcHkKCiAgICBpZiAodGhpcy5jb3JlLm1hbmlmZXN0LnZlcnNpb24gPj0gMikgewogICAgICBjb25zdCBsaW5rZWQgPSB0aGlzLmNvcmUubWFuaWZlc3QubGlua2VkCgogICAgICBpZiAodGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aCA9PT0gMCB8fCBsaW5rZWQgPT09IG51bGwgfHwgIWxpbmtlZC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgLy8gdGVjaG5pY2FsbHkgZGl2ZXJnZXMgZnJvbSBzeXN0ZW0udmlld3MgdG8gaW5jbHVkZSBlbmNyeXB0aW9uIGhlcmUsIGJ1dCBtYWtlcyBzZW5zZQogICAgICB0aGlzLnZpZXdzLnB1c2goewogICAgICAgIGtleTogbGlua2VkWzBdLAogICAgICAgIGxlbmd0aDogdGhpcy5zeXN0ZW0uZW5jcnlwdGlvbkxlbmd0aAogICAgICB9KQogICAgfQoKICAgIGNvbnN0IHByb21pc2VzID0gW10KCiAgICAvLyBlbnN1cmUgbG9jYWwga2V5IGlzIGxvY2FsbHkgYXZhaWxhYmxlIGFsd2F5cwogICAgcHJvbWlzZXMucHVzaCh0aGlzLnN5c3RlbS5nZXQodGhpcy5iYXNlLmxvY2FsLmtleSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkpCgogICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAmJiB0aGlzLmVuY3J5cHRpb24uY29yZSkgewogICAgICBwcm9taXNlcy5wdXNoKAogICAgICAgIHRoaXMuZW5jcnlwdGlvbi5jb3JlLmdldCh0aGlzLnN5c3RlbS5lbmNyeXB0aW9uTGVuZ3RoIC0gMSwgeyB0aW1lb3V0OiB0aGlzLnRpbWVvdXQgfSkKICAgICAgKQogICAgfQoKICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLnN5c3RlbS52aWV3cykgewogICAgICB0aGlzLnZpZXdzLnB1c2godikKICAgICAgY29uc3QgY29yZSA9IHRoaXMuYmFzZS5zdG9yZS5nZXQoeyBrZXk6IHYua2V5LCBhY3RpdmU6IHRydWUgfSkKICAgICAgdGhpcy5jb3Jlcy5wdXNoKGNvcmUpCiAgICAgIGlmICghdi5sZW5ndGgpIGNvbnRpbnVlIC8vIGVuY3J5cHRpb24gdmlldyBjYW4gYmUgMCBsZW5ndGgKICAgICAgcHJvbWlzZXMucHVzaChjb3JlLmdldCh2Lmxlbmd0aCAtIDEsIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogICAgfQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuc3lzdGVtLmluZGV4ZXJzKSB7CiAgICAgIHRoaXMuaW5kZXhlcnMucHVzaChpZHgpCiAgICAgIGlmIChpZHgubGVuZ3RoID09PSAwKSBjb250aW51ZSAvLyBuZWVkIHRvIG1ha2Ugc3VyZSB3ZSBoYXZlIG1hbmlmZXN0Li4uCiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmJhc2Uuc3RvcmUuZ2V0KHsga2V5OiBpZHgua2V5LCBhY3RpdmU6IHRydWUgfSkKICAgICAgdGhpcy5jb3Jlcy5wdXNoKGNvcmUpCiAgICAgIHByb21pc2VzLnB1c2goY29yZS5nZXQoaWR4Lmxlbmd0aCAtIDEsIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogICAgICBwcm9taXNlcy5wdXNoKHRoaXMuc3lzdGVtLmdldChpZHgua2V5LCB7IHRpbWVvdXQ6IHRoaXMudGltZW91dCB9KSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5zeXN0ZW0uaGVhZHMpIHsKICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnN5c3RlbS5nZXQoaGVhZC5rZXksIHsgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gZmFsc2UKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgX2Vuc3VyZUVuY3J5cHRpb24oKSB7CiAgICAvLyBvbmx5IG5lZWQgZW5jcnlwdGlvbiBpZiB3ZSBtaWdyYXRlZAogICAgaWYgKHRoaXMuY29yZS5lbmNyeXB0aW9uICE9PSBudWxsKSByZXR1cm4gdHJ1ZQoKICAgIGNvbnN0IGVuY0NvcmUgPSB0aGlzLmNvcmUubWFuaWZlc3QudmVyc2lvbiA8PSAxID8gbnVsbCA6IHRoaXMuY29yZXNbMV0KCiAgICAvLyBleHBlY3RzIGludGVybmFsIHZpZXdzIHRvIGJlIGxvYWRlZCBpbiBvcmRlcgogICAgdGhpcy5lbmNyeXB0aW9uID0gbmV3IEVuY3J5cHRpb25WaWV3KHRoaXMuYmFzZSwgZW5jQ29yZSkKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLmVuY3J5cHRpb24uZ2V0Vmlld0VuY3J5cHRpb24oJ19zeXN0ZW0nKQoKICAgIGF3YWl0IHRoaXMuY29yZS5zZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24pCgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICBmb3IgKGNvbnN0IHsgcHJvbWlzZSwgdGltZW91dCB9IG9mIHRoaXMud2FpdGluZykgewogICAgICBjbGVhclRpbWVvdXQodGltZW91dCkKICAgICAgcHJvbWlzZS5yZXNvbHZlKCkgLy8gc2lsZW50bHkgYmFpbAogICAgfQogICAgaWYgKHRoaXMuc3lzdGVtKSBhd2FpdCB0aGlzLnN5c3RlbS5jbG9zZSgpCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uKSBhd2FpdCB0aGlzLmVuY3J5cHRpb24uY2xvc2UoKQogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuY29yZXMpIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKY29uc3QgU3lzdGVtVmlldyA9IHJlcXVpcmUoJy4vc3lzdGVtLmpzJykKY29uc3QgeyBFbmNyeXB0aW9uVmlldyB9ID0gcmVxdWlyZSgnLi9lbmNyeXB0aW9uLmpzJykKY29uc3QgeyBNYW5pZmVzdERhdGEgfSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMuanMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGb3JrIHsKICBjb25zdHJ1Y3RvcihiYXNlLCBzdG9yZSwgc3RhdGUsIGZvcmspIHsKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuc3RvcmUgPSBzdG9yZQogICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLmluZGV4ZXJzID0gZm9yay5pbmRleGVycwogICAgdGhpcy5sZW5ndGggPSBmb3JrLmxlbmd0aAogICAgdGhpcy5zeXN0ZW0gPSBudWxsCiAgICB0aGlzLmVuY3J5cHRpb24gPSBudWxsCiAgICB0aGlzLm1hbmlmZXN0cyA9IG51bGwKICAgIHRoaXMuY29yZXMgPSBbXQogIH0KCiAgYXN5bmMgdXBncmFkZSgpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX3VwZ3JhZGUoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgICB9CiAgfQoKICBhc3luYyBfdXBncmFkZSgpIHsKICAgIHRoaXMubWFuaWZlc3RzID0gYXdhaXQgdGhpcy5zdG9yZS5nZXRJbmRleGVyTWFuaWZlc3RzKHRoaXMuaW5kZXhlcnMpCgogICAgdGhpcy5zeXN0ZW0gPSBuZXcgU3lzdGVtVmlldyhhd2FpdCB0aGlzLl9nZXQoJ19zeXN0ZW0nLCB0aGlzLmxlbmd0aCkpCiAgICB0aGlzLmVuY3J5cHRpb24gPSBuZXcgRW5jcnlwdGlvblZpZXcodGhpcywgYXdhaXQgdGhpcy5fZ2V0KCdfZW5jcnlwdGlvbicsIC0xKSkKCiAgICBhd2FpdCB0aGlzLnN5c3RlbS5yZWFkeSgpCiAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb24ucmVhZHkoKQoKICAgIHRoaXMuZW50cm9weSA9IHRoaXMuc3lzdGVtLmdldEVudHJvcHkodGhpcy5pbmRleGVycywgdGhpcy5sZW5ndGgpCiAgICB0aGlzLm1hbmlmZXN0VmVyc2lvbiA9IE1hdGgubWF4KHRoaXMuc3lzdGVtLmNvcmUubWFuaWZlc3QudmVyc2lvbiwgMikgLy8gPj0gMiB0byBzaWduYWwgbmV3IGVuY3J5cHRpb24KCiAgICBjb25zdCB2aWV3cyA9IFtdCiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy5zdGF0ZS52aWV3cykgewogICAgICBjb25zdCB2ID0gdGhpcy5nZXRWaWV3RnJvbVN5c3RlbSh2aWV3LCB0aGlzLnN5c3RlbSkKICAgICAgY29uc3QgaW5kZXhlZExlbmd0aCA9IHYgPyB2Lmxlbmd0aCA6IDAKCiAgICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCB0aGlzLl9nZXQodmlldy5uYW1lLCBpbmRleGVkTGVuZ3RoKQogICAgICBhd2FpdCBzZXNzaW9uLnJlYWR5KCkKCiAgICAgIGNvbnN0IG5leHQgPSBhd2FpdCB0aGlzLmNyZWF0ZVZpZXcodmlldy5uYW1lLCBzZXNzaW9uLCBudWxsKQogICAgICBhd2FpdCBuZXh0LnJlYWR5KCkKCiAgICAgIGF3YWl0IHRoaXMuX21pZ3JhdGUodmlldy5yZWYsIG5leHQsIHZpZXcuY29yZSwgaW5kZXhlZExlbmd0aCkKCiAgICAgIC8vIHVwZGF0ZSBrZXkKICAgICAgdmlld3MucHVzaCh7IGtleTogbmV4dC5rZXksIGxlbmd0aDogaW5kZXhlZExlbmd0aCB9KQogICAgfQoKICAgIC8vIGludGVybmFsIHZpZXdzIGFyZSBleHBsaWNpdGx5IG1pZ3JhdGVkCgogICAgY29uc3QgZW50cm9weSA9IEVuY3J5cHRpb25WaWV3Lm5hbWVzcGFjZSh0aGlzLmVudHJvcHkpCiAgICBhd2FpdCB0aGlzLmVuY3J5cHRpb24udXBkYXRlKGVudHJvcHkpCgogICAgY29uc3Qgc3lzdGVtID0gdGhpcy5zdG9yZS5nZXRWaWV3QnlOYW1lKCdfc3lzdGVtJykKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLnN0b3JlLmdldFZpZXdCeU5hbWUoJ19lbmNyeXB0aW9uJykKCiAgICBjb25zdCBlbmMgPSBhd2FpdCB0aGlzLmNyZWF0ZVZpZXcoJ19lbmNyeXB0aW9uJywgdGhpcy5lbmNyeXB0aW9uLmNvcmUsIG51bGwpCiAgICBhd2FpdCBlbmMucmVhZHkoKQoKICAgIGF3YWl0IHRoaXMuX21pZ3JhdGUoZW5jcnlwdGlvbiwgZW5jLCB0aGlzLmVuY3J5cHRpb24uY29yZSwgdGhpcy5lbmNyeXB0aW9uLmNvcmUubGVuZ3RoKQoKICAgIGF3YWl0IHRoaXMuc3lzdGVtLmZvcmsodGhpcy5pbmRleGVycywgdGhpcy5tYW5pZmVzdHMsIHRoaXMuZW5jcnlwdGlvbi5jb3JlLmxlbmd0aCwgdmlld3MpCgogICAgY29uc3Qgc3lzID0gYXdhaXQgdGhpcy5jcmVhdGVWaWV3KCdfc3lzdGVtJywgdGhpcy5zeXN0ZW0uY29yZSwgW2VuYy5rZXldKQogICAgYXdhaXQgc3lzLnJlYWR5KCkKCiAgICBhd2FpdCB0aGlzLl9taWdyYXRlKHN5c3RlbSwgc3lzLCB0aGlzLnN5c3RlbS5jb3JlLCB0aGlzLnN5c3RlbS5jb3JlLmxlbmd0aCkKICB9CgogIGFzeW5jIGNyZWF0ZVZpZXcobmFtZSwgY29yZSwgbGlua2VkKSB7CiAgICBjb25zdCBwcm9sb2d1ZSA9IGF3YWl0IGdldFByb2xvZ3VlKGNvcmUpCiAgICBjb25zdCBtYW5pZmVzdERhdGEgPSB0aGlzLl9tYW5pZmVzdERhdGEoY29yZSkKCiAgICByZXR1cm4gdGhpcy5zdG9yZS5nZXRWaWV3Q29yZSgKICAgICAgdGhpcy5tYW5pZmVzdHMsCiAgICAgIG5hbWUsCiAgICAgIHByb2xvZ3VlLAogICAgICB0aGlzLm1hbmlmZXN0VmVyc2lvbiwKICAgICAgdGhpcy5lbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQogIH0KCiAgYXN5bmMgX2dldChuYW1lLCBsZW5ndGgpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IG5hbWUgfSkKICAgIHRoaXMuY29yZXMucHVzaChjb3JlKQoKICAgIGlmIChsZW5ndGggIT09IC0xKSBhd2FpdCBjb3JlLnRydW5jYXRlKGxlbmd0aCkKCiAgICByZXR1cm4gY29yZQogIH0KCiAgZ2V0Vmlld0Zyb21TeXN0ZW0odmlldykgewogICAgaWYgKHZpZXcubWFwcGVkSW5kZXggPT09IC0xIHx8IHZpZXcubWFwcGVkSW5kZXggPj0gdGhpcy5zeXN0ZW0udmlld3MubGVuZ3RoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuc3lzdGVtLnZpZXdzW3ZpZXcubWFwcGVkSW5kZXhdCiAgfQoKICBfbWFuaWZlc3REYXRhKHNlc3Npb24pIHsKICAgIGlmIChzZXNzaW9uLm1hbmlmZXN0LnZlcnNpb24gPiAxKSByZXR1cm4gc2Vzc2lvbi5tYW5pZmVzdC51c2VyRGF0YQogICAgcmV0dXJuIGMuZW5jb2RlKE1hbmlmZXN0RGF0YSwgeyB2ZXJzaW9uOiAwLCBsZWdhY3lCbG9ja3M6IHNlc3Npb24ubGVuZ3RoIH0pCiAgfQoKICBhc3luYyBfbWlncmF0ZShyZWYsIG5leHQsIHNvdXJjZSwgbGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICBhd2FpdCBuZXh0LmNvcmUuY29weVByb2xvZ3VlKHNvdXJjZS5zdGF0ZSkKICAgIH0KCiAgICAvLyByZW1ha2UgdGhlIGJhdGNoLCByZXNldCBmcm9tIG91ciBwcm9sb2d1ZSBpbiBjYXNlIGl0IHJlcGxpY2F0ZWQgaW5iZXR3ZWVuCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgcmVhbGx5IGhhdmUgYW4gSEMgZnVuY3Rpb24gZm9yIHRoaXMKICAgIGNvbnN0IGJhdGNoID0gbmV4dC5zZXNzaW9uKHsgbmFtZTogJ2JhdGNoJywgb3ZlcndyaXRlOiB0cnVlLCBjaGVja291dDogbGVuZ3RoIH0pCiAgICBhd2FpdCBiYXRjaC5yZWFkeSgpCgogICAgaWYgKHNvdXJjZSAhPT0gbnVsbCkgewogICAgICB3aGlsZSAoYmF0Y2gubGVuZ3RoIDwgc291cmNlLmxlbmd0aCkgewogICAgICAgIGF3YWl0IGJhdGNoLmFwcGVuZChhd2FpdCBzb3VyY2UuZ2V0KGJhdGNoLmxlbmd0aCkpCiAgICAgIH0KICAgIH0KCiAgICBhd2FpdCByZWYuYmF0Y2guc3RhdGUubW92ZVRvKGJhdGNoLCBiYXRjaC5sZW5ndGgpCiAgICBhd2FpdCBiYXRjaC5jbG9zZSgpCgogICAgcmVmLm1pZ3JhdGVkKHRoaXMuYmFzZSwgbmV4dCkKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICBpZiAodGhpcy5zeXN0ZW0pIGF3YWl0IHRoaXMuc3lzdGVtLmNsb3NlKCkKICAgIGlmICh0aGlzLmVuY3J5cHRpb24pIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5jbG9zZSgpCiAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3JlcykgYXdhaXQgY29yZS5jbG9zZSgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRQcm9sb2d1ZShjb3JlKSB7CiAgaWYgKCFjb3JlLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgcmV0dXJuIHsKICAgIGhhc2g6IGF3YWl0IGNvcmUudHJlZUhhc2goKSwKICAgIGxlbmd0aDogY29yZS5sZW5ndGgKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCgpjb25zdCBDbG9jayA9IHJlcXVpcmUoJy4vY2xvY2suanMnKQpjb25zdCBDb25zZW5zdXMgPSByZXF1aXJlKCcuL2NvbnNlbnN1cy5qcycpCmNvbnN0IFRvcG9saXN0ID0gcmVxdWlyZSgnLi90b3BvbGlzdC5qcycpCgpjbGFzcyBOb2RlIHsKICBjb25zdHJ1Y3Rvcih3cml0ZXIsIGxlbmd0aCwgdmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwZW5kZW5jaWVzLCBvcHRpbWlzdGljLCB0cmFjZSkgewogICAgdGhpcy53cml0ZXIgPSB3cml0ZXIKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICAgIHRoaXMuaGVhZHMgPSBoZWFkcwogICAgdGhpcy5hY3R1YWxIZWFkcyA9IGhlYWRzLnNsaWNlKDApIC8vIFRPRE86IHdlIHNob3VsZCByZW1vdmUgdGhpcyBhbmQganVzdCBub3QgbXV0YXRlIGhlYWRzLi4uCgogICAgdGhpcy5kZXBlbmRlbnRzID0gbmV3IFNldCgpCiAgICB0aGlzLmRlcGVuZGVuY2llcyA9IGRlcGVuZGVuY2llcwogICAgdGhpcy5pbmRleCA9IDAgLy8gdXNlZCBieSB0b3BvbGlzdAoKICAgIHRoaXMub3B0aW1pc3RpYyA9IG9wdGltaXN0aWMgJiYgYmF0Y2ggPT09IDEgJiYgISF2YWx1ZQoKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5kcm9wcGVkID0gMAogICAgdGhpcy50cmFjZSA9IHRyYWNlCgogICAgdGhpcy5jbG9jayA9IG5ldyBDbG9jaygpCgogICAgdGhpcy55aWVsZGVkID0gZmFsc2UKICAgIHRoaXMueWllbGRpbmcgPSBmYWxzZQogIH0KCiAgaXNUYWlsKCkgewogICAgcmV0dXJuIHRoaXMuZGVwZW5kZW5jaWVzLnNpemUgPT09IHRoaXMuZHJvcHBlZAogIH0KCiAgY2F1c2FsRGVwZW5kZW5jaWVzKGlkeCkgewogICAgY29uc3Qgb3JkZXIgPSBbdGhpc10KICAgIGNvbnN0IHN0YWNrID0gW3RoaXNdCgogICAgbGV0IHZpc2l0ZWQgPSBudWxsCgogICAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCiAgICAgIGZvciAoY29uc3QgZGVwIG9mIG5vZGUuZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgaWYgKCFkZXAud3JpdGVyLmlzUmVtb3ZlZCB8fCBkZXAud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgY29udGludWUKCiAgICAgICAgLy8gVE9ETzogcmVwbGFjZSB3aXRoICJjb2xvcmluZyIgYnV0IG9rIGZvciBub3csIHRpbnkgc2V0CiAgICAgICAgaWYgKHZpc2l0ZWQgPT09IG51bGwpIHZpc2l0ZWQgPSBuZXcgU2V0KCkKICAgICAgICBpZiAodmlzaXRlZC5oYXMoZGVwKSkgY29udGludWUKICAgICAgICB2aXNpdGVkLmFkZChkZXApCgogICAgICAgIHN0YWNrLnB1c2goZGVwKQogICAgICAgIG9yZGVyLnB1c2goZGVwKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG9yZGVyCiAgfQoKICBjbGVhcigpIHsKICAgIHRoaXMuY2xvY2sgPSBudWxsCiAgICB0aGlzLmRlcGVuZGVudHMgPSBudWxsCiAgICByZXR1cm4gdGhpcwogIH0KCiAgcmVzZXQoKSB7CiAgICB0aGlzLnlpZWxkZWQgPSBmYWxzZQogICAgdGhpcy55aWVsZGluZyA9IGZhbHNlCiAgICBmb3IgKGNvbnN0IGRlcCBvZiB0aGlzLmRlcGVuZGVudHMpIGRlcC5kZXBlbmRlbmNpZXMuYWRkKHRoaXMpCiAgICB0aGlzLmRlcGVuZGVudHMuY2xlYXIoKQogIH0KCiAgYWN0aXZlKCkgewogICAgZm9yIChjb25zdCBkZXAgb2YgdGhpcy5kZXBlbmRlbmNpZXMpIHsKICAgICAgaWYgKGRlcC55aWVsZGVkKSB7CiAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMuZGVsZXRlKGRlcCkgLy8gbm9kZXMgbWlnaHQgYmUgeWllbGRlZCBkdXJpbmcgYnVmZmVyaW5nCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVwLmRlcGVuZGVudHMuYWRkKHRoaXMpCiAgICAgICAgdGhpcy5jbG9jay5hZGQoZGVwLmNsb2NrKQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgdGhpcy5jbG9jay5zZXQodGhpcy53cml0ZXIuY29yZS5rZXksIHRoaXMubGVuZ3RoKQogIH0KCiAgdGllQnJlYWsobm9kZSkgewogICAgcmV0dXJuIHRpZUJyZWFrKHRoaXMsIG5vZGUpCiAgfQoKICBoYXNEZXBlbmRlbmN5KGRlcCkgewogICAgZm9yIChjb25zdCBoIG9mIHRoaXMuYWN0dWFsSGVhZHMpIHsKICAgICAgaWYgKHNhbWVOb2RlKGgsIGRlcCkpIHJldHVybiB0cnVlCiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIGdldCByZWYoKSB7CiAgICByZXR1cm4gdGhpcy53cml0ZXIuY29yZS5rZXkudG9TdHJpbmcoJ2hleCcpLnNsaWNlKDAsIDIpICsgJzonICsgdGhpcy5sZW5ndGgKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTGluZWFyaXplciB7CiAgY29uc3RydWN0b3IoaW5kZXhlcnMsIHsgaGVhZHMgPSBbXSwgd3JpdGVycyA9IG5ldyBNYXAoKSB9ID0ge30pIHsKICAgIHRoaXMuaGVhZHMgPSBuZXcgU2V0KCkKICAgIHRoaXMudGFpbHMgPSBuZXcgU2V0KCkKICAgIHRoaXMudGlwID0gbmV3IFRvcG9saXN0KCkKICAgIHRoaXMuc2l6ZSA9IDAgLy8gdXNlZnVsIGZvciBkZWJ1Z2dpbmcKICAgIHRoaXMudXBkYXRlZCA9IGZhbHNlCiAgICB0aGlzLmluZGV4ZXJzVXBkYXRlZCA9IGZhbHNlCiAgICB0aGlzLndyaXRlcnMgPSB3cml0ZXJzCgogICAgdGhpcy5jb25zZW5zdXMgPSBuZXcgQ29uc2Vuc3VzKGluZGV4ZXJzKQogICAgdGhpcy5faW5pdGlhbEhlYWRzID0gaGVhZHMuc2xpY2UoMCkKICAgIHRoaXMuX3N0cmljdGx5QWRkZWQgPSBudWxsCgogICAgZm9yIChjb25zdCB7IGtleSwgbGVuZ3RoIH0gb2YgaGVhZHMpIHsKICAgICAgdGhpcy5jb25zZW5zdXMucmVtb3ZlZC5zZXQoa2V5LCBsZW5ndGgpCiAgICB9CiAgfQoKICBnZXQgaW5kZXhlcnMoKSB7CiAgICByZXR1cm4gdGhpcy5jb25zZW5zdXMuaW5kZXhlcnMKICB9CgogIHN0YXRpYyBjcmVhdGVOb2RlKHdyaXRlciwgbGVuZ3RoLCB2YWx1ZSwgaGVhZHMsIGJhdGNoLCBkZXBlbmRlbmNpZXMsIG9wdGltaXN0aWMsIHRyYWNlKSB7CiAgICByZXR1cm4gbmV3IE5vZGUod3JpdGVyLCBsZW5ndGgsIHZhbHVlLCBoZWFkcywgYmF0Y2gsIGRlcGVuZGVuY2llcywgb3B0aW1pc3RpYywgdHJhY2UpCiAgfQoKICAvLyByZXR1cm5zIHRoZSBnbG9iYWwgbGlua3Mgb2YgdGhlIGRhZywgdXNlIHRoaXMgdG8gbGluayBhZ2FpbnN0IHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBkYWcKICAvLyBUT0RPOiByZW5hbWUgdG8gaGVhZHMoKSBhbmQgbW92ZSB0aGUgc2V0cyB0byBfIHByb3BzCiAgZ2V0SGVhZHMoKSB7CiAgICBjb25zdCBoZWFkcyA9IHRoaXMuX2luaXRpYWxIZWFkcy5zbGljZSgwKQogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuaGVhZHMpIGhlYWRzLnB1c2goeyBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LCBsZW5ndGg6IG5vZGUubGVuZ3RoIH0pCiAgICByZXR1cm4gaGVhZHMKICB9CgogIC8vIFRPRE86IG1pZ2h0IGNvbnRhaW4gZHVwcyBhdG0sIG5iZCBmb3IgaG93IHdlIHVzZSBpdCwgcmV0dXJucyBhbiBhcnJheSBvZiB3cml0ZXJzIHlvdSBjYW4gInB1bGwiCiAgLy8gdG8gZ2V0IHRoZSBmdWxsIGRhZyB2aWV3IGF0IGFueSB0aW1lCiAgZ2V0Qm9vdHN0cmFwV3JpdGVycygpIHsKICAgIGNvbnN0IHdyaXRlcnMgPSBbXQoKICAgIGZvciAoY29uc3QgaGVhZCBvZiB0aGlzLmhlYWRzKSB3cml0ZXJzLnB1c2goaGVhZC53cml0ZXIpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY29uc2Vuc3VzLmluZGV4ZXJzLmxlbmd0aDsgaSsrKQogICAgICB3cml0ZXJzLnB1c2godGhpcy5jb25zZW5zdXMuaW5kZXhlcnNbaV0pCgogICAgcmV0dXJuIHdyaXRlcnMKICB9CgogIGFkZEhlYWQobm9kZSkgewogICAgbm9kZS5hY3RpdmUoKQoKICAgIC8vIDk5Ljk5JSBvZiB0aGUgdGltZSBfaW5pdGlhbEhlYWRzIGlzIGVtcHR5Li4uCiAgICBpZiAodGhpcy5faW5pdGlhbEhlYWRzLmxlbmd0aCA+IDApIHRoaXMuX3VwZGF0ZUluaXRpYWxIZWFkcyhub2RlKQoKICAgIGlmIChub2RlLmlzVGFpbCgpKSB7CiAgICAgIHRoaXMudGFpbHMuYWRkKG5vZGUpCiAgICB9CgogICAgZm9yIChjb25zdCBoZWFkIG9mIHRoaXMuaGVhZHMpIHsKICAgICAgaWYgKG5vZGUuaGFzRGVwZW5kZW5jeShoZWFkKSkgewogICAgICAgIHRoaXMuaGVhZHMuZGVsZXRlKGhlYWQpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnRpcC5hZGQobm9kZSkKICAgIGlmIChub2RlLndyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHRoaXMuY29uc2Vuc3VzLmFkZEhlYWQobm9kZSkKCiAgICB0aGlzLnNpemUrKwogICAgdGhpcy5oZWFkcy5hZGQobm9kZSkKCiAgICB0aGlzLnVwZGF0ZWQgPSB0cnVlCgogICAgcmV0dXJuIG5vZGUKICB9CgogIHVwZGF0ZSgpIHsKICAgIGlmICghdGhpcy51cGRhdGVkKSByZXR1cm4gbnVsbAogICAgdGhpcy51cGRhdGVkID0gZmFsc2UKCiAgICAvLyBnZXQgdGhlIGluZGV4ZWQgbm9kZXMKICAgIGNvbnN0IGluZGV4ZWQgPSBbXQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3Qgbm9kZXMgPSB0aGlzLmNvbnNlbnN1cy5zaGlmdCgpCiAgICAgIGlmICghbm9kZXMubGVuZ3RoKSBicmVhawoKICAgICAgdGhpcy5feWllbGQobm9kZXMsIGluZGV4ZWQpCiAgICB9CgogICAgcmV0dXJuIHRoaXMudGlwLmZsdXNoKGluZGV4ZWQpCiAgfQoKICBfdXBkYXRlSW5pdGlhbEhlYWRzKG5vZGUpIHsKICAgIGZvciAoY29uc3QgaGVhZCBvZiBub2RlLmFjdHVhbEhlYWRzKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5faW5pdGlhbEhlYWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgeyBrZXksIGxlbmd0aCB9ID0gdGhpcy5faW5pdGlhbEhlYWRzW2ldCiAgICAgICAgaWYgKGxlbmd0aCAhPT0gaGVhZC5sZW5ndGggfHwgIWI0YS5lcXVhbHMoa2V5LCBoZWFkLmtleSkpIGNvbnRpbnVlCiAgICAgICAgdGhpcy5faW5pdGlhbEhlYWRzLnNwbGljZShpLS0sIDEpCiAgICAgIH0KICAgIH0KICB9CgogIC8qIEFjayBtZXRob2RzICovCgogIHNob3VsZEFjayh3cml0ZXIsIHBlbmRpbmcgPSBmYWxzZSkgewogICAgaWYgKCF3cml0ZXIgfHwgIXdyaXRlci5pc0FjdGl2ZUluZGV4ZXIpIHJldHVybiBmYWxzZQoKICAgIC8vIGFsbCBpbmRleGVycyBoYXZlIHRvIGZsdXNoZWQgdG8gdGhlIGRhZyBiZWZvcmUgd2UgYWNrIGFzIGEgcXVpY2sgImRlYm91bmNlIgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgaWYgKHcubGVuZ3RoICE9PSB3LmF2YWlsYWJsZSkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgbGV0IGlzSGVhZCA9IGZhbHNlCgogICAgLy8gaWYgQU5ZIGhlYWQgaXMgbm90IGFuIGluZGV4ZXIgYWNrCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5oZWFkcykgewogICAgICBpZiAoIWhlYWQud3JpdGVyLmlzQWN0aXZlSW5kZXhlcikgcmV0dXJuIHRydWUKICAgICAgaWYgKGhlYWQud3JpdGVyID09PSB3cml0ZXIpIGlzSGVhZCA9IHRydWUKICAgIH0KCiAgICBpZiAodGhpcy5oZWFkcy5zaXplID09PSAxICYmIGlzSGVhZCkgewogICAgICByZXR1cm4gZmFsc2UgLy8gbmV2ZXIgc2VsZi1hY2shCiAgICB9CgogICAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQoKQoKICAgIC8vIGNoZWNrIGlmIHRoZXJlIGlzIG5vbi1udWxsIHZhbHVlCiAgICBsZXQgdmFsdWVDaGVjayA9IGZhbHNlCgogICAgZm9yIChjb25zdCB0YWlsIG9mIHRoaXMudGFpbHMpIHsKICAgICAgaWYgKHBlbmRpbmcgfHwgdGhpcy5fbm9uTnVsbCh0YWlsLCB2aXNpdGVkKSkgewogICAgICAgIHZhbHVlQ2hlY2sgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICghdmFsdWVDaGVjaykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMuY29uc2Vuc3VzLnNob3VsZEFjayh3cml0ZXIpKSByZXR1cm4gdHJ1ZQoKICAgIHJldHVybiB0aGlzLl9zaG91bGRBY2tIZWFkcyh3cml0ZXIsIHBlbmRpbmcpCiAgfQoKICAvLyBjaGVjayBpZiB0aGVyZSBpcyBhbnkgdmFsdWUgYWJvdmUgdGhpcyBub2RlCiAgX25vbk51bGwodGFyZ2V0LCB2aXNpdGVkKSB7CiAgICBjb25zdCBzdGFjayA9IFt0YXJnZXRdCgogICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkgewogICAgICBjb25zdCBub2RlID0gc3RhY2sucG9wKCkKCiAgICAgIGlmICh2aXNpdGVkLmhhcyhub2RlKSkgY29udGludWUKICAgICAgaWYgKG5vZGUudmFsdWUgIT09IG51bGwpIHJldHVybiB0cnVlCgogICAgICB2aXNpdGVkLmFkZChub2RlKQoKICAgICAgZm9yIChjb25zdCBkZXAgb2Ygbm9kZS5kZXBlbmRlbnRzKSB7CiAgICAgICAgc3RhY2sucHVzaChkZXApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8vIGFjayBpZiBhbnkgaGVhZCBpcyBjbG9zZXIgdG8gY29uZmlybWluZyBhIHZhbHVlCiAgX3Nob3VsZEFja0hlYWRzKHdyaXRlciwgcGVuZGluZykgewogICAgY29uc3QgcHJldiA9IHdyaXRlci5oZWFkKCkKCiAgICBmb3IgKGNvbnN0IGhlYWQgb2YgdGhpcy5oZWFkcykgewogICAgICAvLyBvbmx5IGNoZWNrIG90aGVyIHdyaXRlcnMgaGVhZHMKICAgICAgaWYgKGhlYWQud3JpdGVyID09PSB3cml0ZXIpIGNvbnRpbnVlCgogICAgICBjb25zdCBzdGFjayA9IFtoZWFkXQogICAgICBjb25zdCB2aXNpdGVkID0gbmV3IFNldCgpCgogICAgICB3aGlsZSAoc3RhY2subGVuZ3RoKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCgogICAgICAgIGlmICh2aXNpdGVkLmhhcyhub2RlKSkgY29udGludWUKICAgICAgICB2aXNpdGVkLmFkZChub2RlKQoKICAgICAgICBpZiAocGVuZGluZyB8fCBub2RlLnZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBhY2tzID0gdGhpcy5jb25zZW5zdXMuYWNrc0Zyb21Ob2RlKG5vZGUsIGhlYWQpCiAgICAgICAgICBjb25zdCBwcmV2QWNrcyA9IHRoaXMuY29uc2Vuc3VzLmFja3NGcm9tTm9kZShub2RlLCBwcmV2KQoKICAgICAgICAgIC8vIGhlYWQgc2VlcyBtb3JlIGFja3MKICAgICAgICAgIGlmIChhY2tzLnNpemUgPiBwcmV2QWNrcy5zaXplKSByZXR1cm4gdHJ1ZQoKICAgICAgICAgIGZvciAoY29uc3QgaWR4IG9mIGFja3MpIHsKICAgICAgICAgICAgLy8gaGVhZCBzZWVzIGFja3MgdGhhdCB3cml0ZXIgZG9lcyBub3QKICAgICAgICAgICAgaWYgKCFwcmV2QWNrcy5oYXMoaWR4KSkgcmV0dXJuIHRydWUKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBib3RoIHNlZW4sIG5vIHBvaW50IGdvaW5nIGFueSBmdXJ0aGVyIGRvd24KICAgICAgICAgIGlmIChwcmV2QWNrcy5zaXplICYmIGFja3Muc2l6ZSkgY29udGludWUKICAgICAgICB9CgogICAgICAgIHN0YWNrLnB1c2goLi4ubm9kZS5kZXBlbmRlbmNpZXMpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8qIEZ1bGwgREFHIG1ldGhvZHMgKi8KCiAgX3lpZWxkKG5vZGVzLCBpbmRleGVkID0gW10pIHsKICAgIGNvbnN0IG9mZnNldCA9IGluZGV4ZWQubGVuZ3RoCiAgICBjb25zdCB0YWlscyA9IFtdCgogICAgLy8gZGV0ZXJtaW5lIHdoaWNoIG5vZGVzIGFyZSB5aWVsZGVkCiAgICB3aGlsZSAobm9kZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBub2Rlcy5wb3AoKQoKICAgICAgaWYgKG5vZGUueWllbGRpbmcpIGNvbnRpbnVlCiAgICAgIG5vZGUueWllbGRpbmcgPSB0cnVlCgogICAgICBpZiAobm9kZS5pc1RhaWwoKSkgdGFpbHMucHVzaChub2RlKQoKICAgICAgbm9kZXMucHVzaCguLi5ub2RlLmRlcGVuZGVuY2llcykKICAgIH0KCiAgICB3aGlsZSAodGFpbHMubGVuZ3RoKSB7CiAgICAgIGxldCB0YWlsID0gdGFpbHMucG9wKCkKCiAgICAgIGZvciAodGFpbCBvZiB0aGlzLl9yZW1vdmVCYXRjaCh0YWlsKSkgewogICAgICAgIFRvcG9saXN0LmFkZCh0YWlsLCBpbmRleGVkLCBvZmZzZXQpCiAgICAgIH0KCiAgICAgIGZvciAoY29uc3QgZGVwIG9mIHRhaWwuZGVwZW5kZW50cykgewogICAgICAgIGlmIChkZXAuaXNUYWlsKCkgJiYgZGVwLnlpZWxkaW5nKSB0YWlscy5wdXNoKGRlcCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBpbmRleGVkCiAgfQoKICBfaXNGdXR1cmVUYWlsKG5vZGUpIHsKICAgIGxldCBkcm9wcGVkID0gbm9kZS5kcm9wcGVkCgogICAgLy8gYSB0YWlsIGhhcyBubyB1bnlpZWxkZWQgZGVwZW5kZW5jaWVzCiAgICBmb3IgKGNvbnN0IGRlcCBvZiBub2RlLmRlcGVuZGVuY2llcykgewogICAgICBpZiAoZGVwLnlpZWxkZWQpIGNvbnRpbnVlCiAgICAgIGlmIChkcm9wcGVkID09PSAwKSByZXR1cm4gZmFsc2UKICAgICAgZHJvcHBlZC0tCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZW1vdmVOb2RlKG5vZGUpIHsKICAgIHRoaXMudGFpbHMuZGVsZXRlKG5vZGUpCiAgICB0aGlzLmhlYWRzLmRlbGV0ZShub2RlKQogICAgdGhpcy5jb25zZW5zdXMucmVtb3ZlKG5vZGUpCgogICAgLy8gdXBkYXRlIHRoZSB0YWlsc2V0CiAgICBmb3IgKGNvbnN0IGQgb2Ygbm9kZS5kZXBlbmRlbnRzKSB7CiAgICAgIGlmIChkLnlpZWxkaW5nICYmIGQuZGVwZW5kZW5jaWVzLmhhcyhub2RlKSkKICAgICAgICBkLmRyb3BwZWQrKyAvLyBrZWVwIGxpbmtzIGZvciB0aGUgaW5kZXhlZCBiYXRjaAogICAgICBlbHNlIGQuZGVwZW5kZW5jaWVzLmRlbGV0ZShub2RlKQogICAgICBpZiAodGhpcy5faXNGdXR1cmVUYWlsKGQpKSB0aGlzLnRhaWxzLmFkZChkKQogICAgfQoKICAgIG5vZGUueWllbGRlZCA9IHRydWUKICAgIHRoaXMuc2l6ZS0tCgogICAgaWYgKHRoaXMuaGVhZHMuc2l6ZSA9PT0gMCkgewogICAgICAvLyBpbiBjYXNlIG9mIGEgc2luZ2xlIHdyaXRlciB0aGUgZGFnIG1pZ2h0IGRyYWluIGltbWVkaWF0ZWx5Li4uCiAgICAgIHRoaXMuX2luaXRpYWxIZWFkcy5wdXNoKHsga2V5OiBub2RlLndyaXRlci5jb3JlLmtleSwgbGVuZ3RoOiBub2RlLmxlbmd0aCB9KQogICAgfQoKICAgIHJldHVybiBub2RlCiAgfQoKICBfcmVtb3ZlQmF0Y2gobm9kZSkgewogICAgY29uc3QgYmF0Y2ggPSBbdGhpcy5fcmVtb3ZlTm9kZShub2RlKV0KCiAgICB3aGlsZSAobm9kZS5iYXRjaCAhPT0gMSkgewogICAgICAvLyBpdHMgYSBiYXRjaCEKICAgICAgaWYgKG5vZGUuZGVwZW5kZW50cy5zaXplID09PSAwKSB7CiAgICAgICAgLy8gYmFkIGJhdGNoIG5vZGUsIGF1dG8gY29ycmVjdAogICAgICAgIGNvbnN0IG5leHQgPSBub2RlLndyaXRlci5nZXQobm9kZS5sZW5ndGgpCiAgICAgICAgaWYgKG5leHQgJiYgbmV4dC5iYXRjaCA9PT0gbm9kZS5iYXRjaCAtIDEpIG5vZGUuZGVwZW5kZW50cy5hZGQobmV4dCkKICAgICAgfQoKICAgICAgYXNzZXJ0KG5vZGUuZGVwZW5kZW50cy5zaXplID09PSAxLCAnQmF0Y2ggaXMgbGlua2VkIHBhcnRpYWxseSwgd2hpY2ggaXMgbm90IGFsbG93ZWQnKQoKICAgICAgbm9kZSA9IGdldEZpcnN0KG5vZGUuZGVwZW5kZW50cykKICAgICAgYmF0Y2gucHVzaCh0aGlzLl9yZW1vdmVOb2RlKG5vZGUpKQogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KfQoKZnVuY3Rpb24gdGllQnJlYWsoYSwgYikgewogIHJldHVybiBUb3BvbGlzdC5jb21wYXJlKGEsIGIpIDwgMCAvLyBsb3dlc3Qga2V5IHdpcwp9CgpmdW5jdGlvbiBnZXRGaXJzdChzZXQpIHsKICByZXR1cm4gc2V0W1N5bWJvbC5pdGVyYXRvcl0oKS5uZXh0KCkudmFsdWUKfQoKZnVuY3Rpb24gc2FtZU5vZGUoYSwgYikgewogIHJldHVybiBiNGEuZXF1YWxzKGEua2V5LCBiLndyaXRlci5jb3JlLmtleSkgJiYgYS5sZW5ndGggPT09IGIubGVuZ3RoCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKCmNvbnN0IEdURSA9IGI0YS5mcm9tKFttZXNzYWdlcy5MSU5FQVJJWkVSX1BSRUZJWF0pCmNvbnN0IExUID0gYjRhLmZyb20oW21lc3NhZ2VzLkxJTkVBUklaRVJfUFJFRklYICsgMV0pCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIExvY2FsU3RhdGUgewogIGNvbnN0cnVjdG9yKGNvcmUpIHsKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMudHggPSBudWxsCiAgfQoKICBzdGF0aWMgY2xlYXIoY29yZSkgewogICAgY29uc3QgdHggPSBjb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQogICAgdHguZGVsZXRlTG9jYWxSYW5nZShHVEUsIExUKQogICAgcmV0dXJuIHR4LmZsdXNoKCkKICB9CgogIHN0YXRpYyBhc3luYyBtb3ZlVG8oc3JjLCBkc3QpIHsKICAgIGNvbnN0IGJvb3QgPSBhd2FpdCBzcmMuZ2V0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnKQogICAgY29uc3QgdHggPSBkc3Quc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdHguZGVsZXRlTG9jYWxSYW5nZShHVEUsIExUKQoKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzcmMuc3RhdGUuc3RvcmFnZS5jcmVhdGVMb2NhbFN0cmVhbSh7IGd0ZTogR1RFLCBsdDogTFQgfSkpIHsKICAgICAgdHgucHV0TG9jYWwoZGF0YS5rZXksIGRhdGEudmFsdWUpCiAgICB9CgogICAgdHgucHV0VXNlckRhdGEoJ2F1dG9iYXNlL2Jvb3QnLCBib290KQoKICAgIGF3YWl0IHR4LmZsdXNoKCkKICB9CgogIHNldEJvb3RSZWNvcmQoYm9vdCkgewogICAgaWYgKHRoaXMudHggPT09IG51bGwpIHRoaXMudHggPSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdGhpcy50eC5wdXRVc2VyRGF0YSgnYXV0b2Jhc2UvYm9vdCcsIGMuZW5jb2RlKG1lc3NhZ2VzLkJvb3RSZWNvcmQsIGJvb3QpKQogIH0KCiAgYXN5bmMgbGlzdFVwZGF0ZXMoKSB7CiAgICBjb25zdCB1cGRhdGVzID0gW10KCiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2UuY3JlYXRlTG9jYWxTdHJlYW0oeyBndGU6IEdURSwgbHQ6IExUIH0pKSB7CiAgICAgIGNvbnN0IHVwZGF0ZSA9IGMuZGVjb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJVcGRhdGUsIGRhdGEudmFsdWUpCiAgICAgIGNvbnN0IHNlcSA9IGMuZGVjb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJLZXksIGRhdGEua2V5KQogICAgICB1cGRhdGUuc2VxID0gc2VxCiAgICAgIHVwZGF0ZXMucHVzaCh1cGRhdGUpCiAgICB9CgogICAgcmV0dXJuIHVwZGF0ZXMKICB9CgogIGNsZWFyVXBkYXRlcygpIHsKICAgIGlmICh0aGlzLnR4ID09PSBudWxsKSB0aGlzLnR4ID0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHRoaXMudHguZGVsZXRlTG9jYWxSYW5nZShHVEUsIExUKQogIH0KCiAgZGVsZXRlVXBkYXRlKHVwZGF0ZSkgewogICAgaWYgKHRoaXMudHggPT09IG51bGwpIHRoaXMudHggPSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgdGhpcy50eC5kZWxldGVMb2NhbChjLmVuY29kZShtZXNzYWdlcy5MaW5lYXJpemVyS2V5LCB1cGRhdGUuc2VxKSkKICB9CgogIGluc2VydFVwZGF0ZSh1cGRhdGUpIHsKICAgIGlmICh0aGlzLnR4ID09PSBudWxsKSB0aGlzLnR4ID0gdGhpcy5jb3JlLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQoKICAgIHRoaXMudHgucHV0TG9jYWwoCiAgICAgIGMuZW5jb2RlKG1lc3NhZ2VzLkxpbmVhcml6ZXJLZXksIHVwZGF0ZS5zZXEpLAogICAgICBjLmVuY29kZShtZXNzYWdlcy5MaW5lYXJpemVyVXBkYXRlLCB1cGRhdGUpCiAgICApCiAgfQoKICBmbHVzaCgpIHsKICAgIGlmICghdGhpcy50eCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgZmx1c2hpbmcgPSB0aGlzLnR4LmZsdXNoKCkKICAgIHRoaXMudHggPSBudWxsCiAgICByZXR1cm4gZmx1c2hpbmcKICB9Cn0KY29uc3Qgc2NoZW1hID0gcmVxdWlyZSgnLi4vZW5jb2Rpbmcvc3BlYy9hdXRvYmFzZScpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBXYWtldXA6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2Uvd2FrZXVwJyksCiAgQ2xvY2s6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvY2xvY2snKSwKICBDaGVja291dDogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9jaGVja291dCcpLAogIEJvb3RSZWNvcmQ6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvYm9vdC1yZWNvcmQnKSwKICBPcGxvZ01lc3NhZ2U6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2Uvb3Bsb2ctbWVzc2FnZScpLAogIENoZWNrcG9pbnQ6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvY2hlY2twb2ludCcpLAogIEluZm86IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvaW5mbycpLAogIE1lbWJlcjogc2NoZW1hLnJlc29sdmVTdHJ1Y3QoJ0BhdXRvYmFzZS9tZW1iZXInKSwKICBNYW5pZmVzdERhdGE6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvbWFuaWZlc3QtZGF0YScpLAogIExJTkVBUklaRVJfUFJFRklYOiAxLAogIExpbmVhcml6ZXJLZXk6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvbGluZWFyaXplci1rZXknKSwKICBMaW5lYXJpemVyVXBkYXRlOiBzY2hlbWEucmVzb2x2ZVN0cnVjdCgnQGF1dG9iYXNlL2xpbmVhcml6ZXItdXBkYXRlJyksCiAgRW5jcnlwdGlvbkRlc2NyaXB0b3I6IHNjaGVtYS5yZXNvbHZlU3RydWN0KCdAYXV0b2Jhc2UvZW5jcnlwdGlvbi1kZXNjcmlwdG9yJykKfQpjb25zdCBERUZBVUxUX1NJWkUgPSAzMgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOb2RlQnVmZmVyIHsKICBjb25zdHJ1Y3RvcihvZmZzZXQsIGh3bSkgewogICAgdGhpcy5od20gPSBod20gfHwgREVGQVVMVF9TSVpFCiAgICB0aGlzLmRlZmF1bHRId20gPSB0aGlzLmh3bQogICAgdGhpcy5tYXNrID0gdGhpcy5od20gLSAxCiAgICB0aGlzLnRvcCA9IDAKICAgIHRoaXMuYnRtID0gMAogICAgdGhpcy5idWZmZXIgPSBuZXcgQXJyYXkodGhpcy5od20pCiAgICB0aGlzLm9mZnNldCA9IG9mZnNldCB8fCAwCiAgICB0aGlzLmxlbmd0aCA9IHRoaXMub2Zmc2V0CiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCAtIHRoaXMub2Zmc2V0CiAgfQoKICBpc0VtcHR5KCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID09PSB0aGlzLm9mZnNldAogIH0KCiAgaXNGdWxsKCkgewogICAgcmV0dXJuIHRoaXMuc2l6ZSA9PT0gdGhpcy5idWZmZXIubGVuZ3RoCiAgfQoKICBncm93KCkgewogICAgdGhpcy5od20gPDw9IDEKCiAgICBjb25zdCBzaXplID0gdGhpcy5zaXplCiAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXkodGhpcy5od20pCiAgICBjb25zdCBtYXNrID0gdGhpcy5od20gLSAxCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgYnVmZmVyW2ldID0gdGhpcy5idWZmZXJbKHRoaXMuYnRtICsgaSkgJiB0aGlzLm1hc2tdCiAgICB9CgogICAgdGhpcy5tYXNrID0gbWFzawogICAgdGhpcy50b3AgPSBzaXplCiAgICB0aGlzLmJ0bSA9IDAKICAgIHRoaXMuYnVmZmVyID0gYnVmZmVyCiAgfQoKICBwdXNoKGRhdGEpIHsKICAgIGlmICh0aGlzLmlzRnVsbCgpKSB0aGlzLmdyb3coKQoKICAgIHRoaXMuYnVmZmVyW3RoaXMudG9wXSA9IGRhdGEKICAgIHRoaXMudG9wID0gKHRoaXMudG9wICsgMSkgJiB0aGlzLm1hc2sKCiAgICByZXR1cm4gdGhpcy5sZW5ndGgrKwogIH0KCiAgc2hpZnQoKSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpIHJldHVybiBudWxsCgogICAgY29uc3QgbGFzdCA9IHRoaXMuYnVmZmVyW3RoaXMuYnRtXQoKICAgIHRoaXMuYnVmZmVyW3RoaXMuYnRtXSA9IHVuZGVmaW5lZAogICAgdGhpcy5idG0gPSAodGhpcy5idG0gKyAxKSAmIHRoaXMubWFzawogICAgdGhpcy5vZmZzZXQrKwoKICAgIC8vIHJlc2V0IG9uIGVtcHR5CiAgICBpZiAodGhpcy5pc0VtcHR5KCkgJiYgdGhpcy5od20gIT09IHRoaXMuZGVmYXVsdEh3bSkgewogICAgICB0aGlzLmJ1ZmZlciA9IG5ldyBBcnJheSh0aGlzLmRlZmF1bHRId20pCiAgICAgIHRoaXMuaHdtID0gdGhpcy5idWZmZXIubGVuZ3RoCiAgICAgIHRoaXMubWFzayA9IHRoaXMuaHdtIC0gMQogICAgICB0aGlzLnRvcCA9IHRoaXMuYnRtID0gMAogICAgfQoKICAgIHJldHVybiBsYXN0CiAgfQoKICBnZXQoc2VxKSB7CiAgICBpZiAoc2VxIDwgdGhpcy5vZmZzZXQgfHwgc2VxID49IHRoaXMubGVuZ3RoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuYnVmZmVyWyh0aGlzLmJ0bSArIChzZXEgLSB0aGlzLm9mZnNldCkpICYgdGhpcy5tYXNrXQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBIeXBlcmNvcmUgPSByZXF1aXJlKCdoeXBlcmNvcmUnKQoKY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuL21lc3NhZ2VzLmpzJykKCmNvbnN0IERFRkFVTFRfTUFOSUZFU1RfVkVSU0lPTiA9IDEKY29uc3QgSU5ERVhfVkVSU0lPTiA9IDEKY29uc3QgTUFYX1RSQUNFX1BFUl9WSUVXID0gMjU2Cgpjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQoKY29uc3QgW05TX1NJR05FUl9OQU1FU1BBQ0VdID0gY3J5cHRvLm5hbWVzcGFjZSgnYXV0b2Jhc2UnLCAxKQoKY2xhc3MgVmlld0NvcmUgewogIGNvbnN0cnVjdG9yKG5hbWUsIGNvcmUsIGJhc2UpIHsKICAgIHRoaXMubmFtZSA9IG5hbWUKICAgIHRoaXMuY29yZSA9IG51bGwKICAgIHRoaXMuYmF0Y2ggPSBudWxsCiAgICB0aGlzLmF0b21pY0JhdGNoID0gbnVsbAogICAgdGhpcy50cmFjZXIgPSBuZXcgVHJhY2VyKCkKCiAgICB0aGlzLm1pZ3JhdGVkKGJhc2UsIGNvcmUpCiAgfQoKICBnZXRDb3JlKCkgewogICAgcmV0dXJuIHRoaXMuYXRvbWljQmF0Y2ggfHwgdGhpcy5iYXRjaCB8fCB0aGlzLmNvcmUKICB9CgogIG1pZ3JhdGVkKGJhc2UsIGNvcmUpIHsKICAgIC8vIFRPRE86IGNsb3NlIG9sZCBjb3JlIGlmIHByZXNlbnQsIGZvciBub3cgd2UganVzdCBjbG9zZSB3aGVuIHRoZSBhdXRvYmFzZSBpcyBjbG9zZWQgaW5kaXJlY3RseQogICAgLy8gYXRtIGl0cyB1bnNhZmUgdG8gZG8gYXMgbW92ZVRvIGhhcyBhIGJ1ZyBkdWUgdG8gYSBtaXNzaW5nIHJlYWQgbG9jayBpbiBoYwogICAgdGhpcy5jb3JlID0gY29yZQoKICAgIGlmICh0aGlzLm5hbWUgPT09ICdfc3lzdGVtJykgewogICAgICBjb25zdCBmZiA9IGJhc2UuX3F1ZXVlRmFzdEZvcndhcmQuYmluZChiYXNlKQogICAgICB0aGlzLmNvcmUub24oJ2FwcGVuZCcsIGZmKQogICAgICB0aGlzLmNvcmUucmVhZHkoKS50aGVuKGZmLCBmZikKICAgIH0KICB9CgogIGFzeW5jIG1hdGNoZXNLZXkoa2V5KSB7CiAgICBpZiAoIXRoaXMuY29yZS5vcGVuZWQpIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICByZXR1cm4gYjRhLmVxdWFscyh0aGlzLmNvcmUua2V5LCBrZXkpCiAgfQoKICBhc3luYyBtYXRjaGVzTmFtZXNwYWNlKHRhcmdldCkgewogICAgaWYgKCF0aGlzLmNvcmUub3BlbmVkKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIGlmICh0aGlzLmNvcmUubWFuaWZlc3QgJiYgdGhpcy5jb3JlLm1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBucyA9IHRoaXMuY29yZS5tYW5pZmVzdC5zaWduZXJzWzBdLm5hbWVzcGFjZQogICAgICBpZiAoYjRhLmVxdWFscyhucywgdGFyZ2V0KSkgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGFzeW5jIGNvbW1pdChhdG9tLCBsZW5ndGgsIHNpZ25hdHVyZSkgewogICAgLy8gVE9ETzogaXMgdGhpcyBob3cgaXRzIHN1cHBvc2VkIGJlIGRvbmUgYXRvbWljIHdpc2U/CiAgICBhd2FpdCB0aGlzLmNvcmUuY29tbWl0KHRoaXMuX2dldEF0b21pY0JhdGNoKGF0b20pLCB7IGxlbmd0aCwgc2lnbmF0dXJlIH0pCiAgfQoKICBhc3luYyByZWxlYXNlKCkgewogICAgaWYgKCF0aGlzLmF0b21pY0JhdGNoKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuYXRvbWljQmF0Y2gucmVhZHkoKQogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmF0b21pY0JhdGNoLnN0YXRlLnNlc3Npb25zCiAgICBmb3IgKGxldCBpID0gc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgaWYgKCFzZXNzaW9uc1tpXSkgYnJlYWsgLy8gY2xvc2VkIGJlZm9yZSB1cwogICAgICBhd2FpdCBzZXNzaW9uc1tpXS5jbG9zZSgpCiAgICB9CiAgICBhd2FpdCB0aGlzLmF0b21pY0JhdGNoLmNsb3NlKCkKICAgIHRoaXMuYXRvbWljQmF0Y2ggPSBudWxsCiAgfQoKICBfZ2V0QXRvbWljQmF0Y2goYXRvbSkgewogICAgaWYgKHRoaXMuYXRvbWljQmF0Y2ggPT09IG51bGwpIHsKICAgICAgdGhpcy5hdG9taWNCYXRjaCA9IHRoaXMuYmF0Y2guc2Vzc2lvbih7IGF0b20sIHdyaXRhYmxlOiB0cnVlIH0pCiAgICB9CgogICAgcmV0dXJuIHRoaXMuYXRvbWljQmF0Y2gKICB9CgogIGFzeW5jIGNhdGNodXAoYXRvbSwgbGVuZ3RoKSB7CiAgICBhd2FpdCB0aGlzLnJlbGVhc2UoKQogICAgY29uc3QgYmF0Y2ggPSB0aGlzLl9nZXRBdG9taWNCYXRjaChhdG9tKQogICAgYXdhaXQgYmF0Y2gucmVhZHkoKQogICAgYXdhaXQgYmF0Y2guc3RhdGUuY2F0Y2h1cChsZW5ndGgpCiAgfQoKICBjcmVhdGVTZXNzaW9uKGF0b20sIHZhbHVlRW5jb2RpbmcpIHsKICAgIGlmICh0aGlzLmJhdGNoID09PSBudWxsKSB7CiAgICAgIHRoaXMuYmF0Y2ggPSB0aGlzLmNvcmUuc2Vzc2lvbih7IG5hbWU6ICdiYXRjaCcsIHdyaXRhYmxlOiB0cnVlIH0pCiAgICB9CgogICAgY29uc3QgcyA9IGF0b20KICAgICAgPyB0aGlzLl9nZXRBdG9taWNCYXRjaChhdG9tKS5zZXNzaW9uKHsKICAgICAgICAgIHZhbHVlRW5jb2RpbmcsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgIG9uc2VxOiB0aGlzLnRyYWNlci5vbnNlcS5iaW5kKHRoaXMudHJhY2VyKQogICAgICAgIH0pCiAgICAgIDogdGhpcy5iYXRjaC5zZXNzaW9uKHsgdmFsdWVFbmNvZGluZywgd3JpdGFibGU6IGZhbHNlIH0pCgogICAgcmV0dXJuIHMKICB9Cn0KCmNsYXNzIFRyYWNlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZQogICAgdGhpcy5zZWVuID0gbmV3IFNldCgpCiAgfQoKICBzdGFydCgpIHsKICAgIHRoaXMuZW5hYmxlZCA9IHRydWUKICAgIHRoaXMuc2Vlbi5jbGVhcigpCiAgfQoKICBlbmQoKSB7CiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZQogICAgcmV0dXJuIFsuLi50aGlzLnNlZW4udmFsdWVzKCldCiAgfQoKICBvbnNlcShzZXEsIGNvcmUpIHsKICAgIGlmICghdGhpcy5lbmFibGVkKSByZXR1cm4KICAgIGlmICh0aGlzLnNlZW4uc2l6ZSA+PSBNQVhfVFJBQ0VfUEVSX1ZJRVcpIHJldHVybgogICAgaWYgKHNlcSA+PSBjb3JlLnNpZ25lZExlbmd0aCkgcmV0dXJuCgogICAgdGhpcy5zZWVuLmFkZChzZXEpCiAgfQp9CgpjbGFzcyBBdXRvU3RvcmUgewogIGNvbnN0cnVjdG9yKGJhc2UsIGJ5TmFtZSkgewogICAgdGhpcy5iYXNlID0gYmFzZQogICAgdGhpcy5zdG9yZSA9IGJhc2Uuc3RvcmUKICAgIHRoaXMuYnlOYW1lID0gYnlOYW1lIHx8IG5ldyBNYXAoKQogICAgdGhpcy5vcGVuZWQgPSBbXQogICAgdGhpcy5hdG9tID0gbnVsbAogICAgdGhpcy5sb2NhbCA9IG51bGwKICB9CgogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKHRoaXMubG9jYWwpIGF3YWl0IHRoaXMubG9jYWwuY2xvc2UoKQogICAgZm9yIChjb25zdCB2IG9mIHRoaXMuYnlOYW1lLnZhbHVlcygpKSB7CiAgICAgIGF3YWl0IHYucmVsZWFzZSgpCiAgICB9CiAgICBpZiAodGhpcy5hdG9tKSByZXR1cm4KICAgIGZvciAoY29uc3QgdiBvZiB0aGlzLmJ5TmFtZS52YWx1ZXMoKSkgewogICAgICBpZiAodi5jb3JlKSBhd2FpdCB2LmNvcmUuY2xvc2UoKQogICAgICBpZiAodi5iYXRjaCkgYXdhaXQgdi5iYXRjaC5jbG9zZSgpCiAgICB9CiAgfQoKICBhc3luYyBleHBvcnQoKSB7CiAgICBjb25zdCB2aWV3cyA9IFtdCgogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIHRoaXMuYnlOYW1lKSB7CiAgICAgIGNvbnN0IGNvcmUgPSBhd2FpdCB0aGlzLnN0b3JlLnN0b3JhZ2UuZXhwb3J0KHZhbHVlLmNvcmUuZGlzY292ZXJ5S2V5LCB7IGJhdGNoZXM6IHRydWUgfSkKICAgICAgdmlld3MucHVzaCh7IG5hbWUsIGNvcmUgfSkKICAgIH0KCiAgICByZXR1cm4gdmlld3MKICB9CgogIGF0b21pemUoKSB7CiAgICBjb25zdCBzdG9yZSA9IG5ldyBBdXRvU3RvcmUodGhpcy5iYXNlLCB0aGlzLmJ5TmFtZSkKICAgIHN0b3JlLmF0b20gPSB0aGlzLnN0b3JlLnN0b3JhZ2UuY3JlYXRlQXRvbSgpCiAgICByZXR1cm4gc3RvcmUKICB9CgogIGFzeW5jIHVwZGF0ZUxvY2FsKCkgewogICAgaWYgKCF0aGlzLmxvY2FsKSByZXR1cm4KICAgIGF3YWl0IHRoaXMubG9jYWwuY2xvc2UoKQogICAgdGhpcy5sb2NhbCA9IG51bGwKICB9CgogIGZsdXNoKCkgewogICAgcmV0dXJuIHRoaXMuYXRvbSA/IHRoaXMuYXRvbS5mbHVzaCgpIDogUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIGdldChvcHRzLCBtb3JlT3B0cykgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgbmFtZTogb3B0cyB9CiAgICBpZiAobW9yZU9wdHMpIG9wdHMgPSB7IC4uLm9wdHMsIC4uLm1vcmVPcHRzIH0KCiAgICBjb25zdCB7IG5hbWUsIHZhbHVlRW5jb2RpbmcgPSBudWxsIH0gPSBvcHRzCgogICAgaWYgKCFuYW1lKSB0aHJvdyBuZXcgRXJyb3IoJ25hbWUgaXMgcmVxdWlyZWQnKQogICAgcmV0dXJuIHRoaXMuZ2V0Vmlld0J5TmFtZShuYW1lKS5jcmVhdGVTZXNzaW9uKHRoaXMuYXRvbSwgdmFsdWVFbmNvZGluZykKICB9CgogIGdldFZpZXdCeU5hbWUobmFtZSkgewogICAgbGV0IHZpZXcgPSB0aGlzLmJ5TmFtZS5nZXQobmFtZSkKCiAgICBpZiAoIXZpZXcpIHsKICAgICAgY29uc3QgcHJlbG9hZCA9IHRoaXMuX3ByZWxvYWQobmFtZSkKICAgICAgY29uc3QgY29yZSA9IHRoaXMuYmFzZS5zdG9yZS5nZXQoeyBwcmVsb2FkIH0pCiAgICAgIHZpZXcgPSBuZXcgVmlld0NvcmUobmFtZSwgY29yZSwgdGhpcy5iYXNlKQogICAgICB0aGlzLmJ5TmFtZS5zZXQobmFtZSwgdmlldykKICAgIH0KCiAgICBpZiAodGhpcy5vcGVuZWQuaW5kZXhPZih2aWV3KSA9PT0gLTEpIHsKICAgICAgdGhpcy5vcGVuZWQucHVzaCh2aWV3KQogICAgfQoKICAgIHJldHVybiB2aWV3CiAgfQoKICBnZXRMb2NhbCgpIHsKICAgIGlmICh0aGlzLmxvY2FsICE9PSBudWxsKSByZXR1cm4gdGhpcy5sb2NhbAoKICAgIHRoaXMubG9jYWwgPSB0aGlzLmJhc2UubG9jYWwuc2Vzc2lvbih7CiAgICAgIGF0b206IHRoaXMuYXRvbSwKICAgICAgdmFsdWVFbmNvZGluZzogbWVzc2FnZXMuT3Bsb2dNZXNzYWdlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmJhc2UuZ2V0V3JpdGVyRW5jcnlwdGlvbih0aGlzLmJhc2UubG9jYWwua2V5KSwKICAgICAgYWN0aXZlOiBmYWxzZQogICAgfSkKCiAgICByZXR1cm4gdGhpcy5sb2NhbAogIH0KCiAgZ2V0Vmlld3MoKSB7CiAgICByZXR1cm4gWy4uLnRoaXMuYnlOYW1lLnZhbHVlcygpXQogIH0KCiAgZ2V0Vmlld0NvdW50KCkgewogICAgcmV0dXJuIHRoaXMuYnlOYW1lLnNpemUKICB9CgogIGdldFN5c3RlbVZpZXcoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRWaWV3QnlOYW1lKCdfc3lzdGVtJykKICB9CgogIGdldFN5c3RlbUNvcmUoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTeXN0ZW1WaWV3KCkuY29yZQogIH0KCiAgZ2V0RW5jcnlwdGlvbihuYW1lKSB7CiAgICBpZiAoIXRoaXMuYmFzZS5lbmNyeXB0aW9uS2V5KSByZXR1cm4gbnVsbAogICAgaWYgKG5hbWUgPT09ICdfZW5jcnlwdGlvbicpIHJldHVybiBudWxsCgogICAgcmV0dXJuIHRoaXMuYmFzZS5lbmNyeXB0aW9uLmdldFZpZXdFbmNyeXB0aW9uKG5hbWUpCiAgfQoKICBhc3luYyBnZXRJbmRleGVyTWFuaWZlc3RzKGVudHJpZXMpIHsKICAgIGNvbnN0IG1hbmlmZXN0cyA9IFtdCiAgICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgZW50cmllcykgewogICAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoeyBrZXksIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICAgIGlmICghY29yZS5tYW5pZmVzdCkgY29udGludWUgLy8gZGFuZ2VyIGJ1dCBvbmx5IGZvciBib290c3RyYXBwaW5nLi4uCiAgICAgIG1hbmlmZXN0cy5wdXNoKGNvcmUubWFuaWZlc3QpCiAgICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgfQogICAgcmV0dXJuIG1hbmlmZXN0cwogIH0KCiAgZ2V0Vmlld0NvcmUoaW5kZXhlck1hbmlmZXN0cywgbmFtZSwgcHJvbG9ndWUsIG1hbmlmZXN0VmVyc2lvbiwgZW50cm9weSwgbGlua2VkLCBtYW5pZmVzdERhdGEpIHsKICAgIGNvbnN0IG1hbmlmZXN0ID0gdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgIG5hbWUsCiAgICAgIHByb2xvZ3VlLAogICAgICBtYW5pZmVzdFZlcnNpb24sCiAgICAgIGVudHJvcHksCiAgICAgIGxpbmtlZCwKICAgICAgbWFuaWZlc3REYXRhCiAgICApCgogICAgcmV0dXJuIHRoaXMuYmFzZS5zdG9yZS5nZXQoewogICAgICBtYW5pZmVzdCwKICAgICAgZXhjbHVzaXZlOiBmYWxzZSwKICAgICAgZW5jcnlwdGlvbjogdGhpcy5nZXRFbmNyeXB0aW9uKG5hbWUpCiAgICB9KQogIH0KCiAgbGlzdFZpZXdzKCkgewogICAgY29uc3Qgdmlld3MgPSBbXQogICAgZm9yIChjb25zdCBbbmFtZSwgcmVmXSBvZiB0aGlzLmJ5TmFtZSkgewogICAgICBjb25zdCBjb3JlID0gcmVmLmJhdGNoIHx8IHJlZi5jb3JlCiAgICAgIHZpZXdzLnB1c2goeyBuYW1lLCBrZXk6IGNvcmUua2V5LCBsZW5ndGg6IGNvcmUubGVuZ3RoLCBzaWduZWRMZW5ndGg6IGNvcmUuc2lnbmVkTGVuZ3RoIH0pCiAgICB9CiAgICByZXR1cm4gdmlld3MKICB9CgogIGNyZWF0ZUFuY2hvckNvcmUocHJvbG9ndWUsIG1hbmlmZXN0RGF0YSkgewogICAgY29uc3QgbWFuaWZlc3QgPSB7CiAgICAgIHZlcnNpb246IDIsCiAgICAgIGhhc2g6ICdibGFrZTJiJywKICAgICAgcHJvbG9ndWUsCiAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICBxdW9ydW06IDAsCiAgICAgIHNpZ25lcnM6IFtdLAogICAgICB1c2VyRGF0YTogbWFuaWZlc3REYXRhLAogICAgICBsaW5rZWQ6IG51bGwKICAgIH0KCiAgICBjb25zdCBjb3JlID0gdGhpcy5zdG9yZS5nZXQoewogICAgICBtYW5pZmVzdCwKICAgICAgYWN0aXZlOiBmYWxzZQogICAgfSkKCiAgICByZXR1cm4gY29yZQogIH0KCiAgYXN5bmMgY3JlYXRlVmlldygKICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICBuYW1lLAogICAgcHJvbG9ndWUsCiAgICBtYW5pZmVzdFZlcnNpb24sCiAgICBlbnRyb3B5LAogICAgbGlua2VkLAogICAgbWFuaWZlc3REYXRhCiAgKSB7CiAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICBpbmRleGVyTWFuaWZlc3RzLAogICAgICBuYW1lLAogICAgICBwcm9sb2d1ZSwKICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICBlbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7CiAgICAgIGtleTogSHlwZXJjb3JlLmtleShtYW5pZmVzdCksCiAgICAgIG1hbmlmZXN0LAogICAgICBhY3RpdmU6IGZhbHNlCiAgICB9KQoKICAgIGF3YWl0IGNvcmUucmVhZHkoKQogICAgY29uc3Qga2V5ID0gY29yZS5rZXkKCiAgICBhd2FpdCBjb3JlLmNsb3NlKCkKICAgIHJldHVybiBrZXkKICB9CgogIGFzeW5jIF9wcmVsb2FkKG5hbWUpIHsKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpCgogICAgaWYgKCF0aGlzLmJhc2Uub3BlbmluZykgdGhyb3cgbmV3IEVycm9yKCdBdXRvYmFzZSBmYWlsZWQgdG8gb3BlbicpCiAgICBhd2FpdCB0aGlzLmJhc2UuX3ByZW9wZW4KCiAgICBjb25zdCBib290ID0gKGF3YWl0IHRoaXMuYmFzZS5fZ2V0U3lzdGVtSW5mbygpKSB8fCB7CiAgICAgIGtleTogdGhpcy5nZXRCb290c3RyYXBTeXN0ZW1LZXkoKSwKICAgICAgaW5kZXhlcnM6IFtdLAogICAgICB2aWV3czogW10sCiAgICAgIGVudHJvcHk6IG51bGwKICAgIH0KICAgIGNvbnN0IGluZGV4ZXJNYW5pZmVzdHMgPSBhd2FpdCB0aGlzLmdldEluZGV4ZXJNYW5pZmVzdHMoYm9vdC5pbmRleGVycykKCiAgICAvLyBubyBzeXN0ZW0sIGV2ZXJ5dGhpbmcgaXMgZnJlc2gKICAgIGlmIChib290LmluZGV4ZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdGhpcy5fZnJlc2hDb3JlUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBib290LmVudHJvcHkpCiAgICB9CgogICAgLy8gYXNraW5nIGZvciB0aGUgc3lzdGVtLCBqdXN0IHJldHVybiBpdCwgZWFzeQogICAgaWYgKG5hbWUgPT09ICdfc3lzdGVtJykgewogICAgICByZXR1cm4gewogICAgICAgIGtleTogYm9vdC5rZXksCiAgICAgICAgZXhjbHVzaXZlOiBmYWxzZSwKICAgICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24obmFtZSkKICAgICAgfQogICAgfQoKICAgIGlmIChuYW1lID09PSAnX2VuY3J5cHRpb24nKSB7CiAgICAgIGNvbnN0IGNvcmUgPSB0aGlzLmdldFN5c3RlbUNvcmUoKQogICAgICBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICAgIGlmICghY29yZS5tYW5pZmVzdC5saW5rZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZnJlc2hDb3JlUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBuYW1lLCBib290LmVudHJvcHkpCiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAga2V5OiBjb3JlLm1hbmlmZXN0LmxpbmtlZFswXSwKICAgICAgICBleGNsdXNpdmU6IGZhbHNlLAogICAgICAgIGVuY3J5cHRpb246IG51bGwKICAgICAgfQogICAgfQoKICAgIC8vIGluZmVyIHdoaWNoIHZpZXcKICAgIGNvbnN0IHYgPSBhd2FpdCB0aGlzLmZpbmRWaWV3QnlOYW1lKGluZGV4ZXJNYW5pZmVzdHMsIGJvb3Qudmlld3MsIG5hbWUsIGJvb3QuZW50cm9weSkKCiAgICAvLyBuZXcgdmlldywgZnJlc2gKICAgIGlmICh2ID09PSBudWxsKSB7CiAgICAgIHJldHVybiB0aGlzLl9mcmVzaENvcmVQcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIGJvb3QuZW50cm9weSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICBrZXk6IHYua2V5LAogICAgICBleGNsdXNpdmU6IGZhbHNlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24obmFtZSkKICAgIH0KICB9CgogIF9mcmVzaENvcmVQcmVsb2FkKGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIGVudHJvcHkpIHsKICAgIGlmIChuYW1lID09PSAnX3N5c3RlbScpIHJldHVybiB0aGlzLl9mcmVzaFN5c3RlbVByZWxvYWQoaW5kZXhlck1hbmlmZXN0cywgZW50cm9weSkKCiAgICByZXR1cm4gewogICAgICBtYW5pZmVzdDogdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICBuYW1lLAogICAgICAgIG51bGwsCiAgICAgICAgREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OLAogICAgICAgIGVudHJvcHksCiAgICAgICAgW10sCiAgICAgICAgbnVsbAogICAgICApLAogICAgICBleGNsdXNpdmU6IHRydWUsCiAgICAgIGVuY3J5cHRpb246IHRoaXMuZ2V0RW5jcnlwdGlvbihuYW1lKQogICAgfQogIH0KCiAgX2ZyZXNoU3lzdGVtUHJlbG9hZChpbmRleGVyTWFuaWZlc3RzLCBlbnRyb3B5KSB7CiAgICByZXR1cm4gewogICAgICBtYW5pZmVzdDogdGhpcy5fY3JlYXRlU3lzdGVtTWFuaWZlc3QoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICBudWxsLAogICAgICAgIERFRkFVTFRfTUFOSUZFU1RfVkVSU0lPTiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIG51bGwKICAgICAgKSwKICAgICAgZXhjbHVzaXZlOiB0cnVlLAogICAgICBlbmNyeXB0aW9uOiB0aGlzLmdldEVuY3J5cHRpb24oJ19zeXN0ZW0nKQogICAgfQogIH0KCiAgX2Rlcml2ZVN0YXRpY0hhc2gobmFtZSkgewogICAgLy8ga2V5IGRvZXNudCBtYXR0ZXIuLi4KICAgIHJldHVybiBjcnlwdG8uaGFzaChbdGhpcy5iYXNlLmtleSwgYjRhLmZyb20obmFtZSldKQogIH0KCiAgX2Rlcml2ZU5hbWVzcGFjZShuYW1lLCBlbnRyb3B5KSB7CiAgICBjb25zdCBlbmNyeXB0aW9uSWQgPSBjcnlwdG8uaGFzaCh0aGlzLmJhc2UuZW5jcnlwdGlvbktleSB8fCBFTVBUWSkKICAgIGNvbnN0IHZlcnNpb24gPSBjLmVuY29kZShjLnVpbnQsIElOREVYX1ZFUlNJT04pCiAgICBjb25zdCBib290c3RyYXAgPSB0aGlzLmJhc2Uua2V5CgogICAgcmV0dXJuIGNyeXB0by5oYXNoKFsKICAgICAgTlNfU0lHTkVSX05BTUVTUEFDRSwKICAgICAgdmVyc2lvbiwKICAgICAgYm9vdHN0cmFwLAogICAgICBlbmNyeXB0aW9uSWQsCiAgICAgIGVudHJvcHksCiAgICAgIGI0YS5mcm9tKG5hbWUpCiAgICBdKQogIH0KCiAgYXN5bmMgX2dldENvcmVNYW5pZmVzdChrZXkpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLnN0b3JlLmdldCh7IGtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICBjb25zdCBtYW5pZmVzdCA9IGNvcmUubWFuaWZlc3QKICAgIGF3YWl0IGNvcmUuY2xvc2UoKQogICAgcmV0dXJuIG1hbmlmZXN0CiAgfQoKICBnZXRCb290c3RyYXBTeXN0ZW1LZXkoKSB7CiAgICByZXR1cm4gSHlwZXJjb3JlLmtleSh0aGlzLl9jcmVhdGVTeXN0ZW1NYW5pZmVzdChbXSwgbnVsbCwgREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OLCBudWxsKSkKICB9CgogIGFzeW5jIGZpbmRWaWV3QnlLZXkoa2V5LCBpbmRleGVycywgbWFuaWZlc3RWZXJzaW9uLCBlbnRyb3B5KSB7CiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgaWYgKGF3YWl0IHYubWF0Y2hlc0tleShrZXkpKSByZXR1cm4gdgogICAgfQoKICAgIGNvbnN0IG1hbmlmZXN0ID0gYXdhaXQgdGhpcy5fZ2V0Q29yZU1hbmlmZXN0KGtleSkKICAgIGNvbnN0IHRhcmdldCA9IG1hbmlmZXN0ICYmIG1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoID8gbWFuaWZlc3Quc2lnbmVyc1swXS5uYW1lc3BhY2UgOiBudWxsCgogICAgaWYgKHRhcmdldCkgewogICAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgICBpZiAoYXdhaXQgdi5tYXRjaGVzTmFtZXNwYWNlKHRhcmdldCkpIHJldHVybiB2CiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBpbmRleGVyTWFuaWZlc3RzID0gYXdhaXQgdGhpcy5nZXRJbmRleGVyTWFuaWZlc3RzKGluZGV4ZXJzKQoKICAgIGlmIChlbnRyb3B5ID09PSBudWxsKSB7CiAgICAgIGVudHJvcHkgPSBpbmRleGVyTWFuaWZlc3RzWzBdLnNpZ25lcnNbMF0ubmFtZXNwYWNlCiAgICB9CgogICAgaWYgKHRhcmdldCkgewogICAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLl9kZXJpdmVOYW1lc3BhY2Uodi5uYW1lLCBlbnRyb3B5KQogICAgICAgIGlmIChiNGEuZXF1YWxzKG5hbWVzcGFjZSwgdGFyZ2V0KSkgcmV0dXJuIHYKICAgICAgfQogICAgfQoKICAgIC8vIHByb2IgdGhlIGVtcHR5IHByb2xvZ3VlLCB3ZSBkb250IGhhdmUgbWFuaWZlc3QgZm9yIHRob3NlIGluIEZGIGlmIGxlbj0wCiAgICBmb3IgKGNvbnN0IHYgb2YgdGhpcy5ieU5hbWUudmFsdWVzKCkpIHsKICAgICAgY29uc3QgbWFuaWZlc3REYXRhID0gdi5jb3JlID8gdi5jb3JlLm1hbmlmZXN0LnVzZXJEYXRhIDogbnVsbAogICAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuX2NyZWF0ZU1hbmlmZXN0KAogICAgICAgIGluZGV4ZXJNYW5pZmVzdHMsCiAgICAgICAgdi5uYW1lLAogICAgICAgIG51bGwsCiAgICAgICAgbWFuaWZlc3RWZXJzaW9uLAogICAgICAgIGVudHJvcHksCiAgICAgICAgW10sCiAgICAgICAgbWFuaWZlc3REYXRhCiAgICAgICkKICAgICAgY29uc3QgbWFuaWZlc3RLZXkgPSBIeXBlcmNvcmUua2V5KG1hbmlmZXN0KQoKICAgICAgaWYgKCFiNGEuZXF1YWxzKG1hbmlmZXN0S2V5LCBrZXkpKSBjb250aW51ZQoKICAgICAgLy8gd2UgZGlkbnQgaGF2ZSB0aGUgY29yZSEgdGhpcyBpcyBiZWNhdXNlIGl0IGlzIGVtcHR5LCBlbnN1cmUgaXRzIG9uIGRpc2sKICAgICAgY29uc3QgY29yZSA9IHRoaXMuc3RvcmUuZ2V0KHsga2V5OiBtYW5pZmVzdEtleSwgbWFuaWZlc3QsIGFjdGl2ZTogZmFsc2UgfSkKICAgICAgYXdhaXQgY29yZS5yZWFkeSgpCiAgICAgIGF3YWl0IGNvcmUuY2xvc2UoKQoKICAgICAgcmV0dXJuIHYKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYXN5bmMgZmluZFZpZXdCeU5hbWUoaW5kZXhlck1hbmlmZXN0cywgdmlld3MsIG5hbWUsIGVudHJvcHkpIHsKICAgIGlmIChpbmRleGVyTWFuaWZlc3RzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGwKCiAgICBpZiAoZW50cm9weSA9PT0gbnVsbCkgZW50cm9weSA9IGluZGV4ZXJNYW5pZmVzdHNbMF0uc2lnbmVyc1swXS5uYW1lc3BhY2UKICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuX2Rlcml2ZU5hbWVzcGFjZShuYW1lLCBlbnRyb3B5KQoKICAgIGZvciAoY29uc3QgdiBvZiB2aWV3cykgewogICAgICBjb25zdCBtYW5pZmVzdCA9IGF3YWl0IHRoaXMuX2dldENvcmVNYW5pZmVzdCh2LmtleSkKICAgICAgaWYgKG1hbmlmZXN0LnNpZ25lcnMubGVuZ3RoID09PSAwKSBjb250aW51ZQoKICAgICAgY29uc3Qgc2lnbmVyID0gbWFuaWZlc3Quc2lnbmVyc1swXQoKICAgICAgaWYgKGI0YS5lcXVhbHMoc2lnbmVyLm5hbWVzcGFjZSwgbmFtZXNwYWNlKSkgcmV0dXJuIHYKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgX2NyZWF0ZU1hbmlmZXN0KGluZGV4ZXJNYW5pZmVzdHMsIG5hbWUsIHByb2xvZ3VlLCB2ZXJzaW9uLCBlbnRyb3B5LCBsaW5rZWQsIG1hbmlmZXN0RGF0YSkgewogICAgaWYgKCFpbmRleGVyTWFuaWZlc3RzLmxlbmd0aCkgewogICAgICBwcm9sb2d1ZSA9IHsKICAgICAgICBoYXNoOiB0aGlzLl9kZXJpdmVTdGF0aWNIYXNoKG5hbWUpLAogICAgICAgIGxlbmd0aDogMAogICAgICB9CiAgICB9IGVsc2UgaWYgKHByb2xvZ3VlICYmIHByb2xvZ3VlLmxlbmd0aCA9PT0gMCkgewogICAgICAvLyBqdXN0IGluIGNhc2UKICAgICAgcHJvbG9ndWUgPSBudWxsCiAgICB9CgogICAgY29uc3Qgc2lnbmVycyA9IFtdCgogICAgaWYgKGluZGV4ZXJNYW5pZmVzdHMubGVuZ3RoICYmIGVudHJvcHkgPT09IG51bGwpIHsKICAgICAgZW50cm9weSA9IGluZGV4ZXJNYW5pZmVzdHNbMF0uc2lnbmVyc1swXS5uYW1lc3BhY2UKICAgIH0KCiAgICBmb3IgKGNvbnN0IG1hbmlmZXN0IG9mIGluZGV4ZXJNYW5pZmVzdHMpIHsKICAgICAgY29uc3Qgc2lnbmVyID0gbWFuaWZlc3Quc2lnbmVyc1swXQoKICAgICAgc2lnbmVycy5wdXNoKHsKICAgICAgICBuYW1lc3BhY2U6IHRoaXMuX2Rlcml2ZU5hbWVzcGFjZShuYW1lLCBlbnRyb3B5KSwKICAgICAgICBzaWduYXR1cmU6ICdlZDI1NTE5JywKICAgICAgICBwdWJsaWNLZXk6IHNpZ25lci5wdWJsaWNLZXkKICAgICAgfSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBoYXNoOiAnYmxha2UyYicsCiAgICAgIHByb2xvZ3VlLAogICAgICBhbGxvd1BhdGNoOiB0cnVlLAogICAgICBxdW9ydW06IE1hdGgubWluKHNpZ25lcnMubGVuZ3RoLCAoc2lnbmVycy5sZW5ndGggPj4gMSkgKyAxKSwKICAgICAgc2lnbmVycywKICAgICAgdXNlckRhdGE6IG1hbmlmZXN0RGF0YSwKICAgICAgbGlua2VkOiB2ZXJzaW9uID4gMSA/IGxpbmtlZCA6IG51bGwKICAgIH0KICB9CgogIF9jcmVhdGVTeXN0ZW1NYW5pZmVzdChpbmRleGVyTWFuaWZlc3RzLCBwcm9sb2d1ZSwgdmVyc2lvbiwgZW50cm9weSwgbWFuaWZlc3REYXRhKSB7CiAgICBpZiAocHJvbG9ndWUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignQ2FuIG9ubHkgZGVyaXZlIGZyZXNoIHN5c3RlbSBjb3JlJykKCiAgICBjb25zdCBsaW5rZWQgPSBbXQoKICAgIGlmICh2ZXJzaW9uID4gREVGQVVMVF9NQU5JRkVTVF9WRVJTSU9OKSB7CiAgICAgIGNvbnN0IGVuY01hbmlmZXN0ID0gdGhpcy5fY3JlYXRlTWFuaWZlc3QoCiAgICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgICAnX2VuY3J5cHRpb24nLAogICAgICAgIG51bGwsCiAgICAgICAgdmVyc2lvbiwKICAgICAgICBlbnRyb3B5LAogICAgICAgIFtdLAogICAgICAgIG1hbmlmZXN0RGF0YQogICAgICApCiAgICAgIGxpbmtlZC5wdXNoKEh5cGVyY29yZS5rZXkoZW5jTWFuaWZlc3QpKQogICAgfQoKICAgIHJldHVybiB0aGlzLl9jcmVhdGVNYW5pZmVzdCgKICAgICAgaW5kZXhlck1hbmlmZXN0cywKICAgICAgJ19zeXN0ZW0nLAogICAgICBudWxsLAogICAgICB2ZXJzaW9uLAogICAgICBlbnRyb3B5LAogICAgICBsaW5rZWQsCiAgICAgIG1hbmlmZXN0RGF0YQogICAgKQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBBdXRvU3RvcmUKY29uc3QgSHlwZXJiZWUgPSByZXF1aXJlKCdoeXBlcmJlZScpCmNvbnN0IFN1YkVuY29kZXIgPSByZXF1aXJlKCdzdWItZW5jb2RlcicpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCgpjb25zdCB7IEluZm8sIE1lbWJlciB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMuanMnKQoKY29uc3Qgc3VicyA9IG5ldyBTdWJFbmNvZGVyKCkKCmNvbnN0IERJR0VTVCA9IHN1YnMuc3ViKGI0YS5mcm9tKFswXSkpCmNvbnN0IE1FTUJFUlMgPSBzdWJzLnN1YihiNGEuZnJvbShbMV0pKQoKY29uc3QgSU5GT19LRVkgPSBESUdFU1QuZW5jb2RlKCdpbmZvJykKCmNvbnN0IFtHRU5FU0lTX0VOVFJPUFksIE5TX0VOVFJPUFldID0gY3J5cHRvLm5hbWVzcGFjZSgnYXV0b2Jhc2UvZW50cm9weScsIDIpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFN5c3RlbVZpZXcgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCB7IGNoZWNrb3V0ID0gMCwgZW1wdHkgPSBmYWxzZSB9ID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmNvcmUgPSBjb3JlCgogICAgLy8gc2Vzc2lvbnMgaXMgYSB3b3JrYXJvdW5kIGZvciBiYXRjaGVzIG5vdCBoYXZpbmcgc2Vzc2lvbnMgYXRtLi4uCiAgICB0aGlzLmRiID0gbmV3IEh5cGVyYmVlKGNvcmUsIHsKICAgICAga2V5RW5jb2Rpbmc6ICdiaW5hcnknLAogICAgICBleHRlbnNpb246IGZhbHNlLAogICAgICBjaGVja291dCwKICAgICAgc2Vzc2lvbnM6IHR5cGVvZiBjb3JlLnNlc3Npb24gPT09ICdmdW5jdGlvbicKICAgIH0pCgogICAgdGhpcy52ZXJzaW9uID0gREVGQVVMVF9BVVRPQkFTRV9WRVJTSU9OCiAgICB0aGlzLm1lbWJlcnMgPSAwCiAgICB0aGlzLnBlbmRpbmdJbmRleGVycyA9IFtdCiAgICB0aGlzLmluZGV4ZXJzID0gW10KICAgIHRoaXMuaGVhZHMgPSBbXQogICAgdGhpcy52aWV3cyA9IFtdCiAgICB0aGlzLmVuY3J5cHRpb25MZW5ndGggPSAwCiAgICB0aGlzLmVudHJvcHkgPSBudWxsCgogICAgdGhpcy5pbmRleGVyVXBkYXRlID0gZmFsc2UKCiAgICB0aGlzLl9lbXB0eSA9IGVtcHR5CiAgICB0aGlzLl9mb3JrID0gMAogICAgdGhpcy5fbGVuZ3RoID0gMAogICAgdGhpcy5fY2hhbmdlcyA9IFtdCiAgICB0aGlzLl9pbmRleGVyTWFwID0gbmV3IE1hcCgpCiAgICB0aGlzLl9jbG9ja1VwZGF0ZXMgPSBuZXcgTWFwKCkKICB9CgogIHN0YXRpYyBHRU5FU0lTX0VOVFJPUFkgPSBHRU5FU0lTX0VOVFJPUFkKCiAgc3RhdGljIGFzeW5jIGdldEluZGV4ZWRJbmZvKGNvcmUsIGxlbmd0aCkgewogICAgY29uc3Qgc3lzID0gbmV3IHRoaXMoY29yZS5zZXNzaW9uKCkpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHN5cy5nZXRJbmRleGVkSW5mbyhsZW5ndGgpCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBzeXMuY2xvc2UoKQogICAgfQogIH0KCiAgc3RhdGljIGFzeW5jICpmbHVzaGVzKGNvcmUsIHsgcmV2ZXJzZSwgbHQgPSBjb3JlLmxlbmd0aCwgZ3RlID0gMCwgd2FpdCA9IHRydWUgfSA9IHt9KSB7CiAgICBpZiAobHQgPD0gMCkgcmV0dXJuCgogICAgLy8gZW5zdXJlIGJsb2NrCiAgICBhd2FpdCBjb3JlLmdldChsdCAtIDEpCiAgICBjb25zdCBzeXMgPSBuZXcgU3lzdGVtVmlldyhjb3JlKQoKICAgIHRyeSB7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzeXMuZGIuY3JlYXRlSGlzdG9yeVN0cmVhbSh7IGx0LCBndGUsIHdhaXQsIHJldmVyc2U6IHRydWUgfSkpIHsKICAgICAgICBpZiAoIWI0YS5lcXVhbHMoZGF0YS5rZXksIElORk9fS0VZKSkgY29udGludWUKICAgICAgICBjb25zdCBpbmZvID0gYy5kZWNvZGUoSW5mbywgZGF0YS52YWx1ZSkKICAgICAgICB5aWVsZCB7IGxlbmd0aDogZGF0YS5zZXEgKyAxLCBpbmZvIH0KICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgc3lzLmNsb3NlKCkKICAgIH0KICB9CgogIGdldCBib290c3RyYXBwaW5nKCkgewogICAgcmV0dXJuIHRoaXMubWVtYmVycyA9PT0gMAogIH0KCiAgYXN5bmMgY2hlY2tvdXQobGVuZ3RoKSB7CiAgICBjb25zdCBjaGVja291dCA9IG5ldyBTeXN0ZW1WaWV3KHRoaXMuY29yZS5zZXNzaW9uKCksIHsKICAgICAgY2hlY2tvdXQ6IGxlbmd0aCwKICAgICAgZW1wdHk6IGxlbmd0aCA9PT0gMAogICAgfSkKCiAgICBhd2FpdCBjaGVja291dC5yZWFkeSgpCgogICAgcmV0dXJuIGNoZWNrb3V0CiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIC8vIHRoaXMgc2hvdWxkIE5FVkVSIGZhaWwsIGlmIHNvIHdlIGhhdmUgYSBidWcgZWxzZXdoZXJlIChzaG91bGQgYWx3YXlzIGJlIGNvbnNpc3RlbnQpCiAgICBjb25zdCBpbmZvID0gdGhpcy5fZW1wdHkKICAgICAgPyBudWxsCiAgICAgIDogYXdhaXQgdGhpcy5kYi5nZXQoJ2luZm8nLCB7CiAgICAgICAgICB2YWx1ZUVuY29kaW5nOiBJbmZvLAogICAgICAgICAga2V5RW5jb2Rpbmc6IERJR0VTVCwKICAgICAgICAgIHVwZGF0ZTogZmFsc2UsCiAgICAgICAgICB3YWl0OiBmYWxzZQogICAgICAgIH0pCiAgICBhd2FpdCB0aGlzLl9yZXNldChpbmZvKQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgYXdhaXQgdGhpcy5kYi5jbG9zZSgpCiAgfQoKICBhc3luYyBnZXRJbmRleGVkSW5mbyhsZW5ndGggPSB0aGlzLmNvcmUuc2lnbmVkTGVuZ3RoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBpZiAobGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLAogICAgICAgIG1lbWJlcnM6IHRoaXMubWVtYmVycywKICAgICAgICBwZW5kaW5nSW5kZXhlcnM6IHRoaXMucGVuZGluZ0luZGV4ZXJzLAogICAgICAgIGluZGV4ZXJzOiB0aGlzLmluZGV4ZXJzLAogICAgICAgIGhlYWRzOiB0aGlzLmhlYWRzLAogICAgICAgIHZpZXdzOiB0aGlzLnZpZXdzLAogICAgICAgIGVuY3J5cHRpb25MZW5ndGg6IHRoaXMuZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgICBlbnRyb3B5OiB0aGlzLmVudHJvcHkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IG5vZGUgPSBsZW5ndGggPT09IDAgPyBudWxsIDogYXdhaXQgdGhpcy5kYi5nZXRCeVNlcShsZW5ndGggLSAxKQogICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiBERUZBVUxUX0FVVE9CQVNFX1ZFUlNJT04sCiAgICAgICAgbWVtYmVyczogMCwKICAgICAgICBwZW5kaW5nSW5kZXhlcnM6IFtdLAogICAgICAgIGluZGV4ZXJzOiBbXSwKICAgICAgICBoZWFkczogW10sCiAgICAgICAgdmlld3M6IFtdLAogICAgICAgIGVuY3J5cHRpb25MZW5ndGg6IDAsCiAgICAgICAgZW50cm9weTogbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGMuZGVjb2RlKEluZm8sIG5vZGUudmFsdWUpCiAgfQoKICBzdGF0aWMgc2FtZUluZGV4ZXJzKGEsIGIpIHsKICAgIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoIWI0YS5lcXVhbHMoYVtpXS5rZXksIGJbaV0uY29yZS5rZXkpKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgc2FtZUluZGV4ZXJzKGluZGV4ZXJzKSB7CiAgICByZXR1cm4gU3lzdGVtVmlldy5zYW1lSW5kZXhlcnModGhpcy5pbmRleGVycywgaW5kZXhlcnMpCiAgfQoKICBhc3luYyBoaXN0b3J5KHNpbmNlKSB7CiAgICBjb25zdCBjaGVja291dCA9IHRoaXMuZGIuY2hlY2tvdXQoc2luY2UpCiAgICBjb25zdCBzZWVuID0gbmV3IE1hcCgpCgogICAgY29uc3Qgbm9kZXMgPSBbXQogICAgY29uc3QgdXBkYXRlcyA9IFtdCgogICAgY29uc3QgY2hlY2tvdXROb2RlID0gc2luY2UgPT09IDAgPyBudWxsIDogYXdhaXQgdGhpcy5kYi5nZXRCeVNlcShzaW5jZSAtIDEpCgogICAgbGV0IHByZXZJbmZvID0gY2hlY2tvdXROb2RlID09PSBudWxsID8gbnVsbCA6IGMuZGVjb2RlKEluZm8sIGNoZWNrb3V0Tm9kZS52YWx1ZSkKICAgIGxldCB1cGRhdGVCYXRjaCA9IDAKCiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5kYi5jcmVhdGVIaXN0b3J5U3RyZWFtKHsgZ3RlOiBzaW5jZSB9KSkgewogICAgICBpZiAoYjRhLmVxdWFscyhkYXRhLmtleSwgSU5GT19LRVkpKSB7CiAgICAgICAgY29uc3QgaW5mbyA9IGMuZGVjb2RlKEluZm8sIGRhdGEudmFsdWUpCgogICAgICAgIHVwZGF0ZXMucHVzaCh7CiAgICAgICAgICBiYXRjaDogdXBkYXRlQmF0Y2gsCiAgICAgICAgICBpbmRleGVyczogcHJldkluZm8gPT09IG51bGwgfHwgIXNhbWVJbmRleGVycyhpbmZvLCBwcmV2SW5mbyksCiAgICAgICAgICBzeXN0ZW1MZW5ndGg6IGRhdGEuc2VxICsgMQogICAgICAgIH0pCgogICAgICAgIHByZXZJbmZvID0gaW5mbwogICAgICAgIHVwZGF0ZUJhdGNoID0gMAogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGNvbnN0IGtleSA9IGRhdGEua2V5LnN1YmFycmF5KDIpCiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgICBjb25zdCBsZW4gPSBjLmRlY29kZShNZW1iZXIsIGRhdGEudmFsdWUpLmxlbmd0aAoKICAgICAgaWYgKCFzZWVuLmhhcyhoZXgpKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IGNoZWNrb3V0LmdldChkYXRhLmtleSkKICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgc2Vlbi5zZXQoaGV4LCAwKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB7IGxlbmd0aCB9ID0gYy5kZWNvZGUoTWVtYmVyLCBub2RlLnZhbHVlKQogICAgICAgICAgc2Vlbi5zZXQoaGV4LCBsZW5ndGgpCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBwcmV2ID0gc2Vlbi5nZXQoaGV4KQogICAgICBjb25zdCBiYXRjaCA9IGxlbiAtIHByZXYKICAgICAgc2Vlbi5zZXQoaGV4LCBsZW4pCgogICAgICBpZiAoYmF0Y2ggPT09IDApIGNvbnRpbnVlCgogICAgICB1cGRhdGVCYXRjaCArPSBiYXRjaAoKICAgICAgaWYgKG5vZGVzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCB0b3AgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXQogICAgICAgIGlmIChiNGEuZXF1YWxzKHRvcC5rZXksIGtleSkpIHsKICAgICAgICAgIHRvcC5sZW5ndGggPSBsZW4KICAgICAgICAgIHRvcC5iYXRjaCArPSBiYXRjaAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG5vZGVzLnB1c2goewogICAgICAgIGtleSwKICAgICAgICBsZW5ndGg6IGxlbiwKICAgICAgICBiYXRjaAogICAgICB9KQogICAgfQoKICAgIGF3YWl0IGNoZWNrb3V0LmNsb3NlKCkKCiAgICByZXR1cm4geyB1cGRhdGVzLCBub2RlcyB9CiAgfQoKICBhc3luYyB1cGRhdGUoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICBpZiAodGhpcy5fZm9yayA9PT0gdGhpcy5jb3JlLmZvcmsgJiYgdGhpcy5fbGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoKSByZXR1cm4gZmFsc2UKCiAgICBhd2FpdCB0aGlzLl9yZXNldCgKICAgICAgdGhpcy5fZW1wdHkgPyBudWxsIDogYXdhaXQgdGhpcy5kYi5nZXQoJ2luZm8nLCB7IHZhbHVlRW5jb2Rpbmc6IEluZm8sIGtleUVuY29kaW5nOiBESUdFU1QgfSkKICAgICkKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBfcmVzZXQoaW5mbykgewogICAgdGhpcy52ZXJzaW9uID0gaW5mbyA9PT0gbnVsbCA/IERFRkFVTFRfQVVUT0JBU0VfVkVSU0lPTiA6IGluZm8udmFsdWUudmVyc2lvbgogICAgdGhpcy5tZW1iZXJzID0gaW5mbyA9PT0gbnVsbCA/IDAgOiBpbmZvLnZhbHVlLm1lbWJlcnMKICAgIHRoaXMucGVuZGluZ0luZGV4ZXJzID0gaW5mbyA9PT0gbnVsbCA/IFtdIDogaW5mby52YWx1ZS5wZW5kaW5nSW5kZXhlcnMKICAgIHRoaXMuaW5kZXhlcnMgPSBpbmZvID09PSBudWxsID8gW10gOiBpbmZvLnZhbHVlLmluZGV4ZXJzCiAgICB0aGlzLmhlYWRzID0gaW5mbyA9PT0gbnVsbCA/IFtdIDogaW5mby52YWx1ZS5oZWFkcwogICAgdGhpcy52aWV3cyA9IGluZm8gPT09IG51bGwgPyBbXSA6IGluZm8udmFsdWUudmlld3MKICAgIHRoaXMuZW5jcnlwdGlvbkxlbmd0aCA9IGluZm8gPT09IG51bGwgPyAwIDogaW5mby52YWx1ZS5lbmNyeXB0aW9uTGVuZ3RoCiAgICB0aGlzLmVudHJvcHkgPSBpbmZvID09PSBudWxsID8gbnVsbCA6IGluZm8udmFsdWUuZW50cm9weQoKICAgIHRoaXMuaW5kZXhlclVwZGF0ZSA9IGZhbHNlCiAgICB0aGlzLl9pbmRleGVyTWFwLmNsZWFyKCkKICAgIHRoaXMuX2Nsb2NrVXBkYXRlcy5jbGVhcigpCiAgICB0aGlzLl9sZW5ndGggPSB0aGlzLmNvcmUubGVuZ3RoCiAgICB0aGlzLl9mb3JrID0gdGhpcy5jb3JlLmZvcmsKICAgIHRoaXMuX2NoYW5nZXMgPSBbXQoKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgdGhpcy5faW5kZXhlck1hcC5zZXQoYjRhLnRvU3RyaW5nKGlkeC5rZXksICdoZXgnKSwgaWR4KQogICAgfQogIH0KCiAgLy8gaGVscGVyIHVzZWQgYnkgYXBwbHktc3RhdGUKICBmbHVzaExlbmd0aCgpIHsKICAgIGNvbnN0IGhlYWRlciA9IHRoaXMuY29yZS5sZW5ndGggPyAwIDogMSAvLyBhY2NvdW50IGZvciBoZWFkZXIKCiAgICBsZXQgdXBkYXRlcyA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoICsgdGhpcy5fY2xvY2tVcGRhdGVzLnNpemUKICAgIGZvciAoY29uc3QgeyBrZXkgfSBvZiB0aGlzLl9jaGFuZ2VzKSB7CiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgICBpZiAodGhpcy5fY2xvY2tVcGRhdGVzLmhhcyhoZXgpKSB1cGRhdGVzLS0gLy8gc2hhcmVkIGFyZSBza2lwcGVkCiAgICB9CgogICAgcmV0dXJuIGhlYWRlciArIHRoaXMuY29yZS5sZW5ndGggKyB1cGRhdGVzICsgMQogIH0KCiAgYXN5bmMgZmx1c2godmlld3MpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5kYi5iYXRjaCh7IHVwZGF0ZTogZmFsc2UgfSkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2NoYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYyA9IHRoaXMuX2NoYW5nZXNbaV0KICAgICAgaWYgKHRoaXMuX2Nsb2NrVXBkYXRlcy5oYXMoYjRhLnRvU3RyaW5nKGMua2V5LCAnaGV4JykpKSBjb250aW51ZQogICAgICBhd2FpdCBiYXRjaC5wdXQoYy5rZXksIGMudmFsdWUsIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgfQoKICAgIGZvciAoY29uc3QgW2hleCwgbGVuZ3RoXSBvZiB0aGlzLl9jbG9ja1VwZGF0ZXMpIHsKICAgICAgY29uc3QgaXNJbmRleGVyID0gdGhpcy5faW5kZXhlck1hcC5nZXQoaGV4KSAhPT0gdW5kZWZpbmVkCiAgICAgIGNvbnN0IGtleSA9IGI0YS5mcm9tKGhleCwgJ2hleCcpCgogICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgMCkKCiAgICAgIGNvbnN0IHZhbHVlID0geyBpc0luZGV4ZXIsIGlzUmVtb3ZlZDogaW5mbyA/IGluZm8uaXNSZW1vdmVkIDogdHJ1ZSwgbGVuZ3RoIH0KICAgICAgYXdhaXQgYmF0Y2gucHV0KGtleSwgdmFsdWUsIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgfQoKICAgIGlmICh0aGlzLmluZGV4ZXJVcGRhdGUpIHsKICAgICAgdGhpcy5fcmVmcmVzaEVudHJvcHkodGhpcy5jb3JlLmxlbmd0aCArIGJhdGNoLmxlbmd0aCArIDEpCiAgICB9CgogICAgdGhpcy5fY2xvY2tVcGRhdGVzLmNsZWFyKCkKCiAgICBsZXQgbWF4SW5kZXggPSAtMQogICAgZm9yIChjb25zdCB2aWV3IG9mIHZpZXdzKSB7CiAgICAgIGlmICh2aWV3Lm1hcHBlZEluZGV4ID4gbWF4SW5kZXgpIG1heEluZGV4ID0gdmlldy5tYXBwZWRJbmRleAogICAgfQoKICAgIHdoaWxlICh0aGlzLnZpZXdzLmxlbmd0aCA+IG1heEluZGV4ICsgMSkgdGhpcy52aWV3cy5wb3AoKQoKICAgIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykgewogICAgICBjb25zdCBsZW5ndGggPSB2aWV3LmNvcmUgPyB2aWV3LmNvcmUubGVuZ3RoIDogdmlldy5sZW5ndGgKICAgICAgaWYgKCFsZW5ndGgpIGNvbnRpbnVlCgogICAgICBjb25zdCB2ID0geyBrZXk6IHZpZXcua2V5LCBsZW5ndGggfQoKICAgICAgaWYgKHZpZXcubWFwcGVkSW5kZXggIT09IC0xKSB7CiAgICAgICAgdGhpcy52aWV3c1t2aWV3Lm1hcHBlZEluZGV4XSA9IHYKICAgICAgfSBlbHNlIHsKICAgICAgICB2aWV3Lm1hcHBlZEluZGV4ID0gdGhpcy52aWV3cy5wdXNoKHYpIC0gMQogICAgICB9CiAgICB9CgogICAgY29uc3QgaW5mbyA9IHsKICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLAogICAgICBtZW1iZXJzOiB0aGlzLm1lbWJlcnMsCiAgICAgIHBlbmRpbmdJbmRleGVyczogdGhpcy5wZW5kaW5nSW5kZXhlcnMsCiAgICAgIGluZGV4ZXJzOiB0aGlzLmluZGV4ZXJzLAogICAgICBoZWFkczogdGhpcy5oZWFkcywKICAgICAgdmlld3M6IHRoaXMudmlld3MsCiAgICAgIGVuY3J5cHRpb25MZW5ndGg6IHRoaXMuZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5CiAgICB9CgogICAgYXdhaXQgYmF0Y2gucHV0KCdpbmZvJywgaW5mbywgeyB2YWx1ZUVuY29kaW5nOiBJbmZvLCBrZXlFbmNvZGluZzogRElHRVNUIH0pCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCgogICAgdGhpcy5fbGVuZ3RoID0gdGhpcy5jb3JlLmxlbmd0aCAvLyBzaG91bGQgYmUgb2sKICAgIHRoaXMuX2NoYW5nZXMgPSBbXQoKICAgIGlmICh0aGlzLmluZGV4ZXJVcGRhdGUpIHRoaXMuaW5kZXhlclVwZGF0ZSA9IGZhbHNlCiAgfQoKICBnZXRFbnRyb3B5KGluZGV4ZXJzLCBsZW5ndGgpIHsKICAgIHJldHVybiBnZW5lcmF0ZUVudHJvcHkoaW5kZXhlcnMsIGxlbmd0aCwgdGhpcy5lbnRyb3B5KQogIH0KCiAgX3JlZnJlc2hFbnRyb3B5KGxlbmd0aCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA8IDIpIHJldHVybgogICAgdGhpcy5lbnRyb3B5ID0gdGhpcy5nZXRFbnRyb3B5KHRoaXMuaW5kZXhlcnMsIGxlbmd0aCkKICB9CgogIGNoZWNrcG9pbnQoKSB7CiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sCiAgICAgIG1lbWJlcnM6IHRoaXMubWVtYmVycywKICAgICAgcGVuZGluZ0luZGV4ZXJzOiB0aGlzLnBlbmRpbmdJbmRleGVycy5zbGljZSgwKSwKICAgICAgaW5kZXhlcnM6IGNsb25lTm9kZXModGhpcy5pbmRleGVycyksCiAgICAgIGhlYWRzOiBjbG9uZU5vZGVzKHRoaXMuaGVhZHMpLAogICAgICB2aWV3czogY2xvbmVOb2Rlcyh0aGlzLnZpZXdzKSwKICAgICAgaW5kZXhlclVwZGF0ZTogdGhpcy5pbmRleGVyVXBkYXRlLAogICAgICBlbmNyeXB0aW9uTGVuZ3RoOiB0aGlzLmVuY3J5cHRpb25MZW5ndGgsCiAgICAgIGVudHJvcHk6IHRoaXMuZW50cm9weSA/IGI0YS5mcm9tKHRoaXMuZW50cm9weSkgOiBudWxsLAogICAgICBjaGFuZ2VzOiB0aGlzLl9jaGFuZ2VzLnNsaWNlKDApLAogICAgICBjbG9ja1VwZGF0ZXM6IG5ldyBNYXAoWy4uLnRoaXMuX2Nsb2NrVXBkYXRlc10pCiAgICB9CiAgfQoKICBhcHBseUNoZWNrcG9pbnQoY2hlY2twb2ludCkgewogICAgdGhpcy52ZXJzaW9uID0gY2hlY2twb2ludC52ZXJzaW9uCiAgICB0aGlzLm1lbWJlcnMgPSBjaGVja3BvaW50Lm1lbWJlcnMKICAgIHRoaXMucGVuZGluZ0luZGV4ZXJzID0gY2hlY2twb2ludC5wZW5kaW5nSW5kZXhlcnMKICAgIHRoaXMuaW5kZXhlcnMgPSBjaGVja3BvaW50LmluZGV4ZXJzCiAgICB0aGlzLmhlYWRzID0gY2hlY2twb2ludC5oZWFkcwogICAgdGhpcy52aWV3cyA9IGNoZWNrcG9pbnQudmlld3MKICAgIHRoaXMuaW5kZXhlclVwZGF0ZSA9IGNoZWNrcG9pbnQuaW5kZXhlclVwZGF0ZQogICAgdGhpcy5lbmNyeXB0aW9uTGVuZ3RoID0gY2hlY2twb2ludC5lbmNyeXB0aW9uTGVuZ3RoCiAgICB0aGlzLmVudHJvcHkgPSBjaGVja3BvaW50LmVudHJvcHkKCiAgICB0aGlzLl9jaGFuZ2VzID0gY2hlY2twb2ludC5jaGFuZ2VzCiAgICB0aGlzLl9jbG9ja1VwZGF0ZXMgPSBjaGVja3BvaW50LmNsb2NrVXBkYXRlcwoKICAgIHRoaXMuX2luZGV4ZXJNYXAgPSBuZXcgTWFwKCkKICAgIGZvciAoY29uc3QgaWR4IG9mIHRoaXMuaW5kZXhlcnMpIHsKICAgICAgdGhpcy5faW5kZXhlck1hcC5zZXQoYjRhLnRvU3RyaW5nKGlkeC5rZXksICdoZXgnKSwgaWR4KQogICAgfQogIH0KCiAgYWRkSGVhZChub2RlKSB7CiAgICBjb25zdCBoID0geyBrZXk6IG5vZGUud3JpdGVyLmNvcmUua2V5LCBsZW5ndGg6IG5vZGUubGVuZ3RoIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuaGVhZHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaGVhZCA9IHRoaXMuaGVhZHNbaV0KCiAgICAgIGlmICghaGFzRGVwZW5kZW5jeShub2RlLCBoZWFkKSkgewogICAgICAgIGlmICghYjRhLmVxdWFscyhub2RlLndyaXRlci5jb3JlLmtleSwgaGVhZC5rZXkpKSBjb250aW51ZQoKICAgICAgICAvLyB0b2RvOiByZW1vdmUgaW4gbmV4dCBtYWpvciBiZWNhdXNlIGJ1ZyB3YXMgZml4ZWQgaGVyZToKICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYXV0b2Jhc2UtbmV4dC9wdWxsLzIzNwoKICAgICAgICAvLyBmaWx0ZXIgb3V0IGFueSBiYWQgaGVhZHMgaW50cm9kdWNlZCBieSBhIGJ1ZyB0bwogICAgICAgIC8vIHByZXZlbnQgaW5jb25zaXN0ZW5jaWVzIGJlaW5nIHdyaXR0ZW4gdG8gdGhlIG9wbG9nCiAgICAgICAgaWYgKGhlYWQubGVuZ3RoID4gaC5sZW5ndGgpIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICBjb25zdCBwb3BwZWQgPSB0aGlzLmhlYWRzLnBvcCgpCiAgICAgIGlmIChwb3BwZWQgIT09IGhlYWQpIHRoaXMuaGVhZHNbaS0tXSA9IHBvcHBlZAogICAgfQoKICAgIHRoaXMuaGVhZHMucHVzaChoKQoKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhoLmtleSwgJ2hleCcpCgogICAgdGhpcy5fY2xvY2tVcGRhdGVzLnNldChoZXgsIGgubGVuZ3RoKQoKICAgIGlmICh0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGggPiAwKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWI0YS5lcXVhbHModGhpcy5wZW5kaW5nSW5kZXhlcnNbaV0sIGgua2V5KSkgY29udGludWUKICAgICAgICB0aGlzLl91cGRhdGVJbmRleGVyKGgua2V5LCBoLmxlbmd0aCwgdHJ1ZSwgaSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgY29uc3QgaWR4ID0gdGhpcy5faW5kZXhlck1hcC5nZXQoaGV4KQogICAgaWYgKGlkeCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGlkeC5sZW5ndGggPSBoLmxlbmd0aAogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3VwZGF0ZUluZGV4ZXIoa2V5LCBsZW5ndGgsIGlzSW5kZXhlciwgaSkgewogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCgogICAgaWYgKCFpc0luZGV4ZXIpIHsKICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9pbmRleGVyTWFwLmdldChoZXgpCiAgICAgIGlmIChleGlzdGluZykgewogICAgICAgIHRoaXMuaW5kZXhlclVwZGF0ZSA9IHRydWUKICAgICAgICB0aGlzLmluZGV4ZXJzLnNwbGljZSh0aGlzLmluZGV4ZXJzLmluZGV4T2YoZXhpc3RpbmcpLCAxKQogICAgICAgIHRoaXMuX2luZGV4ZXJNYXAuZGVsZXRlKGhleCkKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKDsgaSA8IHRoaXMucGVuZGluZ0luZGV4ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKHRoaXMucGVuZGluZ0luZGV4ZXJzW2ldLCBrZXkpKSB7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgaWYgKGkgPj0gdGhpcy5wZW5kaW5nSW5kZXhlcnMubGVuZ3RoKSB0aGlzLnBlbmRpbmdJbmRleGVycy5wdXNoKGtleSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGkgPCB0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGgpIHsKICAgICAgY29uc3QgdG9wID0gdGhpcy5wZW5kaW5nSW5kZXhlcnMucG9wKCkKICAgICAgaWYgKGkgPCB0aGlzLnBlbmRpbmdJbmRleGVycy5sZW5ndGgpIHRoaXMucGVuZGluZ0luZGV4ZXJzW2ldID0gdG9wCiAgICB9CgogICAgY29uc3QgaWR4ID0gdGhpcy5faW5kZXhlck1hcC5nZXQoaGV4KQoKICAgIGlmIChpZHggPT09IHVuZGVmaW5lZCkgewogICAgICBjb25zdCBuZXdJZHggPSB7IGtleSwgbGVuZ3RoIH0KICAgICAgdGhpcy5faW5kZXhlck1hcC5zZXQoaGV4LCBuZXdJZHgpCiAgICAgIHRoaXMuaW5kZXhlcnMucHVzaChuZXdJZHgpCgogICAgICAvLyBib290c3RyYXAgaXMgInNpbGVudGx5IiBhZGRlZCBzbyB0aGF0IGluaXRpYWwgdmlld3MgaGF2ZSBubyBwcm9sb2d1ZQogICAgICBpZiAoIXRoaXMuYm9vdHN0cmFwcGluZykgdGhpcy5pbmRleGVyVXBkYXRlID0gdHJ1ZQogICAgfSBlbHNlIHsKICAgICAgaWR4Lmxlbmd0aCA9IGxlbmd0aAogICAgfQogIH0KCiAgX3NlZW5MZW5ndGgoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5fY2xvY2tVcGRhdGVzLmdldChiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykpIHx8IDAKICB9CgogIGFzeW5jIGFjayhrZXkpIHsKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgMCkKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX3NlZW5MZW5ndGgoa2V5KQogICAgaWYgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCA9PT0gbGVuZ3RoKSByZXR1cm4KCiAgICBjb25zdCBpc0luZGV4ZXIgPSB2YWx1ZSA/IHZhbHVlLmlzSW5kZXhlciA6IGZhbHNlCiAgICBjb25zdCBpc1JlbW92ZWQgPSB2YWx1ZSA/IHZhbHVlLmlzUmVtb3ZlZCA6IHRydWUKCiAgICB0aGlzLl9jaGFuZ2VzLnB1c2goeyBrZXksIHZhbHVlOiB7IGlzSW5kZXhlciwgaXNSZW1vdmVkLCBsZW5ndGggfSB9KQogIH0KCiAgYXN5bmMgYWRkKGtleSwgeyBpc0luZGV4ZXIgPSBmYWxzZSwgbGVuZ3RoID0gdGhpcy5fc2Vlbkxlbmd0aChrZXkpIH0gPSB7fSkgewogICAgbGV0IHZhbHVlID0gbnVsbAogICAgbGV0IGZvdW5kID0gZmFsc2UKICAgIGxldCBjaGFuZ2VkID0gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSB0aGlzLl9jaGFuZ2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLl9jaGFuZ2VzW2ldCiAgICAgIGlmIChiNGEuZXF1YWxzKGtleSwgYy5rZXkpKSB7CiAgICAgICAgdmFsdWUgPSBjLnZhbHVlCiAgICAgICAgZm91bmQgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIGlmICghZm91bmQpIHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuZGIuZ2V0KGtleSwgeyB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCgogICAgICBpZiAobm9kZSkgewogICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgbGV0IHdhc1RyYWNrZWQgPSBmYWxzZQogICAgbGV0IHdhc0luZGV4ZXIgPSBmYWxzZQoKICAgIGlmIChmb3VuZCkgewogICAgICBpZiAoIXZhbHVlLmlzUmVtb3ZlZCkgd2FzVHJhY2tlZCA9IHRydWUKICAgICAgaWYgKHZhbHVlLmlzSW5kZXhlcikgd2FzSW5kZXhlciA9IHRydWUKICAgICAgaWYgKGxlbmd0aCA8IHZhbHVlLmxlbmd0aCkgbGVuZ3RoID0gdmFsdWUubGVuZ3RoCiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IGxlbmd0aCAmJiB2YWx1ZS5pc0luZGV4ZXIgPT09IGlzSW5kZXhlciAmJiB2YWx1ZS5pc1JlbW92ZWQgPT09IGZhbHNlKQogICAgICAgIGNoYW5nZWQgPSBmYWxzZQogICAgfQoKICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgIHRoaXMuX2NoYW5nZXMucHVzaCh7IGtleSwgdmFsdWU6IHsgaXNJbmRleGVyLCBpc1JlbW92ZWQ6IGZhbHNlLCBsZW5ndGggfSB9KQogICAgfQoKICAgIGlmICghd2FzVHJhY2tlZCkgdGhpcy5tZW1iZXJzKysKICAgIGlmICh3YXNJbmRleGVyIHx8IGlzSW5kZXhlcikgdGhpcy5fdXBkYXRlSW5kZXhlcihrZXksIGxlbmd0aCwgaXNJbmRleGVyLCAwKQogIH0KCiAgYXN5bmMgcmVtb3ZlKGtleSkgewogICAgbGV0IGlzSW5kZXhlciA9IGZhbHNlCgogICAgZm9yIChjb25zdCBpZHggb2YgdGhpcy5pbmRleGVycykgewogICAgICBpc0luZGV4ZXIgPSBiNGEuZXF1YWxzKGlkeC5rZXksIGtleSkKICAgICAgaWYgKGlzSW5kZXhlcikgYnJlYWsKICAgIH0KCiAgICBpZiAoaXNJbmRleGVyKSB0aGlzLl91cGRhdGVJbmRleGVyKGtleSwgbnVsbCwgZmFsc2UsIDApCgogICAgbGV0IHZhbHVlID0gbnVsbAogICAgbGV0IGZvdW5kID0gZmFsc2UKCiAgICBmb3IgKGxldCBpID0gdGhpcy5fY2hhbmdlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBjID0gdGhpcy5fY2hhbmdlc1tpXQogICAgICBpZiAoYjRhLmVxdWFscyhrZXksIGMua2V5KSkgewogICAgICAgIHZhbHVlID0gYy52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KCiAgICBpZiAoIWZvdW5kKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRiLmdldChrZXksIHsgdmFsdWVFbmNvZGluZzogTWVtYmVyLCBrZXlFbmNvZGluZzogTUVNQkVSUyB9KQogICAgICBpZiAobm9kZSkgewogICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZQogICAgICAgIGZvdW5kID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgY29uc3QgY2hhbmdlZCA9ICFmb3VuZCB8fCAhdmFsdWUuaXNSZW1vdmVkCiAgICBjb25zdCB3YXNUcmFja2VkID0gZm91bmQgJiYgIXZhbHVlLmlzUmVtb3ZlZAogICAgY29uc3QgbGVuZ3RoID0gZm91bmQgPyB2YWx1ZS5sZW5ndGggOiAwCgogICAgaWYgKGNoYW5nZWQpIHsKICAgICAgdGhpcy5fY2hhbmdlcy5wdXNoKHsga2V5LCB2YWx1ZTogeyBpc0luZGV4ZXI6IGZhbHNlLCBpc1JlbW92ZWQ6IHRydWUsIGxlbmd0aCB9IH0pCiAgICB9CgogICAgaWYgKHdhc1RyYWNrZWQpIHRoaXMubWVtYmVycy0tCgogICAgcmV0dXJuIGlzSW5kZXhlcgogIH0KCiAgYXN5bmMgbGlua2FibGUoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGxlbiA9IHRoaXMuX3NlZW5MZW5ndGgoa2V5KQogICAgaWYgKGxlbiA+IDApIHJldHVybiBsZW5ndGggPiBsZW4KCiAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgMCkKICAgIGNvbnN0IHByZXZMZW5ndGggPSBpbmZvID8gaW5mby5sZW5ndGggOiAwCgogICAgcmV0dXJuIGxlbmd0aCA+IHByZXZMZW5ndGgKICB9CgogIGFzeW5jIGhhcyhrZXksIG9wdHMpIHsKICAgIC8vIGNvdWxkIGJlIG9wdGltaXNlZC4uLgogICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldChrZXksIG9wdHMpKSAhPT0gbnVsbAogIH0KCiAgYXN5bmMgX2dldChrZXksIHRpbWVvdXQpIHsKICAgIGxldCB2YWx1ZSA9IG51bGwKICAgIGxldCBmb3VuZCA9IGZhbHNlCgogICAgZm9yIChsZXQgaSA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgYyA9IHRoaXMuX2NoYW5nZXNbaV0KICAgICAgaWYgKGI0YS5lcXVhbHMoa2V5LCBjLmtleSkpIHsKICAgICAgICB2YWx1ZSA9IGMudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKCFmb3VuZCkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5kYi5nZXQoa2V5LCB7IHRpbWVvdXQsIHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwga2V5RW5jb2Rpbmc6IE1FTUJFUlMgfSkKICAgICAgaWYgKG5vZGUpIHsKICAgICAgICB2YWx1ZSA9IG5vZGUudmFsdWUKICAgICAgICBmb3VuZCA9IHRydWUKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmb3VuZCA/IHZhbHVlIDogbnVsbAogIH0KCiAgYXN5bmMgZ2V0KGtleSwgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5fZW1wdHkpIHJldHVybiBudWxsCgogICAgbGV0IHZhbHVlID0gYXdhaXQgdGhpcy5fZ2V0KGtleSwgb3B0cy50aW1lb3V0IHx8IDApCgogICAgaWYgKG9wdHMudW5mbHVzaGVkKSB7CiAgICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQoKICAgICAgZm9yIChsZXQgaSA9IHRoaXMuX2NoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCBjID0gdGhpcy5fY2hhbmdlc1tpXQogICAgICAgIGlmIChiNGEuZXF1YWxzKGMua2V5LCBrZXkpKSB2YWx1ZSA9IGMudmFsdWUKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX2Nsb2NrVXBkYXRlcy5oYXMoaGV4KSkgdmFsdWUubGVuZ3RoID0gdGhpcy5fY2xvY2tVcGRhdGVzLmdldChoZXgpCiAgICB9CgogICAgcmV0dXJuIG9wdHMub25seUFjdGl2ZSAhPT0gZmFsc2UgfHwgIXZhbHVlLmlzUmVtb3ZlZCA/IHZhbHVlIDogbnVsbAogIH0KCiAgYXN5bmMgaGFzTG9jYWwoa2V5KSB7CiAgICBpZiAodGhpcy5fZW1wdHkpIHJldHVybiBmYWxzZQogICAgdHJ5IHsKICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRoaXMuZGIuZ2V0KGtleSwgewogICAgICAgIHZhbHVlRW5jb2Rpbmc6IE1lbWJlciwKICAgICAgICBrZXlFbmNvZGluZzogTUVNQkVSUywKICAgICAgICB1cGRhdGU6IGZhbHNlLAogICAgICAgIHdhaXQ6IGZhbHNlCiAgICAgIH0pCiAgICAgIHJldHVybiBub2RlICE9PSBudWxsCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyBnZXRMb2NhbExlbmd0aChrZXkpIHsKICAgIGlmICh0aGlzLl9lbXB0eSkgcmV0dXJuIDAKICAgIHRyeSB7CiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRiLmdldChrZXksIHsKICAgICAgICB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsCiAgICAgICAga2V5RW5jb2Rpbmc6IE1FTUJFUlMsCiAgICAgICAgdXBkYXRlOiBmYWxzZSwKICAgICAgICB3YWl0OiBmYWxzZQogICAgICB9KQogICAgICByZXR1cm4gbm9kZSA9PT0gbnVsbCA/IDAgOiBub2RlLnZhbHVlLmxlbmd0aAogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiAwCiAgICB9CiAgfQoKICBsaXN0KCkgewogICAgLy8gbm90ZSwgTk9UIHNhZmUgdG8gdXNlIGR1cmluZyBhcHBseSBhdG0KICAgIHJldHVybiB0aGlzLmRiLmNyZWF0ZVJlYWRTdHJlYW0oewogICAgICB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsCiAgICAgIGtleUVuY29kaW5nOiBNRU1CRVJTCiAgICB9KQogIH0KCiAgYXN5bmMgaXNJbmRleGVkKGtleSwgbGVuZ3RoKSB7CiAgICBjb25zdCBjbyA9IHRoaXMuZGIuY2hlY2tvdXQodGhpcy5jb3JlLmluZGV4ZWRMZW5ndGgpCiAgICB0cnkgewogICAgICBjb25zdCBub2RlID0gYXdhaXQgY28uZ2V0KGtleSwgeyB2YWx1ZUVuY29kaW5nOiBNZW1iZXIsIGtleUVuY29kaW5nOiBNRU1CRVJTIH0pCiAgICAgIHJldHVybiBub2RlICE9PSBudWxsICYmIG5vZGUudmFsdWUubGVuZ3RoID49IGxlbmd0aAogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgY28uY2xvc2UoKQogICAgfQogIH0KCiAgYXN5bmMgZm9yayhpbmRleGVycywgbWFuaWZlc3RzLCBlbmNyeXB0aW9uTGVuZ3RoLCB2aWV3cykgewogICAgdGhpcy5pbmRleGVycyA9IFtdCiAgICB0aGlzLnBlbmRpbmdJbmRleGVycyA9IFtdCiAgICB0aGlzLnZpZXdzID0gdmlld3MKCiAgICBpZiAodGhpcy52ZXJzaW9uIDwgMikgdGhpcy52ZXJzaW9uID0gMiAvLyBidW1wIHRvIGVuYWJsZSBlbnRyb3B5CgogICAgZm9yIChjb25zdCB7IGtleSB9IG9mIGluZGV4ZXJzKSB7CiAgICAgIC8vIHRvZG86IHByb2JhYmx5IG5lZWQgdG8gY2hlY2sgaXNSZW1vdmVkIGV0YwogICAgICBjb25zdCB7IGxlbmd0aCB9ID0gYXdhaXQgdGhpcy5nZXQoa2V5KQogICAgICB0aGlzLmluZGV4ZXJzLnB1c2goeyBrZXksIGxlbmd0aCB9KQogICAgfQoKICAgIHRoaXMuX3JlZnJlc2hFbnRyb3B5KHRoaXMuY29yZS5sZW5ndGgpCgogICAgY29uc3QgYmxvY2tzID0gW10KCiAgICAvLyB0cnVuY2F0ZSBuZWVkcyB0byByZXNwZWN0IGh5cGVyY29yZSBiYXRjaAogICAgbGV0IHRydW5jYXRlID0gdGhpcy5jb3JlLmxlbmd0aCAtIDEKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiB0aGlzLmRiLmNyZWF0ZUhpc3RvcnlTdHJlYW0oeyBsdDogdHJ1bmNhdGUsIHJldmVyc2U6IHRydWUgfSkpIHsKICAgICAgaWYgKGI0YS5lcXVhbHMoZGF0YS5rZXksIElORk9fS0VZKSkgewogICAgICAgIHRydW5jYXRlID0gZGF0YS5zZXEgKyAxCiAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgYmxvY2tzLnB1c2goZGF0YSkKICAgIH0KCiAgICBhd2FpdCB0aGlzLmNvcmUudHJ1bmNhdGUodHJ1bmNhdGUsIHRoaXMuY29yZS5mb3JrKQoKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5kYi5iYXRjaCh7IHVwZGF0ZTogZmFsc2UgfSkKICAgIGF3YWl0IGJhdGNoLnJlYWR5KCkKCiAgICBmb3IgKGNvbnN0IHsga2V5LCB2YWx1ZSB9IG9mIGJsb2NrcykgewogICAgICBhd2FpdCBiYXRjaC5wdXQoa2V5LCB2YWx1ZSkKICAgIH0KCiAgICBjb25zdCBpbmZvID0gewogICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sCiAgICAgIG1lbWJlcnM6IHRoaXMubWVtYmVycywKICAgICAgcGVuZGluZ0luZGV4ZXJzOiB0aGlzLnBlbmRpbmdJbmRleGVycywKICAgICAgaW5kZXhlcnM6IHRoaXMuaW5kZXhlcnMsCiAgICAgIGhlYWRzOiB0aGlzLmhlYWRzLAogICAgICB2aWV3czogdGhpcy52aWV3cywKICAgICAgZW5jcnlwdGlvbkxlbmd0aCwKICAgICAgZW50cm9weTogdGhpcy5lbnRyb3B5CiAgICB9CgogICAgYXdhaXQgYmF0Y2gucHV0KCdpbmZvJywgaW5mbywgeyB2YWx1ZUVuY29kaW5nOiBJbmZvLCBrZXlFbmNvZGluZzogRElHRVNUIH0pCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCgogICAgYXdhaXQgdGhpcy5fcmVzZXQoYXdhaXQgdGhpcy5kYi5nZXQoJ2luZm8nLCB7IHZhbHVlRW5jb2Rpbmc6IEluZm8sIGtleUVuY29kaW5nOiBESUdFU1QgfSkpCgogICAgcmV0dXJuIHRydW5jYXRlCiAgfQp9CgpmdW5jdGlvbiBoYXNEZXBlbmRlbmN5KG5vZGUsIGRlcCkgewogIGZvciAoY29uc3QgaCBvZiBub2RlLmFjdHVhbEhlYWRzKSB7CiAgICBpZiAoc2FtZU5vZGUoaCwgZGVwKSkgcmV0dXJuIHRydWUKICB9CiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIHNhbWVOb2RlKGEsIGIpIHsKICByZXR1cm4gYjRhLmVxdWFscyhhLmtleSwgYi5rZXkpICYmIGEubGVuZ3RoID09PSBiLmxlbmd0aAp9CgpmdW5jdGlvbiBzYW1lSW5kZXhlcnMoYSwgYikgewogIGlmIChhLnZpZXdzLmxlbmd0aCA+IDAgJiYgYi52aWV3cy5sZW5ndGggPiAwKSByZXR1cm4gYjRhLmVxdWFscyhhLnZpZXdzWzBdLmtleSwgYi52aWV3c1swXS5rZXkpCiAgaWYgKGEuaW5kZXhlcnMubGVuZ3RoICE9PSBiLmluZGV4ZXJzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogIGZvciAobGV0IGkgPSAwOyBpIDwgYS5pbmRleGVycy5sZW5ndGg7IGkrKykgewogICAgaWYgKCFiNGEuZXF1YWxzKGEuaW5kZXhlcnNbaV0ua2V5LCBiLmluZGV4ZXJzW2ldLmtleSkpIHJldHVybiBmYWxzZQogIH0KCiAgcmV0dXJuIHRydWUKfQoKZnVuY3Rpb24gY2xvbmVOb2RlcyhhcnIpIHsKICBjb25zdCBjID0gW10KICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgYy5wdXNoKHsga2V5OiBhcnJbaV0ua2V5LCBsZW5ndGg6IGFycltpXS5sZW5ndGggfSkKICB9CiAgcmV0dXJuIGMKfQoKZnVuY3Rpb24gZ2VuZXJhdGVFbnRyb3B5KGluZGV4ZXJzLCBsZW5ndGgsIGVudHJvcHkpIHsKICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2MoOCArIDMyICsgaW5kZXhlcnMubGVuZ3RoICogMzIpCiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoLCBidWZmZXIgfQoKICBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGxlbmd0aCkKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBlbnRyb3B5IHx8IEdFTkVTSVNfRU5UUk9QWSkKICBmb3IgKGNvbnN0IHsga2V5IH0gb2YgaW5kZXhlcnMpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGtleSkKCiAgcmV0dXJuIGNyeXB0by5oYXNoKFtOU19FTlRST1BZLCBidWZmZXJdKQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKCmNvbnN0IE1BWF9XQUlUID0gMiAqIDYwICogMTAwMApjb25zdCBERUZBVUxUX0lOVEVSVkFMID0gMTAgKiAxMDAwCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRpbWVyIHsKICBjb25zdHJ1Y3RvcihoYW5kbGVyLCBpbnRlcnZhbCwgb3B0cyA9IHt9KSB7CiAgICB0aGlzLmhhbmRsZXIgPSBoYW5kbGVyIHx8IG5vb3AKICAgIHRoaXMuaW50ZXJ2YWwgPSBpbnRlcnZhbCB8fCBERUZBVUxUX0lOVEVSVkFMCiAgICB0aGlzLmxpbWl0ID0gb3B0cy5saW1pdCB8fCBNQVhfV0FJVAoKICAgIHRoaXMuX2V4ZWN1dGluZyA9IG51bGwKCiAgICB0aGlzLl9saW1pdCA9IHJhbmRvbTJvdmVyMSh0aGlzLmxpbWl0KQogICAgdGhpcy5fdGltZXIgPSBudWxsCiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgdGhpcy5fc3RhcnQgPSAwCiAgICB0aGlzLl9zdG9wcGVkID0gZmFsc2UKICAgIHRoaXMuX2FzYXAgPSBmYWxzZQogICAgdGhpcy5fc3RhbmRhbG9uZSA9IG5ldyBTZXQoKQoKICAgIHRoaXMuX3VucmVmID0gb3B0cy51bnJlZiAhPT0gZmFsc2UKICAgIHRoaXMuX3RpbWVyQ2FsbGJhY2sgPSB0aGlzLl9leGVjdXRlQmFja2dyb3VuZC5iaW5kKHRoaXMpCiAgfQoKICBfZXhlY3V0ZUJhY2tncm91bmQoKSB7CiAgICB0aGlzLl9leGVjdXRpbmcgPSB0aGlzLl9leGVjdXRlKCkKICAgIHRoaXMuX2V4ZWN1dGluZy5jYXRjaChzYWZldHlDYXRjaCkgLy8gbWFrZSBzdXJlIGl0IGRvZXNudCBjcmFzaCBpbiB0aGUgYmcKICB9CgogIGFzeW5jIF9leGVjdXRlKCkgewogICAgdGhpcy5fYXNhcCA9IGZhbHNlCiAgICBhd2FpdCB0aGlzLmhhbmRsZXIoKQogICAgdGhpcy5fc3RhcnQgPSAwCiAgICB0aGlzLl9leGVjdXRpbmcgPSBudWxsCiAgICB0aGlzLmJ1bXAoKQogIH0KCiAgYnVtcCgpIHsKICAgIGlmICh0aGlzLl9zdG9wcGVkIHx8IHRoaXMuX2V4ZWN1dGluZyB8fCB0aGlzLl9hc2FwKSByZXR1cm4KCiAgICBpZiAoIXRoaXMuX3N0YXJ0KSB0aGlzLl9zdGFydCA9IERhdGUubm93KCkKICAgIGVsc2UgaWYgKERhdGUubm93KCkgLSB0aGlzLl9zdGFydCA+IHRoaXMuX2xpbWl0KSByZXR1cm4KCiAgICBjb25zdCBpbnRlcnZhbCA9IHJhbmRvbTJvdmVyMSh0aGlzLmludGVydmFsKQoKICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCh0aGlzLl90aW1lckNhbGxiYWNrLCBpbnRlcnZhbCkKICAgIGlmICh0aGlzLl91bnJlZiAmJiB0aGlzLl90aW1lci51bnJlZikgdGhpcy5fdGltZXIudW5yZWYoKQogIH0KCiAgYXN5bmMgdHJpZ2dlcigpIHsKICAgIGlmICh0aGlzLl9zdG9wcGVkKSByZXR1cm4KICAgIGlmICh0aGlzLl9leGVjdXRpbmcpIGF3YWl0IHRoaXMuX2V4ZWN1dGluZwogICAgaWYgKHRoaXMuX3N0b3BwZWQpIHJldHVybgoKICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgIHRoaXMuX3RpbWVyID0gbnVsbAoKICAgIHRoaXMuX2V4ZWN1dGVCYWNrZ3JvdW5kKCkKICAgIGF3YWl0IHRoaXMuX2V4ZWN1dGluZwogIH0KCiAgYXN5bmMgZmx1c2goKSB7CiAgICBpZiAodGhpcy5fZXhlY3V0aW5nKSBhd2FpdCB0aGlzLl9leGVjdXRpbmcKICB9CgogIC8vIGJ1c2luZXNzLWFzLXVzdWFsCiAgYmF1KCkgewogICAgaWYgKCF0aGlzLl9hc2FwKSByZXR1cm4KICAgIHRoaXMuX2FzYXAgPSBmYWxzZQogICAgdGhpcy5idW1wKCkKICB9CgogIGFzYXAoKSB7CiAgICBpZiAodGhpcy5fYXNhcCkgcmV0dXJuCiAgICB0aGlzLl9hc2FwID0gdHJ1ZQoKICAgIGNvbnN0IGludGVydmFsID0gTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSAqIHRoaXMuaW50ZXJ2YWwpIC8gMykKICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCh0aGlzLl90aW1lckNhbGxiYWNrLCBpbnRlcnZhbCkKICAgIGlmICh0aGlzLl91bnJlZiAmJiB0aGlzLl90aW1lci51bnJlZikgdGhpcy5fdGltZXIudW5yZWYoKQogIH0KCiAgc3RvcCgpIHsKICAgIGlmICh0aGlzLl90aW1lcikgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogICAgdGhpcy5fdGltZXIgPSBudWxsCiAgICB0aGlzLl9zdGFydCA9IDAKICAgIHRoaXMuX2FzYXAgPSBmYWxzZQogICAgdGhpcy5fc3RvcHBlZCA9IHRydWUKCiAgICBmb3IgKGNvbnN0IHsgdGltZXIsIHJlc29sdmUgfSBvZiB0aGlzLl9zdGFuZGFsb25lKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lcikKICAgICAgcmVzb2x2ZSgpCiAgICB9CgogICAgdGhpcy5fc3RhbmRhbG9uZS5jbGVhcigpCiAgfQoKICBhc2FwU3RhbmRhbG9uZSgpIHsKICAgIGNvbnN0IGludGVydmFsID0gTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSAqIHRoaXMuaW50ZXJ2YWwpIC8gMykKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBjb25zdCByZWYgPSB7IHRpbWVyOiBudWxsLCByZXNvbHZlIH0KICAgICAgcmVmLnRpbWVyID0gc2V0VGltZW91dChyZXNvbHZlU3RhbmRhbG9uZSwgaW50ZXJ2YWwsIHJlZiwgdGhpcy5fc3RhbmRhbG9uZSkKICAgICAgaWYgKHJlZi50aW1lci51bnJlZikgcmVmLnRpbWVyLnVucmVmKCkKICAgICAgdGhpcy5fc3RhbmRhbG9uZS5hZGQocmVmKQogICAgfSkKICB9CgogIHVucmVmKCkgewogICAgaWYgKHRoaXMuX3RpbWVyICYmIHRoaXMuX3RpbWVyLnVucmVmKSB0aGlzLl90aW1lci51bnJlZigpCiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlU3RhbmRhbG9uZShyZWYsIHNldCkgewogIHNldC5kZWxldGUocmVmKQogIHJlZi5yZXNvbHZlKCkKfQoKLy8gcmFuZG9tIHZhbHVlIHggYmV0d2VlbiBuIDw9IHggPCAybgpmdW5jdGlvbiByYW5kb20yb3ZlcjEobikgewogIHJldHVybiBNYXRoLmZsb29yKG4gKyBNYXRoLnJhbmRvbSgpICogbikKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUb3BvTGlzdCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnRpcCA9IFtdCiAgICB0aGlzLnVuZG8gPSAwCiAgICB0aGlzLnNoYXJlZCA9IDAKICB9CgogIHN0YXRpYyBjb21wYXJlKGEsIGIpIHsKICAgIHJldHVybiBjbXAoYSwgYikKICB9CgogIHN0YXRpYyBhZGQobm9kZSwgaW5kZXhlZCwgb2Zmc2V0KSB7CiAgICBhZGRTb3J0ZWQobm9kZSwgaW5kZXhlZCwgb2Zmc2V0KQogIH0KCiAgbWFyaygpIHsKICAgIHRoaXMuc2hhcmVkID0gdGhpcy50aXAubGVuZ3RoCiAgICB0aGlzLnVuZG8gPSAwCiAgfQoKICAvLyB0b2RvOiBidW1wIHRvIG5ldyBhcGkgdGhhdCBqdXN0IHRyYWNrcyB1bmRvCiAgZmx1c2goaW5kZXhlZCA9IFtdKSB7CiAgICBpZiAoaW5kZXhlZC5sZW5ndGgpIHRoaXMuX2FwcGx5SW5kZXhlZChpbmRleGVkKQoKICAgIGNvbnN0IHUgPSB7CiAgICAgIHNoYXJlZDogdGhpcy5zaGFyZWQsCiAgICAgIHVuZG86IHRoaXMudW5kbywKICAgICAgbGVuZ3RoOiBpbmRleGVkLmxlbmd0aCArIHRoaXMudGlwLmxlbmd0aCwKICAgICAgaW5kZXhlZCwKICAgICAgdGlwOiB0aGlzLnRpcAogICAgfQoKICAgIHRoaXMubWFyaygpCgogICAgcmV0dXJuIHUKICB9CgogIHByaW50KCkgewogICAgcmV0dXJuIHRoaXMudGlwLm1hcCgobikgPT4gbi53cml0ZXIuY29yZS5rZXkudG9TdHJpbmcoKSArIG4ubGVuZ3RoKQogIH0KCiAgX2FwcGx5SW5kZXhlZChub2RlcykgewogICAgYXNzZXJ0KG5vZGVzLmxlbmd0aCA8PSB0aGlzLnRpcC5sZW5ndGgsICdJbmRleGVkIGJhdGNoIGNhbm5vdCBleGNlZWQgdGlwJykKCiAgICBsZXQgc2hhcmVkID0gMAoKICAgIGZvciAoOyBzaGFyZWQgPCBub2Rlcy5sZW5ndGg7IHNoYXJlZCsrKSB7CiAgICAgIGlmICh0aGlzLnRpcFtzaGFyZWRdICE9PSBub2Rlc1tzaGFyZWRdKSBicmVhawogICAgfQoKICAgIC8vIHJlb3JkZXJpbmcKICAgIGlmIChzaGFyZWQgPCBub2Rlcy5sZW5ndGgpIHRoaXMuX3RyYWNrKHNoYXJlZCkKCiAgICBjb25zdCB0aXAgPSBbXQoKICAgIGZvciAobGV0IGkgPSBzaGFyZWQ7IGkgPCB0aGlzLnRpcC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBub2RlID0gdGhpcy50aXBbaV0KICAgICAgaWYgKG5vZGUueWllbGRlZCkgY29udGludWUKICAgICAgY29uc3QgcyA9IGFkZFNvcnRlZChub2RlLCB0aXAsIDApCiAgICAgIGlmIChzID09PSB0aXAubGVuZ3RoIC0gMSkgY29udGludWUKICAgICAgdGhpcy5fdHJhY2soc2hhcmVkICsgcykKICAgIH0KCiAgICB0aGlzLnRpcCA9IHRpcAogIH0KCiAgYWRkKG5vZGUpIHsKICAgIGNvbnN0IHNoYXJlZCA9IGFkZFNvcnRlZChub2RlLCB0aGlzLnRpcCwgMCkKICAgIHRoaXMuX3RyYWNrKHNoYXJlZCkKICB9CgogIF90cmFjayhzaGFyZWQpIHsKICAgIGlmIChzaGFyZWQgPCB0aGlzLnNoYXJlZCkgewogICAgICB0aGlzLnVuZG8gKz0gdGhpcy5zaGFyZWQgLSBzaGFyZWQKICAgICAgdGhpcy5zaGFyZWQgPSBzaGFyZWQKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGhhc09wdGltaXN0aWNEZXBzKG5vZGUpIHsKICBmb3IgKGNvbnN0IGQgb2Ygbm9kZS5kZXBlbmRlbmNpZXMpIHsKICAgIGlmIChkLm9wdGltaXN0aWMpIHJldHVybiB0cnVlCiAgfQogIHJldHVybiBmYWxzZQp9CgovLyB0aGlzIGNhbiBiZSBvcHRpbWlzZWQgdG8gb25seSByZXR1cm4gb3B0aW1pc3RpYyBub2RlcyB0aGF0IHdlIHdpbGwgInRvdWNoIiB3aGVuIG1vdmluZyBkb3duIHRoZSBub2RlCmZ1bmN0aW9uIGdldE9wdGltaXN0aWNEZXBzKG5vZGUsIGxpc3QpIHsKICBjb25zdCBkZXBzID0gbmV3IFNldCgpCiAgY29uc3Qgc3RhY2sgPSBbbm9kZV0KCiAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IG5leHQgPSBzdGFjay5wb3AoKQogICAgaWYgKGRlcHMuaGFzKG5leHQpKSBjb250aW51ZQogICAgaWYgKG5leHQub3B0aW1pc3RpYyAmJiBuZXh0ICE9PSBub2RlKSBkZXBzLmFkZChuZXh0KQogICAgZm9yIChjb25zdCBkIG9mIG5leHQuZGVwZW5kZW5jaWVzKSB7CiAgICAgIGlmIChkLm9wdGltaXN0aWMpIHN0YWNrLnB1c2goZCkKICAgIH0KICB9CgogIGNvbnN0IHJlc3VsdCA9IFtdCgogIGZvciAobGV0IGkgPSBsaXN0Lmxlbmd0aCAtIDE7IGRlcHMuc2l6ZSAhPT0gcmVzdWx0Lmxlbmd0aCAmJiBpID49IDA7IGktLSkgewogICAgY29uc3QgbiA9IGxpc3RbaV0KICAgIGlmIChkZXBzLmhhcyhuKSkgcmVzdWx0LnB1c2gobikKICB9CgogIHJldHVybiByZXN1bHQucmV2ZXJzZSgpCn0KCmZ1bmN0aW9uIGFkZFNvcnRlZE9wdGltaXN0aWMobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgY29uc3Qgb3B0ID0gZ2V0T3B0aW1pc3RpY0RlcHMobm9kZSwgbGlzdCkKICBjb25zdCBwb3MgPSBuZXcgVWludDMyQXJyYXkob3B0Lmxlbmd0aCkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcHQubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IG4gPSBvcHRbaV0KICAgIHBvc1tpXSA9IG4uaW5kZXgKICAgIG1vdmVEb3duKG4sIGxpc3QsIG9mZnNldCkKICB9CgogIG1vdmVEb3duQW5kVXAobm9kZSwgbGlzdCwgb2Zmc2V0KQoKICBmb3IgKGxldCBpID0gb3B0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICBtb3ZlT3B0aW1pc3RpY1VwKG9wdFtpXSwgbGlzdCwgb2Zmc2V0KQogIH0KCiAgbGV0IHNoYXJlZCA9IG5vZGUuaW5kZXgKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcHQubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGlkeCA9IHBvc1tpXQogICAgY29uc3QgbiA9IG9wdFtpXQoKICAgIGlmIChpZHggPT09IG4uaW5kZXgpIGNvbnRpbnVlCgogICAgaWYgKGlkeCA8IHNoYXJlZCkgc2hhcmVkID0gaWR4CiAgICBpZiAobi5pbmRleCA8IHNoYXJlZCkgc2hhcmVkID0gbi5pbmRleAogIH0KCiAgcmV0dXJuIHNoYXJlZAp9CgpmdW5jdGlvbiBhZGRTb3J0ZWQobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgbGlzdC5wdXNoKG5vZGUpCiAgbm9kZS5pbmRleCA9IGxpc3QubGVuZ3RoIC0gMQoKICAvLyAic2xvdyIgcGF0aCwgMSUgb2Ygbm9kZXMKICBpZiAoaGFzT3B0aW1pc3RpY0RlcHMobm9kZSkpIHJldHVybiBhZGRTb3J0ZWRPcHRpbWlzdGljKG5vZGUsIGxpc3QsIG9mZnNldCkKCiAgbW92ZURvd25BbmRVcChub2RlLCBsaXN0LCBvZmZzZXQpCiAgcmV0dXJuIG5vZGUuaW5kZXgKfQoKZnVuY3Rpb24gbW92ZURvd24obm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgd2hpbGUgKG5vZGUuaW5kZXggPiBvZmZzZXQpIHsKICAgIGNvbnN0IHByZXYgPSBsaXN0W25vZGUuaW5kZXggLSAxXQogICAgaWYgKGxpbmtzKG5vZGUsIHByZXYpKSBicmVhawogICAgbGlzdFsocHJldi5pbmRleCA9IG5vZGUuaW5kZXgpXSA9IHByZXYKICAgIGxpc3RbLS1ub2RlLmluZGV4XSA9IG5vZGUKICB9Cn0KCmZ1bmN0aW9uIG1vdmVPcHRpbWlzdGljVXAobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgLy8gaWYgb3B0aW1pc3RpYyBtb3ZlIGFsbCB0aGUgd2F5IHVwCiAgd2hpbGUgKG5vZGUuaW5kZXggPCBsaXN0Lmxlbmd0aCAtIDEpIHsKICAgIGNvbnN0IG5leHQgPSBsaXN0W25vZGUuaW5kZXggKyAxXQogICAgaWYgKGxpbmtzKG5leHQsIG5vZGUpKSBicmVhawogICAgbGlzdFsobmV4dC5pbmRleCA9IG5vZGUuaW5kZXgpXSA9IG5leHQKICAgIGxpc3RbKytub2RlLmluZGV4XSA9IG5vZGUKICB9CgogIC8vIHN0YWJsZSBzb3J0IGluIGNhc2UgbXVsdGlwbGUgY2hpbGRyZW4KICB3aGlsZSAobm9kZS5pbmRleCA+IG9mZnNldCkgewogICAgY29uc3QgcHJldiA9IGxpc3Rbbm9kZS5pbmRleCAtIDFdCiAgICBpZiAoIXByZXYub3B0aW1pc3RpYykgYnJlYWsKICAgIGNvbnN0IGMgPSBjbXAocHJldiwgbm9kZSkKICAgIGlmIChjIDw9IDApIGJyZWFrCiAgICBsaXN0WyhwcmV2LmluZGV4ID0gbm9kZS5pbmRleCldID0gcHJldgogICAgbGlzdFstLW5vZGUuaW5kZXhdID0gbm9kZQogIH0KfQoKZnVuY3Rpb24gbW92ZU5vbk9wdGltaXN0aWNVcChub2RlLCBsaXN0LCBvZmZzZXQpIHsKICAvLyBzdGFibGUgc29ydCBhZ2FpbnN0IG5leHQgbm9uIG9wdGltaXN0aWMgbm9kZQogIHdoaWxlIChub2RlLmluZGV4IDwgbGlzdC5sZW5ndGggLSAxKSB7CiAgICBjb25zdCBuZXh0ID0gbGlzdFtub2RlLmluZGV4ICsgMV0KICAgIGNvbnN0IGMgPSBjbXBOb25PcHRpbWlzdGljKG5vZGUsIG5leHQsIGxpc3QpCiAgICBpZiAoYyA8PSAwKSBicmVhawogICAgbGlzdFsobmV4dC5pbmRleCA9IG5vZGUuaW5kZXgpXSA9IG5leHQKICAgIGxpc3RbKytub2RlLmluZGV4XSA9IG5vZGUKICB9Cn0KCmZ1bmN0aW9uIG1vdmVEb3duQW5kVXAobm9kZSwgbGlzdCwgb2Zmc2V0KSB7CiAgbW92ZURvd24obm9kZSwgbGlzdCwgb2Zmc2V0KQoKICBpZiAobm9kZS5vcHRpbWlzdGljKSBtb3ZlT3B0aW1pc3RpY1VwKG5vZGUsIGxpc3QsIG9mZnNldCkKICBlbHNlIG1vdmVOb25PcHRpbWlzdGljVXAobm9kZSwgbGlzdCwgb2Zmc2V0KQp9CgpmdW5jdGlvbiBsaW5rcyhhLCBiKSB7CiAgaWYgKGIuZGVwZW5kZW50cy5oYXMoYSkpIHJldHVybiB0cnVlCiAgcmV0dXJuIGEubGVuZ3RoID4gMCAmJiBiLmxlbmd0aCA9PT0gYS5sZW5ndGggLSAxICYmIGEud3JpdGVyID09PSBiLndyaXRlcgp9CgpmdW5jdGlvbiBjbXBOb25PcHRpbWlzdGljKGEsIGIsIGxpc3QpIHsKICBpZiAoIWIub3B0aW1pc3RpYykgcmV0dXJuIGNtcChhLCBiKQoKICBmb3IgKGxldCBpID0gYi5pbmRleCArIDE7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBub2RlID0gbGlzdFtpXQogICAgaWYgKCFub2RlLm9wdGltaXN0aWMpIHJldHVybiBjbXAoYSwgbm9kZSkKICB9CgogIHJldHVybiAtMQp9CgpmdW5jdGlvbiBjbXAoYSwgYikgewogIHJldHVybiBsaW5rcyhiLCBhKSA/IC0xIDogY21wVW5saW5rZWQoYSwgYikKfQoKZnVuY3Rpb24gY21wVW5saW5rZWQoYSwgYikgewogIGNvbnN0IGMgPSBiNGEuY29tcGFyZShhLndyaXRlci5jb3JlLmtleSwgYi53cml0ZXIuY29yZS5rZXkpCiAgcmV0dXJuIGMgPT09IDAgPyAoYS5sZW5ndGggPCBiLmxlbmd0aCA/IC0xIDogMSkgOiBjCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVcGRhdGVDaGFuZ2VzIHsKICBjb25zdHJ1Y3RvcihiYXNlKSB7CiAgICB0aGlzLmJhc2UgPSBiYXNlCiAgICB0aGlzLmJ5TmFtZSA9IG5ldyBNYXAoKQogICAgdGhpcy50cmFja2luZyA9IG51bGwKICB9CgogIGdldCBkaXNjb3ZlcnlLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmRpc2NvdmVyeUtleQogIH0KCiAgZ2V0IGtleSgpIHsKICAgIHJldHVybiB0aGlzLmJhc2Uua2V5CiAgfQoKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gdGhpcy5iYXNlLmlkCiAgfQoKICBnZXQgc3lzdGVtKCkgewogICAgcmV0dXJuIHRoaXMuYmFzZS5zeXN0ZW0KICB9CgogIHRyYWNrKHN0YXRlKSB7CiAgICB0aGlzLnRyYWNraW5nID0gW10KICAgIHRoaXMuYnlOYW1lLmNsZWFyKCkKCiAgICBpZiAoIXN0YXRlKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IHYgb2Ygc3RhdGUudmlld3MpIHsKICAgICAgaWYgKHYucmVmKSB0aGlzLl9hZGQodi5yZWYpCiAgICB9CgogICAgdGhpcy5fYWRkKHN0YXRlLnN5c3RlbVZpZXcucmVmKQogICAgdGhpcy5fYWRkKHN0YXRlLmVuY3J5cHRpb25WaWV3LnJlZikKICB9CgogIF9hZGQocmVmKSB7CiAgICB0aGlzLnRyYWNraW5nLnB1c2goeyByZWYsIGZyb206IHJlZi5hdG9taWNCYXRjaCA/IHJlZi5hdG9taWNCYXRjaC5sZW5ndGggOiAwIH0pCiAgfQoKICBmaW5hbGlzZSgpIHsKICAgIGlmICh0aGlzLnRyYWNraW5nID09PSBudWxsKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IHsgcmVmLCBmcm9tIH0gb2YgdGhpcy50cmFja2luZykgewogICAgICBjb25zdCBjb3JlID0gcmVmLmF0b21pY0JhdGNoIHx8IHJlZi5iYXRjaAogICAgICBjb25zdCB0cnVuYyA9IHJlZi5hdG9taWNCYXRjaCA/IHJlZi5hdG9taWNCYXRjaC5zdGF0ZS5sYXN0VHJ1bmNhdGlvbiA6IG51bGwKCiAgICAgIHRoaXMuYnlOYW1lLnNldChyZWYubmFtZSwgewogICAgICAgIGZyb20sCiAgICAgICAgdG86IGNvcmUgPyBjb3JlLmxlbmd0aCA6IGZyb20sCiAgICAgICAgc2hhcmVkOiB0cnVuYyA/IHRydW5jLnRvIDogZnJvbQogICAgICB9KQogICAgfQoKICAgIHRoaXMudHJhY2tpbmcgPSBudWxsCiAgfQoKICBnZXQobmFtZSkgewogICAgcmV0dXJuIHRoaXMuYnlOYW1lLmdldChuYW1lKQogIH0KfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgeyBPUExPR19WRVJTSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMuanMnKQpjb25zdCB7IE9wbG9nTWVzc2FnZSB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IHsgRW5jcnlwdGlvblZpZXcgfSA9IHJlcXVpcmUoJy4vZW5jcnlwdGlvbi5qcycpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBlbmNvZGVWYWx1ZSwKICBkZWNvZGVWYWx1ZQp9CgpmdW5jdGlvbiBlbmNvZGVWYWx1ZSh2YWx1ZSwgb3B0cyA9IHt9KSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CgogIGNvbnN0IG1lc3NhZ2UgPSB7CiAgICB2ZXJzaW9uOiBvcHRzLnZlcnNpb24gfHwgT1BMT0dfVkVSU0lPTiwKICAgIGRpZ2VzdDogbnVsbCwKICAgIGNoZWNrcG9pbnQ6IG51bGwsCiAgICBvcHRpbWlzdGljOiAhIW9wdHMub3B0aW1pc3RpYywKICAgIG5vZGU6IHsKICAgICAgaGVhZHM6IG9wdHMuaGVhZHMgfHwgW10sCiAgICAgIGJhdGNoOiAxLAogICAgICB2YWx1ZQogICAgfQogIH0KCiAgT3Bsb2dNZXNzYWdlLnByZWVuY29kZShzdGF0ZSwgbWVzc2FnZSkKCiAgaWYgKG9wdHMucGFkZGluZykgewogICAgc3RhdGUuc3RhcnQgPSBvcHRzLnBhZGRpbmcKICAgIHN0YXRlLmVuZCArPSBvcHRzLnBhZGRpbmcKICB9CgogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvYyhzdGF0ZS5lbmQpCgogIE9wbG9nTWVzc2FnZS5lbmNvZGUoc3RhdGUsIG1lc3NhZ2UpCgogIGlmICghb3B0cy5lbmNyeXB0ZWQpIHJldHVybiBzdGF0ZS5idWZmZXIKCiAgaWYgKCFvcHRzLm9wdGltaXN0aWMpIHsKICAgIHRocm93IG5ldyBFcnJvcignRW5jb2RpbmcgYW4gZW5jcnlwdGVkIHZhbHVlIGlzIG5vdCBzdXBwb3J0ZWQnKQogIH0KCiAgY29uc3QgcGFkZGluZyA9IGI0YS5hbGxvYygxNikgLy8gbWluIGhhc2ggbGVuZ3RoIGlzIDE2CiAgY3J5cHRvLmhhc2goc3RhdGUuYnVmZmVyLCBwYWRkaW5nKQogIHBhZGRpbmdbMF0gPSAwCgogIHJldHVybiBiNGEuY29uY2F0KFtwYWRkaW5nLnN1YmFycmF5KDAsIDgpLCBzdGF0ZS5idWZmZXJdKQp9Cgphc3luYyBmdW5jdGlvbiBkZWNvZGVWYWx1ZSh2YWx1ZSwgeyBhdXRvYmFzZSwgZW5jcnlwdGlvbktleSwga2V5LCBtYW5pZmVzdCwgaW5kZXggPSAwIH0gPSB7fSkgewogIGlmIChlbmNyeXB0aW9uS2V5KSB7CiAgICBjb25zdCBlID0gbmV3IEVuY3J5cHRpb25WaWV3KHsgZW5jcnlwdGlvbktleSwgYm9vdHN0cmFwOiBhdXRvYmFzZSB9KQogICAgY29uc3QgdyA9IGUuZ2V0V3JpdGVyRW5jcnlwdGlvbigpCgogICAgYXdhaXQgdy5kZWNyeXB0KGluZGV4LCB2YWx1ZSwgeyBrZXksIG1hbmlmZXN0IH0pCiAgICB2YWx1ZSA9IHZhbHVlLnN1YmFycmF5KDgpCiAgfQoKICBjb25zdCBvcCA9IGMuZGVjb2RlKE9wbG9nTWVzc2FnZSwgdmFsdWUpCiAgcmV0dXJuIG9wLm5vZGUudmFsdWUKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKCmNvbnN0IFdha2V1cEVudHJ5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBdXRvV2FrZXVwIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoYmFzZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuZmx1c2hpbmcgPSBudWxsCgogICAgdGhpcy5fcm9vdFN0b3JlID0gdGhpcy5iYXNlLnN0b3JlCiAgICB0aGlzLl9hZGRCb3VuZCA9IHRoaXMuYWRkLmJpbmQodGhpcykKICAgIHRoaXMuX3ByZXVwZGF0ZUJvdW5kID0gdGhpcy5fcHJldXBkYXRlLmJpbmQodGhpcykKICAgIHRoaXMuX25lZWRzRmx1c2ggPSBmYWxzZQogICAgdGhpcy5fbWFwID0gbmV3IE1hcCgpCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAudmFsdWVzKCkKICB9CgogIGFzeW5jIF9wcmV1cGRhdGUoYmF0Y2gsIGtleSkgewogICAgdGhpcy5xdWV1ZShrZXksIGJhdGNoLmxlbmd0aCkKICAgIGF3YWl0IHRoaXMuZmx1c2goKQogICAgdGhpcy5iYXNlLl9vbndha2V1cCgpCiAgfQoKICBhc3luYyBfc2F2ZSgpIHsKICAgIGNvbnN0IHNsYWIgPSBiNGEuYWxsb2NVbnNhZmUoOCArIHRoaXMuX21hcC5zaXplICogNDApIC8vIDMyICsgOAogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogc2xhYiB9CgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdGhpcy5fbWFwLnNpemUpCiAgICBmb3IgKGNvbnN0IG0gb2YgdGhpcy5fbWFwLnZhbHVlcygpKSBXYWtldXBFbnRyeS5lbmNvZGUoc3RhdGUsIG0pCgogICAgYXdhaXQgdGhpcy5iYXNlLmxvY2FsLnNldFVzZXJEYXRhKCdhdXRvYmFzZS93YWtldXAnLCBzbGFiLnN1YmFycmF5KDAsIHN0YXRlLnN0YXJ0KSkKICB9CgogIGFzeW5jIF9sb2FkKCkgewogICAgY29uc3QgYnVmZmVyID0gYXdhaXQgdGhpcy5iYXNlLmxvY2FsLmdldFVzZXJEYXRhKCdhdXRvYmFzZS93YWtldXAnKQogICAgaWYgKCFidWZmZXIpIHJldHVybgoKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KCiAgICBsZXQgbGVuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHdoaWxlIChsZW4tLSA+IDApIHsKICAgICAgY29uc3QgbSA9IFdha2V1cEVudHJ5LmRlY29kZShzdGF0ZSkKICAgICAgdGhpcy5fbWFwLnNldChiNGEudG9TdHJpbmcobS5rZXksICdoZXgnKSwgbSkKICAgIH0KICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgYXdhaXQgdGhpcy5fbG9hZCgpCgogICAgdGhpcy5fcm9vdFN0b3JlLndhdGNoKHRoaXMuX2FkZEJvdW5kKQoKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLl9yb290U3RvcmUuY29yZXMpIHsKICAgICAgaWYgKGNvcmUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgY29yZS5yZWFkeSgpLmNhdGNoKG5vb3ApCiAgICAgIGlmICghY29yZS5jbG9zaW5nKSB0aGlzLmFkZChjb3JlKQogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgdGhpcy5fcm9vdFN0b3JlLnVud2F0Y2godGhpcy5fYWRkQm91bmQpCgogICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuX3Jvb3RTdG9yZS5jb3JlcykgewogICAgICBpZiAoY29yZS5vcGVuZWQgJiYgIWNvcmUuY2xvc2luZykgdGhpcy5yZW1vdmUoY29yZSkKICAgIH0KCiAgICB0aGlzLl9tYXAuY2xlYXIoKQoKICAgIHdoaWxlICh0aGlzLmZsdXNoaW5nKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5mbHVzaGluZwogICAgICB9IGNhdGNoIHt9CiAgICB9CiAgfQoKICBxdWV1ZShrZXksIGxlbmd0aCkgewogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGtleSwgJ2hleCcpCiAgICBjb25zdCBtID0gdGhpcy5fbWFwLmdldChoZXgpCgogICAgaWYgKG0gJiYgbS5sZW5ndGggPiBsZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgdGhpcy5fbmVlZHNGbHVzaCA9IHRydWUKICAgIHRoaXMuX21hcC5zZXQoaGV4LCB7IGtleSwgbGVuZ3RoIH0pCgogICAgcmV0dXJuIHRydWUKICB9CgogIHVucXVldWUoa2V5LCBsZW5ndGgpIHsKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgY29uc3QgbSA9IHRoaXMuX21hcC5nZXQoaGV4KQoKICAgIGlmICghbSkgcmV0dXJuIHRydWUKICAgIGlmIChtLmxlbmd0aCA+IGxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5fbmVlZHNGbHVzaCA9IHRydWUKICAgIHRoaXMuX21hcC5kZWxldGUoaGV4KQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignQ2xvc2luZycpCgogICAgLy8gd2FpdCBmb3Igc29tZW9uZQogICAgaWYgKHRoaXMuZmx1c2hpbmcpIGF3YWl0IHRoaXMuZmx1c2hpbmcKCiAgICAvLyBpZiBhbm90aGVyIHN0aWxsIGFjdGl2ZSB0aGV5IGZsdXNoZWQgdXMKICAgIGlmICh0aGlzLmZsdXNoaW5nKSByZXR1cm4gdGhpcy5mbHVzaGluZwoKICAgIGlmICh0aGlzLl9uZWVkc0ZsdXNoID09PSBmYWxzZSkgcmV0dXJuCiAgICB0aGlzLl9uZWVkc0ZsdXNoID0gZmFsc2UKCiAgICB0cnkgewogICAgICB0aGlzLmZsdXNoaW5nID0gdGhpcy5fc2F2ZSgpCiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZsdXNoaW5nCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmZsdXNoaW5nID0gbnVsbAogICAgfQogIH0KCiAgYWRkKGNvcmUpIHsKICAgIHJldHVybiB0aGlzLl9hZGQoY29yZSkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICByZW1vdmUoY29yZSkgewogICAgcmV0dXJuIHRoaXMuX3JlbW92ZShjb3JlKQogIH0KCiAgYXN5bmMgX2FkZChjb3JlKSB7CiAgICBpZiAoY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCBjb3JlLnJlYWR5KCkKICAgIGlmIChjb3JlLmNsb3NpbmcpIHJldHVybiBmYWxzZQoKICAgIC8vIGxvY2FsIHdyaXRlciwgbm8gbmVlZAogICAgaWYgKGNvcmUgPT09IHRoaXMuYmFzZS5sb2NhbC5jb3JlKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCByeCA9IGNvcmUuc3RvcmFnZS5yZWFkKCkKCiAgICBjb25zdCByZWZlcnJlclByb21pc2UgPSByeC5nZXRVc2VyRGF0YSgncmVmZXJyZXInKQogICAgY29uc3Qgdmlld1Byb21pc2UgPSByeC5nZXRVc2VyRGF0YSgnYXV0b2Jhc2UvdmlldycpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IFtyZWZlcnJlciwgdmlld10gPSBhd2FpdCBQcm9taXNlLmFsbChbcmVmZXJyZXJQcm9taXNlLCB2aWV3UHJvbWlzZV0pCiAgICBpZiAodmlldykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHJlZmVycmVyID09PSBudWxsIHx8ICFiNGEuZXF1YWxzKHJlZmVycmVyLCB0aGlzLmJhc2Uua2V5KSkgcmV0dXJuIGZhbHNlCgogICAgY29yZS5wcmV1cGRhdGUgPSB0aGlzLl9wcmV1cGRhdGVCb3VuZAoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVtb3ZlKGNvcmUpIHsKICAgIGlmIChjb3JlLnByZXVwZGF0ZSAhPT0gdGhpcy5fcHJldXBkYXRlQm91bmQpIHJldHVybiBmYWxzZQogICAgY29yZS5wcmV1cGRhdGUgPSBudWxsCiAgICByZXR1cm4gdHJ1ZQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IFNpZ25hbFByb21pc2UgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCgpjb25zdCBMaW5lYXJpemVyID0gcmVxdWlyZSgnLi9saW5lYXJpemVyLmpzJykKY29uc3QgTm9kZUJ1ZmZlciA9IHJlcXVpcmUoJy4vbm9kZS1idWZmZXIuanMnKQoKY29uc3QgTUFYX1BSRUxPQUQgPSA0CmNvbnN0IE1BWF9QUkVGRVRDSCA9IDI1NgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBXcml0ZXIgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvcihiYXNlLCBjb3JlLCBsZW5ndGgsIGlzUmVtb3ZlZCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuYmFzZSA9IGJhc2UKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuaXNSZW1vdmVkID0gaXNSZW1vdmVkCiAgICB0aGlzLnVwZGF0ZWQgPSBmYWxzZQogICAgdGhpcy5yYW5nZSA9IG51bGwKICAgIHRoaXMubm9kZXMgPSBuZXcgTm9kZUJ1ZmZlcihsZW5ndGgpCiAgICB0aGlzLm5vZGUgPSBudWxsCiAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgIHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkID0gZmFsc2UKICAgIHRoaXMuaXNDb3VwbGVkID0gZmFsc2UgLy8gbWFpbnRhaW5lZCBieSB1cGRhdGVCb290c3RyYXBXcml0ZXJzCiAgICB0aGlzLmlzQm9vdHN0cmFwID0gZmFsc2UgLy8gbWFpbnRhaW5lZCBieSB1cGRhdGVCb290c3RyYXBXcml0ZXJzCiAgICB0aGlzLmlzQWN0aXZlSW5kZXhlciA9IGZhbHNlCiAgICB0aGlzLmF2YWlsYWJsZSA9IGxlbmd0aAogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuc2Vlbkxlbmd0aCA9IDAKICAgIHRoaXMucmVjb3ZlciA9IGZhbHNlCiAgICB0aGlzLmZyb3plbiA9IGZhbHNlCgogICAgdGhpcy5zeW5jU2lnbmFsID0gbnVsbAogIH0KCiAgX3BhdXNlKCkgewogICAgaWYgKCF0aGlzLnJhbmdlKSByZXR1cm4KICAgIHRoaXMucmFuZ2UuZGVzdHJveSgpCiAgICB0aGlzLnJhbmdlID0gbnVsbAogIH0KCiAgX3Jlc3VtZSgpIHsKICAgIGlmICh0aGlzLnJhbmdlKSB7CiAgICAgIC8vIGlmIHdlIGRpZG50IGZpbGwgdXAgdGhlIHByZWxvYWQgYnVmZmVyIHlldCwgZG8gbm90IGNvbW1pdCB0byBtb3JlIHdvcmsKICAgICAgaWYgKHRoaXMucmFuZ2UucmFuZ2UuZW5kID09PSB0aGlzLm5vZGVzLmxlbmd0aCArIE1BWF9QUkVGRVRDSCkgcmV0dXJuCiAgICAgIHRoaXMucmFuZ2UuZGVzdHJveSgpCiAgICB9CiAgICB0aGlzLnJhbmdlID0gdGhpcy5jb3JlLmRvd25sb2FkKHsKICAgICAgc3RhcnQ6IHRoaXMubm9kZXMubGVuZ3RoLAogICAgICBlbmQ6IHRoaXMubm9kZXMubGVuZ3RoICsgTUFYX1BSRUZFVENILAogICAgICBsaW5lYXI6IHRydWUKICAgIH0pCiAgfQoKICBfdXBkYXRlQ291cGxpbmcoKSB7CiAgICBpZiAoIXRoaXMuYmFzZS5fY291cGxlciB8fCB0aGlzLmlzQ291cGxlZCA9PT0gdGhpcy5pc0N1cnJlbnRseUNvdXBsZWQpIHJldHVybgoKICAgIGlmICh0aGlzLmlzQ3VycmVudGx5Q291cGxlZCkgdGhpcy5iYXNlLl9jb3VwbGVyLnJlbW92ZSh0aGlzLmNvcmUpCiAgICBlbHNlIHRoaXMuYmFzZS5fY291cGxlci5hZGQodGhpcy5jb3JlKQoKICAgIHRoaXMuaXNDdXJyZW50bHlDb3VwbGVkID0gdGhpcy5pc0NvdXBsZWQKICB9CgogIF9yZW1vdmVDb3VwbGUoKSB7CiAgICBpZiAodGhpcy5iYXNlLl9jb3VwbGVyICYmICF0aGlzLmlzQ291cGxlZCAmJiB0aGlzLmlzQ3VycmVudGx5Q291cGxlZCkgewogICAgICB0aGlzLmlzQ3VycmVudGx5Q291cGxlZCA9IGZhbHNlCiAgICAgIHRoaXMuYmFzZS5fY291cGxlci5yZW1vdmUodGhpcy5jb3JlKQogICAgfQogIH0KCiAgdXBkYXRlQWN0aXZpdHkoKSB7CiAgICBpZiAoIXRoaXMuY29yZS5vcGVuZWQpIHJldHVybgoKICAgIGlmICh0aGlzLnNlZW5MZW5ndGggPiB0aGlzLmNvcmUubGVuZ3RoIHx8IHRoaXMubGVuZ3RoIDwgdGhpcy5jb3JlLmxlbmd0aCB8fCB0aGlzLmlzQm9vdHN0cmFwKSB7CiAgICAgIC8vIGlmIHdlIGhhdmUgc2VlbiBhIGxhdGVyIGNvcmUsIG9yIGlmIHdlIGFyZSBiZWhpbmQsIG9yIGlmIGJvb3RzdHJhcAogICAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZQogICAgICB0aGlzLmNvcmUuc2V0QWN0aXZlKHRydWUpCiAgICB9IGVsc2UgaWYgKHRoaXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoKSB7CiAgICAgIC8vIHRoaW5ncyBsb29rIHN0ZWFkeQogICAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgICAgdGhpcy5jb3JlLnNldEFjdGl2ZShmYWxzZSkKICAgIH0KCiAgICB0aGlzLl91cGRhdGVDb3VwbGluZygpCgogICAgaWYgKHRoaXMuY29yZS53cml0YWJsZSkgcmV0dXJuCgogICAgaWYgKHRoaXMuYmFzZS5pc0Zhc3RGb3J3YXJkaW5nKCkgfHwgIXRoaXMuaXNBY3RpdmUpIHsKICAgICAgdGhpcy5fcGF1c2UoKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcmVzdW1lKCkKICAgIH0KICB9CgogIHNldEJvb3RzdHJhcChib29sKSB7CiAgICB0aGlzLmlzQm9vdHN0cmFwID0gYm9vbAogICAgdGhpcy51cGRhdGVBY3Rpdml0eSgpCiAgfQoKICBzZWVuKGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA+IHRoaXMuc2Vlbkxlbmd0aCkgdGhpcy5zZWVuTGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLnVwZGF0ZUFjdGl2aXR5KCkKICB9CgogIHdhaXRGb3JTeW5jZWQoKSB7CiAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCA9PT0gdGhpcy5sZW5ndGgpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuc3luY1NpZ25hbCA9PT0gbnVsbCkgdGhpcy5zeW5jU2lnbmFsID0gbmV3IFNpZ25hbFByb21pc2UoKQogICAgcmV0dXJuIHRoaXMuc3luY1NpZ25hbC53YWl0KCkKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKICAgIGF3YWl0IHRoaXMuY29yZS5zZXRVc2VyRGF0YSgncmVmZXJyZXInLCB0aGlzLmJhc2Uua2V5KQoKICAgIC8vIGJhc2UgbWlnaHQgYmUgY2xvc2luZyBoZXJlCiAgICBpZiAodGhpcy5iYXNlLmNsb3NpbmcpIHJldHVybgoKICAgIC8vIHJlbW92ZSBsYXRlcgogICAgdGhpcy5yZWNvdmVyID0gYXV0b1JlY292ZXIodGhpcy5jb3JlKQoKICAgIC8vIGFkZCBpdCBhZ2FpbiBpbmNhc2UgaXQgd2Fzbid0IHJlYWRpZWQgYmVmb3JlLCBvbmx5IG5lZWRlZCBpZiB0aGlzIGlzIHRoZSBmaXJzdCB0aW1lIHdlIHNldCB0aGUgcmVmZXJyZXIuLi4KICAgIGF3YWl0IHRoaXMuYmFzZS5fd2FrZXVwLmFkZCh0aGlzLmNvcmUuY29yZSkKCiAgICB0aGlzLnVwZGF0ZUFjdGl2aXR5KCkKCiAgICBpZiAodGhpcy5jb3JlLmxlbmd0aCA+IHRoaXMubGVuZ3RoKSB0aGlzLmJhc2UuX3F1ZXVlQnVtcCgpCgogICAgdGhpcy5iYXNlLmVtaXQoJ3dyaXRlcicsIHRoaXMpCiAgfQoKICBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5zeW5jU2lnbmFsICE9PSBudWxsKSB0aGlzLnN5bmNTaWduYWwubm90aWZ5KCkKICAgIHJldHVybiB0aGlzLmNvcmUuY2xvc2UoKQogIH0KCiAgZ2V0IGluZGV4ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5ub2Rlcy5vZmZzZXQKICB9CgogIGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGggPT09IHRoaXMuYXZhaWxhYmxlICYmIHRoaXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoICYmIHRoaXMuY29yZS5vcGVuZWQKICB9CgogIGZsdXNoZWQoKSB7CiAgICAvLyBUT0RPOiBwcm9wIGEgY2xlYW5lciB3YXkgdG8gZXhwcmVzcyB0aGlzLi4uCiAgICByZXR1cm4gKAogICAgICB0aGlzLnNlZW5MZW5ndGggPD0gdGhpcy5sZW5ndGggJiYKICAgICAgdGhpcy5sZW5ndGggPT09IHRoaXMuYXZhaWxhYmxlICYmCiAgICAgIHRoaXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoICYmCiAgICAgIHRoaXMuc2hpZnRhYmxlKCkgPT09IGZhbHNlICYmCiAgICAgICF0aGlzLmNvcmUuY29yZS51cGdyYWRpbmcgJiYKICAgICAgdGhpcy5jb3JlLm9wZW5lZAogICAgKQogIH0KCiAgY29tcGFyZSh3cml0ZXIpIHsKICAgIHJldHVybiBiNGEuY29tcGFyZSh0aGlzLmNvcmUua2V5LCB3cml0ZXIuY29yZS5rZXkpCiAgfQoKICBoZWFkKCkgewogICAgcmV0dXJuIHRoaXMubm9kZXMuZ2V0KHRoaXMubGVuZ3RoIC0gMSkKICB9CgogIGFkdmFuY2UoKSB7CiAgICBpZiAodGhpcy5zeW5jU2lnbmFsICE9PSBudWxsICYmIHRoaXMubGVuZ3RoICsgMSA9PT0gdGhpcy5jb3JlLmxlbmd0aCkgdGhpcy5zeW5jU2lnbmFsLm5vdGlmeSgpCiAgICByZXR1cm4gdGhpcy5sZW5ndGggPCB0aGlzLmF2YWlsYWJsZSA/IHRoaXMubm9kZXMuZ2V0KHRoaXMubGVuZ3RoKyspIDogbnVsbAogIH0KCiAgc2hpZnRhYmxlKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID4gdGhpcy5ub2Rlcy5vZmZzZXQKICB9CgogIHNoaWZ0KCkgewogICAgaWYgKHRoaXMuc2hpZnRhYmxlKCkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKCiAgICBsZXQgbm9kZSA9IHRoaXMuX3NoaWZ0QW5kQ2xlYXIoKQogICAgd2hpbGUgKG5vZGUuYmF0Y2ggPiAxKSBub2RlID0gdGhpcy5fc2hpZnRBbmRDbGVhcigpCgogICAgcmV0dXJuIHRydWUKICB9CgogIGdldChzZXEpIHsKICAgIHJldHVybiBzZXEgPCB0aGlzLmxlbmd0aCA/IHRoaXMubm9kZXMuZ2V0KHNlcSkgOiBudWxsCiAgfQoKICBhcHBlbmQodmFsdWUsIGhlYWRzLCBiYXRjaCwgZGVwZW5kZW5jaWVzLCBvcHRpbWlzdGljKSB7CiAgICBjb25zdCBub2RlID0gTGluZWFyaXplci5jcmVhdGVOb2RlKAogICAgICB0aGlzLAogICAgICB0aGlzLm5vZGVzLmxlbmd0aCArIDEsCiAgICAgIHZhbHVlLAogICAgICBoZWFkcywKICAgICAgYmF0Y2gsCiAgICAgIGRlcGVuZGVuY2llcywKICAgICAgb3B0aW1pc3RpYwogICAgKQoKICAgIG5vZGUuYWN0dWFsSGVhZHMgPSBub2RlLmhlYWRzLnNsaWNlKDApCgogICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpCiAgICB0aGlzLmF2YWlsYWJsZSsrCiAgICB0aGlzLmxlbmd0aCsrCgogICAgcmV0dXJuIG5vZGUKICB9CgogIGFzeW5jIHVwZGF0ZShib290KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLmZyb3plbikgcmV0dXJuIGZhbHNlCgogICAgLy8gaWYgdGhpcyBpcyBhIGJvb3Qgbm9kZSwgRE8gTk9ULCBwcmVsb2FkIGFzIHRoYXQgd2lsbCBtYWtlIGl0IGxvYWQKICAgIC8vIGFuZCByZWplY3Qgbm9kZXMgYmFzZWQgb24gdGhlIHRtcCBzdGF0ZSBvZiB0aGUgc3lzdGVtLgogICAgLy8gcHJvcCBuZWVkcyBhIGJldHRlciBzb2x1dGlvbiBidXQgdGhpcyB3b3JrcyBmb3Igbm93CiAgICBjb25zdCBwcmVsb2FkID0gYm9vdCA/IDEgOiBNQVhfUFJFTE9BRAoKICAgIHdoaWxlICh0aGlzLmF2YWlsYWJsZSAtIHRoaXMubGVuZ3RoIDwgcHJlbG9hZCkgewogICAgICAvLyBxdWljayBzYW5pdHkgY2hlY2sKICAgICAgaWYgKHRoaXMubm9kZXMubGVuZ3RoID09PSB0aGlzLmNvcmUubGVuZ3RoIHx8IHRoaXMuY29yZS5sZW5ndGggPT09IDApIGJyZWFrCgogICAgICAvLyBsb2FkIG5leHQgbm9kZQogICAgICBpZiAodGhpcy5ub2RlID09PSBudWxsICYmICEoYXdhaXQgdGhpcy5fbG9hZE5leHROb2RlKCkpKSBicmVhawogICAgICBpZiAoIShhd2FpdCB0aGlzLl9lbnN1cmVOb2RlRGVwZW5kZW5jaWVzKGJvb3QpKSkgYnJlYWsKCiAgICAgIGlmICh0aGlzLnJlY292ZXIpIHRoaXMubm9kZS52YWx1ZSA9IG51bGwKCiAgICAgIHRoaXMubm9kZXMucHVzaCh0aGlzLm5vZGUpCiAgICAgIGlmICh0aGlzLm5vZGUuYmF0Y2ggPT09IDEpIHRoaXMuYXZhaWxhYmxlID0gdGhpcy5ub2Rlcy5sZW5ndGgKICAgICAgdGhpcy5ub2RlID0gbnVsbAogICAgfQoKICAgIHRoaXMudXBkYXRlQWN0aXZpdHkoKQoKICAgIHJldHVybiB0aGlzLmxlbmd0aCA8IHRoaXMuYXZhaWxhYmxlCiAgfQoKICBfc2hpZnRBbmRDbGVhcigpIHsKICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzLnNoaWZ0KCkKICAgIG5vZGUuY2xlYXIoKQogICAgcmV0dXJuIG5vZGUKICB9CgogIGFzeW5jIF9sb2FkTmV4dE5vZGUoKSB7CiAgICBjb25zdCBzZXEgPSB0aGlzLm5vZGVzLmxlbmd0aAoKICAgIGlmICghKGF3YWl0IHRoaXMuY29yZS5oYXMoc2VxKSkpIHJldHVybiBmYWxzZQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgbm9kZSwgb3B0aW1pc3RpYywgdHJhY2UgfSA9IGF3YWl0IHRoaXMuY29yZS5nZXQoc2VxLCB7IHdhaXQ6IGZhbHNlIH0pCgogICAgICBjb25zdCB2YWx1ZSA9IG5vZGUudmFsdWUgPT0gbnVsbCA/IG51bGwgOiBjLmRlY29kZSh0aGlzLmJhc2UudmFsdWVFbmNvZGluZywgbm9kZS52YWx1ZSkKICAgICAgdGhpcy5ub2RlID0gTGluZWFyaXplci5jcmVhdGVOb2RlKAogICAgICAgIHRoaXMsCiAgICAgICAgc2VxICsgMSwKICAgICAgICB2YWx1ZSwKICAgICAgICBub2RlLmhlYWRzLAogICAgICAgIG5vZGUuYmF0Y2gsCiAgICAgICAgbmV3IFNldCgpLAogICAgICAgIG9wdGltaXN0aWMsCiAgICAgICAgdHJhY2UKICAgICAgKQogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuZnJvemVuID0gdHJ1ZQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIF9lbnN1cmVOb2RlRGVwZW5kZW5jaWVzKGJvb3QpIHsKICAgIHdoaWxlICh0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLnNpemUgPCB0aGlzLm5vZGUuaGVhZHMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHJhd0hlYWQgPSB0aGlzLm5vZGUuaGVhZHNbdGhpcy5ub2RlLmRlcGVuZGVuY2llcy5zaXplXQoKICAgICAgY29uc3QgaGVhZFdyaXRlciA9IGF3YWl0IHRoaXMuYmFzZS5fZ2V0V3JpdGVyQnlLZXkoCiAgICAgICAgcmF3SGVhZC5rZXksCiAgICAgICAgLTEsCiAgICAgICAgcmF3SGVhZC5sZW5ndGgsCiAgICAgICAgdHJ1ZSwKICAgICAgICBmYWxzZSwKICAgICAgICBib290CiAgICAgICkKCiAgICAgIGlmIChoZWFkV3JpdGVyICE9PSB0aGlzICYmIChoZWFkV3JpdGVyID09PSBudWxsIHx8IGhlYWRXcml0ZXIubGVuZ3RoIDwgcmF3SGVhZC5sZW5ndGgpKSB7CiAgICAgICAgaWYgKCFib290KSB0aGlzLmJhc2UuX2Vuc3VyZVdha2V1cChoZWFkV3JpdGVyKQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CgogICAgICBsZXQgaGVhZE5vZGUgPSBoZWFkV3JpdGVyLm5vZGVzLmdldChyYXdIZWFkLmxlbmd0aCAtIDEpCgogICAgICAvLyBjb3VsZCBiZSBhIHN0dWIgbm9kZQogICAgICBpZiAoIWhlYWROb2RlKSB7CiAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuYmFzZS5saW5lYXJpemVyLmhlYWRzKSB7CiAgICAgICAgICBpZiAoIWNvbXBhcmVIZWFkKG5vZGUsIHJhd0hlYWQpKSBjb250aW51ZQogICAgICAgICAgaGVhZE5vZGUgPSBub2RlCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gVE9ETzogZ2VuZXJhbGlzZSBEQUcgdmFsaWRhdGlvbiBhbmQgZnJlZXplIHRoZSB3cml0ZXIKICAgICAgYXNzZXJ0KCF0aGlzLm5vZGUuZGVwZW5kZW5jaWVzLmhhcyhoZWFkTm9kZSksICdDb3JydXB0ZWQgREFHJykKCiAgICAgIC8vIFRPRE86IGJldHRlciB3YXkgdG8gc29sdmUgdGhlIHN0dWIgY2hlY2sgaXMgdG8gbmV2ZXIgbXV0YXRlIGhlYWRzIGJlbG93CiAgICAgIGlmIChoZWFkTm9kZSA9PT0gbnVsbCkgewogICAgICAgIC8vIGFscmVhZHkgeWllbGRlZAogICAgICAgIHRoaXMubm9kZS5oZWFkcy5zcGxpY2UodGhpcy5ub2RlLmRlcGVuZGVuY2llcy5zaXplLCAxKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHRoaXMubm9kZS5kZXBlbmRlbmNpZXMuYWRkKGhlYWROb2RlKQogICAgfQoKICAgIC8vIGFsd2F5cyBsaW5rIHByZXZpb3VzIG5vZGUgaWYgaXQncyBub3QgaW5kZXhlZAogICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5ub2RlLmxlbmd0aCAtIDEKICAgIGlmIChvZmZzZXQgPiB0aGlzLmluZGV4ZWQpIHsKICAgICAgdGhpcy5ub2RlLmRlcGVuZGVuY2llcy5hZGQodGhpcy5ub2Rlcy5nZXQob2Zmc2V0IC0gMSkpCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9Cn0KCmZ1bmN0aW9uIGNvbXBhcmVIZWFkKG5vZGUsIGhlYWQpIHsKICBpZiAobm9kZS5sZW5ndGggIT09IGhlYWQubGVuZ3RoKSByZXR1cm4gZmFsc2UKICByZXR1cm4gYjRhLmVxdWFscyhub2RlLndyaXRlci5jb3JlLmtleSwgaGVhZC5rZXkpCn0KCi8vIHRoaXMgaXMgYSBsaXN0IG9mIHBlZXJzIHdlIGJ1Z2dlZCBpbiB0aGUgYnRjIGFuZCBwbGFuYiByb29tLgovLyBhZGRpbmcgdGhlbSBoZXJlIHNvIG1pZ3JhdGlvbiBjYW4gcnVuLCBjYW4gYmUgcmVtb3ZlZCBpbiBhIG1vbnRoIG9yIHNvIGZyb20gdGltZSBvZiBjb21taXQKLy8gbm90ZSwgbm8gc2VjdXJpdHkgaW1wbGljYXRpb25zIG9mIHRoaXMsIHdlIGp1c3QgbnVsbCB0aGVtIG91dC4KCmZ1bmN0aW9uIGF1dG9SZWNvdmVyKGNvcmUpIHsKICBhc3NlcnQoY29yZS5vcGVuZWQpCgogIHN3aXRjaCAoY29yZS5pZCkgewogICAgY2FzZSAnZ2hycGV4YWJvdXRkbTQ2b21icWhvN21yb3hrbmFzc25udHJ4eDNjdWJmdXg0cWk2dzZoeSc6CiAgICBjYXNlICdxb2FhbmFvNzFzNGhlMXJjZDE5N2QzMzZxZXB5a2s0NDY3Z2VvMXVxOGN3bnptcGI3ODZvJzoKICAgIGNhc2UgJ2ZvbWhkeGduNGo0dHpqcXk2eTdpc2toZmZpbXpva3Q3a3JhZGR5ZDhvcmNodDNyOHE2MW8nOgogICAgY2FzZSAnZDhmNXRheHhyaXQ1MWFwZnRvaTM4ZTViODZoYjk4Y2dmZDdkZnAzdW8xdW9oOTVxdDQ5byc6CiAgICBjYXNlICdvYmp5Zjc1dWdnc3FwamN1dDY5eGRnajQ2a3M4cjcxampycTdveGRmc3o5NXNzdGNoa25vJzoKICAgICAgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CnsKICAibmFtZSI6ICJhdXRvYmFzZSIsCiAgInZlcnNpb24iOiAiNy4yNC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBtdWx0aXdyaXRlciBkYXRhIHN0cnVjdHVyZSBmb3IgSHlwZXJjb3JlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC4gLS13cml0ZSIsCiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYnJpdHRsZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDplbmNyeXB0ZWQiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJyaXR0bGUgdGVzdC9hbGwuanMgLS1lbmNyeXB0LWFsbCIsCiAgICAidGVzdDpmaXh0dXJlcyI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYnJpdHRsZSB0ZXN0L2ZpeHR1cmVzL3Rlc3RzLyouanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJmdXp6OmdlbmVyYXRlZCI6ICJicml0dGxlIHRlc3QvcmVmZXJlbmNlL2Z1enovZ2VuZXJhdGVkLyouanMiLAogICAgImZ1eno6bWFpbiI6ICJub2RlIHRlc3QvZnV6ei9pbmRleC5qcyIsCiAgICAiZnV6eiI6ICJub2RlIHRlc3QvcmVmZXJlbmNlL2Z1enovZnV6ei5qcyIsCiAgICAiZ2VuZXJhdGUtZml4dHVyZXMiOiAibm9kZSB0ZXN0L2ZpeHR1cmVzL2dlbmVyYXRlL2FsbC5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoqIiwKICAgICJlbmNvZGluZy8qKiIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYXV0b2Jhc2UuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYXV0b2Jhc2UvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9hdXRvYmFzZSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMSIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE2LjAiLAogICAgImNvcmUtY291cGxlciI6ICJeMi4wLjAiLAogICAgImRlYm91bmNlaWZ5IjogIl4xLjAuMCIsCiAgICAiaHlwZXJiZWUiOiAiXjIuMjIuMCIsCiAgICAiaHlwZXJjb3JlIjogIl4xMS40LjAiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNC4wIiwKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMi4wIiwKICAgICJoeXBlcnNjaGVtYSI6ICJeMS4xMi4xIiwKICAgICJpbmRleC1lbmNvZGVyIjogIl4zLjMuMiIsCiAgICAibmFub2Fzc2VydCI6ICJeMi4wLjAiLAogICAgInByb3RvbXV4LXdha2V1cCI6ICJeMi4wLjAiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjAuMCIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4xLjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjIiLAogICAgInNjb3BlLWxvY2siOiAiXjEuMi40IiwKICAgICJzaWduYWwtcHJvbWlzZSI6ICJeMS4wLjMiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4xIiwKICAgICJzdWItZW5jb2RlciI6ICJeMi4xLjEiLAogICAgInRpbnktYnVmZmVyLW1hcCI6ICJeMS4xLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImF1dG9iYXNlLXRlc3QtaGVscGVycyI6ICJeMy4wLjAiLAogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJjb3Jlc3RvcmUiOiAiXjcuMC4xNSIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAicmFjaGUiOiAiXjEuMC4wIiwKICAgICJzYW1lLWRhdGEiOiAiXjEuMC4wIiwKICAgICJ0YXNrLWJhY2tvZmYiOiAiXjEuMC4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4yLjAiLAogICAgInVuY2F1Z2h0cyI6ICJeMS4xLjAiCiAgfSwKICAic3RhbmRhcmQiOiB7CiAgICAiaWdub3JlIjogWwogICAgICAiKiovdGVzdC9mdXp6L2dlbmVyYXRlZC8qKiIsCiAgICAgICIqKi90ZXN0L3JlZmVyZW5jZS8qKiIsCiAgICAgICJleGFtcGxlLm1qcyIKICAgIF0KICB9Cn0KZnVuY3Rpb24gaXNCdWZmZXIodmFsdWUpIHsKICByZXR1cm4gQnVmZmVyLmlzQnVmZmVyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkKfQoKZnVuY3Rpb24gaXNFbmNvZGluZyhlbmNvZGluZykgewogIHJldHVybiBCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykKfQoKZnVuY3Rpb24gYWxsb2Moc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICByZXR1cm4gQnVmZmVyLmFsbG9jKHNpemUsIGZpbGwsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBhbGxvY1Vuc2FmZShzaXplKSB7CiAgcmV0dXJuIEJ1ZmZlci5hbGxvY1Vuc2FmZShzaXplKQp9CgpmdW5jdGlvbiBhbGxvY1Vuc2FmZVNsb3coc2l6ZSkgewogIHJldHVybiBCdWZmZXIuYWxsb2NVbnNhZmVTbG93KHNpemUpCn0KCmZ1bmN0aW9uIGJ5dGVMZW5ndGgoc3RyaW5nLCBlbmNvZGluZykgewogIHJldHVybiBCdWZmZXIuYnl0ZUxlbmd0aChzdHJpbmcsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICByZXR1cm4gQnVmZmVyLmNvbXBhcmUoYSwgYikKfQoKZnVuY3Rpb24gY29uY2F0KGJ1ZmZlcnMsIHRvdGFsTGVuZ3RoKSB7CiAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoYnVmZmVycywgdG90YWxMZW5ndGgpCn0KCmZ1bmN0aW9uIGNvcHkoc291cmNlLCB0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKSB7CiAgcmV0dXJuIHRvQnVmZmVyKHNvdXJjZSkuY29weSh0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKQp9CgpmdW5jdGlvbiBlcXVhbHMoYSwgYikgewogIHJldHVybiB0b0J1ZmZlcihhKS5lcXVhbHMoYikKfQoKZnVuY3Rpb24gZmlsbChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGVuZCwgZW5jb2RpbmcpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5maWxsKHZhbHVlLCBvZmZzZXQsIGVuZCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGZyb20odmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBCdWZmZXIuZnJvbSh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQp9CgpmdW5jdGlvbiBpbmNsdWRlcyhidWZmZXIsIHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLmluY2x1ZGVzKHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykKfQoKZnVuY3Rpb24gaW5kZXhPZihidWZmZXIsIHZhbHVlLCBieWZlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLmluZGV4T2YodmFsdWUsIGJ5ZmVPZmZzZXQsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBsYXN0SW5kZXhPZihidWZmZXIsIHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLmxhc3RJbmRleE9mKHZhbHVlLCBieXRlT2Zmc2V0LCBlbmNvZGluZykKfQoKZnVuY3Rpb24gc3dhcDE2KGJ1ZmZlcikgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnN3YXAxNigpCn0KCmZ1bmN0aW9uIHN3YXAzMihidWZmZXIpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5zd2FwMzIoKQp9CgpmdW5jdGlvbiBzd2FwNjQoYnVmZmVyKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikuc3dhcDY0KCkKfQoKZnVuY3Rpb24gdG9CdWZmZXIoYnVmZmVyKSB7CiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihidWZmZXIpKSByZXR1cm4gYnVmZmVyCiAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCkKfQoKZnVuY3Rpb24gdG9TdHJpbmcoYnVmZmVyLCBlbmNvZGluZywgc3RhcnQsIGVuZCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnRvU3RyaW5nKGVuY29kaW5nLCBzdGFydCwgZW5kKQp9CgpmdW5jdGlvbiB3cml0ZShidWZmZXIsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGUoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIHJlYWREb3VibGVCRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWREb3VibGVCRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWREb3VibGVMRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWREb3VibGVMRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRGbG9hdEJFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZEZsb2F0QkUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkRmxvYXRMRShidWZmZXIsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLnJlYWRGbG9hdExFKG9mZnNldCkKfQoKZnVuY3Rpb24gcmVhZEludDMyQkUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkSW50MzJCRShvZmZzZXQpCn0KCmZ1bmN0aW9uIHJlYWRJbnQzMkxFKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikucmVhZEludDMyTEUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkVUludDMyQkUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkVUludDMyQkUob2Zmc2V0KQp9CgpmdW5jdGlvbiByZWFkVUludDMyTEUoYnVmZmVyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS5yZWFkVUludDMyTEUob2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZURvdWJsZUJFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlRG91YmxlQkUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVEb3VibGVMRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZURvdWJsZUxFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlRmxvYXRCRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZUZsb2F0QkUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVGbG9hdExFKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgewogIHJldHVybiB0b0J1ZmZlcihidWZmZXIpLndyaXRlRmxvYXRMRSh2YWx1ZSwgb2Zmc2V0KQp9CgpmdW5jdGlvbiB3cml0ZUludDMyQkUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVJbnQzMkJFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlSW50MzJMRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZUludDMyTEUodmFsdWUsIG9mZnNldCkKfQoKZnVuY3Rpb24gd3JpdGVVSW50MzJCRShidWZmZXIsIHZhbHVlLCBvZmZzZXQpIHsKICByZXR1cm4gdG9CdWZmZXIoYnVmZmVyKS53cml0ZVVJbnQzMkJFKHZhbHVlLCBvZmZzZXQpCn0KCmZ1bmN0aW9uIHdyaXRlVUludDMyTEUoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7CiAgcmV0dXJuIHRvQnVmZmVyKGJ1ZmZlcikud3JpdGVVSW50MzJMRSh2YWx1ZSwgb2Zmc2V0KQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBpc0J1ZmZlciwKICBpc0VuY29kaW5nLAogIGFsbG9jLAogIGFsbG9jVW5zYWZlLAogIGFsbG9jVW5zYWZlU2xvdywKICBieXRlTGVuZ3RoLAogIGNvbXBhcmUsCiAgY29uY2F0LAogIGNvcHksCiAgZXF1YWxzLAogIGZpbGwsCiAgZnJvbSwKICBpbmNsdWRlcywKICBpbmRleE9mLAogIGxhc3RJbmRleE9mLAogIHN3YXAxNiwKICBzd2FwMzIsCiAgc3dhcDY0LAogIHRvQnVmZmVyLAogIHRvU3RyaW5nLAogIHdyaXRlLAogIHJlYWREb3VibGVCRSwKICByZWFkRG91YmxlTEUsCiAgcmVhZEZsb2F0QkUsCiAgcmVhZEZsb2F0TEUsCiAgcmVhZEludDMyQkUsCiAgcmVhZEludDMyTEUsCiAgcmVhZFVJbnQzMkJFLAogIHJlYWRVSW50MzJMRSwKICB3cml0ZURvdWJsZUJFLAogIHdyaXRlRG91YmxlTEUsCiAgd3JpdGVGbG9hdEJFLAogIHdyaXRlRmxvYXRMRSwKICB3cml0ZUludDMyQkUsCiAgd3JpdGVJbnQzMkxFLAogIHdyaXRlVUludDMyQkUsCiAgd3JpdGVVSW50MzJMRQp9CnsKICAibmFtZSI6ICJiNGEiLAogICJ2ZXJzaW9uIjogIjEuNy4zIiwKICAiZGVzY3JpcHRpb24iOiAiQnJpZGdpbmcgdGhlIGdhcCBiZXR3ZWVuIGJ1ZmZlcnMgYW5kIHR5cGVkIGFycmF5cyIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAicmVhY3QtbmF0aXZlIjogIi4vcmVhY3QtbmF0aXZlLmpzIiwKICAgICAgImJyb3dzZXIiOiAiLi9icm93c2VyLmpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJicm93c2VyLmpzIiwKICAgICJpbmRleC5qcyIsCiAgICAicmVhY3QtbmF0aXZlLmpzIiwKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5tanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QubWpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC4gLS1jaGVjayIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iNGEuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYjRhL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYjRhI3JlYWRtZSIsCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjUuMiIsCiAgICAibmFub2JlbmNoIjogIl4zLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgInJlYWN0LW5hdGl2ZS1iNGEiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJyZWFjdC1uYXRpdmUtYjRhIjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbigpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCmNvbnN0IEhhc2ggPSByZXF1aXJlKCcuL2xpYi9oYXNoJykKY29uc3QgSG1hYyA9IHJlcXVpcmUoJy4vbGliL2htYWMnKQpjb25zdCB7IENpcGhlcml2LCBEZWNpcGhlcml2IH0gPSByZXF1aXJlKCcuL2xpYi9jaXBoZXInKQpjb25zdCB7IHJhbmRvbUJ5dGVzLCByYW5kb21GaWxsLCByYW5kb21VVUlEIH0gPSByZXF1aXJlKCcuL2xpYi9yYW5kb20nKQpjb25zdCBwYmtkZjIgPSByZXF1aXJlKCcuL2xpYi9wYmtkZjInKQpjb25zdCB7IGdlbmVyYXRlS2V5UGFpciB9ID0gcmVxdWlyZSgnLi9saWIva2V5JykKY29uc3QgeyBzaWduLCB2ZXJpZnkgfSA9IHJlcXVpcmUoJy4vbGliL3NpZ25hdHVyZScpCgpleHBvcnRzLmNvbnN0YW50cyA9IGNvbnN0YW50cwoKZXhwb3J0cy5IYXNoID0gSGFzaAoKZXhwb3J0cy5jcmVhdGVIYXNoID0gZnVuY3Rpb24gY3JlYXRlSGFzaChhbGdvcml0aG0sIG9wdHMpIHsKICByZXR1cm4gbmV3IEhhc2goYWxnb3JpdGhtLCBvcHRzKQp9CgpleHBvcnRzLkhtYWMgPSBIbWFjCgpleHBvcnRzLmNyZWF0ZUhtYWMgPSBmdW5jdGlvbiBjcmVhdGVIbWFjKGFsZ29yaXRobSwga2V5LCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBIbWFjKGFsZ29yaXRobSwga2V5LCBvcHRzKQp9CgpleHBvcnRzLkNpcGhlcml2ID0gQ2lwaGVyaXYKCmV4cG9ydHMuY3JlYXRlQ2lwaGVyaXYgPSBmdW5jdGlvbiBjcmVhdGVDaXBoZXJpdihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpIHsKICByZXR1cm4gbmV3IENpcGhlcml2KGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykKfQoKZXhwb3J0cy5EZWNpcGhlcml2ID0gRGVjaXBoZXJpdgoKZXhwb3J0cy5jcmVhdGVEZWNpcGhlcml2ID0gZnVuY3Rpb24gY3JlYXRlRGVjaXBoZXJpdihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpIHsKICByZXR1cm4gbmV3IERlY2lwaGVyaXYoYWxnb3JpdGhtLCBrZXksIGl2LCBvcHRzKQp9CgpleHBvcnRzLnJhbmRvbUJ5dGVzID0gcmFuZG9tQnl0ZXMKCmV4cG9ydHMucmFuZG9tRmlsbCA9IHJhbmRvbUZpbGwKCi8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKZXhwb3J0cy5yYW5kb21GaWxsU3luYyA9IGZ1bmN0aW9uIHJhbmRvbUZpbGxTeW5jKGJ1ZmZlciwgb2Zmc2V0LCBzaXplKSB7CiAgcmV0dXJuIGV4cG9ydHMucmFuZG9tRmlsbChidWZmZXIsIG9mZnNldCwgc2l6ZSkKfQoKZXhwb3J0cy5yYW5kb21VVUlEID0gcmFuZG9tVVVJRAoKZXhwb3J0cy5wYmtkZjIgPSBwYmtkZjIKCi8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKZXhwb3J0cy5wYmtkZjJTeW5jID0gZnVuY3Rpb24gcGJrZGYyU3luYyhwYXNzd29yZCwgc2FsdCwgaXRlcmF0aW9ucywga2V5bGVuLCBkaWdlc3QpIHsKICByZXR1cm4gZXhwb3J0cy5wYmtkZjIocGFzc3dvcmQsIHNhbHQsIGl0ZXJhdGlvbnMsIGtleWxlbiwgZGlnZXN0KQp9CgpleHBvcnRzLmdlbmVyYXRlS2V5UGFpciA9IGdlbmVyYXRlS2V5UGFpcgoKZXhwb3J0cy5zaWduID0gc2lnbgoKZXhwb3J0cy52ZXJpZnkgPSB2ZXJpZnkKCi8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKZXhwb3J0cy53ZWJjcnlwdG8gPSByZXF1aXJlKCcuL3dlYicpCmNvbnN0IHsgVHJhbnNmb3JtIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgewogIGNpcGhlcjogewogICAgQUVTMTI4RUNCLAogICAgQUVTMTI4Q0JDLAogICAgQUVTMTI4Q1RSLAogICAgQUVTMTI4T0ZCLAogICAgQUVTMjU2RUNCLAogICAgQUVTMjU2Q0JDLAogICAgQUVTMjU2Q1RSLAogICAgQUVTMjU2T0ZCLAogICAgQUVTMTI4R0NNLAogICAgQUVTMjU2R0NNLAogICAgQ0hBQ0hBMjBQT0xZMTMwNSwKICAgIFhDSEFDSEEyMFBPTFkxMzA1CiAgfQp9ID0gY29uc3RhbnRzCgpjbGFzcyBDcnlwdG9DaXBoZXIgewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwga2V5LCBpdiwgZW5jcnlwdCwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSBrZXkgPSBCdWZmZXIuZnJvbShrZXksIGVuY29kaW5nKQogICAgaWYgKHR5cGVvZiBpdiA9PT0gJ3N0cmluZycpIGl2ID0gQnVmZmVyLmZyb20oaXYsIGVuY29kaW5nKQoKICAgIGlmIChrZXkuYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jaXBoZXJLZXlMZW5ndGgoYWxnb3JpdGhtKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCBrZXkgbGVuZ3RoJykKICAgIH0KCiAgICBpZiAoaXYuYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY2lwaGVySVZMZW5ndGgoYWxnb3JpdGhtKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCBpdiBsZW5ndGgnKQogICAgfQoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuY2lwaGVySW5pdCgKICAgICAgYWxnb3JpdGhtLAogICAgICBrZXkuYnVmZmVyLAogICAgICBrZXkuYnl0ZU9mZnNldCwKICAgICAga2V5LmJ5dGVMZW5ndGgsCiAgICAgIGl2LmJ1ZmZlciwKICAgICAgaXYuYnl0ZU9mZnNldCwKICAgICAgaXYuYnl0ZUxlbmd0aCwKICAgICAgZW5jcnlwdAogICAgKQogIH0KCiAgdXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcgPSAndXRmOCcsIG91dHB1dEVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgaW5wdXRFbmNvZGluZykKCiAgICBjb25zdCBvdXQgPSBuZXcgQXJyYXlCdWZmZXIoYmluZGluZy5jaXBoZXJCbG9ja1NpemUodGhpcy5faGFuZGxlKSkKCiAgICBjb25zdCB3cml0dGVuID0gYmluZGluZy5jaXBoZXJVcGRhdGUoCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgZGF0YS5idWZmZXIsCiAgICAgIGRhdGEuYnl0ZU9mZnNldCwKICAgICAgZGF0YS5ieXRlTGVuZ3RoLAogICAgICBvdXQKICAgICkKCiAgICBjb25zdCByZXN1bHQgPSBCdWZmZXIuZnJvbShvdXQsIDAsIHdyaXR0ZW4pCgogICAgcmV0dXJuIG91dHB1dEVuY29kaW5nID8gcmVzdWx0LnRvU3RyaW5nKG91dHB1dEVuY29kaW5nKSA6IHJlc3VsdAogIH0KCiAgZmluYWwob3V0cHV0RW5jb2RpbmcpIHsKICAgIGNvbnN0IG91dCA9IG5ldyBBcnJheUJ1ZmZlcihiaW5kaW5nLmNpcGhlckJsb2NrU2l6ZSh0aGlzLl9oYW5kbGUpKQoKICAgIGNvbnN0IHdyaXR0ZW4gPSBiaW5kaW5nLmNpcGhlckZpbmFsKHRoaXMuX2hhbmRsZSwgb3V0KQoKICAgIGNvbnN0IHJlc3VsdCA9IEJ1ZmZlci5mcm9tKG91dCwgMCwgd3JpdHRlbikKCiAgICByZXR1cm4gb3V0cHV0RW5jb2RpbmcgPyByZXN1bHQudG9TdHJpbmcob3V0cHV0RW5jb2RpbmcpIDogcmVzdWx0CiAgfQoKICBzZXRBdXRvUGFkZGluZyhwYWQpIHsKICAgIGJpbmRpbmcuY2lwaGVyU2V0UGFkZGluZyhwYWQpCiAgfQp9CgpjbGFzcyBDcnlwdG9BdXRoZW50aWNhdGVkQ2lwaGVyIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgbm9uY2UsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JywgYXV0aFRhZ0xlbmd0aCA9IDE2IH0gPSBvcHRzCgogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSBrZXkgPSBCdWZmZXIuZnJvbShrZXksIGVuY29kaW5nKQogICAgaWYgKHR5cGVvZiBub25jZSA9PT0gJ3N0cmluZycpIG5vbmNlID0gQnVmZmVyLmZyb20obm9uY2UsIGVuY29kaW5nKQoKICAgIGlmIChrZXkuYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5hZWFkS2V5TGVuZ3RoKGFsZ29yaXRobSkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQga2V5IGxlbmd0aCcpCiAgICB9CgogICAgaWYgKG5vbmNlLmJ5dGVMZW5ndGggPCBiaW5kaW5nLmFlYWROb25jZUxlbmd0aChhbGdvcml0aG0pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIG5vbmNlIGxlbmd0aCcpCiAgICB9CgogICAgdGhpcy5fYnVmZmVyID0gW10KICAgIHRoaXMuX25vbmNlID0gbm9uY2UKICAgIHRoaXMuX2F1dGhUYWcgPSBudWxsCiAgICB0aGlzLl9hdXRoVGFnTGVuZ3RoID0gYXV0aFRhZ0xlbmd0aAogICAgdGhpcy5fYWRkaXRpb25hbERhdGEgPSBudWxsCgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5hZWFkSW5pdCgKICAgICAgYWxnb3JpdGhtLAogICAgICBrZXkuYnVmZmVyLAogICAgICBrZXkuYnl0ZU9mZnNldCwKICAgICAga2V5LmJ5dGVMZW5ndGgsCiAgICAgIGF1dGhUYWdMZW5ndGgKICAgICkKICB9CgogIHVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nID0gJ3V0ZjgnLCBvdXRwdXRFbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGlucHV0RW5jb2RpbmcpCgogICAgdGhpcy5fYnVmZmVyLnB1c2goZGF0YSkKCiAgICByZXR1cm4gb3V0cHV0RW5jb2RpbmcgPyAnJyA6IEJ1ZmZlci5hbGxvYygwKQogIH0KCiAgc2V0QUFEKGJ1ZmZlciwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogICAgaWYgKHR5cGVvZiBidWZmZXIgPT09ICdzdHJpbmcnKSBidWZmZXIgPSBCdWZmZXIuZnJvbShidWZmZXIsIGVuY29kaW5nKQoKICAgIHRoaXMuX2FkZGl0aW9uYWxEYXRhID0gYnVmZmVyCiAgfQoKICBnZXRBdXRoVGFnKCkgewogICAgcmV0dXJuIHRoaXMuX2F1dGhUYWcKICB9CgogIHNldEF1dGhUYWcoYXV0aFRhZywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgYXV0aFRhZyA9PT0gJ3N0cmluZycpIGF1dGhUYWcgPSBCdWZmZXIuZnJvbShhdXRoVGFnLCBlbmNvZGluZykKCiAgICB0aGlzLl9hdXRoVGFnID0gYXV0aFRhZwogIH0KfQoKY2xhc3MgQ3J5cHRvQXV0aGVudGljYXRlZFNlYWwgZXh0ZW5kcyBDcnlwdG9BdXRoZW50aWNhdGVkQ2lwaGVyIHsKICBmaW5hbChvdXRwdXRFbmNvZGluZykgewogICAgY29uc3QgZGF0YSA9IHRoaXMuX2J1ZmZlci5sZW5ndGggPT09IDEgPyB0aGlzLl9idWZmZXJbMF0gOiBCdWZmZXIuY29uY2F0KHRoaXMuX2J1ZmZlcikKCiAgICBjb25zdCBub25jZSA9IHRoaXMuX25vbmNlCiAgICBjb25zdCBhZCA9IHRoaXMuX2FkZGl0aW9uYWxEYXRhIHx8IEJ1ZmZlci5hbGxvYygwKQoKICAgIGNvbnN0IG91dCA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhLmJ5dGVMZW5ndGggKyBiaW5kaW5nLmFlYWRNYXhPdmVyaGVhZCh0aGlzLl9oYW5kbGUpKQoKICAgIGJpbmRpbmcuYWVhZFNlYWwoCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgZGF0YS5idWZmZXIsCiAgICAgIGRhdGEuYnl0ZU9mZnNldCwKICAgICAgZGF0YS5ieXRlTGVuZ3RoLAogICAgICBub25jZS5idWZmZXIsCiAgICAgIG5vbmNlLmJ5dGVPZmZzZXQsCiAgICAgIG5vbmNlLmJ5dGVMZW5ndGgsCiAgICAgIGFkLmJ1ZmZlciwKICAgICAgYWQuYnl0ZU9mZnNldCwKICAgICAgYWQuYnl0ZUxlbmd0aCwKICAgICAgb3V0CiAgICApCgogICAgY29uc3Qgd3JpdHRlbiA9IG91dC5ieXRlTGVuZ3RoIC0gdGhpcy5fYXV0aFRhZ0xlbmd0aAoKICAgIHRoaXMuX2F1dGhUYWcgPSBCdWZmZXIuZnJvbShvdXQsIHdyaXR0ZW4pCgogICAgY29uc3QgcmVzdWx0ID0gQnVmZmVyLmZyb20ob3V0LCAwLCB3cml0dGVuKQoKICAgIHJldHVybiBvdXRwdXRFbmNvZGluZyA/IHJlc3VsdC50b1N0cmluZyhvdXRwdXRFbmNvZGluZykgOiByZXN1bHQKICB9Cn0KCmNsYXNzIENyeXB0b0F1dGhlbnRpY2F0ZWRPcGVuIGV4dGVuZHMgQ3J5cHRvQXV0aGVudGljYXRlZENpcGhlciB7CiAgZmluYWwob3V0cHV0RW5jb2RpbmcpIHsKICAgIHRoaXMuX2J1ZmZlci5wdXNoKHRoaXMuX2F1dGhUYWcpCgogICAgY29uc3QgZGF0YSA9IEJ1ZmZlci5jb25jYXQodGhpcy5fYnVmZmVyKQoKICAgIGNvbnN0IG5vbmNlID0gdGhpcy5fbm9uY2UKICAgIGNvbnN0IGFkID0gdGhpcy5fYWRkaXRpb25hbERhdGEgfHwgQnVmZmVyLmFsbG9jKDApCgogICAgY29uc3Qgb3V0ID0gbmV3IEFycmF5QnVmZmVyKGRhdGEuYnl0ZUxlbmd0aCkKCiAgICBiaW5kaW5nLmFlYWRPcGVuKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIGRhdGEuYnVmZmVyLAogICAgICBkYXRhLmJ5dGVPZmZzZXQsCiAgICAgIGRhdGEuYnl0ZUxlbmd0aCwKICAgICAgbm9uY2UuYnVmZmVyLAogICAgICBub25jZS5ieXRlT2Zmc2V0LAogICAgICBub25jZS5ieXRlTGVuZ3RoLAogICAgICBhZC5idWZmZXIsCiAgICAgIGFkLmJ5dGVPZmZzZXQsCiAgICAgIGFkLmJ5dGVMZW5ndGgsCiAgICAgIG91dAogICAgKQoKICAgIGNvbnN0IHdyaXR0ZW4gPSBvdXQuYnl0ZUxlbmd0aCAtIHRoaXMuX2F1dGhUYWdMZW5ndGgKCiAgICBjb25zdCByZXN1bHQgPSBCdWZmZXIuZnJvbShvdXQsIDAsIHdyaXR0ZW4pCgogICAgcmV0dXJuIG91dHB1dEVuY29kaW5nID8gcmVzdWx0LnRvU3RyaW5nKG91dHB1dEVuY29kaW5nKSA6IHJlc3VsdAogIH0KfQoKZXhwb3J0cy5DaXBoZXJpdiA9IGNsYXNzIENyeXB0b0NpcGhlcml2IGV4dGVuZHMgVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMgPSB7fSkgewogICAgc3VwZXIob3B0cykKCiAgICBhbGdvcml0aG0gPSBjb25zdGFudHMudG9DaXBoZXIoYWxnb3JpdGhtKQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtKSB7CiAgICAgIGNhc2UgQUVTMTI4RUNCOgogICAgICBjYXNlIEFFUzEyOENCQzoKICAgICAgY2FzZSBBRVMxMjhDVFI6CiAgICAgIGNhc2UgQUVTMTI4T0ZCOgogICAgICBjYXNlIEFFUzI1NkVDQjoKICAgICAgY2FzZSBBRVMyNTZDQkM6CiAgICAgIGNhc2UgQUVTMjU2Q1RSOgogICAgICBjYXNlIEFFUzI1Nk9GQjoKICAgICAgICB0aGlzLl9jaXBoZXIgPSBuZXcgQ3J5cHRvQ2lwaGVyKGFsZ29yaXRobSwga2V5LCBpdiwgdHJ1ZSwgb3B0cykKICAgICAgICBicmVhawoKICAgICAgY2FzZSBBRVMxMjhHQ006CiAgICAgIGNhc2UgQUVTMjU2R0NNOgogICAgICBjYXNlIENIQUNIQTIwUE9MWTEzMDU6CiAgICAgIGNhc2UgWENIQUNIQTIwUE9MWTEzMDU6CiAgICAgICAgdGhpcy5fY2lwaGVyID0gbmV3IENyeXB0b0F1dGhlbnRpY2F0ZWRTZWFsKGFsZ29yaXRobSwga2V5LCBpdiwgb3B0cykKICAgICAgICBicmVhawogICAgfQogIH0KCiAgdXBkYXRlKGRhdGEsIGlucHV0RW5jb2RpbmcsIG91dHB1dEVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5fY2lwaGVyLnVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nLCBvdXRwdXRFbmNvZGluZykKICB9CgogIGZpbmFsKG91dHB1dEVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5fY2lwaGVyLmZpbmFsKG91dHB1dEVuY29kaW5nKQogIH0KCiAgc2V0QXV0b1BhZGRpbmcocGFkKSB7CiAgICB0aGlzLl9jaXBoZXIuc2V0QXV0b1BhZGRpbmcocGFkKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBzZXRBQUQoYnVmZmVyLCBvcHRzKSB7CiAgICB0aGlzLl9jaXBoZXIuc2V0QUFEKGJ1ZmZlciwgb3B0cykKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZ2V0QXV0aFRhZygpIHsKICAgIHJldHVybiB0aGlzLl9jaXBoZXIuZ2V0QXV0aFRhZygpCiAgfQoKICBfdHJhbnNmb3JtKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy51cGRhdGUoZGF0YSkKCiAgICBjYihudWxsKQogIH0KCiAgX2ZsdXNoKGNiKSB7CiAgICB0aGlzLnB1c2godGhpcy5kaWdlc3QoKSkKCiAgICBjYihudWxsKQogIH0KfQoKZXhwb3J0cy5EZWNpcGhlcml2ID0gY2xhc3MgQ3J5cHRvRGVpcGhlcml2IGV4dGVuZHMgVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMgPSB7fSkgewogICAgc3VwZXIob3B0cykKCiAgICBhbGdvcml0aG0gPSBjb25zdGFudHMudG9DaXBoZXIoYWxnb3JpdGhtKQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtKSB7CiAgICAgIGNhc2UgQUVTMTI4RUNCOgogICAgICBjYXNlIEFFUzEyOENCQzoKICAgICAgY2FzZSBBRVMxMjhDVFI6CiAgICAgIGNhc2UgQUVTMTI4T0ZCOgogICAgICBjYXNlIEFFUzI1NkVDQjoKICAgICAgY2FzZSBBRVMyNTZDQkM6CiAgICAgIGNhc2UgQUVTMjU2Q1RSOgogICAgICBjYXNlIEFFUzI1Nk9GQjoKICAgICAgICB0aGlzLl9jaXBoZXIgPSBuZXcgQ3J5cHRvQ2lwaGVyKGFsZ29yaXRobSwga2V5LCBpdiwgZmFsc2UsIG9wdHMpCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgQUVTMTI4R0NNOgogICAgICBjYXNlIEFFUzI1NkdDTToKICAgICAgY2FzZSBDSEFDSEEyMFBPTFkxMzA1OgogICAgICBjYXNlIFhDSEFDSEEyMFBPTFkxMzA1OgogICAgICAgIHRoaXMuX2NpcGhlciA9IG5ldyBDcnlwdG9BdXRoZW50aWNhdGVkT3BlbihhbGdvcml0aG0sIGtleSwgaXYsIG9wdHMpCiAgICAgICAgYnJlYWsKICAgIH0KICB9CgogIHVwZGF0ZShkYXRhLCBpbnB1dEVuY29kaW5nLCBvdXRwdXRFbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuX2NpcGhlci51cGRhdGUoZGF0YSwgaW5wdXRFbmNvZGluZywgb3V0cHV0RW5jb2RpbmcpCiAgfQoKICBmaW5hbChvdXRwdXRFbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuX2NpcGhlci5maW5hbChvdXRwdXRFbmNvZGluZykKICB9CgogIHNldEF1dG9QYWRkaW5nKHBhZCkgewogICAgdGhpcy5fY2lwaGVyLnNldEF1dG9QYWRkaW5nKHBhZCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgc2V0QUFEKGJ1ZmZlciwgb3B0cykgewogICAgdGhpcy5fY2lwaGVyLnNldEFBRChidWZmZXIsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIHNldEF1dGhUYWcoYXV0aFRhZywgZW5jb2RpbmcpIHsKICAgIHRoaXMuX2NpcGhlci5zZXRBdXRoVGFnKGF1dGhUYWcsIGVuY29kaW5nKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBfdHJhbnNmb3JtKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy51cGRhdGUoZGF0YSkKCiAgICBjYihudWxsKQogIH0KCiAgX2ZsdXNoKGNiKSB7CiAgICB0aGlzLnB1c2godGhpcy5kaWdlc3QoKSkKCiAgICBjYihudWxsKQogIH0KfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICBoYXNoOiB7CiAgICBNRDU6IGJpbmRpbmcuTUQ1LAogICAgU0hBMTogYmluZGluZy5TSEExLAogICAgU0hBMjU2OiBiaW5kaW5nLlNIQTI1NiwKICAgIFNIQTUxMjogYmluZGluZy5TSEE1MTIsCiAgICBCTEFLRTJCMjU2OiBiaW5kaW5nLkJMQUtFMkIyNTYKICB9LAogIHNpZ25hdHVyZTogewogICAgRUQyNTUxOTogYmluZGluZy5FRDI1NTE5CiAgfSwKICBjaXBoZXI6IHsKICAgIEFFUzEyOEVDQjogYmluZGluZy5BRVMxMjhFQ0IsCiAgICBBRVMxMjhDQkM6IGJpbmRpbmcuQUVTMTI4Q0JDLAogICAgQUVTMTI4Q1RSOiBiaW5kaW5nLkFFUzEyOENUUiwKICAgIEFFUzEyOE9GQjogYmluZGluZy5BRVMxMjhPRkIsCiAgICBBRVMyNTZFQ0I6IGJpbmRpbmcuQUVTMjU2RUNCLAogICAgQUVTMjU2Q0JDOiBiaW5kaW5nLkFFUzI1NkNCQywKICAgIEFFUzI1NkNUUjogYmluZGluZy5BRVMyNTZDVFIsCiAgICBBRVMyNTZPRkI6IGJpbmRpbmcuQUVTMjU2T0ZCLAogICAgQUVTMTI4R0NNOiBiaW5kaW5nLkFFUzEyOEdDTSwKICAgIEFFUzI1NkdDTTogYmluZGluZy5BRVMyNTZHQ00sCiAgICBDSEFDSEEyMFBPTFkxMzA1OiBiaW5kaW5nLkNIQUNIQTIwUE9MWTEzMDUsCiAgICBYQ0hBQ0hBMjBQT0xZMTMwNTogYmluZGluZy5YQ0hBQ0hBMjBQT0xZMTMwNQogIH0sCiAga2V5VHlwZTogewogICAgRUQyNTUxOTogYmluZGluZy5FRDI1NTE5CiAgfQp9CgpleHBvcnRzLnRvSGFzaCA9IGZ1bmN0aW9uIHRvSGFzaChoYXNoKSB7CiAgaWYgKHR5cGVvZiBoYXNoID09PSAnbnVtYmVyJykgcmV0dXJuIGhhc2gKCiAgaWYgKHR5cGVvZiBoYXNoID09PSAnc3RyaW5nJykgewogICAgaGFzaCA9IGhhc2gucmVwbGFjZSgvLS9nLCAnJykKCiAgICBpZiAoaGFzaCBpbiBleHBvcnRzLmhhc2ggPT09IGZhbHNlKSB7CiAgICAgIGhhc2ggPSBoYXNoLnRvVXBwZXJDYXNlKCkKCiAgICAgIGlmIChoYXNoIGluIGV4cG9ydHMuaGFzaCA9PT0gZmFsc2UpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuVU5LTk9XTl9IQVNIKGBVbmtub3duIGhhc2ggJyR7aGFzaH0nYCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBleHBvcnRzLmhhc2hbaGFzaF0KICB9CgogIHRocm93IG5ldyBUeXBlRXJyb3IoYEhhc2ggbXVzdCBiZSBhIG51bWJlciBvciBzdHJpbmcuIFJlY2VpdmVkICR7dHlwZW9mIGhhc2h9ICgke2hhc2h9KWApCn0KCmV4cG9ydHMudG9DaXBoZXIgPSBmdW5jdGlvbiB0b0NpcGVyKGNpcGhlcikgewogIGlmICh0eXBlb2YgY2lwaGVyID09PSAnbnVtYmVyJykgcmV0dXJuIGNpcGhlcgoKICBpZiAodHlwZW9mIGNpcGhlciA9PT0gJ3N0cmluZycpIHsKICAgIGNpcGhlciA9IGNpcGhlci5yZXBsYWNlKC8tL2csICcnKQoKICAgIGlmIChjaXBoZXIgaW4gZXhwb3J0cy5jaXBoZXIgPT09IGZhbHNlKSB7CiAgICAgIGNpcGhlciA9IGNpcGhlci50b1VwcGVyQ2FzZSgpCgogICAgICBpZiAoY2lwaGVyIGluIGV4cG9ydHMuY2lwaGVyID09PSBmYWxzZSkgewogICAgICAgIHRocm93IGVycm9ycy5VTktOT1dOX0NJUEhFUihgVW5rbm93biBjaXBoZXIgJyR7Y2lwaGVyfSdgKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGV4cG9ydHMuY2lwaGVyW2NpcGhlcl0KICB9CgogIHRocm93IG5ldyBUeXBlRXJyb3IoYENpcGhlciBtdXN0IGJlIGEgbnVtYmVyIG9yIHN0cmluZy4gUmVjZWl2ZWQgJHt0eXBlb2YgY2lwaGVyfSAoJHtjaXBoZXJ9KWApCn0KCmV4cG9ydHMudG9LZXlUeXBlID0gZnVuY3Rpb24gdG9LZXlUeXBlKHR5cGUpIHsKICBpZiAodHlwZW9mIHR5cGUgPT09ICdudW1iZXInKSByZXR1cm4gdHlwZQoKICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICB0eXBlID0gdHlwZS5yZXBsYWNlKC8tL2csICcnKQoKICAgIGlmICh0eXBlIGluIGV4cG9ydHMua2V5VHlwZSA9PT0gZmFsc2UpIHsKICAgICAgdHlwZSA9IHR5cGUudG9VcHBlckNhc2UoKQoKICAgICAgaWYgKHR5cGUgaW4gZXhwb3J0cy5rZXlUeXBlID09PSBmYWxzZSkgewogICAgICAgIHRocm93IGVycm9ycy5VTktOT1dOX0tFWV9UWVBFKGBVbmtub3duIGtleSB0eXBlICcke3R5cGV9J2ApCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZXhwb3J0cy5rZXlUeXBlW3R5cGVdCiAgfQoKICB0aHJvdyBuZXcgVHlwZUVycm9yKGBLZXkgdHlwZSBtdXN0IGJlIGEgbnVtYmVyIG9yIHN0cmluZy4gUmVjZWl2ZWQgJHt0eXBlb2YgdHlwZX0gKCR7dHlwZX0pYCkKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENyeXB0b0Vycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgZm4gPSBDcnlwdG9FcnJvciwgY29kZSA9IGZuLm5hbWUpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdDcnlwdG9FcnJvcicKICB9CgogIHN0YXRpYyBVTktOT1dOX0hBU0gobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuVU5LTk9XTl9IQVNIKQogIH0KCiAgc3RhdGljIFVOS05PV05fQ0lQSEVSKG1zZykgewogICAgcmV0dXJuIG5ldyBDcnlwdG9FcnJvcihtc2csIENyeXB0b0Vycm9yLlVOS05PV05fQ0lQSEVSKQogIH0KCiAgc3RhdGljIFVOS05PV05fS0VZX1RZUEUobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuVU5LTk9XTl9LRVlfVFlQRSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0FDQ0VTUyhtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5JTlZBTElEX0FDQ0VTUykKICB9CgogIHN0YXRpYyBJTlZBTElEX0RBVEEobXNnKSB7CiAgICByZXR1cm4gbmV3IENyeXB0b0Vycm9yKG1zZywgQ3J5cHRvRXJyb3IuSU5WQUxJRF9EQVRBKQogIH0KCiAgc3RhdGljIE9QRVJBVElPTl9FUlJPUihtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5PUEVSQVRJT05fRVJST1IpCiAgfQoKICBzdGF0aWMgTk9UX1NVUFBPUlRFRChtc2cpIHsKICAgIHJldHVybiBuZXcgQ3J5cHRvRXJyb3IobXNnLCBDcnlwdG9FcnJvci5OT1RfU1VQUE9SVEVEKQogIH0KfQpjb25zdCB7IFRyYW5zZm9ybSB9ID0gcmVxdWlyZSgnYmFyZS1zdHJlYW0nKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ3J5cHRvSGFzaCBleHRlbmRzIFRyYW5zZm9ybSB7CiAgY29uc3RydWN0b3IoYWxnb3JpdGhtLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKG9wdHMpCgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5oYXNoSW5pdChjb25zdGFudHMudG9IYXNoKGFsZ29yaXRobSkpCiAgfQoKICB1cGRhdGUoZGF0YSwgZW5jb2RpbmcgPSAndXRmOCcpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykKCiAgICBiaW5kaW5nLmhhc2hVcGRhdGUodGhpcy5faGFuZGxlLCBkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIGRpZ2VzdChlbmNvZGluZykgewogICAgY29uc3QgZGlnZXN0ID0gQnVmZmVyLmZyb20oYmluZGluZy5oYXNoRmluYWwodGhpcy5faGFuZGxlKSkKCiAgICByZXR1cm4gZW5jb2RpbmcgJiYgZW5jb2RpbmcgIT09ICdidWZmZXInID8gZGlnZXN0LnRvU3RyaW5nKGVuY29kaW5nKSA6IGRpZ2VzdAogIH0KCiAgX3RyYW5zZm9ybShkYXRhLCBlbmNvZGluZywgY2IpIHsKICAgIHRoaXMudXBkYXRlKGRhdGEpCgogICAgY2IobnVsbCkKICB9CgogIF9mbHVzaChjYikgewogICAgdGhpcy5wdXNoKHRoaXMuZGlnZXN0KCkpCgogICAgY2IobnVsbCkKICB9Cn0KY29uc3QgeyBUcmFuc2Zvcm0gfSA9IHJlcXVpcmUoJ2JhcmUtc3RyZWFtJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENyeXB0b0htYWMgZXh0ZW5kcyBUcmFuc2Zvcm0gewogIGNvbnN0cnVjdG9yKGFsZ29yaXRobSwga2V5LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKG9wdHMpCgogICAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykga2V5ID0gQnVmZmVyLmZyb20oa2V5LCBlbmNvZGluZykKCiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLmhtYWNJbml0KAogICAgICBjb25zdGFudHMudG9IYXNoKGFsZ29yaXRobSksCiAgICAgIGtleS5idWZmZXIsCiAgICAgIGtleS5ieXRlT2Zmc2V0LAogICAgICBrZXkuYnl0ZUxlbmd0aAogICAgKQogIH0KCiAgdXBkYXRlKGRhdGEsIGVuY29kaW5nID0gJ3V0ZjgnKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpCgogICAgYmluZGluZy5obWFjVXBkYXRlKHRoaXMuX2hhbmRsZSwgZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBkaWdlc3QoZW5jb2RpbmcpIHsKICAgIGNvbnN0IGRpZ2VzdCA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcuaG1hY0ZpbmFsKHRoaXMuX2hhbmRsZSkpCgogICAgcmV0dXJuIGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJyA/IGRpZ2VzdC50b1N0cmluZyhlbmNvZGluZykgOiBkaWdlc3QKICB9CgogIF90cmFuc2Zvcm0oZGF0YSwgZW5jb2RpbmcsIGNiKSB7CiAgICB0aGlzLnVwZGF0ZShkYXRhKQoKICAgIGNiKG51bGwpCiAgfQoKICBfZmx1c2goY2IpIHsKICAgIHRoaXMucHVzaCh0aGlzLmRpZ2VzdCgpKQoKICAgIGNiKG51bGwpCiAgfQp9CmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQoKY29uc3QgewogIGtleVR5cGU6IHsgRUQyNTUxOSB9Cn0gPSBjb25zdGFudHMKCmNsYXNzIENyeXB0b0tleSB7CiAgY29uc3RydWN0b3Ioa2V5VHlwZSkgewogICAgdGhpcy5fa2V5VHlwZSA9IGtleVR5cGUKICB9Cn0KCmV4cG9ydHMuS2V5ID0gQ3J5cHRvS2V5CgpjbGFzcyBDcnlwdG9FZDI1NTE5S2V5IGV4dGVuZHMgQ3J5cHRvS2V5IHsKICBjb25zdHJ1Y3RvcihrZXkpIHsKICAgIHN1cGVyKEVEMjU1MTkpCgogICAgdGhpcy5fa2V5ID0ga2V5CiAgfQoKICBnZXQgYXN5bW1ldHJpY0tleVR5cGUoKSB7CiAgICByZXR1cm4gJ2VkMjU1MTknCiAgfQp9CgpjbGFzcyBDcnlwdG9FZDI1NTE5UHVibGljS2V5IGV4dGVuZHMgQ3J5cHRvRWQyNTUxOUtleSB7CiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gJ3B1YmxpYycKICB9Cn0KCmV4cG9ydHMuRWQyNTUxOVB1YmxpY0tleSA9IENyeXB0b0VkMjU1MTlQdWJsaWNLZXkKCmNsYXNzIENyeXB0b0VkMjU1MTlQcml2YXRlS2V5IGV4dGVuZHMgQ3J5cHRvRWQyNTUxOUtleSB7CiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gJ3ByaXZhdGUnCiAgfQp9CgpleHBvcnRzLkVkMjU1MTlQcml2YXRlS2V5ID0gQ3J5cHRvRWQyNTUxOVByaXZhdGVLZXkKCmV4cG9ydHMuZ2VuZXJhdGVLZXlQYWlyID0gZnVuY3Rpb24gZ2VuZXJhdGVLZXlQYWlyKHR5cGUsIG9wdHMgPSB7fSkgewogIHR5cGUgPSBjb25zdGFudHMudG9LZXlUeXBlKHR5cGUpCgogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSBFRDI1NTE5OiB7CiAgICAgIGNvbnN0IHsgcHVibGljS2V5LCBwcml2YXRlS2V5IH0gPSBiaW5kaW5nLmVkMjU1MTlHZW5lcmF0ZUtleXBhaXIoKQoKICAgICAgcmV0dXJuIHsKICAgICAgICBwdWJsaWNLZXk6IG5ldyBDcnlwdG9FZDI1NTE5UHVibGljS2V5KHB1YmxpY0tleSksCiAgICAgICAgcHJpdmF0ZUtleTogbmV3IENyeXB0b0VkMjU1MTlQcml2YXRlS2V5KHByaXZhdGVLZXkpCiAgICAgIH0KICAgIH0KICB9Cn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHBia2RmMihwYXNzd29yZCwgc2FsdCwgaXRlcmF0aW9ucywga2V5bGVuLCBkaWdlc3QsIGNiKSB7CiAgaWYgKGl0ZXJhdGlvbnMgPD0gMCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ2l0ZXJhdGlvbnMgaXMgb3V0IG9mIHJhbmdlJykKICB9CgogIGlmICh0eXBlb2YgcGFzc3dvcmQgPT09ICdzdHJpbmcnKSBwYXNzd29yZCA9IEJ1ZmZlci5mcm9tKHBhc3N3b3JkKQogIGlmICh0eXBlb2Ygc2FsdCA9PT0gJ3N0cmluZycpIHNhbHQgPSBCdWZmZXIuZnJvbShzYWx0KQoKICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbSgKICAgIGJpbmRpbmcucGJrZGYyKAogICAgICBwYXNzd29yZC5idWZmZXIsCiAgICAgIHBhc3N3b3JkLmJ5dGVPZmZzZXQsCiAgICAgIHBhc3N3b3JkLmJ5dGVMZW5ndGgsCiAgICAgIHNhbHQuYnVmZmVyLAogICAgICBzYWx0LmJ5dGVPZmZzZXQsCiAgICAgIHNhbHQuYnl0ZUxlbmd0aCwKICAgICAgaXRlcmF0aW9ucywKICAgICAgY29uc3RhbnRzLnRvSGFzaChkaWdlc3QpLAogICAgICBrZXlsZW4KICAgICkKICApCgogIGlmIChjYikgcXVldWVNaWNyb3Rhc2soKCkgPT4gY2IobnVsbCwgYnVmZmVyKSkKICBlbHNlIHJldHVybiBidWZmZXIKfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgpleHBvcnRzLnJhbmRvbUJ5dGVzID0gZnVuY3Rpb24gcmFuZG9tQnl0ZXMoc2l6ZSwgY2IpIHsKICBjb25zdCBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoc2l6ZSkKICBleHBvcnRzLnJhbmRvbUZpbGwoYnVmZmVyKQogIGlmIChjYikgcXVldWVNaWNyb3Rhc2soKCkgPT4gY2IobnVsbCwgYnVmZmVyKSkKICBlbHNlIHJldHVybiBidWZmZXIKfQoKZXhwb3J0cy5yYW5kb21GaWxsID0gZnVuY3Rpb24gcmFuZG9tRmlsbChidWZmZXIsIG9mZnNldCwgc2l6ZSwgY2IpIHsKICBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvZmZzZXQKICAgIG9mZnNldCA9IHVuZGVmaW5lZAogIH0gZWxzZSBpZiAodHlwZW9mIHNpemUgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gc2l6ZQogICAgc2l6ZSA9IHVuZGVmaW5lZAogIH0KCiAgY29uc3QgZWxlbWVudFNpemUgPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgfHwgMQoKICBpZiAob2Zmc2V0ID09PSB1bmRlZmluZWQpIG9mZnNldCA9IDAKICBlbHNlIG9mZnNldCAqPSBlbGVtZW50U2l6ZQoKICBpZiAoc2l6ZSA9PT0gdW5kZWZpbmVkKSBzaXplID0gYnVmZmVyLmJ5dGVMZW5ndGggLSBvZmZzZXQKICBlbHNlIHNpemUgKj0gZWxlbWVudFNpemUKCiAgaWYgKG9mZnNldCA8IDAgfHwgb2Zmc2V0ID4gYnVmZmVyLmJ5dGVMZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvZmZzZXQgaXMgb3V0IG9mIHJhbmdlJykKICB9CgogIGlmIChzaXplIDwgMCB8fCBzaXplID4gYnVmZmVyLmJ5dGVMZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdzaXplIGlzIG91dCBvZiByYW5nZScpCiAgfQoKICBpZiAob2Zmc2V0ICsgc2l6ZSA+IGJ1ZmZlci5ieXRlTGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0ICsgc2l6ZSBpcyBvdXQgb2YgcmFuZ2UnKQogIH0KCiAgbGV0IGFycmF5YnVmZmVyCgogIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoYnVmZmVyKSkgewogICAgb2Zmc2V0ICs9IGJ1ZmZlci5ieXRlT2Zmc2V0CiAgICBhcnJheWJ1ZmZlciA9IGJ1ZmZlci5idWZmZXIKICB9IGVsc2UgewogICAgYXJyYXlidWZmZXIgPSBidWZmZXIKICB9CgogIGJpbmRpbmcucmFuZG9tRmlsbChhcnJheWJ1ZmZlciwgb2Zmc2V0LCBzaXplKQoKICBpZiAoY2IpIHF1ZXVlTWljcm90YXNrKCgpID0+IGNiKG51bGwsIGJ1ZmZlcikpCiAgZWxzZSByZXR1cm4gYnVmZmVyCn0KCmV4cG9ydHMucmFuZG9tVVVJRCA9IGZ1bmN0aW9uIHJhbmRvbVVVSUQoKSB7CiAgY29uc3QgdXVpZCA9IGV4cG9ydHMucmFuZG9tQnl0ZXMoMTYpCgogIHV1aWRbNl0gPSAodXVpZFs2XSA+Pj4gNCkgfCAwYjAxMDAwMDAwCiAgdXVpZFs4XSA9ICh1dWlkWzhdID4+PiAyKSB8IDBiMTAwMDAwMDAKCiAgcmV0dXJuICgKICAgIHV1aWQuc3ViYXJyYXkoMCwgNCkudG9TdHJpbmcoJ2hleCcpICsKICAgICctJyArCiAgICB1dWlkLnN1YmFycmF5KDQsIDYpLnRvU3RyaW5nKCdoZXgnKSArCiAgICAnLScgKwogICAgdXVpZC5zdWJhcnJheSg2LCA4KS50b1N0cmluZygnaGV4JykgKwogICAgJy0nICsKICAgIHV1aWQuc3ViYXJyYXkoOCwgMTApLnRvU3RyaW5nKCdoZXgnKSArCiAgICAnLScgKwogICAgdXVpZC5zdWJhcnJheSgxMCwgMTYpLnRvU3RyaW5nKCdoZXgnKQogICkKfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IHsKICBrZXlUeXBlOiB7IEVEMjU1MTkgfQp9ID0gY29uc3RhbnRzCgpleHBvcnRzLnNpZ24gPSBmdW5jdGlvbiBzaWduKGFsZ29yaXRobSwgZGF0YSwga2V5KSB7CiAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgZGF0YSA9IEJ1ZmZlci5jb2VyY2UoZGF0YSkKICB9IGVsc2UgewogICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEpCiAgfQoKICBzd2l0Y2ggKGtleS5fa2V5VHlwZSkgewogICAgY2FzZSBFRDI1NTE5OgogICAgICByZXR1cm4gQnVmZmVyLmZyb20oCiAgICAgICAgYmluZGluZy5lZDI1NTE5U2lnbihkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgsIGtleS5fa2V5KQogICAgICApCiAgfQp9CgpleHBvcnRzLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShhbGdvcml0aG0sIGRhdGEsIGtleSwgc2lnbmF0dXJlKSB7CiAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgZGF0YSA9IEJ1ZmZlci5jb2VyY2UoZGF0YSkKICB9IGVsc2UgewogICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEpCiAgfQoKICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHNpZ25hdHVyZSkpIHsKICAgIHNpZ25hdHVyZSA9IEJ1ZmZlci5jb2VyY2Uoc2lnbmF0dXJlKQogIH0gZWxzZSB7CiAgICBzaWduYXR1cmUgPSBCdWZmZXIuZnJvbShzaWduYXR1cmUpCiAgfQoKICBzd2l0Y2ggKGtleS5fa2V5VHlwZSkgewogICAgY2FzZSBFRDI1NTE5OgogICAgICByZXR1cm4gYmluZGluZy5lZDI1NTE5VmVyaWZ5KAogICAgICAgIGRhdGEuYnVmZmVyLAogICAgICAgIGRhdGEuYnl0ZU9mZnNldCwKICAgICAgICBkYXRhLmJ5dGVMZW5ndGgsCiAgICAgICAgc2lnbmF0dXJlLmJ1ZmZlciwKICAgICAgICBzaWduYXR1cmUuYnl0ZU9mZnNldCwKICAgICAgICBrZXkuX2tleQogICAgICApCiAgfQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJy4uLy4uLy4uJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uLy4uLy4uL2JpbmRpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9lcnJvcnMnKQpjb25zdCB7IEVkMjU1MTlQdWJsaWNLZXksIEVkMjU1MTlQcml2YXRlS2V5IH0gPSByZXF1aXJlKCcuLi8uLi9rZXknKQpjb25zdCBDcnlwdG9LZXkgPSByZXF1aXJlKCcuLi9jcnlwdG8ta2V5JykKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTkKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy1zaWduCmV4cG9ydHMuc2lnbiA9IGZ1bmN0aW9uIHNpZ24oYWxnb3JpdGhtLCBrZXksIGRhdGEpIHsKICBpZiAoa2V5LnR5cGUgIT09ICdwcml2YXRlJykgewogICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdNdXN0IHBhc3MgcHJpdmF0ZSBrZXkgZm9yIEVkMjU1MTkgc2lnbmluZycpCiAgfQoKICBjb25zdCBzaWduYXR1cmUgPSBjcnlwdG8uc2lnbihudWxsLCBkYXRhLCBrZXkuX2hhbmRsZSkKCiAgcmV0dXJuIHNpZ25hdHVyZS5idWZmZXIuc2xpY2UoMCwgc2lnbmF0dXJlLmJ5dGVMZW5ndGgpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy12ZXJpZnkKZXhwb3J0cy52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkgewogIGlmIChrZXkudHlwZSAhPT0gJ3B1YmxpYycpIHsKICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnTXVzdCBwYXNzIHB1YmxpYyBrZXkgZm9yIEVkMjU1MTkgdmVyaWZpY2F0aW9uJykKICB9CgogIHJldHVybiBjcnlwdG8udmVyaWZ5KG51bGwsIGRhdGEsIGtleS5faGFuZGxlLCBzaWduYXR1cmUpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2VkMjU1MTktb3BlcmF0aW9ucy1nZW5lcmF0ZS1rZXkKZXhwb3J0cy5nZW5lcmF0ZUtleSA9IGZ1bmN0aW9uIGdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VzKSB7CiAgICBpZiAodXNhZ2UgIT09ICdzaWduJyAmJiB1c2FnZSAhPT0gJ3ZlcmlmeScpIHsKICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKAogICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBnZW5lcmF0ZUtleSgpIG9wZXJhdGlvbmAKICAgICAgKQogICAgfQogIH0KCiAgY29uc3Qga2V5cyA9IGNyeXB0by5nZW5lcmF0ZUtleVBhaXIoJ2VkMjU1MTknKQoKICBhbGdvcml0aG0gPSB7IG5hbWU6ICdFZDI1NTE5JyB9CgogIHJldHVybiB7CiAgICBwdWJsaWNLZXk6IG5ldyBDcnlwdG9LZXkoJ3B1YmxpYycsIHRydWUsIGFsZ29yaXRobSwgWyd2ZXJpZnknXSwga2V5cy5wdWJsaWNLZXkpLAogICAgcHJpdmF0ZUtleTogbmV3IENyeXB0b0tleSgncHJpdmF0ZScsIGV4dHJhY3RhYmxlLCBhbGdvcml0aG0sIFsnc2lnbiddLCBrZXlzLnByaXZhdGVLZXkpCiAgfQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5LW9wZXJhdGlvbnMtaW1wb3J0LWtleQpleHBvcnRzLmltcG9ydEtleSA9IGZ1bmN0aW9uIGltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogIHN3aXRjaCAoZm9ybWF0KSB7CiAgICBjYXNlICdzcGtpJzoKICAgICAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgICAgICBpZiAodXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoCiAgICAgICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBrZXlEYXRhID0gYmluZGluZy5lZDI1NTE5RnJvbVNQS0koa2V5RGF0YS5idWZmZXIsIGtleURhdGEuYnl0ZU9mZnNldCwga2V5RGF0YS5ieXRlTGVuZ3RoKQoKICAgICAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAgICAgJ3B1YmxpYycsCiAgICAgICAgZXh0cmFjdGFibGUsCiAgICAgICAgewogICAgICAgICAgbmFtZTogJ0VkMjU1MTknCiAgICAgICAgfSwKICAgICAgICB1c2FnZXMsCiAgICAgICAgbmV3IEVkMjU1MTlQdWJsaWNLZXkoa2V5RGF0YSkKICAgICAgKQogICAgY2FzZSAncGtjczgnOgogICAgICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgICAgIGlmICh1c2FnZSAhPT0gJ3NpZ24nKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoCiAgICAgICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBrZXlEYXRhID0gYmluZGluZy5lZDI1NTE5RnJvbVBLQ1M4KGtleURhdGEuYnVmZmVyLCBrZXlEYXRhLmJ5dGVPZmZzZXQsIGtleURhdGEuYnl0ZUxlbmd0aCkKCiAgICAgIHJldHVybiBuZXcgQ3J5cHRvS2V5KAogICAgICAgICdwcml2YXRlJywKICAgICAgICBleHRyYWN0YWJsZSwKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICB9LAogICAgICAgIHVzYWdlcywKICAgICAgICBuZXcgRWQyNTUxOVByaXZhdGVLZXkoa2V5RGF0YSkKICAgICAgKQogICAgY2FzZSAncmF3JzoKICAgICAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgICAgICBpZiAodXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoCiAgICAgICAgICAgIGBVc2FnZSAnJHt1c2FnZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgICApCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoa2V5RGF0YS5ieXRlTGVuZ3RoICogOCAhPT0gMjU2KSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnS2V5IG11c3QgYmUgMjU2IGJpdHMnKQogICAgICB9CgogICAgICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICAgICAncHVibGljJywKICAgICAgICBleHRyYWN0YWJsZSwKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICB9LAogICAgICAgIHVzYWdlcywKICAgICAgICBuZXcgRWQyNTUxOVB1YmxpY0tleShrZXlEYXRhLmJ1ZmZlcikKICAgICAgKQogICAgY2FzZSAnandrJzoKICAgICAgY29uc3QgandrID0ga2V5RGF0YQoKICAgICAgaWYgKCdkJyBpbiBqd2spIHsKICAgICAgICBpZiAodXNhZ2VzLnNvbWUoKHVzYWdlKSA9PiB1c2FnZSAhPT0gJ3NpZ24nKSkgewogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdKV0sgbXVzdCBiZSB2YWxpZCBmb3Igc2lnbmluZycpCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh1c2FnZXMuc29tZSgodXNhZ2UpID0+IHVzYWdlICE9PSAndmVyaWZ5JykpIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSldLIG11c3QgYmUgdmFsaWQgZm9yIHZlcmlmaWNhdGlvbicpCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoandrLmt0eSAhPT0gJ09LUCcpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sga2V5IG11c3QgYmUgYW4gb2N0ZXQga2V5LXBhaXInKQogICAgICB9CgogICAgICBpZiAoandrLmNydiAhPT0gJ0VkMjU1MTknKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfREFUQSgnSldLIG11c3QgdXNlIHRoZSBFZDI1NTE5IGN1cnZlJykKICAgICAgfQoKICAgICAgaWYgKCdhbGcnIGluIGp3ayAmJiBqd2suYWxnICE9PSAnRWQyNTUxOScgJiYgandrLmFsZyAhPT0gJ0VkRFNBJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBtdXN0IHVzZSB0aGUgRWQyNTUxOSBjdXJ2ZScpCiAgICAgIH0KCiAgICAgIGlmICh1c2FnZXMubGVuZ3RoICYmICd1c2UnIGluIGp3ayAmJiBqd2sudXNlICE9PSAnc2lnJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBjYW5ub3QgYmUgdXNlZCBmb3Igc2lnbmF0dXJlcycpCiAgICAgIH0KCiAgICAgIGlmICgnZXh0JyBpbiBqd2sgJiYgandrLmV4dCAhPT0gZXh0cmFjdGFibGUgJiYgZXh0cmFjdGFibGUpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgaXMgbm90IGV4dHJhY3RhYmxlJykKICAgICAgfQoKICAgICAgaWYgKCdkJyBpbiBqd2spIHsKICAgICAgICBjb25zdCBrZXkgPSBCdWZmZXIuY29uY2F0KFsKICAgICAgICAgIEJ1ZmZlci5mcm9tKGp3ay5kLCAnYmFzZTY0dXJsJyksCiAgICAgICAgICBCdWZmZXIuZnJvbShqd2sueCwgJ2Jhc2U2NHVybCcpCiAgICAgICAgXSkKCiAgICAgICAgaWYgKGtleS5ieXRlTGVuZ3RoICogOCAhPT0gNTEyKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdLZXkgbXVzdCBiZSA1MTIgYml0cycpCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICAgICAgICdwcml2YXRlJywKICAgICAgICAgIGV4dHJhY3RhYmxlLAogICAgICAgICAgewogICAgICAgICAgICBuYW1lOiAnRWQyNTUxOScKICAgICAgICAgIH0sCiAgICAgICAgICB1c2FnZXMsCiAgICAgICAgICBuZXcgRWQyNTUxOVByaXZhdGVLZXkoa2V5LmJ1ZmZlcikKICAgICAgICApCiAgICAgIH0KCiAgICAgIGNvbnN0IGtleSA9IEJ1ZmZlci5mcm9tKGp3ay54LCAnYmFzZTY0dXJsJykKCiAgICAgIGlmIChrZXkuYnl0ZUxlbmd0aCAqIDggIT09IDI1NikgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0tleSBtdXN0IGJlIDI1NiBiaXRzJykKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAgICAgJ3B1YmxpYycsCiAgICAgICAgZXh0cmFjdGFibGUsCiAgICAgICAgewogICAgICAgICAgbmFtZTogJ0VkMjU1MTknCiAgICAgICAgfSwKICAgICAgICB1c2FnZXMsCiAgICAgICAgbmV3IEVkMjU1MTlQdWJsaWNLZXkoa2V5LmJ1ZmZlcikKICAgICAgKQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNlZDI1NTE5LW9wZXJhdGlvbnMtZXhwb3J0LWtleQpleHBvcnRzLmV4cG9ydEtleSA9IGZ1bmN0aW9uIGV4cG9ydEtleShmb3JtYXQsIGtleSkgewogIGNvbnN0IGRhdGEgPSBrZXkuX2hhbmRsZQoKICBzd2l0Y2ggKGZvcm1hdCkgewogICAgY2FzZSAnc3BraSc6CiAgICAgIGlmIChrZXkudHlwZSAhPT0gJ3B1YmxpYycpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoCiAgICAgICAgICBgS2V5IG9mIHR5cGUgJyR7a2V5LnR5cGV9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEVkMjU1MTkgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgICAgfQoKICAgICAgcmV0dXJuIGJpbmRpbmcuZWQyNTUxOVRvU1BLSShkYXRhLl9rZXkpCiAgICBjYXNlICdwa2NzOCc6CiAgICAgIGlmIChrZXkudHlwZSAhPT0gJ3ByaXZhdGUnKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKAogICAgICAgICAgYEtleSBvZiB0eXBlICcke2tleS50eXBlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBFZDI1NTE5IGV4cG9ydEtleSgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICAgIH0KCiAgICAgIHJldHVybiBiaW5kaW5nLmVkMjU1MTlUb1BLQ1M4KGRhdGEuX2tleSkKICAgIGNhc2UgJ3Jhdyc6IHsKICAgICAgaWYgKGtleS50eXBlICE9PSAncHVibGljJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygKICAgICAgICAgIGBLZXkgb2YgdHlwZSAnJHtrZXkudHlwZX0nIGNhbm5vdCBiZSB1c2VkIGZvciB0aGUgRWQyNTUxOSBleHBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgICB9CgogICAgICByZXR1cm4gZGF0YS5fa2V5LnNsaWNlKCkKICAgIH0KICAgIGNhc2UgJ2p3ayc6IHsKICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oZGF0YS5fa2V5KQoKICAgICAgaWYgKGtleS50eXBlID09PSAncHJpdmF0ZScpIHsKICAgICAgICBjb25zdCBkID0gYnVmZmVyLnN1YmFycmF5KDAsIDMyKS50b1N0cmluZygnYmFzZTY0dXJsJykKICAgICAgICBjb25zdCB4ID0gYnVmZmVyLnN1YmFycmF5KDMyKS50b1N0cmluZygnYmFzZTY0dXJsJykKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGt0eTogJ09LUCcsCiAgICAgICAgICBhbGc6ICdFZDI1NTE5JywKICAgICAgICAgIGNydjogJ0VkMjU1MTknLAogICAgICAgICAgeCwKICAgICAgICAgIGQsCiAgICAgICAgICBrZXlfb3BzOiBrZXkudXNhZ2VzLAogICAgICAgICAgZXh0OiBrZXkuZXh0cmFjdGFibGUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAga3R5OiAnT0tQJywKICAgICAgICBhbGc6ICdFZDI1NTE5JywKICAgICAgICBjcnY6ICdFZDI1NTE5JywKICAgICAgICB4OiBidWZmZXIudG9TdHJpbmcoJ2Jhc2U2NHVybCcpLAogICAgICAgIGtleV9vcHM6IGtleS51c2FnZXMsCiAgICAgICAgZXh0OiBrZXkuZXh0cmFjdGFibGUKICAgICAgfQogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEhNQUMgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJy4uLy4uLy4uJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZXJyb3JzJykKY29uc3QgQ3J5cHRvS2V5ID0gcmVxdWlyZSgnLi4vY3J5cHRvLWtleScpCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtc2lnbgpleHBvcnRzLnNpZ24gPSBmdW5jdGlvbiBzaWduKGFsZ29yaXRobSwga2V5LCBkYXRhKSB7CiAgY29uc3QgZGlnZXN0ID0gY3J5cHRvLmNyZWF0ZUhtYWMoa2V5LmFsZ29yaXRobS5oYXNoLm5hbWUsIGtleS5faGFuZGxlKS51cGRhdGUoZGF0YSkuZGlnZXN0KCkKCiAgcmV0dXJuIGRpZ2VzdC5idWZmZXIuc2xpY2UoMCwgZGlnZXN0LmJ5dGVMZW5ndGgpCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI2htYWMtb3BlcmF0aW9ucy12ZXJpZnkKZXhwb3J0cy52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkgewogIGNvbnN0IGRpZ2VzdCA9IGNyeXB0by5jcmVhdGVIbWFjKGtleS5hbGdvcml0aG0uaGFzaC5uYW1lLCBrZXkuX2hhbmRsZSkudXBkYXRlKGRhdGEpLmRpZ2VzdCgpCgogIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoc2lnbmF0dXJlKSkgewogICAgc2lnbmF0dXJlID0gQnVmZmVyLmNvZXJjZShzaWduYXR1cmUpCiAgfSBlbHNlIHsKICAgIHNpZ25hdHVyZSA9IEJ1ZmZlci5mcm9tKHNpZ25hdHVyZSkKICB9CgogIHJldHVybiBzaWduYXR1cmUuZXF1YWxzKGRpZ2VzdCkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLWdlbmVyYXRlLWtleQpleHBvcnRzLmdlbmVyYXRlS2V5ID0gZnVuY3Rpb24gZ2VuZXJhdGVLZXkoYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgIGlmICh1c2FnZSAhPT0gJ3NpZ24nICYmIHVzYWdlICE9PSAndmVyaWZ5JykgewogICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVzYWdlICcke3VzYWdlfScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBITUFDIGdlbmVyYXRlS2V5KCkgb3BlcmF0aW9uYCkKICAgIH0KICB9CgogIGNvbnN0IHsgbGVuZ3RoID0gZXhwb3J0cy5nZXRLZXlMZW5ndGgoYWxnb3JpdGhtKSB9ID0gYWxnb3JpdGhtLmxlbmd0aAoKICBsZXQgaGFzaCA9IGFsZ29yaXRobS5oYXNoCgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIGhhc2ggPSB7IG5hbWU6IGhhc2ggfQoKICBjb25zdCBrZXkgPSBjcnlwdG8uY3JlYXRlSG1hYyhoYXNoLm5hbWUsIGNyeXB0by5yYW5kb21CeXRlcyhsZW5ndGgpKS5kaWdlc3QoKQoKICByZXR1cm4gbmV3IENyeXB0b0tleSgKICAgICdzZWNyZXQnLAogICAgZXh0cmFjdGFibGUsCiAgICB7CiAgICAgIG5hbWU6ICdITUFDJywKICAgICAgbGVuZ3RoLAogICAgICBoYXNoOiB7CiAgICAgICAgbmFtZTogaGFzaC5uYW1lLnRvVXBwZXJDYXNlKCkKICAgICAgfQogICAgfSwKICAgIHVzYWdlcywKICAgIGtleQogICkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jaG1hYy1vcGVyYXRpb25zLWltcG9ydC1rZXkKZXhwb3J0cy5pbXBvcnRLZXkgPSBmdW5jdGlvbiBpbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICBmb3IgKGNvbnN0IHVzYWdlIG9mIHVzYWdlcykgewogICAgaWYgKHVzYWdlICE9PSAnc2lnbicgJiYgdXNhZ2UgIT09ICd2ZXJpZnknKSB7CiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgSW52YWxpZCB1c2FnZSAke3VzYWdlfWApCiAgICB9CiAgfQoKICBsZXQgaGFzaCA9IGFsZ29yaXRobS5oYXNoCgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIGhhc2ggPSB7IG5hbWU6IGhhc2ggfQoKICBsZXQgZGF0YQoKICBzd2l0Y2ggKGZvcm1hdCkgewogICAgY2FzZSAncmF3JzoKICAgICAgZGF0YSA9IGtleURhdGEKICAgICAgYnJlYWsKICAgIGNhc2UgJ2p3ayc6CiAgICAgIGNvbnN0IGp3ayA9IGtleURhdGEKCiAgICAgIGlmIChqd2sua3R5ICE9PSAnb2N0JykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBrZXkgbXVzdCBiZSBhbiBvY3RldCBzZXF1ZW5jZScpCiAgICAgIH0KCiAgICAgIGRhdGEgPSBCdWZmZXIuZnJvbShqd2suaywgJ2Jhc2U2NHVybCcpCgogICAgICBzd2l0Y2ggKGhhc2gubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgY2FzZSAnc2hhLTEnOgogICAgICAgICAgaWYgKGp3ay5hbGcgPT09ICdIUzEnKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgICBjYXNlICdzaGEtMjU2JzoKICAgICAgICAgIGlmIChqd2suYWxnID09PSAnSFMyNTYnKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgICBjYXNlICdzaGEtMzg0JzoKICAgICAgICAgIGlmIChqd2suYWxnID09PSAnSFMzODQnKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgICBjYXNlICdzaGEtNTEyJzoKICAgICAgICAgIGlmIChqd2suYWxnID09PSAnSFM1MTInKSBicmVhawogICAgICAgICAgZWxzZSB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdJbnZhbGlkIEpXSyBrZXkgYWxnb3JpdGhtJykKICAgICAgfQoKICAgICAgaWYgKHVzYWdlcy5sZW5ndGggJiYgJ3VzZScgaW4gandrICYmIGp3ay51c2UgIT09ICdzaWduJykgewogICAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0pXSyBjYW5ub3QgYmUgdXNlZCBmb3Igc2lnbmluZycpCiAgICAgIH0KCiAgICAgIGlmICgnZXh0JyBpbiBqd2sgJiYgandrLmV4dCAhPT0gZXh0cmFjdGFibGUgJiYgZXh0cmFjdGFibGUpIHsKICAgICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9EQVRBKCdKV0sgaXMgbm90IGV4dHJhY3RhYmxlJykKICAgICAgfQogICAgICBicmVhawogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEhNQUMgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQoKICBjb25zdCBsZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGggKiA4CgogIGlmIChsZW5ndGggPT09IDApIHsKICAgIHRocm93IGVycm9ycy5JTlZBTElEX0RBVEEoJ0tleSBjYW5ub3QgYmUgZW1wdHknKQogIH0KCiAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAnc2VjcmV0JywKICAgIGV4dHJhY3RhYmxlLAogICAgewogICAgICBuYW1lOiAnSE1BQycsCiAgICAgIGxlbmd0aCwKICAgICAgaGFzaDogewogICAgICAgIG5hbWU6IGhhc2gubmFtZS50b1VwcGVyQ2FzZSgpCiAgICAgIH0KICAgIH0sCiAgICB1c2FnZXMsCiAgICBkYXRhCiAgKQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtZXhwb3J0LWtleQpleHBvcnRzLmV4cG9ydEtleSA9IGZ1bmN0aW9uIGV4cG9ydEtleShmb3JtYXQsIGtleSkgewogIGNvbnN0IGRhdGEgPSBrZXkuX2hhbmRsZQoKICBzd2l0Y2ggKGZvcm1hdCkgewogICAgY2FzZSAncmF3JzoKICAgICAgcmV0dXJuIGRhdGEuYnVmZmVyLnNsaWNlKDAsIGRhdGEuYnl0ZUxlbmd0aCkKICAgIGNhc2UgJ2p3ayc6IHsKICAgICAgY29uc3QgandrID0gewogICAgICAgIGt0eTogJ29jdCcsCiAgICAgICAgazogZGF0YS50b1N0cmluZygnYmFzZTY0dXJsJyksCiAgICAgICAgYWxnOiBudWxsLAogICAgICAgIGtleV9vcHM6IGtleS51c2FnZXMsCiAgICAgICAgZXh0OiBrZXkuZXh0cmFjdGFibGUKICAgICAgfQoKICAgICAgc3dpdGNoIChrZXkuYWxnb3JpdGhtLmhhc2gubmFtZSkgewogICAgICAgIGNhc2UgJ1NIQS0xJzoKICAgICAgICAgIGp3ay5hbGcgPSAnSFMxJwogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlICdTSEEtMjU2JzoKICAgICAgICAgIGp3ay5hbGcgPSAnSFMyNTYnCiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgJ1NIQS0zODQnOgogICAgICAgICAgandrLmFsZyA9ICdIUzM4NCcKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAnU0hBLTUxMic6CiAgICAgICAgICBqd2suYWxnID0gJ0hTNTEyJwogICAgICAgICAgYnJlYWsKICAgICAgfQoKICAgICAgcmV0dXJuIGp3awogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgYEZvcm1hdCAnJHtmb3JtYXR9JyBjYW5ub3QgYmUgdXNlZCBmb3IgdGhlIEhNQUMgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICApCiAgfQp9CgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNobWFjLW9wZXJhdGlvbnMtZ2V0LWtleS1sZW5ndGgKZXhwb3J0cy5nZXRLZXlMZW5ndGggPSBmdW5jdGlvbiBnZXRLZXlMZW5ndGgoYWxnb3JpdGhtKSB7CiAgY29uc3QgeyBsZW5ndGgsIGhhc2ggfSA9IGFsZ29yaXRobQoKICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgIGlmIChoYXNoID09PSAnU0hBLTEnIHx8IGhhc2ggPT09ICdTSEEtMjU2JykgcmV0dXJuIDUxMgogICAgaWYgKGhhc2ggPT09ICdTSEEtNTEyJykgcmV0dXJuIDEwMjQKCiAgICB0aHJvdyBlcnJvcnMuT1BFUkFUSU9OX0VSUk9SKGBJbnZhbGlkIGhhc2ggJyR7aGFzaH0nYCkKICB9CgogIGlmIChsZW5ndGggPT09IDApIHsKICAgIHRocm93IGVycm9ycy5PUEVSQVRJT05fRVJST1IoYEludmFsaWQgbGVuZ3RoICR7bGVuZ3RofWApCiAgfQoKICByZXR1cm4gbGVuZ3RoCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnLi4vLi4vLi4nKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9lcnJvcnMnKQpjb25zdCBDcnlwdG9LZXkgPSByZXF1aXJlKCcuLi9jcnlwdG8ta2V5JykKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3Bia2RmMgoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jcGJrZGYyLW9wZXJhdGlvbnMtZGVyaXZlLWJpdHMKZXhwb3J0cy5kZXJpdmVCaXRzID0gZnVuY3Rpb24gZGVyaXZlQml0cyhhbGdvcml0aG0sIGtleSwgbGVuZ3RoKSB7CiAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkIHx8IGxlbmd0aCAlIDgpIHsKICAgIHRocm93IGVycm9ycy5PUEVSQVRJT05fRVJST1IoJ0xlbmd0aCBtdXN0IGJlIG11bHRpcGxlIG9mIDgnKQogIH0KCiAgaWYgKGFsZ29yaXRobS5pdGVyYXRpb25zID09PSAwKSB7CiAgICB0aHJvdyBlcnJvcnMuT1BFUkFUSU9OX0VSUk9SKCdJdGVyYXRpb25zIG11c3QgYmUgbm9uLTAnKQogIH0KCiAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG5ldyBBcnJheUJ1ZmZlcigwKQogIH0KCiAgbGV0IGhhc2ggPSBhbGdvcml0aG0uaGFzaAoKICBpZiAodHlwZW9mIGhhc2ggPT09ICdzdHJpbmcnKSBoYXNoID0geyBuYW1lOiBoYXNoIH0KCiAgY29uc3QgcmVzdWx0ID0gY3J5cHRvLnBia2RmMigKICAgIGtleS5faGFuZGxlLAogICAgYWxnb3JpdGhtLnNhbHQsCiAgICBhbGdvcml0aG0uaXRlcmF0aW9ucywKICAgIGxlbmd0aCAvIDgsCiAgICBoYXNoLm5hbWUKICApCgogIHJldHVybiByZXN1bHQuYnVmZmVyCn0KCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI3Bia2RmMi1vcGVyYXRpb25zLWltcG9ydC1rZXkKZXhwb3J0cy5pbXBvcnRLZXkgPSBmdW5jdGlvbiBpbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpIHsKICBpZiAoZm9ybWF0ICE9PSAncmF3JykgewogICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgIGBGb3JtYXQgJyR7Zm9ybWF0fScgY2Fubm90IGJlIHVzZWQgZm9yIHRoZSBQQktERjIgaW1wb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgKQogIH0KCiAgZm9yIChjb25zdCB1c2FnZSBvZiB1c2FnZXMpIHsKICAgIGlmICh1c2FnZSAhPT0gJ2Rlcml2ZUtleScgJiYgdXNhZ2UgIT09ICdkZXJpdmVCaXRzJykgewogICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYEludmFsaWQgdXNhZ2UgJHt1c2FnZX1gKQogICAgfQogIH0KCiAgaWYgKGV4dHJhY3RhYmxlKSB7CiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoJ0V4dHJhY3RhYmxlIG11c3QgYmUgZmFsc2UnKQogIH0KCiAgcmV0dXJuIG5ldyBDcnlwdG9LZXkoCiAgICAnc2VjcmV0JywKICAgIGV4dHJhY3RhYmxlLAogICAgewogICAgICBuYW1lOiAnUEJLREYyJwogICAgfSwKICAgIHVzYWdlcywKICAgIGtleURhdGEKICApCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnLi4vLi4vLi4nKQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jc2hhCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNzaGEtb3BlcmF0aW9ucy1kaWdlc3QKZXhwb3J0cy5kaWdlc3QgPSBmdW5jdGlvbiBkaWdlc3QobmFtZSwgZGF0YSkgewogIGNvbnN0IGRpZ2VzdCA9IGNyeXB0by5jcmVhdGVIYXNoKG5hbWUpLnVwZGF0ZShkYXRhKS5kaWdlc3QoKQoKICByZXR1cm4gZGlnZXN0LmJ1ZmZlci5zbGljZSgwLCBkaWdlc3QuYnl0ZUxlbmd0aCkKfQovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNjcnlwdG9rZXktaW50ZXJmYWNlCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ3J5cHRvS2V5IHsKICBjb25zdHJ1Y3Rvcih0eXBlLCBleHRyYWN0YWJsZSwgYWxnb3JpdGhtLCB1c2FnZXMsIGhhbmRsZSA9IG51bGwpIHsKICAgIHRoaXMuX3R5cGUgPSB0eXBlCiAgICB0aGlzLl9leHRyYWN0YWJsZSA9IGV4dHJhY3RhYmxlCiAgICB0aGlzLl9hbGdvcml0aG0gPSBhbGdvcml0aG0KICAgIHRoaXMuX3VzYWdlcyA9IHVzYWdlcwogICAgdGhpcy5faGFuZGxlID0gaGFuZGxlCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LXR5cGUKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiB0aGlzLl90eXBlCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LWV4dHJhY3RhYmxlCiAgZ2V0IGV4dHJhY3RhYmxlKCkgewogICAgcmV0dXJuIHRoaXMuX2V4dHJhY3RhYmxlCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LWFsZ29yaXRobQogIGdldCBhbGdvcml0aG0oKSB7CiAgICByZXR1cm4gdGhpcy5fYWxnb3JpdGhtCiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNkb20tY3J5cHRva2V5LXVzYWdlcwogIGdldCB1c2FnZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fdXNhZ2VzCiAgfQoKICBbU3ltYm9sLmZvcignYmFyZS5pbnNwZWN0JyldKCkgewogICAgcmV0dXJuIHsKICAgICAgX19wcm90b19fOiB7IGNvbnN0cnVjdG9yOiBDcnlwdG9LZXkgfSwKCiAgICAgIHR5cGU6IHRoaXMudHlwZSwKICAgICAgZXh0cmFjdGFibGU6IHRoaXMuZXh0cmFjdGFibGUsCiAgICAgIGFsZ29yaXRobTogdGhpcy5hbGdvcml0aG0sCiAgICAgIHVzYWdlczogdGhpcy51c2FnZXMKICAgIH0KICB9Cn0KewogICJuYW1lIjogImJhcmUtY3J5cHRvIiwKICAidmVyc2lvbiI6ICIxLjEyLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDcnlwdG9ncmFwaGljIHByaW1pdGl2ZXMgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vd2ViIjogewogICAgICAidHlwZXMiOiAiLi93ZWIuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vd2ViLmpzIgogICAgfSwKICAgICIuL2dsb2JhbCI6IHsKICAgICAgInR5cGVzIjogIi4vZ2xvYmFsLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2dsb2JhbC5qcyIKICAgIH0sCiAgICAiLi9jb25zdGFudHMiOiAiLi9saWIvY29uc3RhbnRzLmpzIiwKICAgICIuL2Vycm9ycyI6ICIuL2xpYi9lcnJvcnMuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgIndlYi5qcyIsCiAgICAid2ViLmQudHMiLAogICAgImdsb2JhbC5qcyIsCiAgICAiZ2xvYmFsLmQudHMiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1jcnlwdG8uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1jcnlwdG8vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWNyeXB0byNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1zdHJlYW0iOiAiXjIuNi4zIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICJeMy4wLjEiLAogICAgImJyaXR0bGUiOiAiXjMuNS4wIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNiIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy40LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWJ1ZmZlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCcuJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKY29uc3QgQ3J5cHRvS2V5ID0gcmVxdWlyZSgnLi9saWIvd2ViL2NyeXB0by1rZXknKQpjb25zdCBobWFjID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9obWFjJykKY29uc3QgcGJrZGYyID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9wYmtkZjInKQpjb25zdCBlZDI1NTE5ID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9lZDI1NTE5JykKY29uc3Qgc2hhID0gcmVxdWlyZSgnLi9saWIvd2ViL2FsZ29yaXRobS9zaGEnKQoKZXhwb3J0cy5DcnlwdG9LZXkgPSBDcnlwdG9LZXkKCi8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI0NyeXB0by1tZXRob2QtZ2V0UmFuZG9tVmFsdWVzCmV4cG9ydHMuZ2V0UmFuZG9tVmFsdWVzID0gZnVuY3Rpb24gZ2V0UmFuZG9tVmFsdWVzKGFycmF5KSB7CiAgcmV0dXJuIGNyeXB0by5yYW5kb21GaWxsU3luYyhhcnJheSkKfQoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jZGZuLUNyeXB0by1tZXRob2QtcmFuZG9tVVVJRApleHBvcnRzLnJhbmRvbVVVSUQgPSBjcnlwdG8ucmFuZG9tVVVJRAoKLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jc3VidGxlY3J5cHRvLWludGVyZmFjZQpleHBvcnRzLlN1YnRsZUNyeXB0byA9IGNsYXNzIFN1YnRsZUNyeXB0byB7CiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1nZW5lcmF0ZUtleQogIGFzeW5jIGdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykgewogICAgaWYgKHR5cGVvZiBhbGdvcml0aG0gPT09ICdzdHJpbmcnKSBhbGdvcml0aG0gPSB7IG5hbWU6IGFsZ29yaXRobSB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIHJldHVybiBobWFjLmdlbmVyYXRlS2V5KGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgcmV0dXJuIGVkMjU1MTkuZ2VuZXJhdGVLZXkoYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGdlbmVyYXRlS2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtaW1wb3J0S2V5CiAgYXN5bmMgaW1wb3J0S2V5KGZvcm1hdCwga2V5RGF0YSwgYWxnb3JpdGhtLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBzd2l0Y2ggKGZvcm1hdCkgewogICAgICBjYXNlICdyYXcnOgogICAgICBjYXNlICdwa2NzOCc6CiAgICAgIGNhc2UgJ3Nwa2knOgogICAgICAgIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoa2V5RGF0YSkpIHsKICAgICAgICAgIGtleURhdGEgPSBCdWZmZXIuZnJvbShrZXlEYXRhKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZXlEYXRhID0gQnVmZmVyLmZyb20oa2V5RGF0YS5zbGljZSgpKQogICAgICAgIH0KICAgICAgICBicmVhawogICAgfQoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICByZXR1cm4gaG1hYy5pbXBvcnRLZXkoZm9ybWF0LCBrZXlEYXRhLCBhbGdvcml0aG0sIGV4dHJhY3RhYmxlLCB1c2FnZXMpCiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIHJldHVybiBlZDI1NTE5LmltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgY2FzZSAncGJrZGYyJzoKICAgICAgICByZXR1cm4gcGJrZGYyLmltcG9ydEtleShmb3JtYXQsIGtleURhdGEsIGFsZ29yaXRobSwgZXh0cmFjdGFibGUsIHVzYWdlcykKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBpbXBvcnRLZXkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1leHBvcnRLZXkKICBhc3luYyBleHBvcnRLZXkoZm9ybWF0LCBrZXkpIHsKICAgIGlmICgha2V5LmV4dHJhY3RhYmxlKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnS2V5IGlzIG5vdCBleHRyYWN0YWJsZScpCiAgICB9CgogICAgc3dpdGNoIChrZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdobWFjJzoKICAgICAgICByZXR1cm4gaG1hYy5leHBvcnRLZXkoZm9ybWF0LCBrZXkpCiAgICAgIGNhc2UgJ2VkMjU1MTknOgogICAgICAgIHJldHVybiBlZDI1NTE5LmV4cG9ydEtleShmb3JtYXQsIGtleSkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7a2V5LmFsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZXhwb3J0S2V5KCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2Qtc2lnbgogIGFzeW5jIHNpZ24oYWxnb3JpdGhtLCBrZXksIGRhdGEpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIGlmIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpICE9PSBrZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IG1hdGNoIGtleSdgKQogICAgfQoKICAgIGlmICgha2V5LnVzYWdlcy5pbmNsdWRlcygnc2lnbicpKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0FDQ0VTUygnS2V5IGNhbm5vdCBiZSB1c2VkIGZvciBzaWduaW5nJykKICAgIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgcmV0dXJuIGhtYWMuc2lnbihhbGdvcml0aG0sIGtleSwgZGF0YSkKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgcmV0dXJuIGVkMjU1MTkuc2lnbihhbGdvcml0aG0sIGtleSwgZGF0YSkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSBzaWduKCkgb3BlcmF0aW9uYAogICAgICAgICkKICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJjcnlwdG8vI1N1YnRsZUNyeXB0by1tZXRob2QtdmVyaWZ5CiAgYXN5bmMgdmVyaWZ5KGFsZ29yaXRobSwga2V5LCBzaWduYXR1cmUsIGRhdGEpIHsKICAgIGlmICh0eXBlb2YgYWxnb3JpdGhtID09PSAnc3RyaW5nJykgYWxnb3JpdGhtID0geyBuYW1lOiBhbGdvcml0aG0gfQoKICAgIGlmIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpICE9PSBrZXkuYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IG1hdGNoIGtleSdgKQogICAgfQoKICAgIGlmICgha2V5LnVzYWdlcy5pbmNsdWRlcygndmVyaWZ5JykpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKCdLZXkgY2Fubm90IGJlIHVzZWQgZm9yIHZlcmlmaWNhdGlvbicpCiAgICB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2htYWMnOgogICAgICAgIHJldHVybiBobWFjLnZlcmlmeShhbGdvcml0aG0sIGtleSwgc2lnbmF0dXJlLCBkYXRhKQogICAgICBjYXNlICdlZDI1NTE5JzoKICAgICAgICByZXR1cm4gZWQyNTUxOS52ZXJpZnkoYWxnb3JpdGhtLCBrZXksIHNpZ25hdHVyZSwgZGF0YSkKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBzdXBwb3J0IHRoZSB2ZXJpZnkoKSBvcGVyYXRpb25gCiAgICAgICAgKQogICAgfQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1kZXJpdmVCaXRzCiAgYXN5bmMgZGVyaXZlQml0cyhhbGdvcml0aG0sIGtleSwgbGVuZ3RoKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBpZiAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSAhPT0ga2V5LmFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBtYXRjaCBrZXknYCkKICAgIH0KCiAgICBpZiAoIWtleS51c2FnZXMuaW5jbHVkZXMoJ2Rlcml2ZUJpdHMnKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ0tleSBjYW5ub3QgYmUgdXNlZCB0byBkZXJpdmUgYml0cycpCiAgICB9CgogICAgc3dpdGNoIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ3Bia2RmMic6CiAgICAgICAgcmV0dXJuIHBia2RmMi5kZXJpdmVCaXRzKGFsZ29yaXRobSwga2V5LCBsZW5ndGgpCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZGVyaXZlQml0cygpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQoKICAvLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNTdWJ0bGVDcnlwdG8tbWV0aG9kLWRlcml2ZUtleQogIGFzeW5jIGRlcml2ZUtleShhbGdvcml0aG0sIGJhc2VLZXksIGRlcml2ZWRLZXlUeXBlLCBleHRyYWN0YWJsZSwgdXNhZ2VzKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBpZiAodHlwZW9mIGRlcml2ZWRLZXlUeXBlID09PSAnc3RyaW5nJykgewogICAgICBkZXJpdmVkS2V5VHlwZSA9IHsgbmFtZTogZGVyaXZlZEtleVR5cGUgfQogICAgfQoKICAgIGlmIChhbGdvcml0aG0ubmFtZS50b0xvd2VyQ2FzZSgpICE9PSBiYXNlS2V5LmFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgdGhyb3cgZXJyb3JzLklOVkFMSURfQUNDRVNTKGBBbGdvcml0aG0gJyR7YWxnb3JpdGhtLm5hbWV9JyBkb2VzIG5vdCBtYXRjaCBrZXknYCkKICAgIH0KCiAgICBpZiAoIWJhc2VLZXkudXNhZ2VzLmluY2x1ZGVzKCdkZXJpdmVLZXknKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9BQ0NFU1MoJ0tleSBjYW5ub3QgYmUgdXNlZCB0byBkZXJpdmUga2V5JykKICAgIH0KCiAgICBsZXQgbGVuZ3RoCgogICAgc3dpdGNoIChkZXJpdmVkS2V5VHlwZS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaG1hYyc6CiAgICAgICAgbGVuZ3RoID0gaG1hYy5nZXRLZXlMZW5ndGgoZGVyaXZlZEtleVR5cGUpCiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuTk9UX1NVUFBPUlRFRCgKICAgICAgICAgIGBBbGdvcml0aG0gJyR7ZGVyaXZlZEtleVR5cGUubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGdldEtleUxlbmd0aCgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CgogICAgbGV0IHNlY3JldAoKICAgIHN3aXRjaCAoYWxnb3JpdGhtLm5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdwYmtkZjInOgogICAgICAgIHNlY3JldCA9IHBia2RmMi5kZXJpdmVCaXRzKGFsZ29yaXRobSwgYmFzZUtleSwgbGVuZ3RoKQogICAgICAgIGJyZWFrCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgZXJyb3JzLk5PVF9TVVBQT1JURUQoCiAgICAgICAgICBgQWxnb3JpdGhtICcke2FsZ29yaXRobS5uYW1lfScgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZGVyaXZlQml0cygpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CgogICAgcmV0dXJuIHRoaXMuaW1wb3J0S2V5KCdyYXcnLCBzZWNyZXQsIGRlcml2ZWRLZXlUeXBlLCBleHRyYWN0YWJsZSwgdXNhZ2VzKQogIH0KCiAgLy8gaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmNyeXB0by8jU3VidGxlQ3J5cHRvLW1ldGhvZC1kaWdlc3QKICBhc3luYyBkaWdlc3QoYWxnb3JpdGhtLCBkYXRhKSB7CiAgICBpZiAodHlwZW9mIGFsZ29yaXRobSA9PT0gJ3N0cmluZycpIGFsZ29yaXRobSA9IHsgbmFtZTogYWxnb3JpdGhtIH0KCiAgICBzd2l0Y2ggKGFsZ29yaXRobS5uYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnc2hhLTEnOgogICAgICAgIHJldHVybiBzaGEuZGlnZXN0KCdzaGExJywgZGF0YSkKICAgICAgY2FzZSAnc2hhLTI1Nic6CiAgICAgICAgcmV0dXJuIHNoYS5kaWdlc3QoJ3NoYTI1NicsIGRhdGEpCiAgICAgIGNhc2UgJ3NoYS01MTInOgogICAgICAgIHJldHVybiBzaGEuZGlnZXN0KCdzaGE1MTInLCBkYXRhKQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IGVycm9ycy5OT1RfU1VQUE9SVEVEKAogICAgICAgICAgYEFsZ29yaXRobSAnJHthbGdvcml0aG0ubmFtZX0nIGRvZXMgbm90IHN1cHBvcnQgdGhlIGRpZ2VzdCgpIG9wZXJhdGlvbmAKICAgICAgICApCiAgICB9CiAgfQp9CgpleHBvcnRzLnN1YnRsZSA9IG5ldyBleHBvcnRzLlN1YnRsZUNyeXB0bygpCgovLyBodHRwczovL3czYy5naXRodWIuaW8vd2ViY3J5cHRvLyNjcnlwdG8taW50ZXJmYWNlCmV4cG9ydHMuQ3J5cHRvID0gY2xhc3MgQ3J5cHRvIHsKICBnZXQgc3VidGxlKCkgewogICAgcmV0dXJuIGV4cG9ydHMuc3VidGxlCiAgfQoKICBnZXRSYW5kb21WYWx1ZXMoYXJyYXkpIHsKICAgIHJldHVybiBleHBvcnRzLmdldFJhbmRvbVZhbHVlcyhhcnJheSkKICB9CgogIHJhbmRvbVVVSUQoKSB7CiAgICByZXR1cm4gZXhwb3J0cy5yYW5kb21VVUlEKCkKICB9Cn0KY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKCmNsYXNzIEV2ZW50TGlzdGVuZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5saXN0ID0gW10KICAgIHRoaXMuY291bnQgPSAwCiAgfQoKICBhcHBlbmQoY3R4LCBuYW1lLCBmbiwgb25jZSkgewogICAgdGhpcy5jb3VudCsrCiAgICBjdHguZW1pdCgnbmV3TGlzdGVuZXInLCBuYW1lLCBmbikgLy8gRW1pdCBCRUZPUkUgYWRkaW5nCiAgICB0aGlzLmxpc3QucHVzaChbZm4sIG9uY2VdKQogIH0KCiAgcHJlcGVuZChjdHgsIG5hbWUsIGZuLCBvbmNlKSB7CiAgICB0aGlzLmNvdW50KysKICAgIGN0eC5lbWl0KCduZXdMaXN0ZW5lcicsIG5hbWUsIGZuKSAvLyBFbWl0IEJFRk9SRSBhZGRpbmcKICAgIHRoaXMubGlzdC51bnNoaWZ0KFtmbiwgb25jZV0pCiAgfQoKICByZW1vdmUoY3R4LCBuYW1lLCBmbikgewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0aGlzLmxpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmxpc3RbaV0KCiAgICAgIGlmIChsWzBdID09PSBmbikgewogICAgICAgIHRoaXMubGlzdC5zcGxpY2UoaSwgMSkKCiAgICAgICAgaWYgKHRoaXMuY291bnQgPT09IDEpIGRlbGV0ZSBjdHguX2V2ZW50c1tuYW1lXQoKICAgICAgICBjdHguZW1pdCgncmVtb3ZlTGlzdGVuZXInLCBuYW1lLCBmbikgLy8gRW1pdCBBRlRFUiByZW1vdmluZwoKICAgICAgICB0aGlzLmNvdW50LS0KICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQogIH0KCiAgcmVtb3ZlQWxsKGN0eCwgbmFtZSkgewogICAgY29uc3QgbGlzdCA9IFsuLi50aGlzLmxpc3RdCiAgICB0aGlzLmxpc3QgPSBbXQoKICAgIGlmICh0aGlzLmNvdW50ID09PSBsaXN0Lmxlbmd0aCkgZGVsZXRlIGN0eC5fZXZlbnRzW25hbWVdCgogICAgZm9yIChsZXQgaSA9IGxpc3QubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY3R4LmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgbmFtZSwgbGlzdFtpXVswXSkgLy8gRW1pdCBBRlRFUiByZW1vdmluZwogICAgfQoKICAgIHRoaXMuY291bnQgLT0gbGlzdC5sZW5ndGgKICB9CgogIGVtaXQoY3R4LCBuYW1lLCAuLi5hcmdzKSB7CiAgICBjb25zdCBsaXN0ID0gWy4uLnRoaXMubGlzdF0KCiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGxpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGwgPSBsaXN0W2ldCgogICAgICBpZiAobFsxXSA9PT0gdHJ1ZSkgdGhpcy5yZW1vdmUoY3R4LCBuYW1lLCBsWzBdKQoKICAgICAgUmVmbGVjdC5hcHBseShsWzBdLCBjdHgsIGFyZ3MpCiAgICB9CgogICAgcmV0dXJuIGxpc3QubGVuZ3RoID4gMAogIH0KfQoKZnVuY3Rpb24gYXBwZW5kTGlzdGVuZXIoY3R4LCBuYW1lLCBmbiwgb25jZSkgewogIGlmIChjdHguX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSBjdHguX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCkKICBjb25zdCBlID0gY3R4Ll9ldmVudHNbbmFtZV0gfHwgKGN0eC5fZXZlbnRzW25hbWVdID0gbmV3IEV2ZW50TGlzdGVuZXIoKSkKICBlLmFwcGVuZChjdHgsIG5hbWUsIGZuLCBvbmNlKQogIHJldHVybiBjdHgKfQoKZnVuY3Rpb24gcHJlcGVuZExpc3RlbmVyKGN0eCwgbmFtZSwgZm4sIG9uY2UpIHsKICBpZiAoY3R4Ll9ldmVudHMgPT09IHVuZGVmaW5lZCkgY3R4Ll9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpCiAgY29uc3QgZSA9IGN0eC5fZXZlbnRzW25hbWVdIHx8IChjdHguX2V2ZW50c1tuYW1lXSA9IG5ldyBFdmVudExpc3RlbmVyKCkpCiAgZS5wcmVwZW5kKGN0eCwgbmFtZSwgZm4sIG9uY2UpCiAgcmV0dXJuIGN0eAp9CgpmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihjdHgsIG5hbWUsIGZuKSB7CiAgaWYgKGN0eC5fZXZlbnRzID09PSB1bmRlZmluZWQpIHJldHVybiBjdHgKICBjb25zdCBlID0gY3R4Ll9ldmVudHNbbmFtZV0KICBpZiAoZSAhPT0gdW5kZWZpbmVkKSBlLnJlbW92ZShjdHgsIG5hbWUsIGZuKQogIHJldHVybiBjdHgKfQoKZnVuY3Rpb24gdGhyb3dVbmhhbmRsZWRFcnJvciguLi5hcmdzKSB7CiAgbGV0IGVycgoKICBpZiAoYXJncy5sZW5ndGggPiAwKSBlcnIgPSBhcmdzWzBdCgogIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvciA9PT0gZmFsc2UpIGVyciA9IGVycm9ycy5VTkhBTkRMRURfRVJST1IoZXJyKQoKICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKGVyciwgZXhwb3J0cy5wcm90b3R5cGUuZW1pdCkKICB9CgogIHF1ZXVlTWljcm90YXNrKCgpID0+IHsKICAgIHRocm93IGVycgogIH0pCn0KCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGNsYXNzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpCiAgfQoKICBhZGRMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIGFwcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCBmYWxzZSkKICB9CgogIGFkZE9uY2VMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIGFwcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCB0cnVlKQogIH0KCiAgcHJlcGVuZExpc3RlbmVyKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gcHJlcGVuZExpc3RlbmVyKHRoaXMsIG5hbWUsIGZuLCBmYWxzZSkKICB9CgogIHByZXBlbmRPbmNlTGlzdGVuZXIobmFtZSwgZm4pIHsKICAgIHJldHVybiBwcmVwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIHRydWUpCiAgfQoKICByZW1vdmVMaXN0ZW5lcihuYW1lLCBmbikgewogICAgcmV0dXJuIHJlbW92ZUxpc3RlbmVyKHRoaXMsIG5hbWUsIGZuKQogIH0KCiAgb24obmFtZSwgZm4pIHsKICAgIHJldHVybiBhcHBlbmRMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbiwgZmFsc2UpCiAgfQoKICBvbmNlKG5hbWUsIGZuKSB7CiAgICByZXR1cm4gYXBwZW5kTGlzdGVuZXIodGhpcywgbmFtZSwgZm4sIHRydWUpCiAgfQoKICBvZmYobmFtZSwgZm4pIHsKICAgIHJldHVybiByZW1vdmVMaXN0ZW5lcih0aGlzLCBuYW1lLCBmbikKICB9CgogIGVtaXQobmFtZSwgLi4uYXJncykgewogICAgaWYgKG5hbWUgPT09ICdlcnJvcicgJiYgdGhpcy5fZXZlbnRzICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fZXZlbnRzLmVycm9yID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3dVbmhhbmRsZWRFcnJvciguLi5hcmdzKQogICAgfQoKICAgIGlmICh0aGlzLl9ldmVudHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlCiAgICBjb25zdCBlID0gdGhpcy5fZXZlbnRzW25hbWVdCiAgICByZXR1cm4gZSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBlLmVtaXQodGhpcywgbmFtZSwgLi4uYXJncykKICB9CgogIGxpc3RlbmVycyhuYW1lKSB7CiAgICBpZiAodGhpcy5fZXZlbnRzID09PSB1bmRlZmluZWQpIHJldHVybiBbXQogICAgY29uc3QgZSA9IHRoaXMuX2V2ZW50c1tuYW1lXQogICAgcmV0dXJuIGUgPT09IHVuZGVmaW5lZCA/IFtdIDogWy4uLmUubGlzdF0KICB9CgogIGxpc3RlbmVyQ291bnQobmFtZSkgewogICAgaWYgKHRoaXMuX2V2ZW50cyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gMAogICAgY29uc3QgZSA9IHRoaXMuX2V2ZW50c1tuYW1lXQogICAgcmV0dXJuIGUgPT09IHVuZGVmaW5lZCA/IDAgOiBlLmxpc3QubGVuZ3RoCiAgfQoKICBnZXRNYXhMaXN0ZW5lcnMoKSB7CiAgICByZXR1cm4gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnMKICB9CgogIHNldE1heExpc3RlbmVycyhuKSB7fQoKICByZW1vdmVBbGxMaXN0ZW5lcnMobmFtZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2YgUmVmbGVjdC5vd25LZXlzKHRoaXMuX2V2ZW50cykpIHsKICAgICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZQogICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSkKICAgICAgfQogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygncmVtb3ZlTGlzdGVuZXInKQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgZSA9IHRoaXMuX2V2ZW50c1tuYW1lXQogICAgICBpZiAoZSAhPT0gdW5kZWZpbmVkKSBlLnJlbW92ZUFsbCh0aGlzLCBuYW1lKQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9Cn0KCmV4cG9ydHMuRXZlbnRFbWl0dGVyID0gZXhwb3J0cwoKZXhwb3J0cy5lcnJvcnMgPSBlcnJvcnMKCmV4cG9ydHMuZGVmYXVsdE1heExpc3RlbmVycyA9IDEwCgpleHBvcnRzLm9uID0gZnVuY3Rpb24gb24oZW1pdHRlciwgbmFtZSwgb3B0cyA9IHt9KSB7CiAgY29uc3QgeyBzaWduYWwgfSA9IG9wdHMKCiAgaWYgKHNpZ25hbCAmJiBzaWduYWwuYWJvcnRlZCkgewogICAgdGhyb3cgZXJyb3JzLk9QRVJBVElPTl9BQk9SVEVEKHNpZ25hbC5yZWFzb24pCiAgfQoKICBsZXQgZXJyb3IgPSBudWxsCiAgbGV0IGRvbmUgPSBmYWxzZQoKICBjb25zdCBldmVudHMgPSBbXQogIGNvbnN0IHByb21pc2VzID0gW10KCiAgaWYgKG5hbWUgIT09ICdlcnJvcicpIGVtaXR0ZXIub24oJ2Vycm9yJywgb25lcnJvcikKCiAgaWYgKHNpZ25hbCkgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgZW1pdHRlci5vbihuYW1lLCBvbmV2ZW50KQoKICByZXR1cm4gewogICAgbmV4dCgpIHsKICAgICAgaWYgKGV2ZW50cy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgdmFsdWU6IGV2ZW50cy5zaGlmdCgpLCBkb25lOiBmYWxzZSB9KQogICAgICB9CgogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICBjb25zdCBlcnIgPSBlcnJvcgoKICAgICAgICBlcnJvciA9IG51bGwKCiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICAgICAgfQoKICAgICAgaWYgKGRvbmUpIHJldHVybiBvbmNsb3NlKCkKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiBwcm9taXNlcy5wdXNoKHsgcmVzb2x2ZSwgcmVqZWN0IH0pKQogICAgfSwKCiAgICByZXR1cm4oKSB7CiAgICAgIHJldHVybiBvbmNsb3NlKCkKICAgIH0sCgogICAgdGhyb3coZXJyKSB7CiAgICAgIHJldHVybiBvbmVycm9yKGVycikKICAgIH0sCgogICAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uZXZlbnQoLi4uYXJncykgewogICAgaWYgKHByb21pc2VzLmxlbmd0aCkgewogICAgICBwcm9taXNlcy5zaGlmdCgpLnJlc29sdmUoeyB2YWx1ZTogYXJncywgZG9uZTogZmFsc2UgfSkKICAgIH0gZWxzZSB7CiAgICAgIGV2ZW50cy5wdXNoKGFyZ3MpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgZW1pdHRlci5vZmYobmFtZSwgb25ldmVudCkub2ZmKCdlcnJvcicsIG9uZXJyb3IpCgogICAgaWYgKHByb21pc2VzLmxlbmd0aCkgewogICAgICBwcm9taXNlcy5zaGlmdCgpLnJlamVjdChlcnIpCiAgICB9IGVsc2UgewogICAgICBlcnJvciA9IGVycgogICAgfQoKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBkb25lOiB0cnVlIH0pCiAgfQoKICBmdW5jdGlvbiBvbmFib3J0KCkgewogICAgc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgICBvbmVycm9yKGVycm9ycy5PUEVSQVRJT05fQUJPUlRFRChzaWduYWwucmVhc29uKSkKICB9CgogIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICBlbWl0dGVyLm9mZihuYW1lLCBvbmV2ZW50KQoKICAgIGlmIChuYW1lICE9PSAnZXJyb3InKSBlbWl0dGVyLm9mZignZXJyb3InLCBvbmVycm9yKQoKICAgIGlmIChzaWduYWwpIHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgZG9uZSA9IHRydWUKCiAgICBpZiAocHJvbWlzZXMubGVuZ3RoKSBwcm9taXNlcy5zaGlmdCgpLnJlc29sdmUoeyBkb25lOiB0cnVlIH0pCgogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRvbmU6IHRydWUgfSkKICB9Cn0KCmV4cG9ydHMub25jZSA9IGZ1bmN0aW9uIG9uY2UoZW1pdHRlciwgbmFtZSwgb3B0cyA9IHt9KSB7CiAgY29uc3QgeyBzaWduYWwgfSA9IG9wdHMKCiAgaWYgKHNpZ25hbCAmJiBzaWduYWwuYWJvcnRlZCkgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9ycy5PUEVSQVRJT05fQUJPUlRFRChzaWduYWwucmVhc29uKSkKICB9CgogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBpZiAobmFtZSAhPT0gJ2Vycm9yJykgZW1pdHRlci5vbignZXJyb3InLCBvbmVycm9yKQoKICAgIGlmIChzaWduYWwpIHNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgZW1pdHRlci5vbmNlKG5hbWUsIG9uZXZlbnQpCgogICAgZnVuY3Rpb24gb25ldmVudCguLi5hcmdzKSB7CiAgICAgIGlmIChuYW1lICE9PSAnZXJyb3InKSBlbWl0dGVyLm9mZignZXJyb3InLCBvbmVycm9yKQoKICAgICAgaWYgKHNpZ25hbCkgc2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Fib3J0Jywgb25hYm9ydCkKCiAgICAgIHJlc29sdmUoYXJncykKICAgIH0KCiAgICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgICBlbWl0dGVyLm9mZihuYW1lLCBvbmV2ZW50KQoKICAgICAgaWYgKG5hbWUgIT09ICdlcnJvcicpIGVtaXR0ZXIub2ZmKCdlcnJvcicsIG9uZXJyb3IpCgogICAgICByZWplY3QoZXJyKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uYWJvcnQoKSB7CiAgICAgIHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCdhYm9ydCcsIG9uYWJvcnQpCgogICAgICBvbmVycm9yKGVycm9ycy5PUEVSQVRJT05fQUJPUlRFRChzaWduYWwucmVhc29uKSkKICAgIH0KICB9KQp9CgpleHBvcnRzLmZvcndhcmQgPSBmdW5jdGlvbiBmb3J3YXJkKGZyb20sIHRvLCBuYW1lcywgb3B0cyA9IHt9KSB7CiAgaWYgKHR5cGVvZiBuYW1lcyA9PT0gJ3N0cmluZycpIG5hbWVzID0gW25hbWVzXQoKICBjb25zdCB7IGVtaXQgPSB0by5lbWl0LmJpbmQodG8pIH0gPSBvcHRzCgogIGNvbnN0IGxpc3RlbmVycyA9IG5hbWVzLm1hcCgKICAgIChuYW1lKSA9PgogICAgICBmdW5jdGlvbiBvbmV2ZW50KC4uLmFyZ3MpIHsKICAgICAgICBlbWl0KG5hbWUsIC4uLmFyZ3MpCiAgICAgIH0KICApCgogIHRvLm9uKCduZXdMaXN0ZW5lcicsIChuYW1lKSA9PiB7CiAgICBjb25zdCBpID0gbmFtZXMuaW5kZXhPZihuYW1lKQoKICAgIGlmIChpICE9PSAtMSAmJiB0by5saXN0ZW5lckNvdW50KG5hbWUpID09PSAwKSB7CiAgICAgIGZyb20ub24obmFtZSwgbGlzdGVuZXJzW2ldKQogICAgfQogIH0pLm9uKCdyZW1vdmVMaXN0ZW5lcicsIChuYW1lKSA9PiB7CiAgICBjb25zdCBpID0gbmFtZXMuaW5kZXhPZihuYW1lKQoKICAgIGlmIChpICE9PSAtMSAmJiB0by5saXN0ZW5lckNvdW50KG5hbWUpID09PSAwKSB7CiAgICAgIGZyb20ub2ZmKG5hbWUsIGxpc3RlbmVyc1tpXSkKICAgIH0KICB9KQp9CgpleHBvcnRzLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGVtaXR0ZXIsIG5hbWUpIHsKICByZXR1cm4gZW1pdHRlci5saXN0ZW5lckNvdW50KG5hbWUpCn0KCmV4cG9ydHMuZ2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24gZ2V0TWF4TGlzdGVuZXJzKGVtaXR0ZXIpIHsKICBpZiAodHlwZW9mIGVtaXR0ZXIuZ2V0TWF4TGlzdGVuZXJzID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gZW1pdHRlci5nZXRNYXhMaXN0ZW5lcnMoKQogIH0KCiAgcmV0dXJuIGV4cG9ydHMuZGVmYXVsdE1heExpc3RlbmVycwp9CgpleHBvcnRzLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIHNldE1heExpc3RlbmVycyhuLCAuLi5lbWl0dGVycykgewogIGlmIChlbWl0dGVycy5sZW5ndGggPT09IDApIGV4cG9ydHMuZGVmYXVsdE1heExpc3RlbmVycyA9IG4KICBlbHNlIHsKICAgIGZvciAoY29uc3QgZW1pdHRlciBvZiBlbWl0dGVycykgewogICAgICBpZiAodHlwZW9mIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMobikKICAgICAgfQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEV2ZW50RW1pdHRlckVycm9yIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1zZywgY29kZSwgZm4gPSBFdmVudEVtaXR0ZXJFcnJvciwgb3B0cykgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWAsIG9wdHMpCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ0V2ZW50RW1pdHRlckVycm9yJwogIH0KCiAgc3RhdGljIE9QRVJBVElPTl9BQk9SVEVEKGNhdXNlLCBtc2cgPSAnT3BlcmF0aW9uIGFib3J0ZWQnKSB7CiAgICByZXR1cm4gbmV3IEV2ZW50RW1pdHRlckVycm9yKG1zZywgJ09QRVJBVElPTl9BQk9SVEVEJywgRXZlbnRFbWl0dGVyRXJyb3IuT1BFUkFUSU9OX0FCT1JURUQsIHsKICAgICAgY2F1c2UKICAgIH0pCiAgfQoKICBzdGF0aWMgVU5IQU5ETEVEX0VSUk9SKGNhdXNlLCBtc2cgPSAnVW5oYW5kbGVkIGVycm9yJykgewogICAgcmV0dXJuIG5ldyBFdmVudEVtaXR0ZXJFcnJvcihtc2csICdVTkhBTkRMRURfRVJST1InLCBFdmVudEVtaXR0ZXJFcnJvci5VTkhBTkRMRURfRVJST1IsIHsKICAgICAgY2F1c2UKICAgIH0pCiAgfQp9CnsKICAibmFtZSI6ICJiYXJlLWV2ZW50cyIsCiAgInZlcnNpb24iOiAiMi44LjIiLAogICJkZXNjcmlwdGlvbiI6ICJFdmVudCBlbWl0dGVycyBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9nbG9iYWwiOiB7CiAgICAgICJ0eXBlcyI6ICIuL2dsb2JhbC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9nbG9iYWwuanMiCiAgICB9LAogICAgIi4vd2ViIjogewogICAgICAidHlwZXMiOiAiLi93ZWIuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vd2ViLmpzIgogICAgfSwKICAgICIuL2Vycm9ycyI6ICIuL2xpYi9lcnJvcnMuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgImdsb2JhbC5qcyIsCiAgICAiZ2xvYmFsLmQudHMiLAogICAgIndlYi5qcyIsCiAgICAid2ViLmQudHMiLAogICAgImxpYiIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0LmpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0LmpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC4gLS1jaGVjayIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWV2ZW50cy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWV2ZW50cy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtZXZlbnRzI3JlYWRtZSIsCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWFib3J0LWNvbnRyb2xsZXIiOiAiXjEuMC4wIiwKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAidW5jYXVnaHRzIjogIl4xLjEuMSIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYWJvcnQtY29udHJvbGxlciI6ICIqIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgImJhcmUtYWJvcnQtY29udHJvbGxlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oKQpjb25zdCBGSUZPID0gcmVxdWlyZSgnZmFzdC1maWZvJykKY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnYmFyZS1ldmVudHMnKQpjb25zdCBwYXRoID0gcmVxdWlyZSgnYmFyZS1wYXRoJykKY29uc3QgeyBmaWxlVVJMVG9QYXRoIH0gPSByZXF1aXJlKCdiYXJlLXVybCcpCmNvbnN0IHsgUmVhZGFibGUsIFdyaXRhYmxlIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2xpYi9jb25zdGFudHMnKQpjb25zdCBGaWxlRXJyb3IgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQoKY29uc3QgaXNXaW5kb3dzID0gQmFyZS5wbGF0Zm9ybSA9PT0gJ3dpbjMyJwoKZXhwb3J0cy5jb25zdGFudHMgPSBjb25zdGFudHMKCmNsYXNzIEZpbGVSZXF1ZXN0IHsKICBzdGF0aWMgX2ZyZWUgPSBbXQoKICBzdGF0aWMgYm9ycm93KCkgewogICAgaWYgKHRoaXMuX2ZyZWUubGVuZ3RoID4gMCkgcmV0dXJuIHRoaXMuX2ZyZWUucG9wKCkKICAgIHJldHVybiBuZXcgRmlsZVJlcXVlc3QoKQogIH0KCiAgc3RhdGljIHJldHVybihyZXEpIHsKICAgIGlmICh0aGlzLl9mcmVlLmxlbmd0aCA8IDMyKSB0aGlzLl9mcmVlLnB1c2gocmVxLnJlc2V0KCkpCiAgICBlbHNlIHJlcS5kZXN0cm95KCkKICB9CgogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fcmVzZXQoKQogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5yZXF1ZXN0SW5pdCh0aGlzLCB0aGlzLl9vbnJlc3VsdCkKICB9CgogIGdldCBoYW5kbGUoKSB7CiAgICByZXR1cm4gdGhpcy5faGFuZGxlCiAgfQoKICByZXRhaW4odmFsdWUpIHsKICAgIHRoaXMuX3JldGFpbiA9IHZhbHVlIC8vIFRpZSB0aGUgbGlmZXRpbWUgb2YgYHZhbHVlYCB0byB0aGUgbGlmZXRpbWUgb2YgYHRoaXNgCiAgfQoKICByZXNldCgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIHJldHVybiB0aGlzCgogICAgYmluZGluZy5yZXF1ZXN0UmVzZXQodGhpcy5faGFuZGxlKQoKICAgIHRoaXMuX3Jlc2V0KCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IG51bGwpIHJldHVybiB0aGlzCgogICAgYmluZGluZy5yZXF1ZXN0RGVzdHJveSh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5fcmVzZXQoKQogICAgdGhpcy5faGFuZGxlID0gbnVsbAoKICAgIHJldHVybiB0aGlzCiAgfQoKICB0aGVuKHJlc29sdmUsIHJlamVjdCkgewogICAgcmV0dXJuIHRoaXMuX3Byb21pc2UudGhlbihyZXNvbHZlLCByZWplY3QpCiAgfQoKICByZXR1cm4oKSB7CiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSByZXR1cm4gdGhpcwoKICAgIEZpbGVSZXF1ZXN0LnJldHVybih0aGlzKQoKICAgIHJldHVybiB0aGlzCiAgfQoKICBbU3ltYm9sLmRpc3Bvc2VdKCkgewogICAgdGhpcy5yZXR1cm4oKQogIH0KCiAgX3Jlc2V0KCkgewogICAgY29uc3QgeyBwcm9taXNlLCByZXNvbHZlLCByZWplY3QgfSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpCgogICAgdGhpcy5fcHJvbWlzZSA9IHByb21pc2UKICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgICB0aGlzLl9yZWplY3QgPSByZWplY3QKICAgIHRoaXMuX3JldGFpbiA9IG51bGwKICB9CgogIF9vbnJlc3VsdChlcnIsIHN0YXR1cykgewogICAgaWYgKGVycikgdGhpcy5fcmVqZWN0KGVycikKICAgIGVsc2UgdGhpcy5fcmVzb2x2ZShzdGF0dXMpCiAgfQp9CgpmdW5jdGlvbiBvayhyZXN1bHQsIGNiKSB7CiAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcmVzdWx0CiAgICByZXN1bHQgPSB1bmRlZmluZWQKICB9CgogIGlmIChjYikgY2IobnVsbCwgcmVzdWx0KQogIGVsc2UgcmV0dXJuIHJlc3VsdAp9CgpmdW5jdGlvbiBmYWlsKGVyciwgY2IpIHsKICBpZiAoY2IpIGNiKGVycikKICBlbHNlIHRocm93IGVycgp9CgpmdW5jdGlvbiBkb25lKGVyciwgcmVzdWx0LCBjYikgewogIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHJlc3VsdAogICAgcmVzdWx0ID0gdW5kZWZpbmVkCiAgfQoKICBpZiAoZXJyKSBmYWlsKGVyciwgY2IpCiAgZWxzZSByZXR1cm4gb2socmVzdWx0LCBjYikKfQoKYXN5bmMgZnVuY3Rpb24gb3BlbihmaWxlcGF0aCwgZmxhZ3MgPSAncicsIG1vZGUgPSAwbzY2NiwgY2IpIHsKICBpZiAodHlwZW9mIGZsYWdzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IGZsYWdzCiAgICBmbGFncyA9ICdyJwogICAgbW9kZSA9IDBvNjY2CiAgfSBlbHNlIGlmICh0eXBlb2YgbW9kZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBtb2RlCiAgICBtb2RlID0gMG82NjYKICB9CgogIGlmICh0eXBlb2YgZmxhZ3MgPT09ICdzdHJpbmcnKSBmbGFncyA9IHRvRmxhZ3MoZmxhZ3MpCiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBmZAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcub3BlbihyZXEuaGFuZGxlLCBmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpCgogICAgZmQgPSBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdvcGVuJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgZmQsIGNiKQp9CgpmdW5jdGlvbiBvcGVuU3luYyhmaWxlcGF0aCwgZmxhZ3MgPSAncicsIG1vZGUgPSAwbzY2NikgewogIGlmICh0eXBlb2YgZmxhZ3MgPT09ICdzdHJpbmcnKSBmbGFncyA9IHRvRmxhZ3MoZmxhZ3MpCiAgaWYgKHR5cGVvZiBtb2RlID09PSAnc3RyaW5nJykgbW9kZSA9IHRvTW9kZShtb2RlKQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy5vcGVuU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnb3BlbicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjbG9zZShmZCwgY2IpIHsKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmNsb3NlKHJlcS5oYW5kbGUsIGZkKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2Nsb3NlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gY2xvc2VTeW5jKGZkKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuY2xvc2VTeW5jKHJlcS5oYW5kbGUsIGZkKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2Nsb3NlJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gYWNjZXNzKGZpbGVwYXRoLCBtb2RlID0gY29uc3RhbnRzLkZfT0ssIGNiKSB7CiAgaWYgKHR5cGVvZiBtb2RlID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG1vZGUKICAgIG1vZGUgPSBjb25zdGFudHMuRl9PSwogIH0KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmFjY2VzcyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdhY2Nlc3MnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gYWNjZXNzU3luYyhmaWxlcGF0aCwgbW9kZSA9IGNvbnN0YW50cy5GX09LKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5hY2Nlc3NTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2FjY2VzcycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBleGlzdHMoZmlsZXBhdGgsIGNiKSB7CiAgbGV0IG9rID0gdHJ1ZQogIHRyeSB7CiAgICBhd2FpdCBhY2Nlc3MoZmlsZXBhdGgpCiAgfSBjYXRjaCB7CiAgICBvayA9IGZhbHNlCiAgfQoKICByZXR1cm4gZG9uZShudWxsLCBvaywgY2IpCn0KCmZ1bmN0aW9uIGV4aXN0c1N5bmMoZmlsZXBhdGgpIHsKICB0cnkgewogICAgYWNjZXNzU3luYyhmaWxlcGF0aCkKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZQogIH0KCiAgcmV0dXJuIHRydWUKfQoKYXN5bmMgZnVuY3Rpb24gcmVhZChmZCwgYnVmZmVyLCBvZmZzZXQgPSAwLCBsZW4gPSBidWZmZXIuYnl0ZUxlbmd0aCAtIG9mZnNldCwgcG9zID0gLTEsIGNiKSB7CiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgICBsZW4gPSBidWZmZXIuYnl0ZUxlbmd0aAogICAgcG9zID0gLTEKICB9IGVsc2UgaWYgKHR5cGVvZiBsZW4gPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbGVuCiAgICBsZW4gPSBidWZmZXIuYnl0ZUxlbmd0aCAtIG9mZnNldAogICAgcG9zID0gLTEKICB9IGVsc2UgaWYgKHR5cGVvZiBwb3MgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcG9zCiAgICBwb3MgPSAtMQogIH0KCiAgaWYgKHR5cGVvZiBwb3MgIT09ICdudW1iZXInKSBwb3MgPSAtMQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgYnl0ZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWQocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW4sIHBvcykKCiAgICBieXRlcyA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3JlYWQnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGJ5dGVzLCBjYikKfQoKZnVuY3Rpb24gcmVhZFN5bmMoZmQsIGJ1ZmZlciwgb2Zmc2V0ID0gMCwgbGVuID0gYnVmZmVyLmJ5dGVMZW5ndGggLSBvZmZzZXQsIHBvcyA9IC0xKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIHJldHVybiBiaW5kaW5nLnJlYWRTeW5jKHJlcS5oYW5kbGUsIGZkLCBidWZmZXIsIG9mZnNldCwgbGVuLCBwb3MpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAncmVhZCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWR2KGZkLCBidWZmZXJzLCBwb3MgPSAtMSwgY2IpIHsKICBpZiAodHlwZW9mIHBvcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBwb3MKICAgIHBvcyA9IC0xCiAgfQoKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBieXRlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhZHYocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKCiAgICBieXRlcyA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3JlYWR2JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBieXRlcywgY2IpCn0KCmZ1bmN0aW9uIHJlYWR2U3luYyhmZCwgYnVmZmVycywgcG9zID0gLTEpIHsKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy5yZWFkdlN5bmMocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdyZWFkdicsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHdyaXRlKGZkLCBkYXRhLCBvZmZzZXQgPSAwLCBsZW4sIHBvcyA9IC0xLCBjYikgewogIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgIGxldCBlbmNvZGluZyA9IGxlbgogICAgY2IgPSBwb3MKICAgIHBvcyA9IG9mZnNldAoKICAgIGlmICh0eXBlb2YgcG9zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gcG9zCiAgICAgIHBvcyA9IC0xCiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICB9CgogICAgaWYgKHR5cGVvZiBwb3MgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gcG9zCiAgICAgIHBvcyA9IC0xCiAgICB9CgogICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKQogICAgb2Zmc2V0ID0gMAogICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoCiAgfSBlbHNlIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9mZnNldAogICAgb2Zmc2V0ID0gMAogICAgbGVuID0gZGF0YS5ieXRlTGVuZ3RoCiAgICBwb3MgPSAtMQogIH0gZWxzZSBpZiAodHlwZW9mIGxlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBsZW4KICAgIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aCAtIG9mZnNldAogICAgcG9zID0gLTEKICB9IGVsc2UgaWYgKHR5cGVvZiBwb3MgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gcG9zCiAgICBwb3MgPSAtMQogIH0KCiAgaWYgKHR5cGVvZiBsZW4gIT09ICdudW1iZXInKSBsZW4gPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBieXRlcwogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcud3JpdGUocmVxLmhhbmRsZSwgZmQsIGRhdGEsIG9mZnNldCwgbGVuLCBwb3MpCgogICAgYnl0ZXMgPSBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICd3cml0ZScsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnl0ZXMsIGNiKQp9CgpmdW5jdGlvbiB3cml0ZVN5bmMoZmQsIGRhdGEsIG9mZnNldCA9IDAsIGxlbiwgcG9zID0gLTEpIHsKICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICBsZXQgZW5jb2RpbmcgPSBsZW4KICAgIHBvcyA9IG9mZnNldAoKICAgIGlmICh0eXBlb2YgcG9zID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IHBvcwogICAgICBwb3MgPSAtMQogICAgfQoKICAgIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykKICAgIG9mZnNldCA9IDAKICAgIGxlbiA9IGRhdGEuYnl0ZUxlbmd0aAogIH0KCiAgaWYgKHR5cGVvZiBsZW4gIT09ICdudW1iZXInKSBsZW4gPSBkYXRhLmJ5dGVMZW5ndGggLSBvZmZzZXQKICBpZiAodHlwZW9mIHBvcyAhPT0gJ251bWJlcicpIHBvcyA9IC0xCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICByZXR1cm4gYmluZGluZy53cml0ZVN5bmMocmVxLmhhbmRsZSwgZmQsIGRhdGEsIG9mZnNldCwgbGVuLCBwb3MpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnd3JpdGUnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB3cml0ZXYoZmQsIGJ1ZmZlcnMsIHBvcyA9IC0xLCBjYikgewogIGlmICh0eXBlb2YgcG9zID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHBvcwogICAgcG9zID0gLTEKICB9CgogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGJ5dGVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy53cml0ZXYocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKCiAgICBieXRlcyA9IGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ3dyaXRldicsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnl0ZXMsIGNiKQp9CgpmdW5jdGlvbiB3cml0ZXZTeW5jKGZkLCBidWZmZXJzLCBwb3MgPSAtMSkgewogIGlmICh0eXBlb2YgcG9zICE9PSAnbnVtYmVyJykgcG9zID0gLTEKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIHJldHVybiBiaW5kaW5nLndyaXRldlN5bmMocmVxLmhhbmRsZSwgZmQsIGJ1ZmZlcnMsIHBvcykKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICd3cml0ZXYnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBzdGF0KGZpbGVwYXRoLCBjYikgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHN0CiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5zdGF0KHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQoKICAgIHN0ID0gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnc3RhdCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIHN0LCBjYikKfQoKZnVuY3Rpb24gc3RhdFN5bmMoZmlsZXBhdGgpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnN0YXRTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIHJldHVybiBuZXcgU3RhdHMoLi4uYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RhdChyZXEuaGFuZGxlKSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdzdGF0JywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGxzdGF0KGZpbGVwYXRoLCBjYikgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHN0CiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5sc3RhdChyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICBzdCA9IG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2xzdGF0JywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgc3QsIGNiKQp9CgpmdW5jdGlvbiBsc3RhdFN5bmMoZmlsZXBhdGgpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmxzdGF0U3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICByZXR1cm4gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnbHN0YXQnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZnN0YXQoZmQsIGNiKSB7CiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IHN0CiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5mc3RhdChyZXEuaGFuZGxlLCBmZCkKCiAgICBhd2FpdCByZXEKCiAgICBzdCA9IG5ldyBTdGF0cyguLi5iaW5kaW5nLnJlcXVlc3RSZXN1bHRTdGF0KHJlcS5oYW5kbGUpKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2ZzdGF0JywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBzdCwgY2IpCn0KCmZ1bmN0aW9uIGZzdGF0U3luYyhmZCkgewogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmZzdGF0U3luYyhyZXEuaGFuZGxlLCBmZCkKCiAgICByZXR1cm4gbmV3IFN0YXRzKC4uLmJpbmRpbmcucmVxdWVzdFJlc3VsdFN0YXQocmVxLmhhbmRsZSkpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZnN0YXQnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBmdHJ1bmNhdGUoZmQsIGxlbiA9IDAsIGNiKSB7CiAgaWYgKHR5cGVvZiBsZW4gPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbGVuCiAgICBsZW4gPSAwCiAgfQoKICBpZiAodHlwZW9mIGxlbiAhPT0gJ251bWJlcicpIGxlbiA9IDAKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5mdHJ1bmNhdGUocmVxLmhhbmRsZSwgZmQsIGxlbikKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmdHJ1bmNhdGUnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBmdHJ1bmNhdGVTeW5jKGZkLCBsZW4gPSAwKSB7CiAgaWYgKHR5cGVvZiBsZW4gIT09ICdudW1iZXInKSBsZW4gPSAwCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmZ0cnVuY2F0ZVN5bmMocmVxLmhhbmRsZSwgZmQsIGxlbikKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgeyBvcGVyYXRpb246ICdmdHJ1bmNhdGUnLCBjb2RlOiBlLmNvZGUsIGZkIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjaG1vZChmaWxlcGF0aCwgbW9kZSwgY2IpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5jaG1vZChyZXEuaGFuZGxlLCBmaWxlcGF0aCwgbW9kZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdjaG1vZCcsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBjaG1vZFN5bmMoZmlsZXBhdGgsIG1vZGUpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcuY2htb2RTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2NobW9kJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGZjaG1vZChmZCwgbW9kZSwgY2IpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcuZmNobW9kKHJlcS5oYW5kbGUsIGZkLCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7IG9wZXJhdGlvbjogJ2ZjaG1vZCcsIGNvZGU6IGUuY29kZSwgZmQgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIGZjaG1vZFN5bmMoZmQsIG1vZGUpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdzdHJpbmcnKSBtb2RlID0gdG9Nb2RlKG1vZGUpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmZjaG1vZFN5bmMocmVxLmhhbmRsZSwgZmQsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsgb3BlcmF0aW9uOiAnZmNobW9kJywgY29kZTogZS5jb2RlLCBmZCB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdXRpbWVzKGZpbGVwYXRoLCBhdGltZSwgbXRpbWUsIGNiKSB7CiAgaWYgKHR5cGVvZiBhdGltZSAhPT0gJ251bWJlcicpIGF0aW1lID0gYXRpbWUuZ2V0VGltZSgpIC8gMTAwMAogIGlmICh0eXBlb2YgbXRpbWUgIT09ICdudW1iZXInKSBtdGltZSA9IG10aW1lLmdldFRpbWUoKSAvIDEwMDAKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnV0aW1lcyhyZXEuaGFuZGxlLCBmaWxlcGF0aCwgYXRpbWUsIG10aW1lKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3V0aW1lcycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiB1dGltZXNTeW5jKGZpbGVwYXRoLCBhdGltZSwgbXRpbWUpIHsKICBpZiAodHlwZW9mIGF0aW1lICE9PSAnbnVtYmVyJykgYXRpbWUgPSBhdGltZS5nZXRUaW1lKCkgLyAxMDAwCiAgaWYgKHR5cGVvZiBtdGltZSAhPT0gJ251bWJlcicpIG10aW1lID0gbXRpbWUuZ2V0VGltZSgpIC8gMTAwMAoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnV0aW1lc1N5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIGF0aW1lLCBtdGltZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICd1dGltZXMnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gbWtkaXIoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7IG1vZGU6IDBvNzc3IH0KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ251bWJlcicpIG9wdHMgPSB7IG1vZGU6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgbW9kZSA9IHR5cGVvZiBvcHRzLm1vZGUgPT09ICdudW1iZXInID8gb3B0cy5tb2RlIDogMG83NzcKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBpZiAob3B0cy5yZWN1cnNpdmUpIHsKICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IG1rZGlyKGZpbGVwYXRoLCB7IG1vZGUgfSkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGVyci5jb2RlICE9PSAnRU5PRU5UJykgewogICAgICAgICAgaWYgKCEoYXdhaXQgc3RhdChmaWxlcGF0aCkpLmlzRGlyZWN0b3J5KCkpIHRocm93IGVycgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGlsZSAoZmlsZXBhdGguZW5kc1dpdGgocGF0aC5zZXApKSBmaWxlcGF0aCA9IGZpbGVwYXRoLnNsaWNlKDAsIC0xKQogICAgICAgICAgY29uc3QgaSA9IGZpbGVwYXRoLmxhc3RJbmRleE9mKHBhdGguc2VwKQogICAgICAgICAgaWYgKGkgPD0gMCkgdGhyb3cgZXJyCgogICAgICAgICAgYXdhaXQgbWtkaXIoZmlsZXBhdGguc2xpY2UoMCwgaSksIHsgbW9kZSwgcmVjdXJzaXZlOiB0cnVlIH0pCgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgbWtkaXIoZmlsZXBhdGgsIHsgbW9kZSB9KQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmICghKGF3YWl0IHN0YXQoZmlsZXBhdGgpKS5pc0RpcmVjdG9yeSgpKSB0aHJvdyBlcnIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIHJldHVybiBkb25lKGVyciwgY2IpCiAgfQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLm1rZGlyKHJlcS5oYW5kbGUsIGZpbGVwYXRoLCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ21rZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIG1rZGlyU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ251bWJlcicpIG9wdHMgPSB7IG1vZGU6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgbW9kZSA9IHR5cGVvZiBvcHRzLm1vZGUgPT09ICdudW1iZXInID8gb3B0cy5tb2RlIDogMG83NzcKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICBpZiAob3B0cy5yZWN1cnNpdmUpIHsKICAgIHRyeSB7CiAgICAgIG1rZGlyU3luYyhmaWxlcGF0aCwgeyBtb2RlIH0pCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGVyci5jb2RlICE9PSAnRU5PRU5UJykgewogICAgICAgIGlmICghc3RhdFN5bmMoZmlsZXBhdGgpLmlzRGlyZWN0b3J5KCkpIHRocm93IGVycgogICAgICB9IGVsc2UgewogICAgICAgIHdoaWxlIChmaWxlcGF0aC5lbmRzV2l0aChwYXRoLnNlcCkpIGZpbGVwYXRoID0gZmlsZXBhdGguc2xpY2UoMCwgLTEpCiAgICAgICAgY29uc3QgaSA9IGZpbGVwYXRoLmxhc3RJbmRleE9mKHBhdGguc2VwKQogICAgICAgIGlmIChpIDw9IDApIHRocm93IGVycgoKICAgICAgICBta2RpclN5bmMoZmlsZXBhdGguc2xpY2UoMCwgaSksIHsgbW9kZSwgcmVjdXJzaXZlOiB0cnVlIH0pCgogICAgICAgIHRyeSB7CiAgICAgICAgICBta2RpclN5bmMoZmlsZXBhdGgsIHsgbW9kZSB9KQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgaWYgKCFzdGF0U3luYyhmaWxlcGF0aCkuaXNEaXJlY3RvcnkoKSkgdGhyb3cgZXJyCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuCiAgfQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5ta2RpclN5bmMocmVxLmhhbmRsZSwgZmlsZXBhdGgsIG1vZGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnbWtkaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcm1kaXIoZmlsZXBhdGgsIGNiKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJtZGlyKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JtZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHJtZGlyU3luYyhmaWxlcGF0aCkgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcucm1kaXJTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JtZGlyJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJtKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgY29uc3Qgc3QgPSBhd2FpdCBsc3RhdChmaWxlcGF0aCkKCiAgICBpZiAoc3QuaXNEaXJlY3RvcnkoKSkgewogICAgICBpZiAob3B0cy5yZWN1cnNpdmUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgcm1kaXIoZmlsZXBhdGgpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9URU1QVFknKSB0aHJvdyBlcnIKCiAgICAgICAgICBjb25zdCBmaWxlcyA9IGF3YWl0IHJlYWRkaXIoZmlsZXBhdGgpCgogICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7CiAgICAgICAgICAgIGF3YWl0IHJtKGZpbGVwYXRoICsgcGF0aC5zZXAgKyBmaWxlLCBvcHRzKQogICAgICAgICAgfQoKICAgICAgICAgIGF3YWl0IHJtZGlyKGZpbGVwYXRoKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKCdpcyBhIGRpcmVjdG9yeScsIHsKICAgICAgICAgIG9wZXJhdGlvbjogJ3JtJywKICAgICAgICAgIGNvZGU6ICdFSVNESVInLAogICAgICAgICAgcGF0aDogZmlsZXBhdGgKICAgICAgICB9KQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBhd2FpdCB1bmxpbmsoZmlsZXBhdGgpCiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKGUuY29kZSAhPT0gJ0VOT0VOVCcgfHwgIW9wdHMuZm9yY2UpIGVyciA9IGUKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHJtU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdHJ5IHsKICAgIGNvbnN0IHN0ID0gbHN0YXRTeW5jKGZpbGVwYXRoKQoKICAgIGlmIChzdC5pc0RpcmVjdG9yeSgpKSB7CiAgICAgIGlmIChvcHRzLnJlY3Vyc2l2ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBybWRpclN5bmMoZmlsZXBhdGgpCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9URU1QVFknKSB0aHJvdyBlcnIKCiAgICAgICAgICBjb25zdCBmaWxlcyA9IHJlYWRkaXJTeW5jKGZpbGVwYXRoKQoKICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykgewogICAgICAgICAgICBybVN5bmMoZmlsZXBhdGggKyBwYXRoLnNlcCArIGZpbGUsIG9wdHMpCiAgICAgICAgICB9CgogICAgICAgICAgcm1kaXJTeW5jKGZpbGVwYXRoKQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKCdpcyBhIGRpcmVjdG9yeScsIHsKICAgICAgICAgIG9wZXJhdGlvbjogJ3JtJywKICAgICAgICAgIGNvZGU6ICdFSVNESVInLAogICAgICAgICAgcGF0aDogZmlsZXBhdGgKICAgICAgICB9KQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB1bmxpbmtTeW5jKGZpbGVwYXRoKQogICAgfQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyci5jb2RlICE9PSAnRU5PRU5UJyB8fCAhb3B0cy5mb3JjZSkgdGhyb3cgZXJyCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB1bmxpbmsoZmlsZXBhdGgsIGNiKSB7CiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnVubGluayhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICd1bmxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCBjYikKfQoKZnVuY3Rpb24gdW5saW5rU3luYyhmaWxlcGF0aCkgewogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcudW5saW5rU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICd1bmxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVuYW1lKHNyYywgZHN0LCBjYikgewogIHNyYyA9IHRvTmFtZXNwYWNlZFBhdGgoc3JjKQogIGRzdCA9IHRvTmFtZXNwYWNlZFBhdGgoZHN0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlbmFtZShyZXEuaGFuZGxlLCBzcmMsIGRzdCkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZW5hbWUnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHNyYywKICAgICAgZGVzdGluYXRpb246IGRzdAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHJlbmFtZVN5bmMoc3JjLCBkc3QpIHsKICBzcmMgPSB0b05hbWVzcGFjZWRQYXRoKHNyYykKICBkc3QgPSB0b05hbWVzcGFjZWRQYXRoKGRzdCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVuYW1lU3luYyhyZXEuaGFuZGxlLCBzcmMsIGRzdCkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZW5hbWUnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IHNyYywKICAgICAgZGVzdGluYXRpb246IGRzdAogICAgfSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNvcHlGaWxlKHNyYywgZHN0LCBtb2RlID0gMCwgY2IpIHsKICBpZiAodHlwZW9mIG1vZGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gbW9kZQogICAgbW9kZSA9IDAKICB9CgogIHNyYyA9IHRvTmFtZXNwYWNlZFBhdGgoc3JjKQogIGRzdCA9IHRvTmFtZXNwYWNlZFBhdGgoZHN0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLmNvcHlmaWxlKHJlcS5oYW5kbGUsIHNyYywgZHN0LCBtb2RlKQoKICAgIGF3YWl0IHJlcQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ2NvcHlmaWxlJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBzcmMsCiAgICAgIGRlc3RpbmF0aW9uOiBkc3QKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGNiKQp9CgpmdW5jdGlvbiBjb3B5RmlsZVN5bmMoc3JjLCBkc3QsIG1vZGUgPSAwKSB7CiAgc3JjID0gdG9OYW1lc3BhY2VkUGF0aChzcmMpCiAgZHN0ID0gdG9OYW1lc3BhY2VkUGF0aChkc3QpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLmNvcHlmaWxlU3luYyhyZXEuaGFuZGxlLCBzcmMsIGRzdCwgbW9kZSkKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdjb3B5ZmlsZScsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogc3JjLAogICAgICBkZXN0aW5hdGlvbjogZHN0CiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY3Aoc3JjLCBkc3QsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgc3JjID0gdG9OYW1lc3BhY2VkUGF0aChzcmMpCiAgZHN0ID0gdG9OYW1lc3BhY2VkUGF0aChkc3QpCgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGNvbnN0IHN0ID0gYXdhaXQgbHN0YXQoc3JjKQoKICAgIGlmIChzdC5pc0RpcmVjdG9yeSgpKSB7CiAgICAgIGlmIChvcHRzLnJlY3Vyc2l2ZSAhPT0gdHJ1ZSkgewogICAgICAgIHRocm93IG5ldyBGaWxlRXJyb3IoJ2lzIGEgZGlyZWN0b3J5JywgewogICAgICAgICAgb3BlcmF0aW9uOiAnY3AnLAogICAgICAgICAgY29kZTogJ0VJU0RJUicsCiAgICAgICAgICBwYXRoOiBzcmMKICAgICAgICB9KQogICAgICB9CgogICAgICB0cnkgewogICAgICAgIGF3YWl0IGxzdGF0KGRzdCkKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChlLmNvZGUgPT09ICdFTk9FTlQnKSB7CiAgICAgICAgICBhd2FpdCBta2Rpcihkc3QsIHsgbW9kZTogc3QubW9kZSwgcmVjdXJzaXZlOiB0cnVlIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IGUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGRpciA9IGF3YWl0IG9wZW5kaXIoc3JjKQogICAgICBmb3IgYXdhaXQgKGNvbnN0IHsgbmFtZSB9IG9mIGRpcikgewogICAgICAgIGF3YWl0IGNwKHBhdGguam9pbihzcmMsIG5hbWUpLCBwYXRoLmpvaW4oZHN0LCBuYW1lKSwgb3B0cykKICAgICAgfQogICAgfSBlbHNlIGlmIChzdC5pc0ZpbGUoKSkgewogICAgICBhd2FpdCBjb3B5RmlsZShzcmMsIGRzdCkKICAgICAgYXdhaXQgY2htb2QoZHN0LCBzdC5tb2RlKQogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IGUKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWxwYXRoKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgcmVzCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgYmluZGluZy5yZWFscGF0aChyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICByZXMgPSBCdWZmZXIuZnJvbShiaW5kaW5nLnJlcXVlc3RSZXN1bHRTdHJpbmcocmVxLmhhbmRsZSkpCgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgcmVzID0gcmVzLnRvU3RyaW5nKGVuY29kaW5nKQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ3JlYWxwYXRoJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgcmVzLCBjYikKfQoKZnVuY3Rpb24gcmVhbHBhdGhTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWxwYXRoU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBsZXQgcmVzID0gQnVmZmVyLmZyb20oYmluZGluZy5yZXF1ZXN0UmVzdWx0U3RyaW5nKHJlcS5oYW5kbGUpKQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIHJlcyA9IHJlcy50b1N0cmluZyhlbmNvZGluZykKCiAgICByZXR1cm4gcmVzCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVhbHBhdGgnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVhZGxpbmsoZmlsZXBhdGgsIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICd1dGY4JyB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIGxldCByZXMKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnJlYWRsaW5rKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGF3YWl0IHJlcQoKICAgIHJlcyA9IEJ1ZmZlci5mcm9tKGJpbmRpbmcucmVxdWVzdFJlc3VsdFN0cmluZyhyZXEuaGFuZGxlKSkKCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSByZXMgPSByZXMudG9TdHJpbmcoZW5jb2RpbmcpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAncmVhZGxpbmsnLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCByZXMsIGNiKQp9CgpmdW5jdGlvbiByZWFkbGlua1N5bmMoZmlsZXBhdGgsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgdHJ5IHsKICAgIGJpbmRpbmcucmVhZGxpbmtTeW5jKHJlcS5oYW5kbGUsIGZpbGVwYXRoKQoKICAgIGxldCByZXMgPSBCdWZmZXIuZnJvbShiaW5kaW5nLnJlcXVlc3RSZXN1bHRTdHJpbmcocmVxLmhhbmRsZSkpCgogICAgaWYgKGVuY29kaW5nICE9PSAnYnVmZmVyJykgcmVzID0gcmVzLnRvU3RyaW5nKGVuY29kaW5nKQoKICAgIHJldHVybiByZXMKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdyZWFkbGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQp9CgpmdW5jdGlvbiBub3JtYWxpemVTeW1saW5rVGFyZ2V0KHRhcmdldCwgdHlwZSwgZmlsZXBhdGgpIHsKICBpZiAoaXNXaW5kb3dzKSB7CiAgICBpZiAodHlwZSA9PT0gJ2p1bmN0aW9uJykgdGFyZ2V0ID0gcGF0aC5yZXNvbHZlKGZpbGVwYXRoLCAnLi4nLCB0YXJnZXQpCgogICAgaWYgKHBhdGguaXNBYnNvbHV0ZSh0YXJnZXQpKSByZXR1cm4gcGF0aC50b05hbWVzcGFjZWRQYXRoKHRhcmdldCkKCiAgICByZXR1cm4gdGFyZ2V0LnJlcGxhY2UoL1wvL2csIHBhdGguc2VwKQogIH0KCiAgcmV0dXJuIHRhcmdldAp9Cgphc3luYyBmdW5jdGlvbiBzeW1saW5rKHRhcmdldCwgZmlsZXBhdGgsIHR5cGUsIGNiKSB7CiAgaWYgKHR5cGVvZiB0eXBlID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IHR5cGUKICAgIHR5cGUgPSBudWxsCiAgfQoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdmaWxlJzoKICAgICAgZGVmYXVsdDoKICAgICAgICB0eXBlID0gMAogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2Rpcic6CiAgICAgICAgdHlwZSA9IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0RJUgogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2p1bmN0aW9uJzoKICAgICAgICB0eXBlID0gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KICAgICAgICBicmVhawogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgIT09ICdudW1iZXInKSB7CiAgICBpZiAoaXNXaW5kb3dzKSB7CiAgICAgIHRhcmdldCA9IHBhdGgucmVzb2x2ZShmaWxlcGF0aCwgJy4uJywgdGFyZ2V0KQoKICAgICAgdHJ5IHsKICAgICAgICB0eXBlID0gKGF3YWl0IHN0YXQodGFyZ2V0KSkuaXNEaXJlY3RvcnkoKQogICAgICAgICAgPyBjb25zdGFudHMuVVZfRlNfU1lNTElOS19ESVIKICAgICAgICAgIDogY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KICAgICAgfSBjYXRjaCB7CiAgICAgICAgdHlwZSA9IDAKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdHlwZSA9IDAKICAgIH0KICB9CgogIHRhcmdldCA9IG5vcm1hbGl6ZVN5bWxpbmtUYXJnZXQodGFyZ2V0KQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICBsZXQgZXJyID0gbnVsbAogIHRyeSB7CiAgICBiaW5kaW5nLnN5bWxpbmsocmVxLmhhbmRsZSwgdGFyZ2V0LCBmaWxlcGF0aCwgdHlwZSkKCiAgICBhd2FpdCByZXEKICB9IGNhdGNoIChlKSB7CiAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICBvcGVyYXRpb246ICdzeW1saW5rJywKICAgICAgY29kZTogZS5jb2RlLAogICAgICBwYXRoOiB0YXJnZXQsCiAgICAgIGRlc3RpbmF0aW9uOiBmaWxlcGF0aAogICAgfSkKICB9CgogIHJldHVybiBkb25lKGVyciwgY2IpCn0KCmZ1bmN0aW9uIHN5bWxpbmtTeW5jKHRhcmdldCwgZmlsZXBhdGgsIHR5cGUpIHsKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdmaWxlJzoKICAgICAgZGVmYXVsdDoKICAgICAgICB0eXBlID0gMAogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2Rpcic6CiAgICAgICAgdHlwZSA9IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0RJUgogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2p1bmN0aW9uJzoKICAgICAgICB0eXBlID0gY29uc3RhbnRzLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KICAgICAgICBicmVhawogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgIT09ICdudW1iZXInKSB7CiAgICBpZiAoaXNXaW5kb3dzKSB7CiAgICAgIHRhcmdldCA9IHBhdGgucmVzb2x2ZShmaWxlcGF0aCwgJy4uJywgdGFyZ2V0KQoKICAgICAgdHJ5IHsKICAgICAgICB0eXBlID0gc3RhdFN5bmModGFyZ2V0KS5pc0RpcmVjdG9yeSgpCiAgICAgICAgICA/IGNvbnN0YW50cy5VVl9GU19TWU1MSU5LX0RJUgogICAgICAgICAgOiBjb25zdGFudHMuVVZfRlNfU1lNTElOS19KVU5DVElPTgogICAgICB9IGNhdGNoIHsKICAgICAgICB0eXBlID0gMAogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0eXBlID0gMAogICAgfQogIH0KCiAgdGFyZ2V0ID0gbm9ybWFsaXplU3ltbGlua1RhcmdldCh0YXJnZXQpCgogIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogIHRyeSB7CiAgICBiaW5kaW5nLnN5bWxpbmtTeW5jKHJlcS5oYW5kbGUsIHRhcmdldCwgZmlsZXBhdGgsIHR5cGUpCiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnc3ltbGluaycsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogdGFyZ2V0LAogICAgICBkZXN0aW5hdGlvbjogZmlsZXBhdGgKICAgIH0pCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBvcGVuZGlyKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgbGV0IGRpcgogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGJpbmRpbmcub3BlbmRpcihyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICBhd2FpdCByZXEKCiAgICBkaXIgPSBuZXcgRGlyKGZpbGVwYXRoLCBiaW5kaW5nLnJlcXVlc3RSZXN1bHREaXIocmVxLmhhbmRsZSksIG9wdHMpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gbmV3IEZpbGVFcnJvcihlLm1lc3NhZ2UsIHsKICAgICAgb3BlcmF0aW9uOiAnb3BlbmRpcicsCiAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgcGF0aDogZmlsZXBhdGgKICAgIH0pCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGRpciwgY2IpCn0KCmZ1bmN0aW9uIG9wZW5kaXJTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgZmlsZXBhdGggPSB0b05hbWVzcGFjZWRQYXRoKGZpbGVwYXRoKQoKICB1c2luZyByZXEgPSBGaWxlUmVxdWVzdC5ib3Jyb3coKQoKICB0cnkgewogICAgYmluZGluZy5vcGVuZGlyU3luYyhyZXEuaGFuZGxlLCBmaWxlcGF0aCkKCiAgICByZXR1cm4gbmV3IERpcihmaWxlcGF0aCwgYmluZGluZy5yZXF1ZXN0UmVzdWx0RGlyKHJlcS5oYW5kbGUpLCBvcHRzKQogIH0gY2F0Y2ggKGUpIHsKICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgIG9wZXJhdGlvbjogJ29wZW5kaXInLAogICAgICBjb2RlOiBlLmNvZGUsCiAgICAgIHBhdGg6IGZpbGVwYXRoCiAgICB9KQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmVhZGRpcihmaWxlcGF0aCwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBjb25zdCB7IHdpdGhGaWxlVHlwZXMgPSBmYWxzZSB9ID0gb3B0cwoKICBmaWxlcGF0aCA9IHRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCgogIGxldCByZXN1bHQgPSBbXQogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGNvbnN0IGRpciA9IGF3YWl0IG9wZW5kaXIoZmlsZXBhdGgpCgogICAgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiBkaXIpIHsKICAgICAgcmVzdWx0LnB1c2god2l0aEZpbGVUeXBlcyA/IGVudHJ5IDogZW50cnkubmFtZSkKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICByZXN1bHQgPSBbXQogICAgZXJyID0gZQogIH0KCiAgcmV0dXJuIGRvbmUoZXJyLCByZXN1bHQsIGNiKQp9CgpmdW5jdGlvbiByZWFkZGlyU3luYyhmaWxlcGF0aCwgb3B0cykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyA9IGZhbHNlIH0gPSBvcHRzCgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgY29uc3QgZGlyID0gb3BlbmRpclN5bmMoZmlsZXBhdGgsIG9wdHMpCiAgY29uc3QgcmVzdWx0ID0gW10KCiAgZm9yIChjb25zdCBlbnRyeSBvZiBkaXIpIHsKICAgIHJlc3VsdC5wdXNoKHdpdGhGaWxlVHlwZXMgPyBlbnRyeSA6IGVudHJ5Lm5hbWUpCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRGaWxlKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGNvbnN0IHsgZW5jb2RpbmcgPSAnYnVmZmVyJyB9ID0gb3B0cwoKICBsZXQgZmQgPSAtMQogIGxldCBidWZmZXIgPSBudWxsCiAgbGV0IGVyciA9IG51bGwKICB0cnkgewogICAgZmQgPSBhd2FpdCBvcGVuKGZpbGVwYXRoLCBvcHRzLmZsYWcgfHwgJ3InKQoKICAgIGNvbnN0IHN0ID0gYXdhaXQgZnN0YXQoZmQpCgogICAgbGV0IGxlbiA9IDAKCiAgICBpZiAoc3Quc2l6ZSA9PT0gMCkgewogICAgICBjb25zdCBidWZmZXJzID0gW10KCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKDgxOTIpCiAgICAgICAgY29uc3QgciA9IGF3YWl0IHJlYWQoZmQsIGJ1ZmZlcikKICAgICAgICBsZW4gKz0gcgogICAgICAgIGlmIChyID09PSAwKSBicmVhawogICAgICAgIGJ1ZmZlcnMucHVzaChidWZmZXIuc3ViYXJyYXkoMCwgcikpCiAgICAgIH0KCiAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoYnVmZmVycykKICAgIH0gZWxzZSB7CiAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShzdC5zaXplKQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBjb25zdCByID0gYXdhaXQgcmVhZChmZCwgbGVuID8gYnVmZmVyLnN1YmFycmF5KGxlbikgOiBidWZmZXIpCiAgICAgICAgbGVuICs9IHIKICAgICAgICBpZiAociA9PT0gMCB8fCBsZW4gPT09IGJ1ZmZlci5ieXRlTGVuZ3RoKSBicmVhawogICAgICB9CgogICAgICBpZiAobGVuICE9PSBidWZmZXIuYnl0ZUxlbmd0aCkgYnVmZmVyID0gYnVmZmVyLnN1YmFycmF5KDAsIGxlbikKICAgIH0KCiAgICBpZiAoZW5jb2RpbmcgIT09ICdidWZmZXInKSBidWZmZXIgPSBidWZmZXIudG9TdHJpbmcoZW5jb2RpbmcpCiAgfSBjYXRjaCAoZSkgewogICAgZXJyID0gZQogIH0gZmluYWxseSB7CiAgICBpZiAoZmQgIT09IC0xKSBhd2FpdCBjbG9zZShmZCkKICB9CgogIHJldHVybiBkb25lKGVyciwgYnVmZmVyLCBjYikKfQoKZnVuY3Rpb24gcmVhZEZpbGVTeW5jKGZpbGVwYXRoLCBvcHRzKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnc3RyaW5nJykgb3B0cyA9IHsgZW5jb2Rpbmc6IG9wdHMgfQogIGVsc2UgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBlbmNvZGluZyA9ICdidWZmZXInIH0gPSBvcHRzCgogIGxldCBmZCA9IC0xCiAgdHJ5IHsKICAgIGZkID0gb3BlblN5bmMoZmlsZXBhdGgsIG9wdHMuZmxhZyB8fCAncicpCgogICAgY29uc3Qgc3QgPSBmc3RhdFN5bmMoZmQpCgogICAgbGV0IGJ1ZmZlcgogICAgbGV0IGxlbiA9IDAKCiAgICBpZiAoc3Quc2l6ZSA9PT0gMCkgewogICAgICBjb25zdCBidWZmZXJzID0gW10KCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKDgxOTIpCiAgICAgICAgY29uc3QgciA9IHJlYWRTeW5jKGZkLCBidWZmZXIpCiAgICAgICAgbGVuICs9IHIKICAgICAgICBpZiAociA9PT0gMCkgYnJlYWsKICAgICAgICBidWZmZXJzLnB1c2goYnVmZmVyLnN1YmFycmF5KDAsIHIpKQogICAgICB9CgogICAgICBidWZmZXIgPSBCdWZmZXIuY29uY2F0KGJ1ZmZlcnMpCiAgICB9IGVsc2UgewogICAgICBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoc3Quc2l6ZSkKCiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgY29uc3QgciA9IHJlYWRTeW5jKGZkLCBsZW4gPyBidWZmZXIuc3ViYXJyYXkobGVuKSA6IGJ1ZmZlcikKICAgICAgICBsZW4gKz0gcgogICAgICAgIGlmIChyID09PSAwIHx8IGxlbiA9PT0gYnVmZmVyLmJ5dGVMZW5ndGgpIGJyZWFrCiAgICAgIH0KCiAgICAgIGlmIChsZW4gIT09IGJ1ZmZlci5ieXRlTGVuZ3RoKSBidWZmZXIgPSBidWZmZXIuc3ViYXJyYXkoMCwgbGVuKQogICAgfQoKICAgIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicpIGJ1ZmZlciA9IGJ1ZmZlci50b1N0cmluZyhlbmNvZGluZykKCiAgICByZXR1cm4gYnVmZmVyCiAgfSBmaW5hbGx5IHsKICAgIGlmIChmZCAhPT0gLTEpIGNsb3NlU3luYyhmZCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlcGF0aCwgZGF0YSwgb3B0cywgY2IpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNiID0gb3B0cwogICAgb3B0cyA9IHt9CiAgfQoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgb3B0cy5lbmNvZGluZykKCiAgbGV0IGZkID0gLTEKICBsZXQgbGVuID0gMAogIGxldCBlcnIgPSBudWxsCiAgdHJ5IHsKICAgIGZkID0gYXdhaXQgb3BlbihmaWxlcGF0aCwgb3B0cy5mbGFnIHx8ICd3Jywgb3B0cy5tb2RlIHx8IDBvNjY2KQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGxlbiArPSBhd2FpdCB3cml0ZShmZCwgbGVuID8gZGF0YS5zdWJhcnJheShsZW4pIDogZGF0YSkKICAgICAgaWYgKGxlbiA9PT0gZGF0YS5ieXRlTGVuZ3RoKSBicmVhawogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGVyciA9IGUKICB9IGZpbmFsbHkgewogICAgaWYgKGZkICE9PSAtMSkgYXdhaXQgY2xvc2UoZmQpCiAgfQoKICByZXR1cm4gZG9uZShlcnIsIGxlbiwgY2IpCn0KCmZ1bmN0aW9uIHdyaXRlRmlsZVN5bmMoZmlsZXBhdGgsIGRhdGEsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gQnVmZmVyLmZyb20oZGF0YSwgb3B0cy5lbmNvZGluZykKCiAgbGV0IGZkID0gLTEKICB0cnkgewogICAgZmQgPSBvcGVuU3luYyhmaWxlcGF0aCwgb3B0cy5mbGFnIHx8ICd3Jywgb3B0cy5tb2RlIHx8IDBvNjY2KQoKICAgIGxldCBsZW4gPSAwCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgbGVuICs9IHdyaXRlU3luYyhmZCwgbGVuID8gZGF0YS5zdWJhcnJheShsZW4pIDogZGF0YSkKICAgICAgaWYgKGxlbiA9PT0gZGF0YS5ieXRlTGVuZ3RoKSBicmVhawogICAgfQogIH0gZmluYWxseSB7CiAgICBpZiAoZmQgIT09IC0xKSBjbG9zZVN5bmMoZmQpCiAgfQp9CgpmdW5jdGlvbiBhcHBlbmRGaWxlKGZpbGVwYXRoLCBkYXRhLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGlmICghb3B0cy5mbGFnKSBvcHRzID0geyAuLi5vcHRzLCBmbGFnOiAnYScgfQoKICByZXR1cm4gd3JpdGVGaWxlKGZpbGVwYXRoLCBkYXRhLCBvcHRzLCBjYikKfQoKZnVuY3Rpb24gYXBwZW5kRmlsZVN5bmMoZmlsZXBhdGgsIGRhdGEsIG9wdHMpIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBlbmNvZGluZzogb3B0cyB9CiAgZWxzZSBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICBpZiAoIW9wdHMuZmxhZykgb3B0cyA9IHsgLi4ub3B0cywgZmxhZzogJ2EnIH0KCiAgcmV0dXJuIHdyaXRlRmlsZVN5bmMoZmlsZXBhdGgsIGRhdGEsIG9wdHMpCn0KCmZ1bmN0aW9uIHdhdGNoKGZpbGVwYXRoLCBvcHRzLCBjYikgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBvcHRzCiAgICBvcHRzID0ge30KICB9CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ3N0cmluZycpIG9wdHMgPSB7IGVuY29kaW5nOiBvcHRzIH0KICBlbHNlIGlmICghb3B0cykgb3B0cyA9IHt9CgogIGZpbGVwYXRoID0gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkKCiAgcmV0dXJuIG5ldyBXYXRjaGVyKGZpbGVwYXRoLCBvcHRzLCBjYikKfQoKY2xhc3MgU3RhdHMgewogIGNvbnN0cnVjdG9yKAogICAgZGV2LAogICAgbW9kZSwKICAgIG5saW5rLAogICAgdWlkLAogICAgZ2lkLAogICAgcmRldiwKICAgIGJsa3NpemUsCiAgICBpbm8sCiAgICBzaXplLAogICAgYmxvY2tzLAogICAgYXRpbWVNcywKICAgIG10aW1lTXMsCiAgICBjdGltZU1zLAogICAgYmlydGh0aW1lTXMKICApIHsKICAgIHRoaXMuZGV2ID0gZGV2CiAgICB0aGlzLm1vZGUgPSBtb2RlCiAgICB0aGlzLm5saW5rID0gbmxpbmsKICAgIHRoaXMudWlkID0gdWlkCiAgICB0aGlzLmdpZCA9IGdpZAogICAgdGhpcy5yZGV2ID0gcmRldgogICAgdGhpcy5ibGtzaXplID0gYmxrc2l6ZQogICAgdGhpcy5pbm8gPSBpbm8KICAgIHRoaXMuc2l6ZSA9IHNpemUKICAgIHRoaXMuYmxvY2tzID0gYmxvY2tzCiAgICB0aGlzLmF0aW1lTXMgPSBhdGltZU1zCiAgICB0aGlzLm10aW1lTXMgPSBtdGltZU1zCiAgICB0aGlzLmN0aW1lTXMgPSBjdGltZU1zCiAgICB0aGlzLmJpcnRodGltZU1zID0gYmlydGh0aW1lTXMKICAgIHRoaXMuYXRpbWUgPSBuZXcgRGF0ZShhdGltZU1zKQogICAgdGhpcy5tdGltZSA9IG5ldyBEYXRlKG10aW1lTXMpCiAgICB0aGlzLmN0aW1lID0gbmV3IERhdGUoY3RpbWVNcykKICAgIHRoaXMuYmlydGh0aW1lID0gbmV3IERhdGUoYmlydGh0aW1lTXMpCiAgfQoKICBpc0RpcmVjdG9yeSgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGRElSCiAgfQoKICBpc0ZpbGUoKSB7CiAgICByZXR1cm4gKHRoaXMubW9kZSAmIGNvbnN0YW50cy5TX0lGTVQpID09PSBjb25zdGFudHMuU19JRlJFRwogIH0KCiAgaXNCbG9ja0RldmljZSgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZNVCkgPT09IGNvbnN0YW50cy5TX0lGQkxLCiAgfQoKICBpc0NoYXJhY3RlckRldmljZSgpIHsKICAgIHJldHVybiAodGhpcy5tb2RlICYgY29uc3RhbnRzLlNfSUZDSFIpID09PSBjb25zdGFudHMuU19JRkNIUgogIH0KCiAgaXNGSUZPKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZJRk8KICB9CgogIGlzU3ltYm9saWNMaW5rKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZMTksKICB9CgogIGlzU29ja2V0KCkgewogICAgcmV0dXJuICh0aGlzLm1vZGUgJiBjb25zdGFudHMuU19JRk1UKSA9PT0gY29uc3RhbnRzLlNfSUZTT0NLCiAgfQp9CgpjbGFzcyBEaXIgewogIGNvbnN0cnVjdG9yKHBhdGgsIGhhbmRsZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGVuY29kaW5nID0gJ3V0ZjgnLCBidWZmZXJTaXplID0gMzIgfSA9IG9wdHMKCiAgICB0aGlzLnBhdGggPSBwYXRoCgogICAgdGhpcy5fZW5jb2RpbmcgPSBlbmNvZGluZwogICAgdGhpcy5fY2FwYWNpdHkgPSBidWZmZXJTaXplCiAgICB0aGlzLl9idWZmZXIgPSBuZXcgRklGTygpCiAgICB0aGlzLl9lbmRlZCA9IGZhbHNlCiAgICB0aGlzLl9oYW5kbGUgPSBoYW5kbGUKICB9CgogIGFzeW5jIHJlYWQoY2IpIHsKICAgIGlmICh0aGlzLl9idWZmZXIubGVuZ3RoKSByZXR1cm4gb2sodGhpcy5fYnVmZmVyLnNoaWZ0KCksIGNiKQogICAgaWYgKHRoaXMuX2VuZGVkKSByZXR1cm4gb2sobnVsbCwgY2IpCgogICAgdXNpbmcgcmVxID0gRmlsZVJlcXVlc3QuYm9ycm93KCkKCiAgICBsZXQgZW50cmllcwogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIHJlcS5yZXRhaW4oYmluZGluZy5yZWFkZGlyKHJlcS5oYW5kbGUsIHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpKQoKICAgICAgYXdhaXQgcmVxCgogICAgICBlbnRyaWVzID0gYmluZGluZy5yZXF1ZXN0UmVzdWx0RGlyZW50cyhyZXEuaGFuZGxlKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICAgIG9wZXJhdGlvbjogJ3JlYWRkaXInLAogICAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgICBwYXRoOiB0aGlzLnBhdGgKICAgICAgfSkKICAgIH0KCiAgICBpZiAoZXJyKSByZXR1cm4gZmFpbChlcnIsIGNiKQoKICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9lbmRlZCA9IHRydWUKCiAgICAgIHJldHVybiBvayhudWxsLCBjYikKICAgIH0KCiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHsKICAgICAgbGV0IG5hbWUgPSBCdWZmZXIuZnJvbShlbnRyeS5uYW1lKQoKICAgICAgaWYgKHRoaXMuX2VuY29kaW5nICE9PSAnYnVmZmVyJykgbmFtZSA9IG5hbWUudG9TdHJpbmcodGhpcy5fZW5jb2RpbmcpCgogICAgICB0aGlzLl9idWZmZXIucHVzaChuZXcgRGlyZW50KHRoaXMucGF0aCwgbmFtZSwgZW50cnkudHlwZSkpCiAgICB9CgogICAgcmV0dXJuIG9rKHRoaXMuX2J1ZmZlci5zaGlmdCgpLCBjYikKICB9CgogIHJlYWRTeW5jKCkgewogICAgaWYgKHRoaXMuX2J1ZmZlci5sZW5ndGgpIHJldHVybiB0aGlzLl9idWZmZXIuc2hpZnQoKQogICAgaWYgKHRoaXMuX2VuZGVkKSByZXR1cm4gbnVsbAoKICAgIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogICAgbGV0IGVudHJpZXMKICAgIHRyeSB7CiAgICAgIHJlcS5yZXRhaW4oYmluZGluZy5yZWFkZGlyU3luYyhyZXEuaGFuZGxlLCB0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KSkKCiAgICAgIGVudHJpZXMgPSBiaW5kaW5nLnJlcXVlc3RSZXN1bHREaXJlbnRzKHJlcS5oYW5kbGUpCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRocm93IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgICAgb3BlcmF0aW9uOiAncmVhZGRpcicsCiAgICAgICAgY29kZTogZS5jb2RlLAogICAgICAgIHBhdGg6IHRoaXMucGF0aAogICAgICB9KQogICAgfQoKICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9lbmRlZCA9IHRydWUKCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7CiAgICAgIGxldCBuYW1lID0gQnVmZmVyLmZyb20oZW50cnkubmFtZSkKCiAgICAgIGlmICh0aGlzLl9lbmNvZGluZyAhPT0gJ2J1ZmZlcicpIG5hbWUgPSBuYW1lLnRvU3RyaW5nKHRoaXMuX2VuY29kaW5nKQoKICAgICAgdGhpcy5fYnVmZmVyLnB1c2gobmV3IERpcmVudCh0aGlzLnBhdGgsIG5hbWUsIGVudHJ5LnR5cGUpKQogICAgfQoKICAgIHJldHVybiB0aGlzLl9idWZmZXIuc2hpZnQoKQogIH0KCiAgYXN5bmMgY2xvc2UoY2IpIHsKICAgIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuY2xvc2VkaXIocmVxLmhhbmRsZSwgdGhpcy5faGFuZGxlKQoKICAgICAgYXdhaXQgcmVxCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyciA9IG5ldyBGaWxlRXJyb3IoZS5tZXNzYWdlLCB7CiAgICAgICAgb3BlcmF0aW9uOiAnY2xvc2VkaXInLAogICAgICAgIGNvZGU6IGUuY29kZSwKICAgICAgICBwYXRoOiB0aGlzLnBhdGgKICAgICAgfSkKICAgIH0KCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCgogICAgcmV0dXJuIGRvbmUoZXJyLCBjYikKICB9CgogIGNsb3NlU3luYygpIHsKICAgIHVzaW5nIHJlcSA9IEZpbGVSZXF1ZXN0LmJvcnJvdygpCgogICAgdHJ5IHsKICAgICAgYmluZGluZy5jbG9zZWRpclN5bmMocmVxLmhhbmRsZSwgdGhpcy5faGFuZGxlKQogICAgfSBjYXRjaCAoZSkgewogICAgICB0aHJvdyBuZXcgRmlsZUVycm9yKGUubWVzc2FnZSwgewogICAgICAgIG9wZXJhdGlvbjogJ2Nsb3NlZGlyJywKICAgICAgICBjb2RlOiBlLmNvZGUsCiAgICAgICAgcGF0aDogdGhpcy5wYXRoCiAgICAgIH0pCiAgICB9CgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogIH0KCiAgW1N5bWJvbC5kaXNwb3NlXSgpIHsKICAgIHRoaXMuY2xvc2VTeW5jKCkKICB9CgogIGFzeW5jIFtTeW1ib2wuYXN5bmNEaXNwb3NlXSgpIHsKICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogIH0KCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgZW50cnkgPSB0aGlzLnJlYWRTeW5jKCkKICAgICAgaWYgKGVudHJ5ID09PSBudWxsKSBicmVhawogICAgICB5aWVsZCBlbnRyeQogICAgfQoKICAgIHRoaXMuY2xvc2VTeW5jKCkKICB9CgogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgZW50cnkgPSBhd2FpdCB0aGlzLnJlYWQoKQogICAgICBpZiAoZW50cnkgPT09IG51bGwpIGJyZWFrCiAgICAgIHlpZWxkIGVudHJ5CiAgICB9CgogICAgYXdhaXQgdGhpcy5jbG9zZSgpCiAgfQp9CgpjbGFzcyBEaXJlbnQgewogIGNvbnN0cnVjdG9yKHBhcmVudFBhdGgsIG5hbWUsIHR5cGUpIHsKICAgIHRoaXMucGFyZW50UGF0aCA9IHBhcmVudFBhdGgKICAgIHRoaXMubmFtZSA9IG5hbWUKICAgIHRoaXMudHlwZSA9IHR5cGUKICB9CgogIGlzRmlsZSgpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfRklMRQogIH0KCiAgaXNEaXJlY3RvcnkoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0RJUgogIH0KCiAgaXNTeW1ib2xpY0xpbmsoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0xJTksKICB9CgogIGlzRklGTygpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPT09IGNvbnN0YW50cy5VVl9ESVJFTlRfRklGTwogIH0KCiAgaXNTb2NrZXQoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX1NPQ0tFVAogIH0KCiAgaXNDaGFyYWN0ZXJEZXZpY2UoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0NIQVIKICB9CgogIGlzQmxvY2tEZXZpY2UoKSB7CiAgICByZXR1cm4gdGhpcy50eXBlID09PSBjb25zdGFudHMuVVZfRElSRU5UX0JMT0NLCiAgfQp9CgpjbGFzcyBGaWxlUmVhZFN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihwYXRoLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgZWFnZXJPcGVuID0gdHJ1ZSB9ID0gb3B0cwoKICAgIHN1cGVyKHsgZWFnZXJPcGVuLCAuLi5vcHRzIH0pCgogICAgdGhpcy5wYXRoID0gcGF0aAogICAgdGhpcy5mZCA9IHR5cGVvZiBvcHRzLmZkID09PSAnbnVtYmVyJyA/IG9wdHMuZmQgOiAtMQogICAgdGhpcy5mbGFncyA9IG9wdHMuZmxhZ3MgfHwgJ3InCiAgICB0aGlzLm1vZGUgPSBvcHRzLm1vZGUgfHwgMG82NjYKCiAgICB0aGlzLl9vZmZzZXQgPSBvcHRzLnN0YXJ0IHx8IDAKICAgIHRoaXMuX21pc3NpbmcgPSAwCgogICAgaWYgKG9wdHMubGVuZ3RoKSB7CiAgICAgIHRoaXMuX21pc3NpbmcgPSBvcHRzLmxlbmd0aAogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0cy5lbmQgPT09ICdudW1iZXInKSB7CiAgICAgIHRoaXMuX21pc3NpbmcgPSBvcHRzLmVuZCAtIHRoaXMuX29mZnNldCArIDEKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX21pc3NpbmcgPSAtMQogICAgfQogIH0KCiAgYXN5bmMgX29wZW4oY2IpIHsKICAgIGxldCBlcnIKCiAgICBpZiAodGhpcy5mZCA9PT0gLTEpIHsKICAgICAgZXJyID0gbnVsbAogICAgICB0cnkgewogICAgICAgIHRoaXMuZmQgPSBhd2FpdCBvcGVuKHRoaXMucGF0aCwgdGhpcy5mbGFncywgdGhpcy5tb2RlKQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyID0gZQogICAgICB9CgogICAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQogICAgfQoKICAgIGxldCBzdAogICAgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgc3QgPSBhd2FpdCBmc3RhdCh0aGlzLmZkKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgaWYgKGVycikgcmV0dXJuIGNiKGVycikKCiAgICBpZiAodGhpcy5fbWlzc2luZyA9PT0gLTEpIHRoaXMuX21pc3NpbmcgPSBzdC5zaXplCgogICAgaWYgKHN0LnNpemUgPCB0aGlzLl9vZmZzZXQpIHsKICAgICAgdGhpcy5fb2Zmc2V0ID0gc3Quc2l6ZQogICAgICB0aGlzLl9taXNzaW5nID0gMAogICAgfSBlbHNlIGlmIChzdC5zaXplIDwgdGhpcy5fb2Zmc2V0ICsgdGhpcy5fbWlzc2luZykgewogICAgICB0aGlzLl9taXNzaW5nID0gc3Quc2l6ZSAtIHRoaXMuX29mZnNldAogICAgfQoKICAgIGNiKG51bGwpCiAgfQoKICBhc3luYyBfcmVhZChzaXplKSB7CiAgICBpZiAodGhpcy5fbWlzc2luZyA8PSAwKSByZXR1cm4gdGhpcy5wdXNoKG51bGwpCgogICAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShNYXRoLm1pbih0aGlzLl9taXNzaW5nLCBzaXplKSkKCiAgICBsZXQgbGVuCiAgICBsZXQgZXJyID0gbnVsbAogICAgdHJ5IHsKICAgICAgbGVuID0gYXdhaXQgcmVhZCh0aGlzLmZkLCBkYXRhLCAwLCBkYXRhLmJ5dGVMZW5ndGgsIHRoaXMuX29mZnNldCkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGlmIChlcnIpIHJldHVybiB0aGlzLmRlc3Ryb3koZXJyKQoKICAgIGlmIChsZW4gPT09IDApIHJldHVybiB0aGlzLnB1c2gobnVsbCkKCiAgICBpZiAodGhpcy5fbWlzc2luZyA8IGxlbikgbGVuID0gdGhpcy5fbWlzc2luZwoKICAgIHRoaXMuX21pc3NpbmcgLT0gbGVuCiAgICB0aGlzLl9vZmZzZXQgKz0gbGVuCgogICAgdGhpcy5wdXNoKGRhdGEuc3ViYXJyYXkoMCwgbGVuKSkKICB9CgogIGFzeW5jIF9kZXN0cm95KGVyciwgY2IpIHsKICAgIGlmICh0aGlzLmZkID09PSAtMSkgcmV0dXJuIGNiKGVycikKCiAgICBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBhd2FpdCBjbG9zZSh0aGlzLmZkKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgY2IoZXJyKQogIH0KfQoKY2xhc3MgRmlsZVdyaXRlU3RyZWFtIGV4dGVuZHMgV3JpdGFibGUgewogIGNvbnN0cnVjdG9yKHBhdGgsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBlYWdlck9wZW4gPSB0cnVlIH0gPSBvcHRzCgogICAgc3VwZXIoeyBlYWdlck9wZW4sIC4uLm9wdHMgfSkKCiAgICB0aGlzLnBhdGggPSBwYXRoCiAgICB0aGlzLmZkID0gdHlwZW9mIG9wdHMuZmQgPT09ICdudW1iZXInID8gb3B0cy5mZCA6IC0xCiAgICB0aGlzLmZsYWdzID0gb3B0cy5mbGFncyB8fCAndycKICAgIHRoaXMubW9kZSA9IG9wdHMubW9kZSB8fCAwbzY2NgogIH0KCiAgYXN5bmMgX29wZW4oY2IpIHsKICAgIGlmICh0aGlzLmZkICE9PSAtMSkgcmV0dXJuIGNiKG51bGwpCgogICAgbGV0IGVyciA9IG51bGwKICAgIHRyeSB7CiAgICAgIHRoaXMuZmQgPSBhd2FpdCBvcGVuKHRoaXMucGF0aCwgdGhpcy5mbGFncywgdGhpcy5tb2RlKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgY2IoZXJyKQogIH0KCiAgYXN5bmMgX3dyaXRldihiYXRjaCwgY2IpIHsKICAgIGxldCBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBhd2FpdCB3cml0ZXYoCiAgICAgICAgdGhpcy5mZCwKICAgICAgICBiYXRjaC5tYXAoKHsgY2h1bmsgfSkgPT4gY2h1bmspCiAgICAgICkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyID0gZQogICAgfQoKICAgIGNiKGVycikKICB9CgogIGFzeW5jIF9kZXN0cm95KGVyciwgY2IpIHsKICAgIGlmICh0aGlzLmZkID09PSAtMSkgcmV0dXJuIGNiKGVycikKCiAgICBlcnIgPSBudWxsCiAgICB0cnkgewogICAgICBhd2FpdCBjbG9zZSh0aGlzLmZkKQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnIgPSBlCiAgICB9CgogICAgY2IoZXJyKQogIH0KfQoKY2xhc3MgV2F0Y2hlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IocGF0aCwgb3B0cywgb25jaGFuZ2UpIHsKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBvbmNoYW5nZSA9IG9wdHMKICAgICAgb3B0cyA9IHt9CiAgICB9CgogICAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgICBjb25zdCB7IHBlcnNpc3RlbnQgPSB0cnVlLCByZWN1cnNpdmUgPSBmYWxzZSwgZW5jb2RpbmcgPSAndXRmOCcgfSA9IG9wdHMKCiAgICBzdXBlcigpCgogICAgdGhpcy5fY2xvc2VkID0gZmFsc2UKICAgIHRoaXMuX2VuY29kaW5nID0gZW5jb2RpbmcKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcud2F0Y2hlckluaXQocGF0aCwgcmVjdXJzaXZlLCB0aGlzLCB0aGlzLl9vbmV2ZW50LCB0aGlzLl9vbmNsb3NlKQoKICAgIGlmICghcGVyc2lzdGVudCkgdGhpcy51bnJlZigpCgogICAgaWYgKG9uY2hhbmdlKSB0aGlzLm9uKCdjaGFuZ2UnLCBvbmNoYW5nZSkKICB9CgogIGNsb3NlKCkgewogICAgaWYgKHRoaXMuX2Nsb3NlZCkgcmV0dXJuCiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCgogICAgYmluZGluZy53YXRjaGVyQ2xvc2UodGhpcy5faGFuZGxlKQogIH0KCiAgcmVmKCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSkgYmluZGluZy53YXRjaGVyUmVmKHRoaXMuX2hhbmRsZSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB1bnJlZigpIHsKICAgIGlmICh0aGlzLl9oYW5kbGUpIGJpbmRpbmcud2F0Y2hlclVucmVmKHRoaXMuX2hhbmRsZSkKICAgIHJldHVybiB0aGlzCiAgfQoKICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgY29uc3QgYnVmZmVyID0gW10KICAgIGxldCBkb25lID0gZmFsc2UKICAgIGxldCBlcnJvciA9IG51bGwKICAgIGxldCBuZXh0ID0gbnVsbAoKICAgIHRoaXMub24oJ2NoYW5nZScsIChldmVudFR5cGUsIGZpbGVuYW1lKSA9PiB7CiAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgbmV4dC5yZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlOiB7IGV2ZW50VHlwZSwgZmlsZW5hbWUgfSB9KQogICAgICAgIG5leHQgPSBudWxsCiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVmZmVyLnB1c2goeyBldmVudFR5cGUsIGZpbGVuYW1lIH0pCiAgICAgIH0KICAgIH0pCiAgICAgIC5vbignZXJyb3InLCAoZXJyKSA9PiB7CiAgICAgICAgZG9uZSA9IHRydWUKICAgICAgICBlcnJvciA9IGVycgoKICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgbmV4dC5yZWplY3QoZXJyb3IpCiAgICAgICAgICBuZXh0ID0gbnVsbAogICAgICAgIH0KICAgICAgfSkKICAgICAgLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgICBkb25lID0gdHJ1ZQoKICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgbmV4dC5yZXNvbHZlKHsgZG9uZSB9KQogICAgICAgICAgbmV4dCA9IG51bGwKICAgICAgICB9CiAgICAgIH0pCgogICAgcmV0dXJuIHsKICAgICAgbmV4dDogKCkgPT4KICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiByZWplY3QoZXJyb3IpCgogICAgICAgICAgaWYgKGJ1ZmZlci5sZW5ndGgpIHJldHVybiByZXNvbHZlKHsgZG9uZTogZmFsc2UsIHZhbHVlOiBidWZmZXIuc2hpZnQoKSB9KQoKICAgICAgICAgIGlmIChkb25lKSByZXR1cm4gcmVzb2x2ZSh7IGRvbmUgfSkKCiAgICAgICAgICBuZXh0ID0geyByZXNvbHZlLCByZWplY3QgfQogICAgICAgIH0pCiAgICB9CiAgfQoKICBfb25ldmVudChlcnIsIGV2ZW50cywgZmlsZW5hbWUpIHsKICAgIGlmIChlcnIpIHsKICAgICAgdGhpcy5jbG9zZSgpCiAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpCiAgICB9IGVsc2UgewogICAgICBjb25zdCBwYXRoID0KICAgICAgICB0aGlzLl9lbmNvZGluZyA9PT0gJ2J1ZmZlcicKICAgICAgICAgID8gQnVmZmVyLmZyb20oZmlsZW5hbWUpCiAgICAgICAgICA6IEJ1ZmZlci5mcm9tKGZpbGVuYW1lKS50b1N0cmluZyh0aGlzLl9lbmNvZGluZykKCiAgICAgIGlmIChldmVudHMgJiBiaW5kaW5nLlVWX1JFTkFNRSkgewogICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlJywgJ3JlbmFtZScsIHBhdGgpCiAgICAgIH0KCiAgICAgIGlmIChldmVudHMgJiBiaW5kaW5nLlVWX0NIQU5HRSkgewogICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlJywgJ2NoYW5nZScsIHBhdGgpCiAgICAgIH0KICAgIH0KICB9CgogIF9vbmNsb3NlKCkgewogICAgdGhpcy5faGFuZGxlID0gbnVsbAoKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KfQoKZXhwb3J0cy5hY2Nlc3MgPSBhY2Nlc3MKZXhwb3J0cy5hcHBlbmRGaWxlID0gYXBwZW5kRmlsZQpleHBvcnRzLmNobW9kID0gY2htb2QKLy8gZXhwb3J0cy5jaG93biA9IGNob3duIFRPRE8KZXhwb3J0cy5jbG9zZSA9IGNsb3NlCmV4cG9ydHMuY29weUZpbGUgPSBjb3B5RmlsZQpleHBvcnRzLmNwID0gY3AKZXhwb3J0cy5leGlzdHMgPSBleGlzdHMKZXhwb3J0cy5mY2htb2QgPSBmY2htb2QKLy8gZXhwb3J0cy5mY2hvd24gPSBmY2hvd24gVE9ETwovLyBleHBvcnRzLmZkYXRhc3luYyA9IGZkYXRhc3luYyBUT0RPCmV4cG9ydHMuZnN0YXQgPSBmc3RhdAovLyBleHBvcnRzLmZzeW5jID0gZnN5bmMgVE9ETwpleHBvcnRzLmZ0cnVuY2F0ZSA9IGZ0cnVuY2F0ZQovLyBleHBvcnRzLmZ1dGltZXMgPSBmdXRpbWVzIFRPRE8KLy8gZXhwb3J0cy5sY2htb2QgPSBsY2htb2QgVE9ETwovLyBleHBvcnRzLmxjaG93biA9IGxjaG93biBUT0RPCi8vIGV4cG9ydHMubHV0aW1lcyA9IGx1dGltZXMgVE9ETwovLyBleHBvcnRzLmxpbmsgPSBsaW5rIFRPRE8KZXhwb3J0cy5sc3RhdCA9IGxzdGF0CmV4cG9ydHMubWtkaXIgPSBta2RpcgovLyBleHBvcnRzLm1rZHRlbXAgPSBta2R0ZW1wIFRPRE8KZXhwb3J0cy5vcGVuID0gb3BlbgpleHBvcnRzLm9wZW5kaXIgPSBvcGVuZGlyCmV4cG9ydHMucmVhZCA9IHJlYWQKZXhwb3J0cy5yZWFkRmlsZSA9IHJlYWRGaWxlCmV4cG9ydHMucmVhZGRpciA9IHJlYWRkaXIKZXhwb3J0cy5yZWFkbGluayA9IHJlYWRsaW5rCmV4cG9ydHMucmVhZHYgPSByZWFkdgpleHBvcnRzLnJlYWxwYXRoID0gcmVhbHBhdGgKZXhwb3J0cy5yZW5hbWUgPSByZW5hbWUKZXhwb3J0cy5ybSA9IHJtCmV4cG9ydHMucm1kaXIgPSBybWRpcgpleHBvcnRzLnN0YXQgPSBzdGF0Ci8vIGV4cG9ydHMuc3RhdGZzID0gc3RhdGZzIFRPRE8KZXhwb3J0cy5zeW1saW5rID0gc3ltbGluawovLyBleHBvcnRzLnRydW5jYXRlID0gdHJ1bmNhdGUgVE9ETwpleHBvcnRzLnVubGluayA9IHVubGluawpleHBvcnRzLnV0aW1lcyA9IHV0aW1lcwpleHBvcnRzLndhdGNoID0gd2F0Y2gKZXhwb3J0cy53cml0ZSA9IHdyaXRlCmV4cG9ydHMud3JpdGVGaWxlID0gd3JpdGVGaWxlCmV4cG9ydHMud3JpdGV2ID0gd3JpdGV2CgpleHBvcnRzLmFjY2Vzc1N5bmMgPSBhY2Nlc3NTeW5jCmV4cG9ydHMuYXBwZW5kRmlsZVN5bmMgPSBhcHBlbmRGaWxlU3luYwpleHBvcnRzLmNobW9kU3luYyA9IGNobW9kU3luYwovLyBleHBvcnRzLmNob3duU3luYyA9IGNob3duU3luYyBUT0RPCmV4cG9ydHMuY2xvc2VTeW5jID0gY2xvc2VTeW5jCmV4cG9ydHMuY29weUZpbGVTeW5jID0gY29weUZpbGVTeW5jCmV4cG9ydHMuZXhpc3RzU3luYyA9IGV4aXN0c1N5bmMKZXhwb3J0cy5mY2htb2RTeW5jID0gZmNobW9kU3luYwovLyBleHBvcnRzLmZjaG93blN5bmMgPSBmY2hvd25TeW5jIFRPRE8KLy8gZXhwb3J0cy5mZGF0YXN5bmNTeW5jID0gZmRhdGFzeW5jU3luYyBUT0RPCmV4cG9ydHMuZnN0YXRTeW5jID0gZnN0YXRTeW5jCi8vIGV4cG9ydHMuZnN5bmNTeW5jID0gZnN5bmNTeW5jIFRPRE8KZXhwb3J0cy5mdHJ1bmNhdGVTeW5jID0gZnRydW5jYXRlU3luYwovLyBleHBvcnRzLmZ1dGltZXNTeW5jID0gZnV0aW1lc1N5bmMgVE9ETwovLyBleHBvcnRzLmxjaG1vZFN5bmMgPSBsY2htb2RTeW5jIFRPRE8KLy8gZXhwb3J0cy5sY2hvd25TeW5jID0gbGNob3duU3luYyBUT0RPCi8vIGV4cG9ydHMubHV0aW1lc1N5bmMgPSBsdXRpbWVzU3luYyBUT0RPCi8vIGV4cG9ydHMubGlua1N5bmMgPSBsaW5rU3luYyBUT0RPCmV4cG9ydHMubHN0YXRTeW5jID0gbHN0YXRTeW5jCmV4cG9ydHMubWtkaXJTeW5jID0gbWtkaXJTeW5jCi8vIGV4cG9ydHMubWtkdGVtcFN5bmMgPSBta2R0ZW1wU3luYyBUT0RPCmV4cG9ydHMub3BlblN5bmMgPSBvcGVuU3luYwpleHBvcnRzLm9wZW5kaXJTeW5jID0gb3BlbmRpclN5bmMKZXhwb3J0cy5yZWFkRmlsZVN5bmMgPSByZWFkRmlsZVN5bmMKZXhwb3J0cy5yZWFkU3luYyA9IHJlYWRTeW5jCmV4cG9ydHMucmVhZGRpclN5bmMgPSByZWFkZGlyU3luYwpleHBvcnRzLnJlYWRsaW5rU3luYyA9IHJlYWRsaW5rU3luYwpleHBvcnRzLnJlYWR2U3luYyA9IHJlYWR2U3luYwpleHBvcnRzLnJlYWxwYXRoU3luYyA9IHJlYWxwYXRoU3luYwpleHBvcnRzLnJlbmFtZVN5bmMgPSByZW5hbWVTeW5jCmV4cG9ydHMucm1TeW5jID0gcm1TeW5jCmV4cG9ydHMucm1kaXJTeW5jID0gcm1kaXJTeW5jCmV4cG9ydHMuc3RhdFN5bmMgPSBzdGF0U3luYwovLyBleHBvcnRzLnN0YXRmc1N5bmMgPSBzdGF0ZnNTeW5jIFRPRE8KZXhwb3J0cy5zeW1saW5rU3luYyA9IHN5bWxpbmtTeW5jCi8vIGV4cG9ydHMudHJ1bmNhdGVTeW5jID0gdHJ1bmNhdGVTeW5jIFRPRE8KZXhwb3J0cy51bmxpbmtTeW5jID0gdW5saW5rU3luYwpleHBvcnRzLnV0aW1lc1N5bmMgPSB1dGltZXNTeW5jCmV4cG9ydHMud3JpdGVGaWxlU3luYyA9IHdyaXRlRmlsZVN5bmMKZXhwb3J0cy53cml0ZVN5bmMgPSB3cml0ZVN5bmMKZXhwb3J0cy53cml0ZXZTeW5jID0gd3JpdGV2U3luYwoKZXhwb3J0cy5wcm9taXNlcyA9IHJlcXVpcmUoJy4vcHJvbWlzZXMnKQoKZXhwb3J0cy5TdGF0cyA9IFN0YXRzCmV4cG9ydHMuRGlyID0gRGlyCmV4cG9ydHMuRGlyZW50ID0gRGlyZW50CmV4cG9ydHMuV2F0Y2hlciA9IFdhdGNoZXIKCmV4cG9ydHMuUmVhZFN0cmVhbSA9IEZpbGVSZWFkU3RyZWFtCgpleHBvcnRzLmNyZWF0ZVJlYWRTdHJlYW0gPSBmdW5jdGlvbiBjcmVhdGVSZWFkU3RyZWFtKHBhdGgsIG9wdHMpIHsKICByZXR1cm4gbmV3IEZpbGVSZWFkU3RyZWFtKHBhdGgsIG9wdHMpCn0KCmV4cG9ydHMuV3JpdGVTdHJlYW0gPSBGaWxlV3JpdGVTdHJlYW0KCmV4cG9ydHMuY3JlYXRlV3JpdGVTdHJlYW0gPSBmdW5jdGlvbiBjcmVhdGVXcml0ZVN0cmVhbShwYXRoLCBvcHRzKSB7CiAgcmV0dXJuIG5ldyBGaWxlV3JpdGVTdHJlYW0ocGF0aCwgb3B0cykKfQoKZnVuY3Rpb24gdG9OYW1lc3BhY2VkUGF0aChmaWxlcGF0aCkgewogIGlmICh0eXBlb2YgZmlsZXBhdGggIT09ICdzdHJpbmcnKSB7CiAgICBpZiAoVVJMLmlzVVJMKGZpbGVwYXRoKSkgZmlsZXBhdGggPSBmaWxlVVJMVG9QYXRoKGZpbGVwYXRoKQogICAgZWxzZSBmaWxlcGF0aCA9IGZpbGVwYXRoLnRvU3RyaW5nKCkKICB9CgogIHJldHVybiBwYXRoLnRvTmFtZXNwYWNlZFBhdGgoZmlsZXBhdGgpCn0KCmZ1bmN0aW9uIHRvRmxhZ3MoZmxhZ3MpIHsKICBzd2l0Y2ggKGZsYWdzKSB7CiAgICBjYXNlICdyJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1JET05MWQogICAgY2FzZSAncnMnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICdzcic6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19SRE9OTFkgfCBjb25zdGFudHMuT19TWU5DCiAgICBjYXNlICdyKyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19SRFdSCiAgICBjYXNlICdycysnOiAvLyBGYWxsIHRocm91Z2guCiAgICBjYXNlICdzcisnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fUkRXUiB8IGNvbnN0YW50cy5PX1NZTkMKCiAgICBjYXNlICd3JzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1RSVU5DIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkKICAgIGNhc2UgJ3d4JzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneHcnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fVFJVTkMgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1dST05MWSB8IGNvbnN0YW50cy5PX0VYQ0wKCiAgICBjYXNlICd3Kyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19UUlVOQyB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUgogICAgY2FzZSAnd3grJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneHcrJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX1RSVU5DIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19SRFdSIHwgY29uc3RhbnRzLk9fRVhDTAoKICAgIGNhc2UgJ2EnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkKICAgIGNhc2UgJ2F4JzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneGEnOgogICAgICByZXR1cm4gY29uc3RhbnRzLk9fQVBQRU5EIHwgY29uc3RhbnRzLk9fQ1JFQVQgfCBjb25zdGFudHMuT19XUk9OTFkgfCBjb25zdGFudHMuT19FWENMCiAgICBjYXNlICdhcyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3NhJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fV1JPTkxZIHwgY29uc3RhbnRzLk9fU1lOQwoKICAgIGNhc2UgJ2ErJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUgogICAgY2FzZSAnYXgrJzogLy8gRmFsbCB0aHJvdWdoLgogICAgY2FzZSAneGErJzoKICAgICAgcmV0dXJuIGNvbnN0YW50cy5PX0FQUEVORCB8IGNvbnN0YW50cy5PX0NSRUFUIHwgY29uc3RhbnRzLk9fUkRXUiB8IGNvbnN0YW50cy5PX0VYQ0wKICAgIGNhc2UgJ2FzKyc6IC8vIEZhbGwgdGhyb3VnaC4KICAgIGNhc2UgJ3NhKyc6CiAgICAgIHJldHVybiBjb25zdGFudHMuT19BUFBFTkQgfCBjb25zdGFudHMuT19DUkVBVCB8IGNvbnN0YW50cy5PX1JEV1IgfCBjb25zdGFudHMuT19TWU5DCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gMAogIH0KfQoKZnVuY3Rpb24gdG9Nb2RlKG1vZGUpIHsKICByZXR1cm4gcGFyc2VJbnQobW9kZSwgOCkKfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBPX1JEV1I6IGJpbmRpbmcuT19SRFdSLAogIE9fUkRPTkxZOiBiaW5kaW5nLk9fUkRPTkxZLAogIE9fV1JPTkxZOiBiaW5kaW5nLk9fV1JPTkxZLAogIE9fQ1JFQVQ6IGJpbmRpbmcuT19DUkVBVCwKICBPX1RSVU5DOiBiaW5kaW5nLk9fVFJVTkMsCiAgT19BUFBFTkQ6IGJpbmRpbmcuT19BUFBFTkQsCgogIEZfT0s6IGJpbmRpbmcuRl9PSyB8fCAwLAogIFJfT0s6IGJpbmRpbmcuUl9PSyB8fCAwLAogIFdfT0s6IGJpbmRpbmcuV19PSyB8fCAwLAogIFhfT0s6IGJpbmRpbmcuWF9PSyB8fCAwLAoKICBTX0lGTVQ6IGJpbmRpbmcuU19JRk1ULAogIFNfSUZSRUc6IGJpbmRpbmcuU19JRlJFRywKICBTX0lGRElSOiBiaW5kaW5nLlNfSUZESVIsCiAgU19JRkNIUjogYmluZGluZy5TX0lGQ0hSLAogIFNfSUZMTks6IGJpbmRpbmcuU19JRkxOSywKICBTX0lGQkxLOiBiaW5kaW5nLlNfSUZCTEsgfHwgMCwKICBTX0lGSUZPOiBiaW5kaW5nLlNfSUZJRk8gfHwgMCwKICBTX0lGU09DSzogYmluZGluZy5TX0lGU09DSyB8fCAwLAoKICBTX0lSVVNSOiBiaW5kaW5nLlNfSVJVU1IgfHwgMCwKICBTX0lXVVNSOiBiaW5kaW5nLlNfSVdVU1IgfHwgMCwKICBTX0lYVVNSOiBiaW5kaW5nLlNfSVhVU1IgfHwgMCwKICBTX0lSR1JQOiBiaW5kaW5nLlNfSVJHUlAgfHwgMCwKICBTX0lXR1JQOiBiaW5kaW5nLlNfSVdHUlAgfHwgMCwKICBTX0lYR1JQOiBiaW5kaW5nLlNfSVhHUlAgfHwgMCwKICBTX0lST1RIOiBiaW5kaW5nLlNfSVJPVEggfHwgMCwKICBTX0lXT1RIOiBiaW5kaW5nLlNfSVdPVEggfHwgMCwKICBTX0lYT1RIOiBiaW5kaW5nLlNfSVhPVEggfHwgMCwKCiAgVVZfRElSRU5UX1VOS05PV046IGJpbmRpbmcuVVZfRElSRU5UX1VOS05PV04sCiAgVVZfRElSRU5UX0ZJTEU6IGJpbmRpbmcuVVZfRElSRU5UX0ZJTEUsCiAgVVZfRElSRU5UX0RJUjogYmluZGluZy5VVl9ESVJFTlRfRElSLAogIFVWX0RJUkVOVF9MSU5LOiBiaW5kaW5nLlVWX0RJUkVOVF9MSU5LLAogIFVWX0RJUkVOVF9GSUZPOiBiaW5kaW5nLlVWX0RJUkVOVF9GSUZPLAogIFVWX0RJUkVOVF9TT0NLRVQ6IGJpbmRpbmcuVVZfRElSRU5UX1NPQ0tFVCwKICBVVl9ESVJFTlRfQ0hBUjogYmluZGluZy5VVl9ESVJFTlRfQ0hBUiwKICBVVl9ESVJFTlRfQkxPQ0s6IGJpbmRpbmcuVVZfRElSRU5UX0JMT0NLLAoKICBDT1BZRklMRV9FWENMOiBiaW5kaW5nLlVWX0ZTX0NPUFlGSUxFX0VYQ0wsCiAgQ09QWUZJTEVfRklDTE9ORTogYmluZGluZy5VVl9GU19DT1BZRklMRV9GSUNMT05FLAogIENPUFlGSUxFX0ZJQ0xPTkVfRk9SQ0U6IGJpbmRpbmcuVVZfRlNfQ09QWUZJTEVfRklDTE9ORV9GT1JDRSwKICBVVl9GU19TWU1MSU5LX0RJUjogYmluZGluZy5VVl9GU19TWU1MSU5LX0RJUiwKICBVVl9GU19TWU1MSU5LX0pVTkNUSU9OOiBiaW5kaW5nLlVWX0ZTX1NZTUxJTktfSlVOQ1RJT04KfQpjb25zdCBvcyA9IHJlcXVpcmUoJ2JhcmUtb3MnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGaWxlRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgY29kZSwgb3BlcmF0aW9uID0gbnVsbCwgcGF0aCA9IG51bGwsIGRlc3RpbmF0aW9uID0gbnVsbCwgZmQgPSAtMSB9ID0gb3B0cwoKICAgIGlmIChvcGVyYXRpb24gIT09IG51bGwpIG1zZyArPSBkZXNjcmliZShvcGVyYXRpb24sIG9wdHMpCgogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCgogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChvcGVyYXRpb24gIT09IG51bGwpIHRoaXMub3BlcmF0aW9uID0gb3BlcmF0aW9uCiAgICBpZiAocGF0aCAhPT0gbnVsbCkgdGhpcy5wYXRoID0gcGF0aAogICAgaWYgKGRlc3RpbmF0aW9uICE9PSBudWxsKSB0aGlzLmRlc3RpbmF0aW9uID0gZGVzdGluYXRpb24KICAgIGlmIChmZCAhPT0gLTEpIHRoaXMuZmQgPSBmZAogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ0ZpbGVFcnJvcicKICB9CgogIC8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKICBnZXQgZXJybm8oKSB7CiAgICByZXR1cm4gb3MuY29uc3RhbnRzLmVycm5vc1t0aGlzLmNvZGVdCiAgfQoKICAvLyBGb3IgTm9kZS5qcyBjb21wYXRpYmlsaXR5CiAgZ2V0IHN5c2NhbGwoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb24KICB9CgogIC8vIEZvciBOb2RlLmpzIGNvbXBhdGliaWxpdHkKICBnZXQgZGVzdCgpIHsKICAgIHJldHVybiB0aGlzLmRlc3RpbmF0aW9uCiAgfQp9CgpmdW5jdGlvbiBkZXNjcmliZShvcGVyYXRpb24sIG9wdHMpIHsKICBjb25zdCB7IHBhdGggPSBudWxsLCBkZXN0aW5hdGlvbiA9IG51bGwsIGZkID0gLTEgfSA9IG9wdHMKCiAgbGV0IHJlc3VsdCA9IGAsICR7b3BlcmF0aW9ufWAKCiAgaWYgKHBhdGggIT09IG51bGwpIHsKICAgIHJlc3VsdCArPSBgICR7SlNPTi5zdHJpbmdpZnkocGF0aCl9YAoKICAgIGlmIChkZXN0aW5hdGlvbiAhPT0gbnVsbCkgewogICAgICByZXN1bHQgKz0gYCAtPiAke0pTT04uc3RyaW5naWZ5KGRlc3RpbmF0aW9uKX1gCiAgICB9CiAgfSBlbHNlIGlmIChmZCAhPT0gLTEpIHsKICAgIHJlc3VsdCArPSBgICR7ZmR9YAogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CnsKICAibmFtZSI6ICJiYXJlLWZzIiwKICAidmVyc2lvbiI6ICI0LjUuMiIsCiAgImRlc2NyaXB0aW9uIjogIk5hdGl2ZSBmaWxlIHN5c3RlbSBvcGVyYXRpb25zIGZvciBKYXZhc2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL3Byb21pc2VzIjogewogICAgICAidHlwZXMiOiAiLi9wcm9taXNlcy5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9wcm9taXNlcy5qcyIKICAgIH0sCiAgICAiLi9jb25zdGFudHMiOiB7CiAgICAgICJ0eXBlcyI6ICIuL2xpYi9jb25zdGFudHMuZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vbGliL2NvbnN0YW50cy5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAicHJvbWlzZXMuanMiLAogICAgInByb21pc2VzLmQudHMiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImFkZG9uIjogdHJ1ZSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1mcy5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLWZzL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1mcyNyZWFkbWUiLAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjE2LjAiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZXZlbnRzIjogIl4yLjUuNCIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiYmFyZS1zdHJlYW0iOiAiXjIuNi40IiwKICAgICJiYXJlLXVybCI6ICJeMi4yLjIiLAogICAgImZhc3QtZmlmbyI6ICJeMS4zLjIiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIl4zLjAuMiIsCiAgICAiYmFyZS1jcnlwdG8iOiAiXjEuMTEuMiIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS43IiwKICAgICJwcmV0dGllciI6ICJeMy40LjEiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWJ1ZmZlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdiYXJlLWV2ZW50cycpCmNvbnN0IGZzID0gcmVxdWlyZSgnLicpCgpjbGFzcyBGaWxlSGFuZGxlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihmZCkgewogICAgdGhpcy5mZCA9IGZkCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGF3YWl0IGZzLmNsb3NlKGZkKQoKICAgIHRoaXMuZmQgPSAtMQogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBhc3luYyByZWFkKGJ1ZmZlciwgLi4uYXJncykgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXNSZWFkOiBhd2FpdCBmcy5yZWFkKHRoaXMuZmQsIGJ1ZmZlciwgLi4uYXJncyksCiAgICAgIGJ1ZmZlcgogICAgfQogIH0KCiAgYXN5bmMgcmVhZHYoYnVmZmVycywgLi4uYXJncykgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXNSZWFkOiBhd2FpdCBmcy5yZWFkdih0aGlzLmZkLCBidWZmZXJzLCAuLi5hcmdzKSwKICAgICAgYnVmZmVycwogICAgfQogIH0KCiAgYXN5bmMgd3JpdGUoYnVmZmVyLCAuLi5hcmdzKSB7CiAgICByZXR1cm4gewogICAgICBieXRlc1dyaXR0ZW46IGF3YWl0IGZzLndyaXRlKHRoaXMuZmQsIGJ1ZmZlciwgLi4uYXJncyksCiAgICAgIGJ1ZmZlcgogICAgfQogIH0KCiAgYXN5bmMgd3JpdGV2KGJ1ZmZlcnMsIC4uLmFyZ3MpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzV3JpdHRlbjogYXdhaXQgZnMud3JpdGV2KHRoaXMuZmQsIGJ1ZmZlcnMsIC4uLmFyZ3MpLAogICAgICBidWZmZXJzCiAgICB9CiAgfQoKICBhc3luYyBzdGF0KCkgewogICAgcmV0dXJuIGZzLmZzdGF0KHRoaXMuZmQpCiAgfQoKICBhc3luYyBjaG1vZChtb2RlKSB7CiAgICBhd2FpdCBmcy5mY2htb2QodGhpcy5mZCwgbW9kZSkKICB9CgogIGNyZWF0ZVJlYWRTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGZzLmNyZWF0ZVJlYWRTdHJlYW0obnVsbCwgeyAuLi5vcHRzLCBmZDogdGhpcy5mZCB9KQogIH0KCiAgY3JlYXRlV3JpdGVTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGZzLmNyZWF0ZVdyaXRlU3RyZWFtKG51bGwsIHsgLi4ub3B0cywgZmQ6IHRoaXMuZmQgfSkKICB9CgogIGFzeW5jIFtTeW1ib2wuYXN5bmNEaXNwb3NlXSgpIHsKICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogIH0KfQoKZXhwb3J0cy5vcGVuID0gYXN5bmMgZnVuY3Rpb24gb3BlbihmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpIHsKICByZXR1cm4gbmV3IEZpbGVIYW5kbGUoYXdhaXQgZnMub3BlbihmaWxlcGF0aCwgZmxhZ3MsIG1vZGUpKQp9CgpleHBvcnRzLmFjY2VzcyA9IGZzLmFjY2VzcwpleHBvcnRzLmFwcGVuZEZpbGUgPSBmcy5hcHBlbmRGaWxlCmV4cG9ydHMuY2htb2QgPSBmcy5jaG1vZApleHBvcnRzLmNvbnN0YW50cyA9IGZzLmNvbnN0YW50cwpleHBvcnRzLmNvcHlGaWxlID0gZnMuY29weUZpbGUKZXhwb3J0cy5jcCA9IGZzLmNwCmV4cG9ydHMubHN0YXQgPSBmcy5sc3RhdApleHBvcnRzLm1rZGlyID0gZnMubWtkaXIKZXhwb3J0cy5vcGVuZGlyID0gZnMub3BlbmRpcgpleHBvcnRzLnJlYWRGaWxlID0gZnMucmVhZEZpbGUKZXhwb3J0cy5yZWFkZGlyID0gZnMucmVhZGRpcgpleHBvcnRzLnJlYWRsaW5rID0gZnMucmVhZGxpbmsKZXhwb3J0cy5yZWFscGF0aCA9IGZzLnJlYWxwYXRoCmV4cG9ydHMucmVuYW1lID0gZnMucmVuYW1lCmV4cG9ydHMucm0gPSBmcy5ybQpleHBvcnRzLnJtZGlyID0gZnMucm1kaXIKZXhwb3J0cy5zdGF0ID0gZnMuc3RhdApleHBvcnRzLnN5bWxpbmsgPSBmcy5zeW1saW5rCmV4cG9ydHMudW5saW5rID0gZnMudW5saW5rCmV4cG9ydHMudXRpbWVzID0gZnMudXRpbWVzCmV4cG9ydHMud2F0Y2ggPSBmcy53YXRjaApleHBvcnRzLndyaXRlRmlsZSA9IGZzLndyaXRlRmlsZQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi9iaW5kaW5nJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKCmV4cG9ydHMuY29uc3RhbnRzID0gY29uc3RhbnRzCgpleHBvcnRzLkVPTCA9IGJpbmRpbmcucGxhdGZvcm0gPT09ICd3aW4zMicgPyAnXHJcbicgOiAnXG4nCgpleHBvcnRzLnBsYXRmb3JtID0gZnVuY3Rpb24gcGxhdGZvcm0oKSB7CiAgcmV0dXJuIGJpbmRpbmcucGxhdGZvcm0KfQoKZXhwb3J0cy5hcmNoID0gZnVuY3Rpb24gYXJjaCgpIHsKICByZXR1cm4gYmluZGluZy5hcmNoCn0KCmV4cG9ydHMudHlwZSA9IGJpbmRpbmcudHlwZQpleHBvcnRzLnZlcnNpb24gPSBiaW5kaW5nLnZlcnNpb24KZXhwb3J0cy5yZWxlYXNlID0gYmluZGluZy5yZWxlYXNlCmV4cG9ydHMubWFjaGluZSA9IGJpbmRpbmcubWFjaGluZQpleHBvcnRzLmV4ZWNQYXRoID0gYmluZGluZy5leGVjUGF0aApleHBvcnRzLnBpZCA9IGJpbmRpbmcucGlkCmV4cG9ydHMucHBpZCA9IGJpbmRpbmcucHBpZApleHBvcnRzLmN3ZCA9IGJpbmRpbmcuY3dkCmV4cG9ydHMuY2hkaXIgPSBiaW5kaW5nLmNoZGlyCmV4cG9ydHMudG1wZGlyID0gYmluZGluZy50bXBkaXIKZXhwb3J0cy5ob21lZGlyID0gYmluZGluZy5ob21lZGlyCmV4cG9ydHMuaG9zdG5hbWUgPSBiaW5kaW5nLmhvc3RuYW1lCmV4cG9ydHMudXNlckluZm8gPSBiaW5kaW5nLnVzZXJJbmZvCgpleHBvcnRzLmtpbGwgPSBmdW5jdGlvbiBraWxsKHBpZCwgc2lnbmFsID0gY29uc3RhbnRzLnNpZ25hbHMuU0lHVEVSTSkgewogIGlmICh0eXBlb2Ygc2lnbmFsID09PSAnc3RyaW5nJykgewogICAgaWYgKHNpZ25hbCBpbiBjb25zdGFudHMuc2lnbmFscyA9PT0gZmFsc2UpIHsKICAgICAgdGhyb3cgZXJyb3JzLlVOS05PV05fU0lHTkFMKCdVbmtub3duIHNpZ25hbDogJyArIHNpZ25hbCkKICAgIH0KCiAgICBzaWduYWwgPSBjb25zdGFudHMuc2lnbmFsc1tzaWduYWxdCiAgfQoKICBiaW5kaW5nLmtpbGwocGlkLCBzaWduYWwpCn0KCmV4cG9ydHMuZW5kaWFubmVzcyA9IGZ1bmN0aW9uIGVuZGlhbm5lc3MoKSB7CiAgcmV0dXJuIGJpbmRpbmcuaXNMaXR0bGVFbmRpYW4gPyAnTEUnIDogJ0JFJwp9CgpleHBvcnRzLmF2YWlsYWJsZVBhcmFsbGVsaXNtID0gYmluZGluZy5hdmFpbGFibGVQYXJhbGxlbGlzbQoKZXhwb3J0cy5jcHVVc2FnZSA9IGZ1bmN0aW9uIGNwdVVzYWdlKHByZXZpb3VzKSB7CiAgY29uc3QgY3VycmVudCA9IGJpbmRpbmcuY3B1VXNhZ2UoKQoKICBpZiAocHJldmlvdXMpIHsKICAgIHJldHVybiB7CiAgICAgIHVzZXI6IGN1cnJlbnQudXNlciAtIHByZXZpb3VzLnVzZXIsCiAgICAgIHN5c3RlbTogY3VycmVudC5zeXN0ZW0gLSBwcmV2aW91cy5zeXN0ZW0KICAgIH0KICB9CgogIHJldHVybiBjdXJyZW50Cn0KCmV4cG9ydHMudGhyZWFkQ3B1VXNhZ2UgPSBmdW5jdGlvbiB0aHJlYWRDcHVVc2FnZShwcmV2aW91cykgewogIGNvbnN0IGN1cnJlbnQgPSBiaW5kaW5nLnRocmVhZENwdVVzYWdlKCkKCiAgaWYgKHByZXZpb3VzKSB7CiAgICByZXR1cm4gewogICAgICB1c2VyOiBjdXJyZW50LnVzZXIgLSBwcmV2aW91cy51c2VyLAogICAgICBzeXN0ZW06IGN1cnJlbnQuc3lzdGVtIC0gcHJldmlvdXMuc3lzdGVtCiAgICB9CiAgfQoKICByZXR1cm4gY3VycmVudAp9CgpleHBvcnRzLnJlc291cmNlVXNhZ2UgPSBiaW5kaW5nLnJlc291cmNlVXNhZ2UKZXhwb3J0cy5tZW1vcnlVc2FnZSA9IGJpbmRpbmcubWVtb3J5VXNhZ2UKZXhwb3J0cy5mcmVlbWVtID0gYmluZGluZy5mcmVlbWVtCmV4cG9ydHMudG90YWxtZW0gPSBiaW5kaW5nLnRvdGFsbWVtCmV4cG9ydHMudXB0aW1lID0gYmluZGluZy51cHRpbWUKZXhwb3J0cy5sb2FkYXZnID0gYmluZGluZy5sb2FkYXZnCmV4cG9ydHMuY3B1cyA9IGJpbmRpbmcuY3B1cwoKZXhwb3J0cy5nZXRQcm9jZXNzVGl0bGUgPSBiaW5kaW5nLmdldFByb2Nlc3NUaXRsZQoKZXhwb3J0cy5zZXRQcm9jZXNzVGl0bGUgPSBmdW5jdGlvbiBzZXRQcm9jZXNzVGl0bGUodGl0bGUpIHsKICBpZiAodHlwZW9mIHRpdGxlICE9PSAnc3RyaW5nJykgdGl0bGUgPSB0aXRsZS50b1N0cmluZygpCgogIGlmICh0aXRsZS5sZW5ndGggPj0gMjU2KSB7CiAgICB0aHJvdyBlcnJvcnMuVElUTEVfT1ZFUkZMT1coJ1Byb2Nlc3MgdGl0bGUgaXMgdG9vIGxvbmcnKQogIH0KCiAgYmluZGluZy5zZXRQcm9jZXNzVGl0bGUodGl0bGUpCn0KCmV4cG9ydHMuZ2V0RW52S2V5cyA9IGJpbmRpbmcuZ2V0RW52S2V5cwpleHBvcnRzLmdldEVudiA9IGJpbmRpbmcuZ2V0RW52CmV4cG9ydHMuaGFzRW52ID0gYmluZGluZy5oYXNFbnYKZXhwb3J0cy5zZXRFbnYgPSBiaW5kaW5nLnNldEVudgpleHBvcnRzLnVuc2V0RW52ID0gYmluZGluZy51bnNldEVudgpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IHsKICBzaWduYWxzOiBiaW5kaW5nLnNpZ25hbHMsCiAgZXJybm9zOiBiaW5kaW5nLmVycm5vcwp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgT1NFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gT1NFcnJvcikgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gJ09TRXJyb3InCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9TSUdOQUwobXNnKSB7CiAgICByZXR1cm4gbmV3IE9TRXJyb3IobXNnLCAnVU5LTk9XTl9TSUdOQUwnLCBPU0Vycm9yLlVOS05PV05fU0lHTkFMKQogIH0KCiAgc3RhdGljIFRJVExFX09WRVJGTE9XKG1zZykgewogICAgcmV0dXJuIG5ldyBPU0Vycm9yKG1zZywgJ1RJVExFX09WRVJGTE9XJywgT1NFcnJvci5USVRMRV9PVkVSRkxPVykKICB9Cn0KewogICJuYW1lIjogImJhcmUtb3MiLAogICJ2ZXJzaW9uIjogIjMuNi4yIiwKICAiZGVzY3JpcHRpb24iOiAiT3BlcmF0aW5nIHN5c3RlbSB1dGlsaXRpZXMgZm9yIEphdmFzY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4vY29uc3RhbnRzIjogIi4vbGliL2NvbnN0YW50cy5qcyIsCiAgICAiLi9lcnJvcnMiOiAiLi9saWIvZXJyb3JzLmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJiaW5kaW5nLmMiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJsaWIiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtb3MuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1vcy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtb3MjcmVhZG1lIiwKICAiZW5naW5lcyI6IHsKICAgICJiYXJlIjogIj49MS4xNC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjYiLAogICAgInByZXR0aWVyIjogIl4zLjQuMiIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIKICB9Cn0KLyogZ2xvYmFsIEJhcmUgKi8KCi8vIFRoaXMgZXhwb3J0IFNIT1VMRCBOT1QgYmUgc2hvcnRlbmVkIGluIGFueSB3YXkgYXMgaGF2aW5nIHRoZSBmdWxsCi8vIGBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoLi4uKWAgc3RhdGVtZW50IGlzIGNydWNpYWwgZm9yIHN5bnRoZXNpemluZwovLyBFU00gZXhwb3J0cy4KCmlmIChCYXJlLnBsYXRmb3JtID09PSAnd2luMzInKSB7CiAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcuL2xpYi93aW4zMicpCn0gZWxzZSB7CiAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcuL2xpYi9wb3NpeCcpCn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgQ0hBUl9VUFBFUkNBU0VfQTogMHg0MSwKICBDSEFSX0xPV0VSQ0FTRV9BOiAweDYxLAogIENIQVJfVVBQRVJDQVNFX1o6IDB4NWEsCiAgQ0hBUl9MT1dFUkNBU0VfWjogMHg3YSwKICBDSEFSX0RPVDogMHgyZSwKICBDSEFSX0ZPUldBUkRfU0xBU0g6IDB4MmYsCiAgQ0hBUl9CQUNLV0FSRF9TTEFTSDogMHg1YywKICBDSEFSX0NPTE9OOiAweDNhLAogIENIQVJfUVVFU1RJT05fTUFSSzogMHgzZgp9CmNvbnN0IG9zID0gcmVxdWlyZSgnYmFyZS1vcycpCgpjb25zdCB7IG5vcm1hbGl6ZVN0cmluZyB9ID0gcmVxdWlyZSgnLi9zaGFyZWQnKQpjb25zdCB7CiAgQ0hBUl9ET1QsCiAgQ0hBUl9GT1JXQVJEX1NMQVNICn0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpmdW5jdGlvbiBpc1Bvc2l4UGF0aFNlcGFyYXRvciAoY29kZSkgewogIHJldHVybiBjb2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKfQoKZXhwb3J0cy53aW4zMiA9IHJlcXVpcmUoJy4vd2luMzInKQpleHBvcnRzLnBvc2l4ID0gZXhwb3J0cwoKZXhwb3J0cy5zZXAgPSAnLycKZXhwb3J0cy5kZWxpbWl0ZXIgPSAnOicKCmV4cG9ydHMucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUgKC4uLmFyZ3MpIHsKICBsZXQgcmVzb2x2ZWRQYXRoID0gJycKICBsZXQgcmVzb2x2ZWRBYnNvbHV0ZSA9IGZhbHNlCgogIGZvciAobGV0IGkgPSBhcmdzLmxlbmd0aCAtIDE7IGkgPj0gLTEgJiYgIXJlc29sdmVkQWJzb2x1dGU7IGktLSkgewogICAgY29uc3QgcGF0aCA9IGkgPj0gMCA/IGFyZ3NbaV0gOiBvcy5jd2QoKQoKICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgewogICAgICBjb250aW51ZQogICAgfQoKICAgIHJlc29sdmVkUGF0aCA9IGAke3BhdGh9LyR7cmVzb2x2ZWRQYXRofWAKICAgIHJlc29sdmVkQWJzb2x1dGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfRk9SV0FSRF9TTEFTSAogIH0KCiAgcmVzb2x2ZWRQYXRoID0gbm9ybWFsaXplU3RyaW5nKHJlc29sdmVkUGF0aCwgIXJlc29sdmVkQWJzb2x1dGUsICcvJywgaXNQb3NpeFBhdGhTZXBhcmF0b3IpCgogIGlmIChyZXNvbHZlZEFic29sdXRlKSB7CiAgICByZXR1cm4gYC8ke3Jlc29sdmVkUGF0aH1gCiAgfQoKICByZXR1cm4gcmVzb2x2ZWRQYXRoLmxlbmd0aCA+IDAgPyByZXNvbHZlZFBhdGggOiAnLicKfQoKZXhwb3J0cy5ub3JtYWxpemUgPSBmdW5jdGlvbiBub3JtYWxpemUgKHBhdGgpIHsKICBpZiAocGF0aC5sZW5ndGggPT09IDApIHJldHVybiAnLicKCiAgY29uc3QgaXNBYnNvbHV0ZSA9IHBhdGguY2hhckNvZGVBdCgwKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICiAgY29uc3QgdHJhaWxpbmdTZXBhcmF0b3IgPSBwYXRoLmNoYXJDb2RlQXQocGF0aC5sZW5ndGggLSAxKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNICgogIHBhdGggPSBub3JtYWxpemVTdHJpbmcocGF0aCwgIWlzQWJzb2x1dGUsICcvJywgaXNQb3NpeFBhdGhTZXBhcmF0b3IpCgogIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgewogICAgaWYgKGlzQWJzb2x1dGUpIHJldHVybiAnLycKICAgIHJldHVybiB0cmFpbGluZ1NlcGFyYXRvciA/ICcuLycgOiAnLicKICB9CgogIGlmICh0cmFpbGluZ1NlcGFyYXRvcikgcGF0aCArPSAnLycKCiAgcmV0dXJuIGlzQWJzb2x1dGUgPyBgLyR7cGF0aH1gIDogcGF0aAp9CgpleHBvcnRzLmlzQWJzb2x1dGUgPSBmdW5jdGlvbiBpc0Fic29sdXRlIChwYXRoKSB7CiAgcmV0dXJuIHBhdGgubGVuZ3RoID4gMCAmJiBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfRk9SV0FSRF9TTEFTSAp9CgpleHBvcnRzLmpvaW4gPSBmdW5jdGlvbiBqb2luICguLi5hcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nCiAgbGV0IGpvaW5lZAogIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7ICsraSkgewogICAgY29uc3QgYXJnID0gYXJnc1tpXQogICAgaWYgKGFyZy5sZW5ndGggPiAwKSB7CiAgICAgIGlmIChqb2luZWQgPT09IHVuZGVmaW5lZCkgam9pbmVkID0gYXJnCiAgICAgIGVsc2Ugam9pbmVkICs9IGAvJHthcmd9YAogICAgfQogIH0KICBpZiAoam9pbmVkID09PSB1bmRlZmluZWQpIHJldHVybiAnLicKICByZXR1cm4gZXhwb3J0cy5ub3JtYWxpemUoam9pbmVkKQp9CgpleHBvcnRzLnJlbGF0aXZlID0gZnVuY3Rpb24gcmVsYXRpdmUgKGZyb20sIHRvKSB7CiAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJycKCiAgZnJvbSA9IGV4cG9ydHMucmVzb2x2ZShmcm9tKQogIHRvID0gZXhwb3J0cy5yZXNvbHZlKHRvKQoKICBpZiAoZnJvbSA9PT0gdG8pIHJldHVybiAnJwoKICBjb25zdCBmcm9tU3RhcnQgPSAxCiAgY29uc3QgZnJvbUVuZCA9IGZyb20ubGVuZ3RoCiAgY29uc3QgZnJvbUxlbiA9IGZyb21FbmQgLSBmcm9tU3RhcnQKICBjb25zdCB0b1N0YXJ0ID0gMQogIGNvbnN0IHRvTGVuID0gdG8ubGVuZ3RoIC0gdG9TdGFydAoKICBjb25zdCBsZW5ndGggPSAoZnJvbUxlbiA8IHRvTGVuID8gZnJvbUxlbiA6IHRvTGVuKQogIGxldCBsYXN0Q29tbW9uU2VwID0gLTEKICBsZXQgaSA9IDAKICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBmcm9tQ29kZSA9IGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKQogICAgaWYgKGZyb21Db2RlICE9PSB0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSkgewogICAgICBicmVhawogICAgfSBlbHNlIGlmIChmcm9tQ29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIGxhc3RDb21tb25TZXAgPSBpCiAgICB9CiAgfQogIGlmIChpID09PSBsZW5ndGgpIHsKICAgIGlmICh0b0xlbiA+IGxlbmd0aCkgewogICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICAgIHJldHVybiB0by5zdWJzdHJpbmcodG9TdGFydCArIGkgKyAxKQogICAgICB9CiAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRvLnN1YnN0cmluZyh0b1N0YXJ0ICsgaSkKICAgICAgfQogICAgfSBlbHNlIGlmIChmcm9tTGVuID4gbGVuZ3RoKSB7CiAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkgPT09IENIQVJfRk9SV0FSRF9TTEFTSCkgewogICAgICAgIGxhc3RDb21tb25TZXAgPSBpCiAgICAgIH0gZWxzZSBpZiAoaSA9PT0gMCkgewogICAgICAgIGxhc3RDb21tb25TZXAgPSAwCiAgICAgIH0KICAgIH0KICB9CgogIGxldCBvdXQgPSAnJwogIGZvciAoaSA9IGZyb21TdGFydCArIGxhc3RDb21tb25TZXAgKyAxOyBpIDw9IGZyb21FbmQ7ICsraSkgewogICAgaWYgKGkgPT09IGZyb21FbmQgfHwgZnJvbS5jaGFyQ29kZUF0KGkpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgb3V0ICs9IG91dC5sZW5ndGggPT09IDAgPyAnLi4nIDogJy8uLicKICAgIH0KICB9CgogIHJldHVybiBgJHtvdXR9JHt0by5zdWJzdHJpbmcodG9TdGFydCArIGxhc3RDb21tb25TZXApfWAKfQoKZXhwb3J0cy50b05hbWVzcGFjZWRQYXRoID0gZnVuY3Rpb24gdG9OYW1lc3BhY2VkUGF0aCAocGF0aCkgewogIHJldHVybiBwYXRoCn0KCmV4cG9ydHMuZGlybmFtZSA9IGZ1bmN0aW9uIGRpcm5hbWUgKHBhdGgpIHsKICBpZiAocGF0aC5sZW5ndGggPT09IDApIHJldHVybiAnLicKICBjb25zdCBoYXNSb290ID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSBDSEFSX0ZPUldBUkRfU0xBU0gKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQogIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMTsgLS1pKSB7CiAgICBpZiAocGF0aC5jaGFyQ29kZUF0KGkpID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBlbmQgPSBpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgIH0KICB9CgogIGlmIChlbmQgPT09IC0xKSByZXR1cm4gaGFzUm9vdCA/ICcvJyA6ICcuJwogIGlmIChoYXNSb290ICYmIGVuZCA9PT0gMSkgcmV0dXJuICcvLycKICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoMCwgZW5kKQp9CgpleHBvcnRzLmJhc2VuYW1lID0gZnVuY3Rpb24gYmFzZW5hbWUgKHBhdGgsIHN1ZmZpeCkgewogIGxldCBzdGFydCA9IDAKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQoKICBpZiAoc3VmZml4ICE9PSB1bmRlZmluZWQgJiYgc3VmZml4Lmxlbmd0aCA+IDAgJiYgc3VmZml4Lmxlbmd0aCA8PSBwYXRoLmxlbmd0aCkgewogICAgaWYgKHN1ZmZpeCA9PT0gcGF0aCkgeyByZXR1cm4gJycgfQogICAgbGV0IGV4dElkeCA9IHN1ZmZpeC5sZW5ndGggLSAxCiAgICBsZXQgZmlyc3ROb25TbGFzaEVuZCA9IC0xCiAgICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICAgIGlmIChjb2RlID09PSBDSEFSX0ZPUldBUkRfU0xBU0gpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgc3RhcnQgPSBpICsgMQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGZpcnN0Tm9uU2xhc2hFbmQgPT09IC0xKSB7CiAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICAgICAgZmlyc3ROb25TbGFzaEVuZCA9IGkgKyAxCiAgICAgICAgfQogICAgICAgIGlmIChleHRJZHggPj0gMCkgewogICAgICAgICAgaWYgKGNvZGUgPT09IHN1ZmZpeC5jaGFyQ29kZUF0KGV4dElkeCkpIHsKICAgICAgICAgICAgaWYgKC0tZXh0SWR4ID09PSAtMSkgewogICAgICAgICAgICAgIGVuZCA9IGkKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0SWR4ID0gLTEKICAgICAgICAgICAgZW5kID0gZmlyc3ROb25TbGFzaEVuZAogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChzdGFydCA9PT0gZW5kKSBlbmQgPSBmaXJzdE5vblNsYXNoRW5kCiAgICBlbHNlIGlmIChlbmQgPT09IC0xKSBlbmQgPSBwYXRoLmxlbmd0aAogICAgcmV0dXJuIHBhdGguc3Vic3RyaW5nKHN0YXJ0LCBlbmQpCiAgfQoKICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgaWYgKHBhdGguY2hhckNvZGVBdChpKSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnQgPSBpICsgMQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogIH0KCiAgaWYgKGVuZCA9PT0gLTEpIHJldHVybiAnJwogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydCwgZW5kKQp9CgpleHBvcnRzLmV4dG5hbWUgPSBmdW5jdGlvbiBleHRuYW1lIChwYXRoKSB7CiAgbGV0IHN0YXJ0RG90ID0gLTEKICBsZXQgc3RhcnRQYXJ0ID0gMAogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCiAgbGV0IHByZURvdFN0YXRlID0gMAogIGZvciAobGV0IGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICBjb25zdCBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICBpZiAoY29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnRQYXJ0ID0gaSArIDEKICAgICAgICBicmVhawogICAgICB9CiAgICAgIGNvbnRpbnVlCiAgICB9CiAgICBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogICAgaWYgKGNvZGUgPT09IENIQVJfRE9UKSB7CiAgICAgIGlmIChzdGFydERvdCA9PT0gLTEpIHN0YXJ0RG90ID0gaQogICAgICBlbHNlIGlmIChwcmVEb3RTdGF0ZSAhPT0gMSkgcHJlRG90U3RhdGUgPSAxCiAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewogICAgICBwcmVEb3RTdGF0ZSA9IC0xCiAgICB9CiAgfQoKICBpZiAoc3RhcnREb3QgPT09IC0xIHx8IGVuZCA9PT0gLTEgfHwgcHJlRG90U3RhdGUgPT09IDAgfHwgKHByZURvdFN0YXRlID09PSAxICYmIHN0YXJ0RG90ID09PSBlbmQgLSAxICYmIHN0YXJ0RG90ID09PSBzdGFydFBhcnQgKyAxKSkgewogICAgcmV0dXJuICcnCiAgfQogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydERvdCwgZW5kKQp9CmNvbnN0IHsKICBDSEFSX0RPVCwKICBDSEFSX0ZPUldBUkRfU0xBU0gKfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmV4cG9ydHMubm9ybWFsaXplU3RyaW5nID0gZnVuY3Rpb24gbm9ybWFsaXplU3RyaW5nIChwYXRoLCBhbGxvd0Fib3ZlUm9vdCwgc2VwYXJhdG9yLCBpc1BhdGhTZXBhcmF0b3IpIHsKICBsZXQgcmVzID0gJycKICBsZXQgbGFzdFNlZ21lbnRMZW5ndGggPSAwCiAgbGV0IGxhc3RTbGFzaCA9IC0xCiAgbGV0IGRvdHMgPSAwCiAgbGV0IGNvZGUgPSAwCiAgZm9yIChsZXQgaSA9IDA7IGkgPD0gcGF0aC5sZW5ndGg7ICsraSkgewogICAgaWYgKGkgPCBwYXRoLmxlbmd0aCkgewogICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpCiAgICB9IGVsc2UgaWYgKGlzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICBicmVhawogICAgfSBlbHNlIHsKICAgICAgY29kZSA9IENIQVJfRk9SV0FSRF9TTEFTSAogICAgfQoKICAgIGlmIChpc1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgaWYgKGxhc3RTbGFzaCA9PT0gaSAtIDEgfHwgZG90cyA9PT0gMSkgOwogICAgICBlbHNlIGlmIChkb3RzID09PSAyKSB7CiAgICAgICAgaWYgKHJlcy5sZW5ndGggPCAyIHx8IGxhc3RTZWdtZW50TGVuZ3RoICE9PSAyIHx8IHJlcy5jaGFyQ29kZUF0KHJlcy5sZW5ndGggLSAxKSAhPT0gQ0hBUl9ET1QgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDIpICE9PSBDSEFSX0RPVCkgewogICAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgIGNvbnN0IGxhc3RTbGFzaEluZGV4ID0gcmVzLmxhc3RJbmRleE9mKHNlcGFyYXRvcikKICAgICAgICAgICAgaWYgKGxhc3RTbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgIHJlcyA9ICcnCiAgICAgICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSAwCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzID0gcmVzLnN1YnN0cmluZygwLCBsYXN0U2xhc2hJbmRleCkKICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9CiAgICAgICAgICAgICAgICByZXMubGVuZ3RoIC0gMSAtIHJlcy5sYXN0SW5kZXhPZihzZXBhcmF0b3IpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdFNsYXNoID0gaQogICAgICAgICAgICBkb3RzID0gMAogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfSBlbHNlIGlmIChyZXMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHJlcyA9ICcnCiAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMAogICAgICAgICAgICBsYXN0U2xhc2ggPSBpCiAgICAgICAgICAgIGRvdHMgPSAwCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhbGxvd0Fib3ZlUm9vdCkgewogICAgICAgICAgcmVzICs9IHJlcy5sZW5ndGggPiAwID8gYCR7c2VwYXJhdG9yfS4uYCA6ICcuLicKICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMgogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJlcyArPSBgJHtzZXBhcmF0b3J9JHtwYXRoLnN1YnN0cmluZyhsYXN0U2xhc2ggKyAxLCBpKX1gCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlcyA9IHBhdGguc3Vic3RyaW5nKGxhc3RTbGFzaCArIDEsIGkpCiAgICAgICAgfQogICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gaSAtIGxhc3RTbGFzaCAtIDEKICAgICAgfQogICAgICBsYXN0U2xhc2ggPSBpCiAgICAgIGRvdHMgPSAwCiAgICB9IGVsc2UgaWYgKGNvZGUgPT09IENIQVJfRE9UICYmIGRvdHMgIT09IC0xKSB7CiAgICAgICsrZG90cwogICAgfSBlbHNlIHsKICAgICAgZG90cyA9IC0xCiAgICB9CiAgfQogIHJldHVybiByZXMKfQpjb25zdCBvcyA9IHJlcXVpcmUoJ2JhcmUtb3MnKQoKY29uc3QgeyBub3JtYWxpemVTdHJpbmcgfSA9IHJlcXVpcmUoJy4vc2hhcmVkJykKY29uc3QgewogIENIQVJfVVBQRVJDQVNFX0EsCiAgQ0hBUl9MT1dFUkNBU0VfQSwKICBDSEFSX1VQUEVSQ0FTRV9aLAogIENIQVJfTE9XRVJDQVNFX1osCiAgQ0hBUl9ET1QsCiAgQ0hBUl9GT1JXQVJEX1NMQVNILAogIENIQVJfQkFDS1dBUkRfU0xBU0gsCiAgQ0hBUl9DT0xPTiwKICBDSEFSX1FVRVNUSU9OX01BUksKfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmZ1bmN0aW9uIGlzV2luZG93c1BhdGhTZXBhcmF0b3IgKGNvZGUpIHsKICByZXR1cm4gY29kZSA9PT0gQ0hBUl9GT1JXQVJEX1NMQVNIIHx8IGNvZGUgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gKfQoKZnVuY3Rpb24gaXNXaW5kb3dzRGV2aWNlUm9vdCAoY29kZSkgewogIHJldHVybiAoY29kZSA+PSBDSEFSX1VQUEVSQ0FTRV9BICYmIGNvZGUgPD0gQ0hBUl9VUFBFUkNBU0VfWikgfHwKICAgICAgICAgKGNvZGUgPj0gQ0hBUl9MT1dFUkNBU0VfQSAmJiBjb2RlIDw9IENIQVJfTE9XRVJDQVNFX1opCn0KCmV4cG9ydHMucG9zaXggPSByZXF1aXJlKCcuL3Bvc2l4JykKZXhwb3J0cy53aW4zMiA9IGV4cG9ydHMKCmV4cG9ydHMuc2VwID0gJ1xcJwpleHBvcnRzLmRlbGltaXRlciA9ICc7JwoKZXhwb3J0cy5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZSAoLi4uYXJncykgewogIGxldCByZXNvbHZlZERldmljZSA9ICcnCiAgbGV0IHJlc29sdmVkVGFpbCA9ICcnCiAgbGV0IHJlc29sdmVkQWJzb2x1dGUgPSBmYWxzZQoKICBmb3IgKGxldCBpID0gYXJncy5sZW5ndGggLSAxOyBpID49IC0xOyBpLS0pIHsKICAgIGxldCBwYXRoCiAgICBpZiAoaSA+PSAwKSB7CiAgICAgIHBhdGggPSBhcmdzW2ldCgogICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIGNvbnRpbnVlCiAgICB9IGVsc2UgaWYgKHJlc29sdmVkRGV2aWNlLmxlbmd0aCA9PT0gMCkgewogICAgICBwYXRoID0gb3MuY3dkKCkKICAgIH0gZWxzZSB7CiAgICAgIHBhdGggPSBvcy5nZXRFbnYoYD0ke3Jlc29sdmVkRGV2aWNlfWApIHx8IG9zLmN3ZCgpCgogICAgICBpZiAocGF0aCA9PT0gdW5kZWZpbmVkIHx8IChwYXRoLnN1YnN0cmluZygwLCAyKS50b0xvd2VyQ2FzZSgpICE9PSByZXNvbHZlZERldmljZS50b0xvd2VyQ2FzZSgpICYmIHBhdGguY2hhckNvZGVBdCgyKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkpIHsKICAgICAgICBwYXRoID0gYCR7cmVzb2x2ZWREZXZpY2V9XFxgCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBsZW4gPSBwYXRoLmxlbmd0aAogICAgbGV0IHJvb3RFbmQgPSAwCiAgICBsZXQgZGV2aWNlID0gJycKICAgIGxldCBpc0Fic29sdXRlID0gZmFsc2UKICAgIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgICBpZiAobGVuID09PSAxKSB7CiAgICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgICAgcm9vdEVuZCA9IDEKICAgICAgICBpc0Fic29sdXRlID0gdHJ1ZQogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkpIHsKICAgICAgaXNBYnNvbHV0ZSA9IHRydWUKCiAgICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgxKSkpIHsKICAgICAgICBsZXQgaiA9IDIKICAgICAgICBsZXQgbGFzdCA9IGoKICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICBqKysKICAgICAgICB9CiAgICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgICAgY29uc3QgZmlyc3RQYXJ0ID0gcGF0aC5zdWJzdHJpbmcobGFzdCwgaikKICAgICAgICAgIGxhc3QgPSBqCiAgICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgICAgaisrCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA8IGxlbiAmJiBqICE9PSBsYXN0KSB7CiAgICAgICAgICAgIGxhc3QgPSBqCiAgICAgICAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgICAgICBqKysKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaiA9PT0gbGVuIHx8IGogIT09IGxhc3QpIHsKICAgICAgICAgICAgICBkZXZpY2UgPSBgXFxcXCR7Zmlyc3RQYXJ0fVxcJHtwYXRoLnN1YnN0cmluZyhsYXN0LCBqKX1gCiAgICAgICAgICAgICAgcm9vdEVuZCA9IGoKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByb290RW5kID0gMQogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzV2luZG93c0RldmljZVJvb3QoY29kZSkgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OKSB7CiAgICAgIGRldmljZSA9IHBhdGguc3Vic3RyaW5nKDAsIDIpCiAgICAgIHJvb3RFbmQgPSAyCiAgICAgIGlmIChsZW4gPiAyICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KDIpKSkgewogICAgICAgIGlzQWJzb2x1dGUgPSB0cnVlCiAgICAgICAgcm9vdEVuZCA9IDMKICAgICAgfQogICAgfQoKICAgIGlmIChkZXZpY2UubGVuZ3RoID4gMCkgewogICAgICBpZiAocmVzb2x2ZWREZXZpY2UubGVuZ3RoID4gMCkgewogICAgICAgIGlmIChkZXZpY2UudG9Mb3dlckNhc2UoKSAhPT0gcmVzb2x2ZWREZXZpY2UudG9Mb3dlckNhc2UoKSkgeyBjb250aW51ZSB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzb2x2ZWREZXZpY2UgPSBkZXZpY2UKICAgICAgfQogICAgfQoKICAgIGlmIChyZXNvbHZlZEFic29sdXRlKSB7CiAgICAgIGlmIChyZXNvbHZlZERldmljZS5sZW5ndGggPiAwKSB7IGJyZWFrIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlc29sdmVkVGFpbCA9IGAke3BhdGguc3Vic3RyaW5nKHJvb3RFbmQpfVxcJHtyZXNvbHZlZFRhaWx9YAogICAgICByZXNvbHZlZEFic29sdXRlID0gaXNBYnNvbHV0ZQogICAgICBpZiAoaXNBYnNvbHV0ZSAmJiByZXNvbHZlZERldmljZS5sZW5ndGggPiAwKSB7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIH0KCiAgcmVzb2x2ZWRUYWlsID0gbm9ybWFsaXplU3RyaW5nKHJlc29sdmVkVGFpbCwgIXJlc29sdmVkQWJzb2x1dGUsICdcXCcsIGlzV2luZG93c1BhdGhTZXBhcmF0b3IpCgogIHJldHVybiByZXNvbHZlZEFic29sdXRlID8gYCR7cmVzb2x2ZWREZXZpY2V9XFwke3Jlc29sdmVkVGFpbH1gIDogYCR7cmVzb2x2ZWREZXZpY2V9JHtyZXNvbHZlZFRhaWx9YCB8fCAnLicKfQoKZXhwb3J0cy5ub3JtYWxpemUgPSBmdW5jdGlvbiBub3JtYWxpemUgKHBhdGgpIHsKICBjb25zdCBsZW4gPSBwYXRoLmxlbmd0aAogIGlmIChsZW4gPT09IDApIHJldHVybiAnLicKICBsZXQgcm9vdEVuZCA9IDAKICBsZXQgZGV2aWNlCiAgbGV0IGlzQWJzb2x1dGUgPSBmYWxzZQogIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgaWYgKGxlbiA9PT0gMSkgewogICAgcmV0dXJuIGNvZGUgPT09IENIQVJfRk9SV0FSRF9TTEFTSCA/ICdcXCcgOiBwYXRoCiAgfQoKICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgaXNBYnNvbHV0ZSA9IHRydWUKCiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMSkpKSB7CiAgICAgIGxldCBqID0gMgogICAgICBsZXQgbGFzdCA9IGoKICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgIGorKwogICAgICB9CiAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICBjb25zdCBmaXJzdFBhcnQgPSBwYXRoLnN1YnN0cmluZyhsYXN0LCBqKQogICAgICAgIGxhc3QgPSBqCiAgICAgICAgd2hpbGUgKGogPCBsZW4gJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICBqKysKICAgICAgICB9CiAgICAgICAgaWYgKGogPCBsZW4gJiYgaiAhPT0gbGFzdCkgewogICAgICAgICAgbGFzdCA9IGoKICAgICAgICAgIHdoaWxlIChqIDwgbGVuICYmICFpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChqKSkpIHsKICAgICAgICAgICAgaisrCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA9PT0gbGVuKSB7CiAgICAgICAgICAgIHJldHVybiBgXFxcXCR7Zmlyc3RQYXJ0fVxcJHtwYXRoLnN1YnN0cmluZyhsYXN0KX1cXGAKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqICE9PSBsYXN0KSB7CiAgICAgICAgICAgIGRldmljZSA9IGBcXFxcJHtmaXJzdFBhcnR9XFwke3BhdGguc3Vic3RyaW5nKGxhc3QsIGopfWAKICAgICAgICAgICAgcm9vdEVuZCA9IGoKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJvb3RFbmQgPSAxCiAgICB9CiAgfSBlbHNlIGlmIChpc1dpbmRvd3NEZXZpY2VSb290KGNvZGUpICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTikgewogICAgZGV2aWNlID0gcGF0aC5zdWJzdHJpbmcoMCwgMikKICAgIHJvb3RFbmQgPSAyCiAgICBpZiAobGVuID4gMiAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdCgyKSkpIHsKICAgICAgaXNBYnNvbHV0ZSA9IHRydWUKICAgICAgcm9vdEVuZCA9IDMKICAgIH0KICB9CgogIGxldCB0YWlsID0gcm9vdEVuZCA8IGxlbiA/IG5vcm1hbGl6ZVN0cmluZyhwYXRoLnN1YnN0cmluZyhyb290RW5kKSwgIWlzQWJzb2x1dGUsICdcXCcsIGlzV2luZG93c1BhdGhTZXBhcmF0b3IpIDogJycKICBpZiAodGFpbC5sZW5ndGggPT09IDAgJiYgIWlzQWJzb2x1dGUpIHsKICAgIHRhaWwgPSAnLicKICB9CiAgaWYgKHRhaWwubGVuZ3RoID4gMCAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChsZW4gLSAxKSkpIHsKICAgIHRhaWwgKz0gJ1xcJwogIH0KICBpZiAoZGV2aWNlID09PSB1bmRlZmluZWQpIHsKICAgIHJldHVybiBpc0Fic29sdXRlID8gYFxcJHt0YWlsfWAgOiB0YWlsCiAgfQogIHJldHVybiBpc0Fic29sdXRlID8gYCR7ZGV2aWNlfVxcJHt0YWlsfWAgOiBgJHtkZXZpY2V9JHt0YWlsfWAKfQoKZXhwb3J0cy5pc0Fic29sdXRlID0gZnVuY3Rpb24gaXNBYnNvbHV0ZSAocGF0aCkgewogIGNvbnN0IGxlbiA9IHBhdGgubGVuZ3RoCiAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIGZhbHNlCgogIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgcmV0dXJuIGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkgfHwgKGxlbiA+IDIgJiYgaXNXaW5kb3dzRGV2aWNlUm9vdChjb2RlKSAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04gJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMikpKQp9CgpleHBvcnRzLmpvaW4gPSBmdW5jdGlvbiBqb2luICguLi5hcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nCgogIGxldCBqb2luZWQKICBsZXQgZmlyc3RQYXJ0CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgKytpKSB7CiAgICBjb25zdCBhcmcgPSBhcmdzW2ldCiAgICBpZiAoYXJnLmxlbmd0aCA+IDApIHsKICAgICAgaWYgKGpvaW5lZCA9PT0gdW5kZWZpbmVkKSBqb2luZWQgPSBmaXJzdFBhcnQgPSBhcmcKICAgICAgZWxzZSBqb2luZWQgKz0gYFxcJHthcmd9YAogICAgfQogIH0KCiAgaWYgKGpvaW5lZCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJy4nCgogIGxldCBuZWVkc1JlcGxhY2UgPSB0cnVlCiAgbGV0IHNsYXNoQ291bnQgPSAwCiAgaWYgKGlzV2luZG93c1BhdGhTZXBhcmF0b3IoZmlyc3RQYXJ0LmNoYXJDb2RlQXQoMCkpKSB7CiAgICArK3NsYXNoQ291bnQKICAgIGNvbnN0IGZpcnN0TGVuID0gZmlyc3RQYXJ0Lmxlbmd0aAogICAgaWYgKGZpcnN0TGVuID4gMSAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGZpcnN0UGFydC5jaGFyQ29kZUF0KDEpKSkgewogICAgICArK3NsYXNoQ291bnQKICAgICAgaWYgKGZpcnN0TGVuID4gMikgewogICAgICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGZpcnN0UGFydC5jaGFyQ29kZUF0KDIpKSkgewogICAgICAgICAgKytzbGFzaENvdW50CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5lZWRzUmVwbGFjZSA9IGZhbHNlCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGlmIChuZWVkc1JlcGxhY2UpIHsKICAgIHdoaWxlIChzbGFzaENvdW50IDwgam9pbmVkLmxlbmd0aCAmJiBpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGpvaW5lZC5jaGFyQ29kZUF0KHNsYXNoQ291bnQpKSkgewogICAgICBzbGFzaENvdW50KysKICAgIH0KCiAgICBpZiAoc2xhc2hDb3VudCA+PSAyKSB7CiAgICAgIGpvaW5lZCA9IGBcXCR7am9pbmVkLnN1YnN0cmluZyhzbGFzaENvdW50KX1gCiAgICB9CiAgfQoKICByZXR1cm4gZXhwb3J0cy5ub3JtYWxpemUoam9pbmVkKQp9CgpleHBvcnRzLnJlbGF0aXZlID0gZnVuY3Rpb24gcmVsYXRpdmUgKGZyb20sIHRvKSB7CiAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJycKCiAgY29uc3QgZnJvbU9yaWcgPSBleHBvcnRzLnJlc29sdmUoZnJvbSkKICBjb25zdCB0b09yaWcgPSBleHBvcnRzLnJlc29sdmUodG8pCgogIGlmIChmcm9tT3JpZyA9PT0gdG9PcmlnKSByZXR1cm4gJycKCiAgZnJvbSA9IGZyb21PcmlnLnRvTG93ZXJDYXNlKCkKICB0byA9IHRvT3JpZy50b0xvd2VyQ2FzZSgpCgogIGlmIChmcm9tID09PSB0bykgcmV0dXJuICcnCgogIGxldCBmcm9tU3RhcnQgPSAwCiAgd2hpbGUgKGZyb21TdGFydCA8IGZyb20ubGVuZ3RoICYmIGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICBmcm9tU3RhcnQrKwogIH0KICBsZXQgZnJvbUVuZCA9IGZyb20ubGVuZ3RoCiAgd2hpbGUgKGZyb21FbmQgLSAxID4gZnJvbVN0YXJ0ICYmIGZyb20uY2hhckNvZGVBdChmcm9tRW5kIC0gMSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgIGZyb21FbmQtLQogIH0KICBjb25zdCBmcm9tTGVuID0gZnJvbUVuZCAtIGZyb21TdGFydAoKICBsZXQgdG9TdGFydCA9IDAKICB3aGlsZSAodG9TdGFydCA8IHRvLmxlbmd0aCAmJiB0by5jaGFyQ29kZUF0KHRvU3RhcnQpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICB0b1N0YXJ0KysKICB9CiAgbGV0IHRvRW5kID0gdG8ubGVuZ3RoCiAgd2hpbGUgKHRvRW5kIC0gMSA+IHRvU3RhcnQgJiYgdG8uY2hhckNvZGVBdCh0b0VuZCAtIDEpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICB0b0VuZC0tCiAgfQogIGNvbnN0IHRvTGVuID0gdG9FbmQgLSB0b1N0YXJ0CgogIGNvbnN0IGxlbmd0aCA9IGZyb21MZW4gPCB0b0xlbiA/IGZyb21MZW4gOiB0b0xlbgogIGxldCBsYXN0Q29tbW9uU2VwID0gLTEKICBsZXQgaSA9IDAKICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBmcm9tQ29kZSA9IGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKQogICAgaWYgKGZyb21Db2RlICE9PSB0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSkgewogICAgICBicmVhawogICAgfSBlbHNlIGlmIChmcm9tQ29kZSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICBsYXN0Q29tbW9uU2VwID0gaQogICAgfQogIH0KCiAgaWYgKGkgIT09IGxlbmd0aCkgewogICAgaWYgKGxhc3RDb21tb25TZXAgPT09IC0xKSByZXR1cm4gdG9PcmlnCiAgfSBlbHNlIHsKICAgIGlmICh0b0xlbiA+IGxlbmd0aCkgewogICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgICAgICByZXR1cm4gdG9PcmlnLnN1YnN0cmluZyh0b1N0YXJ0ICsgaSArIDEpCiAgICAgIH0KICAgICAgaWYgKGkgPT09IDIpIHsKICAgICAgICByZXR1cm4gdG9PcmlnLnN1YnN0cmluZyh0b1N0YXJ0ICsgaSkKICAgICAgfQogICAgfQogICAgaWYgKGZyb21MZW4gPiBsZW5ndGgpIHsKICAgICAgaWYgKGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICAgIGxhc3RDb21tb25TZXAgPSBpCiAgICAgIH0gZWxzZSBpZiAoaSA9PT0gMikgewogICAgICAgIGxhc3RDb21tb25TZXAgPSAzCiAgICAgIH0KICAgIH0KICAgIGlmIChsYXN0Q29tbW9uU2VwID09PSAtMSkgbGFzdENvbW1vblNlcCA9IDAKICB9CgogIGxldCBvdXQgPSAnJwogIGZvciAoaSA9IGZyb21TdGFydCArIGxhc3RDb21tb25TZXAgKyAxOyBpIDw9IGZyb21FbmQ7ICsraSkgewogICAgaWYgKGkgPT09IGZyb21FbmQgfHwgZnJvbS5jaGFyQ29kZUF0KGkpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICAgIG91dCArPSBvdXQubGVuZ3RoID09PSAwID8gJy4uJyA6ICdcXC4uJwogICAgfQogIH0KCiAgdG9TdGFydCArPSBsYXN0Q29tbW9uU2VwCgogIGlmIChvdXQubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGAke291dH0ke3RvT3JpZy5zdWJzdHJpbmcodG9TdGFydCwgdG9FbmQpfWAKICB9CiAgaWYgKHRvT3JpZy5jaGFyQ29kZUF0KHRvU3RhcnQpID09PSBDSEFSX0JBQ0tXQVJEX1NMQVNIKSB7CiAgICArK3RvU3RhcnQKICB9CiAgcmV0dXJuIHRvT3JpZy5zdWJzdHJpbmcodG9TdGFydCwgdG9FbmQpCn0KCmV4cG9ydHMudG9OYW1lc3BhY2VkUGF0aCA9IGZ1bmN0aW9uIHRvTmFtZXNwYWNlZFBhdGggKHBhdGgpIHsKICBpZiAocGF0aC5sZW5ndGggPT09IDApIHJldHVybiBwYXRoCgogIGNvbnN0IHJlc29sdmVkUGF0aCA9IGV4cG9ydHMucmVzb2x2ZShwYXRoKQoKICBpZiAocmVzb2x2ZWRQYXRoLmxlbmd0aCA8PSAyKSByZXR1cm4gcGF0aAoKICBpZiAocmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMCkgPT09IENIQVJfQkFDS1dBUkRfU0xBU0gpIHsKICAgIGlmIChyZXNvbHZlZFBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkgewogICAgICBjb25zdCBjb2RlID0gcmVzb2x2ZWRQYXRoLmNoYXJDb2RlQXQoMikKICAgICAgaWYgKGNvZGUgIT09IENIQVJfUVVFU1RJT05fTUFSSyAmJiBjb2RlICE9PSBDSEFSX0RPVCkgewogICAgICAgIHJldHVybiBgXFxcXD9cXFVOQ1xcJHtyZXNvbHZlZFBhdGguc3Vic3RyaW5nKDIpfWAKICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAoCiAgICBpc1dpbmRvd3NEZXZpY2VSb290KHJlc29sdmVkUGF0aC5jaGFyQ29kZUF0KDApKSAmJgogICAgICByZXNvbHZlZFBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTiAmJgogICAgICByZXNvbHZlZFBhdGguY2hhckNvZGVBdCgyKSA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSAogICkgewogICAgcmV0dXJuIGBcXFxcP1xcJHtyZXNvbHZlZFBhdGh9YAogIH0KCiAgcmV0dXJuIHBhdGgKfQoKZXhwb3J0cy5kaXJuYW1lID0gZnVuY3Rpb24gZGlybmFtZSAocGF0aCkgewogIGNvbnN0IGxlbiA9IHBhdGgubGVuZ3RoCiAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuICcuJwogIGxldCByb290RW5kID0gLTEKICBsZXQgb2Zmc2V0ID0gMAogIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkKCiAgaWYgKGxlbiA9PT0gMSkgewogICAgcmV0dXJuIGlzV2luZG93c1BhdGhTZXBhcmF0b3IoY29kZSkgPyBwYXRoIDogJy4nCiAgfQoKICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgcm9vdEVuZCA9IG9mZnNldCA9IDEKCiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMSkpKSB7CiAgICAgIGxldCBqID0gMgogICAgICBsZXQgbGFzdCA9IGoKICAgICAgd2hpbGUgKGogPCBsZW4gJiYgIWlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgIGorKwogICAgICB9CiAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICBsYXN0ID0gagogICAgICAgIHdoaWxlIChqIDwgbGVuICYmIGlzV2luZG93c1BhdGhTZXBhcmF0b3IocGF0aC5jaGFyQ29kZUF0KGopKSkgewogICAgICAgICAgaisrCiAgICAgICAgfQogICAgICAgIGlmIChqIDwgbGVuICYmIGogIT09IGxhc3QpIHsKICAgICAgICAgIGxhc3QgPSBqCiAgICAgICAgICB3aGlsZSAoaiA8IGxlbiAmJiAhaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaikpKSB7CiAgICAgICAgICAgIGorKwogICAgICAgICAgfQogICAgICAgICAgaWYgKGogPT09IGxlbikgewogICAgICAgICAgICByZXR1cm4gcGF0aAogICAgICAgICAgfQogICAgICAgICAgaWYgKGogIT09IGxhc3QpIHsKICAgICAgICAgICAgcm9vdEVuZCA9IG9mZnNldCA9IGogKyAxCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmIChpc1dpbmRvd3NEZXZpY2VSb290KGNvZGUpICYmIHBhdGguY2hhckNvZGVBdCgxKSA9PT0gQ0hBUl9DT0xPTikgewogICAgcm9vdEVuZCA9IGxlbiA+IDIgJiYgaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoMikpID8gMyA6IDIKICAgIG9mZnNldCA9IHJvb3RFbmQKICB9CgogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCiAgZm9yIChsZXQgaSA9IGxlbiAtIDE7IGkgPj0gb2Zmc2V0OyAtLWkpIHsKICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKHBhdGguY2hhckNvZGVBdChpKSkpIHsKICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICBlbmQgPSBpCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2UKICAgIH0KICB9CgogIGlmIChlbmQgPT09IC0xKSB7CiAgICBpZiAocm9vdEVuZCA9PT0gLTEpIHJldHVybiAnLicKCiAgICBlbmQgPSByb290RW5kCiAgfQogIHJldHVybiBwYXRoLnN1YnN0cmluZygwLCBlbmQpCn0KCmV4cG9ydHMuYmFzZW5hbWUgPSBmdW5jdGlvbiBiYXNlbmFtZSAocGF0aCwgc3VmZml4KSB7CiAgbGV0IHN0YXJ0ID0gMAogIGxldCBlbmQgPSAtMQogIGxldCBtYXRjaGVkU2xhc2ggPSB0cnVlCgogIGlmIChwYXRoLmxlbmd0aCA+PSAyICYmIGlzV2luZG93c0RldmljZVJvb3QocGF0aC5jaGFyQ29kZUF0KDApKSAmJiBwYXRoLmNoYXJDb2RlQXQoMSkgPT09IENIQVJfQ09MT04pIHsKICAgIHN0YXJ0ID0gMgogIH0KCiAgaWYgKHN1ZmZpeCAhPT0gdW5kZWZpbmVkICYmIHN1ZmZpeC5sZW5ndGggPiAwICYmIHN1ZmZpeC5sZW5ndGggPD0gcGF0aC5sZW5ndGgpIHsKICAgIGlmIChzdWZmaXggPT09IHBhdGgpIHJldHVybiAnJwogICAgbGV0IGV4dElkeCA9IHN1ZmZpeC5sZW5ndGggLSAxCiAgICBsZXQgZmlyc3ROb25TbGFzaEVuZCA9IC0xCiAgICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IHN0YXJ0OyAtLWkpIHsKICAgICAgY29uc3QgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKQogICAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihjb2RlKSkgewogICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICBzdGFydCA9IGkgKyAxCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZmlyc3ROb25TbGFzaEVuZCA9PT0gLTEpIHsKICAgICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlCiAgICAgICAgICBmaXJzdE5vblNsYXNoRW5kID0gaSArIDEKICAgICAgICB9CiAgICAgICAgaWYgKGV4dElkeCA+PSAwKSB7CiAgICAgICAgICBpZiAoY29kZSA9PT0gc3VmZml4LmNoYXJDb2RlQXQoZXh0SWR4KSkgewogICAgICAgICAgICBpZiAoLS1leHRJZHggPT09IC0xKSB7CiAgICAgICAgICAgICAgZW5kID0gaQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHRJZHggPSAtMQogICAgICAgICAgICBlbmQgPSBmaXJzdE5vblNsYXNoRW5kCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHN0YXJ0ID09PSBlbmQpIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQKICAgIGVsc2UgaWYgKGVuZCA9PT0gLTEpIGVuZCA9IHBhdGgubGVuZ3RoCiAgICByZXR1cm4gcGF0aC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkKICB9CiAgZm9yIChsZXQgaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSBzdGFydDsgLS1pKSB7CiAgICBpZiAoaXNXaW5kb3dzUGF0aFNlcGFyYXRvcihwYXRoLmNoYXJDb2RlQXQoaSkpKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnQgPSBpICsgMQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogIH0KCiAgaWYgKGVuZCA9PT0gLTEpIHJldHVybiAnJwogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydCwgZW5kKQp9CgpleHBvcnRzLmV4dG5hbWUgPSBmdW5jdGlvbiBleHRuYW1lIChwYXRoKSB7CiAgbGV0IHN0YXJ0ID0gMAogIGxldCBzdGFydERvdCA9IC0xCiAgbGV0IHN0YXJ0UGFydCA9IDAKICBsZXQgZW5kID0gLTEKICBsZXQgbWF0Y2hlZFNsYXNoID0gdHJ1ZQogIGxldCBwcmVEb3RTdGF0ZSA9IDAKCiAgaWYgKHBhdGgubGVuZ3RoID49IDIgJiYgcGF0aC5jaGFyQ29kZUF0KDEpID09PSBDSEFSX0NPTE9OICYmIGlzV2luZG93c0RldmljZVJvb3QocGF0aC5jaGFyQ29kZUF0KDApKSkgewogICAgc3RhcnQgPSBzdGFydFBhcnQgPSAyCiAgfQoKICBmb3IgKGxldCBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IHN0YXJ0OyAtLWkpIHsKICAgIGNvbnN0IGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSkKICAgIGlmIChpc1dpbmRvd3NQYXRoU2VwYXJhdG9yKGNvZGUpKSB7CiAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgc3RhcnRQYXJ0ID0gaSArIDEKICAgICAgICBicmVhawogICAgICB9CiAgICAgIGNvbnRpbnVlCiAgICB9CiAgICBpZiAoZW5kID09PSAtMSkgewogICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZQogICAgICBlbmQgPSBpICsgMQogICAgfQogICAgaWYgKGNvZGUgPT09IENIQVJfRE9UKSB7CiAgICAgIGlmIChzdGFydERvdCA9PT0gLTEpIHN0YXJ0RG90ID0gaQogICAgICBlbHNlIGlmIChwcmVEb3RTdGF0ZSAhPT0gMSkgcHJlRG90U3RhdGUgPSAxCiAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewogICAgICBwcmVEb3RTdGF0ZSA9IC0xCiAgICB9CiAgfQoKICBpZiAoc3RhcnREb3QgPT09IC0xIHx8IGVuZCA9PT0gLTEgfHwgcHJlRG90U3RhdGUgPT09IDAgfHwgKHByZURvdFN0YXRlID09PSAxICYmIHN0YXJ0RG90ID09PSBlbmQgLSAxICYmIHN0YXJ0RG90ID09PSBzdGFydFBhcnQgKyAxKSkgewogICAgcmV0dXJuICcnCiAgfQogIHJldHVybiBwYXRoLnN1YnN0cmluZyhzdGFydERvdCwgZW5kKQp9CnsKICAibmFtZSI6ICJiYXJlLXBhdGgiLAogICJ2ZXJzaW9uIjogIjMuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiUGF0aCBtYW5pcHVsYXRpb24gbGlicmFyeSBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLiI6ICIuL2luZGV4LmpzIiwKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4vcG9zaXgiOiAiLi9saWIvcG9zaXguanMiLAogICAgIi4vd2luMzIiOiAiLi9saWIvd2luMzIuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYiIsCiAgICAiTk9USUNFIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1wYXRoLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcGF0aC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtcGF0aCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1vcyI6ICJeMy4wLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0KfQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbGliL21lc3NhZ2VzJykKY29uc3QgeyB0eXBlOiB0LCBzdHJlYW06IHMgfSA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCmNvbnN0IEluY29taW5nUmVxdWVzdCA9IHJlcXVpcmUoJy4vbGliL2luY29taW5nLXJlcXVlc3QnKQpjb25zdCBJbmNvbWluZ1N0cmVhbSA9IHJlcXVpcmUoJy4vbGliL2luY29taW5nLXN0cmVhbScpCmNvbnN0IE91dGdvaW5nUmVxdWVzdCA9IHJlcXVpcmUoJy4vbGliL291dGdvaW5nLXJlcXVlc3QnKQpjb25zdCBPdXRnb2luZ1N0cmVhbSA9IHJlcXVpcmUoJy4vbGliL291dGdvaW5nLXN0cmVhbScpCmNvbnN0IENvbW1hbmRSb3V0ZXIgPSByZXF1aXJlKCcuL2xpYi9jb21tYW5kLXJvdXRlcicpCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBjbGFzcyBSUEMgewogIGNvbnN0cnVjdG9yKHN0cmVhbSwgb25yZXF1ZXN0ID0gbm9vcCkgewogICAgdGhpcy5fc3RyZWFtID0gc3RyZWFtCiAgICB0aGlzLl9pZCA9IDAKCiAgICB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcyA9IG5ldyBNYXAoKQogICAgdGhpcy5faW5jb21pbmdSZXF1ZXN0cyA9IG5ldyBNYXAoKQogICAgdGhpcy5faW5jb21pbmdSZXNwb25zZXMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cyA9IG5ldyBTZXQoKQogICAgdGhpcy5fcGVuZGluZ1Jlc3BvbnNlcyA9IG5ldyBTZXQoKQoKICAgIHRoaXMuX2J1ZmZlciA9IFtdCiAgICB0aGlzLl9idWZmZXJlZCA9IDAKICAgIHRoaXMuX2ZyYW1lID0gLTEKICAgIHRoaXMuX2RyYWluaW5nID0gW10KCiAgICBpZiAodHlwZW9mIG9ucmVxdWVzdCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBvbnJlcXVlc3QgPSBvbnJlcXVlc3QuYmluZCh0aGlzKQogICAgfSBlbHNlIHsKICAgICAgb25yZXF1ZXN0ID0gb25yZXF1ZXN0Ll9vbnJlcXVlc3QuYmluZChvbnJlcXVlc3QpCiAgICB9CgogICAgdGhpcy5fb25yZXF1ZXN0ID0gb25yZXF1ZXN0CiAgICB0aGlzLl9vbmVycm9yID0gdGhpcy5fb25lcnJvci5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmRhdGEgPSB0aGlzLl9vbmRhdGEuYmluZCh0aGlzKQogICAgdGhpcy5fb25kcmFpbiA9IHRoaXMuX29uZHJhaW4uYmluZCh0aGlzKQoKICAgIHRoaXMuX3N0cmVhbQogICAgICAub24oJ2Vycm9yJywgdGhpcy5fb25lcnJvcikKICAgICAgLm9uKCdkYXRhJywgdGhpcy5fb25kYXRhKQogICAgICAub24oJ2RyYWluJywgdGhpcy5fb25kcmFpbikKICB9CgogIHJlcXVlc3QoY29tbWFuZCkgewogICAgcmV0dXJuIG5ldyBPdXRnb2luZ1JlcXVlc3QodGhpcywgKyt0aGlzLl9pZCwgY29tbWFuZCkKICB9CgogIF9zZW5kTWVzc2FnZShtZXNzYWdlLCBjYikgewogICAgY29uc3QgaGVhZGVyID0gYy5lbmNvZGUobS5oZWFkZXIsIG1lc3NhZ2UpCgogICAgbGV0IGZsdXNoZWQgPSB0aGlzLl9zdHJlYW0ud3JpdGUoaGVhZGVyKQoKICAgIGlmIChtZXNzYWdlLmRhdGEpIGZsdXNoZWQgPSB0aGlzLl9zdHJlYW0ud3JpdGUobWVzc2FnZS5kYXRhKQoKICAgIGlmIChjYikgewogICAgICBpZiAoZmx1c2hlZCkgY2IobnVsbCkKICAgICAgZWxzZSB0aGlzLl9kcmFpbmluZy5wdXNoKGNiKQogICAgfQogIH0KCiAgX3NlbmRSZXF1ZXN0KHJlcXVlc3QsIGRhdGEgPSBudWxsKSB7CiAgICB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgIHRoaXMuX3NlbmRNZXNzYWdlKHsKICAgICAgdHlwZTogdC5SRVFVRVNULAogICAgICBpZDogcmVxdWVzdC5pZCwKICAgICAgY29tbWFuZDogcmVxdWVzdC5jb21tYW5kLAogICAgICBzdHJlYW06IDAsCiAgICAgIGRhdGEKICAgIH0pCiAgfQoKICBfY3JlYXRlUmVxdWVzdFN0cmVhbShyZXF1ZXN0LCBpc0luaXRpYXRvciwgb3B0cykgewogICAgaWYgKGlzSW5pdGlhdG9yKSB7CiAgICAgIHRoaXMuX291dGdvaW5nUmVxdWVzdHMuc2V0KHJlcXVlc3QuaWQsIHJlcXVlc3QpCgogICAgICByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtID0gbmV3IE91dGdvaW5nU3RyZWFtKAogICAgICAgIHRoaXMsCiAgICAgICAgcmVxdWVzdCwKICAgICAgICB0LlJFUVVFU1QsCiAgICAgICAgb3B0cwogICAgICApCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgICAgcmVxdWVzdC5fcmVxdWVzdFN0cmVhbSA9IG5ldyBJbmNvbWluZ1N0cmVhbSgKICAgICAgICB0aGlzLAogICAgICAgIHJlcXVlc3QsCiAgICAgICAgdC5SRVFVRVNULAogICAgICAgIG9wdHMKICAgICAgKQoKICAgICAgcmVxdWVzdC5fcmVxdWVzdFN0cmVhbS5vbignY2xvc2UnLCAoKSA9PgogICAgICAgIHRoaXMuX2luY29taW5nUmVxdWVzdHMuZGVsZXRlKHJlcXVlc3QuaWQpCiAgICAgICkKICAgIH0KICB9CgogIF9zZW5kUmVzcG9uc2UocmVxdWVzdCwgZGF0YSkgewogICAgdGhpcy5fc2VuZE1lc3NhZ2UoewogICAgICB0eXBlOiB0LlJFU1BPTlNFLAogICAgICBpZDogcmVxdWVzdC5pZCwKICAgICAgc3RyZWFtOiAwLAogICAgICBlcnJvcjogbnVsbCwKICAgICAgZGF0YQogICAgfSkKICB9CgogIF9jcmVhdGVSZXNwb25zZVN0cmVhbShyZXF1ZXN0LCBpc0luaXRpYXRvciwgb3B0cykgewogICAgaWYgKGlzSW5pdGlhdG9yKSB7CiAgICAgIHRoaXMuX291dGdvaW5nUmVzcG9uc2VzLnNldChyZXF1ZXN0LmlkLCByZXF1ZXN0KQoKICAgICAgcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0gPSBuZXcgT3V0Z29pbmdTdHJlYW0oCiAgICAgICAgdGhpcywKICAgICAgICByZXF1ZXN0LAogICAgICAgIHQuUkVTUE9OU0UsCiAgICAgICAgb3B0cwogICAgICApCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5zZXQocmVxdWVzdC5pZCwgcmVxdWVzdCkKCiAgICAgIHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtID0gbmV3IEluY29taW5nU3RyZWFtKAogICAgICAgIHRoaXMsCiAgICAgICAgcmVxdWVzdCwKICAgICAgICB0LlJFU1BPTlNFLAogICAgICAgIG9wdHMKICAgICAgKQoKICAgICAgcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4KICAgICAgICB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5kZWxldGUocmVxdWVzdC5pZCkKICAgICAgKQogICAgfQogIH0KCiAgX3NlbmRFcnJvcihyZXF1ZXN0LCBlcnIpIHsKICAgIHRoaXMuX3NlbmRNZXNzYWdlKHsKICAgICAgdHlwZTogdC5SRVNQT05TRSwKICAgICAgaWQ6IHJlcXVlc3QuaWQsCiAgICAgIHN0cmVhbTogMCwKICAgICAgZXJyb3I6IGVyciwKICAgICAgZGF0YTogbnVsbAogICAgfSkKICB9CgogIF9vbmVycm9yKGVycikgewogICAgdGhpcy5fb25kcmFpbihlcnIpCgogICAgLy8gVE9ETyBEZXN0cm95IHBlbmRpbmcgcmVxdWVzdHMgYW5kIHJlc3BvbnNlcwogIH0KCiAgX29uZGF0YShkYXRhKSB7CiAgICB0aGlzLl9idWZmZXIucHVzaChkYXRhKQogICAgdGhpcy5fYnVmZmVyZWQgKz0gZGF0YS5ieXRlTGVuZ3RoCgogICAgaWYgKHRoaXMuX2ZyYW1lID09PSAtMSkgewogICAgICB0aGlzLl9vbmJlZm9yZWZyYW1lKCkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX29uYWZ0ZXJmcmFtZSgpCiAgICB9CiAgfQoKICBfb25iZWZvcmVmcmFtZSgpIHsKICAgIGlmICh0aGlzLl9idWZmZXJlZCA8IDQpIHJldHVybgoKICAgIGNvbnN0IGJ1ZmZlciA9CiAgICAgIHRoaXMuX2J1ZmZlci5sZW5ndGggPT09IDEgPyB0aGlzLl9idWZmZXJbMF0gOiBiNGEuY29uY2F0KHRoaXMuX2J1ZmZlcikKCiAgICB0aGlzLl9idWZmZXIgPSBbYnVmZmVyXQogICAgdGhpcy5fZnJhbWUgPSA0ICsgYy51aW50MzIuZGVjb2RlKGMuc3RhdGUoMCwgNCwgYnVmZmVyKSkKCiAgICB0aGlzLl9vbmFmdGVyZnJhbWUoKQogIH0KCiAgX29uYWZ0ZXJmcmFtZSgpIHsKICAgIGlmICh0aGlzLl9idWZmZXJlZCA8IHRoaXMuX2ZyYW1lKSByZXR1cm4KCiAgICBjb25zdCBidWZmZXIgPQogICAgICB0aGlzLl9idWZmZXIubGVuZ3RoID09PSAxID8gdGhpcy5fYnVmZmVyWzBdIDogYjRhLmNvbmNhdCh0aGlzLl9idWZmZXIpCgogICAgY29uc3QgZnJhbWUgPSB0aGlzLl9mcmFtZQoKICAgIHRoaXMuX2J1ZmZlcmVkIC09IGZyYW1lCiAgICB0aGlzLl9idWZmZXIgPSB0aGlzLl9idWZmZXJlZCA+IDAgPyBbYnVmZmVyLnN1YmFycmF5KGZyYW1lKV0gOiBbXQogICAgdGhpcy5fZnJhbWUgPSAtMQoKICAgIHRoaXMuX29ubWVzc2FnZShidWZmZXIuc3ViYXJyYXkoMCwgZnJhbWUpKQogICAgdGhpcy5fb25iZWZvcmVmcmFtZSgpCiAgfQoKICBhc3luYyBfb25tZXNzYWdlKGJ1ZmZlcikgewogICAgbGV0IG1lc3NhZ2UKICAgIHRyeSB7CiAgICAgIG1lc3NhZ2UgPSBtLm1lc3NhZ2UuZGVjb2RlKGMuc3RhdGUoMCwgYnVmZmVyLmxlbmd0aCwgYnVmZmVyKSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCgogICAgICByZXR1cm4gdGhpcy5fc3RyZWFtLmRlc3Ryb3koZXJyKQogICAgfQoKICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7CiAgICAgIGNhc2UgdC5SRVFVRVNUOgogICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgSW5jb21pbmdSZXF1ZXN0KAogICAgICAgICAgdGhpcywKICAgICAgICAgIG1lc3NhZ2UuaWQsCiAgICAgICAgICBtZXNzYWdlLmNvbW1hbmQsCiAgICAgICAgICBtZXNzYWdlLmRhdGEKICAgICAgICApCgogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9vbnJlcXVlc3QocmVxdWVzdCkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHNhZmV0eUNhdGNoKGVycikKCiAgICAgICAgICB0aGlzLl9zZW5kRXJyb3IocmVxdWVzdCwgZXJyKQogICAgICAgIH0KICAgICAgICBicmVhawogICAgICBjYXNlIHQuUkVTUE9OU0U6CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuX29ucmVzcG9uc2UobWVzc2FnZSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgICB9CiAgICAgICAgYnJlYWsKICAgICAgY2FzZSB0LlNUUkVBTToKICAgICAgICB0cnkgewogICAgICAgICAgdGhpcy5fb25zdHJlYW0obWVzc2FnZSkKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgICAgICB9CiAgICB9CiAgfQoKICBfb25yZXNwb25zZShtZXNzYWdlKSB7CiAgICBpZiAobWVzc2FnZS5pZCA9PT0gMCkgcmV0dXJuCgogICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICBpZiAobWVzc2FnZS5lcnJvcikgewogICAgICByZXF1ZXN0Ll9yZWplY3QobWVzc2FnZS5lcnJvcikKICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gPT09IDApIHsKICAgICAgcmVxdWVzdC5fcmVzb2x2ZShtZXNzYWdlLmRhdGEpCiAgICB9CiAgfQoKICBfb25zdHJlYW0obWVzc2FnZSkgewogICAgaWYgKG1lc3NhZ2UuaWQgPT09IDApIHJldHVybgoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuT1BFTikgdGhpcy5fb25zdHJlYW1vcGVuKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuQ0xPU0UpIHRoaXMuX29uc3RyZWFtY2xvc2UobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5QQVVTRSkgdGhpcy5fb25zdHJlYW1wYXVzZShtZXNzYWdlKQogICAgZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1VNRSkgdGhpcy5fb25zdHJlYW1yZXN1bWUobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5EQVRBKSB0aGlzLl9vbnN0cmVhbWRhdGEobWVzc2FnZSkKICAgIGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5FTkQpIHRoaXMuX29uc3RyZWFtZW5kKG1lc3NhZ2UpCiAgICBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuREVTVFJPWSkgdGhpcy5fb25zdHJlYW1kZXN0cm95KG1lc3NhZ2UpCiAgfQoKICBfb25zdHJlYW1vcGVuKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nUmVxdWVzdHMuYWRkKG1lc3NhZ2UuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KCiAgICAgIGlmIChzdHJlYW0uX3BlbmRpbmdPcGVuID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzLmFkZChtZXNzYWdlLmlkKQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fb3V0Z29pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nUmVzcG9uc2VzLmFkZChtZXNzYWdlLmlkKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQoKICAgICAgaWYgKHN0cmVhbS5fcGVuZGluZ09wZW4gPT09IG51bGwpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nUmVzcG9uc2VzLmFkZChtZXNzYWdlLmlkKQogICAgICAgIHJldHVybgogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0uX2NvbnRpbnVlT3BlbigpCiAgfQoKICBfb25zdHJlYW1jbG9zZShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmNvbWluZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG1lc3NhZ2UuZXJyb3IpIHN0cmVhbS5kZXN0cm95KG1lc3NhZ2UuZXJyb3IpCiAgICBlbHNlIHN0cmVhbS5wdXNoKG51bGwpCiAgfQoKICBfb25zdHJlYW1wYXVzZShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgc3RyZWFtLmNvcmsoKQogIH0KCiAgX29uc3RyZWFtcmVzdW1lKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX291dGdvaW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0udW5jb3JrKCkKICB9CgogIF9vbnN0cmVhbWRhdGEobWVzc2FnZSkgewogICAgbGV0IHN0cmVhbQoKICAgIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVRVUVTVCkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXF1ZXN0cy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXF1ZXN0U3RyZWFtCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVNQT05TRSkgewogICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5jb21pbmdSZXNwb25zZXMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVzcG9uc2VTdHJlYW0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChzdHJlYW0ucHVzaChtZXNzYWdlLmRhdGEpID09PSBmYWxzZSkgewogICAgICB0aGlzLl9zZW5kTWVzc2FnZSh7CiAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgaWQ6IHN0cmVhbS5fcmVxdWVzdC5pZCwKICAgICAgICBzdHJlYW06IHN0cmVhbS5fbWFzayB8IHMuUEFVU0UsCiAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgZGF0YTogbnVsbAogICAgICB9KQogICAgfQogIH0KCiAgX29uc3RyZWFtZW5kKG1lc3NhZ2UpIHsKICAgIGxldCBzdHJlYW0KCiAgICBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFUVVFU1QpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVxdWVzdHMuZ2V0KG1lc3NhZ2UuaWQpCiAgICAgIGlmIChyZXF1ZXN0ID09PSB1bmRlZmluZWQpIHJldHVybgoKICAgICAgc3RyZWFtID0gcmVxdWVzdC5fcmVxdWVzdFN0cmVhbQogICAgfSBlbHNlIGlmIChtZXNzYWdlLnN0cmVhbSAmIHMuUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuX2luY29taW5nUmVzcG9uc2VzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3Jlc3BvbnNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICByZXR1cm4KICAgIH0KCiAgICBzdHJlYW0ucHVzaChudWxsKQogIH0KCiAgX29uc3RyZWFtZGVzdHJveShtZXNzYWdlKSB7CiAgICBsZXQgc3RyZWFtCgogICAgaWYgKG1lc3NhZ2Uuc3RyZWFtICYgcy5SRVFVRVNUKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1JlcXVlc3RzLmdldChtZXNzYWdlLmlkKQogICAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICAgIHN0cmVhbSA9IHJlcXVlc3QuX3JlcXVlc3RTdHJlYW0KICAgIH0gZWxzZSBpZiAobWVzc2FnZS5zdHJlYW0gJiBzLlJFU1BPTlNFKSB7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9vdXRnb2luZ1Jlc3BvbnNlcy5nZXQobWVzc2FnZS5pZCkKICAgICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBzdHJlYW0gPSByZXF1ZXN0Ll9yZXNwb25zZVN0cmVhbQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgc3RyZWFtLmRlc3Ryb3kobWVzc2FnZS5lcnJvcikKICB9CgogIF9vbmRyYWluKGVyciA9IG51bGwpIHsKICAgIGNvbnN0IGRyYWluaW5nID0gdGhpcy5fZHJhaW5pbmcKCiAgICB0aGlzLl9kcmFpbmluZyA9IFtdCgogICAgZm9yIChjb25zdCBjYiBvZiBkcmFpbmluZykgY2IoZXJyKQogIH0KfQoKZXhwb3J0cy5Db21tYW5kUm91dGVyID0gQ29tbWFuZFJvdXRlcgoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUlBDQ29tbWFuZFJvdXRlciB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IHZhbHVlRW5jb2RpbmcgPSBjLnJhdyB9ID0gb3B0cwoKICAgIHRoaXMuX3Jlc3BvbmRlcnMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2RlZmF1bHRWYWx1ZUVuY29kaW5nID0gdmFsdWVFbmNvZGluZwogIH0KCiAgcmVzcG9uZChjb21tYW5kLCBvcHRzID0ge30sIG9ucmVxdWVzdCkgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIG9ucmVxdWVzdCA9IG9wdHMKICAgICAgb3B0cyA9IHt9CiAgICB9CgogICAgY29uc3QgewogICAgICB2YWx1ZUVuY29kaW5nID0gdGhpcy5fZGVmYXVsdFZhbHVlRW5jb2RpbmcsCiAgICAgIHJlcXVlc3RFbmNvZGluZyA9IHZhbHVlRW5jb2RpbmcsCiAgICAgIHJlc3BvbnNlRW5jb2RpbmcgPSB2YWx1ZUVuY29kaW5nCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX3Jlc3BvbmRlcnMuc2V0KGNvbW1hbmQsIHsKICAgICAgb25yZXF1ZXN0LAogICAgICByZXF1ZXN0RW5jb2RpbmcsCiAgICAgIHJlc3BvbnNlRW5jb2RpbmcKICAgIH0pCiAgfQoKICBhc3luYyBfb25yZXF1ZXN0KHJlcSkgewogICAgY29uc3QgcmVzcG9uZGVyID0gdGhpcy5fcmVzcG9uZGVycy5nZXQocmVxLmNvbW1hbmQpCgogICAgaWYgKHJlc3BvbmRlciA9PT0gdW5kZWZpbmVkKSByZXR1cm4KCiAgICBjb25zdCB7IG9ucmVxdWVzdCwgcmVxdWVzdEVuY29kaW5nLCByZXNwb25zZUVuY29kaW5nIH0gPSByZXNwb25kZXIKCiAgICBsZXQgZGF0YSA9IHJlcS5kYXRhCgogICAgaWYgKHJlcXVlc3RFbmNvZGluZykgZGF0YSA9IGMuZGVjb2RlKHJlcXVlc3RFbmNvZGluZywgZGF0YSkKCiAgICBkYXRhID0gYXdhaXQgb25yZXF1ZXN0KHJlcSwgZGF0YSkKCiAgICBpZiAocmVxLnNlbnQpIHJldHVybgoKICAgIGlmIChyZXNwb25zZUVuY29kaW5nKSBkYXRhID0gYy5lbmNvZGUocmVzcG9uc2VFbmNvZGluZywgZGF0YSkKCiAgICByZXEucmVwbHkoZGF0YSkKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgdHlwZTogewogICAgUkVRVUVTVDogMSwKICAgIFJFU1BPTlNFOiAyLAogICAgU1RSRUFNOiAzCiAgfSwKICBzdHJlYW06IHsKICAgIE9QRU46IDB4MSwKICAgIENMT1NFOiAweDIsCiAgICBQQVVTRTogMHg0LAogICAgUkVTVU1FOiAweDgsCiAgICBEQVRBOiAweDEwLAogICAgRU5EOiAweDIwLAogICAgREVTVFJPWTogMHg0MCwKICAgIEVSUk9SOiAweDgwLAogICAgUkVRVUVTVDogMHgxMDAsCiAgICBSRVNQT05TRTogMHgyMDAKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSUENFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gUlBDRXJyb3IpIHsKICAgIHN1cGVyKGAke2NvZGV9OiAke21zZ31gKQogICAgdGhpcy5jb2RlID0gY29kZQoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICAgIH0KICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdSUENFcnJvcicKICB9CgogIHN0YXRpYyBVTktOT1dOX01FU1NBR0UobXNnKSB7CiAgICByZXR1cm4gbmV3IFJQQ0Vycm9yKG1zZywgJ1VOS05PV05fTUVTU0FHRScsIFJQQ0Vycm9yLlVOS05PV05fTUVTU0FHRSkKICB9CgogIHN0YXRpYyBBTFJFQURZX1NFTlQobXNnKSB7CiAgICByZXR1cm4gbmV3IFJQQ0Vycm9yKG1zZywgJ0FMUkVBRFlfU0VOVCcsIFJQQ0Vycm9yLkFMUkVBRFlfU0VOVCkKICB9CgogIHN0YXRpYyBBTFJFQURZX1JFQ0VJVkVEKG1zZykgewogICAgcmV0dXJuIG5ldyBSUENFcnJvcihtc2csICdBTFJFQURZX1JFQ0VJVkVEJywgUlBDRXJyb3IuQUxSRUFEWV9SRUNFSVZFRCkKICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ0luY29taW5nUmVxdWVzdCB7CiAgY29uc3RydWN0b3IocnBjLCBpZCwgY29tbWFuZCwgZGF0YSkgewogICAgdGhpcy5ycGMgPSBycGMKICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZAogICAgdGhpcy5kYXRhID0gZGF0YQogICAgdGhpcy5zZW50ID0gZmFsc2UKICAgIHRoaXMucmVjZWl2ZWQgPSBmYWxzZQoKICAgIHRoaXMuX3JlcXVlc3RTdHJlYW0gPSBudWxsCiAgICB0aGlzLl9yZXNwb25zZVN0cmVhbSA9IG51bGwKICB9CgogIHJlcGx5KGRhdGEsIGVuY29kaW5nKSB7CiAgICBpZiAodGhpcy5zZW50KSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1NFTlQoJ1Jlc3BvbnNlIGhhcyBhbHJlYWR5IGJlZW4gc2VudCcpCiAgICB9CgogICAgZW5jb2RpbmcgPQogICAgICBlbmNvZGluZyAmJiBlbmNvZGluZyAhPT0gJ2J1ZmZlcicKICAgICAgICA/IGMuZnJvbShlbmNvZGluZykKICAgICAgICA6IHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJwogICAgICAgICAgPyBjLnJhdy51dGY4CiAgICAgICAgICA6IG51bGwKCiAgICB0aGlzLnNlbnQgPSB0cnVlCgogICAgdGhpcy5ycGMuX3NlbmRSZXNwb25zZSh0aGlzLCBlbmNvZGluZyA/IGMuZW5jb2RlKGVuY29kaW5nLCBkYXRhKSA6IGRhdGEpCiAgfQoKICBjcmVhdGVSZXNwb25zZVN0cmVhbShvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLnNlbnQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfU0VOVCgnUmVzcG9uc2UgaGFzIGFscmVhZHkgYmVlbiBzZW50JykKICAgIH0KCiAgICB0aGlzLnNlbnQgPSB0cnVlCgogICAgdGhpcy5ycGMuX2NyZWF0ZVJlc3BvbnNlU3RyZWFtKHRoaXMsIHRydWUsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMuX3Jlc3BvbnNlU3RyZWFtCiAgfQoKICBjcmVhdGVSZXF1ZXN0U3RyZWFtKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMucmVjZWl2ZWQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfUkVDRUlWRUQoJ1JlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiByZWNlaXZlZCcpCiAgICB9CgogICAgdGhpcy5yZWNlaXZlZCA9IHRydWUKCiAgICB0aGlzLnJwYy5fY3JlYXRlUmVxdWVzdFN0cmVhbSh0aGlzLCBmYWxzZSwgb3B0cykKCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdFN0cmVhbQogIH0KfQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IHsgdHlwZTogdCwgc3RyZWFtOiBzIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ0luY29taW5nU3RyZWFtIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKHJwYywgcmVxdWVzdCwgdHlwZSwgb3B0cykgewogICAgc3VwZXIoeyAuLi5vcHRzLCBlYWdlck9wZW46IHRydWUgfSkKCiAgICB0aGlzLl9ycGMgPSBycGMKICAgIHRoaXMuX3JlcXVlc3QgPSByZXF1ZXN0CiAgICB0aGlzLl90eXBlID0gdHlwZQogICAgdGhpcy5fbWFzayA9IHR5cGUgPT09IHQuUkVRVUVTVCA/IHMuUkVRVUVTVCA6IHMuUkVTUE9OU0UKICB9CgogIF9vcGVuKGNiKSB7CiAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICB7CiAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5PUEVOLAogICAgICAgIGVycm9yOiBudWxsLAogICAgICAgIGRhdGE6IG51bGwKICAgICAgfSwKICAgICAgY2IKICAgICkKICB9CgogIF9yZWFkKCkgewogICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSh7CiAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgc3RyZWFtOiB0aGlzLl9tYXNrIHwgcy5SRVNVTUUsCiAgICAgIGVycm9yOiBudWxsLAogICAgICBkYXRhOiBudWxsCiAgICB9KQogIH0KCiAgX2Rlc3Ryb3koZXJyLCBjYikgewogICAgaWYgKGVycikgewogICAgICB0aGlzLl9ycGMuX3NlbmRNZXNzYWdlKAogICAgICAgIHsKICAgICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkRFU1RST1kgfCBzLkVSUk9SLAogICAgICAgICAgZXJyb3I6IGVyciwKICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGNiCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuREVTVFJPWSwKICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgZGF0YTogbnVsbAogICAgICAgIH0sCiAgICAgICAgY2IKICAgICAgKQogICAgfQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHsgdHlwZTogdCwgc3RyZWFtOiBzIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCmNvbnN0IGVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IGVycm9yID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51dGY4LnByZWVuY29kZShzdGF0ZSwgbS5tZXNzYWdlKQogICAgYy51dGY4LnByZWVuY29kZShzdGF0ZSwgU3RyaW5nKG0uY29kZSkgfHwgJycpCiAgICBjLmludC5wcmVlbmNvZGUoc3RhdGUsIE51bWJlcihtLmVycm5vKSB8fCAwKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnV0ZjguZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgICBjLnV0ZjguZW5jb2RlKHN0YXRlLCBTdHJpbmcobS5jb2RlKSB8fCAnJykKICAgIGMuaW50LmVuY29kZShzdGF0ZSwgTnVtYmVyKG0uZXJybm8pIHx8IDApCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihgJHtjLnV0ZjguZGVjb2RlKHN0YXRlKX1gKQogICAgZXJyLmNvZGUgPSBjLnV0ZjguZGVjb2RlKHN0YXRlKQogICAgZXJyLmVycm5vID0gYy5pbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIGVycgogIH0KfQoKZXhwb3J0cy5oZWFkZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQzMi5wcmVlbmNvZGUoc3RhdGUsIDApIC8vIEZyYW1lCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnR5cGUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQoKICAgIGxldCBoYXNEYXRhID0gZmFsc2UKCiAgICBzd2l0Y2ggKG0udHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDoKICAgICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmNvbW1hbmQpCiAgICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCiAgICAgICAgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuUkVTUE9OU0U6CiAgICAgICAgYy5ib29sLnByZWVuY29kZShzdGF0ZSwgISFtLmVycm9yKQogICAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5lcnJvcikgZXJyb3IucHJlZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgICAgIGVsc2UgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuU1RSRUFNOgogICAgICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5zdHJlYW0gJiBzLkVSUk9SKSBlcnJvci5wcmVlbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICAgICAgZWxzZSBpZiAobS5zdHJlYW0gJiBzLkRBVEEpIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAoaGFzRGF0YSkgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5kYXRhID8gbS5kYXRhLmJ5dGVMZW5ndGggOiAwKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmcmFtZSA9IHN0YXRlLnN0YXJ0CgogICAgYy51aW50MzIuZW5jb2RlKHN0YXRlLCAwKSAvLyBGcmFtZQoKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnR5cGUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQoKICAgIGxldCBoYXNEYXRhID0gZmFsc2UKCiAgICBzd2l0Y2ggKG0udHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDoKICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmNvbW1hbmQpCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdHJlYW0pCiAgICAgICAgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuUkVTUE9OU0U6CiAgICAgICAgYy5ib29sLmVuY29kZShzdGF0ZSwgISFtLmVycm9yKQogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5lcnJvcikgZXJyb3IuZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgICAgIGVsc2UgaWYgKG0uc3RyZWFtID09PSAwKSBoYXNEYXRhID0gdHJ1ZQogICAgICAgIGJyZWFrCgogICAgICBjYXNlIHQuU1RSRUFNOgogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RyZWFtKQoKICAgICAgICBpZiAobS5zdHJlYW0gJiBzLkVSUk9SKSBlcnJvci5lbmNvZGUoc3RhdGUsIG0uZXJyb3IpCiAgICAgICAgZWxzZSBpZiAobS5zdHJlYW0gJiBzLkRBVEEpIGhhc0RhdGEgPSB0cnVlCiAgICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAoaGFzRGF0YSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5kYXRhID8gbS5kYXRhLmJ5dGVMZW5ndGggOiAwKQoKICAgIGNvbnN0IGVuZCA9IHN0YXRlLnN0YXJ0CgogICAgc3RhdGUuc3RhcnQgPSBmcmFtZQoKICAgIGMudWludDMyLmVuY29kZSgKICAgICAgc3RhdGUsCiAgICAgIGVuZCAtIHN0YXJ0ICsgKGhhc0RhdGEgJiYgbS5kYXRhID8gbS5kYXRhLmJ5dGVMZW5ndGggOiAwKQogICAgKQoKICAgIHN0YXRlLnN0YXJ0ID0gZW5kCiAgfQp9CgpleHBvcnRzLm1lc3NhZ2UgPSB7CiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmcmFtZSA9IGMudWludDMyLmRlY29kZShzdGF0ZSkKCiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBmcmFtZSkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ091dCBvZiBib3VuZHMnKQoKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgaWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIHQuUkVRVUVTVDogewogICAgICAgIGNvbnN0IGNvbW1hbmQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICAgIGNvbnN0IHN0cmVhbSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgICAgY29uc3QgZGF0YSA9IHN0cmVhbSA9PT0gMCA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBjb21tYW5kLCBzdHJlYW0sIGRhdGEgfQogICAgICB9CgogICAgICBjYXNlIHQuUkVTUE9OU0U6IHsKICAgICAgICBjb25zdCBlcnIgPSBjLmJvb2wuZGVjb2RlKHN0YXRlKQogICAgICAgIGNvbnN0IHN0cmVhbSA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBlcnJvci5kZWNvZGUoc3RhdGUpLCBkYXRhOiBudWxsIH0KICAgICAgICB9CgogICAgICAgIGlmIChzdHJlYW0gPT09IDApIHsKICAgICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBudWxsLCBkYXRhOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHR5cGUsIGlkLCBzdHJlYW0sIGVycm9yOiBudWxsLCBkYXRhOiBudWxsIH0KICAgICAgfQoKICAgICAgY2FzZSB0LlNUUkVBTToKICAgICAgICBjb25zdCBzdHJlYW0gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgICAgICBpZiAoc3RyZWFtICYgcy5FUlJPUikgewogICAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IGVycm9yLmRlY29kZShzdGF0ZSksIGRhdGE6IG51bGwgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHN0cmVhbSAmIHMuREFUQSkgewogICAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IG51bGwsIGRhdGE6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgdHlwZSwgaWQsIHN0cmVhbSwgZXJyb3I6IG51bGwsIGRhdGE6IG51bGwgfQoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBlcnJvcnMuVU5LTk9XTl9NRVNTQUdFKGBVbmtub3duIG1lc3NhZ2UgJyR7dHlwZX0nYCkKICAgIH0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ091dGdvaW5nUmVxdWVzdCB7CiAgY29uc3RydWN0b3IocnBjLCBpZCwgY29tbWFuZCkgewogICAgdGhpcy5ycGMgPSBycGMKICAgIHRoaXMuaWQgPSBpZAogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZAogICAgdGhpcy5zZW50ID0gZmFsc2UKICAgIHRoaXMucmVjZWl2ZWQgPSBmYWxzZQoKICAgIHRoaXMuX3Byb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgICAgIHRoaXMuX3JlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0aGlzLl9yZXF1ZXN0U3RyZWFtID0gbnVsbAogICAgdGhpcy5fcmVzcG9uc2VTdHJlYW0gPSBudWxsCiAgfQoKICBzZW5kKGRhdGEsIGVuY29kaW5nKSB7CiAgICBpZiAodGhpcy5zZW50KSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1NFTlQoJ1JlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50JykKICAgIH0KCiAgICBlbmNvZGluZyA9CiAgICAgIGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJwogICAgICAgID8gYy5mcm9tKGVuY29kaW5nKQogICAgICAgIDogdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnCiAgICAgICAgICA/IGMucmF3LnV0ZjgKICAgICAgICAgIDogbnVsbAoKICAgIHRoaXMuc2VudCA9IHRydWUKCiAgICB0aGlzLnJwYy5fc2VuZFJlcXVlc3QodGhpcywgZW5jb2RpbmcgPyBjLmVuY29kZShlbmNvZGluZywgZGF0YSkgOiBkYXRhKQogIH0KCiAgcmVwbHkoZW5jb2RpbmcpIHsKICAgIGlmICh0aGlzLnJlY2VpdmVkKSB7CiAgICAgIHRocm93IGVycm9ycy5BTFJFQURZX1JFQ0VJVkVEKCdSZXNwb25zZSBpcyBhbHJlYWR5IGJlaW5nIHJlY2VpdmVkJykKICAgIH0KCiAgICBlbmNvZGluZyA9IGVuY29kaW5nICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJyA/IGMuZnJvbShlbmNvZGluZykgOiBudWxsCgogICAgdGhpcy5yZWNlaXZlZCA9IHRydWUKCiAgICByZXR1cm4gZW5jb2RpbmcKICAgICAgPyB0aGlzLl9wcm9taXNlLnRoZW4oKGRhdGEpID0+IGMuZGVjb2RlKGVuY29kaW5nLCBkYXRhKSkKICAgICAgOiB0aGlzLl9wcm9taXNlCiAgfQoKICBjcmVhdGVSZXF1ZXN0U3RyZWFtKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuc2VudCkgewogICAgICB0aHJvdyBlcnJvcnMuQUxSRUFEWV9TRU5UKCdSZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCcpCiAgICB9CgogICAgdGhpcy5zZW50ID0gdHJ1ZQoKICAgIHRoaXMucnBjLl9jcmVhdGVSZXF1ZXN0U3RyZWFtKHRoaXMsIHRydWUsIG9wdHMpCgogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RTdHJlYW0KICB9CgogIGNyZWF0ZVJlc3BvbnNlU3RyZWFtKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMucmVjZWl2ZWQpIHsKICAgICAgdGhyb3cgZXJyb3JzLkFMUkVBRFlfUkVDRUlWRUQoJ1Jlc3BvbnNlIGhhcyBhbHJlYWR5IGJlZW4gcmVjZWl2ZWQnKQogICAgfQoKICAgIHRoaXMucmVjZWl2ZWQgPSB0cnVlCgogICAgdGhpcy5ycGMuX2NyZWF0ZVJlc3BvbnNlU3RyZWFtKHRoaXMsIGZhbHNlLCBvcHRzKQoKICAgIHJldHVybiB0aGlzLl9yZXNwb25zZVN0cmVhbQogIH0KfQpjb25zdCB7IFdyaXRhYmxlIH0gPSByZXF1aXJlKCdiYXJlLXN0cmVhbScpCmNvbnN0IHsgdHlwZTogdCwgc3RyZWFtOiBzIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJQQ091dGdvaW5nU3RyZWFtIGV4dGVuZHMgV3JpdGFibGUgewogIGNvbnN0cnVjdG9yKHJwYywgcmVxdWVzdCwgdHlwZSwgb3B0cykgewogICAgc3VwZXIoeyAuLi5vcHRzLCBlYWdlck9wZW46IHRydWUgfSkKCiAgICB0aGlzLl9ycGMgPSBycGMKICAgIHRoaXMuX3JlcXVlc3QgPSByZXF1ZXN0CiAgICB0aGlzLl90eXBlID0gdHlwZQogICAgdGhpcy5fbWFzayA9IHR5cGUgPT09IHQuUkVRVUVTVCA/IHMuUkVRVUVTVCA6IHMuUkVTUE9OU0UKCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IG51bGwKICB9CgogIF9vcGVuKGNiKSB7CiAgICBsZXQgcGVuZGluZwoKICAgIGNvbnN0IG9uZmx1c2hlZCA9ICgpID0+IHsKICAgICAgaWYgKHBlbmRpbmcuaGFzKHRoaXMuX3JlcXVlc3QuaWQpKSB7CiAgICAgICAgcGVuZGluZy5kZWxldGUodGhpcy5fcmVxdWVzdC5pZCkKCiAgICAgICAgY2IobnVsbCkKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IGNiCiAgICAgIH0KICAgIH0KCiAgICBzd2l0Y2ggKHRoaXMuX3R5cGUpIHsKICAgICAgY2FzZSB0LlJFUVVFU1Q6CiAgICAgICAgcGVuZGluZyA9IHRoaXMuX3JwYy5fcGVuZGluZ1JlcXVlc3RzCgogICAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgICB7CiAgICAgICAgICAgIHR5cGU6IHQuUkVRVUVTVCwKICAgICAgICAgICAgaWQ6IHRoaXMuX3JlcXVlc3QuaWQsCiAgICAgICAgICAgIGNvbW1hbmQ6IHRoaXMuX3JlcXVlc3QuY29tbWFuZCwKICAgICAgICAgICAgc3RyZWFtOiBzLk9QRU4sCiAgICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICAgIH0sCiAgICAgICAgICBvbmZsdXNoZWQKICAgICAgICApCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgdC5SRVNQT05TRToKICAgICAgICBwZW5kaW5nID0gdGhpcy5fcnBjLl9wZW5kaW5nUmVzcG9uc2VzCgogICAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgICB7CiAgICAgICAgICAgIHR5cGU6IHQuUkVTUE9OU0UsCiAgICAgICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgICAgICBlcnJvcjogZmFsc2UsCiAgICAgICAgICAgIHN0cmVhbTogcy5PUEVOLAogICAgICAgICAgICBkYXRhOiBudWxsCiAgICAgICAgICB9LAogICAgICAgICAgb25mbHVzaGVkCiAgICAgICAgKQogICAgICAgIGJyZWFrCiAgICB9CiAgfQoKICBfY29udGludWVPcGVuKCkgewogICAgaWYgKHRoaXMuX3BlbmRpbmdPcGVuID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IGNiID0gdGhpcy5fcGVuZGluZ09wZW4KICAgIHRoaXMuX3BlbmRpbmdPcGVuID0gbnVsbAogICAgY2IoKQogIH0KCiAgX3dyaXRlKGRhdGEsIGVuY29kaW5nLCBjYikgewogICAgdGhpcy5fcnBjLl9zZW5kTWVzc2FnZSgKICAgICAgewogICAgICAgIHR5cGU6IHQuU1RSRUFNLAogICAgICAgIGlkOiB0aGlzLl9yZXF1ZXN0LmlkLAogICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuREFUQSwKICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICBkYXRhCiAgICAgIH0sCiAgICAgIGNiCiAgICApCiAgfQoKICBfZmluYWwoY2IpIHsKICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgIHsKICAgICAgICB0eXBlOiB0LlNUUkVBTSwKICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICBzdHJlYW06IHRoaXMuX21hc2sgfCBzLkVORCwKICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICBkYXRhOiBudWxsCiAgICAgIH0sCiAgICAgIGNiCiAgICApCiAgfQoKICBfZGVzdHJveShlcnIsIGNiKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuQ0xPU0UgfCBzLkVSUk9SLAogICAgICAgICAgZXJyb3I6IGVyciwKICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGNiCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3JwYy5fc2VuZE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgdHlwZTogdC5TVFJFQU0sCiAgICAgICAgICBpZDogdGhpcy5fcmVxdWVzdC5pZCwKICAgICAgICAgIHN0cmVhbTogdGhpcy5fbWFzayB8IHMuQ0xPU0UsCiAgICAgICAgICBlcnJvcjogbnVsbCwKICAgICAgICAgIGRhdGE6IG51bGwKICAgICAgICB9LAogICAgICAgIGNiCiAgICAgICkKICAgIH0KICB9Cn0KewogICJuYW1lIjogImJhcmUtcnBjIiwKICAidmVyc2lvbiI6ICIwLjIuMTMiLAogICJkZXNjcmlwdGlvbiI6ICJsaWJycGMgQUJJIGNvbXBhdGlibGUgUlBDIGZvciBCYXJlIiwKICAiZXhwb3J0cyI6IHsKICAgICIuIjogewogICAgICAidHlwZXMiOiAiLi9pbmRleC5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9pbmRleC5qcyIKICAgIH0sCiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuL2Vycm9ycyI6IHsKICAgICAgInR5cGVzIjogIi4vbGliL2Vycm9ycy5kLnRzIiwKICAgICAgImRlZmF1bHQiOiAiLi9saWIvZXJyb3JzLmpzIgogICAgfQogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJpbmRleC5kLnRzIiwKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ycGMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1ycGMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXJwYyNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNiIsCiAgICAiYmFyZS1zdHJlYW0iOiAiXjIuMS4zIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE1LjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjIiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIl4zLjAuMSIsCiAgICAiYmFyZS1pcGMiOiAiXjEuMS4wIiwKICAgICJicml0dGxlIjogIl4zLjIuMSIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctc3RhbmRhcmQiOiAiXjcuMC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFyZS1idWZmZXIiOiAiKiIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzTWV0YSI6IHsKICAgICJiYXJlLWJ1ZmZlciI6IHsKICAgICAgIm9wdGlvbmFsIjogdHJ1ZQogICAgfQogIH0KfQpjb25zdCBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW14JykKCmNvbnN0IGRlZmF1bHRFbmNvZGluZyA9ICd1dGY4JwoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gc3RyZWFtLlN0cmVhbQoKZXhwb3J0cy5waXBlbGluZSA9IHN0cmVhbS5waXBlbGluZQoKZXhwb3J0cy5pc1N0cmVhbSA9IHN0cmVhbS5pc1N0cmVhbQpleHBvcnRzLmlzRW5kZWQgPSBzdHJlYW0uaXNFbmRlZApleHBvcnRzLmlzRmluaXNoZWQgPSBzdHJlYW0uaXNGaW5pc2hlZApleHBvcnRzLmlzRGlzdHVyYmVkID0gc3RyZWFtLmlzRGlzdHVyYmVkCgpleHBvcnRzLmdldFN0cmVhbUVycm9yID0gc3RyZWFtLmdldFN0cmVhbUVycm9yCgpleHBvcnRzLlN0cmVhbSA9IGV4cG9ydHMKCmV4cG9ydHMuUmVhZGFibGUgPSBjbGFzcyBSZWFkYWJsZSBleHRlbmRzIHN0cmVhbS5SZWFkYWJsZSB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcih7CiAgICAgIC4uLm9wdHMsCiAgICAgIGJ5dGVMZW5ndGg6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhSZWFkYWJsZTogbnVsbCwKICAgICAgbWFwOiBudWxsLAogICAgICBtYXBSZWFkYWJsZTogbnVsbAogICAgfSkKCiAgICBpZiAodGhpcy5fY29uc3RydWN0KSB0aGlzLl9vcGVuID0gdGhpcy5fY29uc3RydWN0CgogICAgaWYgKHRoaXMuX3JlYWQgIT09IHN0cmVhbS5SZWFkYWJsZS5wcm90b3R5cGUuX3JlYWQpIHsKICAgICAgdGhpcy5fcmVhZCA9IHJlYWQuYmluZCh0aGlzLCB0aGlzLl9yZWFkKQogICAgfQoKICAgIGlmICh0aGlzLl9kZXN0cm95ICE9PSBzdHJlYW0uU3RyZWFtLnByb3RvdHlwZS5fZGVzdHJveSkgewogICAgICB0aGlzLl9kZXN0cm95ID0gZGVzdHJveS5iaW5kKHRoaXMsIHRoaXMuX2Rlc3Ryb3kpCiAgICB9CiAgfQoKICBwdXNoKGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHJldHVybiBzdXBlci5wdXNoKGNodW5rKQogIH0KCiAgdW5zaGlmdChjaHVuaywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZykKICAgIH0KCiAgICBzdXBlci51bnNoaWZ0KGNodW5rKQogIH0KfQoKZXhwb3J0cy5Xcml0YWJsZSA9IGNsYXNzIFdyaXRhYmxlIGV4dGVuZHMgc3RyZWFtLldyaXRhYmxlIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKHsKICAgICAgLi4ub3B0cywKICAgICAgYnl0ZUxlbmd0aDogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFdyaXRhYmxlLAogICAgICBtYXA6IG51bGwsCiAgICAgIG1hcFdyaXRhYmxlOiBudWxsCiAgICB9KQoKICAgIGlmICh0aGlzLl9jb25zdHJ1Y3QpIHRoaXMuX29wZW4gPSB0aGlzLl9jb25zdHJ1Y3QKCiAgICBpZiAodGhpcy5fd3JpdGUgIT09IHN0cmVhbS5Xcml0YWJsZS5wcm90b3R5cGUuX3dyaXRlKSB7CiAgICAgIHRoaXMuX3dyaXRlID0gd3JpdGUuYmluZCh0aGlzLCB0aGlzLl93cml0ZSkKICAgIH0KCiAgICBpZiAodGhpcy5fZGVzdHJveSAhPT0gc3RyZWFtLlN0cmVhbS5wcm90b3R5cGUuX2Rlc3Ryb3kpIHsKICAgICAgdGhpcy5fZGVzdHJveSA9IGRlc3Ryb3kuYmluZCh0aGlzLCB0aGlzLl9kZXN0cm95KQogICAgfQogIH0KCiAgd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9IHN1cGVyLndyaXRlKHsgY2h1bmssIGVuY29kaW5nIH0pCgogICAgaWYgKGNiKSBzdHJlYW0uV3JpdGFibGUuZHJhaW5lZCh0aGlzKS50aGVuKCgpID0+IGNiKG51bGwpLCBjYikKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBlbmQoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGNodW5rCiAgICAgIGNodW5rID0gbnVsbAogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZwogICAgICBlbmNvZGluZyA9IG51bGwKICAgIH0KCiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IGRlZmF1bHRFbmNvZGluZwogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0KICAgICAgY2h1bmsgIT09IHVuZGVmaW5lZCAmJiBjaHVuayAhPT0gbnVsbAogICAgICAgID8gc3VwZXIuZW5kKHsgY2h1bmssIGVuY29kaW5nIH0pCiAgICAgICAgOiBzdXBlci5lbmQoKQoKICAgIGlmIChjYikgdGhpcy5vbmNlKCdmaW5pc2gnLCAoKSA9PiBjYihudWxsKSkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpleHBvcnRzLkR1cGxleCA9IGNsYXNzIER1cGxleCBleHRlbmRzIHN0cmVhbS5EdXBsZXggewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgc3VwZXIoewogICAgICAuLi5vcHRzLAogICAgICBieXRlTGVuZ3RoOiBudWxsLAogICAgICBieXRlTGVuZ3RoUmVhZGFibGU6IG51bGwsCiAgICAgIGJ5dGVMZW5ndGhXcml0YWJsZSwKICAgICAgbWFwOiBudWxsLAogICAgICBtYXBSZWFkYWJsZTogbnVsbCwKICAgICAgbWFwV3JpdGFibGU6IG51bGwKICAgIH0pCgogICAgaWYgKHRoaXMuX2NvbnN0cnVjdCkgdGhpcy5fb3BlbiA9IHRoaXMuX2NvbnN0cnVjdAoKICAgIGlmICh0aGlzLl9yZWFkICE9PSBzdHJlYW0uUmVhZGFibGUucHJvdG90eXBlLl9yZWFkKSB7CiAgICAgIHRoaXMuX3JlYWQgPSByZWFkLmJpbmQodGhpcywgdGhpcy5fcmVhZCkKICAgIH0KCiAgICBpZiAodGhpcy5fd3JpdGUgIT09IHN0cmVhbS5EdXBsZXgucHJvdG90eXBlLl93cml0ZSkgewogICAgICB0aGlzLl93cml0ZSA9IHdyaXRlLmJpbmQodGhpcywgdGhpcy5fd3JpdGUpCiAgICB9CgogICAgaWYgKHRoaXMuX2Rlc3Ryb3kgIT09IHN0cmVhbS5TdHJlYW0ucHJvdG90eXBlLl9kZXN0cm95KSB7CiAgICAgIHRoaXMuX2Rlc3Ryb3kgPSBkZXN0cm95LmJpbmQodGhpcywgdGhpcy5fZGVzdHJveSkKICAgIH0KICB9CgogIHB1c2goY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgcmV0dXJuIHN1cGVyLnB1c2goY2h1bmspCiAgfQoKICB1bnNoaWZ0KGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHN1cGVyLnVuc2hpZnQoY2h1bmspCiAgfQoKICB3cml0ZShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gc3VwZXIud3JpdGUoeyBjaHVuaywgZW5jb2RpbmcgfSkKCiAgICBpZiAoY2IpIHN0cmVhbS5Xcml0YWJsZS5kcmFpbmVkKHRoaXMpLnRoZW4oKCkgPT4gY2IobnVsbCksIGNiKQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGVuZChjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gY2h1bmsKICAgICAgY2h1bmsgPSBudWxsCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9CiAgICAgIGNodW5rICE9PSB1bmRlZmluZWQgJiYgY2h1bmsgIT09IG51bGwKICAgICAgICA/IHN1cGVyLmVuZCh7IGNodW5rLCBlbmNvZGluZyB9KQogICAgICAgIDogc3VwZXIuZW5kKCkKCiAgICBpZiAoY2IpIHRoaXMub25jZSgnZmluaXNoJywgKCkgPT4gY2IobnVsbCkpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZXhwb3J0cy5UcmFuc2Zvcm0gPSBjbGFzcyBUcmFuc2Zvcm0gZXh0ZW5kcyBzdHJlYW0uVHJhbnNmb3JtIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKHsKICAgICAgLi4ub3B0cywKICAgICAgYnl0ZUxlbmd0aDogbnVsbCwKICAgICAgYnl0ZUxlbmd0aFJlYWRhYmxlOiBudWxsLAogICAgICBieXRlTGVuZ3RoV3JpdGFibGUsCiAgICAgIG1hcDogbnVsbCwKICAgICAgbWFwUmVhZGFibGU6IG51bGwsCiAgICAgIG1hcFdyaXRhYmxlOiBudWxsCiAgICB9KQoKICAgIGlmICh0aGlzLl90cmFuc2Zvcm0gIT09IHN0cmVhbS5UcmFuc2Zvcm0ucHJvdG90eXBlLl90cmFuc2Zvcm0pIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtID0gdHJhbnNmb3JtLmJpbmQodGhpcywgdGhpcy5fdHJhbnNmb3JtKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtID0gcGFzc3Rocm91Z2gKICAgIH0KICB9CgogIHB1c2goY2h1bmssIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgewogICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcpCiAgICB9CgogICAgcmV0dXJuIHN1cGVyLnB1c2goY2h1bmspCiAgfQoKICB1bnNoaWZ0KGNodW5rLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nKQogICAgfQoKICAgIHN1cGVyLnVuc2hpZnQoY2h1bmspCiAgfQoKICB3cml0ZShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gZW5jb2RpbmcKICAgICAgZW5jb2RpbmcgPSBudWxsCiAgICB9CgogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBkZWZhdWx0RW5jb2RpbmcKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9ICdidWZmZXInCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gc3VwZXIud3JpdGUoeyBjaHVuaywgZW5jb2RpbmcgfSkKCiAgICBpZiAoY2IpIHN0cmVhbS5Xcml0YWJsZS5kcmFpbmVkKHRoaXMpLnRoZW4oKCkgPT4gY2IobnVsbCksIGNiKQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGVuZChjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gY2h1bmsKICAgICAgY2h1bmsgPSBudWxsCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYiA9IGVuY29kaW5nCiAgICAgIGVuY29kaW5nID0gbnVsbAogICAgfQoKICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5jb2RpbmcgfHwgZGVmYXVsdEVuY29kaW5nCiAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKQogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJwogICAgfQoKICAgIGNvbnN0IHJlc3VsdCA9CiAgICAgIGNodW5rICE9PSB1bmRlZmluZWQgJiYgY2h1bmsgIT09IG51bGwKICAgICAgICA/IHN1cGVyLmVuZCh7IGNodW5rLCBlbmNvZGluZyB9KQogICAgICAgIDogc3VwZXIuZW5kKCkKCiAgICBpZiAoY2IpIHRoaXMub25jZSgnZmluaXNoJywgKCkgPT4gY2IobnVsbCkpCgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKZXhwb3J0cy5QYXNzVGhyb3VnaCA9IGNsYXNzIFBhc3NUaHJvdWdoIGV4dGVuZHMgZXhwb3J0cy5UcmFuc2Zvcm0ge30KCmV4cG9ydHMuZmluaXNoZWQgPSBmdW5jdGlvbiBmaW5pc2hlZChzdHJlYW0sIG9wdHMsIGNiKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IG9wdHMKICAgIG9wdHMgPSB7fQogIH0KCiAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgY29uc3QgeyBjbGVhbnVwID0gZmFsc2UgfSA9IG9wdHMKCiAgY29uc3QgZG9uZSA9ICgpID0+IHsKICAgIGNiKGV4cG9ydHMuZ2V0U3RyZWFtRXJyb3Ioc3RyZWFtLCB7IGFsbDogdHJ1ZSB9KSkKCiAgICBpZiAoY2xlYW51cCkgZGV0YWNoKCkKICB9CgogIGNvbnN0IGRldGFjaCA9ICgpID0+IHsKICAgIHN0cmVhbS5vZmYoJ2Nsb3NlJywgZG9uZSkKICAgIHN0cmVhbS5vZmYoJ2Vycm9yJywgbm9vcCkKICB9CgogIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICBkb25lKCkKICB9IGVsc2UgewogICAgc3RyZWFtLm9uKCdjbG9zZScsIGRvbmUpCiAgICBzdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkKICB9CgogIHJldHVybiBkZXRhY2gKfQoKZnVuY3Rpb24gcmVhZChyZWFkLCBjYikgewogIHJlYWQuY2FsbCh0aGlzLCA2NTUzNikKCiAgY2IobnVsbCkKfQoKZnVuY3Rpb24gd3JpdGUod3JpdGUsIGRhdGEsIGNiKSB7CiAgd3JpdGUuY2FsbCh0aGlzLCBkYXRhLmNodW5rLCBkYXRhLmVuY29kaW5nLCBjYikKfQoKZnVuY3Rpb24gdHJhbnNmb3JtKHRyYW5zZm9ybSwgZGF0YSwgY2IpIHsKICB0cmFuc2Zvcm0uY2FsbCh0aGlzLCBkYXRhLmNodW5rLCBkYXRhLmVuY29kaW5nLCBjYikKfQoKZnVuY3Rpb24gZGVzdHJveShkZXN0cm95LCBjYikgewogIGRlc3Ryb3kuY2FsbCh0aGlzLCBleHBvcnRzLmdldFN0cmVhbUVycm9yKHRoaXMpLCBjYikKfQoKZnVuY3Rpb24gcGFzc3Rocm91Z2goZGF0YSwgY2IpIHsKICBjYihudWxsLCBkYXRhLmNodW5rKQp9CgpmdW5jdGlvbiBieXRlTGVuZ3RoV3JpdGFibGUoZGF0YSkgewogIHJldHVybiBkYXRhLmNodW5rLmJ5dGVMZW5ndGgKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CnsKICAibmFtZSI6ICJiYXJlLXN0cmVhbSIsCiAgInZlcnNpb24iOiAiMi43LjAiLAogICJkZXNjcmlwdGlvbiI6ICJTdHJlYW1pbmcgZGF0YSBmb3IgSmF2YVNjcmlwdCIsCiAgImV4cG9ydHMiOiB7CiAgICAiLiI6IHsKICAgICAgInR5cGVzIjogIi4vaW5kZXguZC50cyIsCiAgICAgICJkZWZhdWx0IjogIi4vaW5kZXguanMiCiAgICB9LAogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLi9wcm9taXNlcyI6ICIuL3Byb21pc2VzLmpzIiwKICAgICIuL3dlYiI6IHsKICAgICAgInR5cGVzIjogIi4vd2ViLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL3dlYi5qcyIKICAgIH0sCiAgICAiLi9nbG9iYWwiOiAiLi9nbG9iYWwuanMiCiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiLAogICAgInByb21pc2VzLmpzIiwKICAgICJ3ZWIuanMiLAogICAgIndlYi5kLnRzIiwKICAgICJnbG9iYWwuanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBiYXJlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1zdHJlYW0uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS1zdHJlYW0vaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXN0cmVhbSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAic3RyZWFteCI6ICJeMi4yMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWJ1ZmZlciI6ICJeMy4wLjAiLAogICAgImJhcmUtZXZlbnRzIjogIl4yLjUuNCIsCiAgICAiYnJpdHRsZSI6ICJeMy41LjIiLAogICAgInByZXR0aWVyIjogIl4zLjMuMyIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIKICB9LAogICJwZWVyRGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVmZmVyIjogIioiLAogICAgImJhcmUtZXZlbnRzIjogIioiCiAgfSwKICAicGVlckRlcGVuZGVuY2llc01ldGEiOiB7CiAgICAiYmFyZS1idWZmZXIiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0sCiAgICAiYmFyZS1ldmVudHMiOiB7CiAgICAgICJvcHRpb25hbCI6IHRydWUKICAgIH0KICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCkKY29uc3QgcGF0aCA9IHJlcXVpcmUoJ2JhcmUtcGF0aCcpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQpjb25zdCBVUkxTZWFyY2hQYXJhbXMgPSByZXF1aXJlKCcuL2xpYi91cmwtc2VhcmNoLXBhcmFtcycpCgpjb25zdCBraW5kID0gU3ltYm9sLmZvcignYmFyZS51cmwua2luZCcpCgpjb25zdCBpc1dpbmRvd3MgPSBCYXJlLnBsYXRmb3JtID09PSAnd2luMzInCgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBjbGFzcyBVUkwgewogIHN0YXRpYyBnZXQgW2tpbmRdKCkgewogICAgcmV0dXJuIDAgLy8gQ29tcGF0aWJpbGl0eSB2ZXJzaW9uCiAgfQoKICBjb25zdHJ1Y3RvcihpbnB1dCwgYmFzZSwgb3B0cyA9IHt9KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgdGhyb3cgZXJyb3JzLklOVkFMSURfVVJMKCkKCiAgICBpbnB1dCA9IFN0cmluZyhpbnB1dCkKCiAgICBpZiAoYmFzZSAhPT0gdW5kZWZpbmVkKSBiYXNlID0gU3RyaW5nKGJhc2UpCgogICAgdGhpcy5fY29tcG9uZW50cyA9IG5ldyBVaW50MzJBcnJheSg4KQoKICAgIHRoaXMuX3BhcnNlKGlucHV0LCBiYXNlLCBvcHRzLnRocm93ICE9PSBmYWxzZSkKCiAgICBpZiAodGhpcy5faHJlZikgdGhpcy5fcGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh0aGlzLnNlYXJjaCwgdGhpcykKICB9CgogIGdldCBba2luZF0oKSB7CiAgICByZXR1cm4gVVJMW2tpbmRdCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtaHJlZgoKICBnZXQgaHJlZigpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmCiAgfQoKICBzZXQgaHJlZih2YWx1ZSkgewogICAgdGhpcy5fdXBkYXRlKHZhbHVlKQoKICAgIHRoaXMuX3BhcmFtcy5fcGFyc2UodGhpcy5zZWFyY2gpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtcHJvdG9jb2wKCiAgZ2V0IHByb3RvY29sKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKDAsIHRoaXMuX2NvbXBvbmVudHNbMF0pICsgJzonCiAgfQoKICBzZXQgcHJvdG9jb2wodmFsdWUpIHsKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLnJlcGxhY2UoLzorJC8sICcnKSwgMCwgdGhpcy5fY29tcG9uZW50c1swXSkpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtdXNlcm5hbWUKCiAgZ2V0IHVzZXJuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbMF0gKyAzIC8qIDovLyAqLywgdGhpcy5fY29tcG9uZW50c1sxXSkKICB9CgogIHNldCB1c2VybmFtZSh2YWx1ZSkgewogICAgaWYgKGNhbm5vdEhhdmVDcmVkZW50aWFsc09yUG9ydCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy51c2VybmFtZSA9PT0gJycpIHZhbHVlICs9ICdAJwoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzBdICsgMyAvKiA6Ly8gKi8sIHRoaXMuX2NvbXBvbmVudHNbMV0pKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsLXBhc3N3b3JkCgogIGdldCBwYXNzd29yZCgpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmLnNsaWNlKHRoaXMuX2NvbXBvbmVudHNbMV0gKyAxIC8qIDogKi8sIHRoaXMuX2NvbXBvbmVudHNbMl0gLSAxIC8qIEAgKi8pCiAgfQoKICBzZXQgcGFzc3dvcmQodmFsdWUpIHsKICAgIGlmIChjYW5ub3RIYXZlQ3JlZGVudGlhbHNPclBvcnQodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgbGV0IHN0YXJ0ID0gdGhpcy5fY29tcG9uZW50c1sxXSArIDEgLyogOiAqLwogICAgbGV0IGVuZCA9IHRoaXMuX2NvbXBvbmVudHNbMl0gLSAxIC8qIEAgKi8KCiAgICBpZiAodGhpcy5wYXNzd29yZCA9PT0gJycpIHsKICAgICAgdmFsdWUgPSAnOicgKyB2YWx1ZQogICAgICBzdGFydC0tCiAgICB9CgogICAgaWYgKHRoaXMudXNlcm5hbWUgPT09ICcnKSB7CiAgICAgIHZhbHVlICs9ICdAJwogICAgICBlbmQrKwogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCBzdGFydCwgZW5kKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1ob3N0CgogIGdldCBob3N0KCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbMl0sIHRoaXMuX2NvbXBvbmVudHNbNV0pCiAgfQoKICBzZXQgaG9zdCh2YWx1ZSkgewogICAgaWYgKGhhc09wYXF1ZVBhdGgodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKAogICAgICB0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzJdLCB0aGlzLl9jb21wb25lbnRzW3ZhbHVlLmluY2x1ZGVzKCc6JykgPyA1IDogM10pCiAgICApCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtaG9zdG5hbWUKCiAgZ2V0IGhvc3RuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbMl0sIHRoaXMuX2NvbXBvbmVudHNbM10pCiAgfQoKICBzZXQgaG9zdG5hbWUodmFsdWUpIHsKICAgIGlmIChoYXNPcGFxdWVQYXRoKHRoaXMpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzJdLCB0aGlzLl9jb21wb25lbnRzWzNdKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1wb3J0CgogIGdldCBwb3J0KCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbM10gKyAxIC8qIDogKi8sIHRoaXMuX2NvbXBvbmVudHNbNV0pCiAgfQoKICBzZXQgcG9ydCh2YWx1ZSkgewogICAgaWYgKGNhbm5vdEhhdmVDcmVkZW50aWFsc09yUG9ydCh0aGlzKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBsZXQgc3RhcnQgPSB0aGlzLl9jb21wb25lbnRzWzNdICsgMSAvKiA6ICovCgogICAgaWYgKHRoaXMucG9ydCA9PT0gJycpIHsKICAgICAgdmFsdWUgPSAnOicgKyB2YWx1ZQogICAgICBzdGFydC0tCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKHRoaXMuX3JlcGxhY2UodmFsdWUsIHN0YXJ0LCB0aGlzLl9jb21wb25lbnRzWzVdKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1wYXRobmFtZQoKICBnZXQgcGF0aG5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fc2xpY2UodGhpcy5fY29tcG9uZW50c1s1XSwgdGhpcy5fY29tcG9uZW50c1s2XSAtIDEgLyogPyAqLykKICB9CgogIHNldCBwYXRobmFtZSh2YWx1ZSkgewogICAgaWYgKGhhc09wYXF1ZVBhdGgodGhpcykpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHZhbHVlWzBdICE9PSAnLycgJiYgdmFsdWVbMF0gIT09ICdcXCcpIHsKICAgICAgdmFsdWUgPSAnLycgKyB2YWx1ZQogICAgfQoKICAgIHRoaXMuX3VwZGF0ZSh0aGlzLl9yZXBsYWNlKHZhbHVlLCB0aGlzLl9jb21wb25lbnRzWzVdLCB0aGlzLl9jb21wb25lbnRzWzZdIC0gMSAvKiA/ICovKSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1zZWFyY2gKCiAgZ2V0IHNlYXJjaCgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSh0aGlzLl9jb21wb25lbnRzWzZdIC0gMSAvKiA/ICovLCB0aGlzLl9jb21wb25lbnRzWzddIC0gMSAvKiAjICovKQogIH0KCiAgc2V0IHNlYXJjaCh2YWx1ZSkgewogICAgaWYgKHZhbHVlICYmIHZhbHVlWzBdICE9PSAnPycpIHZhbHVlID0gJz8nICsgdmFsdWUKCiAgICB0aGlzLl91cGRhdGUoCiAgICAgIHRoaXMuX3JlcGxhY2UodmFsdWUsIHRoaXMuX2NvbXBvbmVudHNbNl0gLSAxIC8qID8gKi8sIHRoaXMuX2NvbXBvbmVudHNbN10gLSAxIC8qICMgKi8pCiAgICApCgogICAgdGhpcy5fcGFyYW1zLl9wYXJzZSh0aGlzLnNlYXJjaCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1zZWFyY2hwYXJhbXMKCiAgZ2V0IHNlYXJjaFBhcmFtcygpIHsKICAgIHJldHVybiB0aGlzLl9wYXJhbXMKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybC1oYXNoCgogIGdldCBoYXNoKCkgewogICAgcmV0dXJuIHRoaXMuX3NsaWNlKHRoaXMuX2NvbXBvbmVudHNbN10gLSAxIC8qICMgKi8pCiAgfQoKICBzZXQgaGFzaCh2YWx1ZSkgewogICAgaWYgKHZhbHVlICYmIHZhbHVlWzBdICE9PSAnIycpIHZhbHVlID0gJyMnICsgdmFsdWUKCiAgICB0aGlzLl91cGRhdGUodGhpcy5fcmVwbGFjZSh2YWx1ZSwgdGhpcy5fY29tcG9uZW50c1s3XSAtIDEgLyogIyAqLykpCiAgfQoKICB0b1N0cmluZygpIHsKICAgIHJldHVybiB0aGlzLl9ocmVmCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy5faHJlZgogIH0KCiAgW1N5bWJvbC5mb3IoJ2JhcmUuaW5zcGVjdCcpXSgpIHsKICAgIHJldHVybiB7CiAgICAgIF9fcHJvdG9fXzogeyBjb25zdHJ1Y3RvcjogVVJMIH0sCgogICAgICBocmVmOiB0aGlzLmhyZWYsCiAgICAgIHByb3RvY29sOiB0aGlzLnByb3RvY29sLAogICAgICB1c2VybmFtZTogdGhpcy51c2VybmFtZSwKICAgICAgcGFzc3dvcmQ6IHRoaXMucGFzc3dvcmQsCiAgICAgIGhvc3Q6IHRoaXMuaG9zdCwKICAgICAgaG9zdG5hbWU6IHRoaXMuaG9zdG5hbWUsCiAgICAgIHBvcnQ6IHRoaXMucG9ydCwKICAgICAgcGF0aG5hbWU6IHRoaXMucGF0aG5hbWUsCiAgICAgIHNlYXJjaDogdGhpcy5zZWFyY2gsCiAgICAgIHNlYXJjaFBhcmFtczogdGhpcy5zZWFyY2hQYXJhbXMsCiAgICAgIGhhc2g6IHRoaXMuaGFzaAogICAgfQogIH0KCiAgX3NsaWNlKHN0YXJ0LCBlbmQgPSB0aGlzLl9ocmVmLmxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuX2hyZWYuc2xpY2Uoc3RhcnQsIGVuZCkKICB9CgogIF9yZXBsYWNlKHJlcGxhY2VtZW50LCBzdGFydCwgZW5kID0gdGhpcy5faHJlZi5sZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLl9zbGljZSgwLCBzdGFydCkgKyByZXBsYWNlbWVudCArIHRoaXMuX3NsaWNlKGVuZCkKICB9CgogIF9wYXJzZShpbnB1dCwgYmFzZSwgc2hvdWxkVGhyb3cpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMuX2hyZWYgPSBiaW5kaW5nLnBhcnNlKAogICAgICAgIFN0cmluZyhpbnB1dCksCiAgICAgICAgYmFzZSA/IFN0cmluZyhiYXNlKSA6IG51bGwsCiAgICAgICAgdGhpcy5fY29tcG9uZW50cywKICAgICAgICBzaG91bGRUaHJvdwogICAgICApCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFR5cGVFcnJvcikgdGhyb3cgZXJyCgogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9VUkwoYEludmFsaWQgVVJMICcke2lucHV0fSdgLCBpbnB1dCkKICAgIH0KICB9CgogIF91cGRhdGUoaW5wdXQpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMuX3BhcnNlKGlucHV0LCBudWxsLCB0cnVlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBUeXBlRXJyb3IpIHRocm93IGVycgogICAgfQogIH0KfQoKLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyN1cmwtb3BhcXVlLXBhdGgKZnVuY3Rpb24gaGFzT3BhcXVlUGF0aCh1cmwpIHsKICByZXR1cm4gdXJsLnBhdGhuYW1lWzBdICE9PSAnLycKfQoKLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNjYW5ub3QtaGF2ZS1hLXVzZXJuYW1lLXBhc3N3b3JkLXBvcnQKZnVuY3Rpb24gY2Fubm90SGF2ZUNyZWRlbnRpYWxzT3JQb3J0KHVybCkgewogIHJldHVybiB1cmwuaG9zdG5hbWUgPT09ICcnIHx8IHVybC5wcm90b2NvbCA9PT0gJ2ZpbGU6Jwp9Cgpjb25zdCBVUkwgPSBleHBvcnRzCgpleHBvcnRzLlVSTCA9IFVSTApleHBvcnRzLlVSTFNlYXJjaFBhcmFtcyA9IFVSTFNlYXJjaFBhcmFtcwoKZXhwb3J0cy5lcnJvcnMgPSBlcnJvcnMKCmV4cG9ydHMuaXNVUkwgPSBmdW5jdGlvbiBpc1VSTCh2YWx1ZSkgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFVSTCkgcmV0dXJuIHRydWUKCiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWVba2luZF0gPT09IFVSTFtraW5kXQp9CgovLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtcGFyc2UKZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uIHBhcnNlKGlucHV0LCBiYXNlKSB7CiAgY29uc3QgdXJsID0gbmV3IFVSTChpbnB1dCwgYmFzZSwgeyB0aHJvdzogZmFsc2UgfSkKICByZXR1cm4gdXJsLl9ocmVmID8gdXJsIDogbnVsbAp9CgovLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmwtY2FucGFyc2UKZXhwb3J0cy5jYW5QYXJzZSA9IGZ1bmN0aW9uIGNhblBhcnNlKGlucHV0LCBiYXNlKSB7CiAgcmV0dXJuIGJpbmRpbmcuY2FuUGFyc2UoU3RyaW5nKGlucHV0KSwgYmFzZSA/IFN0cmluZyhiYXNlKSA6IG51bGwpCn0KCmV4cG9ydHMuZmlsZVVSTFRvUGF0aCA9IGZ1bmN0aW9uIGZpbGVVUkxUb1BhdGgodXJsKSB7CiAgaWYgKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnKSB7CiAgICB1cmwgPSBuZXcgVVJMKHVybCkKICB9CgogIGlmICh1cmwucHJvdG9jb2wgIT09ICdmaWxlOicpIHsKICAgIHRocm93IGVycm9ycy5JTlZBTElEX1VSTF9TQ0hFTUUoJ1RoZSBVUkwgbXVzdCB1c2UgdGhlIGZpbGU6IHByb3RvY29sJykKICB9CgogIGlmIChpc1dpbmRvd3MpIHsKICAgIGlmICgvJTJmfCU1Yy9pLnRlc3QodXJsLnBhdGhuYW1lKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9GSUxFX1VSTF9QQVRIKAogICAgICAgICdUaGUgZmlsZTogVVJMIHBhdGggbXVzdCBub3QgaW5jbHVkZSBlbmNvZGVkIFxcIG9yIC8gY2hhcmFjdGVycycKICAgICAgKQogICAgfQogIH0gZWxzZSB7CiAgICBpZiAodXJsLmhvc3RuYW1lKSB7CiAgICAgIHRocm93IGVycm9ycy5JTlZBTElEX0ZJTEVfVVJMX0hPU1QoIlRoZSBmaWxlOiBVUkwgaG9zdCBtdXN0IGJlICdsb2NhbGhvc3QnIG9yIGVtcHR5IikKICAgIH0KCiAgICBpZiAoLyUyZi9pLnRlc3QodXJsLnBhdGhuYW1lKSkgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9GSUxFX1VSTF9QQVRIKCdUaGUgZmlsZTogVVJMIHBhdGggbXVzdCBub3QgaW5jbHVkZSBlbmNvZGVkIC8gY2hhcmFjdGVycycpCiAgICB9CiAgfQoKICBjb25zdCBwYXRobmFtZSA9IHBhdGgubm9ybWFsaXplKGRlY29kZVVSSUNvbXBvbmVudCh1cmwucGF0aG5hbWUpKQoKICBpZiAoaXNXaW5kb3dzKSB7CiAgICBpZiAodXJsLmhvc3RuYW1lKSByZXR1cm4gJ1xcXFwnICsgdXJsLmhvc3RuYW1lICsgcGF0aG5hbWUKCiAgICBjb25zdCBsZXR0ZXIgPSBwYXRobmFtZS5jaGFyQ29kZUF0KDEpIHwgMHgyMAoKICAgIGlmIChsZXR0ZXIgPCAweDYxIC8qIGEgKi8gfHwgbGV0dGVyID4gMHg3YSAvKiB6ICovIHx8IHBhdGhuYW1lLmNoYXJDb2RlQXQoMikgIT09IDB4M2EgLyogOiAqLykgewogICAgICB0aHJvdyBlcnJvcnMuSU5WQUxJRF9GSUxFX1VSTF9QQVRIKCdUaGUgZmlsZTogVVJMIHBhdGggbXVzdCBiZSBhYnNvbHV0ZScpCiAgICB9CgogICAgcmV0dXJuIHBhdGhuYW1lLnNsaWNlKDEpCiAgfQoKICByZXR1cm4gcGF0aG5hbWUKfQoKZXhwb3J0cy5wYXRoVG9GaWxlVVJMID0gZnVuY3Rpb24gcGF0aFRvRmlsZVVSTChwYXRobmFtZSkgewogIGxldCByZXNvbHZlZCA9IHBhdGgucmVzb2x2ZShwYXRobmFtZSkKCiAgaWYgKHBhdGhuYW1lW3BhdGhuYW1lLmxlbmd0aCAtIDFdID09PSAnLycpIHsKICAgIHJlc29sdmVkICs9ICcvJwogIH0gZWxzZSBpZiAoaXNXaW5kb3dzICYmIHBhdGhuYW1lW3BhdGhuYW1lLmxlbmd0aCAtIDFdID09PSAnXFwnKSB7CiAgICByZXNvbHZlZCArPSAnXFwnCiAgfQoKICByZXNvbHZlZCA9IHJlc29sdmVkCiAgICAucmVwbGFjZUFsbCgnJScsICclMjUnKSAvLyBNdXN0IGJlIGZpcnN0CiAgICAucmVwbGFjZUFsbCgnIycsICclMjMnKQogICAgLnJlcGxhY2VBbGwoJz8nLCAnJTNmJykKICAgIC5yZXBsYWNlQWxsKCdcbicsICclMGEnKQogICAgLnJlcGxhY2VBbGwoJ1xyJywgJyUwZCcpCiAgICAucmVwbGFjZUFsbCgnXHQnLCAnJTA5JykKCiAgaWYgKCFpc1dpbmRvd3MpIHsKICAgIHJlc29sdmVkID0gcmVzb2x2ZWQucmVwbGFjZUFsbCgnXFwnLCAnJTVjJykKICB9CgogIHJldHVybiBuZXcgVVJMKCdmaWxlOicgKyByZXNvbHZlZCkKfQoKZXhwb3J0cy5mb3JtYXQgPSBmdW5jdGlvbiBmb3JtYXQocGFydHMpIHsKICBjb25zdCB7IHByb3RvY29sLCBhdXRoLCBob3N0LCBob3N0bmFtZSwgcG9ydCwgcGF0aG5hbWUsIHNlYXJjaCwgcXVlcnksIGhhc2gsIHNsYXNoZXMgfSA9IHBhcnRzCgogIGxldCByZXN1bHQgPSAnJwoKICBpZiAodHlwZW9mIHByb3RvY29sID09PSAnc3RyaW5nJykgewogICAgcmVzdWx0ICs9IHByb3RvY29sCgogICAgaWYgKHByb3RvY29sW3Byb3RvY29sLmxlbmd0aCAtIDFdICE9PSAnOicpIHsKICAgICAgcmVzdWx0ICs9ICc6JwogICAgfQoKICAgIGlmIChzbGFzaGVzID09PSB0cnVlIHx8IC9odHRwcz98ZnRwfGdvcGhlcnxmaWxlLy50ZXN0KHByb3RvY29sKSkgewogICAgICByZXN1bHQgKz0gJy8vJwogICAgfQogIH0KCiAgaWYgKHR5cGVvZiBhdXRoID09PSAnc3RyaW5nJykgewogICAgaWYgKGhvc3QgfHwgaG9zdG5hbWUpIHJlc3VsdCArPSBhdXRoICsgJ0AnCiAgfQoKICBpZiAodHlwZW9mIGhvc3QgPT09ICdzdHJpbmcnKSByZXN1bHQgKz0gaG9zdAogIGVsc2UgewogICAgcmVzdWx0ICs9IGhvc3RuYW1lCgogICAgaWYgKHBvcnQpIHJlc3VsdCArPSAnOicgKyBwb3J0CiAgfQoKICBpZiAodHlwZW9mIHBhdGhuYW1lID09PSAnc3RyaW5nJyAmJiBwYXRobmFtZSAhPT0gJycpIHsKICAgIGlmIChwYXRobmFtZVswXSAhPT0gJy8nKSByZXN1bHQgKz0gJy8nCiAgICByZXN1bHQgKz0gcGF0aG5hbWUKICB9CgogIGlmICh0eXBlb2Ygc2VhcmNoID09PSAnc3RyaW5nJykgewogICAgaWYgKHNlYXJjaFswXSAhPT0gJz8nKSByZXN1bHQgKz0gJz8nCiAgICByZXN1bHQgKz0gc2VhcmNoCiAgfSBlbHNlIGlmICh0eXBlb2YgcXVlcnkgPT09ICdvYmplY3QnICYmIHF1ZXJ5ICE9PSBudWxsKSB7CiAgICByZXN1bHQgKz0gJz8nICsgbmV3IFVSTFNlYXJjaFBhcmFtcyhxdWVyeSkKICB9CgogIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3N0cmluZycpIHsKICAgIGlmIChoYXNoWzBdICE9PSAnIycpIHJlc3VsdCArPSAnIycKICAgIHJlc3VsdCArPSBoYXNoCiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVUkxFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGZuID0gVVJMRXJyb3IsIGNvZGUgPSBmbi5uYW1lKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBmbikKICB9CgogIGdldCBuYW1lKCkgewogICAgcmV0dXJuICdVUkxFcnJvcicKICB9CgogIHN0YXRpYyBJTlZBTElEX1VSTChtc2csIGlucHV0KSB7CiAgICBjb25zdCBlcnIgPSBuZXcgVVJMRXJyb3IobXNnLCBVUkxFcnJvci5JTlZBTElEX1VSTCkKCiAgICBlcnIuaW5wdXQgPSBpbnB1dAoKICAgIHJldHVybiBlcnIKICB9CgogIHN0YXRpYyBJTlZBTElEX1VSTF9TQ0hFTUUobXNnID0gJ0ludmFsaWQgVVJMJykgewogICAgcmV0dXJuIG5ldyBVUkxFcnJvcihtc2csIFVSTEVycm9yLklOVkFMSURfVVJMX1NDSEVNRSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0ZJTEVfVVJMX0hPU1QobXNnID0gJ0ludmFsaWQgZmlsZTogVVJMIGhvc3QnKSB7CiAgICByZXR1cm4gbmV3IFVSTEVycm9yKG1zZywgVVJMRXJyb3IuSU5WQUxJRF9GSUxFX1VSTF9IT1NUKQogIH0KCiAgc3RhdGljIElOVkFMSURfRklMRV9VUkxfUEFUSChtc2cgPSAnSW52YWxpZCBmaWxlOiBVUkwgcGF0aCcpIHsKICAgIHJldHVybiBuZXcgVVJMRXJyb3IobXNnLCBVUkxFcnJvci5JTlZBTElEX0ZJTEVfVVJMX1BBVEgpCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVVJMU2VhcmNoUGFyYW1zIHsKICBzdGF0aWMgX3VybHMgPSBuZXcgV2Vha01hcCgpCgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy11cmxzZWFyY2hwYXJhbXMKICBjb25zdHJ1Y3Rvcihpbml0LCB1cmwgPSBudWxsKSB7CiAgICB0aGlzLl9wYXJhbXMgPSBuZXcgTWFwKCkKCiAgICBpZiAodXJsKSBVUkxTZWFyY2hQYXJhbXMuX3VybHMuc2V0KHRoaXMsIHVybCkKCiAgICBpZiAodHlwZW9mIGluaXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIHRoaXMuX3BhcnNlKGluaXQpCiAgICB9IGVsc2UgaWYgKGluaXQpIHsKICAgICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIHR5cGVvZiBpbml0W1N5bWJvbC5pdGVyYXRvcl0gPT09ICdmdW5jdGlvbicKICAgICAgICA/IGluaXQKICAgICAgICA6IE9iamVjdC5lbnRyaWVzKGluaXQpKSB7CiAgICAgICAgdGhpcy5hcHBlbmQobmFtZSwgdmFsdWUpCiAgICAgIH0KICAgIH0KICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1zaXplCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFyYW1zLmxlbmd0aAogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLWFwcGVuZAogIGFwcGVuZChuYW1lLCB2YWx1ZSA9IG51bGwpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuCgogICAgbGV0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgewogICAgICBsaXN0ID0gW10KICAgICAgdGhpcy5fcGFyYW1zLnNldChuYW1lLCBsaXN0KQogICAgfQoKICAgIGxpc3QucHVzaCh2YWx1ZSkKCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNkb20tdXJsc2VhcmNocGFyYW1zLWRlbGV0ZQogIGRlbGV0ZShuYW1lLCB2YWx1ZSA9IG51bGwpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgdGhpcy5fcGFyYW1zLmRlbGV0ZShuYW1lKQogICAgZWxzZSB7CiAgICAgIGxldCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgICBsaXN0ID0gbGlzdC5maWx0ZXIoKGZvdW5kKSA9PiBmb3VuZCAhPT0gdmFsdWUpCgogICAgICBpZiAobGlzdC5sZW5ndGggPT09IDApIHRoaXMuX3BhcmFtcy5kZWxldGUobmFtZSkKICAgICAgZWxzZSB0aGlzLl9wYXJhbXMuc2V0KG5hbWUsIGxpc3QpCiAgICB9CgogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1nZXQKICBnZXQobmFtZSkgewogICAgY29uc3QgbGlzdCA9IHRoaXMuX3BhcmFtcy5nZXQobmFtZSkKCiAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiBsaXN0WzBdCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2RvbS11cmxzZWFyY2hwYXJhbXMtZ2V0YWxsCiAgZ2V0QWxsKG5hbWUpIHsKICAgIGNvbnN0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIFtdCgogICAgcmV0dXJuIEFycmF5LmZyb20obGlzdCkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1oYXMKICBoYXMobmFtZSwgdmFsdWUgPSBudWxsKSB7CiAgICBjb25zdCBsaXN0ID0gdGhpcy5fcGFyYW1zLmdldChuYW1lKQoKICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZQoKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICByZXR1cm4gbGlzdC5pbmNsdWRlcyh2YWx1ZSkKICB9CgogIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jZG9tLXVybHNlYXJjaHBhcmFtcy1zZXQKICBzZXQobmFtZSwgdmFsdWUgPSBudWxsKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpIHRoaXMuX3BhcmFtcy5kZWxldGUobmFtZSkKICAgIGVsc2UgdGhpcy5fcGFyYW1zLnNldChuYW1lLCBbdmFsdWVdKQoKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICB0b1N0cmluZygpIHsKICAgIHJldHVybiB0aGlzLl9zZXJpYWxpemUoKQogIH0KCiAgdG9KU09OKCkgewogICAgcmV0dXJuIFsuLi50aGlzXQogIH0KCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVzXSBvZiB0aGlzLl9wYXJhbXMpIHsKICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHlpZWxkIFtuYW1lLCB2YWx1ZV0KICAgIH0KICB9CgogIFtTeW1ib2wuZm9yKCdiYXJlLmluc3BlY3QnKV0oKSB7CiAgICBjb25zdCBvYmplY3QgPSB7CiAgICAgIF9fcHJvdG9fXzogeyBjb25zdHJ1Y3RvcjogVVJMU2VhcmNoUGFyYW1zIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZXNdIG9mIHRoaXMuX3BhcmFtcykgewogICAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMSkgb2JqZWN0W25hbWVdID0gdmFsdWVzWzBdCiAgICAgIGVsc2Ugb2JqZWN0W25hbWVdID0gdmFsdWVzCiAgICB9CgogICAgcmV0dXJuIG9iamVjdAogIH0KCiAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LXVybHNlYXJjaHBhcmFtcy11cGRhdGUKICBfdXBkYXRlKCkgewogICAgY29uc3QgdXJsID0gVVJMU2VhcmNoUGFyYW1zLl91cmxzLmdldCh0aGlzKQoKICAgIGlmICh1cmwgPT09IHVuZGVmaW5lZCkgcmV0dXJuCgogICAgdXJsLnNlYXJjaCA9IHRoaXMuX3NlcmlhbGl6ZSgpCiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtdXJsZW5jb2RlZC1wYXJzZXIKICBfcGFyc2UoaW5wdXQpIHsKICAgIGlmIChpbnB1dFswXSA9PT0gJz8nKSBpbnB1dCA9IGlucHV0LnN1YnN0cmluZygxKQoKICAgIHRoaXMuX3BhcmFtcyA9IG5ldyBNYXAoKQoKICAgIGZvciAoY29uc3Qgc2VxdWVuY2Ugb2YgaW5wdXQuc3BsaXQoJyYnKSkgewogICAgICBpZiAoc2VxdWVuY2UubGVuZ3RoID09PSAwKSBjb250aW51ZQoKICAgICAgbGV0IGkgPSBzZXF1ZW5jZS5pbmRleE9mKCc9JykKICAgICAgaWYgKGkgPT09IC0xKSBpID0gc2VxdWVuY2UubGVuZ3RoCgogICAgICBjb25zdCBuYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KHNlcXVlbmNlLnN1YnN0cmluZygwLCBpKSkKICAgICAgY29uc3QgdmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQoc2VxdWVuY2Uuc3Vic3RyaW5nKGkgKyAxLCBzZXF1ZW5jZS5sZW5ndGgpKQoKICAgICAgbGV0IGxpc3QgPSB0aGlzLl9wYXJhbXMuZ2V0KG5hbWUpCgogICAgICBpZiAobGlzdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbGlzdCA9IFtdCiAgICAgICAgdGhpcy5fcGFyYW1zLnNldChuYW1lLCBsaXN0KQogICAgICB9CgogICAgICBsaXN0LnB1c2godmFsdWUpCiAgICB9CiAgfQoKICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtdXJsZW5jb2RlZC1zZXJpYWxpemVyCiAgX3NlcmlhbGl6ZSgpIHsKICAgIGxldCBvdXRwdXQgPSAnJwoKICAgIGZvciAobGV0IFtuYW1lLCB2YWx1ZXNdIG9mIHRoaXMuX3BhcmFtcykgewogICAgICBuYW1lID0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpCgogICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICAgIGlmIChvdXRwdXQpIG91dHB1dCArPSAnJicKCiAgICAgICAgb3V0cHV0ICs9IG5hbWUgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gb3V0cHV0CiAgfQp9CnsKICAibmFtZSI6ICJiYXJlLXVybCIsCiAgInZlcnNpb24iOiAiMi4zLjIiLAogICJkZXNjcmlwdGlvbiI6ICJXSEFUV0cgVVJMIGltcGxlbWVudGF0aW9uIGZvciBKYXZhU2NyaXB0IiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJ0eXBlcyI6ICIuL2luZGV4LmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2luZGV4LmpzIgogICAgfSwKICAgICIuL2dsb2JhbCI6IHsKICAgICAgInR5cGVzIjogIi4vZ2xvYmFsLmQudHMiLAogICAgICAiZGVmYXVsdCI6ICIuL2dsb2JhbC5qcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiaW5kZXguZC50cyIsCiAgICAiZ2xvYmFsLmpzIiwKICAgICJnbG9iYWwuZC50cyIsCiAgICAiYmluZGluZy5jIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIsCiAgICAibGliIiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJhcmUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXVybC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXVybC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdXJsIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtcGF0aCI6ICJeMy4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuNiIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy4zLjMiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0KfQpjb25zdCBGQUNUT1IgPSBuZXcgVWludDE2QXJyYXkoOCkKCmZ1bmN0aW9uIGZhY3RvcjQwOTYgKGksIG4pIHsKICB3aGlsZSAobiA+IDApIHsKICAgIGNvbnN0IGYgPSBpICYgNDA5NQogICAgRkFDVE9SWy0tbl0gPSBmCiAgICBpID0gKGkgLSBmKSAvIDQwOTYKICB9CiAgcmV0dXJuIEZBQ1RPUgp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJpZ1NwYXJzZUFycmF5IHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLnRpbnkgPSBuZXcgVGlueUFycmF5KCkKICAgIHRoaXMubWF4TGVuZ3RoID0gNDA5NgogICAgdGhpcy5mYWN0b3IgPSAxCiAgfQoKICBzZXQgKGluZGV4LCB2YWwpIHsKICAgIGlmICh2YWwgIT09IHVuZGVmaW5lZCkgewogICAgICB3aGlsZSAoaW5kZXggPj0gdGhpcy5tYXhMZW5ndGgpIHsKICAgICAgICB0aGlzLm1heExlbmd0aCAqPSA0MDk2CiAgICAgICAgdGhpcy5mYWN0b3IrKwogICAgICAgIGlmICghdGhpcy50aW55LmlzRW1wdHlpc2goKSkgewogICAgICAgICAgY29uc3QgdCA9IG5ldyBUaW55QXJyYXkoKQogICAgICAgICAgdC5zZXQoMCwgdGhpcy50aW55KQogICAgICAgICAgdGhpcy50aW55ID0gdAogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbnN0IGYgPSBmYWN0b3I0MDk2KGluZGV4LCB0aGlzLmZhY3RvcikKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmZhY3RvciAtIDEKCiAgICBsZXQgdGlueSA9IHRoaXMudGlueQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXN0OyBpKyspIHsKICAgICAgY29uc3QgbmV4dCA9IHRpbnkuZ2V0KGZbaV0pCiAgICAgIGlmIChuZXh0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHJldHVybgogICAgICAgIHRpbnkgPSB0aW55LnNldChmW2ldLCBuZXcgVGlueUFycmF5KCkpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGlueSA9IG5leHQKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aW55LnNldChmW2xhc3RdLCB2YWwpCiAgfQoKICBnZXQgKGluZGV4KSB7CiAgICBpZiAoaW5kZXggPj0gdGhpcy5tYXhMZW5ndGgpIHJldHVybgoKICAgIGNvbnN0IGYgPSBmYWN0b3I0MDk2KGluZGV4LCB0aGlzLmZhY3RvcikKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmZhY3RvciAtIDEKCiAgICBsZXQgdGlueSA9IHRoaXMudGlueQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXN0OyBpKyspIHsKICAgICAgdGlueSA9IHRpbnkuZ2V0KGZbaV0pCiAgICAgIGlmICh0aW55ID09PSB1bmRlZmluZWQpIHJldHVybgogICAgfQoKICAgIHJldHVybiB0aW55LmdldChmW2xhc3RdKQogIH0KfQoKY2xhc3MgVGlueUFycmF5IHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLnMgPSAwCiAgICB0aGlzLmIgPSBuZXcgQXJyYXkoMSkKICAgIHRoaXMuZiA9IG5ldyBVaW50MTZBcnJheSgxKQogIH0KCiAgaXNFbXB0eWlzaCAoKSB7CiAgICByZXR1cm4gdGhpcy5iLmxlbmd0aCA9PT0gMSAmJiB0aGlzLmJbMF0gPT09IHVuZGVmaW5lZAogIH0KCiAgZ2V0IChpKSB7CiAgICBpZiAodGhpcy5zID09PSAxMikgcmV0dXJuIHRoaXMuYltpXQogICAgY29uc3QgZiA9IGkgPj4+IHRoaXMucwogICAgY29uc3QgciA9IGkgJiAodGhpcy5iLmxlbmd0aCAtIDEpCiAgICByZXR1cm4gdGhpcy5mW3JdID09PSBmID8gdGhpcy5iW3JdIDogdW5kZWZpbmVkCiAgfQoKICBzZXQgKGksIHYpIHsKICAgIHdoaWxlICh0aGlzLnMgIT09IDEyKSB7CiAgICAgIGNvbnN0IGYgPSBpID4+PiB0aGlzLnMKICAgICAgY29uc3QgciA9IGkgJiAodGhpcy5iLmxlbmd0aCAtIDEpCiAgICAgIGNvbnN0IG8gPSB0aGlzLmJbcl0KCiAgICAgIGlmIChvID09PSB1bmRlZmluZWQgfHwgZiA9PT0gdGhpcy5mW3JdKSB7CiAgICAgICAgdGhpcy5iW3JdID0gdgogICAgICAgIHRoaXMuZltyXSA9IGYKICAgICAgICByZXR1cm4gdgogICAgICB9CgogICAgICB0aGlzLmdyb3coKQogICAgfQoKICAgIHRoaXMuYltpXSA9IHYKICAgIHJldHVybiB2CiAgfQoKICBncm93ICgpIHsKICAgIGNvbnN0IG9zID0gdGhpcy5zCiAgICBjb25zdCBvYiA9IHRoaXMuYgogICAgY29uc3Qgb2YgPSB0aGlzLmYKCiAgICB0aGlzLnMgKz0gNAogICAgdGhpcy5iID0gbmV3IEFycmF5KHRoaXMuYi5sZW5ndGggPDwgNCkKICAgIHRoaXMuZiA9IHRoaXMucyA9PT0gMTIgPyBudWxsIDogbmV3IFVpbnQ4QXJyYXkodGhpcy5iLmxlbmd0aCkKCiAgICBjb25zdCBtID0gdGhpcy5iLmxlbmd0aCAtIDEKCiAgICBmb3IgKGxldCBvciA9IDA7IG9yIDwgb2IubGVuZ3RoOyBvcisrKSB7CiAgICAgIGlmIChvYltvcl0gPT09IHVuZGVmaW5lZCkgY29udGludWUKCiAgICAgIGNvbnN0IGkgPSBvZltvcl0gPDwgb3MgfCBvcgogICAgICBjb25zdCBmID0gaSA+Pj4gdGhpcy5zCiAgICAgIGNvbnN0IHIgPSBpICYgbQoKICAgICAgdGhpcy5iW3JdID0gb2Jbb3JdCiAgICAgIGlmICh0aGlzLnMgIT09IDEyKSB0aGlzLmZbcl0gPSBmCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJiaWctc3BhcnNlLWFycmF5IiwKICAidmVyc2lvbiI6ICIxLjAuMyIsCiAgImRlc2NyaXB0aW9uIjogIkEgc3BhcnNlIGFycmF5IG9wdGltaXNlZCBmb3IgbG93IG1lbW9yeSB3aGlsc3Qgc3RpbGwgYmVpbmcgZmFzdCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYmlnLXNwYXJzZS1hcnJheS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYmlnLXNwYXJzZS1hcnJheS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9iaWctc3BhcnNlLWFycmF5Igp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpmdW5jdGlvbiBieXRlTGVuZ3RoIChzaXplKSB7CiAgcmV0dXJuIE1hdGguY2VpbChzaXplIC8gOCkKfQoKZnVuY3Rpb24gZ2V0IChidWZmZXIsIGJpdCkgewogIGNvbnN0IG4gPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGNvbnN0IG9mZnNldCA9IGJpdCAmIChuIC0gMSkKICBjb25zdCBpID0gKGJpdCAtIG9mZnNldCkgLyBuCgogIHJldHVybiAoYnVmZmVyW2ldICYgKDEgPDwgb2Zmc2V0KSkgIT09IDAKfQoKZnVuY3Rpb24gc2V0IChidWZmZXIsIGJpdCwgdmFsdWUgPSB0cnVlKSB7CiAgY29uc3QgbiA9IGJ1ZmZlci5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgY29uc3Qgb2Zmc2V0ID0gYml0ICYgKG4gLSAxKQogIGNvbnN0IGkgPSAoYml0IC0gb2Zmc2V0KSAvIG4KICBjb25zdCBtYXNrID0gMSA8PCBvZmZzZXQKCiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoKGJ1ZmZlcltpXSAmIG1hc2spICE9PSAwKSByZXR1cm4gZmFsc2UKICB9IGVsc2UgewogICAgaWYgKChidWZmZXJbaV0gJiBtYXNrKSA9PT0gMCkgcmV0dXJuIGZhbHNlCiAgfQoKICBidWZmZXJbaV0gXj0gbWFzawogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIHNldFJhbmdlIChidWZmZXIsIHN0YXJ0LCBlbmQsIHZhbHVlID0gdHJ1ZSkgewogIGNvbnN0IG4gPSBidWZmZXIuQllURVNfUEVSX0VMRU1FTlQgKiA4CgogIGxldCByZW1haW5pbmcgPSBlbmQgLSBzdGFydAogIGxldCBvZmZzZXQgPSBzdGFydCAmIChuIC0gMSkKICBsZXQgaSA9IChzdGFydCAtIG9mZnNldCkgLyBuCgogIGxldCBjaGFuZ2VkID0gZmFsc2UKCiAgd2hpbGUgKHJlbWFpbmluZyA+IDApIHsKICAgIGNvbnN0IG1hc2sgPSAoMiAqKiBNYXRoLm1pbihyZW1haW5pbmcsIG4gLSBvZmZzZXQpIC0gMSkgPDwgb2Zmc2V0CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIGlmICgoYnVmZmVyW2ldICYgbWFzaykgIT09IG1hc2spIHsKICAgICAgICBidWZmZXJbaV0gfD0gbWFzawogICAgICAgIGNoYW5nZWQgPSB0cnVlCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICgoYnVmZmVyW2ldICYgbWFzaykgIT09IDApIHsKICAgICAgICBidWZmZXJbaV0gJj0gfm1hc2sKICAgICAgICBjaGFuZ2VkID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgcmVtYWluaW5nIC09IG4gLSBvZmZzZXQKICAgIG9mZnNldCA9IDAKICAgIGkrKwogIH0KCiAgcmV0dXJuIGNoYW5nZWQKfQoKZnVuY3Rpb24gZmlsbCAoYnVmZmVyLCB2YWx1ZSwgc3RhcnQgPSAwLCBlbmQgPSBidWZmZXIuYnl0ZUxlbmd0aCAqIDgpIHsKICBjb25zdCBuID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UICogOAogIGxldCBpLCBqCgogIHsKICAgIGNvbnN0IG9mZnNldCA9IHN0YXJ0ICYgKG4gLSAxKQogICAgaSA9IChzdGFydCAtIG9mZnNldCkgLyBuCgogICAgaWYgKG9mZnNldCAhPT0gMCkgewogICAgICBjb25zdCBtYXNrID0gKDIgKiogTWF0aC5taW4obiAtIG9mZnNldCwgZW5kIC0gc3RhcnQpIC0gMSkgPDwgb2Zmc2V0CgogICAgICBpZiAodmFsdWUpIGJ1ZmZlcltpXSB8PSBtYXNrCiAgICAgIGVsc2UgYnVmZmVyW2ldICY9IH5tYXNrCgogICAgICBpKysKICAgIH0KICB9CgogIHsKICAgIGNvbnN0IG9mZnNldCA9IGVuZCAmIChuIC0gMSkKICAgIGogPSAoZW5kIC0gb2Zmc2V0KSAvIG4KCiAgICBpZiAob2Zmc2V0ICE9PSAwICYmIGogPj0gaSkgewogICAgICBjb25zdCBtYXNrID0gKDIgKiogb2Zmc2V0KSAtIDEKCiAgICAgIGlmICh2YWx1ZSkgYnVmZmVyW2pdIHw9IG1hc2sKICAgICAgZWxzZSBidWZmZXJbal0gJj0gfm1hc2sKICAgIH0KICB9CgogIHJldHVybiBidWZmZXIuZmlsbCh2YWx1ZSA/ICgyICoqIG4pIC0gMSA6IDAsIGksIGopCn0KCmZ1bmN0aW9uIHRvZ2dsZSAoYnVmZmVyLCBiaXQpIHsKICBjb25zdCBuID0gYnVmZmVyLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBjb25zdCBvZmZzZXQgPSBiaXQgJiAobiAtIDEpCiAgY29uc3QgaSA9IChiaXQgLSBvZmZzZXQpIC8gbgogIGNvbnN0IG1hc2sgPSAxIDw8IG9mZnNldAoKICBidWZmZXJbaV0gXj0gbWFzawogIHJldHVybiAoYnVmZmVyW2ldICYgbWFzaykgIT09IDAKfQoKZnVuY3Rpb24gcmVtb3ZlIChidWZmZXIsIGJpdCkgewogIHJldHVybiBzZXQoYnVmZmVyLCBiaXQsIGZhbHNlKQp9CgpmdW5jdGlvbiByZW1vdmVSYW5nZSAoYnVmZmVyLCBzdGFydCwgZW5kKSB7CiAgcmV0dXJuIHNldFJhbmdlKGJ1ZmZlciwgc3RhcnQsIGVuZCwgZmFsc2UpCn0KCmZ1bmN0aW9uIGluZGV4T2YgKGJ1ZmZlciwgdmFsdWUsIHBvc2l0aW9uID0gMCkgewogIGZvciAobGV0IGkgPSBwb3NpdGlvbiwgbiA9IGJ1ZmZlci5ieXRlTGVuZ3RoICogODsgaSA8IG47IGkrKykgewogICAgaWYgKGdldChidWZmZXIsIGkpID09PSB2YWx1ZSkgcmV0dXJuIGkKICB9CgogIHJldHVybiAtMQp9CgpmdW5jdGlvbiBsYXN0SW5kZXhPZiAoYnVmZmVyLCB2YWx1ZSwgcG9zaXRpb24gPSBidWZmZXIuYnl0ZUxlbmd0aCAqIDggLSAxKSB7CiAgZm9yIChsZXQgaSA9IHBvc2l0aW9uOyBpID49IDA7IGktLSkgewogICAgaWYgKGdldChidWZmZXIsIGkpID09PSB2YWx1ZSkgcmV0dXJuIGkKICB9CgogIHJldHVybiAtMQp9CgpmdW5jdGlvbiBvZiAoLi4uYml0cykgewogIHJldHVybiBmcm9tKGJpdHMpCn0KCmZ1bmN0aW9uIGZyb20gKGJpdHMpIHsKICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2MoYnl0ZUxlbmd0aChiaXRzLmxlbmd0aCkpCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBiaXRzLmxlbmd0aDsgaSsrKSBzZXQoYnVmZmVyLCBpLCBiaXRzW2ldKQogIHJldHVybiBidWZmZXIKfQoKZnVuY3Rpb24gKiBpdGVyYXRvciAoYnVmZmVyKSB7CiAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWZmZXIuYnl0ZUxlbmd0aCAqIDg7IGkgPCBuOyBpKyspIHlpZWxkIGdldChidWZmZXIsIGkpCn0KCm1vZHVsZS5leHBvcnRzID0gewogIGJ5dGVMZW5ndGgsCiAgZ2V0LAogIHNldCwKICBzZXRSYW5nZSwKICBmaWxsLAogIHRvZ2dsZSwKICByZW1vdmUsCiAgcmVtb3ZlUmFuZ2UsCiAgaW5kZXhPZiwKICBsYXN0SW5kZXhPZiwKICBvZiwKICBmcm9tLAogIGl0ZXJhdG9yCn0KewogICJuYW1lIjogImJpdHMtdG8tYnl0ZXMiLAogICJ2ZXJzaW9uIjogIjEuMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiRnVuY3Rpb25zIGZvciBkb2luZyBiaXQgbWFuaXB1bGF0aW9uIG9mIHR5cGVkIGFycmF5cyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iaXRzLXRvLWJ5dGVzLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JpdHMtdG8tYnl0ZXMvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iaXRzLXRvLWJ5dGVzI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4yLjMuMSIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9Cn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKY29uc3QgewogIEludml0ZSwKICBSZXNwb25zZVBheWxvYWQsCiAgSW52aXRlUmVxdWVzdCwKICBJbnZpdGVSZXNwb25zZSwKICBJbnZpdGVEYXRhLAogIEludml0ZVJlY2VpcHQsCiAgUGVyc2lzdGVkUmVxdWVzdCwKICBBdXRoRGF0YQp9ID0gcmVxdWlyZSgnLi9saWIvbWVzc2FnZXMnKQoKY29uc3QgewogIFBBSVJJTkdfUkVKRUNURUQsCiAgSU5WSVRFX1VTRUQsCiAgSU5WSVRFX0VYUElSRUQKfSA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCgpjb25zdCBbCiAgTlNfU0lHTkFUVVJFLAogIE5TX1RPS0VOLAogIE5TX0lOVklURV9JRCwKICBOU19SRVFVRVNUX0lELAogIE5TX1NFU1NJT04sCiAgTlNfU0VTU0lPTl9LRVksCiAgTlNfRU5DUllQVCwKICBOU19OT05DRQpdID0gY3J5cHRvLm5hbWVzcGFjZSgnYmxpbmQtcGFpcmluZycsIDgpCgpjbGFzcyBDYW5kaWRhdGVSZXF1ZXN0IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihpbnZpdGUsIHVzZXJEYXRhLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICBpZiAoYjRhLmlzQnVmZmVyKGludml0ZSkpIHsKICAgICAgaW52aXRlID0gYy5kZWNvZGUoSW52aXRlLCBpbnZpdGUpCiAgICB9CgogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBpbnZpdGUuZGlzY292ZXJ5S2V5CiAgICB0aGlzLnNlZWQgPSBpbnZpdGUuc2VlZAoKICAgIHRoaXMua2V5UGFpciA9IGNyeXB0by5rZXlQYWlyKHRoaXMuc2VlZCkKICAgIHRoaXMuaW52aXRlSWQgPSBkZXJpdmVJbnZpdGVJZCh0aGlzLmtleVBhaXIucHVibGljS2V5KQogICAgdGhpcy51c2VyRGF0YSA9IHVzZXJEYXRhCgogICAgdGhpcy50b2tlbiA9IGRlcml2ZVRva2VuKHRoaXMua2V5UGFpci5wdWJsaWNLZXksIHVzZXJEYXRhKQogICAgdGhpcy5zZXNzaW9uID0gb3B0cy5zZXNzaW9uIHx8IGNyZWF0ZVNlc3Npb25Ub2tlbih0aGlzLnRva2VuKQogICAgdGhpcy5pZCA9IGRlcml2ZVJlcXVlc3RJZCh0aGlzLnNlc3Npb24pCgogICAgdGhpcy5wYXlsb2FkID0gY3JlYXRlQXV0aCh0aGlzLnVzZXJEYXRhLCB0aGlzLmtleVBhaXIsIHRoaXMuc2Vzc2lvbikKCiAgICB0aGlzLl9lbmNvZGVkID0gbnVsbAoKICAgIC8vIHNldCBpbiByZXBseQogICAgdGhpcy5hdXRoID0gbnVsbAogIH0KCiAgc3RhdGljIGZyb20oYnVmKSB7CiAgICBjb25zdCBpbmZvID0gYy5kZWNvZGUoUGVyc2lzdGVkUmVxdWVzdCwgYnVmKQogICAgY29uc3QgeyBzZWVkLCBkaXNjb3ZlcnlLZXksIHVzZXJEYXRhIH0gPSBpbmZvCiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IENhbmRpZGF0ZVJlcXVlc3QoeyBkaXNjb3ZlcnlLZXksIHNlZWQgfSwgdXNlckRhdGEpCgogICAgLy8gY2xlYXIgY29tcGxldGVkIHJlcXVlc3QKICAgIGlmIChpbmZvLmtleSkgewogICAgICByZXF1ZXN0LmtleSA9IGluZm8ua2V5CiAgICAgIHJlcXVlc3QudG9rZW4gPSBudWxsCiAgICAgIHJlcXVlc3QucGF5bG9hZCA9IG51bGwKICAgIH0KCiAgICByZXR1cm4gcmVxdWVzdAogIH0KCiAgaGFuZGxlUmVzcG9uc2UocGF5bG9hZCkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihwYXlsb2FkKSkgewogICAgICBwYXlsb2FkID0gdGhpcy5fZGVjb2RlUmVzcG9uc2UocGF5bG9hZCkKICAgIH0KCiAgICB0cnkgewogICAgICB0aGlzLl9vcGVuUmVzcG9uc2UocGF5bG9hZCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLmVtaXQoJ3JlamVjdGVkJywgZXJyKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIHRoaXMuX29uQWNjZXB0KCkKCiAgICByZXR1cm4gdGhpcy5hdXRoCiAgfQoKICBfb3BlblJlc3BvbnNlKHBheWxvYWQpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlc3BvbnNlID0gb3BlblJlcGx5KAogICAgICAgIHBheWxvYWQsCiAgICAgICAgdGhpcy5wYXlsb2FkLnNlc3Npb24sCiAgICAgICAgdGhpcy5rZXlQYWlyLnB1YmxpY0tleQogICAgICApCiAgICAgIHRoaXMucmVzcG9uc2UgPSBjLmRlY29kZShSZXNwb25zZVBheWxvYWQsIHJlc3BvbnNlKQogICAgfSBjYXRjaCAoZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBkZWNyeXB0IHJlcGx5LicpCiAgICB9CgogICAgY29uc3QgeyBzdGF0dXMsIGtleSwgZW5jcnlwdGlvbktleSwgYWRkaXRpb25hbCB9ID0gdGhpcy5yZXNwb25zZQoKICAgIGlmIChzdGF0dXMgIT09IDApIHsKICAgICAgc3dpdGNoIChzdGF0dXMpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICB0aHJvdyBQQUlSSU5HX1JFSkVDVEVEKCkKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgdGhyb3cgSU5WSVRFX1VTRUQoKQoKICAgICAgICBjYXNlIDM6CiAgICAgICAgICB0aHJvdyBJTlZJVEVfRVhQSVJFRCgpCiAgICAgIH0KICAgIH0KCiAgICBpZiAoYjRhLmNvbXBhcmUoY3J5cHRvLmRpc2NvdmVyeUtleShrZXkpLCB0aGlzLmRpc2NvdmVyeUtleSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZpdGUgcmVzcG9uc2UgZG9lcyBub3QgbWF0Y2ggZGlzY292ZXJ5S2V5JykKICAgIH0KCiAgICBpZiAoCiAgICAgIGFkZGl0aW9uYWwgJiYKICAgICAgIWNyeXB0by52ZXJpZnkoCiAgICAgICAgYWRkaXRpb25hbC5kYXRhLAogICAgICAgIGFkZGl0aW9uYWwuc2lnbmF0dXJlLAogICAgICAgIHRoaXMua2V5UGFpci5wdWJsaWNLZXkKICAgICAgKQogICAgKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQWRkaXRpb25hbCBkYXRhIGZhaWxlZCB2ZXJpZmljYXRpb24nKQogICAgfQoKICAgIHRoaXMuYXV0aCA9IHsKICAgICAga2V5LAogICAgICBlbmNyeXB0aW9uS2V5LAogICAgICBkYXRhOiBhZGRpdGlvbmFsID8gYWRkaXRpb25hbC5kYXRhIDogbnVsbAogICAgfQogIH0KCiAgX29uQWNjZXB0KCkgewogICAgdGhpcy5lbWl0KCdhY2NlcHRlZCcsIHRoaXMuYXV0aCkKICAgIHRoaXMuZGVzdHJveSgpCiAgfQoKICBfZGVjb2RlUmVzcG9uc2UoYnVmKSB7CiAgICB0cnkgewogICAgICBjb25zdCB7IHBheWxvYWQgfSA9IGMuZGVjb2RlKEludml0ZVJlc3BvbnNlLCBidWYpCiAgICAgIHJldHVybiBwYXlsb2FkCiAgICB9IGNhdGNoIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZGVjb2RlIHJlc3BvbnNlLicpCiAgICB9CiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy50b2tlbiA9IG51bGwKICAgIHRoaXMucGF5bG9hZCA9IG51bGwKCiAgICB0aGlzLmVtaXQoJ2Rlc3Ryb3llZCcpCiAgfQoKICBlbmNvZGUoKSB7CiAgICBpZiAoIXRoaXMuX2VuY29kZWQpIHRoaXMuX2VuY29kZWQgPSBjLmVuY29kZShJbnZpdGVSZXF1ZXN0LCB0aGlzKQogICAgcmV0dXJuIHRoaXMuX2VuY29kZWQKICB9Cn0KCmNsYXNzIE1lbWJlclJlcXVlc3QgewogIGNvbnN0cnVjdG9yKGludml0ZUlkLCByZXF1ZXN0RGF0YSkgewogICAgdGhpcy5pbnZpdGVJZCA9IGludml0ZUlkCiAgICB0aGlzLnJlcXVlc3REYXRhID0gcmVxdWVzdERhdGEKCiAgICB0aGlzLl9vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5fY29uZmlybWVkID0gZmFsc2UKICAgIHRoaXMuX2RlbmllZCA9IGZhbHNlCgogICAgLy8gc2V0IGJ5IHRyYW5zcG9ydAogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBudWxsCgogICAgLy8gc2V0IGluIG9wZW4KICAgIHRoaXMucHVibGljS2V5ID0gbnVsbAogICAgdGhpcy51c2VyRGF0YSA9IG51bGwKICAgIHRoaXMuc2Vzc2lvbiA9IG51bGwKICAgIHRoaXMuaWQgPSBudWxsCiAgICB0aGlzLnJlY2VpcHQgPSBudWxsCgogICAgLy8gc2V0IGluIGNvbmZpcm0vcmVzcG9uZAogICAgdGhpcy5fcGF5bG9hZCA9IG51bGwKICAgIHRoaXMucmVzcG9uc2UgPSBudWxsCiAgfQoKICBzdGF0aWMgZnJvbShyZXEpIHsKICAgIGlmIChiNGEuaXNCdWZmZXIocmVxKSkgewogICAgICByZXR1cm4gTWVtYmVyUmVxdWVzdC5mcm9tKGMuZGVjb2RlKEludml0ZVJlcXVlc3QsIHJlcSkpCiAgICB9CgogICAgcmV0dXJuIG5ldyBNZW1iZXJSZXF1ZXN0KHJlcS5pbnZpdGVJZCwgcmVxLnBheWxvYWQpCiAgfQoKICBjb25maXJtKHsga2V5LCBlbmNyeXB0aW9uS2V5LCBhZGRpdGlvbmFsIH0pIHsKICAgIGlmICh0aGlzLl9jb25maXJtZWQgfHwgdGhpcy5fZGVuaWVkIHx8ICF0aGlzLl9vcGVuZWQpIHJldHVybgogICAgdGhpcy5fY29uZmlybWVkID0gdHJ1ZQoKICAgIGNvbnN0IHBheWxvYWQgPSBjLmVuY29kZShSZXNwb25zZVBheWxvYWQsIHsKICAgICAgc3RhdHVzOiAwLAogICAgICBrZXksCiAgICAgIGVuY3J5cHRpb25LZXksCiAgICAgIGFkZGl0aW9uYWwKICAgIH0pCiAgICB0aGlzLl9wYXlsb2FkID0gY3JlYXRlUmVwbHkocGF5bG9hZCwgdGhpcy5zZXNzaW9uLCB0aGlzLnB1YmxpY0tleSkKCiAgICB0aGlzLl9yZXNwb25kKCkKICB9CgogIGRlbnkoeyBzdGF0dXMgPSAxIH0gPSB7fSkgewogICAgaWYgKHRoaXMuX2NvbmZpcm1lZCB8fCB0aGlzLl9kZW5pZWQpIHJldHVybgogICAgdGhpcy5fZGVuaWVkID0gdHJ1ZQoKICAgIGlmICghc3RhdHVzKSByZXR1cm4KCiAgICBjb25zdCBwYXlsb2FkID0gYy5lbmNvZGUoUmVzcG9uc2VQYXlsb2FkLCB7CiAgICAgIHN0YXR1cywKICAgICAga2V5OiBudWxsLAogICAgICBlbmNyeXB0aW9uS2V5OiBudWxsLAogICAgICBhZGRpdGlvbmFsOiBudWxsCiAgICB9KQogICAgdGhpcy5fcGF5bG9hZCA9IGNyZWF0ZVJlcGx5KHBheWxvYWQsIHRoaXMuc2Vzc2lvbiwgdGhpcy5wdWJsaWNLZXkpCgogICAgdGhpcy5fcmVzcG9uZCgpCiAgfQoKICByZXNwb25kKCkgewogICAgcmV0dXJuIHsKICAgICAgaWQ6IHRoaXMuaWQsCiAgICAgIHBheWxvYWQ6IHRoaXMuX3BheWxvYWQKICAgIH0KICB9CgogIF9yZXNwb25kKCkgewogICAgdGhpcy5yZXNwb25zZSA9IGMuZW5jb2RlKEludml0ZVJlc3BvbnNlLCB0aGlzLnJlc3BvbmQoKSkKICB9CgogIG9wZW4ocHVibGljS2V5KSB7CiAgICBpZiAodGhpcy5fb3BlbmVkICYmIGI0YS5lcXVhbHModGhpcy5wdWJsaWNLZXksIHB1YmxpY0tleSkpCiAgICAgIHJldHVybiB0aGlzLnVzZXJEYXRhCgogICAgdHJ5IHsKICAgICAgdGhpcy5yZWNlaXB0ID0gb3BlbkF1dGgodGhpcy5yZXF1ZXN0RGF0YSwgcHVibGljS2V5KQogICAgICBjb25zdCB7IHVzZXJEYXRhLCBzZXNzaW9uIH0gPSBjLmRlY29kZShJbnZpdGVSZWNlaXB0LCB0aGlzLnJlY2VpcHQpCgogICAgICB0aGlzLnVzZXJEYXRhID0gdXNlckRhdGEKICAgICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbgogICAgICB0aGlzLnRva2VuID0gZGVyaXZlVG9rZW4ocHVibGljS2V5LCB1c2VyRGF0YSkKICAgICAgdGhpcy5pZCA9IGRlcml2ZVJlcXVlc3RJZCh0aGlzLnNlc3Npb24pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIG9wZW4gaW52aXRlIHdpdGggcHJvdmlkZWQga2V5JykKICAgIH0KCiAgICB0aGlzLnB1YmxpY0tleSA9IHB1YmxpY0tleQogICAgdGhpcy5fb3BlbmVkID0gdHJ1ZQoKICAgIHJldHVybiB0aGlzLnVzZXJEYXRhCiAgfQp9Cgptb2R1bGUuZXhwb3J0cy5DYW5kaWRhdGVSZXF1ZXN0ID0gQ2FuZGlkYXRlUmVxdWVzdAptb2R1bGUuZXhwb3J0cy5NZW1iZXJSZXF1ZXN0ID0gTWVtYmVyUmVxdWVzdAptb2R1bGUuZXhwb3J0cy5jcmVhdGVJbnZpdGUgPSBjcmVhdGVJbnZpdGUKbW9kdWxlLmV4cG9ydHMuZGVjb2RlSW52aXRlID0gZGVjb2RlSW52aXRlCm1vZHVsZS5leHBvcnRzLnZlcmlmeVJlY2VpcHQgPSB2ZXJpZnlSZWNlaXB0Cm1vZHVsZS5leHBvcnRzLmNyZWF0ZVJlY2VpcHQgPSBjcmVhdGVSZWNlaXB0Cm1vZHVsZS5leHBvcnRzLkludml0ZSA9IEludml0ZQoKZnVuY3Rpb24gY3JlYXRlUmVjZWlwdChpbnZpdGUsIHVzZXJEYXRhKSB7CiAgY29uc3QgcmVxID0gbmV3IENhbmRpZGF0ZVJlcXVlc3QoaW52aXRlLCB1c2VyRGF0YSkgLy8geW9sbywgcmVmYWN0b3IKICBjb25zdCByZWNlaXB0ID0gb3BlbkF1dGgocmVxLnBheWxvYWQsIHJlcS5rZXlQYWlyLnB1YmxpY0tleSkKICByZXR1cm4geyBpZDogZGVyaXZlSW52aXRlSWQocmVxLmtleVBhaXIucHVibGljS2V5KSwgcmVjZWlwdCB9Cn0KCmZ1bmN0aW9uIHZlcmlmeVJlY2VpcHQocmVjZWlwdCwgcHVibGljS2V5KSB7CiAgaWYgKGI0YS5pc0J1ZmZlcihyZWNlaXB0KSkgewogICAgcmVjZWlwdCA9IGMuZGVjb2RlKEludml0ZVJlY2VpcHQsIHJlY2VpcHQpCiAgfQoKICBjb25zdCB7IHNlc3Npb24sIHNpZ25hdHVyZSwgdXNlckRhdGEgfSA9IHJlY2VpcHQKICBjb25zdCBzaWduRGF0YSA9IGMuZW5jb2RlKEF1dGhEYXRhLCB7IHVzZXJEYXRhLCBzZXNzaW9uIH0pCgogIGlmICghdmVyaWZ5U2lnbmF0dXJlKHNpZ25EYXRhLCBzaWduYXR1cmUsIHB1YmxpY0tleSkpIHJldHVybiBudWxsCgogIHJldHVybiB1c2VyRGF0YQp9CgpmdW5jdGlvbiBkZXJpdmVJbnZpdGVJZChwdWJsaWNLZXkpIHsKICByZXR1cm4gY3J5cHRvLmhhc2goW05TX0lOVklURV9JRCwgcHVibGljS2V5XSkKfQoKZnVuY3Rpb24gZGVyaXZlS2V5KHB1YmxpY0tleSkgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgKICAgIHNvZGl1bS5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTCiAgKQogIHJldHVybiBjcnlwdG8uaGFzaChbTlNfRU5DUllQVCwgcHVibGljS2V5XSwgb3V0KQp9CgpmdW5jdGlvbiBkZXJpdmVOb25jZShwdWJsaWNLZXksIHNlc3Npb25Ub2tlbikgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgKICAgIHNvZGl1bS5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUwogICkKICByZXR1cm4gY3J5cHRvLmhhc2goW05TX05PTkNFLCBwdWJsaWNLZXksIHNlc3Npb25Ub2tlbl0sIG91dCkKfQoKZnVuY3Rpb24gZGVyaXZlVG9rZW4ocHVibGljS2V5LCB1c2VyRGF0YSkgewogIHJldHVybiBjcnlwdG8uaGFzaChbTlNfVE9LRU4sIHB1YmxpY0tleSwgdXNlckRhdGFdKQp9CgpmdW5jdGlvbiBjcmVhdGVTZXNzaW9uVG9rZW4odG9rZW4pIHsKICByZXR1cm4gY3J5cHRvLmhhc2goW05TX1NFU1NJT04sIHRva2VuXSkKfQoKZnVuY3Rpb24gZGVyaXZlUmVxdWVzdElkKHNlc3Npb25Ub2tlbikgewogIHJldHVybiBjcnlwdG8uaGFzaChbTlNfUkVRVUVTVF9JRCwgc2Vzc2lvblRva2VuXSkKfQoKZnVuY3Rpb24gY3JlYXRlSW52aXRlKGtleSwgb3B0cyA9IHt9KSB7CiAgY29uc3QgewogICAgZGlzY292ZXJ5S2V5ID0gY3J5cHRvLmRpc2NvdmVyeUtleShrZXkpLAogICAgZXhwaXJlcyA9IDAsCiAgICBzZWVkID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDMyKSwKICAgIHNlbnNpdGl2ZSA9IGZhbHNlLAogICAgZGF0YSwKICAgIHRlc3RJbnZpdGF0aW9uID0gZmFsc2UsCiAgICBhZGRpdGlvbmFsTm9kZXMKICB9ID0gb3B0cwoKICBjb25zdCBrZXlQYWlyID0gY3J5cHRvLmtleVBhaXIoc2VlZCkKICBjb25zdCBhZGRpdGlvbmFsID0gZGF0YQogICAgPyB7CiAgICAgICAgZGF0YSwKICAgICAgICBzaWduYXR1cmU6IGNyeXB0by5zaWduKGRhdGEsIGtleVBhaXIuc2VjcmV0S2V5KQogICAgICB9CiAgICA6IG51bGwKCiAgcmV0dXJuIHsKICAgIGlkOiBkZXJpdmVJbnZpdGVJZChrZXlQYWlyLnB1YmxpY0tleSksCiAgICBpbnZpdGU6IGMuZW5jb2RlKEludml0ZSwgewogICAgICBzZWVkLAogICAgICBkaXNjb3ZlcnlLZXksCiAgICAgIGV4cGlyZXMsCiAgICAgIHNlbnNpdGl2ZSwKICAgICAgdGVzdEludml0YXRpb24sCiAgICAgIGFkZGl0aW9uYWxOb2RlcwogICAgfSksCiAgICBzZWVkLAogICAgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwKICAgIGFkZGl0aW9uYWwsCiAgICBkaXNjb3ZlcnlLZXksCiAgICBleHBpcmVzLAogICAgc2Vuc2l0aXZlLAogICAgdGVzdEludml0YXRpb24KICB9Cn0KCmZ1bmN0aW9uIGRlY29kZUludml0ZShpbnZpdGUpIHsKICBjb25zdCBkYXRhID0gYy5kZWNvZGUoSW52aXRlLCBpbnZpdGUpCiAgcmV0dXJuIHsKICAgIGlkOiBkZXJpdmVJbnZpdGVJZChjcnlwdG8ua2V5UGFpcihkYXRhLnNlZWQpLnB1YmxpY0tleSksCiAgICAuLi5kYXRhCiAgfQp9CgpmdW5jdGlvbiBlbmNyeXB0KGRhdGEsIG5vbmNlLCBzZWNyZXRLZXkpIHsKICBjb25zdCBvdXRwdXQgPSBiNGEuYWxsb2NVbnNhZmUoCiAgICBkYXRhLmJ5dGVMZW5ndGggKyBzb2RpdW0uY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMKICApCiAgc29kaXVtLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdCgKICAgIG91dHB1dCwKICAgIGRhdGEsCiAgICBub25jZSwKICAgIG51bGwsCiAgICBub25jZSwKICAgIHNlY3JldEtleQogICkKICByZXR1cm4gb3V0cHV0Cn0KCmZ1bmN0aW9uIGRlY3J5cHQoZGF0YSwgbm9uY2UsIHNlY3JldEtleSkgewogIGNvbnN0IG91dHB1dCA9IGI0YS5hbGxvY1Vuc2FmZSgKICAgIGRhdGEuYnl0ZUxlbmd0aCAtIHNvZGl1bS5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUwogICkKICBzb2RpdW0uY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9kZWNyeXB0KAogICAgb3V0cHV0LAogICAgbnVsbCwKICAgIGRhdGEsCiAgICBub25jZSwKICAgIG5vbmNlLAogICAgc2VjcmV0S2V5CiAgKQogIHJldHVybiBvdXRwdXQKfQoKZnVuY3Rpb24gY3JlYXRlQXV0aCh1c2VyRGF0YSwgaW52aXRhdGlvbktleVBhaXIsIHNlc3Npb24pIHsKICBjb25zdCBzZWNyZXQgPSBkZXJpdmVLZXkoaW52aXRhdGlvbktleVBhaXIucHVibGljS2V5KQoKICBjb25zdCBub25jZSA9IGRlcml2ZU5vbmNlKGludml0YXRpb25LZXlQYWlyLnB1YmxpY0tleSwgc2Vzc2lvbikKICBjb25zdCBzaWduRGF0YSA9IGMuZW5jb2RlKEF1dGhEYXRhLCB7IHVzZXJEYXRhLCBzZXNzaW9uIH0pCiAgY29uc3Qgc2lnbmF0dXJlID0gY3JlYXRlU2lnbmF0dXJlKHNpZ25EYXRhLCBpbnZpdGF0aW9uS2V5UGFpci5zZWNyZXRLZXkpCgogIGNvbnN0IGludml0ZURhdGEgPSBjLmVuY29kZShJbnZpdGVEYXRhLCB7IHVzZXJEYXRhLCBzaWduYXR1cmUgfSkKICBjb25zdCBkYXRhID0gZW5jcnlwdChpbnZpdGVEYXRhLCBub25jZSwgc2VjcmV0KQoKICByZXR1cm4gewogICAgc2Vzc2lvbiwKICAgIGRhdGEKICB9Cn0KCmZ1bmN0aW9uIG9wZW5BdXRoKHBheWxvYWQsIGludml0YXRpb25LZXkpIHsKICBjb25zdCBzZWNyZXQgPSBkZXJpdmVLZXkoaW52aXRhdGlvbktleSkKCiAgY29uc3QgeyBzZXNzaW9uLCBkYXRhIH0gPSBwYXlsb2FkCgogIGNvbnN0IG5vbmNlID0gZGVyaXZlTm9uY2UoaW52aXRhdGlvbktleSwgc2Vzc2lvbikKCiAgbGV0IHBsYWludGV4dAogIHRyeSB7CiAgICBwbGFpbnRleHQgPSBkZWNyeXB0KGRhdGEsIG5vbmNlLCBzZWNyZXQpCiAgfSBjYXRjaCB7CiAgICAvLyB0b2RvIHN0cm9uZ2VyIGNoZWNrCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0RlY3J5cHRpb24gZmFpbGVkLicpCiAgfQoKICBjb25zdCB7IHVzZXJEYXRhLCBzaWduYXR1cmUgfSA9IGMuZGVjb2RlKEludml0ZURhdGEsIHBsYWludGV4dCkKICBjb25zdCByZWNlaXB0ID0geyBzZXNzaW9uLCBzaWduYXR1cmUsIHVzZXJEYXRhIH0KCiAgaWYgKCF2ZXJpZnlSZWNlaXB0KHJlY2VpcHQsIGludml0YXRpb25LZXkpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgcmVwbHknKQogIH0KCiAgcmV0dXJuIGMuZW5jb2RlKEludml0ZVJlY2VpcHQsIHsgc2Vzc2lvbiwgc2lnbmF0dXJlLCB1c2VyRGF0YSB9KQp9CgpmdW5jdGlvbiBjcmVhdGVSZXBseShwYXlsb2FkLCBzZXNzaW9uVG9rZW4sIGludml0YXRpb25LZXkpIHsKICBjb25zdCBzZXNzaW9uS2V5ID0gY3J5cHRvLmhhc2goW05TX1NFU1NJT05fS0VZLCBpbnZpdGF0aW9uS2V5LCBzZXNzaW9uVG9rZW5dKQogIGNvbnN0IHNlY3JldCA9IGRlcml2ZUtleShzZXNzaW9uS2V5KQogIGNvbnN0IG5vbmNlID0gZGVyaXZlTm9uY2Uoc2Vzc2lvbktleSwgc2Vzc2lvblRva2VuKQoKICByZXR1cm4gZW5jcnlwdChwYXlsb2FkLCBub25jZSwgc2VjcmV0KQp9CgpmdW5jdGlvbiBvcGVuUmVwbHkoZGF0YSwgc2Vzc2lvblRva2VuLCBpbnZpdGF0aW9uS2V5KSB7CiAgY29uc3Qgc2Vzc2lvbktleSA9IGNyeXB0by5oYXNoKFtOU19TRVNTSU9OX0tFWSwgaW52aXRhdGlvbktleSwgc2Vzc2lvblRva2VuXSkKICBjb25zdCBzZWNyZXQgPSBkZXJpdmVLZXkoc2Vzc2lvbktleSkKICBjb25zdCBub25jZSA9IGRlcml2ZU5vbmNlKHNlc3Npb25LZXksIHNlc3Npb25Ub2tlbikKCiAgcmV0dXJuIGRlY3J5cHQoZGF0YSwgbm9uY2UsIHNlY3JldCkKfQoKZnVuY3Rpb24gY3JlYXRlU2lnbmF0dXJlKGRhdGEsIHNlY3JldEtleSkgewogIGNvbnN0IHNpZ25hdHVyZSA9IGI0YS5hbGxvY1Vuc2FmZShzb2RpdW0uY3J5cHRvX3NpZ25fQllURVMpCiAgY29uc3QgbmFtZXNwYWNlZCA9IGI0YS5hbGxvY1Vuc2FmZSgzMiArIGRhdGEuYnl0ZUxlbmd0aCkKCiAgbmFtZXNwYWNlZC5zZXQoTlNfU0lHTkFUVVJFLCAwKQogIG5hbWVzcGFjZWQuc2V0KGRhdGEsIDMyKQoKICBzb2RpdW0uY3J5cHRvX3NpZ25fZGV0YWNoZWQoc2lnbmF0dXJlLCBuYW1lc3BhY2VkLCBzZWNyZXRLZXkpCgogIHJldHVybiBzaWduYXR1cmUKfQoKZnVuY3Rpb24gdmVyaWZ5U2lnbmF0dXJlKGRhdGEsIHNpZ25hdHVyZSwgcHVibGljS2V5KSB7CiAgY29uc3QgbmFtZXNwYWNlZCA9IGI0YS5hbGxvY1Vuc2FmZSgzMiArIGRhdGEuYnl0ZUxlbmd0aCkKCiAgbmFtZXNwYWNlZC5zZXQoTlNfU0lHTkFUVVJFLCAwKQogIG5hbWVzcGFjZWQuc2V0KGRhdGEsIDMyKQoKICByZXR1cm4gc29kaXVtLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZChzaWduYXR1cmUsIG5hbWVzcGFjZWQsIHB1YmxpY0tleSkKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFBhaXJpbmdFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3Rvcihtc2csIGNvZGUsIGZuID0gUGFpcmluZ0Vycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnUGFpcmluZ0Vycm9yJwogIH0KCiAgc3RhdGljIFBBSVJJTkdfUkVKRUNURUQobXNnID0gJ1BhaXJpbmcgd2FzIHJlamVjdGVkJykgewogICAgcmV0dXJuIG5ldyBQYWlyaW5nRXJyb3IoCiAgICAgIG1zZywKICAgICAgJ1BBSVJJTkdfUkVKRUNURUQnLAogICAgICBQYWlyaW5nRXJyb3IuUEFJUklOR19SRUpFQ1RFRAogICAgKQogIH0KCiAgc3RhdGljIElOVklURV9VU0VEKG1zZyA9ICdJbnZpdGUgaGFzIGJlZW4gdXNlZCcpIHsKICAgIHJldHVybiBuZXcgUGFpcmluZ0Vycm9yKG1zZywgJ0lOVklURV9VU0VEJywgUGFpcmluZ0Vycm9yLklOVklURV9VU0VEKQogIH0KCiAgc3RhdGljIElOVklURV9FWFBJUkVEKG1zZyA9ICdJbnZpdGUgaGFzIGV4cGlyZWRzJykgewogICAgcmV0dXJuIG5ldyBQYWlyaW5nRXJyb3IobXNnLCAnSU5WSVRFX0VYUElSRUQnLCBQYWlyaW5nRXJyb3IuSU5WSVRFX0VYUElSRUQpCiAgfQp9CmNvbnN0IHsgaXNCb2dvbiB9ID0gcmVxdWlyZSgnYm9nb24nKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgpjb25zdCBESFROb2RlcyA9IGMuYXJyYXkoYy5pcHY0QWRkcmVzcykKCmNvbnN0IEludml0ZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGkpIHsKICAgIHN0YXRlLmVuZCsrIC8vIHZlcnNpb24KICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBpLnNlZWQpCiAgICBpZiAoaS5kaXNjb3ZlcnlLZXkpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIGkuZGlzY292ZXJ5S2V5KQogICAgaWYgKGkuZXhwaXJlcykgYy51aW50MzIucHJlZW5jb2RlKHN0YXRlLCBNYXRoLmZsb29yKGkuZXhwaXJlcyAvIDEwMDApKSAvLyBzdG9yZSBhcyBzZWNzCiAgICBpZiAoaS5hZGRpdGlvbmFsTm9kZXMgJiYgQXJyYXkuaXNBcnJheShpLmFkZGl0aW9uYWxOb2RlcykpCiAgICAgIERIVE5vZGVzLnByZWVuY29kZSgKICAgICAgICBzdGF0ZSwKICAgICAgICBpLmFkZGl0aW9uYWxOb2Rlcy5maWx0ZXIoKG5vZGUpID0+ICFpc0JvZ29uKG5vZGUuaG9zdCkpCiAgICAgICkKICB9LAogIGVuY29kZShzdGF0ZSwgaSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkgLy8gdmVyc2lvbgogICAgYy51aW50LmVuY29kZSgKICAgICAgc3RhdGUsCiAgICAgIChpLmRpc2NvdmVyeUtleSA/IDEgOiAwKSB8CiAgICAgICAgKGkuZXhwaXJlcyA/IDIgOiAwKSB8CiAgICAgICAgKGkuc2Vuc2l0aXZlID8gNCA6IDApIHwKICAgICAgICAoaS50ZXN0SW52aXRhdGlvbiA/IDggOiAwKSB8CiAgICAgICAgKGkuYWRkaXRpb25hbE5vZGVzICYmIEFycmF5LmlzQXJyYXkoaS5hZGRpdGlvbmFsTm9kZXMpID8gMTYgOiAwKQogICAgKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgaS5zZWVkKQogICAgaWYgKGkuZGlzY292ZXJ5S2V5KSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBpLmRpc2NvdmVyeUtleSkKICAgIGlmIChpLmV4cGlyZXMpIGMudWludDMyLmVuY29kZShzdGF0ZSwgTWF0aC5mbG9vcihpLmV4cGlyZXMgLyAxMDAwKSkKICAgIGlmIChpLmFkZGl0aW9uYWxOb2RlcyAmJiBBcnJheS5pc0FycmF5KGkuYWRkaXRpb25hbE5vZGVzKSkKICAgICAgREhUTm9kZXMuZW5jb2RlKAogICAgICAgIHN0YXRlLAogICAgICAgIGkuYWRkaXRpb25hbE5vZGVzLmZpbHRlcigobm9kZSkgPT4gIWlzQm9nb24obm9kZS5ob3N0KSkKICAgICAgKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGlmICh2ZXJzaW9uICE9PSAxKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBpbnZpdGUgdmVyc2lvbicpCiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHNlZWQ6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBkaXNjb3ZlcnlLZXk6IGZsYWdzICYgMSA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZXhwaXJlczogZmxhZ3MgJiAyID8gYy51aW50MzIuZGVjb2RlKHN0YXRlKSAqIDEwMDAgOiAwLAogICAgICBzZW5zaXRpdmU6IChmbGFncyAmIDQpICE9PSAwLAogICAgICB0ZXN0SW52aXRhdGlvbjogKGZsYWdzICYgOCkgIT09IDAsCiAgICAgIGFkZGl0aW9uYWxOb2RlczogZmxhZ3MgJiAxNiA/IERIVE5vZGVzLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBSZXF1ZXN0UGF5bG9hZCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHApIHsKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgcC5zZXNzaW9uKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBwLmRhdGEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHApIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgcC5zZXNzaW9uKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBwLmRhdGEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNlc3Npb246IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIGRhdGE6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IFJlc3BvbnNlU3RhdHVzID0gYy51aW50Cgpjb25zdCBBZGRpdGlvbmFsRGF0YSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5kYXRhKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5kYXRhKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGRhdGE6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IFJlc3BvbnNlUGF5bG9hZCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHApIHsKICAgIFJlc3BvbnNlU3RhdHVzLnByZWVuY29kZShzdGF0ZSwgcC5zdGF0dXMpCiAgICBpZiAocC5zdGF0dXMgIT09IDApIHJldHVybgoKICAgIGxldCBmbGFncyA9IDAKICAgIGlmIChwLmVuY3J5cHRpb25LZXkpIGZsYWdzIHw9IDEKICAgIGlmIChwLmFkZGl0aW9uYWwpIGZsYWdzIHw9IDIKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGZsYWdzKSAvLyBmbGFncwoKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIHAua2V5KQogICAgaWYgKHAuZW5jcnlwdGlvbktleSkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgcC5lbmNyeXB0aW9uS2V5KQogICAgaWYgKHAuYWRkaXRpb25hbCkgQWRkaXRpb25hbERhdGEucHJlZW5jb2RlKHN0YXRlLCBwLmFkZGl0aW9uYWwpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHApIHsKICAgIFJlc3BvbnNlU3RhdHVzLmVuY29kZShzdGF0ZSwgcC5zdGF0dXMpCiAgICBpZiAocC5zdGF0dXMgIT09IDApIHJldHVybgoKICAgIGxldCBmbGFncyA9IDAKICAgIGlmIChwLmVuY3J5cHRpb25LZXkpIGZsYWdzIHw9IDEKICAgIGlmIChwLmFkZGl0aW9uYWwpIGZsYWdzIHw9IDIKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHAua2V5KQogICAgaWYgKHAuZW5jcnlwdGlvbktleSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgcC5lbmNyeXB0aW9uS2V5KQogICAgaWYgKHAuYWRkaXRpb25hbCkgQWRkaXRpb25hbERhdGEuZW5jb2RlKHN0YXRlLCBwLmFkZGl0aW9uYWwpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHN0YXR1cyA9IFJlc3BvbnNlU3RhdHVzLmRlY29kZShzdGF0ZSkKCiAgICBpZiAoc3RhdHVzICE9PSAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc3RhdHVzLAogICAgICAgIGtleTogbnVsbCwKICAgICAgICBlbmNyeXB0aW9uS2V5OiBudWxsLAogICAgICAgIGFkZGl0aW9uYWw6IG51bGwKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGtleSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBlbmNyeXB0aW9uS2V5ID0gKGZsYWdzICYgMSkgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIGNvbnN0IGFkZGl0aW9uYWwgPSAoZmxhZ3MgJiAyKSAhPT0gMCA/IEFkZGl0aW9uYWxEYXRhLmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgcmV0dXJuIHsKICAgICAgc3RhdHVzOiAwLAogICAgICBrZXksCiAgICAgIGVuY3J5cHRpb25LZXksCiAgICAgIGFkZGl0aW9uYWwKICAgIH0KICB9Cn0KCmNvbnN0IEludml0ZVJlcXVlc3QgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBpKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBpLmludml0ZUlkKQogICAgUmVxdWVzdFBheWxvYWQucHJlZW5jb2RlKHN0YXRlLCBpLnBheWxvYWQpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGkpIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGkuaW52aXRlSWQpCiAgICBSZXF1ZXN0UGF5bG9hZC5lbmNvZGUoc3RhdGUsIGkucGF5bG9hZCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW52aXRlSWQ6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICBwYXlsb2FkOiBSZXF1ZXN0UGF5bG9hZC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBJbnZpdGVSZXNwb25zZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGkpIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIGkuaWQpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGkucGF5bG9hZCkKICB9LAogIGVuY29kZShzdGF0ZSwgaSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgaS5pZCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgaS5wYXlsb2FkKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpZDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHBheWxvYWQ6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IEludml0ZURhdGEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBpKSB7CiAgICBjLmZpeGVkNjQucHJlZW5jb2RlKHN0YXRlLCBpLnNpZ25hdHVyZSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgaS51c2VyRGF0YSkKICB9LAogIGVuY29kZShzdGF0ZSwgaSkgewogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgaS5zaWduYXR1cmUpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGkudXNlckRhdGEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSksCiAgICAgIHVzZXJEYXRhOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBJbnZpdGVSZWNlaXB0ID0gewogIHByZWVuY29kZShzdGF0ZSwgaSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgaS5zZXNzaW9uKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgaS5zaWduYXR1cmUpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGkudXNlckRhdGEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGkpIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGkuc2Vzc2lvbikKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIGkuc2lnbmF0dXJlKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBpLnVzZXJEYXRhKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzZXNzaW9uOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgdXNlckRhdGE6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IEF1dGhEYXRhID0gewogIHByZWVuY29kZShzdGF0ZSwgaSkgewogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBpLnNlc3Npb24pCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGkudXNlckRhdGEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGkpIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgaS5zZXNzaW9uKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBpLnVzZXJEYXRhKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzZXNzaW9uOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICB1c2VyRGF0YTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgSW52aXRlLAogIFJlc3BvbnNlUGF5bG9hZCwKICBJbnZpdGVSZXF1ZXN0LAogIEludml0ZVJlc3BvbnNlLAogIEludml0ZURhdGEsCiAgSW52aXRlUmVjZWlwdCwKICBBdXRoRGF0YQp9CnsKICAibmFtZSI6ICJibGluZC1wYWlyaW5nLWNvcmUiLAogICJ2ZXJzaW9uIjogIjIuMTAuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNvcmUgYmxpbmQgcGFpcmluZyBtb2R1bGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qKi5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAuIC0td3JpdGUiLAogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIGJyaXR0bGUgdGVzdC8qLmpzIgogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1wYWlyaW5nLWNvcmUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmxpbmQtcGFpcmluZy1jb3JlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmxpbmQtcGFpcmluZy1jb3JlI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi40IiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi41LjAiLAogICAgImJvZ29uIjogIl4xLjEuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNy4wIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjQuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjEiLAogICAgInRpbnktYnVmZmVyLW1hcCI6ICJeMS4xLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMi4xIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIgogIH0KfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBYYWNoZSA9IHJlcXVpcmUoJ3hhY2hlJykKY29uc3QgeyBNZW1iZXJSZXF1ZXN0LCBDYW5kaWRhdGVSZXF1ZXN0LCBjcmVhdGVJbnZpdGUsIGRlY29kZUludml0ZSwgdmVyaWZ5UmVjZWlwdCwgSW52aXRlIH0gPSByZXF1aXJlKCdibGluZC1wYWlyaW5nLWNvcmUnKQpjb25zdCBQcm90b211eCA9IHJlcXVpcmUoJ3Byb3RvbXV4JykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBkZWJvdW5jZSA9IHJlcXVpcmUoJ2RlYm91bmNlaWZ5JykKY29uc3QgaXNPcHRpb25zID0gcmVxdWlyZSgnaXMtb3B0aW9ucycpCgpjb25zdCBbTlNfRVBIRU1FUkFMLCBOU19SRVBMWSwgTlNfRElTQ09WRVJZXSA9IGNyeXB0by5uYW1lc3BhY2UoJ2JsaW5kLXBhaXJpbmcvZGh0JywgMykKCmNvbnN0IERFRkFVTFRfUE9MTCA9IDcgKiA2MCAqIDEwMDAKY29uc3QgUEVFUl9JTlRFUlZBTCA9IDEwMDAKCmNsYXNzIFRpbWVvdXRQcm9taXNlIHsKICBjb25zdHJ1Y3RvciAobXMpIHsKICAgIHRoaXMubXMgPSBtcwogICAgdGhpcy5yZXNvbHZlID0gbnVsbAogICAgdGhpcy50aW1lb3V0ID0gbnVsbAogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQoKICAgIHRoaXMuX3Jlc29sdmVCb3VuZCA9IHRoaXMuX3Jlc29sdmUuYmluZCh0aGlzKQogICAgdGhpcy5fb250aW1lckJvdW5kID0gdGhpcy5fb250aW1lci5iaW5kKHRoaXMpCiAgfQoKICB3YWl0ICgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICBpZiAodGhpcy5yZXNvbHZlKSB0aGlzLl9yZXNvbHZlKCkKICAgIHJldHVybiBuZXcgUHJvbWlzZSh0aGlzLl9vbnRpbWVyQm91bmQpCiAgfQoKICBzdXNwZW5kICgpIHsKICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQogICAgaWYgKHRoaXMudGltZW91dCAhPT0gbnVsbCkgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dCkKICAgIHRoaXMudGltZW91dCA9IG51bGwKICB9CgogIHJlc3VtZSAoKSB7CiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICBpZiAodGhpcy5yZXNvbHZlKSB0aGlzLl9yZXNvbHZlKCkKICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCiAgICBpZiAodGhpcy5yZXNvbHZlKSB0aGlzLl9yZXNvbHZlKCkKICB9CgogIF9vbnRpbWVyIChyZXNvbHZlKSB7CiAgICB0aGlzLnJlc29sdmUgPSByZXNvbHZlCiAgICBpZiAoIXRoaXMuc3VzcGVuZGVkKSB0aGlzLnRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuX3Jlc29sdmVCb3VuZCwgdGhpcy5tcykKICB9CgogIF9yZXNvbHZlICgpIHsKICAgIGlmICh0aGlzLnRpbWVvdXQgIT09IG51bGwpIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpCgogICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMucmVzb2x2ZQogICAgdGhpcy50aW1lb3V0ID0gbnVsbAogICAgdGhpcy5yZXNvbHZlID0gbnVsbAoKICAgIHJlc29sdmUoKQogIH0KfQoKY2xhc3MgQmxpbmRQYWlyaW5nIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IgKHN3YXJtLCB7IHBvbGwgPSBERUZBVUxUX1BPTEwsIG9uaW5jb21pbmcgPSBub29wIH0gPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuc3dhcm0gPSBzd2FybQogICAgdGhpcy5wb2xsID0gcG9sbAogICAgdGhpcy5hY3RpdmUgPSBuZXcgTWFwKCkKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKCiAgICB0aGlzLl9vbmluY29taW5nID0gb25pbmNvbWluZwogICAgdGhpcy5fb25jb25uZWN0aW9uQm91bmQgPSB0aGlzLl9vbmNvbm5lY3Rpb24uYmluZCh0aGlzKQogICAgdGhpcy5fcmVmcmVzaEJvdW5kID0gdGhpcy5yZWZyZXNoLmJpbmQodGhpcykKICAgIHRoaXMuX3JlZnJlc2hpbmcgPSBudWxsCgogICAgdGhpcy5zd2FybS5vbignY29ubmVjdGlvbicsIHRoaXMuX29uY29ubmVjdGlvbkJvdW5kKQogICAgdGhpcy5zd2FybS5kaHQub24oJ25ldHdvcmstY2hhbmdlJywgdGhpcy5fcmVmcmVzaEJvdW5kKQogIH0KCiAgc3RhdGljIEludml0ZSA9IEludml0ZQoKICBzdGF0aWMgY3JlYXRlSW52aXRlIChrZXksIG9wdHMpIHsKICAgIHJldHVybiBjcmVhdGVJbnZpdGUoa2V5LCBvcHRzKQogIH0KCiAgc3RhdGljIGRlY29kZUludml0ZSAoaW52aXRlKSB7CiAgICByZXR1cm4gZGVjb2RlSW52aXRlKGludml0ZSkKICB9CgogIHN0YXRpYyB2ZXJpZnlSZWNlaXB0IChyZWNlaXB0LCBwdWJsaWNLZXkpIHsKICAgIHJldHVybiB2ZXJpZnlSZWNlaXB0KHJlY2VpcHQsIHB1YmxpY0tleSkKICB9CgogIHN0YXRpYyBjcmVhdGVSZXF1ZXN0IChpbnZpdGUsIHVzZXJEYXRhKSB7CiAgICByZXR1cm4gbmV3IENhbmRpZGF0ZVJlcXVlc3QoaW52aXRlLCB1c2VyRGF0YSkKICB9CgogIGFzeW5jIHN1c3BlbmQgKCkgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQoKICAgIGNvbnN0IGFsbCA9IFtdCgogICAgZm9yIChjb25zdCByZWYgb2YgdGhpcy5hY3RpdmUudmFsdWVzKCkpIHsKICAgICAgaWYgKHJlZi5jYW5kaWRhdGUpIGFsbC5wdXNoKHJlZi5jYW5kaWRhdGUuX3N1c3BlbmQoKSkKICAgICAgaWYgKHJlZi5tZW1iZXIpIGFsbC5wdXNoKHJlZi5tZW1iZXIuX3N1c3BlbmQoKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoYWxsKQogIH0KCiAgcmVzdW1lICgpIHsKICAgIGlmICghdGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5yZWZyZXNoKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpIC8vIG5vIG5lZWQgdG8gd2FpdCBmb3IgdGhlIHJlZnJlc2hlcwogIH0KCiAgYXN5bmMgcmVmcmVzaCAoKSB7CiAgICBpZiAodGhpcy5fcmVmcmVzaGluZykgewogICAgICBhd2FpdCB0aGlzLl9yZWZyZXNoaW5nCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLmNsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIGNvbnN0IHIgPSB0aGlzLl9yZWZyZXNoaW5nID0gdGhpcy5fcmVmcmVzaCgpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgcgogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKHIgPT09IHRoaXMuX3JlZnJlc2hpbmcpIHRoaXMuX3JlZnJlc2hpbmcgPSBudWxsCiAgICB9CiAgfQoKICBhc3luYyBfcmVmcmVzaCAoKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICBjb25zdCBhbGwgPSBbXQoKICAgIGZvciAoY29uc3QgcmVmIG9mIHRoaXMuYWN0aXZlLnZhbHVlcygpKSB7CiAgICAgIGlmIChyZWYuY2FuZGlkYXRlKSBhbGwucHVzaChyZWYuY2FuZGlkYXRlLnJlZnJlc2goKSkKICAgICAgaWYgKHJlZi5tZW1iZXIpIGFsbC5wdXNoKHJlZi5tZW1iZXIucmVmcmVzaCgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChhbGwpCiAgfQoKICBhZGRNZW1iZXIgKG9wdHMpIHsKICAgIHJldHVybiBuZXcgTWVtYmVyKHRoaXMsIG9wdHMpCiAgfQoKICBhZGRDYW5kaWRhdGUgKHJlcXVlc3QsIG9wdHMpIHsKICAgIGlmIChpc09wdGlvbnMocmVxdWVzdCkpIHJldHVybiB0aGlzLmFkZENhbmRpZGF0ZShudWxsLCByZXF1ZXN0KQogICAgaWYgKCFyZXF1ZXN0KSByZXF1ZXN0ID0gbmV3IENhbmRpZGF0ZVJlcXVlc3Qob3B0cy5pbnZpdGUsIG9wdHMudXNlckRhdGEpCiAgICByZXR1cm4gbmV3IENhbmRpZGF0ZSh0aGlzLCByZXF1ZXN0LCBvcHRzKQogIH0KCiAgYXN5bmMgX2Nsb3NlICgpIHsKICAgIHRoaXMuc3dhcm0ucmVtb3ZlTGlzdGVuZXIoJ2Nvbm5lY3Rpb24nLCB0aGlzLl9vbmNvbm5lY3Rpb25Cb3VuZCkKICAgIHRoaXMuc3dhcm0uZGh0LnJlbW92ZUxpc3RlbmVyKCduZXR3b3JrLWNoYW5nZScsIHRoaXMuX3JlZnJlc2hCb3VuZCkKCiAgICBjb25zdCBhbGwgPSBbXQoKICAgIGZvciAoY29uc3QgY29ubiBvZiB0aGlzLnN3YXJtLmNvbm5lY3Rpb25zKSB7CiAgICAgIGNvbnN0IG11eCA9IGdldE11eGVyKGNvbm4pCiAgICAgIG11eC51bnBhaXIoeyBwcm90b2NvbDogJ2JsaW5kLXBhaXJpbmcnIH0pCiAgICAgIGZvciAoY29uc3QgcmVmIG9mIHRoaXMuYWN0aXZlLnZhbHVlcygpKSBtdXgudW5wYWlyKHsgcHJvdG9jb2w6ICdibGluZC1wYWlyaW5nJywgaWQ6IHJlZi5kaXNjb3ZlcnlLZXkgfSkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHJlZiBvZiB0aGlzLmFjdGl2ZS52YWx1ZXMoKSkgewogICAgICBpZiAocmVmLm1lbWJlcikgYWxsLnB1c2gocmVmLm1lbWJlci5jbG9zZSgpKQogICAgICBpZiAocmVmLmNhbmRpZGF0ZSkgYWxsLnB1c2gocmVmLmNhbmRpZGF0ZS5jbG9zZSgpKQogICAgICBpZiAocmVmLmRpc2NvdmVyeSkgYWxsLnB1c2gocmVmLmRpc2NvdmVyeS5kZXN0cm95KCkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGFsbCkKICB9CgogIF9yYW5kb21Qb2xsICgpIHsKICAgIHJldHVybiByYW5kb21JbnRlcnZhbCh0aGlzLnBvbGwpCiAgfQoKICBfYWRkIChkaXNjb3ZlcnlLZXkpIHsKICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKGRpc2NvdmVyeUtleSwgJ2hleCcpCiAgICBjb25zdCB0ID0gdGhpcy5hY3RpdmUuZ2V0KGlkKQogICAgaWYgKHQpIHJldHVybiB0CgogICAgY29uc3QgZnJlc2ggPSB7CiAgICAgIGlkLAogICAgICBkaXNjb3ZlcnlLZXksCiAgICAgIG1lbWJlcjogbnVsbCwKICAgICAgY2FuZGlkYXRlOiBudWxsLAogICAgICBjaGFubmVsczogbmV3IFNldCgpLAogICAgICBhbHdheXNTZXJ2ZXI6IGZhbHNlLAogICAgICBhbHdheXNDbGllbnQ6IGZhbHNlLAogICAgICBkaXNjb3Zlcnk6IG51bGwKICAgIH0KCiAgICB0aGlzLmFjdGl2ZS5zZXQoaWQsIGZyZXNoKQogICAgcmV0dXJuIGZyZXNoCiAgfQoKICBfc3dhcm0gKHJlZikgewogICAgY29uc3Qgc2VydmVyID0gcmVmLmFsd2F5c1NlcnZlciB8fCAhIXJlZi5tZW1iZXIKICAgIGNvbnN0IGNsaWVudCA9IHJlZi5hbHdheXNDbGllbnQgfHwgISFyZWYuY2FuZGlkYXRlCgogICAgaWYgKHJlZi5kaXNjb3ZlcnkgJiYgcmVmLmRpc2NvdmVyeS5pc1NlcnZlciA9PT0gc2VydmVyICYmIHJlZi5kaXNjb3ZlcnkuaXNDbGllbnQgPT09IGNsaWVudCkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocmVmLmRpc2NvdmVyeSkgcmVmLmRpc2NvdmVyeS5kZXN0cm95KCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCgogICAgLy8ganVzdCBhIHNhbml0eSBjaGVjaywgbm90IG5lZWRlZCBidXQgZG9lc250IGh1cnQKICAgIGlmICghc2VydmVyICYmICFjbGllbnQpIHJldHVybgoKICAgIHJlZi5kaXNjb3ZlcnkgPSB0aGlzLnN3YXJtLmpvaW4ocmVmLmRpc2NvdmVyeUtleSwgeyBzZXJ2ZXIsIGNsaWVudCB9KQogICAgdGhpcy5fYXR0YWNoVG9Td2FybShyZWYpCiAgfQoKICBfYXR0YWNoVG9Td2FybSAocmVmKSB7CiAgICBmb3IgKGNvbnN0IGNvbm4gb2YgdGhpcy5zd2FybS5jb25uZWN0aW9ucykgewogICAgICBjb25zdCBtdXggPSBnZXRNdXhlcihjb25uKQogICAgICB0aGlzLl9hdHRhY2hUb011eGVyKG11eCwgcmVmLmRpc2NvdmVyeUtleSwgcmVmKQogICAgfQogIH0KCiAgX2djIChyZWYpIHsKICAgIGlmIChyZWYubWVtYmVyIHx8IHJlZi5jYW5kaWRhdGUpIHsKICAgICAgaWYgKHJlZi5kaXNjb3ZlcnkpIHRoaXMuX3N3YXJtKHJlZikgLy8gaW4gY2FzZSBpdCBuZWVkcyB1cGRhdGluZy4uLgogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIHRoaXMuYWN0aXZlLmRlbGV0ZShyZWYuaWQpCiAgICBmb3IgKGNvbnN0IGNoIG9mIHJlZi5jaGFubmVscykgY2guY2xvc2UoKQogICAgZm9yIChjb25zdCBjb25uIG9mIHRoaXMuc3dhcm0uY29ubmVjdGlvbnMpIHsKICAgICAgY29uc3QgbXV4ID0gZ2V0TXV4ZXIoY29ubikKICAgICAgbXV4LnVucGFpcih7IHByb3RvY29sOiAnYmxpbmQtcGFpcmluZycsIGlkOiByZWYuZGlzY292ZXJ5S2V5IH0pCiAgICB9CiAgICBpZiAocmVmLmRpc2NvdmVyeSkgcmVmLmRpc2NvdmVyeS5kZXN0cm95KCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX29uY29ubmVjdGlvbiAoY29ubikgewogICAgY29uc3QgbXV4ID0gZ2V0TXV4ZXIoY29ubikKCiAgICBtdXgucGFpcih7IHByb3RvY29sOiAnYmxpbmQtcGFpcmluZycgfSwgdGhpcy5fb25pbmNvbWluZykKCiAgICBmb3IgKGNvbnN0IHJlZiBvZiB0aGlzLmFjdGl2ZS52YWx1ZXMoKSkgewogICAgICB0aGlzLl9hdHRhY2hUb011eGVyKG11eCwgcmVmLmRpc2NvdmVyeUtleSwgcmVmKQogICAgfQogIH0KCiAgX2F0dGFjaFRvTXV4ZXIgKG11eCwgZGlzY292ZXJ5S2V5LCByZWYpIHsKICAgIGlmICghcmVmKSByZWYgPSB0aGlzLl9hZGQoZGlzY292ZXJ5S2V5KQoKICAgIGNvbnN0IGNoID0gbXV4LmNyZWF0ZUNoYW5uZWwoewogICAgICBwcm90b2NvbDogJ2JsaW5kLXBhaXJpbmcnLAogICAgICBpZDogZGlzY292ZXJ5S2V5LAogICAgICBtZXNzYWdlczogWwogICAgICAgIHsgZW5jb2Rpbmc6IGMuYnVmZmVyLCBvbm1lc3NhZ2U6IChyZXEpID0+IHRoaXMuX29ucGFpcmluZ3JlcXVlc3QoY2gsIHJlZiwgcmVxKSB9LAogICAgICAgIHsgZW5jb2Rpbmc6IGMuYnVmZmVyLCBvbm1lc3NhZ2U6IChyZXMpID0+IHRoaXMuX29ucGFpcmluZ3Jlc3BvbnNlKGNoLCByZWYsIHJlcykgfQogICAgICBdLAogICAgICBvbmNsb3NlOiAoKSA9PiB7CiAgICAgICAgcmVmLmNoYW5uZWxzLmRlbGV0ZShjaCkKICAgICAgICBpZiAocmVmLmNhbmRpZGF0ZSkgcmVmLmNhbmRpZGF0ZS52aXNpdGVkLmRlbGV0ZShjaCkKICAgICAgfQogICAgfSkKCiAgICBpZiAoY2ggPT09IG51bGwpIHJldHVybgoKICAgIGNoLm9wZW4oKQogICAgbXV4LnBhaXIoeyBwcm90b2NvbDogJ2JsaW5kLXBhaXJpbmcnLCBpZDogZGlzY292ZXJ5S2V5IH0sICgpID0+IHRoaXMuX2F0dGFjaFRvTXV4ZXIobXV4LCBkaXNjb3ZlcnlLZXksIG51bGwpKQogICAgcmVmLmNoYW5uZWxzLmFkZChjaCkKCiAgICBpZiAocmVmLmNhbmRpZGF0ZSkgcmVmLmNhbmRpZGF0ZS5icm9hZGNhc3QoKQogIH0KCiAgYXN5bmMgX29ucGFpcmluZ3JlcXVlc3QgKGNoLCByZWYsIHJlcSkgewogICAgaWYgKCFyZWYubWVtYmVyKSByZXR1cm4KCiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgcmVmLm1lbWJlci5fYWRkUmVxdWVzdChyZXEpCiAgICBpZiAoIXJlcXVlc3QpIHJldHVybgoKICAgIGNoLm1lc3NhZ2VzWzFdLnNlbmQocmVxdWVzdC5yZXNwb25zZSkKICB9CgogIGFzeW5jIF9vbnBhaXJpbmdyZXNwb25zZSAoY2gsIHJlZiwgcmVzKSB7CiAgICBpZiAoIXJlZi5jYW5kaWRhdGUpIHJldHVybgoKICAgIGF3YWl0IHJlZi5jYW5kaWRhdGUuX2FkZFJlc3BvbnNlKHJlcywgZmFsc2UpCiAgfQp9CgpjbGFzcyBNZW1iZXIgZXh0ZW5kcyBSZWFkeVJlc291cmNlIHsKICBjb25zdHJ1Y3RvciAoYmxpbmQsIHsgYW5ub3VuY2UgPSB0cnVlLCBkaXNjb3ZlcnlLZXksIG9uYWRkID0gbm9vcCB9ID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICBpZiAoIWRpc2NvdmVyeUtleSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgcHJvdmlkZSBkaXNjb3ZlcnlLZXknKQogICAgfQoKICAgIGNvbnN0IHJlZiA9IGJsaW5kLl9hZGQoZGlzY292ZXJ5S2V5KQoKICAgIGlmIChyZWYubWVtYmVyKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQWN0aXZlIG1lbWJlciBhbHJlYWR5IGV4aXN0JykKICAgIH0KCiAgICByZWYubWVtYmVyID0gdGhpcwoKICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cyA9IG5ldyBNYXAoKQoKICAgIHRoaXMuYmxpbmQgPSBibGluZAogICAgdGhpcy5kaHQgPSBibGluZC5zd2FybS5kaHQKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CiAgICB0aGlzLnBhaXJpbmdEaXNjb3ZlcnlLZXkgPSBkZXJpdmVEaXNjb3ZlcnlLZXkoZGlzY292ZXJ5S2V5KQogICAgdGhpcy50aW1lb3V0ID0gbmV3IFRpbWVvdXRQcm9taXNlKGJsaW5kLl9yYW5kb21Qb2xsKCkpCiAgICB0aGlzLnBhaXJpbmcgPSBudWxsCiAgICB0aGlzLnNraXAgPSBuZXcgWGFjaGUoeyBtYXhTaXplOiA1MTIgfSkKICAgIHRoaXMucmVmID0gcmVmCiAgICB0aGlzLm9uYWRkID0gb25hZGQKCiAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKICAgIHRoaXMuX2FjdGl2ZVBvbGwgPSBudWxsCiAgICB0aGlzLl9jbG9zZXN0Tm9kZXMgPSBudWxsCiAgICB0aGlzLl9hdXRvQW5ub3VuY2UgPSBhbm5vdW5jZQoKICAgIHRoaXMucmVhZHkoKQogIH0KCiAgYW5ub3VuY2UgKCkgewogICAgaWYgKHRoaXMucGFpcmluZykgcmV0dXJuIHRoaXMucGFpcmluZwoKICAgIHRoaXMuYmxpbmQuX3N3YXJtKHRoaXMucmVmKQogICAgdGhpcy5wYWlyaW5nID0gdGhpcy5fcnVuKCkKICAgIHRoaXMucGFpcmluZy5jYXRjaChzYWZldHlDYXRjaCkKCiAgICByZXR1cm4gdGhpcy5wYWlyaW5nCiAgfQoKICBhc3luYyBmbHVzaGVkICgpIHsKICAgIGlmICghdGhpcy5yZWYuZGlzY292ZXJ5KSByZXR1cm4KICAgIHJldHVybiB0aGlzLnJlZi5kaXNjb3ZlcnkuZmx1c2hlZCgpCiAgfQoKICBfb3BlbiAoKSB7CiAgICBpZiAodGhpcy5fYXV0b0Fubm91bmNlKSB0aGlzLmFubm91bmNlKCkKICAgIGVsc2UgdGhpcy5ibGluZC5fYXR0YWNoVG9Td2FybSh0aGlzLnJlZikKICB9CgogIF9zdXNwZW5kICgpIHsKICAgIHRoaXMudGltZW91dC5zdXNwZW5kKCkKICAgIHJldHVybiB0aGlzLl9hYm9ydCgpCiAgfQoKICBhc3luYyBfYWJvcnQgKCkgewogICAgaWYgKHRoaXMuX2FjdGl2ZVF1ZXJ5KSB0aGlzLl9hY3RpdmVRdWVyeS5kZXN0cm95KCkKICAgIHdoaWxlICh0aGlzLl9hY3RpdmVQb2xsICE9PSBudWxsKSBhd2FpdCB0aGlzLl9hY3RpdmVQb2xsCiAgfQoKICBhc3luYyByZWZyZXNoICgpIHsKICAgIGF3YWl0IHRoaXMuX2Fib3J0KCkKICAgIHRoaXMudGltZW91dC5yZXN1bWUoKQogIH0KCiAgYXN5bmMgX2Nsb3NlICgpIHsKICAgIHRoaXMucmVmLm1lbWJlciA9IG51bGwKICAgIHRoaXMuYmxpbmQuX2djKHRoaXMucmVmKQogICAgdGhpcy50aW1lb3V0LmRlc3Ryb3koKQogICAgYXdhaXQgdGhpcy5fYWJvcnQoKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMucGFpcmluZwogICAgfSBjYXRjaCB7CiAgICAgIC8vIGlnbm9yZSBlcnJvcnMgc2luY2Ugd2UgdGVhcmRvd24KICAgIH0KICB9CgogIGFzeW5jIF9ydW4gKCkgewogICAgd2hpbGUgKCF0aGlzLmNsb3NpbmcpIHsKICAgICAgdGhpcy5fYWN0aXZlUG9sbCA9IHRoaXMuX3BvbGwoKQogICAgICBhd2FpdCB0aGlzLl9hY3RpdmVQb2xsCiAgICAgIHRoaXMuX2FjdGl2ZVBvbGwgPSBudWxsCiAgICAgIGF3YWl0IHRoaXMudGltZW91dC53YWl0KCkKICAgIH0KICB9CgogIGFzeW5jIF9wb2xsICgpIHsKICAgIGNvbnN0IHZpc2l0ZWQgPSBuZXcgU2V0KCkKICAgIGxldCBhbHdheXNDbGllbnQgPSBmYWxzZQoKICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSkgdGhpcy5fYWN0aXZlUXVlcnkuZGVzdHJveSgpCgogICAgY29uc3QgcXVlcnkgPSB0aGlzLl9hY3RpdmVRdWVyeSA9IHRoaXMuZGh0Lmxvb2t1cCh0aGlzLnBhaXJpbmdEaXNjb3ZlcnlLZXksIHsgY2xvc2VzdE5vZGVzOiB0aGlzLl9jbG9zZXN0Tm9kZXMgfSkKCiAgICB0cnkgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5fYWN0aXZlUXVlcnkpIHsKICAgICAgICBpZiAodGhpcy5jbG9zaW5nIHx8IHRoaXMuYmxpbmQuc3VzcGVuZGVkKSByZXR1cm4KCiAgICAgICAgZm9yIChjb25zdCBwZWVyIG9mIGRhdGEucGVlcnMpIHsKICAgICAgICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHBlZXIucHVibGljS2V5LCAnaGV4JykKCiAgICAgICAgICBpZiAodmlzaXRlZC5oYXMoaWQpIHx8IHRoaXMuc2tpcC5nZXQoaWQpKSBjb250aW51ZQogICAgICAgICAgdmlzaXRlZC5hZGQoaWQpCgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGF3YWl0IHRoaXMuX2FkZChwZWVyLnB1YmxpY0tleSwgaWQpKSBhbHdheXNDbGllbnQgPSB0cnVlCiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0aGlzLmNsb3NpbmcgfHwgdGhpcy5ibGluZC5zdXNwZW5kZWQpIHJldHVybgoKICAgICAgICAgIGlmIChhbHdheXNDbGllbnQgJiYgIXRoaXMucmVmLmFsd2F5c0NsaWVudCkgewogICAgICAgICAgICB0aGlzLnJlZi5hbHdheXNDbGllbnQgPSB0cnVlCiAgICAgICAgICAgIHRoaXMuYmxpbmQuX3N3YXJtKHRoaXMucmVmKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGRvIG5vdGhpbmcKICAgIH0gZmluYWxseSB7CiAgICAgIGNvbnN0IG5vZGVzID0gdGhpcy5fYWN0aXZlUXVlcnkuY2xvc2VzdE5vZGVzCiAgICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSA9PT0gcXVlcnkpIHRoaXMuX2FjdGl2ZVF1ZXJ5ID0gbnVsbAogICAgICBpZiAobm9kZXMgJiYgbm9kZXMubGVuZ3RoID4gMCkgdGhpcy5fY2xvc2VzdE5vZGVzID0gbm9kZXMKICAgIH0KCiAgICBpZiAoYWx3YXlzQ2xpZW50KSB0aGlzLl9yZXZlcnRDbGllbnRBZnRlckZsdXNoKCkgLy8gc2FmZSB0byBkbyBpbiBiZwogIH0KCiAgYXN5bmMgX3JldmVydENsaWVudEFmdGVyRmx1c2ggKCkgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5ibGluZC5zd2FybS5mbHVzaCgpCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAodGhpcy5jbG9zaW5nIHx8IHRoaXMuYmxpbmQuc3VzcGVuZGVkKSByZXR1cm4KCiAgICB0aGlzLnJlZi5hbHdheXNDbGllbnQgPSBmYWxzZQogICAgdGhpcy5ibGluZC5fc3dhcm0odGhpcy5yZWYpCiAgfQoKICBhc3luYyBfYWRkUmVxdWVzdCAodmFsdWUpIHsKICAgIGxldCByZXF1ZXN0ID0gbnVsbAogICAgdHJ5IHsKICAgICAgcmVxdWVzdCA9IE1lbWJlclJlcXVlc3QuZnJvbSh2YWx1ZSkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIHJlcXVlc3QuZGlzY292ZXJ5S2V5ID0gdGhpcy5kaXNjb3ZlcnlLZXkKCiAgICBjb25zdCBzZXNzaW9uID0gYjRhLnRvU3RyaW5nKHJlcXVlc3QucmVxdWVzdERhdGEuc2Vzc2lvbiwgJ2hleCcpCgogICAgaWYgKCF0aGlzLl9wZW5kaW5nUmVxdWVzdHMuaGFzKHNlc3Npb24pKSB7CiAgICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cy5zZXQoc2Vzc2lvbiwgewogICAgICAgIHJlcXVlc3QsCiAgICAgICAgcHJvbWlzZTogdGhpcy5vbmFkZChyZXF1ZXN0KQogICAgICB9KQogICAgfQoKICAgIC8vIGxhb2QgZXhpc3RpbmcgcmVxdWVzdCBpZiBpdCBleGlzdHMKICAgIGNvbnN0IHBlbmRpbmcgPSB0aGlzLl9wZW5kaW5nUmVxdWVzdHMuZ2V0KHNlc3Npb24pCgogICAgdHJ5IHsKICAgICAgYXdhaXQgcGVuZGluZy5wcm9taXNlCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHNhZmV0eUNhdGNoKGUpCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzLmRlbGV0ZShzZXNzaW9uKQoKICAgIGlmICghcGVuZGluZy5yZXF1ZXN0LnJlc3BvbnNlKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiBwZW5kaW5nLnJlcXVlc3QKICB9CgogIGFzeW5jIF9hZGQgKHB1YmxpY0tleSwgaWQpIHsKICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRodC5tdXRhYmxlR2V0KHB1YmxpY0tleSwgeyBsYXRlc3Q6IGZhbHNlIH0pCiAgICBpZiAoIW5vZGUpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuc2tpcC5zZXQoaWQsIHRydWUpCgogICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IHRoaXMuX2FkZFJlcXVlc3Qobm9kZS52YWx1ZSkKICAgIGlmICghcmVxdWVzdCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgcmVwbHlLZXlQYWlyID0gZGVyaXZlUmVwbHlLZXlQYWlyKHJlcXVlc3QudG9rZW4pCiAgICBhd2FpdCB0aGlzLmRodC5tdXRhYmxlUHV0KHJlcGx5S2V5UGFpciwgcmVxdWVzdC5yZXNwb25zZSkKCiAgICByZXR1cm4gdHJ1ZQogIH0KfQoKY2xhc3MgQ2FuZGlkYXRlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IgKGJsaW5kLCByZXF1ZXN0LCB7IGRpc2NvdmVyeUtleSA9IHJlcXVlc3QuZGlzY292ZXJ5S2V5LCBvbmFkZCA9IG5vb3AgfSA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgY29uc3QgcmVmID0gYmxpbmQuX2FkZChkaXNjb3ZlcnlLZXkpCiAgICBpZiAocmVmLmNhbmRpZGF0ZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FjdGl2ZSBjYW5kaWRhdGUgYWxyZWFkeSBleGlzdCcpCiAgICB9CgogICAgcmVmLmNhbmRpZGF0ZSA9IHRoaXMKCiAgICB0aGlzLmJsaW5kID0gYmxpbmQKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CiAgICB0aGlzLnBhaXJpbmdEaXNjb3ZlcnlLZXkgPSBkZXJpdmVEaXNjb3ZlcnlLZXkoZGlzY292ZXJ5S2V5KQogICAgdGhpcy5kaHQgPSBibGluZC5zd2FybS5kaHQKICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3QKICAgIHRoaXMudG9rZW4gPSByZXF1ZXN0LnRva2VuCiAgICB0aGlzLnRpbWVvdXQgPSBuZXcgVGltZW91dFByb21pc2UoYmxpbmQuX3JhbmRvbVBvbGwoKSkKICAgIHRoaXMuYW5ub3VuY2VkID0gZmFsc2UKICAgIHRoaXMuZ2NpbmcgPSBudWxsCiAgICB0aGlzLnJlZiA9IHJlZgogICAgdGhpcy5wYWlyZWQgPSBudWxsCiAgICB0aGlzLnBhaXJpbmcgPSBudWxsCiAgICB0aGlzLm9uYWRkID0gb25hZGQKCiAgICB0aGlzLnNpZ25hbCA9IG51bGwKICAgIHRoaXMudmlzaXRlZCA9IG5ldyBTZXQoKQogICAgdGhpcy5icm9hZGNhc3QgPSBkZWJvdW5jZSh0aGlzLl9icm9hZGNhc3QuYmluZCh0aGlzKSkKCiAgICB0aGlzLl9hY3RpdmVQb2xsID0gbnVsbAoKICAgIHRoaXMucmVhZHkoKQogIH0KCiAgX29wZW4gKCkgewogICAgdGhpcy5ibGluZC5fc3dhcm0odGhpcy5yZWYpCiAgICB0aGlzLnBhaXJpbmcgPSB0aGlzLl9ydW4oKQogICAgdGhpcy5icm9hZGNhc3QoKQogIH0KCiAgX3N1c3BlbmQgKCkgewogICAgdGhpcy50aW1lb3V0LnN1c3BlbmQoKQogICAgLy8gbm8gZ29vZCB3YXkgdG8gc3VzcGVuZCB0aGUgbXV0IGdldHMgYXRtIHVuZm9ydHVuYXRlbHkgc28gd2UganVzdCByZWx5IG9uIHRoZSBwb2xscyB0aW1pbmcgb3V0CiAgfQoKICBhc3luYyByZWZyZXNoICgpIHsKICAgIHdoaWxlICh0aGlzLl9hY3RpdmVQb2xsICE9PSBudWxsKSBhd2FpdCB0aGlzLl9hY3RpdmVQb2xsCiAgICB0aGlzLmFubm91bmNlZCA9IGZhbHNlCiAgICB0aGlzLnRpbWVvdXQucmVzdW1lKCkKICB9CgogIGFzeW5jIF9jbG9zZSAoKSB7CiAgICB0aGlzLnJlZi5jYW5kaWRhdGUgPSBudWxsCiAgICB0aGlzLmJsaW5kLl9nYyh0aGlzLnJlZikKICAgIHRoaXMudGltZW91dC5kZXN0cm95KCkKICAgIHRoaXMudmlzaXRlZC5jbGVhcigpCiAgICBhd2FpdCB0aGlzLnBhaXJpbmcKICAgIC8vIGdjIG5ldmVyIHRocm93cwogICAgaWYgKHRoaXMuZ2NpbmcpIGF3YWl0IHRoaXMuZ2NpbmcKICB9CgogIGFzeW5jIF9hZGRSZXNwb25zZSAodmFsdWUsIGdjKSB7CiAgICBpZiAodGhpcy5wYWlyZWQpIHJldHVybgoKICAgIGNvbnN0IHBhaXJlZCA9IHRoaXMucmVxdWVzdC5oYW5kbGVSZXNwb25zZSh2YWx1ZSkKICAgIGlmICghcGFpcmVkKSByZXR1cm4KCiAgICB0aGlzLnBhaXJlZCA9IHBhaXJlZAogICAgaWYgKHRoaXMuc2lnbmFsKSB0aGlzLnNpZ25hbC5kZXN0cm95KCkKCiAgICBpZiAoKGdjIHx8IHRoaXMuYW5ub3VuY2VkKSAmJiAhdGhpcy5nY2luZykgdGhpcy5nY2luZyA9IHRoaXMuX2djKCkgLy8gZ2MgaW4gdGhlIGJhY2tncm91bmQKICAgIGF3YWl0IHRoaXMub25hZGQocGFpcmVkKQogICAgdGhpcy50aW1lb3V0LmRlc3Ryb3koKQogIH0KCiAgYXN5bmMgX3J1biAoKSB7CiAgICB3aGlsZSAoIXRoaXMuX2RvbmUoKSkgewogICAgICB0aGlzLl9hY3RpdmVQb2xsID0gdGhpcy5fcG9sbCgpCiAgICAgIGF3YWl0IHRoaXMuX2FjdGl2ZVBvbGwKICAgICAgdGhpcy5fYWN0aXZlUG9sbCA9IG51bGwKICAgICAgaWYgKHRoaXMuX2RvbmUoKSkgYnJlYWsKICAgICAgYXdhaXQgdGhpcy50aW1lb3V0LndhaXQoKQogICAgfQoKICAgIHRoaXMuY2xvc2UoKS5jYXRjaChzYWZldHlDYXRjaCkKICAgIHJldHVybiB0aGlzLnBhaXJlZAogIH0KCiAgX2RvbmUgKCkgewogICAgcmV0dXJuICEhKHRoaXMuY2xvc2luZyB8fCB0aGlzLnBhaXJlZCkKICB9CgogIGFzeW5jIF9hbm5vdW5jZSAoKSB7CiAgICBjb25zdCBlcGggPSBkZXJpdmVFcGhlbWVyYWxLZXlQYWlyKHRoaXMudG9rZW4pCgogICAgYXdhaXQgdGhpcy5kaHQubXV0YWJsZVB1dChlcGgsIHRoaXMucmVxdWVzdC5lbmNvZGUoKSkKICAgIGlmICh0aGlzLl9kb25lKCkpIHJldHVybgoKICAgIGF3YWl0IHRoaXMuZGh0LmFubm91bmNlKHRoaXMucGFpcmluZ0Rpc2NvdmVyeUtleSwgZXBoKS5maW5pc2hlZCgpCiAgICBpZiAodGhpcy5fZG9uZSgpKSByZXR1cm4KCiAgICBpZiAoIXRoaXMucGFpcmVkKSB7CiAgICAgIHRoaXMucmVmLmFsd2F5c1NlcnZlciA9IHRydWUKICAgICAgdGhpcy5ibGluZC5fc3dhcm0odGhpcy5yZWYpCiAgICB9CgogICAgdGhpcy5lbWl0KCdhbm5vdW5jZScpCiAgfQoKICBhc3luYyBfZ2MgKCkgewogICAgY29uc3QgZXBoID0gZGVyaXZlRXBoZW1lcmFsS2V5UGFpcih0aGlzLnRva2VuKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuZGh0LnVuYW5ub3VuY2UodGhpcy5wYWlyaW5nRGlzY292ZXJ5S2V5LCBlcGgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKSAvLyBqdXN0IGdjLCB3aGF0ZXZzCiAgICB9CiAgfQoKICBfc2VuZFJlcXVlc3QgKGNoKSB7CiAgICBjaC5tZXNzYWdlc1swXS5zZW5kKHRoaXMucmVxdWVzdC5lbmNvZGUoKSkKICAgIHRoaXMudmlzaXRlZC5hZGQoY2gpCiAgfQoKICBhc3luYyBfYnJvYWRjYXN0ICgpIHsKICAgIGZvciAoY29uc3QgY2hhbm5lbCBvZiB0aGlzLmNsb3Nlc3RQZWVycygpKSB7CiAgICAgIHRoaXMuc2lnbmFsID0gbmV3IFRpbWVvdXRQcm9taXNlKHJhbmRvbUludGVydmFsKFBFRVJfSU5URVJWQUwpKQogICAgICBpZiAoY2hhbm5lbCkgdGhpcy5fc2VuZFJlcXVlc3QoY2hhbm5lbCkKCiAgICAgIGF3YWl0IHRoaXMuc2lnbmFsLndhaXQoKSAvLyByZXNvbHZlcyBvbiBkZXN0cm95CgogICAgICBpZiAodGhpcy5wYWlyZWQgfHwgdGhpcy5zdXNwZW5kZWQpIGJyZWFrCiAgICB9CiAgfQoKICAqIGNsb3Nlc3RQZWVycyAoKSB7CiAgICB3aGlsZSAoIXRoaXMucGFpcmVkKSB7CiAgICAgIGNvbnN0IGNsb3Nlc3QgPSBJbmZpbml0eQogICAgICBsZXQgY2hhbm5lbCA9IG51bGwKCiAgICAgIGZvciAoY29uc3QgY2ggb2YgdGhpcy5yZWYuY2hhbm5lbHMpIHsKICAgICAgICBpZiAodGhpcy52aXNpdGVkLmhhcyhjaCkpIGNvbnRpbnVlCgogICAgICAgIGNvbnN0IHsgcnR0IH0gPSBjaC5fbXV4LnN0cmVhbS5yYXdTdHJlYW0KICAgICAgICBpZiAocnR0IDwgY2xvc2VzdCkgY2hhbm5lbCA9IGNoCiAgICAgIH0KCiAgICAgIGlmICghY2hhbm5lbCkgcmV0dXJuCgogICAgICB5aWVsZCBjaGFubmVsCiAgICB9CiAgfQoKICBhc3luYyBfcG9sbCAoKSB7CiAgICB0cnkgewogICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuX2dldFJlcGx5KCkKICAgICAgaWYgKHRoaXMuX2RvbmUoKSB8fCB0aGlzLmJsaW5kLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgICBpZiAodmFsdWUpIHsKICAgICAgICBhd2FpdCB0aGlzLl9hZGRSZXNwb25zZSh2YWx1ZSwgdHJ1ZSkKICAgICAgICBpZiAodGhpcy5fZG9uZSgpIHx8IHRoaXMuYmxpbmQuc3VzcGVuZGVkKSByZXR1cm4KICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmFubm91bmNlZCkgewogICAgICAgIHRoaXMuYW5ub3VuY2VkID0gdHJ1ZQogICAgICAgIGF3YWl0IHRoaXMuX2Fubm91bmNlKCkKICAgICAgfQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGNhbiBydW4gaW4gYmcsIHNob3VsZCBuZXZlciBjcmFzaCBpdAogICAgfQogIH0KCiAgYXN5bmMgX2dldFJlcGx5ICgpIHsKICAgIGNvbnN0IHsgcHVibGljS2V5IH0gPSBkZXJpdmVSZXBseUtleVBhaXIodGhpcy50b2tlbikKICAgIGNvbnN0IG5vZGUgPSBhd2FpdCB0aGlzLmRodC5tdXRhYmxlR2V0KHB1YmxpY0tleSwgeyBsYXRlc3Q6IGZhbHNlIH0pCiAgICBpZiAoIW5vZGUpIHJldHVybiBudWxsCiAgICByZXR1cm4gbm9kZS52YWx1ZQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBCbGluZFBhaXJpbmcKCmZ1bmN0aW9uIG5vb3AgKCkge30KCmZ1bmN0aW9uIGRlcml2ZVJlcGx5S2V5UGFpciAodG9rZW4pIHsKICByZXR1cm4gY3J5cHRvLmtleVBhaXIoY3J5cHRvLmhhc2goW05TX1JFUExZLCB0b2tlbl0pKQp9CgpmdW5jdGlvbiBkZXJpdmVFcGhlbWVyYWxLZXlQYWlyICh0b2tlbikgewogIHJldHVybiBjcnlwdG8ua2V5UGFpcihjcnlwdG8uaGFzaChbTlNfRVBIRU1FUkFMLCB0b2tlbl0pKQp9CgpmdW5jdGlvbiBkZXJpdmVEaXNjb3ZlcnlLZXkgKGRpc2NvdmVyeUtleSkgewogIHJldHVybiBjcnlwdG8uaGFzaChbTlNfRElTQ09WRVJZLCBkaXNjb3ZlcnlLZXldKQp9CgpmdW5jdGlvbiBnZXRNdXhlciAoc3RyZWFtKSB7CiAgaWYgKHN0cmVhbS51c2VyRGF0YSkgcmV0dXJuIHN0cmVhbS51c2VyRGF0YQogIGNvbnN0IHByb3RvY29sID0gUHJvdG9tdXguZnJvbShzdHJlYW0pCiAgc3RyZWFtLnNldEtlZXBBbGl2ZSg1MDAwKQogIHN0cmVhbS51c2VyRGF0YSA9IHByb3RvY29sCiAgcmV0dXJuIHByb3RvY29sCn0KCmZ1bmN0aW9uIHJhbmRvbUludGVydmFsIChuKSB7CiAgcmV0dXJuIG4gKyAobiAqIDAuNSAqIE1hdGgucmFuZG9tKCkpIHwgMAp9CnsKICAibmFtZSI6ICJibGluZC1wYWlyaW5nIiwKICAidmVyc2lvbiI6ICIyLjMuMSIsCiAgImRlc2NyaXB0aW9uIjogIkJsaW5kIHBhaXJpbmcgdXNpbmcgSHlwZXJzd2FybSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYmxpbmQtcGFpcmluZy1jb3JlIjogIl4yLjAuMCIsCiAgICAiYjRhIjogIl4xLjYuNCIsCiAgICAiZGVib3VuY2VpZnkiOiAiXjEuMS4wIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjQuMCIsCiAgICAiaXMtb3B0aW9ucyI6ICJeMS4wLjIiLAogICAgInJlYWR5LXJlc291cmNlIjogIl4xLjAuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMiIsCiAgICAieGFjaGUiOiAiXjEuMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJAaHlwZXJzd2FybS90ZXN0bmV0IjogIl4zLjEuNCIsCiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgImh5cGVyZGh0IjogIl42LjguOSIsCiAgICAiaHlwZXJzd2FybSI6ICJeNC43LjMiLAogICAgIm1pbmltaXN0IjogIl4xLjIuOCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIsCiAgICAiejMyIjogIl4xLjAuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1wYWlyaW5nLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYyIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1wYWlyaW5nL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmxpbmQtcGFpcmluZyIKfQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBQcm90b211eCA9IHJlcXVpcmUoJ3Byb3RvbXV4JykKY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGJpdGZpZWxkID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZy1iaXRmaWVsZCcpCmNvbnN0IGJpdHMgPSByZXF1aXJlKCdiaXRzLXRvLWJ5dGVzJykKY29uc3QgZXJyb3JzID0gcmVxdWlyZSgnLi9saWIvZXJyb3JzJykKCmV4cG9ydHMuU2VydmVyID0gY2xhc3MgQmxpbmRSZWxheVNlcnZlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIGNvbnN0IHsKICAgICAgY3JlYXRlU3RyZWFtCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX2NyZWF0ZVN0cmVhbSA9IGNyZWF0ZVN0cmVhbQogICAgdGhpcy5fcGFpcmluZyA9IG5ldyBNYXAoKQogICAgdGhpcy5fc2Vzc2lvbnMgPSBuZXcgU2V0KCkKICB9CgogIGdldCBzZXNzaW9ucyAoKSB7CiAgICByZXR1cm4gdGhpcy5fc2Vzc2lvbnNbU3ltYm9sLml0ZXJhdG9yXSgpCiAgfQoKICBhY2NlcHQgKHN0cmVhbSwgb3B0cykgewogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBCbGluZFJlbGF5U2Vzc2lvbih0aGlzLCBzdHJlYW0sIG9wdHMpCgogICAgdGhpcy5fc2Vzc2lvbnMuYWRkKHNlc3Npb24pCgogICAgcmV0dXJuIHNlc3Npb24KICB9CgogIGFzeW5jIGNsb3NlICgpIHsKICAgIGNvbnN0IGVuZGluZyA9IFtdCgogICAgZm9yIChjb25zdCBzZXNzaW9uIG9mIHRoaXMuX3Nlc3Npb25zKSB7CiAgICAgIGVuZGluZy5wdXNoKHNlc3Npb24uZW5kKCkpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGwoZW5kaW5nKQoKICAgIHRoaXMuX3BhaXJpbmcuY2xlYXIoKQogIH0KfQoKY2xhc3MgQmxpbmRSZWxheVNlc3Npb24gZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yIChzZXJ2ZXIsIHN0cmVhbSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgY29uc3QgewogICAgICBpZCwKICAgICAgaGFuZHNoYWtlLAogICAgICBoYW5kc2hha2VFbmNvZGluZwogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9zZXJ2ZXIgPSBzZXJ2ZXIKICAgIHRoaXMuX211eCA9IFByb3RvbXV4LmZyb20oc3RyZWFtKQoKICAgIHRoaXMuX2NoYW5uZWwgPSB0aGlzLl9tdXguY3JlYXRlQ2hhbm5lbCh7CiAgICAgIHByb3RvY29sOiAnYmxpbmQtcmVsYXknLAogICAgICBpZCwKICAgICAgaGFuZHNoYWtlOiBoYW5kc2hha2UgPyBoYW5kc2hha2VFbmNvZGluZyB8fCBjLnJhdyA6IG51bGwsCiAgICAgIG9ub3BlbjogdGhpcy5fb25vcGVuLmJpbmQodGhpcyksCiAgICAgIG9uY2xvc2U6IHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKSwKICAgICAgb25kZXN0cm95OiB0aGlzLl9vbmRlc3Ryb3kuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl9wYWlyID0gdGhpcy5fY2hhbm5lbC5hZGRNZXNzYWdlKHsKICAgICAgZW5jb2Rpbmc6IG0ucGFpciwKICAgICAgb25tZXNzYWdlOiB0aGlzLl9vbnBhaXIuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl91bnBhaXIgPSB0aGlzLl9jaGFubmVsLmFkZE1lc3NhZ2UoewogICAgICBlbmNvZGluZzogbS51bnBhaXIsCiAgICAgIG9ubWVzc2FnZTogdGhpcy5fb251bnBhaXIuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLl9lbmRpbmcgPSBudWxsCiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5fZXJyb3IgPSBudWxsCiAgICB0aGlzLl9wYWlyaW5nID0gbmV3IFNldCgpCiAgICB0aGlzLl9zdHJlYW1zID0gbmV3IE1hcCgpCgogICAgdGhpcy5fb25lcnJvciA9IChlcnIpID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpCgogICAgdGhpcy5fY2hhbm5lbC5vcGVuKGhhbmRzaGFrZSkKICB9CgogIGdldCBjbG9zZWQgKCkgewogICAgcmV0dXJuIHRoaXMuX2NoYW5uZWwuY2xvc2VkCiAgfQoKICBnZXQgbXV4ICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXgKICB9CgogIGdldCBzdHJlYW0gKCkgewogICAgcmV0dXJuIHRoaXMuX211eC5zdHJlYW0KICB9CgogIF9vbm9wZW4gKCkgewogICAgdGhpcy5lbWl0KCdvcGVuJykKICB9CgogIF9vbmNsb3NlICgpIHsKICAgIHRoaXMuX2VuZGluZyA9IFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgZXJyID0gdGhpcy5fZXJyb3IgfHwgZXJyb3JzLkNIQU5ORUxfQ0xPU0VEKCkKCiAgICBmb3IgKGNvbnN0IHRva2VuIG9mIHRoaXMuX3BhaXJpbmcpIHsKICAgICAgdGhpcy5fc2VydmVyLl9wYWlyaW5nLmRlbGV0ZSh0b2tlbi50b1N0cmluZygnaGV4JykpCiAgICB9CgogICAgZm9yIChjb25zdCBzdHJlYW0gb2YgdGhpcy5fc3RyZWFtcy52YWx1ZXMoKSkgewogICAgICBzdHJlYW0KICAgICAgICAub2ZmKCdlcnJvcicsIHRoaXMuX29uZXJyb3IpCiAgICAgICAgLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgICAgLmRlc3Ryb3koZXJyKQogICAgfQoKICAgIHRoaXMuX3BhaXJpbmcuY2xlYXIoKQogICAgdGhpcy5fc3RyZWFtcy5jbGVhcigpCgogICAgdGhpcy5fc2VydmVyLl9zZXNzaW9ucy5kZWxldGUodGhpcykKCiAgICB0aGlzLmVtaXQoJ2Nsb3NlJykKICB9CgogIF9vbmRlc3Ryb3kgKCkgewogICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy5lbWl0KCdkZXN0cm95JykKICB9CgogIF9vbnBhaXIgKHsgaXNJbml0aWF0b3IsIHRva2VuLCBpZDogcmVtb3RlSWQgfSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gdG9rZW4udG9TdHJpbmcoJ2hleCcpCgogICAgbGV0IHBhaXIgPSB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuZ2V0KGtleVN0cmluZykKCiAgICBpZiAocGFpciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHBhaXIgPSBuZXcgQmxpbmRSZWxheVBhaXIodG9rZW4pCiAgICAgIHRoaXMuX3NlcnZlci5fcGFpcmluZy5zZXQoa2V5U3RyaW5nLCBwYWlyKQogICAgfSBlbHNlIGlmIChwYWlyLmxpbmtzWytpc0luaXRpYXRvcl0pIHJldHVybgoKICAgIHRoaXMuX3BhaXJpbmcuYWRkKGtleVN0cmluZykKCiAgICBwYWlyLmxpbmtzWytpc0luaXRpYXRvcl0gPSBuZXcgQmxpbmRSZWxheUxpbmsodGhpcywgaXNJbml0aWF0b3IsIHJlbW90ZUlkKQoKICAgIGlmICghcGFpci5wYWlyZWQpIHJldHVybgoKICAgIHRoaXMuX3NlcnZlci5fcGFpcmluZy5kZWxldGUoa2V5U3RyaW5nKQoKICAgIC8vIDFzdCBwYXNzOiBDcmVhdGUgdGhlIHJhdyBzdHJlYW1zIG5lZWRlZCBmb3IgZWFjaCBlbmQgb2YgdGhlIGxpbmsuCiAgICBmb3IgKGNvbnN0IGxpbmsgb2YgcGFpci5saW5rcykgewogICAgICBsaW5rLmNyZWF0ZVN0cmVhbSgpCiAgICB9CgogICAgLy8gMm5kIHBhc3M6IENvbm5lY3QgdGhlIHJhdyBzdHJlYW1zIGFuZCBzZXQgdXAgaGFuZGxlcnMuCiAgICBmb3IgKGNvbnN0IHsgaXNJbml0aWF0b3IsIHNlc3Npb24sIHN0cmVhbSB9IG9mIHBhaXIubGlua3MpIHsKICAgICAgY29uc3QgcmVtb3RlID0gcGFpci5yZW1vdGUoaXNJbml0aWF0b3IpCgogICAgICBzdHJlYW0KICAgICAgICAub24oJ2Vycm9yJywgc2Vzc2lvbi5fb25lcnJvcikKICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gc2Vzc2lvbi5fc3RyZWFtcy5kZWxldGUoa2V5U3RyaW5nKSkKICAgICAgICAucmVsYXlUbyhyZW1vdGUuc3RyZWFtKQoKICAgICAgc2Vzc2lvbi5fcGFpcmluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgICBzZXNzaW9uLl9zdHJlYW1zLnNldChrZXlTdHJpbmcsIHN0cmVhbSkKICAgIH0KCiAgICAvLyAzcmQgcGFzczogTGV0IGVpdGhlciBlbmQgb2YgdGhlIGxpbmsga25vdyB0aGUgc3RyZWFtcyB3ZXJlIHNldCB1cC4KICAgIGZvciAoY29uc3QgeyBpc0luaXRpYXRvciwgc2Vzc2lvbiwgcmVtb3RlSWQsIHN0cmVhbSB9IG9mIHBhaXIubGlua3MpIHsKICAgICAgc2Vzc2lvbi5fcGFpci5zZW5kKHsKICAgICAgICBpc0luaXRpYXRvciwKICAgICAgICB0b2tlbiwKICAgICAgICBpZDogc3RyZWFtLmlkLAogICAgICAgIHNlcTogMAogICAgICB9KQoKICAgICAgc2Vzc2lvbi5fZW5kTWF5YmUoKQoKICAgICAgc2Vzc2lvbi5lbWl0KCdwYWlyJywgaXNJbml0aWF0b3IsIHRva2VuLCBzdHJlYW0sIHJlbW90ZUlkKQogICAgfQogIH0KCiAgX29udW5wYWlyICh7IHRva2VuIH0pIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IHRva2VuLnRvU3RyaW5nKCdoZXgnKQoKICAgIGNvbnN0IHBhaXIgPSB0aGlzLl9zZXJ2ZXIuX3BhaXJpbmcuZ2V0KGtleVN0cmluZykKCiAgICBpZiAocGFpcikgewogICAgICBmb3IgKGNvbnN0IGxpbmsgb2YgcGFpci5saW5rcykgewogICAgICAgIGlmIChsaW5rKSBsaW5rLnNlc3Npb24uX3BhaXJpbmcuZGVsZXRlKGtleVN0cmluZykKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX3NlcnZlci5fcGFpcmluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgfQoKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuX3N0cmVhbXMuZ2V0KGtleVN0cmluZykKCiAgICBpZiAoc3RyZWFtKSB7CiAgICAgIHN0cmVhbQogICAgICAgIC5vZmYoJ2Vycm9yJywgdGhpcy5fb25lcnJvcikKICAgICAgICAub24oJ2Vycm9yJywgbm9vcCkKICAgICAgICAuZGVzdHJveShlcnJvcnMuUEFJUklOR19DQU5DRUxMRUQoKSkKCiAgICAgIHRoaXMuX3N0cmVhbXMuZGVsZXRlKGtleVN0cmluZykKICAgIH0KICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fY2hhbm5lbC5jb3JrKCkKICB9CgogIHVuY29yayAoKSB7CiAgICB0aGlzLl9jaGFubmVsLnVuY29yaygpCiAgfQoKICBhc3luYyBlbmQgKCkgewogICAgaWYgKHRoaXMuX2VuZGluZykgcmV0dXJuIHRoaXMuX2VuZGluZwoKICAgIHRoaXMuX2VuZGluZyA9IEV2ZW50RW1pdHRlci5vbmNlKHRoaXMsICdjbG9zZScpCiAgICB0aGlzLl9lbmRNYXliZSgpCgogICAgcmV0dXJuIHRoaXMuX2VuZGluZwogIH0KCiAgX2VuZE1heWJlICgpIHsKICAgIGlmICh0aGlzLl9lbmRpbmcgJiYgdGhpcy5fcGFpcmluZy5zaXplID09PSAwKSB7CiAgICAgIHRoaXMuX2NoYW5uZWwuY2xvc2UoKQogICAgfQogIH0KCiAgZGVzdHJveSAoZXJyKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWUKCiAgICB0aGlzLl9lcnJvciA9IGVyciB8fCBlcnJvcnMuQ0hBTk5FTF9ERVNUUk9ZRUQoKQogICAgdGhpcy5fY2hhbm5lbC5jbG9zZSgpCiAgfQp9CgpjbGFzcyBCbGluZFJlbGF5UGFpciB7CiAgY29uc3RydWN0b3IgKHRva2VuKSB7CiAgICB0aGlzLnRva2VuID0gdG9rZW4KICAgIHRoaXMubGlua3MgPSBbbnVsbCwgbnVsbF0KICB9CgogIGdldCBwYWlyZWQgKCkgewogICAgcmV0dXJuIHRoaXMubGlua3NbMF0gIT09IG51bGwgJiYgdGhpcy5saW5rc1sxXSAhPT0gbnVsbAogIH0KCiAgcmVtb3RlIChpc0luaXRpYXRvcikgewogICAgcmV0dXJuIHRoaXMubGlua3NbaXNJbml0aWF0b3IgPyAwIDogMV0KICB9Cn0KCmNsYXNzIEJsaW5kUmVsYXlMaW5rIHsKICBjb25zdHJ1Y3RvciAoc2Vzc2lvbiwgaXNJbml0aWF0b3IsIHJlbW90ZUlkKSB7CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLmlzSW5pdGlhdG9yID0gaXNJbml0aWF0b3IKICAgIHRoaXMucmVtb3RlSWQgPSByZW1vdGVJZAogICAgdGhpcy5zdHJlYW0gPSBudWxsCiAgfQoKICBjcmVhdGVTdHJlYW0gKCkgewogICAgaWYgKHRoaXMuc3RyZWFtKSByZXR1cm4KCiAgICB0aGlzLnN0cmVhbSA9IHRoaXMuc2Vzc2lvbi5fc2VydmVyLl9jcmVhdGVTdHJlYW0oewogICAgICBmaXJld2FsbDogdGhpcy5fb25maXJld2FsbC5iaW5kKHRoaXMpCiAgICB9KQogIH0KCiAgX29uZmlyZXdhbGwgKHNvY2tldCwgcG9ydCwgaG9zdCkgewogICAgdGhpcy5zdHJlYW0uY29ubmVjdChzb2NrZXQsIHRoaXMucmVtb3RlSWQsIHBvcnQsIGhvc3QpCgogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpleHBvcnRzLkNsaWVudCA9IGNsYXNzIEJsaW5kUmVsYXlDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIHN0YXRpYyBfY2xpZW50cyA9IG5ldyBXZWFrTWFwKCkKCiAgc3RhdGljIGZyb20gKHN0cmVhbSwgb3B0cykgewogICAgbGV0IGNsaWVudCA9IHRoaXMuX2NsaWVudHMuZ2V0KHN0cmVhbSkKICAgIGlmIChjbGllbnQpIHJldHVybiBjbGllbnQKICAgIGNsaWVudCA9IG5ldyB0aGlzKHN0cmVhbSwgb3B0cykKICAgIHRoaXMuX2NsaWVudHMuc2V0KHN0cmVhbSwgY2xpZW50KQogICAgcmV0dXJuIGNsaWVudAogIH0KCiAgY29uc3RydWN0b3IgKHN0cmVhbSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgY29uc3QgewogICAgICBpZCwKICAgICAgaGFuZHNoYWtlLAogICAgICBoYW5kc2hha2VFbmNvZGluZwogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9tdXggPSBQcm90b211eC5mcm9tKHN0cmVhbSkKCiAgICB0aGlzLl9jaGFubmVsID0gdGhpcy5fbXV4LmNyZWF0ZUNoYW5uZWwoewogICAgICBwcm90b2NvbDogJ2JsaW5kLXJlbGF5JywKICAgICAgaWQsCiAgICAgIGhhbmRzaGFrZTogaGFuZHNoYWtlID8gaGFuZHNoYWtlRW5jb2RpbmcgfHwgYy5yYXcgOiBudWxsLAogICAgICBvbm9wZW46IHRoaXMuX29ub3Blbi5iaW5kKHRoaXMpLAogICAgICBvbmNsb3NlOiB0aGlzLl9vbmNsb3NlLmJpbmQodGhpcyksCiAgICAgIG9uZGVzdHJveTogdGhpcy5fb25kZXN0cm95LmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5fcGFpciA9IHRoaXMuX2NoYW5uZWwuYWRkTWVzc2FnZSh7CiAgICAgIGVuY29kaW5nOiBtLnBhaXIsCiAgICAgIG9ubWVzc2FnZTogdGhpcy5fb25wYWlyLmJpbmQodGhpcykKICAgIH0pCgogICAgdGhpcy5fdW5wYWlyID0gdGhpcy5fY2hhbm5lbC5hZGRNZXNzYWdlKHsKICAgICAgZW5jb2Rpbmc6IG0udW5wYWlyCiAgICB9KQoKICAgIHRoaXMuX2VuZGluZyA9IGZhbHNlCiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5fZXJyb3IgPSBudWxsCiAgICB0aGlzLl9yZXF1ZXN0cyA9IG5ldyBNYXAoKQoKICAgIHRoaXMuX2NoYW5uZWwub3BlbihoYW5kc2hha2UpCiAgfQoKICBnZXQgY2xvc2VkICgpIHsKICAgIHJldHVybiB0aGlzLl9jaGFubmVsLmNsb3NlZAogIH0KCiAgZ2V0IG11eCAoKSB7CiAgICByZXR1cm4gdGhpcy5fbXV4CiAgfQoKICBnZXQgc3RyZWFtICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXguc3RyZWFtCiAgfQoKICBnZXQgcmVxdWVzdHMgKCkgewogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RzLnZhbHVlcygpCiAgfQoKICBfb25vcGVuICgpIHsKICAgIHRoaXMuZW1pdCgnb3BlbicpCiAgfQoKICBfb25jbG9zZSAoKSB7CiAgICB0aGlzLl9lbmRpbmcgPSBQcm9taXNlLnJlc29sdmUoKQoKICAgIGNvbnN0IGVyciA9IHRoaXMuX2Vycm9yIHx8IGVycm9ycy5DSEFOTkVMX0NMT1NFRCgpCgogICAgZm9yIChjb25zdCByZXF1ZXN0IG9mIHRoaXMuX3JlcXVlc3RzLnZhbHVlcygpKSB7CiAgICAgIHJlcXVlc3QuZGVzdHJveShlcnIpCiAgICB9CgogICAgdGhpcy5fcmVxdWVzdHMuY2xlYXIoKQoKICAgIHRoaXMuY29uc3RydWN0b3IuX2NsaWVudHMuZGVsZXRlKHRoaXMuc3RyZWFtKQoKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX29uZGVzdHJveSAoKSB7CiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCiAgICB0aGlzLmVtaXQoJ2Rlc3Ryb3knKQogIH0KCiAgX29ucGFpciAoeyBpc0luaXRpYXRvciwgdG9rZW4sIGlkOiByZW1vdGVJZCB9KSB7CiAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fcmVxdWVzdHMuZ2V0KHRva2VuLnRvU3RyaW5nKCdoZXgnKSkKCiAgICBpZiAocmVxdWVzdCA9PT0gdW5kZWZpbmVkIHx8IHJlcXVlc3QuaXNJbml0aWF0b3IgIT09IGlzSW5pdGlhdG9yKSByZXR1cm4KCiAgICByZXF1ZXN0LnB1c2gocmVtb3RlSWQpCiAgICByZXF1ZXN0LnB1c2gobnVsbCkKCiAgICB0aGlzLmVtaXQoJ3BhaXInLCByZXF1ZXN0LmlzSW5pdGlhdG9yLCByZXF1ZXN0LnRva2VuLCByZXF1ZXN0LnN0cmVhbSwgcmVtb3RlSWQpCiAgfQoKICBwYWlyIChpc0luaXRpYXRvciwgdG9rZW4sIHN0cmVhbSkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgdGhyb3cgZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkKCiAgICBjb25zdCBrZXlTdHJpbmcgPSB0b2tlbi50b1N0cmluZygnaGV4JykKCiAgICBpZiAodGhpcy5fcmVxdWVzdHMuaGFzKGtleVN0cmluZykpIHRocm93IGVycm9ycy5BTFJFQURZX1BBSVJJTkcoKQoKICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgQmxpbmRSZWxheVJlcXVlc3QodGhpcywgaXNJbml0aWF0b3IsIHRva2VuLCBzdHJlYW0pCgogICAgdGhpcy5fcmVxdWVzdHMuc2V0KGtleVN0cmluZywgcmVxdWVzdCkKCiAgICByZXR1cm4gcmVxdWVzdAogIH0KCiAgdW5wYWlyICh0b2tlbikgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgdGhyb3cgZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkKCiAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fcmVxdWVzdHMuZ2V0KHRva2VuLnRvU3RyaW5nKCdoZXgnKSkKCiAgICBpZiAocmVxdWVzdCkgcmVxdWVzdC5kZXN0cm95KGVycm9ycy5QQUlSSU5HX0NBTkNFTExFRCgpKQoKICAgIHRoaXMuX3VucGFpci5zZW5kKHsgdG9rZW4gfSkKICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fY2hhbm5lbC5jb3JrKCkKICB9CgogIHVuY29yayAoKSB7CiAgICB0aGlzLl9jaGFubmVsLnVuY29yaygpCiAgfQoKICBhc3luYyBlbmQgKCkgewogICAgaWYgKHRoaXMuX2VuZGluZykgcmV0dXJuIHRoaXMuX2VuZGluZwoKICAgIHRoaXMuX2VuZGluZyA9IEV2ZW50RW1pdHRlci5vbmNlKHRoaXMsICdjbG9zZScpCiAgICB0aGlzLl9lbmRNYXliZSgpCgogICAgcmV0dXJuIHRoaXMuX2VuZGluZwogIH0KCiAgX2VuZE1heWJlICgpIHsKICAgIGlmICh0aGlzLl9lbmRpbmcgJiYgdGhpcy5fcmVxdWVzdHMuc2l6ZSA9PT0gMCkgewogICAgICB0aGlzLl9jaGFubmVsLmNsb3NlKCkKICAgIH0KICB9CgogIGRlc3Ryb3kgKGVycikgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCgogICAgdGhpcy5fZXJyb3IgPSBlcnIgfHwgZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkKICAgIHRoaXMuX2NoYW5uZWwuY2xvc2UoKQogIH0KfQoKY2xhc3MgQmxpbmRSZWxheVJlcXVlc3QgZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IgKGNsaWVudCwgaXNJbml0aWF0b3IsIHRva2VuLCBzdHJlYW0pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmNsaWVudCA9IGNsaWVudAogICAgdGhpcy5pc0luaXRpYXRvciA9IGlzSW5pdGlhdG9yCiAgICB0aGlzLnRva2VuID0gdG9rZW4KICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtCiAgfQoKICBfb3BlbiAoY2IpIHsKICAgIGlmICh0aGlzLmNsaWVudC5fZGVzdHJveWVkKSByZXR1cm4gY2IoZXJyb3JzLkNIQU5ORUxfREVTVFJPWUVEKCkpCgogICAgdGhpcy5jbGllbnQuX3BhaXIuc2VuZCh7CiAgICAgIGlzSW5pdGlhdG9yOiB0aGlzLmlzSW5pdGlhdG9yLAogICAgICB0b2tlbjogdGhpcy50b2tlbiwKICAgICAgaWQ6IHRoaXMuc3RyZWFtLmlkLAogICAgICBzZXE6IDAKICAgIH0pCgogICAgY2IobnVsbCkKICB9CgogIF9kZXN0cm95IChjYikgewogICAgdGhpcy5jbGllbnQuX3JlcXVlc3RzLmRlbGV0ZSh0aGlzLnRva2VuLnRvU3RyaW5nKCdoZXgnKSkKCiAgICBjYihudWxsKQoKICAgIHRoaXMuY2xpZW50Ll9lbmRNYXliZSgpCiAgfQp9CgpleHBvcnRzLnRva2VuID0gZnVuY3Rpb24gdG9rZW4gKGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZSgzMikpIHsKICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKGJ1ZikKICByZXR1cm4gYnVmCn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KCmNvbnN0IG0gPSBleHBvcnRzLm1lc3NhZ2VzID0ge30KCmNvbnN0IGZsYWdzID0gYml0ZmllbGQoNykKCm0ucGFpciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBmbGFncy5wcmVlbmNvZGUoc3RhdGUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgZmxhZ3MuZW5jb2RlKHN0YXRlLCBiaXRzLm9mKG0uaXNJbml0aWF0b3IpKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS50b2tlbikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlcSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IFtpc0luaXRpYXRvcl0gPSBiaXRzLml0ZXJhdG9yKGZsYWdzLmRlY29kZShzdGF0ZSkpCgogICAgcmV0dXJuIHsKICAgICAgaXNJbml0aWF0b3IsCiAgICAgIHRva2VuOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzZXE6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgptLnVucGFpciA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBmbGFncy5wcmVlbmNvZGUoc3RhdGUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgZmxhZ3MuZW5jb2RlKHN0YXRlLCBiaXRzLm9mKCkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnRva2VuKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgZmxhZ3MuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHRva2VuOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJsaW5kUmVsYXlFcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvciAobXNnLCBjb2RlLCBmbiA9IEJsaW5kUmVsYXlFcnJvcikgewogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCiAgICB0aGlzLmNvZGUgPSBjb2RlCgogICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIGZuKQogICAgfQogIH0KCiAgZ2V0IG5hbWUgKCkgewogICAgcmV0dXJuICdCbGluZFJlbGF5RXJyb3InCiAgfQoKICBzdGF0aWMgRFVQTElDQVRFX0NIQU5ORUwgKG1zZyA9ICdEdXBsaWNhdGUgY2hhbm5lbCcpIHsKICAgIHJldHVybiBuZXcgQmxpbmRSZWxheUVycm9yKG1zZywgJ0RVUExJQ0FURV9DSEFOTkVMJywgQmxpbmRSZWxheUVycm9yLkRVUExJQ0FURV9DSEFOTkVMKQogIH0KCiAgc3RhdGljIENIQU5ORUxfQ0xPU0VEIChtc2cgPSAnQ2hhbm5lbCBjbG9zZWQnKSB7CiAgICByZXR1cm4gbmV3IEJsaW5kUmVsYXlFcnJvcihtc2csICdDSEFOTkVMX0NMT1NFRCcsIEJsaW5kUmVsYXlFcnJvci5DSEFOTkVMX0NMT1NFRCkKICB9CgogIHN0YXRpYyBDSEFOTkVMX0RFU1RST1lFRCAobXNnID0gJ0NoYW5uZWwgZGVzdHJveWVkJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnQ0hBTk5FTF9ERVNUUk9ZRUQnLCBCbGluZFJlbGF5RXJyb3IuQ0hBTk5FTF9ERVNUUk9ZRUQpCiAgfQoKICBzdGF0aWMgQUxSRUFEWV9QQUlSSU5HIChtc2cgPSAnQWxyZWFkeSBwYWlyaW5nJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnQUxSRUFEWV9QQUlSSU5HJywgQmxpbmRSZWxheUVycm9yLkFMUkVBRFlfUEFJUklORykKICB9CgogIHN0YXRpYyBQQUlSSU5HX0NBTkNFTExFRCAobXNnID0gJ1BhaXJpbmcgY2FuY2VsbGVkJykgewogICAgcmV0dXJuIG5ldyBCbGluZFJlbGF5RXJyb3IobXNnLCAnUEFJUklOR19DQU5DRUxMRUQnLCBCbGluZFJlbGF5RXJyb3IuUEFJUklOR19DQU5DRUxMRUQpCiAgfQp9CnsKICAibmFtZSI6ICJibGluZC1yZWxheSIsCiAgInZlcnNpb24iOiAiMS40LjAiLAogICJkZXNjcmlwdGlvbiI6ICJCbGluZCByZWxheSBmb3IgVURYIG92ZXIgUHJvdG9tdXggY2hhbm5lbHMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYiIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1yZWxheS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ibGluZC1yZWxheS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JsaW5kLXJlbGF5I3JlYWRtZSIsCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNCIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJiaXRzLXRvLWJ5dGVzIjogIl4xLjMuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xMi4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkIjogIl4xLjAuMCIsCiAgICAicHJvdG9tdXgiOiAiXjMuNS4xIiwKICAgICJzb2RpdW0tdW5pdmVyc2FsIjogIl41LjAuMCIsCiAgICAic3RyZWFteCI6ICJeMi4xNS4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjIuMSIsCiAgICAiaHlwZXJkaHQiOiAiXjYuNi4xIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIiwKICAgICJ1ZHgtbmF0aXZlIjogIl4xLjYuMSIKICB9Cn0KLy8gaHR0cHM6Ly9pcGluZm8uaW8vYm9nb24KCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgbmV0ID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZy1uZXQnKQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gZnVuY3Rpb24gaXNCb2dvbiAoaXApIHsKICByZXR1cm4gaXNCb2dvbklQKGVuc3VyZUJ1ZmZlcihpcCkpCn0KCmV4cG9ydHMuaXNCb2dvbiA9IGV4cG9ydHMKCmV4cG9ydHMuaXNQcml2YXRlID0gZnVuY3Rpb24gaXNQcml2YXRlIChpcCkgewogIHJldHVybiBpc1ByaXZhdGVJUChlbnN1cmVCdWZmZXIoaXApKQp9CgpmdW5jdGlvbiBpc0JvZ29uSVAgKGlwKSB7CiAgcmV0dXJuIGlzUHJpdmF0ZUlQKGlwKSB8fCBpc1Jlc2VydmVkSVAoaXApCn0KCmZ1bmN0aW9uIGlzUHJpdmF0ZUlQIChpcCkgewogIHJldHVybiBpcC5ieXRlTGVuZ3RoID09PSA0ID8gaXNQcml2YXRlSVB2NChpcCkgOiBmYWxzZSAvLyBJUHY2IGhhcyBubyBwcml2YXRlIElQcwp9CgpmdW5jdGlvbiBpc1ByaXZhdGVJUHY0IChpcCkgewogIHJldHVybiAoCiAgICAvLyAxMC4wLjAuMC84ICBQcml2YXRlLXVzZSBuZXR3b3JrcwogICAgKGlwWzBdID09PSAxMCkgfHwKICAgIC8vIDEwMC42NC4wLjAvMTAgQ2Fycmllci1ncmFkZSBOQVQKICAgIChpcFswXSA9PT0gMTAwICYmIGlwWzFdID49IDY0ICYmIGlwWzFdIDw9IDEyNykgfHwKICAgIC8vIDEyNy4wLjAuMC84IExvb3BiYWNrICsgTmFtZSBjb2xsaXNpb24gb2NjdXJyZW5jZSAoMTI3LjAuNTMuNTMpCiAgICAoaXBbMF0gPT09IDEyNykgfHwKICAgIC8vIDE2OS4yNTQuMC4wLzE2ICBMaW5rIGxvY2FsCiAgICAoaXBbMF0gPT09IDE2OSAmJiBpcFsxXSA9PT0gMjU0KSB8fAogICAgLy8gMTcyLjE2LjAuMC8xMiBQcml2YXRlLXVzZSBuZXR3b3JrcwogICAgKGlwWzBdID09PSAxNzIgJiYgaXBbMV0gPj0gMTYgJiYgaXBbMV0gPD0gMzEpIHx8CiAgICAvLyAxOTIuMTY4LjAuMC8xNiAgUHJpdmF0ZS11c2UgbmV0d29ya3MKICAgIChpcFswXSA9PT0gMTkyICYmIGlwWzFdID09PSAxNjgpCiAgKQp9CgpmdW5jdGlvbiBpc1Jlc2VydmVkSVAgKGlwKSB7CiAgcmV0dXJuIGlwLmJ5dGVMZW5ndGggPT09IDQgPyBpc1Jlc2VydmVkSVB2NChpcCkgOiBpc1Jlc2VydmVkSVB2NihpcCkKfQoKZnVuY3Rpb24gaXNSZXNlcnZlZElQdjQgKGlwKSB7CiAgcmV0dXJuICgKICAgIC8vIDAuMC4wLjAvOCAiVGhpcyIgbmV0d29yawogICAgKGlwWzBdID09PSAwKSB8fAogICAgLy8gMTkyLjAuMC4wLzI0ICBJRVRGIHByb3RvY29sIGFzc2lnbm1lbnRzCiAgICAoaXBbMF0gPT09IDE5MiAmJiBpcFsxXSA9PT0gMCAmJiBpcFsyXSA9PT0gMCkgfHwKICAgIC8vIDE5Mi4wLjIuMC8yNCAgVEVTVC1ORVQtMQogICAgKGlwWzBdID09PSAxOTIgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDIpIHx8CiAgICAvLyAxOTguMTguMC4wLzE1IE5ldHdvcmsgaW50ZXJjb25uZWN0IGRldmljZSBiZW5jaG1hcmsgdGVzdGluZwogICAgKGlwWzBdID09PSAxOTggJiYgaXBbMV0gPj0gMTggJiYgaXBbMV0gPD0gMTkpIHx8CiAgICAvLyAxOTguNTEuMTAwLjAvMjQgVEVTVC1ORVQtMgogICAgKGlwWzBdID09PSAxOTggJiYgaXBbMV0gPT09IDUxICYmIGlwWzJdID09PSAxMDApIHx8CiAgICAvLyAyMDMuMC4xMTMuMC8yNCAgVEVTVC1ORVQtMwogICAgKGlwWzBdID09PSAyMDMgJiYgaXBbMV0gPT09IDAgJiYgaXBbMl0gPT09IDExMykgfHwKICAgIC8vIDIyNC4wLjAuMC80IE11bHRpY2FzdAogICAgKGlwWzBdID49IDIyNCAmJiBpcFswXSA8PSAyMzkpIHx8CiAgICAvLyAyNDAuMC4wLjAvNCBSZXNlcnZlZCBmb3IgZnV0dXJlIHVzZQogICAgKGlwWzBdID49IDI0MCkgfHwKICAgIC8vIDI1NS4yNTUuMjU1LjI1NS8zMgogICAgKGlwWzBdID09PSAyNTUgJiYgaXBbMV0gPT09IDI1NSAmJiBpcFsyXSA9PT0gMjU1ICYmIGlwWzNdID09PSAyNTUpCiAgKQp9CgpmdW5jdGlvbiBpc1Jlc2VydmVkSVB2NiAoaXApIHsKICByZXR1cm4gKAogICAgLy8gOjovMTI4IE5vZGUtc2NvcGUgdW5pY2FzdCB1bnNwZWNpZmllZCBhZGRyZXNzCiAgICAvLyA6OjEvMTI4IE5vZGUtc2NvcGUgdW5pY2FzdCBsb29wYmFjayBhZGRyZXNzCiAgICAoCiAgICAgIGlwWzBdID09PSAwICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAwICYmIGlwWzNdID09PSAwICYmIGlwWzRdID09PSAwICYmCiAgICAgIGlwWzVdID09PSAwICYmIGlwWzZdID09PSAwICYmIGlwWzddID09PSAwICYmIGlwWzhdID09PSAwICYmIGlwWzldID09PSAwICYmCiAgICAgIGlwWzEwXSA9PT0gMCAmJiBpcFsxMV0gPT09IDAgJiYgaXBbMTJdID09PSAwICYmIGlwWzEzXSA9PT0gMCAmJiBpcFsxNF0gPT09IDAgJiYKICAgICAgaXBbMTVdIDw9IDEKICAgICkgfHwKICAgIC8vIDo6ZmZmZjowOjAvOTYgSVB2NC1tYXBwZWQgYWRkcmVzc2VzCiAgICAvLyA6Oi85NiBJUHY0LWNvbXBhdGlibGUgYWRkcmVzc2VzCiAgICAoCiAgICAgIGlwWzBdID09PSAwICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAwICYmIGlwWzNdID09PSAwICYmIGlwWzRdID09PSAwICYmCiAgICAgIGlwWzVdID09PSAwICYmIGlwWzZdID09PSAwICYmIGlwWzddID09PSAwICYmIGlwWzhdID09PSAwICYmIGlwWzldID09PSAwICYmCiAgICAgIChpcFsxMF0gPT09IDAgfHwgaXBbMTBdID09PSAweGZmKSAmJgogICAgICAoaXBbMTFdID09PSAwIHx8IGlwWzExXSA9PT0gMHhmZikKICAgICkgfHwKICAgIC8vIDEwMDo6LzY0IFJlbW90ZWx5IHRyaWdnZXJlZCBibGFjayBob2xlIGFkZHJlc3NlcwogICAgKGlwWzBdID09PSAweDAxICYmIGlwWzFdID09PSAwICYmIGlwWzJdID09PSAwICYmIGlwWzNdID09PSAwICYmIGlwWzRdID09PSAwICYmIGlwWzVdID09PSAwICYmIGlwWzZdID09PSAwICYmIGlwWzddID09PSAwKSB8fAogICAgLy8gMjAwMToxMDo6LzI4IE92ZXJsYXkgcm91dGFibGUgY3J5cHRvZ3JhcGhpYyBoYXNoIGlkZW50aWZpZXJzIChPUkNISUQpCiAgICAoaXBbMF0gPT09IDB4MjAgJiYgaXBbMV0gPT09IDB4MDEgJiYgaXBbMl0gPT09IDAgJiYgaXBbM10gPj0gMHgxMCAmJiBpcFszXSA8PSAweDFmKSB8fAogICAgLy8gMjAwMToyMDo6LzI4IE92ZXJsYXkgcm91dGFibGUgY3J5cHRvZ3JhcGhpYyBoYXNoIGlkZW50aWZpZXJzIHZlcnNpb24gMiAoT1JDSElEdjIpCiAgICAoaXBbMF0gPT09IDB4MjAgJiYgaXBbMV0gPT09IDB4MDEgJiYgaXBbMl0gPT09IDAgJiYgaXBbM10gPj0gMHgyMCAmJiBpcFszXSA8PSAweDJmKSB8fAogICAgLy8gMjAwMTpkYjg6Oi8zMiBEb2N1bWVudGF0aW9uIHByZWZpeAogICAgKGlwWzBdID09PSAweDIwICYmIGlwWzFdID09PSAweDAxICYmIGlwWzJdID09PSAweDBkICYmIGlwWzNdID09PSAweGI4KSB8fAogICAgLy8gZmMwMDo6LzcgVW5pcXVlIGxvY2FsIGFkZHJlc3NlcyAoVUxBKQogICAgKGlwWzBdID49IDB4ZmMgJiYgaXBbMF0gPD0gMHhmZCkgfHwKICAgIC8vIGZlODA6Oi8xMCBMaW5rLWxvY2FsIHVuaWNhc3QKICAgIChpcFswXSA9PT0gMHhmZSAmJiBpcFsxXSA+PSAweDgwICYmIGlwWzFdIDw9IDB4YmYpIHx8CiAgICAvLyBmZjAwOjovOCBNdWx0aWNhc3QKICAgIChpcFswXSA9PT0gMHhmZikKICApCn0KCmNvbnN0IHN0YXRlID0gYy5zdGF0ZSgwLCAwLCBiNGEuYWxsb2NVbnNhZmUoMSAvKiBmYW1pbHkgKi8gKyAxNikpCgpmdW5jdGlvbiBlbnN1cmVCdWZmZXIgKGlwKSB7CiAgaWYgKGI0YS5pc0J1ZmZlcihpcCkpIHJldHVybiBpcAoKICBuZXQuaXAucHJlZW5jb2RlKHN0YXRlLCBpcCkKICBuZXQuaXAuZW5jb2RlKHN0YXRlLCBpcCkKCiAgY29uc3QgYnVmZmVyID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KDEgLyogZmFtaWx5ICovLCBzdGF0ZS5lbmQpCgogIHN0YXRlLnN0YXJ0ID0gMAogIHN0YXRlLmVuZCA9IDAKCiAgcmV0dXJuIGJ1ZmZlcgp9CnsKICAibmFtZSI6ICJib2dvbiIsCiAgInZlcnNpb24iOiAiMS4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDaGVjayBpZiBhbiBJUCBpcyBhIGJvZ29uIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QubWpzIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmctbmV0IjogIl4xLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjQiLAogICAgIm5hbm9iZW5jaCI6ICJeMi4xLjEiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvYm9nb24uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JvZ29uL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2JvZ29uIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNvZGVjcwoKY29kZWNzLmFzY2lpID0gY3JlYXRlU3RyaW5nKCdhc2NpaScpCmNvZGVjcy51dGY4ID0gY3JlYXRlU3RyaW5nKCd1dGYtOCcpCmNvZGVjcy5oZXggPSBjcmVhdGVTdHJpbmcoJ2hleCcpCmNvZGVjcy5iYXNlNjQgPSBjcmVhdGVTdHJpbmcoJ2Jhc2U2NCcpCmNvZGVjcy51Y3MyID0gY3JlYXRlU3RyaW5nKCd1Y3MyJykKY29kZWNzLnV0ZjE2bGUgPSBjcmVhdGVTdHJpbmcoJ3V0ZjE2bGUnKQpjb2RlY3MubmRqc29uID0gY3JlYXRlSlNPTih0cnVlKQpjb2RlY3MuanNvbiA9IGNyZWF0ZUpTT04oZmFsc2UpCmNvZGVjcy5iaW5hcnkgPSB7CiAgbmFtZTogJ2JpbmFyeScsCiAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGVCaW5hcnkgKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdzdHJpbmcnCiAgICAgID8gYjRhLmZyb20ob2JqLCAndXRmLTgnKQogICAgICA6IGI0YS50b0J1ZmZlcihvYmopCiAgfSwKICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZUJpbmFyeSAoYnVmKSB7CiAgICByZXR1cm4gYjRhLnRvQnVmZmVyKGJ1ZikKICB9Cn0KCmZ1bmN0aW9uIGlzQ29tcGFjdEVuY29kaW5nIChjKSB7CiAgcmV0dXJuICEhKGMuZW5jb2RlICYmIGMuZGVjb2RlICYmIGMucHJlZW5jb2RlKQp9CgpmdW5jdGlvbiBmcm9tQ29tcGFjdEVuY29kaW5nIChjKSB7CiAgcmV0dXJuIHsKICAgIG5hbWU6ICdjb21wYWN0LWVuY29kaW5nJywKICAgIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlV2l0aENvbXBhY3QgKHZhbHVlKSB7CiAgICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAwLCBidWZmZXI6IG51bGwsIGNhY2hlOiBudWxsIH0KICAgICAgYy5wcmVlbmNvZGUoc3RhdGUsIHZhbHVlKQogICAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogICAgICBjLmVuY29kZShzdGF0ZSwgdmFsdWUpCiAgICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICAgIH0sCiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZVdpdGhDb21wYWN0IChidWZmZXIpIHsKICAgICAgcmV0dXJuIGMuZGVjb2RlKHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciwgY2FjaGU6IG51bGwgfSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNvZGVjcyAoZm10LCBmYWxsYmFjaykgewogIGlmICh0eXBlb2YgZm10ID09PSAnb2JqZWN0JyAmJiBmbXQpIHsKICAgIHJldHVybiBpc0NvbXBhY3RFbmNvZGluZyhmbXQpID8gZnJvbUNvbXBhY3RFbmNvZGluZyhmbXQpIDogZm10CiAgfQoKICBzd2l0Y2ggKGZtdCkgewogICAgY2FzZSAnbmRqc29uJzogcmV0dXJuIGNvZGVjcy5uZGpzb24KICAgIGNhc2UgJ2pzb24nOiByZXR1cm4gY29kZWNzLmpzb24KICAgIGNhc2UgJ2FzY2lpJzogcmV0dXJuIGNvZGVjcy5hc2NpaQogICAgY2FzZSAndXRmLTgnOgogICAgY2FzZSAndXRmOCc6IHJldHVybiBjb2RlY3MudXRmOAogICAgY2FzZSAnaGV4JzogcmV0dXJuIGNvZGVjcy5oZXgKICAgIGNhc2UgJ2Jhc2U2NCc6IHJldHVybiBjb2RlY3MuYmFzZTY0CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1Y3MyJzogcmV0dXJuIGNvZGVjcy51Y3MyCiAgICBjYXNlICd1dGYxNi1sZSc6CiAgICBjYXNlICd1dGYxNmxlJzogcmV0dXJuIGNvZGVjcy51dGYxNmxlCiAgfQoKICByZXR1cm4gZmFsbGJhY2sgIT09IHVuZGVmaW5lZCA/IGZhbGxiYWNrIDogY29kZWNzLmJpbmFyeQp9CgpmdW5jdGlvbiBjcmVhdGVKU09OIChuZXdsaW5lKSB7CiAgcmV0dXJuIHsKICAgIG5hbWU6IG5ld2xpbmUgPyAnbmRqc29uJyA6ICdqc29uJywKICAgIGVuY29kZTogbmV3bGluZSA/IGVuY29kZU5ESlNPTiA6IGVuY29kZUpTT04sCiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZUpTT04gKGJ1ZikgewogICAgICByZXR1cm4gSlNPTi5wYXJzZShiNGEudG9TdHJpbmcoYnVmKSkKICAgIH0KICB9CgogIGZ1bmN0aW9uIGVuY29kZUpTT04gKHZhbCkgewogICAgcmV0dXJuIGI0YS5mcm9tKEpTT04uc3RyaW5naWZ5KHZhbCkpCiAgfQoKICBmdW5jdGlvbiBlbmNvZGVOREpTT04gKHZhbCkgewogICAgcmV0dXJuIGI0YS5mcm9tKEpTT04uc3RyaW5naWZ5KHZhbCkgKyAnXG4nKQogIH0KfQoKZnVuY3Rpb24gY3JlYXRlU3RyaW5nICh0eXBlKSB7CiAgcmV0dXJuIHsKICAgIG5hbWU6IHR5cGUsCiAgICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZVN0cmluZyAodmFsKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsICE9PSAnc3RyaW5nJykgdmFsID0gdmFsLnRvU3RyaW5nKCkKICAgICAgcmV0dXJuIGI0YS5mcm9tKHZhbCwgdHlwZSkKICAgIH0sCiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZVN0cmluZyAoYnVmKSB7CiAgICAgIHJldHVybiBiNGEudG9TdHJpbmcoYnVmLCB0eXBlKQogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiY29kZWNzIiwKICAidmVyc2lvbiI6ICIzLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNyZWF0ZSBhbiBiaW5hcnkgZW5jb2Rlci9kZWNvZGVyIGZvciBqc29uLCB1dGYtOCBvciBjdXN0b20gdHlwZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjMiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMi4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9jb2RlY3MuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2NvZGVjcy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9jb2RlY3MiCn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBiaXRmaWVsZCAobGVuZ3RoKSB7CiAgaWYgKGxlbmd0aCA+IDY0KSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQml0ZmllbGQgY2Fubm90IGJlIGxhcmdlciB0aGFuIDY0IGJpdHMnKQoKICBsZXQgYnl0ZUxlbmd0aAogIGlmIChsZW5ndGggPCA4KSBieXRlTGVuZ3RoID0gMQogIGVsc2UgaWYgKGxlbmd0aCA8PSAxNikgYnl0ZUxlbmd0aCA9IDIKICBlbHNlIGlmIChsZW5ndGggPD0gMzIpIGJ5dGVMZW5ndGggPSA0CiAgZWxzZSBieXRlTGVuZ3RoID0gOAoKICByZXR1cm4gewogICAgcHJlZW5jb2RlIChzdGF0ZSkgewogICAgICBzdGF0ZS5lbmQrKyAvLyBMZW5ndGggYnl0ZSwgdXNlZCBmb3IgZGF0YSB3aGVuIGJ5dGVMZW5ndGggPT09IDEKCiAgICAgIGlmIChieXRlTGVuZ3RoID09PSAxKSA7CiAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDIpIGMudWludDE2LnByZWVuY29kZShzdGF0ZSkKICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gNCkgYy51aW50MzIucHJlZW5jb2RlKHN0YXRlKQogICAgICBlbHNlIGMudWludDY0LnByZWVuY29kZShzdGF0ZSkKICAgIH0sCgogICAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgICBpZiAoYnl0ZUxlbmd0aCA9PT0gMSkgOwogICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSAyKSBjLnVpbnQ4LmVuY29kZShzdGF0ZSwgMHhmZCkKICAgICAgZWxzZSBpZiAoYnl0ZUxlbmd0aCA9PT0gNCkgYy51aW50OC5lbmNvZGUoc3RhdGUsIDB4ZmUpCiAgICAgIGVsc2UgYy51aW50OC5lbmNvZGUoc3RhdGUsIDB4ZmYpCgogICAgICBpZiAodHlwZW9mIGIgPT09ICdudW1iZXInKSB7CiAgICAgICAgaWYgKGJ5dGVMZW5ndGggPT09IDEpIGMudWludDguZW5jb2RlKHN0YXRlLCBiKQogICAgICAgIGVsc2UgaWYgKGJ5dGVMZW5ndGggPT09IDIpIGMudWludDE2LmVuY29kZShzdGF0ZSwgYikKICAgICAgICBlbHNlIGlmIChieXRlTGVuZ3RoID09PSA0KSBjLnVpbnQzMi5lbmNvZGUoc3RhdGUsIGIpCiAgICAgICAgZWxzZSBjLnVpbnQ2NC5lbmNvZGUoc3RhdGUsIGIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhdGUuYnVmZmVyLnNldChiLCBzdGF0ZS5zdGFydCkKCiAgICAgICAgaWYgKGIuYnl0ZUxlbmd0aCA8IGJ5dGVMZW5ndGgpIHsKICAgICAgICAgIC8vIFplcm8tZmlsbCB0aGUgcmVzdCBvZiB0aGUgYnl0ZSBsZW5ndGguCiAgICAgICAgICBzdGF0ZS5idWZmZXIuZmlsbCgKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc3RhdGUuc3RhcnQgKyBiLmJ5dGVMZW5ndGgsCiAgICAgICAgICAgIHN0YXRlLnN0YXJ0ICsgYnl0ZUxlbmd0aAogICAgICAgICAgKQogICAgICAgIH0KCiAgICAgICAgc3RhdGUuc3RhcnQgKz0gYnl0ZUxlbmd0aAogICAgICB9CiAgICB9LAoKICAgIGRlY29kZSAoc3RhdGUpIHsKICAgICAgY29uc3QgYnl0ZSA9IHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydF0KCiAgICAgIGxldCBieXRlTGVuZ3RoCiAgICAgIGlmIChieXRlIDw9IDB4ZmMpIGJ5dGVMZW5ndGggPSAxCiAgICAgIGVsc2UgaWYgKGJ5dGUgPT09IDB4ZmQpIGJ5dGVMZW5ndGggPSAyCiAgICAgIGVsc2UgaWYgKGJ5dGUgPT09IDB4ZmUpIGJ5dGVMZW5ndGggPSA0CiAgICAgIGVsc2UgYnl0ZUxlbmd0aCA9IDgKCiAgICAgIGlmIChieXRlTGVuZ3RoID4gMSkgc3RhdGUuc3RhcnQrKyAvLyBTa2lwIHRoZSBsZW5ndGggYnl0ZQoKICAgICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgICAgIGNvbnN0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBieXRlTGVuZ3RoKSkKCiAgICAgIHJldHVybiBsZW5ndGggPD0gOCA/IGIuc3ViYXJyYXkoMCwgMSkgOiBiCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJjb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkIiwKICAidmVyc2lvbiI6ICIxLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNvbXBhY3QgY29kZWMgZm9yIGJpdGZpZWxkcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctYml0ZmllbGQuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJLYXNwZXIgSXNhZ2VyIERhbHNnYXLDsCA8a2FzcGVyQGZ1bmt0aW9uZWwuY28+IiwKICAibGljZW5zZSI6ICJJU0MiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vY29tcGFjdC1lbmNvZGluZy9jb21wYWN0LWVuY29kaW5nLWJpdGZpZWxkI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjQuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMS4zLjUiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiCiAgfSwKICAic3RhbmRhcmQiOiB7CiAgICAiaWdub3JlIjogWwogICAgICAiX19zbmFwc2hvdHNfXy8qKiIKICAgIF0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQoKY29uc3QgcG9ydCA9IGMudWludDE2Cgpjb25zdCBhZGRyZXNzID0gKGhvc3QsIGZhbWlseSkgPT4gewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICAgIGhvc3QucHJlZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICAgIHBvcnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgICB9LAogICAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgICBob3N0LmVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgICBwb3J0LmVuY29kZShzdGF0ZSwgbS5wb3J0KQogICAgfSwKICAgIGRlY29kZSAoc3RhdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBob3N0OiBob3N0LmRlY29kZShzdGF0ZSksCiAgICAgICAgZmFtaWx5LAogICAgICAgIHBvcnQ6IHBvcnQuZGVjb2RlKHN0YXRlKQogICAgICB9CiAgICB9CiAgfQp9Cgpjb25zdCBpcHY0ID0gewogIHByZWVuY29kZSAoc3RhdGUpIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSwKICBlbmNvZGUgKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgNAoKICAgIGxldCBpID0gMAoKICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCkgewogICAgICBsZXQgbiA9IDAKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCAmJiAoYyA9IHN0cmluZy5jaGFyQ29kZUF0KGkrKykpICE9PSAvKiAuICovIDB4MmUpIHsKICAgICAgICBuID0gbiAqIDEwICsgKGMgLSAvKiAwICovIDB4MzApCiAgICAgIH0KCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIH0KCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArICcuJyArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICAgKQogIH0KfQoKY29uc3QgaXB2NEFkZHJlc3MgPSBhZGRyZXNzKGlwdjQsIDQpCgpjb25zdCBpcHY2ID0gewogIHByZWVuY29kZSAoc3RhdGUpIHsKICAgIHN0YXRlLmVuZCArPSAxNgogIH0sCiAgZW5jb2RlIChzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgICBjb25zdCBlbmQgPSBzdGFydCArIDE2CgogICAgbGV0IGkgPSAwCiAgICBsZXQgc3BsaXQgPSBudWxsCgogICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoKSB7CiAgICAgIGxldCBuID0gMAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKGkgPCBzdHJpbmcubGVuZ3RoICYmIChjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSsrKSkgIT09IC8qIDogKi8gMHgzYSkgewogICAgICAgIGlmIChjID49IDB4MzAgJiYgYyA8PSAweDM5KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIDAgKi8gMHgzMCkKICAgICAgICBlbHNlIGlmIChjID49IDB4NDEgJiYgYyA8PSAweDQ2KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIEEgKi8gMHg0MSArIDEwKQogICAgICAgIGVsc2UgaWYgKGMgPj0gMHg2MSAmJiBjIDw9IDB4NjYpIG4gPSBuICogMHgxMCArIChjIC0gLyogYSAqLyAweDYxICsgMTApCiAgICAgIH0KCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgoKICAgICAgaWYgKGkgPCBzdHJpbmcubGVuZ3RoICYmIHN0cmluZy5jaGFyQ29kZUF0KGkpID09PSAvKiA6ICovIDB4M2EpIHsKICAgICAgICBpKysKICAgICAgICBzcGxpdCA9IHN0YXRlLnN0YXJ0CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3BsaXQgIT09IG51bGwpIHsKICAgICAgY29uc3Qgb2Zmc2V0ID0gZW5kIC0gc3RhdGUuc3RhcnQKICAgICAgc3RhdGUuYnVmZmVyCiAgICAgICAgLmNvcHlXaXRoaW4oc3BsaXQgKyBvZmZzZXQsIHNwbGl0KQogICAgICAgIC5maWxsKDAsIHNwbGl0LCBzcGxpdCArIG9mZnNldCkKICAgIH0KCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMTYpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikgKyAnOicgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdKS50b1N0cmluZygxNikKICAgICkKICB9Cn0KCmNvbnN0IGlwdjZBZGRyZXNzID0gYWRkcmVzcyhpcHY2LCA2KQoKY29uc3QgaXAgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBmYW1pbHkgPSBzdHJpbmcuaW5jbHVkZXMoJzonKSA/IDYgOiA0CiAgICBjLnVpbnQ4LnByZWVuY29kZShzdGF0ZSwgZmFtaWx5KQogICAgaWYgKGZhbWlseSA9PT0gNCkgaXB2NC5wcmVlbmNvZGUoc3RhdGUpCiAgICBlbHNlIGlwdjYucHJlZW5jb2RlKHN0YXRlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgc3RyaW5nKSB7CiAgICBjb25zdCBmYW1pbHkgPSBzdHJpbmcuaW5jbHVkZXMoJzonKSA/IDYgOiA0CiAgICBjLnVpbnQ4LmVuY29kZShzdGF0ZSwgZmFtaWx5KQogICAgaWYgKGZhbWlseSA9PT0gNCkgaXB2NC5lbmNvZGUoc3RhdGUsIHN0cmluZykKICAgIGVsc2UgaXB2Ni5lbmNvZGUoc3RhdGUsIHN0cmluZykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZhbWlseSA9IGMudWludDguZGVjb2RlKHN0YXRlKQogICAgaWYgKGZhbWlseSA9PT0gNCkgcmV0dXJuIGlwdjQuZGVjb2RlKHN0YXRlKQogICAgZWxzZSByZXR1cm4gaXB2Ni5kZWNvZGUoc3RhdGUpCiAgfQp9Cgpjb25zdCBpcEFkZHJlc3MgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaXAucHJlZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICBwb3J0LnByZWVuY29kZShzdGF0ZSwgbS5wb3J0KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaXAuZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICBwb3J0LmVuY29kZShzdGF0ZSwgbS5wb3J0KQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmFtaWx5ID0gYy51aW50OC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBob3N0OiBmYW1pbHkgPT09IDQgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBpcHY2LmRlY29kZShzdGF0ZSksCiAgICAgIGZhbWlseSwKICAgICAgcG9ydDogcG9ydC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBwb3J0LAogIGlwdjQsCiAgaXB2NEFkZHJlc3MsCiAgaXB2NiwKICBpcHY2QWRkcmVzcywKICBpcCwKICBpcEFkZHJlc3MKfQp7CiAgIm5hbWUiOiAiY29tcGFjdC1lbmNvZGluZy1uZXQiLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ29tcGFjdCBjb2RlY3MgZm9yIG5ldCB0eXBlcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0Lm1qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctbmV0LmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy1uZXQvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmctbmV0I3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjQuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMS4zLjUiLAogICAgIm5hbm9iZW5jaCI6ICJeMi4xLjEiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiCiAgfQp9CmNvbnN0IExFID0gKGV4cG9ydHMuTEUgPQogIG5ldyBVaW50OEFycmF5KG5ldyBVaW50MTZBcnJheShbMHhmZl0pLmJ1ZmZlcilbMF0gPT09IDB4ZmYpCgpleHBvcnRzLkJFID0gIUxFCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCB7IEJFIH0gPSByZXF1aXJlKCcuL2VuZGlhbicpCgpleHBvcnRzLnN0YXRlID0gZnVuY3Rpb24gKHN0YXJ0ID0gMCwgZW5kID0gMCwgYnVmZmVyID0gbnVsbCkgewogIHJldHVybiB7IHN0YXJ0LCBlbmQsIGJ1ZmZlciB9Cn0KCmNvbnN0IHJhdyA9IChleHBvcnRzLnJhdyA9IHJlcXVpcmUoJy4vcmF3JykpCgpjb25zdCB1aW50ID0gKGV4cG9ydHMudWludCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSBuIDw9IDB4ZmMgPyAxIDogbiA8PSAweGZmZmYgPyAzIDogbiA8PSAweGZmZmZmZmZmID8gNSA6IDkKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgaWYgKG4gPD0gMHhmYykgdWludDguZW5jb2RlKHN0YXRlLCBuKQogICAgZWxzZSBpZiAobiA8PSAweGZmZmYpIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZAogICAgICB1aW50MTYuZW5jb2RlKHN0YXRlLCBuKQogICAgfSBlbHNlIGlmIChuIDw9IDB4ZmZmZmZmZmYpIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZQogICAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCBuKQogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZgogICAgICB1aW50NjQuZW5jb2RlKHN0YXRlLCBuKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBhID0gdWludDguZGVjb2RlKHN0YXRlKQogICAgaWYgKGEgPD0gMHhmYykgcmV0dXJuIGEKICAgIGlmIChhID09PSAweGZkKSByZXR1cm4gdWludDE2LmRlY29kZShzdGF0ZSkKICAgIGlmIChhID09PSAweGZlKSByZXR1cm4gdWludDMyLmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB1aW50NjQuZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IHVpbnQ4ID0gKGV4cG9ydHMudWludDggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gMQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLnN0YXJ0ID49IHN0YXRlLmVuZCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICB9Cn0pCgpjb25zdCB1aW50MTYgPSAoZXhwb3J0cy51aW50MTYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gMgogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKyBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMAogIH0KfSkKCmNvbnN0IHVpbnQyNCA9IChleHBvcnRzLnVpbnQyNCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSAzCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gMTYKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMykgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMHgxMDAwMAogICAgKQogIH0KfSkKCmNvbnN0IHVpbnQzMiA9IChleHBvcnRzLnVpbnQzMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHZhbGlkYXRlVWludChuKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gMTYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDI0CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMCArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwMDAKICAgICkKICB9Cn0pCgpjb25zdCB1aW50NDAgPSAoZXhwb3J0cy51aW50NDAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMCkKICAgIHVpbnQ4LmVuY29kZShzdGF0ZSwgbikKICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIHIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDUpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gdWludDguZGVjb2RlKHN0YXRlKSArIDB4MTAwICogdWludDMyLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCB1aW50NDggPSAoZXhwb3J0cy51aW50NDggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNgogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMDAwKQogICAgdWludDE2LmVuY29kZShzdGF0ZSwgbikKICAgIHVpbnQzMi5lbmNvZGUoc3RhdGUsIHIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDYpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gdWludDE2LmRlY29kZShzdGF0ZSkgKyAweDEwMDAwICogdWludDMyLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCB1aW50NTYgPSAoZXhwb3J0cy51aW50NTYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gNwogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICB2YWxpZGF0ZVVpbnQobikKICAgIGNvbnN0IHIgPSBNYXRoLmZsb29yKG4gLyAweDEwMDAwMDApCiAgICB1aW50MjQuZW5jb2RlKHN0YXRlLCBuKQogICAgdWludDMyLmVuY29kZShzdGF0ZSwgcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNykgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiB1aW50MjQuZGVjb2RlKHN0YXRlKSArIDB4MTAwMDAwMCAqIHVpbnQzMi5kZWNvZGUoc3RhdGUpCiAgfQp9KQoKY29uc3QgdWludDY0ID0gKGV4cG9ydHMudWludDY0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgc3RhdGUuZW5kICs9IDgKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgdmFsaWRhdGVVaW50KG4pCiAgICBjb25zdCByID0gTWF0aC5mbG9vcihuIC8gMHgxMDAwMDAwMDApCiAgICB1aW50MzIuZW5jb2RlKHN0YXRlLCBuKQogICAgdWludDMyLmVuY29kZShzdGF0ZSwgcikKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgOCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiB1aW50MzIuZGVjb2RlKHN0YXRlKSArIDB4MTAwMDAwMDAwICogdWludDMyLmRlY29kZShzdGF0ZSkKICB9Cn0pCgpjb25zdCBpbnQgPSAoZXhwb3J0cy5pbnQgPSB6aWdaYWdJbnQodWludCkpCmV4cG9ydHMuaW50OCA9IHppZ1phZ0ludCh1aW50OCkKZXhwb3J0cy5pbnQxNiA9IHppZ1phZ0ludCh1aW50MTYpCmV4cG9ydHMuaW50MjQgPSB6aWdaYWdJbnQodWludDI0KQpleHBvcnRzLmludDMyID0gemlnWmFnSW50KHVpbnQzMikKZXhwb3J0cy5pbnQ0MCA9IHppZ1phZ0ludCh1aW50NDApCmV4cG9ydHMuaW50NDggPSB6aWdaYWdJbnQodWludDQ4KQpleHBvcnRzLmludDU2ID0gemlnWmFnSW50KHVpbnQ1NikKZXhwb3J0cy5pbnQ2NCA9IHppZ1phZ0ludCh1aW50NjQpCgpjb25zdCBiaWd1aW50NjQgPSAoZXhwb3J0cy5iaWd1aW50NjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBzdGF0ZS5lbmQgKz0gOAogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4CiAgICApCiAgICB2aWV3LnNldEJpZ1VpbnQ2NCgwLCBuLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDgpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4CiAgICApCiAgICBjb25zdCBuID0gdmlldy5nZXRCaWdVaW50NjQoMCwgdHJ1ZSkgLy8gbGl0dGxlIGVuZGlhbgogICAgc3RhdGUuc3RhcnQgKz0gOAogICAgcmV0dXJuIG4KICB9Cn0pCgpleHBvcnRzLmJpZ2ludDY0ID0gemlnWmFnQmlnSW50KGJpZ3VpbnQ2NCkKCmNvbnN0IGJpZ3VpbnQgPSAoZXhwb3J0cy5iaWd1aW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgbGV0IGxlbiA9IDAKICAgIGZvciAobGV0IG0gPSBuOyBtOyBtID0gbSA+PiA2NG4pIGxlbisrCiAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgbGVuKQogICAgc3RhdGUuZW5kICs9IDggKiBsZW4KICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgbGV0IGxlbiA9IDAKICAgIGZvciAobGV0IG0gPSBuOyBtOyBtID0gbSA+PiA2NG4pIGxlbisrCiAgICB1aW50LmVuY29kZShzdGF0ZSwgbGVuKQogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOCAqIGxlbgogICAgKQogICAgZm9yIChsZXQgbSA9IG4sIGkgPSAwOyBtOyBtID0gbSA+PiA2NG4sIGkgKz0gOCkgewogICAgICB2aWV3LnNldEJpZ1VpbnQ2NChpLCBCaWdJbnQuYXNVaW50Tig2NCwgbSksIHRydWUpIC8vIGxpdHRsZSBlbmRpYW4KICAgIH0KICAgIHN0YXRlLnN0YXJ0ICs9IDggKiBsZW4KICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA4ICogbGVuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldygKICAgICAgc3RhdGUuYnVmZmVyLmJ1ZmZlciwKICAgICAgc3RhdGUuc3RhcnQgKyBzdGF0ZS5idWZmZXIuYnl0ZU9mZnNldCwKICAgICAgOCAqIGxlbgogICAgKQogICAgbGV0IG4gPSAwbgogICAgZm9yIChsZXQgaSA9IGxlbiAtIDE7IGkgPj0gMDsgaS0tKQogICAgICBuID0gKG4gPDwgNjRuKSArIHZpZXcuZ2V0QmlnVWludDY0KGkgKiA4LCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4ICogbGVuCiAgICByZXR1cm4gbgogIH0KfSkKCmV4cG9ydHMuYmlnaW50ID0gemlnWmFnQmlnSW50KGJpZ3VpbnQpCgpleHBvcnRzLmxleGludCA9IHJlcXVpcmUoJy4vbGV4aW50JykKCmV4cG9ydHMuZmxvYXQzMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDQKICAgICkKICAgIHZpZXcuc2V0RmxvYXQzMigwLCBuLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA0CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA0CiAgICApCiAgICBjb25zdCBmbG9hdCA9IHZpZXcuZ2V0RmxvYXQzMigwLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA0CiAgICByZXR1cm4gZmxvYXQKICB9Cn0KCmV4cG9ydHMuZmxvYXQ2NCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCArPSA4CiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoCiAgICAgIHN0YXRlLmJ1ZmZlci5idWZmZXIsCiAgICAgIHN0YXRlLnN0YXJ0ICsgc3RhdGUuYnVmZmVyLmJ5dGVPZmZzZXQsCiAgICAgIDgKICAgICkKICAgIHZpZXcuc2V0RmxvYXQ2NCgwLCBuLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDgpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KAogICAgICBzdGF0ZS5idWZmZXIuYnVmZmVyLAogICAgICBzdGF0ZS5zdGFydCArIHN0YXRlLmJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgICA4CiAgICApCiAgICBjb25zdCBmbG9hdCA9IHZpZXcuZ2V0RmxvYXQ2NCgwLCB0cnVlKSAvLyBsaXR0bGUgZW5kaWFuCiAgICBzdGF0ZS5zdGFydCArPSA4CiAgICByZXR1cm4gZmxvYXQKICB9Cn0KCmNvbnN0IGJ1ZmZlciA9IChleHBvcnRzLmJ1ZmZlciA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmIChiKSB1aW50OGFycmF5LnByZWVuY29kZShzdGF0ZSwgYikKICAgIGVsc2Ugc3RhdGUuZW5kKysKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKGIpIHVpbnQ4YXJyYXkuZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAwCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIG51bGwKICAgIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGxlbikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBsZW4pKQogIH0KfSkKCmV4cG9ydHMuYmluYXJ5ID0gewogIC4uLmJ1ZmZlciwKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGlmICh0eXBlb2YgYiA9PT0gJ3N0cmluZycpIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBidWZmZXIucHJlZW5jb2RlKHN0YXRlLCBiKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAodHlwZW9mIGIgPT09ICdzdHJpbmcnKSB1dGY4LmVuY29kZShzdGF0ZSwgYikKICAgIGVsc2UgYnVmZmVyLmVuY29kZShzdGF0ZSwgYikKICB9Cn0KCmV4cG9ydHMuYXJyYXlidWZmZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgYi5ieXRlTGVuZ3RoKQogICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICB1aW50LmVuY29kZShzdGF0ZSwgYi5ieXRlTGVuZ3RoKQoKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShiKQoKICAgIHN0YXRlLmJ1ZmZlci5zZXQodmlldywgc3RhdGUuc3RhcnQpCiAgICBzdGF0ZS5zdGFydCArPSBiLmJ5dGVMZW5ndGgKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgYiA9IG5ldyBBcnJheUJ1ZmZlcihsZW4pCiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICB2aWV3LnNldChzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIChzdGF0ZS5zdGFydCArPSBsZW4pKSkKCiAgICByZXR1cm4gYgogIH0KfQoKZnVuY3Rpb24gdHlwZWRhcnJheShUeXBlZEFycmF5LCBzd2FwKSB7CiAgY29uc3QgbiA9IFR5cGVkQXJyYXkuQllURVNfUEVSX0VMRU1FTlQKCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCiAgICAgIHN0YXRlLmVuZCArPSBiLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgICAgdWludC5lbmNvZGUoc3RhdGUsIGIubGVuZ3RoKQoKICAgICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGIuYnVmZmVyLCBiLmJ5dGVPZmZzZXQsIGIuYnl0ZUxlbmd0aCkKCiAgICAgIGlmIChCRSAmJiBzd2FwKSBzd2FwKHZpZXcpCgogICAgICBzdGF0ZS5idWZmZXIuc2V0KHZpZXcsIHN0YXRlLnN0YXJ0KQogICAgICBzdGF0ZS5zdGFydCArPSBiLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCgogICAgICBsZXQgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCwgKHN0YXRlLnN0YXJ0ICs9IGxlbiAqIG4pKQogICAgICBpZiAoYi5ieXRlTGVuZ3RoICE9PSBsZW4gKiBuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICBpZiAoYi5ieXRlT2Zmc2V0ICUgbiAhPT0gMCkgYiA9IG5ldyBVaW50OEFycmF5KGIpCgogICAgICBpZiAoQkUgJiYgc3dhcCkgc3dhcChiKQoKICAgICAgcmV0dXJuIG5ldyBUeXBlZEFycmF5KGIuYnVmZmVyLCBiLmJ5dGVPZmZzZXQsIGIuYnl0ZUxlbmd0aCAvIG4pCiAgICB9CiAgfQp9Cgpjb25zdCB1aW50OGFycmF5ID0gKGV4cG9ydHMudWludDhhcnJheSA9IHR5cGVkYXJyYXkoVWludDhBcnJheSkpCmV4cG9ydHMudWludDE2YXJyYXkgPSB0eXBlZGFycmF5KFVpbnQxNkFycmF5LCBiNGEuc3dhcDE2KQpleHBvcnRzLnVpbnQzMmFycmF5ID0gdHlwZWRhcnJheShVaW50MzJBcnJheSwgYjRhLnN3YXAzMikKCmV4cG9ydHMuaW50OGFycmF5ID0gdHlwZWRhcnJheShJbnQ4QXJyYXkpCmV4cG9ydHMuaW50MTZhcnJheSA9IHR5cGVkYXJyYXkoSW50MTZBcnJheSwgYjRhLnN3YXAxNikKZXhwb3J0cy5pbnQzMmFycmF5ID0gdHlwZWRhcnJheShJbnQzMkFycmF5LCBiNGEuc3dhcDMyKQoKZXhwb3J0cy5iaWd1aW50NjRhcnJheSA9IHR5cGVkYXJyYXkoQmlnVWludDY0QXJyYXksIGI0YS5zd2FwNjQpCmV4cG9ydHMuYmlnaW50NjRhcnJheSA9IHR5cGVkYXJyYXkoQmlnSW50NjRBcnJheSwgYjRhLnN3YXA2NCkKCmV4cG9ydHMuZmxvYXQzMmFycmF5ID0gdHlwZWRhcnJheShGbG9hdDMyQXJyYXksIGI0YS5zd2FwMzIpCmV4cG9ydHMuZmxvYXQ2NGFycmF5ID0gdHlwZWRhcnJheShGbG9hdDY0QXJyYXksIGI0YS5zd2FwNjQpCgpmdW5jdGlvbiBzdHJpbmcoZW5jb2RpbmcpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIGNvbnN0IGxlbiA9IGI0YS5ieXRlTGVuZ3RoKHMsIGVuY29kaW5nKQogICAgICB1aW50LnByZWVuY29kZShzdGF0ZSwgbGVuKQogICAgICBzdGF0ZS5lbmQgKz0gbGVuCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIGNvbnN0IGxlbiA9IGI0YS5ieXRlTGVuZ3RoKHMsIGVuY29kaW5nKQogICAgICB1aW50LmVuY29kZShzdGF0ZSwgbGVuKQogICAgICBiNGEud3JpdGUoc3RhdGUuYnVmZmVyLCBzLCBzdGF0ZS5zdGFydCwgZW5jb2RpbmcpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IGxlbgogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbGVuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICByZXR1cm4gYjRhLnRvU3RyaW5nKAogICAgICAgIHN0YXRlLmJ1ZmZlciwKICAgICAgICBlbmNvZGluZywKICAgICAgICBzdGF0ZS5zdGFydCwKICAgICAgICAoc3RhdGUuc3RhcnQgKz0gbGVuKQogICAgICApCiAgICB9LAogICAgZml4ZWQobikgewogICAgICByZXR1cm4gewogICAgICAgIHByZWVuY29kZShzdGF0ZSkgewogICAgICAgICAgc3RhdGUuZW5kICs9IG4KICAgICAgICB9LAogICAgICAgIGVuY29kZShzdGF0ZSwgcykgewogICAgICAgICAgYjRhLndyaXRlKHN0YXRlLmJ1ZmZlciwgcywgc3RhdGUuc3RhcnQsIG4sIGVuY29kaW5nKQogICAgICAgICAgc3RhdGUuc3RhcnQgKz0gbgogICAgICAgIH0sCiAgICAgICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgICAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICAgICAgcmV0dXJuIGI0YS50b1N0cmluZygKICAgICAgICAgICAgc3RhdGUuYnVmZmVyLAogICAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgICAgc3RhdGUuc3RhcnQsCiAgICAgICAgICAgIChzdGF0ZS5zdGFydCArPSBuKQogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfQoKY29uc3QgdXRmOCA9IChleHBvcnRzLnN0cmluZyA9IGV4cG9ydHMudXRmOCA9IHN0cmluZygndXRmLTgnKSkKZXhwb3J0cy5hc2NpaSA9IHN0cmluZygnYXNjaWknKQpleHBvcnRzLmhleCA9IHN0cmluZygnaGV4JykKZXhwb3J0cy5iYXNlNjQgPSBzdHJpbmcoJ2Jhc2U2NCcpCmV4cG9ydHMudWNzMiA9IGV4cG9ydHMudXRmMTZsZSA9IHN0cmluZygndXRmMTZsZScpCgpleHBvcnRzLmJvb2wgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5lbmQrKwogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBiID8gMSA6IDAKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLnN0YXJ0ID49IHN0YXRlLmVuZCkgdGhyb3cgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9PT0gMQogIH0KfQoKY29uc3QgZml4ZWQgPSAoZXhwb3J0cy5maXhlZCA9IGZ1bmN0aW9uIGZpeGVkKG4pIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICAgIGlmIChzLmJ5dGVMZW5ndGggIT09IG4pIHRocm93IG5ldyBFcnJvcignSW5jb3JyZWN0IGJ1ZmZlciBzaXplJykKICAgICAgc3RhdGUuZW5kICs9IG4KICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgc3RhdGUuYnVmZmVyLnNldChzLCBzdGF0ZS5zdGFydCkKICAgICAgc3RhdGUuc3RhcnQgKz0gbgogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCBuKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCAoc3RhdGUuc3RhcnQgKz0gbikpCiAgICB9CiAgfQp9KQoKZXhwb3J0cy5maXhlZDMyID0gZml4ZWQoMzIpCmV4cG9ydHMuZml4ZWQ2NCA9IGZpeGVkKDY0KQoKZXhwb3J0cy5hcnJheSA9IGZ1bmN0aW9uIGFycmF5KGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIGxpc3QpIHsKICAgICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGxpc3QubGVuZ3RoKQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGVuYy5wcmVlbmNvZGUoc3RhdGUsIGxpc3RbaV0pCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBsaXN0KSB7CiAgICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBsaXN0Lmxlbmd0aCkKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSBlbmMuZW5jb2RlKHN0YXRlLCBsaXN0W2ldKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgICAgaWYgKGxlbiA+IDB4MTAwMDAwKSB0aHJvdyBuZXcgRXJyb3IoJ0FycmF5IGlzIHRvbyBiaWcnKQogICAgICBjb25zdCBhcnIgPSBuZXcgQXJyYXkobGVuKQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSBhcnJbaV0gPSBlbmMuZGVjb2RlKHN0YXRlKQogICAgICByZXR1cm4gYXJyCiAgICB9CiAgfQp9CgpleHBvcnRzLmZyYW1lID0gZnVuY3Rpb24gZnJhbWUoZW5jKSB7CiAgY29uc3QgZHVtbXkgPSBleHBvcnRzLnN0YXRlKCkKCiAgcmV0dXJuIHsKICAgIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgICBjb25zdCBlbmQgPSBzdGF0ZS5lbmQKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICAgICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIHN0YXRlLmVuZCAtIGVuZCkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgZHVtbXkuZW5kID0gMAogICAgICBlbmMucHJlZW5jb2RlKGR1bW15LCBtKQogICAgICB1aW50LmVuY29kZShzdGF0ZSwgZHVtbXkuZW5kKQogICAgICBlbmMuZW5jb2RlKHN0YXRlLCBtKQogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBjb25zdCBlbmQgPSBzdGF0ZS5lbmQKICAgICAgY29uc3QgbGVuID0gdWludC5kZWNvZGUoc3RhdGUpCiAgICAgIHN0YXRlLmVuZCA9IHN0YXRlLnN0YXJ0ICsgbGVuCiAgICAgIGNvbnN0IG0gPSBlbmMuZGVjb2RlKHN0YXRlKQogICAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgICBzdGF0ZS5lbmQgPSBlbmQKICAgICAgcmV0dXJuIG0KICAgIH0KICB9Cn0KCmV4cG9ydHMuZGF0ZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGQpIHsKICAgIGludC5wcmVlbmNvZGUoc3RhdGUsIGQuZ2V0VGltZSgpKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBkKSB7CiAgICBpbnQuZW5jb2RlKHN0YXRlLCBkLmdldFRpbWUoKSkKICB9LAogIGRlY29kZShzdGF0ZSwgZCkgewogICAgcmV0dXJuIG5ldyBEYXRlKGludC5kZWNvZGUoc3RhdGUpKQogIH0KfQoKZXhwb3J0cy5qc29uID0gewogIHByZWVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB2KSB7CiAgICB1dGY4LmVuY29kZShzdGF0ZSwgSlNPTi5zdHJpbmdpZnkodikpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKHV0ZjguZGVjb2RlKHN0YXRlKSkKICB9Cn0KCmV4cG9ydHMubmRqc29uID0gewogIHByZWVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5wcmVlbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpICsgJ1xuJykKICB9LAogIGVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5lbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpICsgJ1xuJykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIEpTT04ucGFyc2UodXRmOC5kZWNvZGUoc3RhdGUpKQogIH0KfQoKLy8gc2ltcGxlIGhlbHBlciBmb3Igd2hlbiB5b3Ugd2FudCB0byBqdXN0IGV4cHJlc3Mgbm90aGluZwpleHBvcnRzLm5vbmUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICAvLyBkbyBub3RoaW5nCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIC8vIGRvIG5vdGhpbmcKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIG51bGwKICB9Cn0KCi8vICJhbnkiIGVuY29kZXJzIGhlcmUgZm9yIGhlbHBpbmcganVzdCBzdHJ1Y3R1cmUgYW55IG9iamVjdCB3aXRob3V0IHNjaGVtYXRpc2luZyBpdAoKY29uc3QgYW55QXJyYXkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBhcnIpIHsKICAgIHVpbnQucHJlZW5jb2RlKHN0YXRlLCBhcnIubGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgYW55LnByZWVuY29kZShzdGF0ZSwgYXJyW2ldKQogICAgfQogIH0sCiAgZW5jb2RlKHN0YXRlLCBhcnIpIHsKICAgIHVpbnQuZW5jb2RlKHN0YXRlLCBhcnIubGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgYW55LmVuY29kZShzdGF0ZSwgYXJyW2ldKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBhcnIgPSBbXQogICAgbGV0IGxlbiA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgd2hpbGUgKGxlbi0tID4gMCkgewogICAgICBhcnIucHVzaChhbnkuZGVjb2RlKHN0YXRlKSkKICAgIH0KICAgIHJldHVybiBhcnIKICB9Cn0KCmNvbnN0IGFueU9iamVjdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG8pIHsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvKQogICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIGtleXMubGVuZ3RoKQogICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICB1dGY4LnByZWVuY29kZShzdGF0ZSwga2V5KQogICAgICBhbnkucHJlZW5jb2RlKHN0YXRlLCBvW2tleV0pCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG8pIHsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvKQogICAgdWludC5lbmNvZGUoc3RhdGUsIGtleXMubGVuZ3RoKQogICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICB1dGY4LmVuY29kZShzdGF0ZSwga2V5KQogICAgICBhbnkuZW5jb2RlKHN0YXRlLCBvW2tleV0pCiAgICB9CiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGxldCBsZW4gPSB1aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IG8gPSB7fQogICAgd2hpbGUgKGxlbi0tID4gMCkgewogICAgICBjb25zdCBrZXkgPSB1dGY4LmRlY29kZShzdGF0ZSkKICAgICAgb1trZXldID0gYW55LmRlY29kZShzdGF0ZSkKICAgIH0KICAgIHJldHVybiBvCiAgfQp9Cgpjb25zdCBhbnlUeXBlcyA9IFsKICBleHBvcnRzLm5vbmUsCiAgZXhwb3J0cy5ib29sLAogIGV4cG9ydHMuc3RyaW5nLAogIGV4cG9ydHMuYnVmZmVyLAogIGV4cG9ydHMudWludCwKICBleHBvcnRzLmludCwKICBleHBvcnRzLmZsb2F0NjQsCiAgYW55QXJyYXksCiAgYW55T2JqZWN0LAogIGV4cG9ydHMuZGF0ZQpdCgpjb25zdCBhbnkgPSAoZXhwb3J0cy5hbnkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBvKSB7CiAgICBjb25zdCB0ID0gZ2V0VHlwZShvKQogICAgdWludC5wcmVlbmNvZGUoc3RhdGUsIHQpCiAgICBhbnlUeXBlc1t0XS5wcmVlbmNvZGUoc3RhdGUsIG8pCiAgfSwKICBlbmNvZGUoc3RhdGUsIG8pIHsKICAgIGNvbnN0IHQgPSBnZXRUeXBlKG8pCiAgICB1aW50LmVuY29kZShzdGF0ZSwgdCkKICAgIGFueVR5cGVzW3RdLmVuY29kZShzdGF0ZSwgbykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdCA9IHVpbnQuZGVjb2RlKHN0YXRlKQogICAgaWYgKHQgPj0gYW55VHlwZXMubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHlwZTogJyArIHQpCiAgICByZXR1cm4gYW55VHlwZXNbdF0uZGVjb2RlKHN0YXRlKQogIH0KfSkKCmNvbnN0IHBvcnQgPSAoZXhwb3J0cy5wb3J0ID0gdWludDE2KQoKY29uc3QgYWRkcmVzcyA9IChob3N0LCBmYW1pbHkpID0+IHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIGhvc3QucHJlZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICAgIHBvcnQucHJlZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIGhvc3QuZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICAgIHBvcnQuZW5jb2RlKHN0YXRlLCBtLnBvcnQpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgaG9zdDogaG9zdC5kZWNvZGUoc3RhdGUpLAogICAgICAgIGZhbWlseSwKICAgICAgICBwb3J0OiBwb3J0LmRlY29kZShzdGF0ZSkKICAgICAgfQogICAgfQogIH0KfQoKY29uc3QgaXB2NCA9IChleHBvcnRzLmlwdjQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlKSB7CiAgICBzdGF0ZS5lbmQgKz0gNAogIH0sCiAgZW5jb2RlKHN0YXRlLCBzdHJpbmcpIHsKICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgNAoKICAgIGxldCBpID0gMAoKICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCkgewogICAgICBsZXQgbiA9IDAKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlICgKICAgICAgICBpIDwgc3RyaW5nLmxlbmd0aCAmJgogICAgICAgIChjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSsrKSkgIT09IC8qIC4gKi8gMHgyZQogICAgICApIHsKICAgICAgICBuID0gbiAqIDEwICsgKGMgLSAvKiAwICovIDB4MzApCiAgICAgIH0KCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIH0KCiAgICBzdGF0ZS5zdGFydCA9IGVuZAogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQgPCA0KSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogICAgcmV0dXJuICgKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsKICAgICAgJy4nICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICApCiAgfQp9KQoKZXhwb3J0cy5pcHY0QWRkcmVzcyA9IGFkZHJlc3MoaXB2NCwgNCkKCmNvbnN0IGlwdjYgPSAoZXhwb3J0cy5pcHY2ID0gewogIHByZWVuY29kZShzdGF0ZSkgewogICAgc3RhdGUuZW5kICs9IDE2CiAgfSwKICBlbmNvZGUoc3RhdGUsIHN0cmluZykgewogICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogICAgY29uc3QgZW5kID0gc3RhcnQgKyAxNgoKICAgIGxldCBpID0gMAogICAgbGV0IHNwbGl0ID0gbnVsbAoKICAgIHdoaWxlIChpIDwgc3RyaW5nLmxlbmd0aCkgewogICAgICBsZXQgbiA9IDAKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlICgKICAgICAgICBpIDwgc3RyaW5nLmxlbmd0aCAmJgogICAgICAgIChjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSsrKSkgIT09IC8qIDogKi8gMHgzYQogICAgICApIHsKICAgICAgICBpZiAoYyA+PSAweDMwICYmIGMgPD0gMHgzOSkgbiA9IG4gKiAweDEwICsgKGMgLSAvKiAwICovIDB4MzApCiAgICAgICAgZWxzZSBpZiAoYyA+PSAweDQxICYmIGMgPD0gMHg0NikgbiA9IG4gKiAweDEwICsgKGMgLSAvKiBBICovIDB4NDEgKyAxMCkKICAgICAgICBlbHNlIGlmIChjID49IDB4NjEgJiYgYyA8PSAweDY2KSBuID0gbiAqIDB4MTAgKyAoYyAtIC8qIGEgKi8gMHg2MSArIDEwKQogICAgICB9CgogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiA4CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KCiAgICAgIGlmIChpIDwgc3RyaW5nLmxlbmd0aCAmJiBzdHJpbmcuY2hhckNvZGVBdChpKSA9PT0gLyogOiAqLyAweDNhKSB7CiAgICAgICAgaSsrCiAgICAgICAgc3BsaXQgPSBzdGF0ZS5zdGFydAogICAgICB9CiAgICB9CgogICAgaWYgKHNwbGl0ICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IG9mZnNldCA9IGVuZCAtIHN0YXRlLnN0YXJ0CiAgICAgIHN0YXRlLmJ1ZmZlcgogICAgICAgIC5jb3B5V2l0aGluKHNwbGl0ICsgb2Zmc2V0LCBzcGxpdCkKICAgICAgICAuZmlsbCgwLCBzcGxpdCwgc3BsaXQgKyBvZmZzZXQpCiAgICB9CgogICAgc3RhdGUuc3RhcnQgPSBlbmQKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMTYpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgICByZXR1cm4gKAogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikgKwogICAgICAnOicgKwogICAgICAoCiAgICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICogMjU2ICsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KICAgICAgKS50b1N0cmluZygxNikKICAgICkKICB9Cn0pCgpleHBvcnRzLmlwdjZBZGRyZXNzID0gYWRkcmVzcyhpcHY2LCA2KQoKY29uc3QgaXAgPSAoZXhwb3J0cy5pcCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHN0cmluZykgewogICAgY29uc3QgZmFtaWx5ID0gc3RyaW5nLmluY2x1ZGVzKCc6JykgPyA2IDogNAogICAgdWludDgucHJlZW5jb2RlKHN0YXRlLCBmYW1pbHkpCiAgICBpZiAoZmFtaWx5ID09PSA0KSBpcHY0LnByZWVuY29kZShzdGF0ZSkKICAgIGVsc2UgaXB2Ni5wcmVlbmNvZGUoc3RhdGUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHN0cmluZykgewogICAgY29uc3QgZmFtaWx5ID0gc3RyaW5nLmluY2x1ZGVzKCc6JykgPyA2IDogNAogICAgdWludDguZW5jb2RlKHN0YXRlLCBmYW1pbHkpCiAgICBpZiAoZmFtaWx5ID09PSA0KSBpcHY0LmVuY29kZShzdGF0ZSwgc3RyaW5nKQogICAgZWxzZSBpcHY2LmVuY29kZShzdGF0ZSwgc3RyaW5nKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmYW1pbHkgPSB1aW50OC5kZWNvZGUoc3RhdGUpCiAgICBpZiAoZmFtaWx5ID09PSA0KSByZXR1cm4gaXB2NC5kZWNvZGUoc3RhdGUpCiAgICBlbHNlIHJldHVybiBpcHY2LmRlY29kZShzdGF0ZSkKICB9Cn0pCgpleHBvcnRzLmlwQWRkcmVzcyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGlwLnByZWVuY29kZShzdGF0ZSwgbS5ob3N0KQogICAgcG9ydC5wcmVlbmNvZGUoc3RhdGUsIG0ucG9ydCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaXAuZW5jb2RlKHN0YXRlLCBtLmhvc3QpCiAgICBwb3J0LmVuY29kZShzdGF0ZSwgbS5wb3J0KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmYW1pbHkgPSB1aW50OC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBob3N0OiBmYW1pbHkgPT09IDQgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBpcHY2LmRlY29kZShzdGF0ZSksCiAgICAgIGZhbWlseSwKICAgICAgcG9ydDogcG9ydC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBnZXRUeXBlKG8pIHsKICBpZiAobyA9PT0gbnVsbCB8fCBvID09PSB1bmRlZmluZWQpIHJldHVybiAwCiAgaWYgKHR5cGVvZiBvID09PSAnYm9vbGVhbicpIHJldHVybiAxCiAgaWYgKHR5cGVvZiBvID09PSAnc3RyaW5nJykgcmV0dXJuIDIKICBpZiAoYjRhLmlzQnVmZmVyKG8pKSByZXR1cm4gMwogIGlmICh0eXBlb2YgbyA9PT0gJ251bWJlcicpIHsKICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKG8pKSByZXR1cm4gbyA+PSAwID8gNCA6IDUKICAgIHJldHVybiA2CiAgfQogIGlmIChBcnJheS5pc0FycmF5KG8pKSByZXR1cm4gNwogIGlmIChvIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIDkKICBpZiAodHlwZW9mIG8gPT09ICdvYmplY3QnKSByZXR1cm4gOAoKICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHR5cGUgZm9yICcgKyBvKQp9CgpleHBvcnRzLmZyb20gPSBmdW5jdGlvbiBmcm9tKGVuYykgewogIGlmICh0eXBlb2YgZW5jID09PSAnc3RyaW5nJykgcmV0dXJuIGZyb21OYW1lZChlbmMpCiAgaWYgKGVuYy5wcmVlbmNvZGUpIHJldHVybiBlbmMKICBpZiAoZW5jLmVuY29kaW5nTGVuZ3RoKSByZXR1cm4gZnJvbUFic3RyYWN0RW5jb2RlcihlbmMpCiAgcmV0dXJuIGZyb21Db2RlYyhlbmMpCn0KCmZ1bmN0aW9uIGZyb21OYW1lZChlbmMpIHsKICBzd2l0Y2ggKGVuYykgewogICAgY2FzZSAnYXNjaWknOgogICAgICByZXR1cm4gcmF3LmFzY2lpCiAgICBjYXNlICd1dGYtOCc6CiAgICBjYXNlICd1dGY4JzoKICAgICAgcmV0dXJuIHJhdy51dGY4CiAgICBjYXNlICdoZXgnOgogICAgICByZXR1cm4gcmF3LmhleAogICAgY2FzZSAnYmFzZTY0JzoKICAgICAgcmV0dXJuIHJhdy5iYXNlNjQKICAgIGNhc2UgJ3V0ZjE2LWxlJzoKICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndWNzMic6CiAgICAgIHJldHVybiByYXcudWNzMgogICAgY2FzZSAnbmRqc29uJzoKICAgICAgcmV0dXJuIHJhdy5uZGpzb24KICAgIGNhc2UgJ2pzb24nOgogICAgICByZXR1cm4gcmF3Lmpzb24KICAgIGNhc2UgJ2JpbmFyeSc6CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gcmF3LmJpbmFyeQogIH0KfQoKZnVuY3Rpb24gZnJvbUNvZGVjKGVuYykgewogIGxldCB0bXBNID0gbnVsbAogIGxldCB0bXBCdWYgPSBudWxsCgogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdG1wTSA9IG0KICAgICAgdG1wQnVmID0gZW5jLmVuY29kZShtKQogICAgICBzdGF0ZS5lbmQgKz0gdG1wQnVmLmJ5dGVMZW5ndGgKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgcmF3LmVuY29kZShzdGF0ZSwgbSA9PT0gdG1wTSA/IHRtcEJ1ZiA6IGVuYy5lbmNvZGUobSkpCiAgICAgIHRtcE0gPSB0bXBCdWYgPSBudWxsCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiBlbmMuZGVjb2RlKHJhdy5kZWNvZGUoc3RhdGUpKQogICAgfQogIH0KfQoKZnVuY3Rpb24gZnJvbUFic3RyYWN0RW5jb2RlcihlbmMpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHN0YXRlLmVuZCArPSBlbmMuZW5jb2RpbmdMZW5ndGgobSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgZW5jLmVuY29kZShtLCBzdGF0ZS5idWZmZXIsIHN0YXRlLnN0YXJ0KQogICAgICBzdGF0ZS5zdGFydCArPSBlbmMuZW5jb2RlLmJ5dGVzCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IG0gPSBlbmMuZGVjb2RlKHN0YXRlLmJ1ZmZlciwgc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKICAgICAgc3RhdGUuc3RhcnQgKz0gZW5jLmRlY29kZS5ieXRlcwogICAgICByZXR1cm4gbQogICAgfQogIH0KfQoKZXhwb3J0cy5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUoZW5jLCBtKSB7CiAgY29uc3Qgc3RhdGUgPSBleHBvcnRzLnN0YXRlKCkKICBlbmMucHJlZW5jb2RlKHN0YXRlLCBtKQogIHN0YXRlLmJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShzdGF0ZS5lbmQpCiAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KCmV4cG9ydHMuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKGVuYywgYnVmZmVyKSB7CiAgcmV0dXJuIGVuYy5kZWNvZGUoZXhwb3J0cy5zdGF0ZSgwLCBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyKSkKfQoKZnVuY3Rpb24gemlnWmFnSW50KGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgemlnWmFnRW5jb2RlSW50KG4pKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbikgewogICAgICBlbmMuZW5jb2RlKHN0YXRlLCB6aWdaYWdFbmNvZGVJbnQobikpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiB6aWdaYWdEZWNvZGVJbnQoZW5jLmRlY29kZShzdGF0ZSkpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiB6aWdaYWdEZWNvZGVJbnQobikgewogIHJldHVybiBuID09PSAwID8gbiA6IChuICYgMSkgPT09IDAgPyBuIC8gMiA6IC0obiArIDEpIC8gMgp9CgpmdW5jdGlvbiB6aWdaYWdFbmNvZGVJbnQobikgewogIC8vIDAsIC0xLCAxLCAtMiwgMiwgLi4uCiAgcmV0dXJuIG4gPCAwID8gMiAqIC1uIC0gMSA6IG4gPT09IDAgPyAwIDogMiAqIG4KfQoKZnVuY3Rpb24gemlnWmFnQmlnSW50KGVuYykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgemlnWmFnRW5jb2RlQmlnSW50KG4pKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgbikgewogICAgICBlbmMuZW5jb2RlKHN0YXRlLCB6aWdaYWdFbmNvZGVCaWdJbnQobikpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHJldHVybiB6aWdaYWdEZWNvZGVCaWdJbnQoZW5jLmRlY29kZShzdGF0ZSkpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiB6aWdaYWdEZWNvZGVCaWdJbnQobikgewogIHJldHVybiBuID09PSAwbiA/IG4gOiAobiAmIDFuKSA9PT0gMG4gPyBuIC8gMm4gOiAtKG4gKyAxbikgLyAybgp9CgpmdW5jdGlvbiB6aWdaYWdFbmNvZGVCaWdJbnQobikgewogIC8vIDAsIC0xLCAxLCAtMiwgMiwgLi4uCiAgcmV0dXJuIG4gPCAwbiA/IDJuICogLW4gLSAxbiA6IG4gPT09IDBuID8gMG4gOiAybiAqIG4KfQoKZnVuY3Rpb24gdmFsaWRhdGVVaW50KG4pIHsKICBpZiAobiA+PSAwID09PSBmYWxzZSAvKiBIYW5kbGVzIE5hTiBhcyB3ZWxsICovKQogICAgdGhyb3cgbmV3IEVycm9yKCd1aW50IG11c3QgYmUgcG9zaXRpdmUnKQp9Cm1vZHVsZS5leHBvcnRzID0gewogIHByZWVuY29kZSwKICBlbmNvZGUsCiAgZGVjb2RlCn0KCmZ1bmN0aW9uIHByZWVuY29kZShzdGF0ZSwgbnVtKSB7CiAgaWYgKG51bSA8IDI1MSkgewogICAgc3RhdGUuZW5kKysKICB9IGVsc2UgaWYgKG51bSA8IDI1NikgewogICAgc3RhdGUuZW5kICs9IDIKICB9IGVsc2UgaWYgKG51bSA8IDB4MTAwMDApIHsKICAgIHN0YXRlLmVuZCArPSAzCiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwMDApIHsKICAgIHN0YXRlLmVuZCArPSA0CiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwMDAwMCkgewogICAgc3RhdGUuZW5kICs9IDUKICB9IGVsc2UgewogICAgc3RhdGUuZW5kKysKICAgIGNvbnN0IGV4cCA9IE1hdGguZmxvb3IoTWF0aC5sb2cobnVtKSAvIE1hdGgubG9nKDIpKSAtIDMyCiAgICBwcmVlbmNvZGUoc3RhdGUsIGV4cCkKICAgIHN0YXRlLmVuZCArPSA2CiAgfQp9CgpmdW5jdGlvbiBlbmNvZGUoc3RhdGUsIG51bSkgewogIGNvbnN0IG1heCA9IDI1MQogIGNvbnN0IHggPSBudW0gLSBtYXgKCiAgaWYgKG51bSA8IG1heCkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbnVtCiAgfSBlbHNlIGlmIChudW0gPCAyNTYpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG1heAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geAogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMCkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbWF4ICsgMQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHggPj4gOCkgJiAweGZmCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ICYgMHhmZgogIH0gZWxzZSBpZiAobnVtIDwgMHgxMDAwMDAwKSB7CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBtYXggKyAyCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ID4+IDE2CiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAoeCA+PiA4KSAmIDB4ZmYKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IHggJiAweGZmCiAgfSBlbHNlIGlmIChudW0gPCAweDEwMDAwMDAwMCkgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbWF4ICsgMwogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0geCA+PiAyNAogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHggPj4gMTYpICYgMHhmZgogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gKHggPj4gOCkgJiAweGZmCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSB4ICYgMHhmZgogIH0gZWxzZSB7CiAgICAvLyBuZWVkIHRvIHVzZSBNYXRoIGhlcmUgYXMgYml0d2lzZSBvcHMgYXJlIDMyIGJpdAogICAgY29uc3QgZXhwID0gTWF0aC5mbG9vcihNYXRoLmxvZyh4KSAvIE1hdGgubG9nKDIpKSAtIDMyCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweGZmCgogICAgZW5jb2RlKHN0YXRlLCBleHApCiAgICBjb25zdCByZW0gPSB4IC8gTWF0aC5wb3coMiwgZXhwIC0gMTEpCgogICAgZm9yIChsZXQgaSA9IDU7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IChyZW0gLyBNYXRoLnBvdygyLCA4ICogaSkpICYgMHhmZgogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVjb2RlKHN0YXRlKSB7CiAgY29uc3QgbWF4ID0gMjUxCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDEpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCgogIGNvbnN0IGZsYWcgPSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10KCiAgaWYgKGZsYWcgPCBtYXgpIHJldHVybiBmbGFnCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGZsYWcgLSBtYXggKyAxKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMuJykKICB9CgogIGlmIChmbGFnIDwgMjUyKSB7CiAgICByZXR1cm4gc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdICsgbWF4CiAgfQoKICBpZiAoZmxhZyA8IDI1MykgewogICAgcmV0dXJuICgKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA8PCA4KSArIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArIG1heAogICAgKQogIH0KCiAgaWYgKGZsYWcgPCAyNTQpIHsKICAgIHJldHVybiAoCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPDwgMTYpICsKICAgICAgKHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA8PCA4KSArCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSArCiAgICAgIG1heAogICAgKQogIH0KCiAgLy8gPDwgMjQgcmVzdWx0IG1heSBiZSBpbnRlcnByZXRlZCBhcyBuZWdhdGl2ZQogIGlmIChmbGFnIDwgMjU1KSB7CiAgICByZXR1cm4gKAogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwMDAgKwogICAgICAoc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdIDw8IDE2KSArCiAgICAgIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPDwgOCkgKwogICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKwogICAgICBtYXgKICAgICkKICB9CgogIGNvbnN0IGV4cCA9IGRlY29kZShzdGF0ZSkKCiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgNikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgbGV0IHJlbSA9IDAKICBmb3IgKGxldCBpID0gNTsgaSA+PSAwOyBpLS0pIHsKICAgIHJlbSArPSBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiBNYXRoLnBvdygyLCA4ICogaSkKICB9CgogIHJldHVybiByZW0gKiBNYXRoLnBvdygyLCBleHAgLSAxMSkgKyBtYXgKfQp7CiAgIm5hbWUiOiAiY29tcGFjdC1lbmNvZGluZyIsCiAgInZlcnNpb24iOiAiMi4xOC4wIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzZXJpZXMgb2YgY29tcGFjdCBlbmNvZGluZyBzY2hlbWVzIGZvciBidWlsZGluZyBzbWFsbCBhbmQgZmFzdCBwYXJzZXJzIGFuZCBzZXJpYWxpemVycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjMuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMS4wLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLiAtLXdyaXRlIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jb21wYWN0LWVuY29kaW5nL2NvbXBhY3QtZW5jb2RpbmcuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NvbXBhY3QtZW5jb2RpbmcvY29tcGFjdC1lbmNvZGluZyIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgeyBCRSB9ID0gcmVxdWlyZSgnLi9lbmRpYW4nKQoKZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBzdGF0ZS5idWZmZXIuc2V0KGIsIHN0YXRlLnN0YXJ0KQogICAgc3RhdGUuc3RhcnQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCiAgICByZXR1cm4gYgogIH0KfQoKY29uc3QgYnVmZmVyID0gKGV4cG9ydHMuYnVmZmVyID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKGIpIHVpbnQ4YXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiKQogICAgZWxzZSBzdGF0ZS5lbmQrKwogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAoYikgdWludDhhcnJheS5lbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkKICAgIGlmIChiLmJ5dGVMZW5ndGggPT09IDApIHJldHVybiBudWxsCiAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgcmV0dXJuIGIKICB9Cn0pCgpleHBvcnRzLmJpbmFyeSA9IHsKICAuLi5idWZmZXIsCiAgcHJlZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBpZiAodHlwZW9mIGIgPT09ICdzdHJpbmcnKSB1dGY4LnByZWVuY29kZShzdGF0ZSwgYikKICAgIGVsc2UgYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgYikKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgaWYgKHR5cGVvZiBiID09PSAnc3RyaW5nJykgdXRmOC5lbmNvZGUoc3RhdGUsIGIpCiAgICBlbHNlIGJ1ZmZlci5lbmNvZGUoc3RhdGUsIGIpCiAgfQp9CgpleHBvcnRzLmFycmF5YnVmZmVyID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICBzdGF0ZS5idWZmZXIuc2V0KHZpZXcsIHN0YXRlLnN0YXJ0KQogICAgc3RhdGUuc3RhcnQgKz0gYi5ieXRlTGVuZ3RoCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGIgPSBuZXcgQXJyYXlCdWZmZXIoc3RhdGUuZW5kIC0gc3RhdGUuc3RhcnQpCiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYikKCiAgICB2aWV3LnNldChzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQpKQoKICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCgogICAgcmV0dXJuIGIKICB9Cn0KCmZ1bmN0aW9uIHR5cGVkYXJyYXkoVHlwZWRBcnJheSwgc3dhcCkgewogIGNvbnN0IG4gPSBUeXBlZEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UCgogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgICAgc3RhdGUuZW5kICs9IGIuYnl0ZUxlbmd0aAogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgYikgewogICAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYi5idWZmZXIsIGIuYnl0ZU9mZnNldCwgYi5ieXRlTGVuZ3RoKQoKICAgICAgaWYgKEJFICYmIHN3YXApIHN3YXAodmlldykKCiAgICAgIHN0YXRlLmJ1ZmZlci5zZXQodmlldywgc3RhdGUuc3RhcnQpCiAgICAgIHN0YXRlLnN0YXJ0ICs9IGIuYnl0ZUxlbmd0aAogICAgfSwKICAgIGRlY29kZShzdGF0ZSkgewogICAgICBsZXQgYiA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkKICAgICAgaWYgKGIuYnl0ZU9mZnNldCAlIG4gIT09IDApIGIgPSBuZXcgVWludDhBcnJheShiKQoKICAgICAgaWYgKEJFICYmIHN3YXApIHN3YXAoYikKCiAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCgogICAgICByZXR1cm4gbmV3IFR5cGVkQXJyYXkoYi5idWZmZXIsIGIuYnl0ZU9mZnNldCwgYi5ieXRlTGVuZ3RoIC8gbikKICAgIH0KICB9Cn0KCmNvbnN0IHVpbnQ4YXJyYXkgPSAoZXhwb3J0cy51aW50OGFycmF5ID0gdHlwZWRhcnJheShVaW50OEFycmF5KSkKZXhwb3J0cy51aW50MTZhcnJheSA9IHR5cGVkYXJyYXkoVWludDE2QXJyYXksIGI0YS5zd2FwMTYpCmV4cG9ydHMudWludDMyYXJyYXkgPSB0eXBlZGFycmF5KFVpbnQzMkFycmF5LCBiNGEuc3dhcDMyKQoKZXhwb3J0cy5pbnQ4YXJyYXkgPSB0eXBlZGFycmF5KEludDhBcnJheSkKZXhwb3J0cy5pbnQxNmFycmF5ID0gdHlwZWRhcnJheShJbnQxNkFycmF5LCBiNGEuc3dhcDE2KQpleHBvcnRzLmludDMyYXJyYXkgPSB0eXBlZGFycmF5KEludDMyQXJyYXksIGI0YS5zd2FwMzIpCgpleHBvcnRzLmJpZ3VpbnQ2NGFycmF5ID0gdHlwZWRhcnJheShCaWdVaW50NjRBcnJheSwgYjRhLnN3YXA2NCkKZXhwb3J0cy5iaWdpbnQ2NGFycmF5ID0gdHlwZWRhcnJheShCaWdJbnQ2NEFycmF5LCBiNGEuc3dhcDY0KQoKZXhwb3J0cy5mbG9hdDMyYXJyYXkgPSB0eXBlZGFycmF5KEZsb2F0MzJBcnJheSwgYjRhLnN3YXAzMikKZXhwb3J0cy5mbG9hdDY0YXJyYXkgPSB0eXBlZGFycmF5KEZsb2F0NjRBcnJheSwgYjRhLnN3YXA2NCkKCmZ1bmN0aW9uIHN0cmluZyhlbmNvZGluZykgewogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgICAgc3RhdGUuZW5kICs9IGI0YS5ieXRlTGVuZ3RoKHMsIGVuY29kaW5nKQogICAgfSwKICAgIGVuY29kZShzdGF0ZSwgcykgewogICAgICBzdGF0ZS5zdGFydCArPSBiNGEud3JpdGUoc3RhdGUuYnVmZmVyLCBzLCBzdGF0ZS5zdGFydCwgZW5jb2RpbmcpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IHMgPSBiNGEudG9TdHJpbmcoc3RhdGUuYnVmZmVyLCBlbmNvZGluZywgc3RhdGUuc3RhcnQpCiAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhdGUuZW5kCiAgICAgIHJldHVybiBzCiAgICB9CiAgfQp9Cgpjb25zdCB1dGY4ID0gKGV4cG9ydHMuc3RyaW5nID0gZXhwb3J0cy51dGY4ID0gc3RyaW5nKCd1dGYtOCcpKQpleHBvcnRzLmFzY2lpID0gc3RyaW5nKCdhc2NpaScpCmV4cG9ydHMuaGV4ID0gc3RyaW5nKCdoZXgnKQpleHBvcnRzLmJhc2U2NCA9IHN0cmluZygnYmFzZTY0JykKZXhwb3J0cy51Y3MyID0gZXhwb3J0cy51dGYxNmxlID0gc3RyaW5nKCd1dGYxNmxlJykKCmV4cG9ydHMuYXJyYXkgPSBmdW5jdGlvbiBhcnJheShlbmMpIHsKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBsaXN0KSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgbGlzdCkgZW5jLnByZWVuY29kZShzdGF0ZSwgdmFsdWUpCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBsaXN0KSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgbGlzdCkgZW5jLmVuY29kZShzdGF0ZSwgdmFsdWUpCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIGNvbnN0IGFyciA9IFtdCiAgICAgIHdoaWxlIChzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCkgYXJyLnB1c2goZW5jLmRlY29kZShzdGF0ZSkpCiAgICAgIHJldHVybiBhcnIKICAgIH0KICB9Cn0KCmV4cG9ydHMuanNvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSkKICB9LAogIGVuY29kZShzdGF0ZSwgdikgewogICAgdXRmOC5lbmNvZGUoc3RhdGUsIEpTT04uc3RyaW5naWZ5KHYpKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZSh1dGY4LmRlY29kZShzdGF0ZSkpCiAgfQp9CgpleHBvcnRzLm5kanNvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjgucHJlZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSArICdcbicpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHYpIHsKICAgIHV0ZjguZW5jb2RlKHN0YXRlLCBKU09OLnN0cmluZ2lmeSh2KSArICdcbicpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKHV0ZjguZGVjb2RlKHN0YXRlKSkKICB9Cn0KY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBDb3JlQ291cGxlciB7CiAgY29uc3RydWN0b3IgKHRhcmdldCwgd2FrZXVwKSB7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldAogICAgdGhpcy53YWtldXAgPSB3YWtldXAKICAgIHRoaXMuY291cGxlZCA9IG5ldyBTZXQoKQoKICAgIHRoaXMuX29ucGVlcmFkZEJvdW5kID0gdGhpcy5fb25wZWVyYWRkLmJpbmQodGhpcykKICAgIHRoaXMudGFyZ2V0Lm9uKCdwZWVyLWFkZCcsIHRoaXMuX29ucGVlcmFkZEJvdW5kKQogIH0KCiAgYWRkIChjb3JlKSB7CiAgICBjb25zdCBhZGRlZCA9IHRoaXMuY291cGxlZC5zaXplCiAgICB0aGlzLmNvdXBsZWQuYWRkKGNvcmUpCiAgICBpZiAoYWRkZWQgIT09IHRoaXMuY291cGxlZC5zaXplKSB0aGlzLl9jb3VwbGUoY29yZSkKICB9CgogIHJlbW92ZSAoY29yZSkgewogICAgdGhpcy5jb3VwbGVkLmRlbGV0ZShjb3JlKQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLnRhcmdldC5vZmYoJ3BlZXItYWRkJywgdGhpcy5fb25wZWVyYWRkQm91bmQpCiAgfQoKICBhc3luYyB1cGRhdGUgKHN0cmVhbSkgewogICAgY29uc3QgbXV4ZXIgPSBzdHJlYW0udXNlckRhdGEKICAgIGlmICghbXV4ZXIpIHJldHVybgoKICAgIHRyeSB7CiAgICAgIGlmICghKGF3YWl0IHRoaXMuX2hhc011eGVyKHRoaXMudGFyZ2V0LCBtdXhlcikpKSByZXR1cm4KCiAgICAgIGxldCB3YWtldXAgPSBudWxsCgogICAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3VwbGVkKSB7CiAgICAgICAgaWYgKGF3YWl0IHRoaXMuX2hhc011eGVyKGNvcmUsIG11eGVyKSkgY29udGludWUKICAgICAgICBpZiAod2FrZXVwID09PSBudWxsKSB3YWtldXAgPSBbXQogICAgICAgIHdha2V1cC5wdXNoKGNvcmUpCiAgICAgIH0KCiAgICAgIGlmICh3YWtldXAgIT09IG51bGwpIHsKICAgICAgICB0aGlzLndha2V1cChzdHJlYW0sIHdha2V1cCkKICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgIH0KICB9CgogIGFzeW5jIF9jb3VwbGUgKGNvcmUpIHsKICAgIHRyeSB7CiAgICAgIGxldCB3YWtldXAgPSBudWxsCgogICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy50YXJnZXQucGVlcnMpIHsKICAgICAgICBpZiAoYXdhaXQgdGhpcy5faGFzUGVlcihjb3JlLCBwZWVyKSkgY29udGludWUKICAgICAgICBpZiAod2FrZXVwID09PSBudWxsKSB3YWtldXAgPSBbXQogICAgICAgIHdha2V1cC5wdXNoKHBlZXIpCiAgICAgIH0KCiAgICAgIGlmICh3YWtldXAgIT09IG51bGwgJiYgdGhpcy5jb3VwbGVkLmhhcyhjb3JlKSkgewogICAgICAgIGZvciAoY29uc3QgcGVlciBvZiB3YWtldXApIHRoaXMud2FrZXVwKHBlZXIuc3RyZWFtLCBbY29yZV0pCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICB9CiAgfQoKICBhc3luYyBfb25wZWVyYWRkIChwZWVyKSB7CiAgICB0cnkgewogICAgICBsZXQgd2FrZXVwID0gbnVsbAoKICAgICAgZm9yIChjb25zdCBjb3JlIG9mIHRoaXMuY291cGxlZCkgewogICAgICAgIGlmIChhd2FpdCB0aGlzLl9oYXNQZWVyKGNvcmUsIHBlZXIpKSBjb250aW51ZQogICAgICAgIGlmICh3YWtldXAgPT09IG51bGwpIHdha2V1cCA9IFtdCiAgICAgICAgd2FrZXVwLnB1c2goY29yZSkKICAgICAgfQoKICAgICAgaWYgKHdha2V1cCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMud2FrZXVwKHBlZXIuc3RyZWFtLCB3YWtldXApCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICB9CiAgfQoKICBfaGFzTXV4ZXIgKGNvcmUsIG11eGVyKSB7CiAgICBjb25zdCBjaCA9IG11eGVyLmdldExhc3RDaGFubmVsKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUnLCBpZDogY29yZS5kaXNjb3ZlcnlLZXkgfSkKICAgIGlmIChjaCkgcmV0dXJuIGNoLmZ1bGx5T3BlbmVkKCkKCiAgICBjb25zdCBjaGEgPSBtdXhlci5nZXRMYXN0Q2hhbm5lbCh7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IGNvcmUuZGlzY292ZXJ5S2V5IH0pCiAgICBpZiAoY2hhKSByZXR1cm4gY2hhLmZ1bGx5T3BlbmVkKCkKCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKQogIH0KCiAgX2hhc1BlZXIgKGNvcmUsIHBlZXIpIHsKICAgIHJldHVybiB0aGlzLl9oYXNNdXhlcihjb3JlLCBwZWVyLnByb3RvbXV4KQogIH0KfQp7CiAgIm5hbWUiOiAiY29yZS1jb3VwbGVyIiwKICAidmVyc2lvbiI6ICIyLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIkNvdXBsZSB0aGUgcGVlcnMgb2YgY29yZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJjb3Jlc3RvcmUiOiAiXjYuMTguMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2NvcmUtY291cGxlci5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZS1jb3VwbGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZS1jb3VwbGVyIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IEh5cGVyY29yZSA9IHJlcXVpcmUoJ2h5cGVyY29yZScpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgSUQgPSByZXF1aXJlKCdoeXBlcmNvcmUtaWQtZW5jb2RpbmcnKQpjb25zdCB7IGlzQW5kcm9pZCB9ID0gcmVxdWlyZSgnd2hpY2gtcnVudGltZScpCmNvbnN0IHsgU1RPUkFHRV9FTVBUWSwgQVNTRVJUSU9OIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKCmNvbnN0IGF1ZGl0U3RvcmUgPSByZXF1aXJlKCcuL2xpYi9hdWRpdC5qcycpCgpjb25zdCBbTlNdID0gY3J5cHRvLm5hbWVzcGFjZSgnY29yZXN0b3JlJywgMSkKY29uc3QgREVGQVVMVF9OQU1FU1BBQ0UgPSBiNGEuYWxsb2MoMzIpIC8vIFRoaXMgaXMgbWVhbnQgdG8gYmUgMzIgMC1ieXRlcwoKY2xhc3MgU3RyZWFtVHJhY2tlciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnJlY29yZHMgPSBbXQogIH0KCiAgYWRkKHN0cmVhbSwgaXNFeHRlcm5hbCkgewogICAgY29uc3QgcmVjb3JkID0geyBpbmRleDogMCwgc3RyZWFtLCBpc0V4dGVybmFsIH0KICAgIHJlY29yZC5pbmRleCA9IHRoaXMucmVjb3Jkcy5wdXNoKHJlY29yZCkgLSAxCiAgICByZXR1cm4gcmVjb3JkCiAgfQoKICByZW1vdmUocmVjb3JkKSB7CiAgICBjb25zdCBwb3BwZWQgPSB0aGlzLnJlY29yZHMucG9wKCkKICAgIGlmIChwb3BwZWQgPT09IHJlY29yZCkgcmV0dXJuCiAgICB0aGlzLnJlY29yZHNbKHBvcHBlZC5pbmRleCA9IHJlY29yZC5pbmRleCldID0gcG9wcGVkCiAgfQoKICBhdHRhY2hBbGwoY29yZSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJlY29yZHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcmVjb3JkID0gdGhpcy5yZWNvcmRzW2ldCiAgICAgIGNvbnN0IG11eGVyID0gcmVjb3JkLnN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YQogICAgICBpZiAoIWNvcmUucmVwbGljYXRvci5hdHRhY2hlZChtdXhlcikpIGNvcmUucmVwbGljYXRvci5hdHRhY2hUbyhtdXhlcikKICAgIH0KICB9CgogIGRlc3Ryb3koKSB7CiAgICAvLyByZXZlcnNlIGlzIHNhZmVyIGNhdXNlIHdlIGRlbGV0ZSBtYgogICAgZm9yIChsZXQgaSA9IHRoaXMucmVjb3Jkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCByZWNvcmQgPSB0aGlzLnJlY29yZHNbaV0KICAgICAgaWYgKCFyZWNvcmQuaXNFeHRlcm5hbCkgcmVjb3JkLnN0cmVhbS5kZXN0cm95KCkKICAgIH0KICB9Cn0KCmNsYXNzIFNlc3Npb25UcmFja2VyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFwID0gbmV3IE1hcCgpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLm1hcC5zaXplCiAgfQoKICBnZXQoaWQpIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5tYXAuZ2V0KGlkKQogICAgaWYgKGV4aXN0aW5nICE9PSB1bmRlZmluZWQpIHJldHVybiBleGlzdGluZwogICAgY29uc3QgZnJlc2ggPSBbXQogICAgdGhpcy5tYXAuc2V0KGlkLCBmcmVzaCkKICAgIHJldHVybiBmcmVzaAogIH0KCiAgZ2MoaWQpIHsKICAgIHRoaXMubWFwLmRlbGV0ZShpZCkKICB9CgogIGxpc3QoaWQpIHsKICAgIHJldHVybiBpZCA/IHRoaXMubWFwLmdldChpZCkgfHwgW10gOiBbLi4udGhpc10KICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3Qgc2Vzc2lvbnMgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHsKICAgICAgeWllbGQqIHNlc3Npb25zW1N5bWJvbC5pdGVyYXRvcl0oKQogICAgfQogIH0KfQoKY2xhc3MgQ29yZVRyYWNrZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5tYXAgPSBuZXcgTWFwKCkKICAgIHRoaXMud2F0Y2hpbmcgPSBbXQoKICAgIHRoaXMuX2djaW5nID0gbmV3IFNldCgpCiAgICB0aGlzLl9nY0ludGVydmFsID0gbnVsbAogICAgdGhpcy5fZ2NDeWNsZUJvdW5kID0gdGhpcy5fZ2NDeWNsZS5iaW5kKHRoaXMpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLm1hcC5zaXplCiAgfQoKICB3YXRjaChzdG9yZSkgewogICAgaWYgKHN0b3JlLndhdGNoSW5kZXggIT09IC0xKSByZXR1cm4KICAgIHN0b3JlLndhdGNoSW5kZXggPSB0aGlzLndhdGNoaW5nLnB1c2goc3RvcmUpIC0gMQogIH0KCiAgdW53YXRjaChzdG9yZSkgewogICAgaWYgKHN0b3JlLndhdGNoSW5kZXggPT09IC0xKSByZXR1cm4KICAgIGNvbnN0IGhlYWQgPSB0aGlzLndhdGNoaW5nLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gc3RvcmUpIHRoaXMud2F0Y2hpbmdbKGhlYWQud2F0Y2hJbmRleCA9IHN0b3JlLndhdGNoSW5kZXgpXSA9IGhlYWQKICAgIHN0b3JlLndhdGNoSW5kZXggPSAtMQogIH0KCiAgcmVzdW1lKGlkKSB7CiAgICBjb25zdCBjb3JlID0gdGhpcy5tYXAuZ2V0KGlkKQoKICAgIGlmICghY29yZSkgcmV0dXJuIG51bGwKCiAgICAvLyBzaWduYWwgYmFjayB0aGF0IHdlIGhhdmUgYSBjbG9zaW5nIG9uZSBzdG9yZWQKICAgIGlmIChjb3JlLmNsb3NpbmcpIHJldHVybiBjb3JlCgogICAgaWYgKGNvcmUuZ2MpIHsKICAgICAgdGhpcy5fZ2NpbmcuZGVsZXRlKGNvcmUpCiAgICAgIGlmICh0aGlzLl9nY2luZy5zaXplID09PSAwKSB0aGlzLl9zdG9wR0MoKQogICAgICBjb3JlLmdjID0gMAogICAgfQoKICAgIHJldHVybiBjb3JlCiAgfQoKICBvcGVuZWQoaWQpIHsKICAgIGNvbnN0IGNvcmUgPSB0aGlzLm1hcC5nZXQoaWQpCiAgICByZXR1cm4gISEoY29yZSAmJiBjb3JlLm9wZW5lZCAmJiAhY29yZS5jbG9zaW5nKQogIH0KCiAgZ2V0KGlkKSB7CiAgICAvLyB3ZSBhbGxvdyB5b3UgZG8gY2FsbCB0aGlzIGZyb20gdGhlIG91dHNpZGUsIHNvIHN1cHBvcnQgbm9ybWFsIGJ1ZmZlcnMgYWxzbwogICAgaWYgKGI0YS5pc0J1ZmZlcihpZCkpIGlkID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKICAgIGNvbnN0IGNvcmUgPSB0aGlzLm1hcC5nZXQoaWQpCiAgICBpZiAoIWNvcmUgfHwgY29yZS5jbG9zaW5nKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIGNvcmUKICB9CgogIHNldChpZCwgY29yZSkgewogICAgdGhpcy5tYXAuc2V0KGlkLCBjb3JlKQogICAgaWYgKHRoaXMud2F0Y2hpbmcubGVuZ3RoID4gMCkgdGhpcy5fZW1pdChjb3JlKQogIH0KCiAgX2VtaXQoY29yZSkgewogICAgZm9yIChsZXQgaSA9IHRoaXMud2F0Y2hpbmcubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3Qgc3RvcmUgPSB0aGlzLndhdGNoaW5nW2ldCiAgICAgIGZvciAoY29uc3QgZm4gb2Ygc3RvcmUud2F0Y2hlcnMpIGZuKGNvcmUpCiAgICB9CiAgfQoKICBfZ2MoY29yZSkgewogICAgY29uc3QgaWQgPSB0b0hleChjb3JlLmRpc2NvdmVyeUtleSkKICAgIGlmICh0aGlzLm1hcC5nZXQoaWQpID09PSBjb3JlKSB0aGlzLm1hcC5kZWxldGUoaWQpCiAgfQoKICBfZ2NDeWNsZSgpIHsKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLl9nY2luZykgewogICAgICBpZiAoKytjb3JlLmdjIDwgNCkgY29udGludWUKICAgICAgY29uc3QgZ2MgPSB0aGlzLl9nYy5iaW5kKHRoaXMsIGNvcmUpCiAgICAgIGNvcmUuY2xvc2UoKS50aGVuKGdjLCBnYykKICAgICAgdGhpcy5fZ2NpbmcuZGVsZXRlKGNvcmUpCiAgICB9CgogICAgaWYgKHRoaXMuX2djaW5nLnNpemUgPT09IDApIHRoaXMuX3N0b3BHQygpCiAgfQoKICBnYyhjb3JlKSB7CiAgICBjb3JlLmdjID0gMSAvLyBmaXJzdCBzdHJpa2UKICAgIHRoaXMuX2djaW5nLmFkZChjb3JlKQogICAgaWYgKHRoaXMuX2djaW5nLnNpemUgPT09IDEpIHRoaXMuX3N0YXJ0R0MoKQogIH0KCiAgX3N0b3BHQygpIHsKICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZ2NJbnRlcnZhbCkKICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBudWxsCiAgfQoKICBfc3RhcnRHQygpIHsKICAgIGlmICh0aGlzLl9nY0ludGVydmFsKSByZXR1cm4KICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9nY0N5Y2xlQm91bmQsIDIwMDApCiAgICBpZiAodGhpcy5fZ2NJbnRlcnZhbC51bnJlZikgdGhpcy5fZ2NJbnRlcnZhbC51bnJlZigpCiAgfQoKICBjbG9zZSgpIHsKICAgIHRoaXMuX3N0b3BHQygpCiAgICB0aGlzLl9nY2luZy5jbGVhcigpCgogICAgY29uc3QgYWxsID0gW10KICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLm1hcC52YWx1ZXMoKSkgewogICAgICBjb3JlLm9uaWRsZSA9IG5vb3AgLy8gbm8gcmVlbnRyeQogICAgICBhbGwucHVzaChjb3JlLmNsb3NlKCkpCiAgICB9CiAgICB0aGlzLm1hcC5jbGVhcigpCgogICAgcmV0dXJuIFByb21pc2UuYWxsKGFsbCkKICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3QgY29yZSBvZiB0aGlzLm1hcC52YWx1ZXMoKSkgewogICAgICBpZiAoIWNvcmUuY2xvc2luZykgeWllbGQgY29yZQogICAgfQogIH0KfQoKY2xhc3MgRmluZGluZ1BlZXJzIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuY291bnQgPSAwCiAgICB0aGlzLnBlbmRpbmcgPSBbXQogIH0KCiAgYWRkKGNvcmUpIHsKICAgIGlmICh0aGlzLmNvdW50ID09PSAwKSByZXR1cm4KICAgIHRoaXMucGVuZGluZy5wdXNoKGNvcmUuZmluZGluZ1BlZXJzKCkpCiAgfQoKICBpbmMoc2Vzc2lvbnMpIHsKICAgIGlmICgrK3RoaXMuY291bnQgIT09IDEpIHJldHVybgoKICAgIGZvciAoY29uc3QgY29yZSBvZiBzZXNzaW9ucykgewogICAgICB0aGlzLnBlbmRpbmcucHVzaChjb3JlLmZpbmRpbmdQZWVycygpKQogICAgfQogIH0KCiAgZGVjKHNlc3Npb25zKSB7CiAgICBpZiAoLS10aGlzLmNvdW50ICE9PSAwKSByZXR1cm4KICAgIHdoaWxlICh0aGlzLnBlbmRpbmcubGVuZ3RoID4gMCkgdGhpcy5wZW5kaW5nLnBvcCgpKCkKICB9Cn0KCmNsYXNzIENvcmVzdG9yZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKHN0b3JhZ2UsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMucm9vdCA9IG9wdHMucm9vdCB8fCBudWxsCiAgICB0aGlzLnN0b3JhZ2UgPSB0aGlzLnJvb3QKICAgICAgPyB0aGlzLnJvb3Quc3RvcmFnZQogICAgICA6IEh5cGVyY29yZS5kZWZhdWx0U3RvcmFnZShzdG9yYWdlLCB7CiAgICAgICAgICBpZDogb3B0cy5pZCwKICAgICAgICAgIGFsbG93QmFja3VwOiBvcHRzLmFsbG93QmFja3VwLAogICAgICAgICAgcmVhZE9ubHk6IG9wdHMucmVhZE9ubHksCiAgICAgICAgICB3YWl0OiBvcHRzLndhaXQKICAgICAgICB9KQogICAgdGhpcy5zdHJlYW1UcmFja2VyID0gdGhpcy5yb290ID8gdGhpcy5yb290LnN0cmVhbVRyYWNrZXIgOiBuZXcgU3RyZWFtVHJhY2tlcigpCiAgICB0aGlzLmNvcmVzID0gdGhpcy5yb290ID8gdGhpcy5yb290LmNvcmVzIDogbmV3IENvcmVUcmFja2VyKCkKICAgIHRoaXMuc2Vzc2lvbnMgPSBuZXcgU2Vzc2lvblRyYWNrZXIoKQogICAgdGhpcy5jb3Jlc3RvcmVzID0gdGhpcy5yb290ID8gdGhpcy5yb290LmNvcmVzdG9yZXMgOiBuZXcgU2V0KCkKICAgIHRoaXMucmVhZE9ubHkgPSBvcHRzLndyaXRhYmxlID09PSBmYWxzZSB8fCAhIW9wdHMucmVhZE9ubHkKICAgIHRoaXMuZ2xvYmFsQ2FjaGUgPSB0aGlzLnJvb3QgPyB0aGlzLnJvb3QuZ2xvYmFsQ2FjaGUgOiBvcHRzLmdsb2JhbENhY2hlIHx8IG51bGwKICAgIHRoaXMucHJpbWFyeUtleSA9IHRoaXMucm9vdCA/IHRoaXMucm9vdC5wcmltYXJ5S2V5IDogb3B0cy5wcmltYXJ5S2V5IHx8IG51bGwKICAgIHRoaXMubnMgPSBvcHRzLm5hbWVzcGFjZSB8fCBERUZBVUxUX05BTUVTUEFDRQogICAgdGhpcy5tYW5pZmVzdFZlcnNpb24gPSBvcHRzLm1hbmlmZXN0VmVyc2lvbiB8fCAxCiAgICB0aGlzLnNob3VsZFN1c3BlbmQgPSBpc0FuZHJvaWQgPyAhIW9wdHMuc3VzcGVuZCA6IG9wdHMuc3VzcGVuZCAhPT0gZmFsc2UKICAgIHRoaXMuYWN0aXZlID0gb3B0cy5hY3RpdmUgIT09IGZhbHNlCgogICAgdGhpcy53YXRjaGVycyA9IG51bGwKICAgIHRoaXMud2F0Y2hJbmRleCA9IC0xCgogICAgdGhpcy5fZmluZGluZ1BlZXJzID0gbnVsbCAvLyBoZXJlIGZvciBsZWdhY3kKICAgIHRoaXMuX29uZ2NCb3VuZCA9IHRoaXMuX29uZ2MuYmluZCh0aGlzKQoKICAgIGlmIChvcHRzLnByaW1hcnlLZXkgJiYgIXRoaXMucm9vdCAmJiAhb3B0cy51bnNhZmUpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKAogICAgICAgICdQYXNzaW5nIHRoZSBwcmltYXJ5IGtleSBpcyB1bnNhZmUgdW5sZXNzIHlvdSBrbm93IHdoYXQgeW91IGFyZSBkb2luZy4gU2V0IHVuc2FmZTogdHJ1ZSB0byBhY2tub3dsZWRnZSB0aGF0JwogICAgICApCiAgICB9CgogICAgaWYgKHRoaXMucm9vdCkgdGhpcy5jb3Jlc3RvcmVzLmFkZCh0aGlzKQoKICAgIHRoaXMucmVhZHkoKS5jYXRjaChub29wKQogIH0KCiAgd2F0Y2goZm4pIHsKICAgIGlmICh0aGlzLndhdGNoZXJzID09PSBudWxsKSB7CiAgICAgIHRoaXMud2F0Y2hlcnMgPSBuZXcgU2V0KCkKICAgICAgdGhpcy5jb3Jlcy53YXRjaCh0aGlzKQogICAgfQoKICAgIHRoaXMud2F0Y2hlcnMuYWRkKGZuKQogIH0KCiAgdW53YXRjaChmbikgewogICAgaWYgKHRoaXMud2F0Y2hlcnMgPT09IG51bGwpIHJldHVybgoKICAgIHRoaXMud2F0Y2hlcnMuZGVsZXRlKGZuKQoKICAgIGlmICh0aGlzLndhdGNoZXJzLnNpemUgPT09IDApIHsKICAgICAgdGhpcy53YXRjaGVycyA9IG51bGwKICAgICAgdGhpcy5jb3Jlcy51bndhdGNoKHRoaXMpCiAgICB9CiAgfQoKICBmaW5kaW5nUGVlcnMoKSB7CiAgICBpZiAodGhpcy5fZmluZGluZ1BlZXJzID09PSBudWxsKSB0aGlzLl9maW5kaW5nUGVlcnMgPSBuZXcgRmluZGluZ1BlZXJzKCkKICAgIHRoaXMuX2ZpbmRpbmdQZWVycy5pbmModGhpcy5zZXNzaW9ucykKICAgIGxldCBkb25lID0gZmFsc2UKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChkb25lKSByZXR1cm4KICAgICAgZG9uZSA9IHRydWUKICAgICAgdGhpcy5fZmluZGluZ1BlZXJzLmRlYyh0aGlzLnNlc3Npb25zKQogICAgfQogIH0KCiAgYXVkaXQob3B0cyA9IHt9KSB7CiAgICByZXR1cm4gYXVkaXRTdG9yZSh0aGlzLCBvcHRzKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBhd2FpdCBsb2coJ0ZsdXNoaW5nIGRiLi4uJykKICAgIC8vIElmIHJlYWRPbmx5IHdlIGRvbid0IG5lZWQgdG8gZmx1c2gKICAgIGlmICghdGhpcy5zdG9yYWdlLnJlYWRPbmx5KSBhd2FpdCB0aGlzLnN0b3JhZ2UuZGIuZmx1c2goKQogICAgaWYgKCF0aGlzLnNob3VsZFN1c3BlbmQpIHJldHVybgogICAgYXdhaXQgbG9nKCdTdXNwZW5kaW5nIGRiLi4uJykKICAgIGF3YWl0IHRoaXMuc3RvcmFnZS5zdXNwZW5kKCkKICB9CgogIHJlc3VtZSgpIHsKICAgIHJldHVybiB0aGlzLnN0b3JhZ2UucmVzdW1lKCkKICB9CgogIHNlc3Npb24ob3B0cykgewogICAgdGhpcy5fbWF5YmVDbG9zZWQoKQogICAgY29uc3Qgcm9vdCA9IHRoaXMucm9vdCB8fCB0aGlzCiAgICByZXR1cm4gbmV3IENvcmVzdG9yZShudWxsLCB7CiAgICAgIG1hbmlmZXN0VmVyc2lvbjogdGhpcy5tYW5pZmVzdFZlcnNpb24sCiAgICAgIC4uLm9wdHMsCiAgICAgIHJvb3QKICAgIH0pCiAgfQoKICBuYW1lc3BhY2UobmFtZSwgb3B0cykgewogICAgcmV0dXJuIHRoaXMuc2Vzc2lvbih7CiAgICAgIC4uLm9wdHMsCiAgICAgIG5hbWVzcGFjZTogZ2VuZXJhdGVOYW1lc3BhY2UodGhpcy5ucywgbmFtZSkKICAgIH0pCiAgfQoKICBsaXN0KG5hbWVzcGFjZSkgewogICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5jcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0obmFtZXNwYWNlKQogIH0KCiAgZ2V0QXV0aChkaXNjb3ZlcnlLZXkpIHsKICAgIHJldHVybiB0aGlzLnN0b3JhZ2UuZ2V0QXV0aChkaXNjb3ZlcnlLZXkpCiAgfQoKICBfb25nYyhzZXNzaW9uKSB7CiAgICBpZiAoc2Vzc2lvbi5zZXNzaW9ucy5sZW5ndGggPT09IDApIHRoaXMuc2Vzc2lvbnMuZ2Moc2Vzc2lvbi5pZCkKICB9CgogIGFzeW5jIF9nZXRPclNldFNlZWQoKSB7CiAgICBjb25zdCBzZWVkID0gYXdhaXQgdGhpcy5zdG9yYWdlLmdldFNlZWQoKQogICAgaWYgKHNlZWQgIT09IG51bGwpIHJldHVybiBzZWVkCiAgICByZXR1cm4gYXdhaXQgdGhpcy5zdG9yYWdlLnNldFNlZWQodGhpcy5wcmltYXJ5S2V5IHx8IGNyeXB0by5yYW5kb21CeXRlcygzMikpCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGlmICh0aGlzLnJvb3QgIT09IG51bGwpIHsKICAgICAgaWYgKHRoaXMucm9vdC5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnJvb3QucmVhZHkoKQogICAgICB0aGlzLnByaW1hcnlLZXkgPSB0aGlzLnJvb3QucHJpbWFyeUtleQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBwcmltYXJ5S2V5ID0gYXdhaXQgdGhpcy5fZ2V0T3JTZXRTZWVkKCkKCiAgICBpZiAodGhpcy5wcmltYXJ5S2V5ID09PSBudWxsKSB7CiAgICAgIHRoaXMucHJpbWFyeUtleSA9IHByaW1hcnlLZXkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCFiNGEuZXF1YWxzKHByaW1hcnlLZXksIHRoaXMucHJpbWFyeUtleSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbm90aGVyIGNvcmVzdG9yZSBpcyBzdG9yZWQgaGVyZScpCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBjb25zdCBjbG9zaW5nID0gW10KICAgIGNvbnN0IGhhbmdpbmcgPSBbLi4udGhpcy5zZXNzaW9uc10KICAgIGZvciAoY29uc3Qgc2VzcyBvZiBoYW5naW5nKSBjbG9zaW5nLnB1c2goc2Vzcy5jbG9zZSgpKQoKICAgIGlmICh0aGlzLndhdGNoZXJzICE9PSBudWxsKSB0aGlzLmNvcmVzLnVud2F0Y2godGhpcykKCiAgICBpZiAodGhpcy5yb290ICE9PSBudWxsKSB7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKGNsb3NpbmcpCiAgICAgIHJldHVybgogICAgfQoKICAgIGZvciAoY29uc3Qgc3RvcmUgb2YgdGhpcy5jb3Jlc3RvcmVzKSB7CiAgICAgIGNsb3NpbmcucHVzaChzdG9yZS5jbG9zZSgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsKGNsb3NpbmcpCgogICAgYXdhaXQgdGhpcy5jb3Jlcy5jbG9zZSgpCiAgICBhd2FpdCB0aGlzLnN0b3JhZ2UuY2xvc2UoKQogIH0KCiAgYXN5bmMgX2F0dGFjaE1heWJlKG11eGVyLCBkaXNjb3ZlcnlLZXkpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKAogICAgICAhdGhpcy5jb3Jlcy5vcGVuZWQodG9IZXgoZGlzY292ZXJ5S2V5KSkgJiYKICAgICAgIShhd2FpdCB0aGlzLnN0b3JhZ2UuaGFzQ29yZShkaXNjb3ZlcnlLZXksIHsgaWZNaWdyYXRlZDogdHJ1ZSB9KSkKICAgICkKICAgICAgcmV0dXJuCiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgICBjb25zdCBjb3JlID0gdGhpcy5fb3BlbkNvcmUoZGlzY292ZXJ5S2V5LCB7IGNyZWF0ZUlmTWlzc2luZzogZmFsc2UgfSkKCiAgICBpZiAoIWNvcmUpIHJldHVybgogICAgaWYgKCFjb3JlLm9wZW5lZCkgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgaWYgKCFjb3JlLnJlcGxpY2F0b3IuYXR0YWNoZWQobXV4ZXIpKSB7CiAgICAgIGNvcmUucmVwbGljYXRvci5hdHRhY2hUbyhtdXhlcikKICAgIH0KCiAgICBjb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIF9zaG91bGRSZXBsaWNhdGUoY29yZSwgbXV4ZXIpIHsKICAgIHJldHVybiAoCiAgICAgIGNvcmUucmVwbGljYXRvci5kb3dubG9hZGluZyAmJiAhY29yZS5yZXBsaWNhdG9yLmF0dGFjaGVkKG11eGVyKSAmJiBjb3JlLm9wZW5lZCAmJiB0aGlzLmFjdGl2ZQogICAgKQogIH0KCiAgcmVwbGljYXRlKGlzSW5pdGlhdG9yLCBvcHRzKSB7CiAgICB0aGlzLl9tYXliZUNsb3NlZCgpCgogICAgY29uc3QgaXNFeHRlcm5hbCA9IGlzU3RyZWFtKGlzSW5pdGlhdG9yKQogICAgY29uc3Qgc3RyZWFtID0gSHlwZXJjb3JlLmNyZWF0ZVByb3RvY29sU3RyZWFtKGlzSW5pdGlhdG9yLCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIG9uZGlzY292ZXJ5a2V5OiAoZGlzY292ZXJ5S2V5KSA9PiB7CiAgICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCiAgICAgICAgY29uc3QgbXV4ZXIgPSBzdHJlYW0ubm9pc2VTdHJlYW0udXNlckRhdGEKICAgICAgICByZXR1cm4gdGhpcy5fYXR0YWNoTWF5YmUobXV4ZXIsIGRpc2NvdmVyeUtleSkKICAgICAgfQogICAgfSkKCiAgICBpZiAodGhpcy5jb3Jlcy5zaXplID4gMCkgewogICAgICBjb25zdCBtdXhlciA9IHN0cmVhbS5ub2lzZVN0cmVhbS51c2VyRGF0YQogICAgICBjb25zdCB1bmNvcmsgPSBtdXhlci51bmNvcmsuYmluZChtdXhlcikKICAgICAgbXV4ZXIuY29yaygpCgogICAgICBmb3IgKGNvbnN0IGNvcmUgb2YgdGhpcy5jb3JlcykgewogICAgICAgIGlmICghdGhpcy5fc2hvdWxkUmVwbGljYXRlKGNvcmUsIG11eGVyKSkgewogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgICAgY29yZS5yZXBsaWNhdG9yLmF0dGFjaFRvKG11eGVyKQogICAgICB9CgogICAgICBzdHJlYW0ubm9pc2VTdHJlYW0ub3BlbmVkLnRoZW4odW5jb3JrKQogICAgfQoKICAgIGNvbnN0IHJlY29yZCA9IHRoaXMuc3RyZWFtVHJhY2tlci5hZGQoc3RyZWFtLCBpc0V4dGVybmFsKQogICAgc3RyZWFtLm9uY2UoJ2Nsb3NlJywgKCkgPT4gdGhpcy5zdHJlYW1UcmFja2VyLnJlbW92ZShyZWNvcmQpKQogICAgcmV0dXJuIHN0cmVhbQogIH0KCiAgX21heWJlQ2xvc2VkKCkgewogICAgaWYgKHRoaXMuY2xvc2luZyB8fCAodGhpcy5yb290ICE9PSBudWxsICYmIHRoaXMucm9vdC5jbG9zaW5nKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvcmVzdG9yZSBpcyBjbG9zZWQnKQogICAgfQogIH0KCiAgYXN5bmMgc3RhdGljaWZ5KGNvcmUsIG9wdHMpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKCFjb3JlLm9wZW5lZCkgYXdhaXQgY29yZS5yZWFkeSgpCgogICAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCgogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKICAgIGNvbnN0IGF1dGhQcm9taXNlID0gcnguZ2V0QXV0aCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IFtoZWFkLCBhdXRoXSA9IGF3YWl0IFByb21pc2UuYWxsKFtoZWFkUHJvbWlzZSwgYXV0aFByb21pc2VdKQogICAgaWYgKCFoZWFkIHx8IGhlYWQubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgbXVzdCBoYXZlIGRhdGEnKQoKICAgIGNvbnN0IHByb2xvZ3VlID0gewogICAgICBsZW5ndGg6IGhlYWQubGVuZ3RoLAogICAgICBoYXNoOiBoZWFkLnJvb3RIYXNoCiAgICB9CgogICAgY29uc3QgbWFuaWZlc3QgPSB7CiAgICAgIHZlcnNpb246IDEsCiAgICAgIGhhc2g6IGF1dGgubWFuaWZlc3QuaGFzaCwKICAgICAgcXVvcnVtOiAwLAogICAgICBzaWduZXJzOiBbXSwKICAgICAgcHJvbG9ndWUKICAgIH0KCiAgICBjb25zdCBjID0gewogICAgICBrZXk6IG51bGwsCiAgICAgIGRpc2NvdmVyeUtleTogbnVsbCwKICAgICAgbWFuaWZlc3QsCiAgICAgIGNvcmU6IGNvcmUuc3RhdGUuc3RvcmFnZS5jb3JlCiAgICB9CgogICAgYy5rZXkgPSBIeXBlcmNvcmUua2V5KGMubWFuaWZlc3QpCiAgICBjLmRpc2NvdmVyeUtleSA9IEh5cGVyY29yZS5kaXNjb3ZlcnlLZXkoYy5rZXkpCgogICAgYXdhaXQgdGhpcy5zdG9yYWdlLmNyZWF0ZUNvcmUoYykKCiAgICBjb25zdCBzdGF0aWNDb3JlID0gdGhpcy5nZXQoeyAuLi5vcHRzLCBrZXk6IGMua2V5IH0pCiAgICBhd2FpdCBzdGF0aWNDb3JlLnJlYWR5KCkKICAgIHJldHVybiBzdGF0aWNDb3JlCiAgfQoKICBnZXQob3B0cykgewogICAgdGhpcy5fbWF5YmVDbG9zZWQoKQoKICAgIGlmIChiNGEuaXNCdWZmZXIob3B0cykgfHwgdHlwZW9mIG9wdHMgPT09ICdzdHJpbmcnKSBvcHRzID0geyBrZXk6IG9wdHMgfQogICAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgICBjb25zdCBjb25mID0gewogICAgICBwcmVsb2FkOiBudWxsLAogICAgICBzZXNzaW9uczogbnVsbCwKICAgICAgb25nYzogbnVsbCwKICAgICAgY29yZTogbnVsbCwKICAgICAgYWN0aXZlOiBvcHRzLmFjdGl2ZSAhPT0gZmFsc2UsCiAgICAgIGVuY3J5cHRpb246IG9wdHMuZW5jcnlwdGlvbiB8fCBudWxsLAogICAgICBlbmNyeXB0aW9uS2V5OiBvcHRzLmVuY3J5cHRpb25LZXkgfHwgbnVsbCwgLy8gYmFjayBjb21wYXQsIHNob3VsZCByZW1vdmUKICAgICAgaXNCbG9ja0tleTogISFvcHRzLmlzQmxvY2tLZXksIC8vIGJhY2sgY29tcGF0LCBzaG91bGQgcmVtb3ZlCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG9wdHMudmFsdWVFbmNvZGluZyB8fCBudWxsLAogICAgICBleGNsdXNpdmU6ICEhb3B0cy5leGNsdXNpdmUsCiAgICAgIG1hbmlmZXN0OiBvcHRzLm1hbmlmZXN0IHx8IG51bGwsCiAgICAgIGtleVBhaXI6IG9wdHMua2V5UGFpciB8fCBudWxsLAogICAgICBvbndhaXQ6IG9wdHMub253YWl0IHx8IG51bGwsCiAgICAgIHdhaXQ6IG9wdHMud2FpdCAhPT0gZmFsc2UsCiAgICAgIHRpbWVvdXQ6IG9wdHMudGltZW91dCB8fCAwLAogICAgICBkcmFmdDogISFvcHRzLmRyYWZ0LAogICAgICB3cml0YWJsZTogb3B0cy53cml0YWJsZSA9PT0gdW5kZWZpbmVkICYmIHRoaXMucmVhZE9ubHkgPyBmYWxzZSA6IG9wdHMud3JpdGFibGUKICAgIH0KCiAgICAvLyBuYW1lIHJlcXVpcmVzIHVzIHRvIHJ0IHRvIHN0b3JhZ2UgKyByZWFkeSwgc28gbmVlZHMgcHJlbG9hZAogICAgLy8gc2FtZSBnb2VzIGlmIHVzZXIgaGFzIGRlZmluZWQgYXN5bmMgcHJlbG9hZCBvYnZzCiAgICBpZiAob3B0cy5uYW1lIHx8IG9wdHMucHJlbG9hZCkgewogICAgICBjb25mLnByZWxvYWQgPSB0aGlzLl9wcmVsb2FkKG9wdHMpCiAgICAgIHJldHVybiB0aGlzLl9tYWtlU2Vzc2lvbihjb25mKQogICAgfQoKICAgIGlmIChvcHRzLmRpc2NvdmVyeUtleSAmJiAhb3B0cy5rZXkgJiYgIW9wdHMubWFuaWZlc3QpIHsKICAgICAgY29uZi5wcmVsb2FkID0gdGhpcy5fcHJlbG9hZENoZWNrSWZFeGlzdHMob3B0cykKICAgICAgcmV0dXJuIHRoaXMuX21ha2VTZXNzaW9uKGNvbmYpCiAgICB9CgogICAgLy8gaWYgbm90IG5vdCB3ZSBjYW4gc3luYyBjcmVhdGUgaXQsIHdoaWNoIGp1c3QgaXMgZWFzaWVyIGZvciB0aGUKICAgIC8vIHVwc3RyZWFtIHVzZXIgaW4gdGVybXMgb2YgZ3VhcmFudGVlcyAoa2V5IGlzIHRoZXJlIGV0YyBldGMpCiAgICBjb25zdCBjb3JlID0gdGhpcy5fb3BlbkNvcmUobnVsbCwgb3B0cykKCiAgICBjb25mLmNvcmUgPSBjb3JlCiAgICBjb25mLnNlc3Npb25zID0gdGhpcy5zZXNzaW9ucy5nZXQoY29yZS5pZCkKICAgIGNvbmYub25nYyA9IHRoaXMuX29uZ2NCb3VuZAoKICAgIHJldHVybiB0aGlzLl9tYWtlU2Vzc2lvbihjb25mKQogIH0KCiAgX21ha2VTZXNzaW9uKGNvbmYpIHsKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgSHlwZXJjb3JlKG51bGwsIG51bGwsIGNvbmYpCiAgICBpZiAodGhpcy5fZmluZGluZ1BlZXJzICE9PSBudWxsKSB0aGlzLl9maW5kaW5nUGVlcnMuYWRkKHNlc3Npb24pCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgYXN5bmMgY3JlYXRlS2V5UGFpcihuYW1lLCBucyA9IHRoaXMubnMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgcmV0dXJuIGNyZWF0ZUtleVBhaXIodGhpcy5wcmltYXJ5S2V5LCBucywgbmFtZSkKICB9CgogIGFzeW5jIF9wcmVsb2FkQ2hlY2tJZkV4aXN0cyhvcHRzKSB7CiAgICBjb25zdCBoYXMgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuaGFzQ29yZShvcHRzLmRpc2NvdmVyeUtleSkKICAgIGlmICghaGFzKSB0aHJvdyBTVE9SQUdFX0VNUFRZKCdObyBIeXBlcmNvcmUgaXMgc3RvcmVkIGhlcmUnKQogICAgcmV0dXJuIHRoaXMuX3ByZWxvYWQob3B0cykKICB9CgogIGFzeW5jIF9wcmVsb2FkKG9wdHMpIHsKICAgIGlmIChvcHRzLnByZWxvYWQpIG9wdHMgPSB7IC4uLm9wdHMsIC4uLihhd2FpdCBvcHRzLnByZWxvYWQpIH0KICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGNvbnN0IGRpc2NvdmVyeUtleSA9IG9wdHMubmFtZQogICAgICA/IGF3YWl0IHRoaXMuc3RvcmFnZS5nZXRBbGlhcyh7IG5hbWU6IG9wdHMubmFtZSwgbmFtZXNwYWNlOiB0aGlzLm5zIH0pCiAgICAgIDogbnVsbAogICAgdGhpcy5fbWF5YmVDbG9zZWQoKQoKICAgIGNvbnN0IGNvcmUgPSB0aGlzLl9vcGVuQ29yZShkaXNjb3ZlcnlLZXksIG9wdHMpCgogICAgcmV0dXJuIHsKICAgICAgY29yZSwKICAgICAgc2Vzc2lvbnM6IHRoaXMuc2Vzc2lvbnMuZ2V0KGNvcmUuaWQpLAogICAgICBvbmdjOiB0aGlzLl9vbmdjQm91bmQsCiAgICAgIGVuY3J5cHRpb246IG9wdHMuZW5jcnlwdGlvbiB8fCBudWxsLAogICAgICBlbmNyeXB0aW9uS2V5OiBvcHRzLmVuY3J5cHRpb25LZXkgfHwgbnVsbCwgLy8gYmFjayBjb21wYXQsIHNob3VsZCByZW1vdmUKICAgICAgaXNCbG9ja0tleTogISFvcHRzLmlzQmxvY2tLZXkgLy8gYmFjayBjb21wYXQsIHNob3VsZCByZW1vdmUKICAgIH0KICB9CgogIF9hdXRoKGRpc2NvdmVyeUtleSwgb3B0cykgewogICAgY29uc3QgcmVzdWx0ID0gewogICAgICBrZXlQYWlyOiBudWxsLAogICAgICBrZXk6IG51bGwsCiAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgbWFuaWZlc3Q6IG51bGwKICAgIH0KCiAgICBpZiAob3B0cy5uYW1lKSB7CiAgICAgIHJlc3VsdC5rZXlQYWlyID0gY3JlYXRlS2V5UGFpcih0aGlzLnByaW1hcnlLZXksIHRoaXMubnMsIG9wdHMubmFtZSkKICAgIH0gZWxzZSBpZiAob3B0cy5rZXlQYWlyKSB7CiAgICAgIHJlc3VsdC5rZXlQYWlyID0gb3B0cy5rZXlQYWlyCiAgICB9CgogICAgaWYgKG9wdHMubWFuaWZlc3QpIHsKICAgICAgcmVzdWx0Lm1hbmlmZXN0ID0gb3B0cy5tYW5pZmVzdAogICAgfSBlbHNlIGlmIChyZXN1bHQua2V5UGFpciAmJiAhcmVzdWx0LmRpc2NvdmVyeUtleSkgewogICAgICByZXN1bHQubWFuaWZlc3QgPSB7CiAgICAgICAgdmVyc2lvbjogdGhpcy5tYW5pZmVzdFZlcnNpb24sCiAgICAgICAgc2lnbmVyczogW3sgcHVibGljS2V5OiByZXN1bHQua2V5UGFpci5wdWJsaWNLZXkgfV0KICAgICAgfQogICAgfQoKICAgIGlmIChvcHRzLmtleSkgcmVzdWx0LmtleSA9IElELmRlY29kZShvcHRzLmtleSkKICAgIGVsc2UgaWYgKHJlc3VsdC5tYW5pZmVzdCkgcmVzdWx0LmtleSA9IEh5cGVyY29yZS5rZXkocmVzdWx0Lm1hbmlmZXN0KQoKICAgIGlmIChyZXN1bHQuZGlzY292ZXJ5S2V5KSByZXR1cm4gcmVzdWx0CgogICAgaWYgKG9wdHMuZGlzY292ZXJ5S2V5KSByZXN1bHQuZGlzY292ZXJ5S2V5ID0gSUQuZGVjb2RlKG9wdHMuZGlzY292ZXJ5S2V5KQogICAgZWxzZSBpZiAocmVzdWx0LmtleSkgcmVzdWx0LmRpc2NvdmVyeUtleSA9IGNyeXB0by5kaXNjb3ZlcnlLZXkocmVzdWx0LmtleSkKICAgIGVsc2UgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZGVyaXZlIGRpc2NvdmVyeSBmcm9tIGlucHV0JykKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBfb3BlbkNvcmUoZGlzY292ZXJ5S2V5LCBvcHRzKSB7CiAgICBjb25zdCBhdXRoID0gdGhpcy5fYXV0aChkaXNjb3ZlcnlLZXksIG9wdHMpCgogICAgY29uc3QgaWQgPSB0b0hleChhdXRoLmRpc2NvdmVyeUtleSkKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5jb3Jlcy5yZXN1bWUoaWQpCiAgICBpZiAoZXhpc3RpbmcgJiYgIWV4aXN0aW5nLmNsb3NpbmcpIHJldHVybiBleGlzdGluZwoKICAgIGNvbnN0IGNvcmUgPSBIeXBlcmNvcmUuY3JlYXRlQ29yZSh0aGlzLnN0b3JhZ2UsIHsKICAgICAgcHJlb3BlbjogZXhpc3RpbmcgJiYgZXhpc3Rpbmcub3BlbmVkID8gZXhpc3RpbmcuY2xvc2luZyA6IG51bGwsIC8vIGFsd2F5cyB3YWl0IGZvciB0aGUgcHJldiBvbmUgdG8gY2xvc2UgZmlyc3QgaW4gYW55IGNhc2UuLi4KICAgICAgZWFnZXJVcGdyYWRlOiB0cnVlLAogICAgICBub3REb3dubG9hZGluZ0xpbmdlcjogb3B0cy5ub3REb3dubG9hZGluZ0xpbmdlciwKICAgICAgYWxsb3dGb3JrOiBvcHRzLmFsbG93Rm9yayAhPT0gZmFsc2UsCiAgICAgIGluZmxpZ2h0UmFuZ2U6IG9wdHMuaW5mbGlnaHRSYW5nZSwKICAgICAgY29tcGF0OiBmYWxzZSwgLy8gbm8gY29tcGF0IGZvciBub3cgOikKICAgICAgZm9yY2U6IG9wdHMuZm9yY2UsCiAgICAgIGNyZWF0ZUlmTWlzc2luZzogb3B0cy5jcmVhdGVJZk1pc3NpbmcsCiAgICAgIGRpc2NvdmVyeUtleTogYXV0aC5kaXNjb3ZlcnlLZXksCiAgICAgIG92ZXJ3cml0ZTogb3B0cy5vdmVyd3JpdGUsCiAgICAgIGtleTogYXV0aC5rZXksCiAgICAgIGtleVBhaXI6IGF1dGgua2V5UGFpciwKICAgICAgbGVnYWN5OiBvcHRzLmxlZ2FjeSwKICAgICAgbWFuaWZlc3Q6IGF1dGgubWFuaWZlc3QsCiAgICAgIGdsb2JhbENhY2hlOiBvcHRzLmdsb2JhbENhY2hlIHx8IHRoaXMuZ2xvYmFsQ2FjaGUgfHwgbnVsbCwKICAgICAgYWxpYXM6IG9wdHMubmFtZSA/IHsgbmFtZTogb3B0cy5uYW1lLCBuYW1lc3BhY2U6IHRoaXMubnMgfSA6IG51bGwKICAgIH0pCgogICAgY29yZS5vbmlkbGUgPSAoKSA9PiB7CiAgICAgIHRoaXMuY29yZXMuZ2MoY29yZSkKICAgIH0KCiAgICBjb3JlLnJlcGxpY2F0b3Iub25kb3dubG9hZGluZyA9ICgpID0+IHsKICAgICAgaWYgKHRoaXMuYWN0aXZlKSB0aGlzLnN0cmVhbVRyYWNrZXIuYXR0YWNoQWxsKGNvcmUpCiAgICB9CgogICAgdGhpcy5jb3Jlcy5zZXQoaWQsIGNvcmUpCiAgICByZXR1cm4gY29yZQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBDb3Jlc3RvcmUKCmZ1bmN0aW9uIGlzU3RyZWFtKHMpIHsKICByZXR1cm4gdHlwZW9mIHMgPT09ICdvYmplY3QnICYmIHMgJiYgdHlwZW9mIHMucGlwZSA9PT0gJ2Z1bmN0aW9uJwp9CgpmdW5jdGlvbiBnZW5lcmF0ZU5hbWVzcGFjZShuYW1lc3BhY2UsIG5hbWUpIHsKICBpZiAoIWI0YS5pc0J1ZmZlcihuYW1lKSkgbmFtZSA9IGI0YS5mcm9tKG5hbWUpCiAgY29uc3Qgb3V0ID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgW25hbWVzcGFjZSwgbmFtZV0pCiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiBkZXJpdmVTZWVkKHByaW1hcnlLZXksIG5hbWVzcGFjZSwgbmFtZSkgewogIGlmICghYjRhLmlzQnVmZmVyKG5hbWUpKSBuYW1lID0gYjRhLmZyb20obmFtZSkKICBjb25zdCBvdXQgPSBiNGEuYWxsb2MoMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFtOUywgbmFtZXNwYWNlLCBuYW1lXSwgcHJpbWFyeUtleSkKICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIGNyZWF0ZUtleVBhaXIocHJpbWFyeUtleSwgbmFtZXNwYWNlLCBuYW1lKSB7CiAgY29uc3Qgc2VlZCA9IGRlcml2ZVNlZWQocHJpbWFyeUtleSwgbmFtZXNwYWNlLCBuYW1lKQogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMgKyBzb2RpdW0uY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgY29uc3Qga2V5UGFpciA9IHsKICAgIHB1YmxpY0tleTogYnVmLnN1YmFycmF5KDAsIHNvZGl1bS5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUyksCiAgICBzZWNyZXRLZXk6IGJ1Zi5zdWJhcnJheShzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgfQogIHNvZGl1bS5jcnlwdG9fc2lnbl9zZWVkX2tleXBhaXIoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5LCBzZWVkKQogIHJldHVybiBrZXlQYWlyCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gdG9IZXgoZGlzY292ZXJ5S2V5KSB7CiAgcmV0dXJuIGI0YS50b1N0cmluZyhkaXNjb3ZlcnlLZXksICdoZXgnKQp9Cm1vZHVsZS5leHBvcnRzID0gYXN5bmMgZnVuY3Rpb24qIGF1ZGl0KHN0b3JlLCB7IGRyeVJ1biA9IGZhbHNlIH0gPSB7fSkgewogIGZvciBhd2FpdCAoY29uc3QgeyBkaXNjb3ZlcnlLZXksIGNvcmUgfSBvZiBzdG9yZS5zdG9yYWdlLmNyZWF0ZUNvcmVTdHJlYW0oKSkgewogICAgaWYgKGNvcmUudmVyc2lvbiA8IDEpIGNvbnRpbnVlIC8vIG5vdCBtaWdyYXRlZCwgaWdub3JlCgogICAgY29uc3QgYyA9IHN0b3JlLmdldCh7IGRpc2NvdmVyeUtleSwgYWN0aXZlOiBmYWxzZSB9KQogICAgYXdhaXQgYy5yZWFkeSgpCgogICAgeWllbGQgeyBkaXNjb3ZlcnlLZXksIGtleTogYy5rZXksIGF1ZGl0OiBhd2FpdCBjLmNvcmUuYXVkaXQoeyBkcnlSdW4gfSkgfQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IGMuY2xvc2UoKQogICAgfSBjYXRjaCB7CiAgICAgIC8vIGlnbm9yZSBpZiBmYWlsZWQsIHdlIGFyZSBhdWRpdGluZy4uLgogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAiY29yZXN0b3JlIiwKICAidmVyc2lvbiI6ICI3LjcuMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgSHlwZXJjb3JlIGZhY3RvcnkgdGhhdCBzaW1wbGlmaWVzIG1hbmFnaW5nIGNvbGxlY3Rpb25zIG9mIGNvcmVzLiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImh5cGVyY29yZSI6ICJeMTEuMTkuMCIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy40LjIiLAogICAgImh5cGVyY29yZS1lcnJvcnMiOiAiXjEuNC4wIiwKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMy4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4xLjEiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4xIiwKICAgICJ3aGljaC1ydW50aW1lIjogIl4xLjIuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy43LjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInJhY2hlIjogIl4xLjAuMCIsCiAgICAidGVzdC10bXAiOiAiXjEuMy4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAidGVzdCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgYnJpdHRsZSB0ZXN0LyouanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYmFzaWMuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9jb3Jlc3RvcmUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZXN0b3JlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vY29yZXN0b3JlIgp9Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gZGVib3VuY2UgKHdvcmtlciwgY29udGV4dCA9IG51bGwpIHsKICBkZWJvdW5jZWQucnVubmluZyA9IG51bGwKICByZXR1cm4gZGVib3VuY2VkCgogIGFzeW5jIGZ1bmN0aW9uIGRlYm91bmNlZCAoKSB7CiAgICBpZiAoZGVib3VuY2VkLnJ1bm5pbmcgIT09IG51bGwpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBkZWJvdW5jZWQucnVubmluZwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgLy8gaWdub3JlIC0gZG8gbm90IGZhaWwgb24gb2xkIGVycm9ycwogICAgICB9CiAgICB9CgogICAgLy8gYW5vdGhlciAidGhyZWFkIiBiZWF0IHVzIHRvIGl0LCBqdXN0IHBpZ2d5IHBhY2sgb24gdGhhdCBvbmUKICAgIGlmIChkZWJvdW5jZWQucnVubmluZyAhPT0gbnVsbCkgcmV0dXJuIGRlYm91bmNlZC5ydW5uaW5nCgogICAgZGVib3VuY2VkLnJ1bm5pbmcgPSB3b3JrZXIuY2FsbChjb250ZXh0KQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBkZWJvdW5jZWQucnVubmluZwogICAgfSBmaW5hbGx5IHsKICAgICAgZGVib3VuY2VkLnJ1bm5pbmcgPSBudWxsCiAgICB9CiAgfQp9CnsKICAibmFtZSI6ICJkZWJvdW5jZWlmeSIsCiAgInZlcnNpb24iOiAiMS4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJUaW55IGFzeW5jIGRlYm91bmNlciIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiLAogICAgInRhcGUiOiAiXjUuMS4xIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RlYm91bmNlaWZ5LmdpdCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RlYm91bmNlaWZ5L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RlYm91bmNlaWZ5Igp9CmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKQpjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpCmNvbnN0IGZzeCA9IHJlcXVpcmUoJ2ZzLW5hdGl2ZS1leHRlbnNpb25zJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgRkRMb2NrID0gcmVxdWlyZSgnZmQtbG9jaycpCgpjb25zdCBQTEFURk9STSA9IGdsb2JhbC5CYXJlID8gZ2xvYmFsLkJhcmUucGxhdGZvcm0gOiBnbG9iYWwucHJvY2Vzcy5wbGF0Zm9ybQpjb25zdCBJU19XSU4gPSBQTEFURk9STSA9PT0gJ3dpbjMyJwpjb25zdCBJU19MSU5VWCA9IFBMQVRGT1JNID09PSAnbGludXgnCmNvbnN0IE1PRElGSUVEX1NMQUNLID0gNTAwMApjb25zdCBFTVBUWSA9IGI0YS5hbGxvYygwKQpjb25zdCBBVFRSID0gSVNfTElOVVggPyAndXNlci5kZXZpY2UtZmlsZScgOiAnZGV2aWNlLWZpbGUnCgpjb25zdCBubCA9IElTX1dJTiA/ICdcclxuJyA6ICdcbicKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRGV2aWNlRmlsZSBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGZpbGVuYW1lLCB7IGNyZWF0ZSA9IHRydWUsIHdhaXQgPSBmYWxzZSwgbG9jayA9IHdhaXQsIGRhdGEgPSB7fSB9ID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmZpbGVuYW1lID0gZmlsZW5hbWUKICAgIHRoaXMuZGF0YSA9IGRhdGEKICAgIHRoaXMubG9jayA9IG51bGwKCiAgICB0aGlzLl9jcmVhdGUgPSBjcmVhdGUKICAgIHRoaXMuX3dhaXQgPSB3YWl0CiAgICB0aGlzLl9sb2NrID0gbG9jawogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICBpZiAoYXdhaXQgdmVyaWZ5RGV2aWNlRmlsZSh0aGlzKSkgcmV0dXJuCiAgICBpZiAoIXRoaXMuX2NyZWF0ZSkgdGhyb3cgbmV3IEVycm9yKCdObyBkZXZpY2UgZmlsZSBwcmVzZW50JykKICAgIGF3YWl0IHdyaXRlRGV2aWNlRmlsZSh0aGlzKQogIH0KCiAgdHJhbnNmZXIoKSB7CiAgICByZXR1cm4gdGhpcy5sb2NrID8gdGhpcy5sb2NrLnRyYW5zZmVyKCkgOiAtMQogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMubG9jaykgYXdhaXQgdGhpcy5sb2NrLmNsb3NlKCkKICB9CgogIGFzeW5jIHN1c3BlbmQoKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIGlmICh0aGlzLmxvY2spIGF3YWl0IHRoaXMubG9jay5zdXNwZW5kKCkKICB9CgogIGFzeW5jIHJlc3VtZSgpIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMubG9jaykgYXdhaXQgdGhpcy5sb2NrLnJlc3VtZSgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiB3cml0ZURldmljZUZpbGUoZGV2aWNlKSB7CiAgbGV0IHMgPSAnJwoKICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkZXZpY2UuZGF0YSkpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgY29udGludWUKICAgIHMgKz0ga2V5ICsgJz0nICsgdmFsdWUgKyBubAogIH0KCiAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIocGF0aC5kaXJuYW1lKGRldmljZS5maWxlbmFtZSksIHsgcmVjdXJzaXZlOiB0cnVlIH0pCgogIGNvbnN0IGZkID0gYXdhaXQgb3BlbihkZXZpY2UuZmlsZW5hbWUsICd3JykKCiAgZGV2aWNlLmxvY2sgPSBkZXZpY2UuX2xvY2sgPyBuZXcgRkRMb2NrKGZkLCB7IHdhaXQ6IGRldmljZS5fd2FpdCB9KSA6IG51bGwKCiAgaWYgKGRldmljZS5sb2NrKSB7CiAgICB0cnkgewogICAgICBhd2FpdCBkZXZpY2UubG9jay5yZWFkeSgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYXdhaXQgZGV2aWNlLmxvY2suY2xvc2UoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGNvbnN0IHN0ID0gYXdhaXQgZnN0YXQoZmQpCgogIGNvbnN0IGNyZWF0ZWQgPSBEYXRlLm5vdygpCgogIHMgKz0gJ2RldmljZS9wbGF0Zm9ybT0nICsgUExBVEZPUk0gKyBubAogIHMgKz0gJ2RldmljZS9pbm9kZT0nICsgc3QuaW5vICsgbmwKICBzICs9ICdkZXZpY2UvY3JlYXRlZD0nICsgY3JlYXRlZCArIG5sCgogIGlmIChhd2FpdCBzZXRBdHRyKGZkLCBBVFRSLCBiNGEuZnJvbSgnb3JpZ2luYWwnKSkpIHsKICAgIHMgKz0gJ2RldmljZS9hdHRyaWJ1dGU9b3JpZ2luYWwnICsgbmwKICB9CgogIGF3YWl0IHdyaXRlKGZkLCBiNGEuZnJvbShzKSkKCiAgaWYgKCFkZXZpY2UubG9jaykgYXdhaXQgY2xvc2UoZmQpCn0KCmFzeW5jIGZ1bmN0aW9uIHZlcmlmeURldmljZUZpbGUoZGV2aWNlKSB7CiAgbGV0IGZkID0gMAoKICB0cnkgewogICAgZmQgPSBhd2FpdCBvcGVuKGRldmljZS5maWxlbmFtZSwgJ3IrJykKICB9IGNhdGNoIChlKSB7CiAgICBmZCA9IDAKICB9CgogIGlmIChmZCA9PT0gMCkgcmV0dXJuIGZhbHNlCgogIGRldmljZS5sb2NrID0gZGV2aWNlLl9sb2NrID8gbmV3IEZETG9jayhmZCwgeyB3YWl0OiBkZXZpY2UuX3dhaXQgfSkgOiBudWxsCgogIGlmIChkZXZpY2UubG9jaykgewogICAgdHJ5IHsKICAgICAgYXdhaXQgZGV2aWNlLmxvY2sucmVhZHkoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGF3YWl0IGRldmljZS5sb2NrLmNsb3NlKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBjb25zdCBidWYgPSBhd2FpdCByZWFkKGZkKQogIGNvbnN0IHJlc3VsdCA9IHt9CgogIGNvbnN0IHMgPSBiNGEudG9TdHJpbmcoYnVmKS50cmltKCkuc3BsaXQoJ1xuJykKCiAgbGV0IGlub2RlID0gMAogIGxldCBjcmVhdGVkID0gMAogIGxldCBhdHRyID0gJycKICBsZXQgcGxhdGZvcm0gPSAnJwoKICBmb3IgKGNvbnN0IGxuIG9mIHMpIHsKICAgIGNvbnN0IGkgPSBsbi5pbmRleE9mKCc9JykKICAgIGlmIChpID09PSAtMSkgY29udGludWUKCiAgICBjb25zdCBrID0gbG4uc2xpY2UoMCwgaSkudHJpbSgpCiAgICBjb25zdCB2ID0gbG4uc2xpY2UoaSArIDEpLnRyaW0oKQoKICAgIHN3aXRjaCAoaykgewogICAgICBjYXNlICdkZXZpY2UvcGxhdGZvcm0nOgogICAgICAgIHBsYXRmb3JtID0gdgogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2RldmljZS9pbm9kZSc6CiAgICAgICAgaW5vZGUgPSBOdW1iZXIodikKICAgICAgICBicmVhawogICAgICBjYXNlICdkZXZpY2UvY3JlYXRlZCc6CiAgICAgICAgY3JlYXRlZCA9IE51bWJlcih2KQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ2RldmljZS9hdHRyaWJ1dGUnOgogICAgICAgIGF0dHIgPSB2CiAgICAgICAgYnJlYWsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXN1bHRba10gPSB2CiAgICAgICAgYnJlYWsKICAgIH0KICB9CgogIGZvciAoY29uc3QgW2ssIHZdIG9mIE9iamVjdC5lbnRyaWVzKGRldmljZS5kYXRhKSkgewogICAgaWYgKHYgPT09IG51bGwpIGNvbnRpbnVlCiAgICBpZiAocmVzdWx0W2tdID09PSB1bmRlZmluZWQpIGNvbnRpbnVlIC8vIGFsbG93IHVwc2VydHMKICAgIGlmIChyZXN1bHRba10gIT09ICcnICsgdikgewogICAgICBhd2FpdCB0ZWFyZG93bigpCiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkZXZpY2UgZmlsZSwgJyArIGsgKyAnIGhhcyBjaGFuZ2VkLiBXYXMgJyArIHJlc3VsdFtrXSArICcsIGlzICcgKyB2KQogICAgfQogIH0KCiAgY29uc3Qgc3QgPSBhd2FpdCBmc3RhdChmZCkKICBjb25zdCBhdCA9IGF3YWl0IGdldEF0dHIoZmQsIEFUVFIpCgogIGNvbnN0IHNhbWVBdHRyID0gYjRhLnRvU3RyaW5nKGF0IHx8IEVNUFRZKSA9PT0gYXR0cgogIGNvbnN0IG1vZGlmaWVkID0gTWF0aC5tYXgoc3QubXRpbWUuZ2V0VGltZSgpLCBzdC5iaXJ0aHRpbWUuZ2V0VGltZSgpKQoKICBpZiAocGxhdGZvcm0gJiYgcGxhdGZvcm0gIT09IFBMQVRGT1JNKSB7CiAgICBhd2FpdCB0ZWFyZG93bigpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZGV2aWNlIGZpbGUsIHdhcyBtYWRlIG9uIGRpZmZlcmVudCBwbGF0Zm9ybScpCiAgfQoKICBpZiAoIXNhbWVBdHRyKSB7CiAgICBhd2FpdCB0ZWFyZG93bigpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZGV2aWNlIGZpbGUsIHdhcyBtb3ZlZCB1bnNhZmVseScpCiAgfQoKICBpZiAoc3QuaW5vICE9PSBpbm9kZSB8fCAoY3JlYXRlZCAmJiBNYXRoLmFicyhtb2RpZmllZCAtIGNyZWF0ZWQpID49IE1PRElGSUVEX1NMQUNLKSkgewogICAgYXdhaXQgdGVhcmRvd24oKQogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGRldmljZSBmaWxlLCB3YXMgbW9kaWZpZWQnKQogIH0KCiAgaWYgKCFkZXZpY2UubG9jaykgYXdhaXQgY2xvc2UoZmQpCgogIGRldmljZS5kYXRhID0gcmVzdWx0CiAgcmV0dXJuIHRydWUKCiAgYXN5bmMgZnVuY3Rpb24gdGVhcmRvd24gKCkgewogICAgaWYgKGRldmljZS5sb2NrKSBhd2FpdCBkZXZpY2UubG9jay5jbG9zZSgpCiAgICBlbHNlIGF3YWl0IGNsb3NlKGZkKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZ2V0QXR0cihmZCwgbmFtZSkgewogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgZnN4LmdldEF0dHIoZmQsIG5hbWUpCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gc2V0QXR0cihmZCwgbmFtZSwgdmFsdWUpIHsKICB0cnkgewogICAgYXdhaXQgZnN4LnNldEF0dHIoZmQsIG5hbWUsIHZhbHVlKQogICAgcmV0dXJuIHRydWUKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZnVuY3Rpb24gZnN0YXQoZmQpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnMuZnN0YXQoZmQsIChlcnIsIHN0KSA9PiB7CiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICAgIHJlc29sdmUoc3QpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIGNsb3NlKGZkKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGZzLmNsb3NlKGZkLCAoZXJyLCBzdCkgPT4gewogICAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgICByZXNvbHZlKHN0KQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiB3cml0ZShmZCwgYnVmKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGxldCBvZmZzZXQgPSAwCgogICAgb253cml0ZShudWxsLCAwKQoKICAgIGZ1bmN0aW9uIG9ud3JpdGUoZXJyLCB3cm90ZSkgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycikKICAgICAgaWYgKG9mZnNldCA9PT0gYnVmLmJ5dGVMZW5ndGgpIHJldHVybiByZXNvbHZlKCkKICAgICAgb2Zmc2V0ICs9IHdyb3RlCiAgICAgIGZzLndyaXRlKGZkLCBidWYsIG9mZnNldCwgYnVmLmJ5dGVMZW5ndGggLSBvZmZzZXQsIG9mZnNldCwgb253cml0ZSkKICAgIH0KICB9KQp9CgpmdW5jdGlvbiByZWFkKGZkKSB7CiAgY29uc3QgYnVmID0gYjRhLmFsbG9jVW5zYWZlKDQwOTYpCgogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBsZXQgb2Zmc2V0ID0gMAoKICAgIGZzLnJlYWQoZmQsIGJ1ZiwgMCwgYnVmLmJ5dGVMZW5ndGgsIDAsIG9ucmVhZCkKCiAgICBmdW5jdGlvbiBvbnJlYWQoZXJyLCByZWFkKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKQogICAgICBpZiAocmVhZCA9PT0gMCkgcmV0dXJuIHJlc29sdmUoYnVmLnN1YmFycmF5KDAsIG9mZnNldCkpCiAgICAgIG9mZnNldCArPSByZWFkCiAgICAgIGZzLnJlYWQoZmQsIGJ1Ziwgb2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCAtIG9mZnNldCwgb2Zmc2V0LCBvbnJlYWQpCiAgICB9CiAgfSkKfQoKZnVuY3Rpb24gb3BlbihmaWxlbmFtZSwgZmxhZ3MpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnMub3BlbihmaWxlbmFtZSwgZmxhZ3MsIChlcnIsIGZkKSA9PiB7CiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpCiAgICAgIHJlc29sdmUoZmQpCiAgICB9KQogIH0pCn0KewogICJuYW1lIjogImRldmljZS1maWxlIiwKICAidmVyc2lvbiI6ICIyLjEuMyIsCiAgImRlc2NyaXB0aW9uIjogIkRldmljZSBvbmx5IGZpbGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImJhcmUtZnMiOiAiXjQuMC4xIiwKICAgICJiYXJlLXBhdGgiOiAiXjMuMC4wIiwKICAgICJmZC1sb2NrIjogIl4yLjEuMCIsCiAgICAiZnMtbmF0aXZlLWV4dGVuc2lvbnMiOiAiXjEuNC4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMTMuMSIsCiAgICAibHVudGUiOiAiXjEuMC4yIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbHVudGUiLAogICAgInRlc3QiOiAiYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0KICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2RldmljZS1maWxlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYyIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9kZXZpY2UtZmlsZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2RldmljZS1maWxlIgp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBUYWJsZSA9IHJlcXVpcmUoJ2thZGVtbGlhLXJvdXRpbmctdGFibGUnKQpjb25zdCBUT1MgPSByZXF1aXJlKCd0aW1lLW9yZGVyZWQtc2V0JykKY29uc3QgVURYID0gcmVxdWlyZSgndWR4LW5hdGl2ZScpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IE5hdFNhbXBsZXIgPSByZXF1aXJlKCduYXQtc2FtcGxlcicpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IElPID0gcmVxdWlyZSgnLi9saWIvaW8nKQpjb25zdCBRdWVyeSA9IHJlcXVpcmUoJy4vbGliL3F1ZXJ5JykKY29uc3QgU2Vzc2lvbiA9IHJlcXVpcmUoJy4vbGliL3Nlc3Npb24nKQpjb25zdCBwZWVyID0gcmVxdWlyZSgnLi9saWIvcGVlcicpCmNvbnN0IHsgVU5LTk9XTl9DT01NQU5ELCBJTlZBTElEX1RPS0VOIH0gPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKQpjb25zdCB7IFBJTkcsIFBJTkdfTkFULCBGSU5EX05PREUsIERPV05fSElOVCB9ID0gcmVxdWlyZSgnLi9saWIvY29tbWFuZHMnKQoKY29uc3QgVE1QID0gYjRhLmFsbG9jVW5zYWZlKDMyKQpjb25zdCBUSUNLX0lOVEVSVkFMID0gNTAwMApjb25zdCBTTEVFUElOR19JTlRFUlZBTCA9IDMgKiBUSUNLX0lOVEVSVkFMCmNvbnN0IFNUQUJMRV9USUNLUyA9IDI0MCAvLyBpZiBub3RoaW5nIG1ham9yIGJhZCBoYXBwZW5zIGluIH4yMG1pbnMgd2UgY2FuIGNvbnNpZGVyIHRoaXMgbm9kZSBzdGFibGUgKGlmIG5hdCBpcyBmcmllbmRseSkKY29uc3QgTU9SRV9TVEFCTEVfVElDS1MgPSAzICogU1RBQkxFX1RJQ0tTCmNvbnN0IFJFRlJFU0hfVElDS1MgPSA2MCAvLyByZWZyZXNoIGV2ZXJ5IH41bWluIHdoZW4gaWRsZQpjb25zdCBSRUNFTlRfTk9ERSA9IDEyIC8vIHdlJ3ZlIGhlYXJkIGZyb20gYSBub2RlIGxlc3MgdGhhbiAxbWluIGFnbwpjb25zdCBPTERfTk9ERSA9IDM2MCAvLyBpZiBhbiBub2RlIGhhcyBiZWVuIGFyb3VuZCBtb3JlIHRoYW4gMzAgbWluIHdlIGNvbnNpZGVyIGl0IG9sZAoKY2xhc3MgREhUIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmJvb3RzdHJhcE5vZGVzID0gb3B0cy5ib290c3RyYXAgPT09IGZhbHNlID8gW10gOiAob3B0cy5ib290c3RyYXAgfHwgW10pLm1hcChwYXJzZU5vZGUpCiAgICB0aGlzLnRhYmxlID0gbmV3IFRhYmxlKHJhbmRvbUJ5dGVzKDMyKSkKICAgIHRoaXMubm9kZXMgPSBuZXcgVE9TKCkKICAgIHRoaXMudWR4ID0gb3B0cy51ZHggfHwgbmV3IFVEWCgpCiAgICB0aGlzLmlvID0gbmV3IElPKHRoaXMudGFibGUsIHRoaXMudWR4LCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIG9ucmVxdWVzdDogdGhpcy5fb25yZXF1ZXN0LmJpbmQodGhpcyksCiAgICAgIG9ucmVzcG9uc2U6IHRoaXMuX29ucmVzcG9uc2UuYmluZCh0aGlzKSwKICAgICAgb250aW1lb3V0OiB0aGlzLl9vbnRpbWVvdXQuYmluZCh0aGlzKQogICAgfSkKCiAgICB0aGlzLmNvbmN1cnJlbmN5ID0gb3B0cy5jb25jdXJyZW5jeSB8fCAxMAogICAgdGhpcy5ib290c3RyYXBwZWQgPSBmYWxzZQogICAgdGhpcy5lcGhlbWVyYWwgPSB0cnVlCiAgICB0aGlzLmZpcmV3YWxsZWQgPSB0aGlzLmlvLmZpcmV3YWxsZWQKICAgIHRoaXMuYWRhcHRpdmUgPSB0eXBlb2Ygb3B0cy5lcGhlbWVyYWwgIT09ICdib29sZWFuJyAmJiBvcHRzLmFkYXB0aXZlICE9PSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5vbmxpbmUgPSB0cnVlCiAgICB0aGlzLnN0YXRzID0gewogICAgICBxdWVyaWVzOiB7IGFjdGl2ZTogMCwgdG90YWw6IDAgfSwKICAgICAgcmVxdWVzdHM6IHRoaXMuaW8uc3RhdHMucmVxdWVzdHMsCiAgICAgIGNvbW1hbmRzOiB7CiAgICAgICAgcGluZzogdGhpcy5pby5zdGF0cy5jb21tYW5kc1tQSU5HXSwKICAgICAgICBwaW5nTmF0OiB0aGlzLmlvLnN0YXRzLmNvbW1hbmRzW1BJTkdfTkFUXSwKICAgICAgICBmaW5kTm9kZTogdGhpcy5pby5zdGF0cy5jb21tYW5kc1tGSU5EX05PREVdLAogICAgICAgIGRvd25IaW50OiB0aGlzLmlvLnN0YXRzLmNvbW1hbmRzW0RPV05fSElOVF0KICAgICAgfQogICAgfQoKICAgIHRoaXMuX25hdCA9IG5ldyBOYXRTYW1wbGVyKCkKICAgIHRoaXMuX3F1aWNrRmlyZXdhbGwgPSBvcHRzLnF1aWNrRmlyZXdhbGwgIT09IGZhbHNlCiAgICB0aGlzLl9mb3JjZVBlcnNpc3RlbnQgPSBvcHRzLmVwaGVtZXJhbCA9PT0gZmFsc2UKICAgIHRoaXMuX3JlcGluZ2luZyA9IDAKICAgIHRoaXMuX2NoZWNrcyA9IDAKICAgIHRoaXMuX3RpY2sgPSByYW5kb21PZmZzZXQoMTAwKSAvLyBtYWtlIHN1cmUgdG8gcmFuZG9tIG9mZnNldCBhbGwgdGhlIG5ldHdvcmsgdGlja3MKICAgIHRoaXMuX3JlZnJlc2hUaWNrcyA9IHJhbmRvbU9mZnNldChSRUZSRVNIX1RJQ0tTKQogICAgdGhpcy5fc3RhYmxlVGlja3MgPSB0aGlzLmFkYXB0aXZlID8gU1RBQkxFX1RJQ0tTIDogMAogICAgdGhpcy5fdGlja0ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fb250aWNrLmJpbmQodGhpcyksIFRJQ0tfSU5URVJWQUwpCiAgICB0aGlzLl9sYXN0VGljayA9IERhdGUubm93KCkKICAgIHRoaXMuX2xhc3RIb3N0ID0gbnVsbAogICAgdGhpcy5fZmlsdGVyTm9kZSA9IG9wdHMuZmlsdGVyTm9kZSB8fCBvcHRzLmFkZE5vZGUgfHwgbnVsbCAvLyBvcHRzLmFkZE5vZGUgaXMgZGVwcmVjYXRpbmcsIHVzZSBvcHRzLmZpbHRlck5vZGUgaW5zdGVhZAogICAgdGhpcy5fb25yb3cgPSAocm93KSA9PiByb3cub24oJ2Z1bGwnLCAobm9kZSkgPT4gdGhpcy5fb25mdWxscm93KG5vZGUsIHJvdykpCiAgICB0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMgPSBbXQogICAgdGhpcy5fYm9vdHN0cmFwcGluZyA9IHRoaXMuX2Jvb3RzdHJhcCgpCiAgICB0aGlzLl9ib290c3RyYXBwaW5nLmNhdGNoKG5vb3ApCgogICAgdGhpcy50YWJsZS5vbigncm93JywgdGhpcy5fb25yb3cpCgogICAgdGhpcy5pby5uZXR3b3JrSW50ZXJmYWNlcy5vbignY2hhbmdlJywgKGludGVyZmFjZXMpID0+IHRoaXMuX29ubmV0d29ya2NoYW5nZShpbnRlcmZhY2VzKSkKCiAgICBpZiAob3B0cy5ub2RlcykgewogICAgICBmb3IgKGxldCBpID0gb3B0cy5ub2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHRoaXMuYWRkTm9kZShvcHRzLm5vZGVzW2ldKQogICAgICB9CiAgICB9CiAgfQoKICBzdGF0aWMgYm9vdHN0cmFwcGVyKHBvcnQsIGhvc3QsIG9wdHMpIHsKICAgIGlmICghcG9ydCkgdGhyb3cgbmV3IEVycm9yKCdQb3J0IGlzIHJlcXVpcmVkJykKICAgIGlmICghaG9zdCkgdGhyb3cgbmV3IEVycm9yKCdIb3N0IGlzIHJlcXVpcmVkJykKICAgIGlmIChob3N0ID09PSAnMC4wLjAuMCcgfHwgaG9zdCA9PT0gJzo6JykgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGhvc3QnKQogICAgaWYgKCFVRFguaXNJUHY0KGhvc3QpKSB0aHJvdyBuZXcgRXJyb3IoJ0hvc3QgbXVzdCBiZSBhIElQdjQgYWRkcmVzcycpCgogICAgY29uc3QgZGh0ID0gbmV3IHRoaXMoewogICAgICBwb3J0LAogICAgICBlcGhlbWVyYWw6IGZhbHNlLAogICAgICBmaXJld2FsbGVkOiBmYWxzZSwKICAgICAgYW55UG9ydDogZmFsc2UsCiAgICAgIGJvb3RzdHJhcDogW10sCiAgICAgIC4uLm9wdHMKICAgIH0pCiAgICBkaHQuX25hdC5hZGQoaG9zdCwgcG9ydCkKICAgIHJldHVybiBkaHQKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmVwaGVtZXJhbCA/IG51bGwgOiB0aGlzLnRhYmxlLmlkCiAgfQoKICBnZXQgaG9zdCgpIHsKICAgIHJldHVybiB0aGlzLl9uYXQuaG9zdAogIH0KCiAgZ2V0IHBvcnQoKSB7CiAgICByZXR1cm4gdGhpcy5fbmF0LnBvcnQKICB9CgogIGdldCByYW5kb21pemVkKCkgewogICAgcmV0dXJuIHRoaXMuX25hdC5ob3N0ICE9PSBudWxsICYmIHRoaXMuX25hdC5wb3J0ID09PSAwCiAgfQoKICBnZXQgc29ja2V0KCkgewogICAgcmV0dXJuIHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuaW8uY2xpZW50U29ja2V0IDogdGhpcy5pby5zZXJ2ZXJTb2NrZXQKICB9CgogIG9ubWVzc2FnZShzb2NrZXQsIGJ1ZiwgcmluZm8pIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCA+IDEpIHRoaXMuaW8ub25tZXNzYWdlKHNvY2tldCwgYnVmLCByaW5mbykKICB9CgogIGJpbmQoKSB7CiAgICByZXR1cm4gdGhpcy5pby5iaW5kKCkKICB9CgogIGFzeW5jIHN1c3BlbmQoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgbG9nKCdTdXNwZW5kaW5nIHdhaXRpbmcgZm9yIGlvIGJpbmQuLi4nKQogICAgYXdhaXQgdGhpcy5pby5iaW5kKCkKICAgIGxvZygnRG9uZSwgY29udGludWluZycpCiAgICBpZiAodGhpcy5zdXNwZW5kZWQgfHwgdGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCiAgICBjbGVhckludGVydmFsKHRoaXMuX3RpY2tJbnRlcnZhbCkKICAgIGxvZygnRG9uZSwgc3VzcGVuZGluZyBpbycpCiAgICBhd2FpdCB0aGlzLmlvLnN1c3BlbmQoeyBsb2cgfSkKICAgIGxvZygnRG9uZSwgZGh0IHN1c3BlbmRlZCcpCiAgICB0aGlzLmVtaXQoJ3N1c3BlbmQnKQogIH0KCiAgYXN5bmMgcmVzdW1lKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICghdGhpcy5zdXNwZW5kZWQgfHwgdGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5fdGlja0ludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5fb250aWNrLmJpbmQodGhpcyksIFRJQ0tfSU5URVJWQUwpCiAgICB0aGlzLl9vbndha2V1cCgpCiAgICBsb2coJ1Jlc3VtaW5nIGlvJykKICAgIGF3YWl0IHRoaXMuaW8ucmVzdW1lKCkKICAgIGxvZygnRG9uZSwgZGh0IHJlc3VtZWQnKQogICAgdGhpcy5pby5uZXR3b3JrSW50ZXJmYWNlcy5vbignY2hhbmdlJywgKGludGVyZmFjZXMpID0+IHRoaXMuX29ubmV0d29ya2NoYW5nZShpbnRlcmZhY2VzKSkKICAgIHRoaXMucmVmcmVzaCgpCiAgICB0aGlzLmVtaXQoJ3Jlc3VtZScpCiAgfQoKICBhZGRyZXNzKCkgewogICAgY29uc3Qgc29ja2V0ID0gdGhpcy5zb2NrZXQKICAgIHJldHVybiBzb2NrZXQgPyBzb2NrZXQuYWRkcmVzcygpIDogbnVsbAogIH0KCiAgbG9jYWxBZGRyZXNzKCkgewogICAgaWYgKCF0aGlzLmlvLnNlcnZlclNvY2tldCkgcmV0dXJuIG51bGwKCiAgICByZXR1cm4gewogICAgICBob3N0OiBsb2NhbElQKHRoaXMudWR4KSwKICAgICAgcG9ydDogdGhpcy5pby5zZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQKICAgIH0KICB9CgogIHJlbW90ZUFkZHJlc3MoKSB7CiAgICBpZiAoIXRoaXMuaG9zdCkgcmV0dXJuIG51bGwKICAgIGlmICghdGhpcy5wb3J0KSByZXR1cm4gbnVsbAogICAgaWYgKHRoaXMuZmlyZXdhbGxlZCkgcmV0dXJuIG51bGwKICAgIGlmICghdGhpcy5pby5zZXJ2ZXJTb2NrZXQpIHJldHVybiBudWxsCgogICAgY29uc3QgcG9ydCA9IHRoaXMuaW8uc2VydmVyU29ja2V0LmFkZHJlc3MoKS5wb3J0CiAgICBpZiAocG9ydCAhPT0gdGhpcy5wb3J0KSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IHRoaXMuaG9zdCwKICAgICAgcG9ydAogICAgfQogIH0KCiAgYWRkTm9kZSh7IGhvc3QsIHBvcnQgfSkgewogICAgdGhpcy5fYWRkTm9kZSh7CiAgICAgIGlkOiBwZWVyLmlkKGhvc3QsIHBvcnQpLAogICAgICBwb3J0LAogICAgICBob3N0LAogICAgICB0b2tlbjogbnVsbCwKICAgICAgdG86IG51bGwsCiAgICAgIHNhbXBsZWQ6IDAsCiAgICAgIGFkZGVkOiB0aGlzLl90aWNrLAogICAgICBwaW5nZWQ6IDAsCiAgICAgIHNlZW46IDAsCiAgICAgIGRvd25IaW50czogMCwKICAgICAgcHJldjogbnVsbCwKICAgICAgbmV4dDogbnVsbAogICAgfSkKICB9CgogIHRvQXJyYXkob3B0cykgewogICAgY29uc3QgbGltaXQgPSBvcHRzICYmIG9wdHMubGltaXQKICAgIGlmIChsaW1pdCA9PT0gMCkgcmV0dXJuIFtdCiAgICByZXR1cm4gdGhpcy5ub2Rlcy50b0FycmF5KHsgbGltaXQsIHJldmVyc2U6IHRydWUgfSkubWFwKCh7IGhvc3QsIHBvcnQgfSkgPT4gKHsgaG9zdCwgcG9ydCB9KSkKICB9CgogIGFzeW5jIGZ1bGx5Qm9vdHN0cmFwcGVkKCkgewogICAgcmV0dXJuIHRoaXMuX2Jvb3RzdHJhcHBpbmcKICB9CgogIHJlYWR5KCkgewogICAgLy8gRGVwcmVjYXRpbmcsIHVzZSBmdWxseUJvb3RzdHJhcHBlZCBpbnN0ZWFkIChyZW1vdmVkIG9uIG5leHQgbWFqb3IpCiAgICByZXR1cm4gdGhpcy5mdWxseUJvb3RzdHJhcHBlZCgpCiAgfQoKICBmaW5kTm9kZSh0YXJnZXQsIG9wdHMpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdOb2RlIGRlc3Ryb3llZCcpCiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSBSRUZSRVNIX1RJQ0tTCiAgICByZXR1cm4gbmV3IFF1ZXJ5KHRoaXMsIHRhcmdldCwgdHJ1ZSwgRklORF9OT0RFLCBudWxsLCBvcHRzKQogIH0KCiAgcXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQsIHZhbHVlIH0sIG9wdHMpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdOb2RlIGRlc3Ryb3llZCcpCiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSBSRUZSRVNIX1RJQ0tTCiAgICByZXR1cm4gbmV3IFF1ZXJ5KHRoaXMsIHRhcmdldCwgZmFsc2UsIGNvbW1hbmQsIHZhbHVlIHx8IG51bGwsIG9wdHMpCiAgfQoKICBwaW5nKHsgaG9zdCwgcG9ydCB9LCBvcHRzKSB7CiAgICBsZXQgdmFsdWUgPSBudWxsCgogICAgaWYgKG9wdHMgJiYgb3B0cy5zaXplICYmIG9wdHMuc2l6ZSA+IDApIHZhbHVlID0gYjRhLmFsbG9jKG9wdHMuc2l6ZSkKCiAgICBjb25zdCByZXEgPSB0aGlzLmlvLmNyZWF0ZVJlcXVlc3QoCiAgICAgIHsgaWQ6IG51bGwsIGhvc3QsIHBvcnQgfSwKICAgICAgbnVsbCwKICAgICAgdHJ1ZSwKICAgICAgUElORywKICAgICAgbnVsbCwKICAgICAgdmFsdWUsCiAgICAgIChvcHRzICYmIG9wdHMuc2Vzc2lvbikgfHwgbnVsbCwKICAgICAgb3B0cyAmJiBvcHRzLnR0bAogICAgKQogICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RUb1Byb21pc2UocmVxLCBvcHRzKQogIH0KCiAgcmVxdWVzdCh7IHRva2VuID0gbnVsbCwgY29tbWFuZCwgdGFyZ2V0ID0gbnVsbCwgdmFsdWUgPSBudWxsIH0sIHsgaG9zdCwgcG9ydCB9LCBvcHRzKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLmlvLmNyZWF0ZVJlcXVlc3QoCiAgICAgIHsgaWQ6IG51bGwsIGhvc3QsIHBvcnQgfSwKICAgICAgdG9rZW4sCiAgICAgIGZhbHNlLAogICAgICBjb21tYW5kLAogICAgICB0YXJnZXQsCiAgICAgIHZhbHVlLAogICAgICAob3B0cyAmJiBvcHRzLnNlc3Npb24pIHx8IG51bGwsCiAgICAgIG9wdHMgJiYgb3B0cy50dGwKICAgICkKICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0VG9Qcm9taXNlKHJlcSwgb3B0cykKICB9CgogIHNlc3Npb24oKSB7CiAgICByZXR1cm4gbmV3IFNlc3Npb24odGhpcykKICB9CgogIF9yZXF1ZXN0VG9Qcm9taXNlKHJlcSwgb3B0cykgewogICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignTm9kZSBkZXN0cm95ZWQnKSkKCiAgICBpZiAob3B0cyAmJiBvcHRzLnNvY2tldCkgcmVxLnNvY2tldCA9IG9wdHMuc29ja2V0CiAgICBpZiAob3B0cyAmJiBvcHRzLnJldHJ5ID09PSBmYWxzZSkgcmVxLnJldHJpZXMgPSAwCgogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLm9ucmVzcG9uc2UgPSByZXNvbHZlCiAgICAgIHJlcS5vbmVycm9yID0gcmVqZWN0CiAgICAgIHJlcS5zZW5kKCkKICAgIH0pCiAgfQoKICBhc3luYyBfYm9vdHN0cmFwKCkgewogICAgY29uc3Qgc2VsZiA9IHRoaXMKCiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKSAvLyB3YWl0IGEgdGljaywgc28gYXBpcyBjYW4gYmUgdXNlZCBmcm9tIHRoZSBvdXRzaWRlCiAgICBhd2FpdCB0aGlzLmlvLmJpbmQoKQoKICAgIHRoaXMuZW1pdCgnbGlzdGVuaW5nJykKCiAgICAvLyBUT0RPOiBzb21lIHBhcGVycyBkZXNjcmliZSBtb3JlIGFkdmFuY2VkIHdheXMgb2YgYm9vdHN0cmFwcGluZyAtIHdlIHNob3VsZCBwcm9iIGxvb2sgaW50byB0aGF0CgogICAgbGV0IGZpcnN0ID0gdGhpcy5maXJld2FsbGVkICYmIHRoaXMuX3F1aWNrRmlyZXdhbGwgJiYgIXRoaXMuX2ZvcmNlUGVyc2lzdGVudAogICAgbGV0IHRlc3ROYXQgPSBmYWxzZQoKICAgIGNvbnN0IG9ubHlGaXJld2FsbCA9ICF0aGlzLl9mb3JjZVBlcnNpc3RlbnQKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI7IGkrKykgewogICAgICBhd2FpdCB0aGlzLl9iYWNrZ3JvdW5kUXVlcnkodGhpcy50YWJsZS5pZCkub24oJ2RhdGEnLCBvbmRhdGEpLmZpbmlzaGVkKCkKCiAgICAgIGlmICh0aGlzLmJvb3RzdHJhcHBlZCB8fCAoIXRlc3ROYXQgJiYgIXRoaXMuX2ZvcmNlUGVyc2lzdGVudCkpIGJyZWFrCiAgICAgIGlmICghKGF3YWl0IHRoaXMuX3VwZGF0ZU5ldHdvcmtTdGF0ZShvbmx5RmlyZXdhbGwpKSkgYnJlYWsKICAgIH0KCiAgICBpZiAodGhpcy5ib290c3RyYXBwZWQpIHJldHVybgogICAgdGhpcy5ib290c3RyYXBwZWQgPSB0cnVlCgogICAgdGhpcy5lbWl0KCdyZWFkeScpCgogICAgZnVuY3Rpb24gb25kYXRhKGRhdGEpIHsKICAgICAgLy8gU2ltcGxlIFFVSUNLIG5hdCBoZXVyaXN0aWMuCiAgICAgIC8vIElmIHdlIGdldCBPTkUgcG9zaXRpdmUgbmF0IHBpbmcgYmVmb3JlIHRoZSBib290c3RyYXAgcXVlcnkgZmluaXNoZXMKICAgICAgLy8gdGhlbiB3ZSBhbHdheXMgdG8gYSBuYXQgdGVzdCwgbm8gbWF0dGVyIGlmIHdlIGFyZSBhZGFwdGl2ZS4uLgogICAgICAvLyBUaGlzIHNob3VsZCBiZSBleHBhbmRlZCBpbiB0aGUgZnV0dXJlIHRvIHRyeSBtb3JlIHRoYW4gb25lIG5vZGUgZXRjLCBub3QgYWx3YXlzIGhpdCB0aGUgZmlyc3QgZXRjCiAgICAgIC8vIElmIHRoaXMgZmFpbHMsIHRoZW4gbmJkLCBhcyB0aGUgb25zdGFibGUgaG9vayB3aWxsIHBpY2sgaXQgdXAgbGF0ZXIuCgogICAgICBpZiAoIWZpcnN0KSByZXR1cm4KICAgICAgZmlyc3QgPSBmYWxzZQoKICAgICAgY29uc3QgdmFsdWUgPSBiNGEuYWxsb2NVbnNhZmUoMikKICAgICAgYy51aW50MTYuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogMiwgYnVmZmVyOiB2YWx1ZSB9LCBzZWxmLmlvLnNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydCkKCiAgICAgIHNlbGYuX3JlcXVlc3QoCiAgICAgICAgZGF0YS5mcm9tLAogICAgICAgIGZhbHNlLAogICAgICAgIHRydWUsCiAgICAgICAgUElOR19OQVQsCiAgICAgICAgbnVsbCwKICAgICAgICB2YWx1ZSwKICAgICAgICBudWxsLAogICAgICAgICgpID0+IHsKICAgICAgICAgIHRlc3ROYXQgPSB0cnVlCiAgICAgICAgfSwKICAgICAgICBub29wCiAgICAgICkKICAgIH0KICB9CgogIHJlZnJlc2goKSB7CiAgICBjb25zdCBub2RlID0gdGhpcy50YWJsZS5yYW5kb20oKQogICAgdGhpcy5fYmFja2dyb3VuZFF1ZXJ5KG5vZGUgPyBub2RlLmlkIDogdGhpcy50YWJsZS5pZCkub24oJ2Vycm9yJywgbm9vcCkKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBjb25zdCBlbWl0Q2xvc2UgPSAhdGhpcy5kZXN0cm95ZWQKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgY2xlYXJJbnRlcnZhbCh0aGlzLl90aWNrSW50ZXJ2YWwpCiAgICBhd2FpdCB0aGlzLmlvLmRlc3Ryb3koKQogICAgaWYgKGVtaXRDbG9zZSkgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfcmVxdWVzdCh0bywgZm9yY2UsIGludGVybmFsLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlLCBzZXNzaW9uLCBvbnJlc3BvbnNlLCBvbmVycm9yKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLmlvLmNyZWF0ZVJlcXVlc3QodG8sIG51bGwsIGludGVybmFsLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlLCBzZXNzaW9uKQogICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICByZXEub25yZXNwb25zZSA9IG9ucmVzcG9uc2UKICAgIHJlcS5vbmVycm9yID0gb25lcnJvcgogICAgcmVxLnNlbmQoZm9yY2UpCgogICAgcmV0dXJuIHJlcQogIH0KCiAgX25hdEFkZChob3N0LCBwb3J0KSB7CiAgICBjb25zdCBwcmV2SG9zdCA9IHRoaXMuX25hdC5ob3N0CiAgICBjb25zdCBwcmV2UG9ydCA9IHRoaXMuX25hdC5wb3J0CgogICAgdGhpcy5fbmF0LmFkZChob3N0LCBwb3J0KQoKICAgIGlmIChwcmV2SG9zdCA9PT0gdGhpcy5fbmF0Lmhvc3QgJiYgcHJldlBvcnQgPT09IHRoaXMuX25hdC5wb3J0KSByZXR1cm4KCiAgICB0aGlzLmVtaXQoJ25hdC11cGRhdGUnLCB0aGlzLl9uYXQuaG9zdCwgdGhpcy5fbmF0LnBvcnQpCiAgfQoKICAvLyB3ZSBkb24ndCBjaGVjayB0aGF0IHRoaXMgaXMgYSBib290c3RyYXAgbm9kZSBidXQgd2UgbGltaXQgdGhlIHNhbXBsZSBzaXplIHRvIHZlcnkgZmV3IG5vZGVzLCBzbyBmaW5lCiAgX3NhbXBsZUJvb3RzdHJhcE1heWJlKGZyb20sIHRvKSB7CiAgICBpZiAodGhpcy5fbm9uZVBlcnNpc3RlbnRTYW1wbGVzLmxlbmd0aCA+PSBNYXRoLm1heCgxLCB0aGlzLmJvb3RzdHJhcE5vZGVzLmxlbmd0aCkpIHJldHVybgogICAgY29uc3QgaWQgPSBmcm9tLmhvc3QgKyAnOicgKyBmcm9tLnBvcnQKICAgIGlmICh0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMuaW5kZXhPZihpZCkgPiAtMSkgcmV0dXJuCiAgICB0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMucHVzaChpZCkKICAgIHRoaXMuX25hdEFkZCh0by5ob3N0LCB0by5wb3J0KQogIH0KCiAgX2FkZE5vZGVGcm9tTmV0d29yayhzYW1wbGUsIGZyb20sIHRvKSB7CiAgICBpZiAodGhpcy5fZmlsdGVyTm9kZSAhPT0gbnVsbCAmJiAhdGhpcy5fZmlsdGVyTm9kZShmcm9tKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoZnJvbS5pZCA9PT0gbnVsbCkgewogICAgICB0aGlzLl9zYW1wbGVCb290c3RyYXBNYXliZShmcm9tLCB0bykKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3Qgb2xkTm9kZSA9IHRoaXMudGFibGUuZ2V0KGZyb20uaWQpCgogICAgLy8gcmVmcmVzaCBpdCwgaWYgd2UndmUgc2VlbiB0aGlzIGJlZm9yZQogICAgaWYgKG9sZE5vZGUpIHsKICAgICAgaWYgKHNhbXBsZSAmJiAob2xkTm9kZS5zYW1wbGVkID09PSAwIHx8IHRoaXMuX3RpY2sgLSBvbGROb2RlLnNhbXBsZWQgPj0gT0xEX05PREUpKSB7CiAgICAgICAgb2xkTm9kZS50byA9IHRvCiAgICAgICAgb2xkTm9kZS5zYW1wbGVkID0gdGhpcy5fdGljawogICAgICAgIHRoaXMuX25hdEFkZCh0by5ob3N0LCB0by5wb3J0KQogICAgICB9CgogICAgICBvbGROb2RlLnBpbmdlZCA9IG9sZE5vZGUuc2VlbiA9IHRoaXMuX3RpY2sKICAgICAgdGhpcy5ub2Rlcy5hZGQob2xkTm9kZSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fYWRkTm9kZSh7CiAgICAgIGlkOiBmcm9tLmlkLAogICAgICBwb3J0OiBmcm9tLnBvcnQsCiAgICAgIGhvc3Q6IGZyb20uaG9zdCwKICAgICAgdG8sCiAgICAgIHNhbXBsZWQ6IDAsCiAgICAgIGFkZGVkOiB0aGlzLl90aWNrLAogICAgICBwaW5nZWQ6IHRoaXMuX3RpY2ssIC8vIGxhc3QgdGltZSB3ZSBpbnRlcmFjdGVkIHdpdGggdGhlbQogICAgICBzZWVuOiB0aGlzLl90aWNrLCAvLyBsYXN0IHRpbWUgd2UgaGVhcmQgZnJvbSB0aGVtCiAgICAgIGRvd25IaW50czogMCwKICAgICAgcHJldjogbnVsbCwKICAgICAgbmV4dDogbnVsbAogICAgfSkKICB9CgogIF9hZGROb2RlKG5vZGUpIHsKICAgIGlmICh0aGlzLm5vZGVzLmhhcyhub2RlKSB8fCBiNGEuZXF1YWxzKG5vZGUuaWQsIHRoaXMudGFibGUuaWQpKSByZXR1cm4KCiAgICBub2RlLmFkZGVkID0gbm9kZS5waW5nZWQgPSBub2RlLnNlZW4gPSB0aGlzLl90aWNrCgogICAgaWYgKCF0aGlzLnRhYmxlLmFkZChub2RlKSkgcmV0dXJuCiAgICB0aGlzLm5vZGVzLmFkZChub2RlKQoKICAgIGlmIChub2RlLnRvICYmIG5vZGUuc2FtcGxlZCA9PT0gMCkgewogICAgICBub2RlLnNhbXBsZWQgPSB0aGlzLl90aWNrCiAgICAgIHRoaXMuX25hdEFkZChub2RlLnRvLmhvc3QsIG5vZGUudG8ucG9ydCkKICAgIH0KCiAgICB0aGlzLmVtaXQoJ2FkZC1ub2RlJywgbm9kZSkKICB9CgogIF9yZW1vdmVTdGFsZU5vZGUobm9kZSwgbGFzdFNlZW4pIHsKICAgIGlmIChub2RlLnNlZW4gPD0gbGFzdFNlZW4pIHRoaXMuX3JlbW92ZU5vZGUobm9kZSkKICB9CgogIF9yZW1vdmVOb2RlKG5vZGUpIHsKICAgIGlmICghdGhpcy5ub2Rlcy5oYXMobm9kZSkpIHJldHVybgoKICAgIHRoaXMudGFibGUucmVtb3ZlKG5vZGUuaWQpCiAgICB0aGlzLm5vZGVzLnJlbW92ZShub2RlKQoKICAgIHRoaXMuZW1pdCgncmVtb3ZlLW5vZGUnLCBub2RlKQogIH0KCiAgX29ud2FrZXVwKCkgewogICAgdGhpcy5fdGljayArPSAyICogT0xEX05PREUgLy8gYnVtcCB0aGUgdGljayBlbm91Z2ggdGhhdCBldmVyeXRoaW5nIGFwcGVhcnMgb2xkLgogICAgdGhpcy5fdGljayArPSA4IC0gKHRoaXMuX3RpY2sgJiA3KSAtIDIgLy8gdHJpZ2dlcnMgYSBzZXJpZXMgb2YgcGluZ3MgaW4gdHdvIHRpY2tzCiAgICB0aGlzLl9zdGFibGVUaWNrcyA9IE1PUkVfU1RBQkxFX1RJQ0tTCiAgICB0aGlzLl9yZWZyZXNoVGlja3MgPSAxIC8vIHRyaWdnZXJzIGEgcmVmcmVzaCBuZXh0IHRpY2sgKGFsbG93IG5ldHdvcmsgdGltZSB0byB3YWtlIHVwIGFsc28pCiAgICB0aGlzLl9sYXN0SG9zdCA9IG51bGwgLy8gY2xlYXIgbmV0d29yayBjYWNoZSBjaGVjawoKICAgIGlmICh0aGlzLmFkYXB0aXZlKSB7CiAgICAgIC8vIFRPRE86IHJlLWVuYWJsZSB0aGlzIGFzIHNvb24gYXMgd2UgZmluZCBvdXQgd2h5IHRoaXMgaXMgb3ZlciB0cmlnZ2VyaW5nIGluIHNvbWUgZWRnZSBjYXNlcwogICAgICAvLyB0aGlzLmZpcmV3YWxsZWQgPSB0cnVlCiAgICAgIC8vIHRoaXMuaW8uZmlyZXdhbGxlZCA9IHRydWUKCiAgICAgIGlmICghdGhpcy5lcGhlbWVyYWwpIHsKICAgICAgICB0aGlzLmVwaGVtZXJhbCA9IHRydWUKICAgICAgICB0aGlzLmlvLmVwaGVtZXJhbCA9IHRydWUKICAgICAgICB0aGlzLmVtaXQoJ2VwaGVtZXJhbCcpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmVtaXQoJ3dha2V1cCcpCiAgfQoKICBfb25mdWxscm93KG5ld05vZGUsIHJvdykgewogICAgaWYgKCF0aGlzLmJvb3RzdHJhcHBlZCB8fCB0aGlzLl9yZXBpbmdpbmcgPj0gMykgcmV0dXJuCgogICAgbGV0IG9sZGVzdCA9IG51bGwKICAgIGZvciAoY29uc3Qgbm9kZSBvZiByb3cubm9kZXMpIHsKICAgICAgaWYgKG5vZGUucGluZ2VkID09PSB0aGlzLl90aWNrKSBjb250aW51ZQogICAgICBpZiAoCiAgICAgICAgb2xkZXN0ID09PSBudWxsIHx8CiAgICAgICAgb2xkZXN0LnBpbmdlZCA+IG5vZGUucGluZ2VkIHx8CiAgICAgICAgKG9sZGVzdC5waW5nZWQgPT09IG5vZGUucGluZ2VkICYmIG9sZGVzdC5hZGRlZCA+IG5vZGUuYWRkZWQpCiAgICAgICkgewogICAgICAgIG9sZGVzdCA9IG5vZGUKICAgICAgfQogICAgfQoKICAgIGlmIChvbGRlc3QgPT09IG51bGwpIHJldHVybgogICAgaWYgKHRoaXMuX3RpY2sgLSBvbGRlc3QucGluZ2VkIDwgUkVDRU5UX05PREUgJiYgdGhpcy5fdGljayAtIG9sZGVzdC5hZGRlZCA+IE9MRF9OT0RFKSByZXR1cm4KCiAgICB0aGlzLl9yZXBpbmdBbmRTd2FwKG5ld05vZGUsIG9sZGVzdCkKICB9CgogIF9vbm5ldHdvcmtjaGFuZ2UoaW50ZXJmYWNlcykgewogICAgdGhpcy5lbWl0KCduZXR3b3JrLWNoYW5nZScsIGludGVyZmFjZXMpCiAgICB0aGlzLmVtaXQoJ25ldHdvcmstdXBkYXRlJykKICB9CgogIF9yZXBpbmdBbmRTd2FwKG5ld05vZGUsIG9sZE5vZGUpIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICBjb25zdCBsYXN0U2VlbiA9IG9sZE5vZGUuc2VlbgoKICAgIG9sZE5vZGUucGluZ2VkID0gdGhpcy5fdGljawoKICAgIHRoaXMuX3JlcGluZ2luZysrCiAgICB0aGlzLl9yZXF1ZXN0KAogICAgICB7IGlkOiBudWxsLCBob3N0OiBvbGROb2RlLmhvc3QsIHBvcnQ6IG9sZE5vZGUucG9ydCB9LAogICAgICBmYWxzZSwKICAgICAgdHJ1ZSwKICAgICAgUElORywKICAgICAgbnVsbCwKICAgICAgbnVsbCwKICAgICAgbnVsbCwKICAgICAgb25zdWNjZXNzLAogICAgICBvbnN3YXAKICAgICkKCiAgICBmdW5jdGlvbiBvbnN1Y2Nlc3MobSkgewogICAgICBpZiAob2xkTm9kZS5zZWVuIDw9IGxhc3RTZWVuKSByZXR1cm4gb25zd2FwKCkKICAgICAgc2VsZi5fcmVwaW5naW5nLS0KICAgIH0KCiAgICBmdW5jdGlvbiBvbnN3YXAoZSkgewogICAgICBzZWxmLl9yZXBpbmdpbmctLQogICAgICBzZWxmLl9yZW1vdmVOb2RlKG9sZE5vZGUpCiAgICAgIHNlbGYuX2FkZE5vZGUobmV3Tm9kZSkKICAgIH0KICB9CgogIF9vbnJlcXVlc3QocmVxLCBleHRlcm5hbCkgewogICAgaWYgKHJlcS5mcm9tLmlkICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2FkZE5vZGVGcm9tTmV0d29yayghZXh0ZXJuYWwsIHJlcS5mcm9tLCByZXEudG8pCiAgICB9CgogICAgaWYgKHJlcS5pbnRlcm5hbCkgewogICAgICBzd2l0Y2ggKHJlcS5jb21tYW5kKSB7CiAgICAgICAgLy8gc3RhbmRhcmQga2VlcCBhbGl2ZSBjYWxsCiAgICAgICAgY2FzZSBQSU5HOiB7CiAgICAgICAgICByZXEuc2VuZFJlcGx5KDAsIG51bGwsIGZhbHNlLCBmYWxzZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICAvLyBjaGVjayBpZiB0aGUgb3RoZXIgc2lkZSBjYW4gcmVjZWl2ZSBhIG1lc3NhZ2UgdG8gdGhlaXIgb3RoZXIgc29ja2V0CiAgICAgICAgY2FzZSBQSU5HX05BVDogewogICAgICAgICAgaWYgKHJlcS52YWx1ZSA9PT0gbnVsbCB8fCByZXEudmFsdWUuYnl0ZUxlbmd0aCA8IDIpIHJldHVybgogICAgICAgICAgY29uc3QgcG9ydCA9IGMudWludDE2LmRlY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDIsIGJ1ZmZlcjogcmVxLnZhbHVlIH0pCiAgICAgICAgICBpZiAocG9ydCA9PT0gMCkgcmV0dXJuCiAgICAgICAgICByZXEuZnJvbS5wb3J0ID0gcG9ydAogICAgICAgICAgcmVxLnNlbmRSZXBseSgwLCBudWxsLCBmYWxzZSwgZmFsc2UpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgLy8gZW1wdHkgZGh0IHJlcGx5IGJhY2sKICAgICAgICBjYXNlIEZJTkRfTk9ERTogewogICAgICAgICAgaWYgKCFyZXEudGFyZ2V0KSByZXR1cm4KICAgICAgICAgIHJlcS5zZW5kUmVwbHkoMCwgbnVsbCwgZmFsc2UsIHRydWUpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgLy8gInRoaXMgaXMgbm9kZSB5b3Ugc2VudCBtZSBpcyBkb3duIiAtIGxldCdzIHRyeSB0byBwaW5nIGl0CiAgICAgICAgY2FzZSBET1dOX0hJTlQ6IHsKICAgICAgICAgIGlmIChyZXEudmFsdWUgPT09IG51bGwgfHwgcmVxLnZhbHVlLmJ5dGVMZW5ndGggPCA2KSByZXR1cm4KICAgICAgICAgIGlmICh0aGlzLl9jaGVja3MgPCAxMCkgewogICAgICAgICAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKFRNUCwgcmVxLnZhbHVlLnN1YmFycmF5KDAsIDYpKQogICAgICAgICAgICBjb25zdCBub2RlID0gdGhpcy50YWJsZS5nZXQoVE1QKQogICAgICAgICAgICBpZiAobm9kZSAmJiAobm9kZS5waW5nZWQgPCB0aGlzLl90aWNrIHx8IG5vZGUuZG93bkhpbnRzID09PSAwKSkgewogICAgICAgICAgICAgIG5vZGUuZG93bkhpbnRzKysKICAgICAgICAgICAgICB0aGlzLl9jaGVjayhub2RlKQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXEuc2VuZFJlcGx5KDAsIG51bGwsIGZhbHNlLCBmYWxzZSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVxLnNlbmRSZXBseShVTktOT1dOX0NPTU1BTkQsIG51bGwsIGZhbHNlLCByZXEudGFyZ2V0ICE9PSBudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBhc2sgdGhlIHVzZXIgdG8gaGFuZGxlIGl0IG9yIHJlcGx5IGJhY2sgd2l0aCBhIGJhZCBjb21tYW5kCiAgICBpZiAodGhpcy5vbnJlcXVlc3QocmVxKSA9PT0gZmFsc2UpIHsKICAgICAgcmVxLnNlbmRSZXBseShVTktOT1dOX0NPTU1BTkQsIG51bGwsIGZhbHNlLCByZXEudGFyZ2V0ICE9PSBudWxsKQogICAgfQogIH0KCiAgb25yZXF1ZXN0KHJlcSkgewogICAgcmV0dXJuIHRoaXMuZW1pdCgncmVxdWVzdCcsIHJlcSkKICB9CgogIF9vbnJlc3BvbnNlKHJlcywgZXh0ZXJuYWwpIHsKICAgIHRoaXMuX2FkZE5vZGVGcm9tTmV0d29yayghZXh0ZXJuYWwsIHJlcy5mcm9tLCByZXMudG8pCiAgfQoKICBfb250aW1lb3V0KHJlcSkgewogICAgaWYgKCFyZXEudG8uaWQpIHJldHVybgogICAgY29uc3Qgbm9kZSA9IHRoaXMudGFibGUuZ2V0KHJlcS50by5pZCkKICAgIGlmIChub2RlKSB0aGlzLl9yZW1vdmVOb2RlKG5vZGUpCiAgfQoKICBfcGluZ1NvbWUoKSB7CiAgICBsZXQgY250ID0gdGhpcy5pby5pbmZsaWdodC5sZW5ndGggPiAyID8gMyA6IDUKICAgIGxldCBvbGRlc3QgPSB0aGlzLm5vZGVzLm9sZGVzdAoKICAgIC8vIHRpbnkgZGh0LCBwaW5nZWQgdGhlIGJvb3RzdHJhcCBhZ2FpbgogICAgaWYgKCFvbGRlc3QpIHsKICAgICAgdGhpcy5yZWZyZXNoKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gd2UndmUgcmVjZW50bHkgcGluZ2VkIHRoZSBvbGRlc3Qgb25lLCBzbyBvbmx5IHRyaWdnZXIgYSBjb3VwbGUgb2YgcmVwaW5ncwogICAgaWYgKHRoaXMuX3RpY2sgLSBvbGRlc3QucGluZ2VkIDwgUkVDRU5UX05PREUpIHsKICAgICAgY250ID0gMgogICAgfQoKICAgIHdoaWxlIChjbnQtLSkgewogICAgICBpZiAoIW9sZGVzdCB8fCB0aGlzLl90aWNrID09PSBvbGRlc3QucGluZ2VkKSBjb250aW51ZQogICAgICB0aGlzLl9jaGVjayhvbGRlc3QpCiAgICAgIG9sZGVzdCA9IG9sZGVzdC5uZXh0CiAgICB9CiAgfQoKICBfY2hlY2sobm9kZSkgewogICAgbm9kZS5waW5nZWQgPSB0aGlzLl90aWNrCgogICAgY29uc3QgbGFzdFNlZW4gPSBub2RlLnNlZW4KICAgIGNvbnN0IG9ucmVzcG9uc2UgPSAoKSA9PiB7CiAgICAgIHRoaXMuX2NoZWNrcy0tCiAgICAgIHRoaXMuX3JlbW92ZVN0YWxlTm9kZShub2RlLCBsYXN0U2VlbikKICAgIH0KICAgIGNvbnN0IG9uZXJyb3IgPSAoKSA9PiB7CiAgICAgIHRoaXMuX2NoZWNrcy0tCiAgICAgIHRoaXMuX3JlbW92ZU5vZGUobm9kZSkKICAgIH0KCiAgICB0aGlzLl9jaGVja3MrKwogICAgdGhpcy5fcmVxdWVzdCgKICAgICAgeyBpZDogbnVsbCwgaG9zdDogbm9kZS5ob3N0LCBwb3J0OiBub2RlLnBvcnQgfSwKICAgICAgZmFsc2UsCiAgICAgIHRydWUsCiAgICAgIFBJTkcsCiAgICAgIG51bGwsCiAgICAgIG51bGwsCiAgICAgIG51bGwsCiAgICAgIG9ucmVzcG9uc2UsCiAgICAgIG9uZXJyb3IKICAgICkKICB9CgogIF9vbnRpY2soKSB7CiAgICBjb25zdCB0aW1lID0gRGF0ZS5ub3coKQoKICAgIGlmICh0aW1lIC0gdGhpcy5fbGFzdFRpY2sgPiBTTEVFUElOR19JTlRFUlZBTCAmJiB0aGlzLnN1c3BlbmRlZCA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fb253YWtldXAoKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdGljaysrCiAgICB9CgogICAgdGhpcy5fbGFzdFRpY2sgPSB0aW1lCgogICAgaWYgKCF0aGlzLmJvb3RzdHJhcHBlZCB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMuYWRhcHRpdmUgJiYgdGhpcy5lcGhlbWVyYWwgJiYgLS10aGlzLl9zdGFibGVUaWNrcyA8PSAwKSB7CiAgICAgIGlmICh0aGlzLl9sYXN0SG9zdCA9PT0gdGhpcy5fbmF0Lmhvc3QpIHsKICAgICAgICAvLyBkbyBub3QgcmVjaGVjayB0aGUgc2FtZSBuZXR3b3JrLi4uCiAgICAgICAgdGhpcy5fc3RhYmxlVGlja3MgPSBNT1JFX1NUQUJMRV9USUNLUwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3VwZGF0ZU5ldHdvcmtTdGF0ZSgpIC8vIHRoZSBwcm9taXNlIHJldHVybmVkIGhlcmUgbmV2ZXIgZmFpbHMgc28ganVzdCBpZ25vcmUgaXQKICAgICAgfQogICAgfQoKICAgIGlmICgodGhpcy5fdGljayAmIDcpID09PSAwKSB7CiAgICAgIHRoaXMuX3BpbmdTb21lKCkKICAgIH0KCiAgICBpZiAoCiAgICAgICgodGhpcy5fdGljayAmIDYzKSA9PT0gMCAmJiB0aGlzLm5vZGVzLmxlbmd0aCA8IHRoaXMudGFibGUuaykgfHwKICAgICAgLS10aGlzLl9yZWZyZXNoVGlja3MgPD0gMAogICAgKSB7CiAgICAgIHRoaXMucmVmcmVzaCgpCiAgICB9CiAgfQoKICBhc3luYyBfdXBkYXRlTmV0d29ya1N0YXRlKG9ubHlGaXJld2FsbCA9IGZhbHNlKSB7CiAgICBpZiAoIXRoaXMuZXBoZW1lcmFsKSByZXR1cm4gZmFsc2UKICAgIGlmIChvbmx5RmlyZXdhbGwgJiYgIXRoaXMuZmlyZXdhbGxlZCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgeyBob3N0LCBwb3J0IH0gPSB0aGlzLl9uYXQKCiAgICBpZiAoIW9ubHlGaXJld2FsbCkgewogICAgICAvLyByZW1lbWJlciB3aGF0IGhvc3Qgd2UgY2hlY2tlZCBhbmQgcmVzZXQgdGhlIGNvdW50ZXIKICAgICAgdGhpcy5fc3RhYmxlVGlja3MgPSBNT1JFX1NUQUJMRV9USUNLUwogICAgICB0aGlzLl9sYXN0SG9zdCA9IGhvc3QKICAgIH0KCiAgICAvLyBjaGVjayBpZiB3ZSBoYXZlIGEgY29uc2lzdGVudCBob3N0IGFuZCBwb3J0CiAgICBpZiAoaG9zdCA9PT0gbnVsbCB8fCBwb3J0ID09PSAwKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IG5hdFNhbXBsZXIgPSB0aGlzLmZpcmV3YWxsZWQgPyBuZXcgTmF0U2FtcGxlcigpIDogdGhpcy5fbmF0CgogICAgLy8gYXNrIHJlbW90ZSBub2RlcyB0byBwaW5nIHVzIG9uIG91ciBzZXJ2ZXIgc29ja2V0IHRvIHNlZSBpZiB3ZSBoYXZlIHRoZSBwb3J0IG9wZW4KICAgIGNvbnN0IGZpcmV3YWxsZWQgPSB0aGlzLmZpcmV3YWxsZWQgJiYgKGF3YWl0IHRoaXMuX2NoZWNrSWZGaXJld2FsbGVkKG5hdFNhbXBsZXIpKQogICAgaWYgKGZpcmV3YWxsZWQpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuZmlyZXdhbGxlZCA9IHRoaXMuaW8uZmlyZXdhbGxlZCA9IGZhbHNlCgogICAgLy8gaW5jYXNlIGl0J3MgY2FsbGVkIGluIHBhcmFsbGVsIGZvciBzb21lIHJlYXNvbiwgb3IgaWYgb3VyIG5hdCBzdGF0dXMgc29tZWhvdyBjaGFuZ2VkCiAgICBpZiAoIXRoaXMuZXBoZW1lcmFsIHx8IGhvc3QgIT09IHRoaXMuX25hdC5ob3N0IHx8IHBvcnQgIT09IHRoaXMuX25hdC5wb3J0KSByZXR1cm4gZmFsc2UKICAgIC8vIGlmIHRoZSBmaXJld2FsbCBwcm9iZSByZXR1cm5lZCBhIGRpZmZlcmVudCBob3N0IC8gbm9uIGNvbnNpc3RlbnQgcG9ydCwgYmFpbCBhcyB3ZWxsCiAgICBpZiAobmF0U2FtcGxlci5ob3N0ICE9PSBob3N0IHx8IG5hdFNhbXBsZXIucG9ydCA9PT0gMCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaWQgPSBwZWVyLmlkKG5hdFNhbXBsZXIuaG9zdCwgbmF0U2FtcGxlci5wb3J0KQoKICAgIGlmICghb25seUZpcmV3YWxsKSB7CiAgICAgIHRoaXMuZXBoZW1lcmFsID0gdGhpcy5pby5lcGhlbWVyYWwgPSBmYWxzZQogICAgfQoKICAgIGlmIChuYXRTYW1wbGVyICE9PSB0aGlzLl9uYXQpIHsKICAgICAgY29uc3QgcHJldkhvc3QgPSB0aGlzLl9uYXQuaG9zdAogICAgICBjb25zdCBwcmV2UG9ydCA9IHRoaXMuX25hdC5wb3J0CgogICAgICB0aGlzLl9ub25lUGVyc2lzdGVudFNhbXBsZXMgPSBbXQogICAgICB0aGlzLl9uYXQgPSBuYXRTYW1wbGVyCgogICAgICBpZiAocHJldkhvc3QgIT09IHRoaXMuX25hdC5ob3N0IHx8IHByZXZQb3J0ICE9PSB0aGlzLl9uYXQucG9ydCkgewogICAgICAgIHRoaXMuZW1pdCgnbmF0LXVwZGF0ZScsIHRoaXMuX25hdC5ob3N0LCB0aGlzLl9uYXQucG9ydCkKICAgICAgfQogICAgfQoKICAgIC8vIFRPRE86IHdlIHNob3VsZCBtYWtlIHRoaXMgYSBiaXQgbW9yZSBkZWZlbnNpdmUgaW4gdGVybXMgb2YgdXNpbmcgbW9yZQogICAgLy8gcmVzb3VyY2VzIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBuZXcgcm91dGluZyB0YWJsZSBjb250YWlucyBhcyBtYW55IGFsaXZlIG5vZGVzCiAgICAvLyBhcyBwb3NzaWJsZSwgdnMgYmxpbmRseSBjb3B5aW5nIHRoZW0gb3Zlci4uLgoKICAgIC8vIGFsbCBnb29kISBjb3B5IG92ZXIgdGhlIG9sZCByb3V0aW5nIHRhYmxlIHRvIHRoZSBuZXcgb25lCiAgICBpZiAoIWI0YS5lcXVhbHModGhpcy50YWJsZS5pZCwgaWQpKSB7CiAgICAgIGNvbnN0IG5vZGVzID0gdGhpcy50YWJsZS50b0FycmF5KCkKCiAgICAgIHRoaXMudGFibGUgPSB0aGlzLmlvLnRhYmxlID0gbmV3IFRhYmxlKGlkKQoKICAgICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7CiAgICAgICAgaWYgKGI0YS5lcXVhbHMobm9kZS5pZCwgaWQpKSBjb250aW51ZQogICAgICAgIGlmICghdGhpcy50YWJsZS5hZGQobm9kZSkpIHRoaXMubm9kZXMucmVtb3ZlKG5vZGUpCiAgICAgIH0KCiAgICAgIHRoaXMudGFibGUub24oJ3JvdycsIHRoaXMuX29ucm93KQoKICAgICAgLy8gd2UgbmVlZCB0byByZWJvb3RzdHJhcC9yZWZyZXNoIHNpbmNlIHdlIHVwZGF0ZWQgb3VyIGlkCiAgICAgIGlmICh0aGlzLmJvb3RzdHJhcHBlZCkgdGhpcy5yZWZyZXNoKCkKICAgIH0KCiAgICBpZiAoIXRoaXMuZXBoZW1lcmFsKSB7CiAgICAgIHRoaXMuZW1pdCgncGVyc2lzdGVudCcpCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jICpfcmVzb2x2ZUJvb3RzdHJhcE5vZGVzKCkgewogICAgZm9yIChsZXQgeyBob3N0LCBwb3J0IH0gb2YgdGhpcy5ib290c3RyYXBOb2RlcykgewogICAgICBsZXQgZG9Mb29rdXAgPSBmYWxzZQoKICAgICAgaWYgKGhvc3QuaW5kZXhPZignQCcpID09PSAtMSkgewogICAgICAgIGRvTG9va3VwID0gdHJ1ZQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IFtzdWdnZXN0ZWRJUCwgZmFsbGJhY2tIb3N0XSA9IGhvc3Quc3BsaXQoJ0AnKQogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCB0aGlzLnBpbmcoeyBob3N0OiBzdWdnZXN0ZWRJUCwgcG9ydCB9KQogICAgICAgICAgaG9zdCA9IHN1Z2dlc3RlZElQCiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICBob3N0ID0gZmFsbGJhY2tIb3N0CiAgICAgICAgICBkb0xvb2t1cCA9IHRydWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChkb0xvb2t1cCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBob3N0ID0gVURYLmlzSVB2NChob3N0KSA/IGhvc3QgOiAoYXdhaXQgdGhpcy51ZHgubG9va3VwKGhvc3QsIHsgZmFtaWx5OiA0IH0pKS5ob3N0CiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgeWllbGQgewogICAgICAgIGlkOiBwZWVyLmlkKGhvc3QsIHBvcnQpLAogICAgICAgIGhvc3QsCiAgICAgICAgcG9ydAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBfYWRkQm9vdHN0cmFwTm9kZXMobm9kZXMpIHsKICAgIGZvciBhd2FpdCAoY29uc3Qgbm9kZSBvZiB0aGlzLl9yZXNvbHZlQm9vdHN0cmFwTm9kZXMoKSkgewogICAgICBub2Rlcy5wdXNoKG5vZGUpCiAgICB9CiAgfQoKICBhc3luYyBfY2hlY2tJZkZpcmV3YWxsZWQobmF0U2FtcGxlciA9IG5ldyBOYXRTYW1wbGVyKCkpIHsKICAgIGNvbnN0IG5vZGVzID0gW10KICAgIGZvciAobGV0IG5vZGUgPSB0aGlzLm5vZGVzLmxhdGVzdDsgbm9kZSAmJiBub2Rlcy5sZW5ndGggPCA1OyBub2RlID0gbm9kZS5wcmV2KSB7CiAgICAgIG5vZGVzLnB1c2gobm9kZSkKICAgIH0KCiAgICBpZiAobm9kZXMubGVuZ3RoIDwgNSkgYXdhaXQgdGhpcy5fYWRkQm9vdHN0cmFwTm9kZXMobm9kZXMpCiAgICAvLyBpZiBubyBub2RlcyBhcmUgYXZhaWxhYmxlLCBpbmNsdWRpbmcgYm9vdHN0cmFwcGVycyAtIGJhaWwKICAgIGlmIChub2Rlcy5sZW5ndGggPT09IDApIHJldHVybiB0cnVlCgogICAgY29uc3QgaG9zdHMgPSBuZXcgU2V0KCkKICAgIGNvbnN0IHZhbHVlID0gYjRhLmFsbG9jVW5zYWZlKDIpCgogICAgYy51aW50MTYuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogMiwgYnVmZmVyOiB2YWx1ZSB9LCB0aGlzLmlvLnNlcnZlclNvY2tldC5hZGRyZXNzKCkucG9ydCkKCiAgICAvLyBkb3VibGUgY2hlY2sgdGhleSBhY3R1YWxseSBjYW1lIG9uIHRoZSBzZXJ2ZXIgc29ja2V0Li4uCiAgICB0aGlzLmlvLnNlcnZlclNvY2tldC5vbignbWVzc2FnZScsIG9ubWVzc2FnZSkKCiAgICBjb25zdCBwb25ncyA9IGF3YWl0IHJlcXVlc3RBbGwodGhpcywgdHJ1ZSwgUElOR19OQVQsIHZhbHVlLCBub2RlcykKCiAgICBsZXQgY291bnQgPSAwCiAgICBmb3IgKGNvbnN0IHJlcyBvZiBwb25ncykgewogICAgICBpZiAoaG9zdHMuaGFzKHJlcy5mcm9tLmhvc3QpKSB7CiAgICAgICAgY291bnQrKwogICAgICAgIG5hdFNhbXBsZXIuYWRkKHJlcy50by5ob3N0LCByZXMudG8ucG9ydCkKICAgICAgfQogICAgfQoKICAgIHRoaXMuaW8uc2VydmVyU29ja2V0LnJlbW92ZUxpc3RlbmVyKCdtZXNzYWdlJywgb25tZXNzYWdlKQoKICAgIC8vIGlmIHdlIGdvdCBubyBvciB2ZXJ5IGZldyByZXBsaWVzLCBjb25zaWRlciBpdCBhIGZsdWtlCiAgICBpZiAoY291bnQgPCAobm9kZXMubGVuZ3RoID49IDUgPyAzIDogMSkpIHJldHVybiB0cnVlCgogICAgLy8gY2hlY2sgdGhhdCB0aGUgc2VydmVyIHNvY2tldCBoYXMgdGhlIHNhbWUgaXAgYXMgdGhlIGNsaWVudCBzb2NrZXQKICAgIGlmIChuYXRTYW1wbGVyLmhvc3QgPT09IG51bGwgfHwgdGhpcy5fbmF0Lmhvc3QgIT09IG5hdFNhbXBsZXIuaG9zdCkgcmV0dXJuIHRydWUKCiAgICAvLyBjaGVjayB0aGF0IHRoZSBsb2NhbCBwb3J0IG9mIHRoZSBzZXJ2ZXIgc29ja2V0IGlzIHRoZSBzYW1lIGFzIHRoZSByZW1vdGUgcG9ydAogICAgLy8gVE9ETzogd2UgbWlnaHQgd2FudCBhIGZsYWcgdG8gb3B0IG91dCBvZiB0aGlzIGhldXJpc3RpYyBmb3Igc3BlY2lmaWMgcmVtYXBwZWQgcG9ydCBzZXJ2ZXJzCiAgICBpZiAobmF0U2FtcGxlci5wb3J0ID09PSAwIHx8IG5hdFNhbXBsZXIucG9ydCAhPT0gdGhpcy5pby5zZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQpIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKCiAgICBmdW5jdGlvbiBvbm1lc3NhZ2UoXywgeyBob3N0IH0pIHsKICAgICAgaG9zdHMuYWRkKGhvc3QpCiAgICB9CiAgfQoKICBfYmFja2dyb3VuZFF1ZXJ5KHRhcmdldCkgewogICAgdGhpcy5fcmVmcmVzaFRpY2tzID0gUkVGUkVTSF9USUNLUwoKICAgIGNvbnN0IGJhY2tncm91bmRDb24gPSBNYXRoLm1pbih0aGlzLmNvbmN1cnJlbmN5LCBNYXRoLm1heCgyLCAodGhpcy5jb25jdXJyZW5jeSAvIDgpIHwgMCkpCiAgICBjb25zdCBxID0gbmV3IFF1ZXJ5KHRoaXMsIHRhcmdldCwgdHJ1ZSwgRklORF9OT0RFLCBudWxsLCB7CiAgICAgIGNvbmN1cnJlbmN5OiBiYWNrZ3JvdW5kQ29uLAogICAgICBtYXhTbG93OiAwCiAgICB9KQoKICAgIHEub24oJ2RhdGEnLCAoKSA9PiB7CiAgICAgIC8vIHlpZWxkIHRvIG90aGVyIHRyYWZmaWMKICAgICAgcS5jb25jdXJyZW5jeSA9IHRoaXMuaW8uaW5mbGlnaHQubGVuZ3RoIDwgMyA/IHRoaXMuY29uY3VycmVuY3kgOiBiYWNrZ3JvdW5kQ29uCiAgICB9KQoKICAgIHJldHVybiBxCiAgfQoKICAvLyBjYWxsZWQgYnkgdGhlIHF1ZXJ5CiAgX29ubGluZSgpIHsKICAgIGlmICh0aGlzLm9ubGluZSkgcmV0dXJuCiAgICB0aGlzLm9ubGluZSA9IHRydWUKICAgIHRoaXMuZW1pdCgnbmV0d29yay11cGRhdGUnKQogIH0KCiAgLy8gY2FsbGVkIGJ5IHRoZSBxdWVyeQogIF9vZmZsaW5lKCkgewogICAgaWYgKCF0aGlzLm9ubGluZSkgcmV0dXJuCiAgICB0aGlzLm9ubGluZSA9IGZhbHNlCiAgICB0aGlzLmVtaXQoJ25ldHdvcmstdXBkYXRlJykKICB9Cn0KCkRIVC5PSyA9IDAKREhULkVSUk9SX1VOS05PV05fQ09NTUFORCA9IFVOS05PV05fQ09NTUFORApESFQuRVJST1JfSU5WQUxJRF9UT0tFTiA9IElOVkFMSURfVE9LRU4KCm1vZHVsZS5leHBvcnRzID0gREhUCgpmdW5jdGlvbiBsb2NhbElQKHVkeCwgZmFtaWx5ID0gNCkgewogIGxldCBob3N0ID0gbnVsbAoKICBmb3IgKGNvbnN0IG4gb2YgdWR4Lm5ldHdvcmtJbnRlcmZhY2VzKCkpIHsKICAgIGlmIChuLmZhbWlseSAhPT0gZmFtaWx5IHx8IG4uaW50ZXJuYWwpIGNvbnRpbnVlCgogICAgLy8gbWFjIHJlYWxseSBsaWtlcyBlbjAsIG1iIGEgYmV0dGVyIHdheSBidXQgdGhpcyBzaG91bGRudCBiZSBiYWQgYW55d2hlcmUgc28gcmV0dXJuIG5vdwogICAgaWYgKG4ubmFtZSA9PT0gJ2VuMCcpIHJldHVybiBuLmhvc3QKCiAgICAvLyBvdGhlcndpc2UgcGljayB0aGUgZmlyc3Qgbm9uIGludGVybmFsIGhvc3QgKGxldCB0aGUgbG9vcCBjb250aW51ZSBpbiBjYXNlIHdlIHNlZSBlbjApCiAgICBpZiAoaG9zdCA9PT0gbnVsbCkgaG9zdCA9IG4uaG9zdAogIH0KCiAgcmV0dXJuIGhvc3QgfHwgKGZhbWlseSA9PT0gNCA/ICcxMjcuMC4wLjEnIDogJzo6MScpCn0KCmZ1bmN0aW9uIHBhcnNlTm9kZShzKSB7CiAgaWYgKHR5cGVvZiBzID09PSAnb2JqZWN0JykgcmV0dXJuIHMKICBpZiAodHlwZW9mIHMgPT09ICdudW1iZXInKSByZXR1cm4geyBob3N0OiAnMTI3LjAuMC4xJywgcG9ydDogcyB9CiAgY29uc3QgW2hvc3QsIHBvcnRdID0gcy5zcGxpdCgnOicpCiAgaWYgKCFwb3J0KSB0aHJvdyBuZXcgRXJyb3IoJ0Jvb3RzdHJhcCBub2RlIGZvcm1hdCBpcyBob3N0OnBvcnQnKQoKICByZXR1cm4gewogICAgaG9zdCwKICAgIHBvcnQ6IE51bWJlcihwb3J0KQogIH0KfQoKZnVuY3Rpb24gcmFuZG9tQnl0ZXMobikgewogIGNvbnN0IGIgPSBiNGEuYWxsb2MobikKICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKGIpCiAgcmV0dXJuIGIKfQoKZnVuY3Rpb24gcmFuZG9tT2Zmc2V0KG4pIHsKICByZXR1cm4gbiAtICgoTWF0aC5yYW5kb20oKSAqIDAuNSAqIG4pIHwgMCkKfQoKZnVuY3Rpb24gcmVxdWVzdEFsbChkaHQsIGludGVybmFsLCBjb21tYW5kLCB2YWx1ZSwgbm9kZXMpIHsKICBsZXQgbWlzc2luZyA9IG5vZGVzLmxlbmd0aAogIGNvbnN0IHJlcGxpZXMgPSBbXQoKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgewogICAgICBjb25zdCByZXEgPSBkaHQuX3JlcXVlc3QoCiAgICAgICAgbm9kZSwKICAgICAgICBmYWxzZSwKICAgICAgICBpbnRlcm5hbCwKICAgICAgICBjb21tYW5kLAogICAgICAgIG51bGwsCiAgICAgICAgdmFsdWUsCiAgICAgICAgbnVsbCwKICAgICAgICBvbnN1Y2Nlc3MsCiAgICAgICAgb25lcnJvcgogICAgICApCiAgICAgIGlmICghcmVxKSByZXR1cm4gcmVzb2x2ZShyZXBsaWVzKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uc3VjY2VzcyhyZXMpIHsKICAgICAgcmVwbGllcy5wdXNoKHJlcykKICAgICAgaWYgKC0tbWlzc2luZyA9PT0gMCkgcmVzb2x2ZShyZXBsaWVzKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uZXJyb3IoKSB7CiAgICAgIGlmICgtLW1pc3NpbmcgPT09IDApIHJlc29sdmUocmVwbGllcykKICAgIH0KICB9KQp9CgpmdW5jdGlvbiBub29wKCkge30KZXhwb3J0cy5QSU5HID0gMApleHBvcnRzLlBJTkdfTkFUID0gMQpleHBvcnRzLkZJTkRfTk9ERSA9IDIKZXhwb3J0cy5ET1dOX0hJTlQgPSAzCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgREhURXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlLCBmbiA9IERIVEVycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnREhURXJyb3InCiAgfQoKICBzdGF0aWMgVU5LTk9XTl9DT01NQU5EID0gMQogIHN0YXRpYyBJTlZBTElEX1RPS0VOID0gMgoKICBzdGF0aWMgUkVRVUVTVF9USU1FT1VUKG1zZyA9ICdSZXF1ZXN0IHRpbWVkIG91dCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVRVUVTVF9USU1FT1VUJywgREhURXJyb3IuUkVRVUVTVF9USU1FT1VUKQogIH0KCiAgc3RhdGljIFJFUVVFU1RfREVTVFJPWUVEKG1zZyA9ICdSZXF1ZXN0IGRlc3Ryb3llZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVRVUVTVF9ERVNUUk9ZRUQnLCBESFRFcnJvci5SRVFVRVNUX0RFU1RST1lFRCkKICB9CgogIHN0YXRpYyBJT19TVVNQRU5ERUQobXNnID0gJ0kvTyBzdXNwZW5kZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0lPX1NVU1BFTkRFRCcsIERIVEVycm9yLklPX1NVU1BFTkRFRCkKICB9Cn0KY29uc3QgRklGTyA9IHJlcXVpcmUoJ2Zhc3QtZmlmbycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHBlZXIgPSByZXF1aXJlKCcuL3BlZXInKQpjb25zdCB7IElOVkFMSURfVE9LRU4sIFJFUVVFU1RfVElNRU9VVCwgUkVRVUVTVF9ERVNUUk9ZRUQsIElPX1NVU1BFTkRFRCB9ID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKY29uc3QgVkVSU0lPTiA9IDBiMTEKY29uc3QgUkVTUE9OU0VfSUQgPSAoMGIwMDAxIDw8IDQpIHwgVkVSU0lPTgpjb25zdCBSRVFVRVNUX0lEID0gKDBiMDAwMCA8PCA0KSB8IFZFUlNJT04KY29uc3QgRU1QVFlfQVJSQVkgPSBbXQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBJTyB7CiAgY29uc3RydWN0b3IoCiAgICB0YWJsZSwKICAgIHVkeCwKICAgIHsKICAgICAgbWF4V2luZG93ID0gODAsCiAgICAgIHBvcnQgPSAwLAogICAgICBob3N0ID0gJzAuMC4wLjAnLAogICAgICBhbnlQb3J0ID0gdHJ1ZSwKICAgICAgZmlyZXdhbGxlZCA9IHRydWUsCiAgICAgIG9ucmVxdWVzdCwKICAgICAgb25yZXNwb25zZSA9IG5vb3AsCiAgICAgIG9udGltZW91dCA9IG5vb3AKICAgIH0gPSB7fQogICkgewogICAgdGhpcy50YWJsZSA9IHRhYmxlCiAgICB0aGlzLnVkeCA9IHVkeAogICAgdGhpcy5pbmZsaWdodCA9IFtdCiAgICB0aGlzLmNsaWVudFNvY2tldCA9IG51bGwKICAgIHRoaXMuc2VydmVyU29ja2V0ID0gbnVsbAogICAgdGhpcy5maXJld2FsbGVkID0gZmlyZXdhbGxlZCAhPT0gZmFsc2UKICAgIHRoaXMuZXBoZW1lcmFsID0gdHJ1ZQogICAgdGhpcy5jb25nZXN0aW9uID0gbmV3IENvbmdlc3Rpb25XaW5kb3cobWF4V2luZG93KQogICAgdGhpcy5uZXR3b3JrSW50ZXJmYWNlcyA9IHVkeC53YXRjaE5ldHdvcmtJbnRlcmZhY2VzKCkKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKCiAgICB0aGlzLnN0YXRzID0gewogICAgICByZXF1ZXN0czogeyBhY3RpdmU6IDAsIHRvdGFsOiAwIH0sCiAgICAgIGNvbW1hbmRzOiBbCiAgICAgICAgeyB0eDogMCwgcng6IDAgfSwgLy8gdHggPSB0cmFuc21pdHRlZCwgcnggPSByZWNlaXZlZAogICAgICAgIHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgICAgeyB0eDogMCwgcng6IDAgfSwKICAgICAgICB7IHR4OiAwLCByeDogMCB9CiAgICAgIF0KICAgIH0KCiAgICB0aGlzLm9ucmVxdWVzdCA9IG9ucmVxdWVzdAogICAgdGhpcy5vbnJlc3BvbnNlID0gb25yZXNwb25zZQogICAgdGhpcy5vbnRpbWVvdXQgPSBvbnRpbWVvdXQKCiAgICB0aGlzLl9wZW5kaW5nID0gbmV3IEZJRk8oKQogICAgdGhpcy5fcm90YXRlU2VjcmV0cyA9IDEwCiAgICB0aGlzLl90aWQgPSAoTWF0aC5yYW5kb20oKSAqIDY1NTM2KSB8IDAKICAgIHRoaXMuX3NlY3JldHMgPSBudWxsCiAgICB0aGlzLl9kcmFpbkludGVydmFsID0gbnVsbAogICAgdGhpcy5fZGVzdHJveWluZyA9IG51bGwKICAgIHRoaXMuX2JpbmRpbmcgPSBudWxsCgogICAgLy8gcG9ydCBjYW4gYmUgYSBudW1iZXIgb3IgYSByYW5nZSBbc3RhcnQsIHRvXQogICAgdGhpcy5wb3J0UmFuZ2UgPSBwb3J0Lmxlbmd0aCA/IHBvcnQgOiBwb3J0ID09PSAwID8gWzAsIDBdIDogW3BvcnQsIHBvcnQgKyA1XQoKICAgIHRoaXMuX2hvc3QgPSBob3N0CiAgICB0aGlzLl9hbnlQb3J0ID0gYW55UG9ydCAhPT0gZmFsc2UKICAgIHRoaXMuX2JvdW5kU2VydmVyUG9ydCA9IDAKICAgIHRoaXMuX2JvdW5kQ2xpZW50UG9ydCA9IDAKICB9CgogIG9ubWVzc2FnZShzb2NrZXQsIGJ1ZmZlciwgeyBob3N0LCBwb3J0IH0pIHsKICAgIGlmIChidWZmZXIuYnl0ZUxlbmd0aCA8IDIgfHwgIShwb3J0ID4gMCAmJiBwb3J0IDwgNjU1MzYpIHx8IHRoaXMuc3VzcGVuZGVkID09PSB0cnVlKSByZXR1cm4KCiAgICBjb25zdCBmcm9tID0geyBpZDogbnVsbCwgaG9zdCwgcG9ydCB9CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDEsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9CiAgICBjb25zdCBleHBlY3RlZFNvY2tldCA9IHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuY2xpZW50U29ja2V0IDogdGhpcy5zZXJ2ZXJTb2NrZXQKICAgIGNvbnN0IGV4dGVybmFsID0gc29ja2V0ICE9PSBleHBlY3RlZFNvY2tldAoKICAgIGlmIChidWZmZXJbMF0gPT09IFJFUVVFU1RfSUQpIHsKICAgICAgY29uc3QgcmVxID0gUmVxdWVzdC5kZWNvZGUodGhpcywgc29ja2V0LCBmcm9tLCBzdGF0ZSkKICAgICAgaWYgKHJlcSA9PT0gbnVsbCkgcmV0dXJuCiAgICAgIGlmICgKICAgICAgICByZXEudG9rZW4gIT09IG51bGwgJiYKICAgICAgICAhYjRhLmVxdWFscyhyZXEudG9rZW4sIHRoaXMudG9rZW4ocmVxLmZyb20sIDEpKSAmJgogICAgICAgICFiNGEuZXF1YWxzKHJlcS50b2tlbiwgdGhpcy50b2tlbihyZXEuZnJvbSwgMCkpCiAgICAgICkgewogICAgICAgIHJlcS5lcnJvcihJTlZBTElEX1RPS0VOLCB7IHRva2VuOiB0cnVlIH0pCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgdGhpcy5vbnJlcXVlc3QocmVxLCBleHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGJ1ZmZlclswXSA9PT0gUkVTUE9OU0VfSUQpIHsKICAgICAgY29uc3QgcmVzID0gZGVjb2RlUmVwbHkoZnJvbSwgc3RhdGUpCiAgICAgIGlmIChyZXMgPT09IG51bGwpIHJldHVybgoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZmxpZ2h0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5pbmZsaWdodFtpXQogICAgICAgIGlmIChyZXEudGlkICE9PSByZXMudGlkKSBjb250aW51ZQoKICAgICAgICByZXMucnR0ID0gRGF0ZS5ub3coKSAtIHJlcS5fdGltZXN0YW1wCgogICAgICAgIGlmIChpID09PSB0aGlzLmluZmxpZ2h0Lmxlbmd0aCAtIDEpIHRoaXMuaW5mbGlnaHQucG9wKCkKICAgICAgICBlbHNlIHRoaXMuaW5mbGlnaHRbaV0gPSB0aGlzLmluZmxpZ2h0LnBvcCgpCgogICAgICAgIGlmIChyZXEuc2Vzc2lvbikgcmVxLnNlc3Npb24uX2RldGFjaChyZXEpCgogICAgICAgIC8vIFRPRE86IEF1dG8gcmV0cnkgaGVyZSBpZiBlcnJvcnMuSU5WQUxJRF9UT0tFTiBpcyByZXR1cm5lZD8KCiAgICAgICAgaWYgKHJlcS5fdGltZW91dCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHJlcS5fdGltZW91dCkKICAgICAgICAgIHJlcS5fdGltZW91dCA9IG51bGwKICAgICAgICB9CgogICAgICAgIHRoaXMuY29uZ2VzdGlvbi5yZWN2KCkKCiAgICAgICAgaWYgKHJlcS5pbnRlcm5hbCAmJiByZXEuY29tbWFuZCA8IHRoaXMuc3RhdHMuY29tbWFuZHMubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnN0YXRzLmNvbW1hbmRzW3JlcS5jb21tYW5kXS5yeCsrCiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0YXRzLnJlcXVlc3RzLmFjdGl2ZS0tCgogICAgICAgIHRoaXMub25yZXNwb25zZShyZXMsIGV4dGVybmFsKQogICAgICAgIHJlcS5vbnJlc3BvbnNlKHJlcywgcmVxKQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICB9CgogIHRva2VuKGFkZHIsIGkpIHsKICAgIGlmICh0aGlzLl9zZWNyZXRzID09PSBudWxsKSB7CiAgICAgIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvYyg2NCkKICAgICAgdGhpcy5fc2VjcmV0cyA9IFtidWYuc3ViYXJyYXkoMCwgMzIpLCBidWYuc3ViYXJyYXkoMzIsIDY0KV0KICAgICAgc29kaXVtLnJhbmRvbWJ5dGVzX2J1Zih0aGlzLl9zZWNyZXRzWzBdKQogICAgICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKHRoaXMuX3NlY3JldHNbMV0pCiAgICB9CgogICAgY29uc3QgdG9rZW4gPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKHRva2VuLCBiNGEuZnJvbShhZGRyLmhvc3QpLCB0aGlzLl9zZWNyZXRzW2ldKQogICAgcmV0dXJuIHRva2VuCiAgfQoKICBhc3luYyBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3lpbmcpIHJldHVybiB0aGlzLl9kZXN0cm95aW5nCiAgICB0aGlzLl9kZXN0cm95aW5nID0gdGhpcy5fZGVzdHJveSgpCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogIH0KCiAgYXN5bmMgX2Rlc3Ryb3koKSB7CiAgICAvLyBzaW1wbGlmaWVzIHRpbWluZyB0byBhd2FpdCB0aGUgYmluZCBoZXJlIGFsc28sIGFsdGhvdWdoIGl0IG1pZ2h0IGJlIHVubmVlZGVkCiAgICBhd2FpdCB0aGlzLmJpbmQoKQogICAgYXdhaXQgdGhpcy5fY2xlYXIoZmFsc2UpCiAgfQoKICBhc3luYyBfY2xlYXIoc3VzcGVuZGVkKSB7CiAgICBpZiAodGhpcy5fZHJhaW5JbnRlcnZhbCkgewogICAgICBjbGVhckludGVydmFsKHRoaXMuX2RyYWluSW50ZXJ2YWwpCiAgICAgIHRoaXMuX2RyYWluSW50ZXJ2YWwgPSBudWxsCiAgICB9CgogICAgd2hpbGUgKHRoaXMuaW5mbGlnaHQubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuaW5mbGlnaHQucG9wKCkKICAgICAgaWYgKHJlcS5fdGltZW91dCkgY2xlYXJUaW1lb3V0KHJlcS5fdGltZW91dCkKICAgICAgcmVxLl90aW1lb3V0ID0gbnVsbAogICAgICByZXEuZGVzdHJveWVkID0gdHJ1ZQoKICAgICAgaWYgKHJlcS5zZXNzaW9uKSByZXEuc2Vzc2lvbi5fZGV0YWNoKHJlcSkKCiAgICAgIHRoaXMuY29uZ2VzdGlvbi5yZWN2KCkKICAgICAgdGhpcy5zdGF0cy5yZXF1ZXN0cy5hY3RpdmUtLQoKICAgICAgcmVxLm9uZXJyb3Ioc3VzcGVuZGVkID8gSU9fU1VTUEVOREVEKCkgOiBSRVFVRVNUX0RFU1RST1lFRCgpLCByZXEpCiAgICB9CgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFt0aGlzLnNlcnZlclNvY2tldC5jbG9zZSgpLCB0aGlzLmNsaWVudFNvY2tldC5jbG9zZSgpXSkKCiAgICB0aGlzLm5ldHdvcmtJbnRlcmZhY2VzLmRlc3Ryb3koKQogIH0KCiAgYXN5bmMgc3VzcGVuZCgpIHsKICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQogICAgYXdhaXQgdGhpcy5fY2xlYXIodHJ1ZSkKCiAgICB0aGlzLmNvbmdlc3Rpb24uY2xlYXIoKQoKICAgIGlmICh0aGlzLl9kcmFpbkludGVydmFsKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZHJhaW5JbnRlcnZhbCkKICAgICAgdGhpcy5fZHJhaW5JbnRlcnZhbCA9IG51bGwKICAgIH0KICB9CgogIGFzeW5jIF9yZWJpbmQoYmluZGluZykgewogICAgaWYgKGJpbmRpbmcpIGF3YWl0IGJpbmRpbmcKICAgIGlmICh0aGlzLl9kZXN0cm95aW5nKSByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogICAgYXdhaXQgdGhpcy5fYmluZFNvY2tldHMoKQogICAgdGhpcy5uZXR3b3JrSW50ZXJmYWNlcyA9IHRoaXMudWR4LndhdGNoTmV0d29ya0ludGVyZmFjZXMoKQogIH0KCiAgcmVzdW1lKCkgewogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgY29uc3QgYmluZGluZyA9IHRoaXMuX2JpbmRpbmcKICAgIHRoaXMuX2JpbmRpbmcgPSB0aGlzLl9yZWJpbmQoYmluZGluZykKICAgIHJldHVybiB0aGlzLl9iaW5kaW5nCiAgfQoKICBiaW5kKCkgewogICAgaWYgKHRoaXMuX2JpbmRpbmcpIHJldHVybiB0aGlzLl9iaW5kaW5nCiAgICB0aGlzLl9iaW5kaW5nID0gdGhpcy5fYmluZFNvY2tldHMoKQogICAgcmV0dXJuIHRoaXMuX2JpbmRpbmcKICB9CgogIGFzeW5jIF9iaW5kU29ja2V0cygpIHsKICAgIGNvbnN0IHNlcnZlclNvY2tldCA9IHRoaXMudWR4LmNyZWF0ZVNvY2tldCgpCgogICAgY29uc3QgY2FuZGlkYXRlUG9ydHMgPSBbXQoKICAgIC8vIFJldHJ5aW5nIHByZXZpb3VzIHBvcnQgYWx3YXlzIGhhcyBwcmVjZWRlbmNlCiAgICBpZiAodGhpcy5fYm91bmRTZXJ2ZXJQb3J0KSBjYW5kaWRhdGVQb3J0cy5wdXNoKHRoaXMuX2JvdW5kU2VydmVyUG9ydCkKCiAgICBmb3IgKGxldCBpID0gdGhpcy5wb3J0UmFuZ2VbMF07IGkgPCB0aGlzLnBvcnRSYW5nZVsxXTsgaSsrKSBjYW5kaWRhdGVQb3J0cy5wdXNoKGkpCgogICAgZm9yIChjb25zdCBwb3J0IG9mIGNhbmRpZGF0ZVBvcnRzKSB7CiAgICAgIGlmIChzZXJ2ZXJTb2NrZXQuYm91bmQpIGJyZWFrCgogICAgICB0cnkgewogICAgICAgIHNlcnZlclNvY2tldC5iaW5kKHBvcnQsIHRoaXMuX2hvc3QpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmICghdGhpcy5fYW55UG9ydCkgewogICAgICAgICAgYXdhaXQgc2VydmVyU29ja2V0LmNsb3NlKCkKICAgICAgICAgIHRocm93IGVycgogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmICghc2VydmVyU29ja2V0LmJvdW5kKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc2VydmVyU29ja2V0LmJpbmQoMCwgdGhpcy5faG9zdCkKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgYXdhaXQgc2VydmVyU29ja2V0LmNsb3NlKCkKICAgICAgICB0aHJvdyBlcnIKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGNsaWVudFNvY2tldCA9IHRoaXMudWR4LmNyZWF0ZVNvY2tldCgpCgogICAgdHJ5IHsKICAgICAgY2xpZW50U29ja2V0LmJpbmQodGhpcy5fYm91bmRDbGllbnRQb3J0IHx8IDAsIHRoaXMuX2hvc3QpCiAgICB9IGNhdGNoIHsKICAgICAgdHJ5IHsKICAgICAgICBjbGllbnRTb2NrZXQuYmluZCgwLCB0aGlzLl9ob3N0KQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBhd2FpdCBzZXJ2ZXJTb2NrZXQuY2xvc2UoKQogICAgICAgIGF3YWl0IGNsaWVudFNvY2tldC5jbG9zZSgpCiAgICAgICAgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9ib3VuZFNlcnZlclBvcnQgPSBzZXJ2ZXJTb2NrZXQuYWRkcmVzcygpLnBvcnQKICAgIHRoaXMuX2JvdW5kQ2xpZW50UG9ydCA9IGNsaWVudFNvY2tldC5hZGRyZXNzKCkucG9ydAoKICAgIHRoaXMuY2xpZW50U29ja2V0ID0gY2xpZW50U29ja2V0CiAgICB0aGlzLnNlcnZlclNvY2tldCA9IHNlcnZlclNvY2tldAoKICAgIHRoaXMuc2VydmVyU29ja2V0Lm9uKCdtZXNzYWdlJywgdGhpcy5vbm1lc3NhZ2UuYmluZCh0aGlzLCB0aGlzLnNlcnZlclNvY2tldCkpCiAgICB0aGlzLmNsaWVudFNvY2tldC5vbignbWVzc2FnZScsIHRoaXMub25tZXNzYWdlLmJpbmQodGhpcywgdGhpcy5jbGllbnRTb2NrZXQpKQoKICAgIGlmICh0aGlzLl9kcmFpbkludGVydmFsID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2RyYWluSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9kcmFpbi5iaW5kKHRoaXMpLCA3NTApCiAgICAgIGlmICh0aGlzLl9kcmFpbkludGVydmFsLnVucmVmKSB0aGlzLl9kcmFpbkludGVydmFsLnVucmVmKCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLmluZmxpZ2h0KSB7CiAgICAgIGlmICghcmVxLnNvY2tldCkgcmVxLnNvY2tldCA9IHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuY2xpZW50U29ja2V0IDogdGhpcy5zZXJ2ZXJTb2NrZXQKICAgICAgcmVxLnNlbnQgPSAwCiAgICAgIHJlcS5zZW5kKGZhbHNlKQogICAgfQogIH0KCiAgX2RyYWluKCkgewogICAgaWYgKHRoaXMuX3NlY3JldHMgIT09IG51bGwgJiYgLS10aGlzLl9yb3RhdGVTZWNyZXRzID09PSAwKSB7CiAgICAgIHRoaXMuX3JvdGF0ZVNlY3JldHMgPSAxMAogICAgICBjb25zdCB0bXAgPSB0aGlzLl9zZWNyZXRzWzBdCiAgICAgIHRoaXMuX3NlY3JldHNbMF0gPSB0aGlzLl9zZWNyZXRzWzFdCiAgICAgIHRoaXMuX3NlY3JldHNbMV0gPSB0bXAKICAgICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaCh0bXAsIHRtcCkKICAgIH0KCiAgICB0aGlzLmNvbmdlc3Rpb24uZHJhaW4oKQoKICAgIHdoaWxlICghdGhpcy5jb25nZXN0aW9uLmlzRnVsbCgpKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLl9wZW5kaW5nLnNoaWZ0KCkKICAgICAgaWYgKHAgPT09IHVuZGVmaW5lZCkgcmV0dXJuCiAgICAgIHAuX3NlbmROb3coKQogICAgfQogIH0KCiAgY3JlYXRlUmVxdWVzdCh0bywgdG9rZW4sIGludGVybmFsLCBjb21tYW5kLCB0YXJnZXQsIHZhbHVlLCBzZXNzaW9uLCB0dGwpIHsKICAgIGlmICh0aGlzLl9kZXN0cm95aW5nICE9PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGlmICh0aGlzLl90aWQgPT09IDY1NTM2KSB0aGlzLl90aWQgPSAwCgogICAgY29uc3QgdGlkID0gdGhpcy5fdGlkKysKICAgIGNvbnN0IHNvY2tldCA9IHRoaXMuZmlyZXdhbGxlZCA/IHRoaXMuY2xpZW50U29ja2V0IDogdGhpcy5zZXJ2ZXJTb2NrZXQKCiAgICBjb25zdCByZXEgPSBuZXcgUmVxdWVzdCgKICAgICAgdGhpcywKICAgICAgc29ja2V0LAogICAgICB0aWQsCiAgICAgIG51bGwsCiAgICAgIHRvLAogICAgICB0b2tlbiwKICAgICAgaW50ZXJuYWwsCiAgICAgIGNvbW1hbmQsCiAgICAgIHRhcmdldCwKICAgICAgdmFsdWUsCiAgICAgIHNlc3Npb24sCiAgICAgIHR0bCB8fCAwCiAgICApCiAgICB0aGlzLmluZmxpZ2h0LnB1c2gocmVxKQogICAgaWYgKHNlc3Npb24pIHNlc3Npb24uX2F0dGFjaChyZXEpCgogICAgaWYgKGludGVybmFsICYmIGNvbW1hbmQgPCB0aGlzLnN0YXRzLmNvbW1hbmRzLmxlbmd0aCkgewogICAgICB0aGlzLnN0YXRzLmNvbW1hbmRzW2NvbW1hbmRdLnR4KysKICAgIH0KCiAgICB0aGlzLnN0YXRzLnJlcXVlc3RzLmFjdGl2ZSsrCiAgICB0aGlzLnN0YXRzLnJlcXVlc3RzLnRvdGFsKysKCiAgICByZXR1cm4gcmVxCiAgfQp9CgpjbGFzcyBSZXF1ZXN0IHsKICBjb25zdHJ1Y3Rvcihpbywgc29ja2V0LCB0aWQsIGZyb20sIHRvLCB0b2tlbiwgaW50ZXJuYWwsIGNvbW1hbmQsIHRhcmdldCwgdmFsdWUsIHNlc3Npb24sIHR0bCkgewogICAgdGhpcy5zb2NrZXQgPSBzb2NrZXQKICAgIHRoaXMudGlkID0gdGlkCiAgICB0aGlzLmZyb20gPSBmcm9tCiAgICB0aGlzLnRvID0gdG8KICAgIHRoaXMudG9rZW4gPSB0b2tlbgogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZAogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogICAgdGhpcy5pbnRlcm5hbCA9IGludGVybmFsCiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLnR0bCA9IHR0bAogICAgdGhpcy5pbmRleCA9IC0xCiAgICB0aGlzLnNlbnQgPSAwCiAgICB0aGlzLnJldHJpZXMgPSAzCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5vbmN5Y2xlID0gbm9vcAogICAgdGhpcy5vbmVycm9yID0gbm9vcAogICAgdGhpcy5vbnJlc3BvbnNlID0gbm9vcAoKICAgIHRoaXMuX2J1ZmZlciA9IG51bGwKICAgIHRoaXMuX2lvID0gaW8KICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB0aGlzLl90aW1lc3RhbXAgPSBEYXRlLm5vdygpCiAgfQoKICBzdGF0aWMgZGVjb2RlKGlvLCBzb2NrZXQsIGZyb20sIHN0YXRlKSB7CiAgICB0cnkgewogICAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICAgIGNvbnN0IHRpZCA9IGMudWludDE2LmRlY29kZShzdGF0ZSkKICAgICAgY29uc3QgdG8gPSBwZWVyLmlwdjQuZGVjb2RlKHN0YXRlKQogICAgICBjb25zdCBpZCA9IGZsYWdzICYgMSA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgICBjb25zdCB0b2tlbiA9IGZsYWdzICYgMiA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgICBjb25zdCBpbnRlcm5hbCA9IChmbGFncyAmIDQpICE9PSAwCiAgICAgIGNvbnN0IGNvbW1hbmQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgICBjb25zdCB0YXJnZXQgPSBmbGFncyAmIDggPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgICAgY29uc3QgdmFsdWUgPSBmbGFncyAmIDE2ID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKCiAgICAgIGlmIChpZCAhPT0gbnVsbCkgZnJvbS5pZCA9IHZhbGlkYXRlSWQoaWQsIGZyb20pCgogICAgICByZXR1cm4gbmV3IFJlcXVlc3QoCiAgICAgICAgaW8sCiAgICAgICAgc29ja2V0LAogICAgICAgIHRpZCwKICAgICAgICBmcm9tLAogICAgICAgIHRvLAogICAgICAgIHRva2VuLAogICAgICAgIGludGVybmFsLAogICAgICAgIGNvbW1hbmQsCiAgICAgICAgdGFyZ2V0LAogICAgICAgIHZhbHVlLAogICAgICAgIG51bGwsCiAgICAgICAgMAogICAgICApCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIHJlcGx5KHZhbHVlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHNvY2tldCA9IG9wdHMuc29ja2V0IHx8IHRoaXMuc29ja2V0CiAgICBjb25zdCB0byA9IG9wdHMudG8gfHwgdGhpcy5mcm9tCiAgICB0aGlzLl9zZW5kUmVwbHkoMCwgdmFsdWUgfHwgbnVsbCwgb3B0cy50b2tlbiAhPT0gZmFsc2UsIG9wdHMuY2xvc2VyTm9kZXMgIT09IGZhbHNlLCB0bywgc29ja2V0KQogIH0KCiAgZXJyb3IoY29kZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBzb2NrZXQgPSBvcHRzLnNvY2tldCB8fCB0aGlzLnNvY2tldAogICAgY29uc3QgdG8gPSBvcHRzLnRvIHx8IHRoaXMuZnJvbQogICAgdGhpcy5fc2VuZFJlcGx5KGNvZGUsIG51bGwsIG9wdHMudG9rZW4gPT09IHRydWUsIG9wdHMuY2xvc2VyTm9kZXMgIT09IGZhbHNlLCB0bywgc29ja2V0KQogIH0KCiAgcmVsYXkodmFsdWUsIHRvLCBvcHRzKSB7CiAgICBjb25zdCBzb2NrZXQgPSAob3B0cyAmJiBvcHRzLnNvY2tldCkgfHwgdGhpcy5zb2NrZXQKICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuX2VuY29kZVJlcXVlc3QobnVsbCwgdmFsdWUsIHRvLCBzb2NrZXQpCiAgICBzb2NrZXQudHJ5U2VuZChidWZmZXIsIHRvLnBvcnQsIHRvLmhvc3QsIHRoaXMudHRsKQogIH0KCiAgc2VuZChmb3JjZSA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgoKICAgIGlmICh0aGlzLnNvY2tldCA9PT0gbnVsbCkgcmV0dXJuCiAgICBpZiAodGhpcy5fYnVmZmVyID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2J1ZmZlciA9IHRoaXMuX2VuY29kZVJlcXVlc3QodGhpcy50b2tlbiwgdGhpcy52YWx1ZSwgdGhpcy50bywgdGhpcy5zb2NrZXQpCiAgICB9CgogICAgaWYgKCFmb3JjZSAmJiB0aGlzLl9pby5jb25nZXN0aW9uLmlzRnVsbCgpKSB7CiAgICAgIHRoaXMuX2lvLl9wZW5kaW5nLnB1c2godGhpcykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fc2VuZE5vdygpCiAgfQoKICBzZW5kUmVwbHkoZXJyb3IsIHZhbHVlLCB0b2tlbiwgaGFzQ2xvc2VyTm9kZXMpIHsKICAgIHRoaXMuX3NlbmRSZXBseShlcnJvciwgdmFsdWUsIHRva2VuLCBoYXNDbG9zZXJOb2RlcywgdGhpcy5mcm9tLCB0aGlzLnNvY2tldCwgbnVsbCkKICB9CgogIF9zZW5kTm93KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuc2VudCsrCiAgICB0aGlzLl9pby5jb25nZXN0aW9uLnNlbmQoKQogICAgdGhpcy5zb2NrZXQudHJ5U2VuZCh0aGlzLl9idWZmZXIsIHRoaXMudG8ucG9ydCwgdGhpcy50by5ob3N0LCB0aGlzLnR0bCkKICAgIGlmICh0aGlzLl90aW1lb3V0KSBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCkKICAgIHRoaXMuX3RpbWVvdXQgPSBzZXRUaW1lb3V0KG9uY3ljbGUsIDEwMDAsIHRoaXMpCiAgfQoKICBkZXN0cm95KGVycikgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIGlmICh0aGlzLl90aW1lb3V0KSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KQogICAgICB0aGlzLl90aW1lb3V0ID0gbnVsbAogICAgfQoKICAgIGNvbnN0IGkgPSB0aGlzLl9pby5pbmZsaWdodC5pbmRleE9mKHRoaXMpCiAgICBpZiAoaSA9PT0gLTEpIHJldHVybgoKICAgIGlmIChpID09PSB0aGlzLl9pby5pbmZsaWdodC5sZW5ndGggLSAxKSB0aGlzLl9pby5pbmZsaWdodC5wb3AoKQogICAgZWxzZSB0aGlzLl9pby5pbmZsaWdodFtpXSA9IHRoaXMuX2lvLmluZmxpZ2h0LnBvcCgpCgogICAgaWYgKHRoaXMuc2Vzc2lvbikgdGhpcy5zZXNzaW9uLl9kZXRhY2godGhpcykKCiAgICB0aGlzLl9pby5zdGF0cy5yZXF1ZXN0cy5hY3RpdmUtLQogICAgdGhpcy5faW8uY29uZ2VzdGlvbi5yZWN2KCkKCiAgICB0aGlzLm9uZXJyb3IoZXJyIHx8IFJFUVVFU1RfREVTVFJPWUVEKCksIHRoaXMpCiAgfQoKICBfc2VuZFJlcGx5KGVycm9yLCB2YWx1ZSwgdG9rZW4sIGhhc0Nsb3Nlck5vZGVzLCBmcm9tLCBzb2NrZXQpIHsKICAgIGlmIChzb2NrZXQgPT09IG51bGwgfHwgdGhpcy5kZXN0cm95ZWQpIHJldHVybgoKICAgIGNvbnN0IGlkID0gdGhpcy5faW8uZXBoZW1lcmFsID09PSBmYWxzZSAmJiBzb2NrZXQgPT09IHRoaXMuX2lvLnNlcnZlclNvY2tldAogICAgY29uc3QgY2xvc2VyTm9kZXMgPQogICAgICB0aGlzLnRhcmdldCAhPT0gbnVsbCAmJiBoYXNDbG9zZXJOb2RlcyA/IHRoaXMuX2lvLnRhYmxlLmNsb3Nlc3QodGhpcy50YXJnZXQpIDogRU1QVFlfQVJSQVkKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiAxICsgMSArIDYgKyAyLCBidWZmZXI6IG51bGwgfSAvLyAodHlwZSB8IHZlcnNpb24pICsgZmxhZ3MgKyB0byArIHRpZAoKICAgIGlmIChpZCkgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAodG9rZW4pIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKGNsb3Nlck5vZGVzLmxlbmd0aCA+IDApIHBlZXIuaXB2NEFycmF5LnByZWVuY29kZShzdGF0ZSwgY2xvc2VyTm9kZXMpCiAgICBpZiAoZXJyb3IgPiAwKSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBlcnJvcikKICAgIGlmICh2YWx1ZSkgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB2YWx1ZSkKCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gUkVTUE9OU0VfSUQKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9CiAgICAgIChpZCA/IDEgOiAwKSB8CiAgICAgICh0b2tlbiA/IDIgOiAwKSB8CiAgICAgIChjbG9zZXJOb2Rlcy5sZW5ndGggPiAwID8gNCA6IDApIHwKICAgICAgKGVycm9yID4gMCA/IDggOiAwKSB8CiAgICAgICh2YWx1ZSA/IDE2IDogMCkKCiAgICBjLnVpbnQxNi5lbmNvZGUoc3RhdGUsIHRoaXMudGlkKQogICAgcGVlci5pcHY0LmVuY29kZShzdGF0ZSwgZnJvbSkKCiAgICBpZiAoaWQpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRoaXMuX2lvLnRhYmxlLmlkKQogICAgaWYgKHRva2VuKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0aGlzLl9pby50b2tlbihmcm9tLCAxKSkKICAgIGlmIChjbG9zZXJOb2Rlcy5sZW5ndGggPiAwKSBwZWVyLmlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIGNsb3Nlck5vZGVzKQogICAgaWYgKGVycm9yID4gMCkgYy51aW50LmVuY29kZShzdGF0ZSwgZXJyb3IpCiAgICBpZiAodmFsdWUpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdmFsdWUpCgogICAgc29ja2V0LnRyeVNlbmQoc3RhdGUuYnVmZmVyLCBmcm9tLnBvcnQsIGZyb20uaG9zdCwgdGhpcy50dGwpCiAgfQoKICBfZW5jb2RlUmVxdWVzdCh0b2tlbiwgdmFsdWUsIHRvLCBzb2NrZXQpIHsKICAgIGNvbnN0IGlkID0gdGhpcy5faW8uZXBoZW1lcmFsID09PSBmYWxzZSAmJiBzb2NrZXQgPT09IHRoaXMuX2lvLnNlcnZlclNvY2tldAogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDEgKyAxICsgNiArIDIsIGJ1ZmZlcjogbnVsbCB9IC8vICh0eXBlIHwgdmVyc2lvbikgKyBmbGFncyArIHRvICsgdGlkCgogICAgaWYgKGlkKSBzdGF0ZS5lbmQgKz0gMzIKICAgIGlmICh0b2tlbikgc3RhdGUuZW5kICs9IDMyCgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdGhpcy5jb21tYW5kKQoKICAgIGlmICh0aGlzLnRhcmdldCkgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAodmFsdWUpIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdmFsdWUpCgogICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IFJFUVVFU1RfSUQKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9CiAgICAgIChpZCA/IDEgOiAwKSB8CiAgICAgICh0b2tlbiA/IDIgOiAwKSB8CiAgICAgICh0aGlzLmludGVybmFsID8gNCA6IDApIHwKICAgICAgKHRoaXMudGFyZ2V0ID8gOCA6IDApIHwKICAgICAgKHZhbHVlID8gMTYgOiAwKQoKICAgIGMudWludDE2LmVuY29kZShzdGF0ZSwgdGhpcy50aWQpCiAgICBwZWVyLmlwdjQuZW5jb2RlKHN0YXRlLCB0bykKCiAgICBpZiAoaWQpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHRoaXMuX2lvLnRhYmxlLmlkKQogICAgaWYgKHRva2VuKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0b2tlbikKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0aGlzLmNvbW1hbmQpCgogICAgaWYgKHRoaXMudGFyZ2V0KSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCB0aGlzLnRhcmdldCkKICAgIGlmICh2YWx1ZSkgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB2YWx1ZSkKCiAgICByZXR1cm4gc3RhdGUuYnVmZmVyCiAgfQp9CgpjbGFzcyBDb25nZXN0aW9uV2luZG93IHsKICBjb25zdHJ1Y3RvcihtYXhXaW5kb3cpIHsKICAgIHRoaXMuX2kgPSAwCiAgICB0aGlzLl90b3RhbCA9IDAKICAgIHRoaXMuX3dpbmRvdyA9IFswLCAwLCAwLCAwXQogICAgdGhpcy5fbWF4V2luZG93ID0gbWF4V2luZG93CiAgfQoKICBjbGVhcigpIHsKICAgIHRoaXMuX2kgPSAwCiAgICB0aGlzLl90b3RhbCA9IDAKICAgIHRoaXMuX3dpbmRvdyA9IFswLCAwLCAwLCAwXQogIH0KCiAgaXNGdWxsKCkgewogICAgcmV0dXJuIHRoaXMuX3RvdGFsID49IDIgKiB0aGlzLl9tYXhXaW5kb3cgfHwgdGhpcy5fd2luZG93W3RoaXMuX2ldID49IHRoaXMuX21heFdpbmRvdwogIH0KCiAgcmVjdigpIHsKICAgIGlmICh0aGlzLl93aW5kb3dbdGhpcy5faV0gPiAwKSB7CiAgICAgIHRoaXMuX3dpbmRvd1t0aGlzLl9pXS0tCiAgICAgIHRoaXMuX3RvdGFsLS0KICAgIH0KICB9CgogIHNlbmQoKSB7CiAgICB0aGlzLl90b3RhbCsrCiAgICB0aGlzLl93aW5kb3dbdGhpcy5faV0rKwogIH0KCiAgZHJhaW4oKSB7CiAgICB0aGlzLl9pID0gKHRoaXMuX2kgKyAxKSAmIDMKICAgIHRoaXMuX3RvdGFsIC09IHRoaXMuX3dpbmRvd1t0aGlzLl9pXQogICAgdGhpcy5fd2luZG93W3RoaXMuX2ldID0gMCAvLyBjbGVhciBvbGRlc3QKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gb25jeWNsZShyZXEpIHsKICByZXEuX3RpbWVvdXQgPSBudWxsCiAgcmVxLm9uY3ljbGUocmVxKQogIGlmIChyZXEuc2VudCA+PSByZXEucmV0cmllcykgewogICAgcmVxLmRlc3Ryb3koUkVRVUVTVF9USU1FT1VUKCkpCiAgICByZXEuX2lvLm9udGltZW91dChyZXEpCiAgfSBlbHNlIHsKICAgIHJlcS5zZW5kKCkKICB9Cn0KCmZ1bmN0aW9uIGRlY29kZVJlcGx5KGZyb20sIHN0YXRlKSB7CiAgdHJ5IHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHRpZCA9IGMudWludDE2LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHRvID0gcGVlci5pcHY0LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGlkID0gZmxhZ3MgJiAxID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICBjb25zdCB0b2tlbiA9IGZsYWdzICYgMiA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3QgY2xvc2VyTm9kZXMgPSBmbGFncyAmIDQgPyBwZWVyLmlwdjRBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgY29uc3QgZXJyb3IgPSBmbGFncyAmIDggPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIGNvbnN0IHZhbHVlID0gZmxhZ3MgJiAxNiA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCgogICAgaWYgKGlkICE9PSBudWxsKSBmcm9tLmlkID0gdmFsaWRhdGVJZChpZCwgZnJvbSkKCiAgICByZXR1cm4geyB0aWQsIHJ0dDogMCwgZnJvbSwgdG8sIHRva2VuLCBjbG9zZXJOb2RlcywgZXJyb3IsIHZhbHVlIH0KICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiB2YWxpZGF0ZUlkKGlkLCBmcm9tKSB7CiAgY29uc3QgZXhwZWN0ZWQgPSBwZWVyLmlkKGZyb20uaG9zdCwgZnJvbS5wb3J0KQogIHJldHVybiBiNGEuZXF1YWxzKGV4cGVjdGVkLCBpZCkgPyBleHBlY3RlZCA6IG51bGwKfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBuZXQgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nLW5ldCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBpcHY0ID0gewogIC4uLm5ldC5pcHY0QWRkcmVzcywKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGlwID0gbmV0LmlwdjRBZGRyZXNzLmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGlkOiBudWxsLCAvLyBwb3B1bGF0ZWQgYnkgdGhlIGNhbGxlZQogICAgICBob3N0OiBpcC5ob3N0LAogICAgICBwb3J0OiBpcC5wb3J0CiAgICB9CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgaWQsIGlwdjQsIGlwdjRBcnJheTogYy5hcnJheShpcHY0KSB9CgpmdW5jdGlvbiBpZChob3N0LCBwb3J0LCBvdXQgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyKSkgewogIGNvbnN0IGFkZHIgPSBvdXQuc3ViYXJyYXkoMCwgNikKICBpcHY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDYsIGJ1ZmZlcjogYWRkciB9LCB7IGhvc3QsIHBvcnQgfSkKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKG91dCwgYWRkcikKICByZXR1cm4gb3V0Cn0KY29uc3QgeyBSZWFkYWJsZSwgZ2V0U3RyZWFtRXJyb3IgfSA9IHJlcXVpcmUoJ3N0cmVhbXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBwZWVyID0gcmVxdWlyZSgnLi9wZWVyJykKY29uc3QgeyBET1dOX0hJTlQgfSA9IHJlcXVpcmUoJy4vY29tbWFuZHMnKQoKY29uc3QgRE9ORSA9IFtdCmNvbnN0IERPV04gPSBbXQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBRdWVyeSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihkaHQsIHRhcmdldCwgaW50ZXJuYWwsIGNvbW1hbmQsIHZhbHVlLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICBkaHQuc3RhdHMucXVlcmllcy50b3RhbCsrCiAgICBkaHQuc3RhdHMucXVlcmllcy5hY3RpdmUrKwoKICAgIHRoaXMuZm9yY2UgPSAhIW9wdHMuZm9yY2UKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLmsgPSB0aGlzLmRodC50YWJsZS5rCiAgICB0aGlzLnRhcmdldCA9IHRhcmdldAogICAgdGhpcy5pbnRlcm5hbCA9IGludGVybmFsCiAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kCiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICAgIHRoaXMuZXJyb3JzID0gMAogICAgdGhpcy5zdWNjZXNzZXMgPSAwCiAgICB0aGlzLmNvbmN1cnJlbmN5ID0gb3B0cy5jb25jdXJyZW5jeSB8fCB0aGlzLmRodC5jb25jdXJyZW5jeQogICAgdGhpcy5pbmZsaWdodCA9IDAKICAgIHRoaXMubWFwID0gb3B0cy5tYXAgfHwgZGVmYXVsdE1hcAogICAgdGhpcy5yZXRyaWVzID0gb3B0cy5yZXRyaWVzID09PSAwID8gMCA6IG9wdHMucmV0cmllcyB8fCAzCiAgICB0aGlzLm1heFNsb3cgPSBvcHRzLm1heFNsb3cgPT09IDAgPyAwIDogb3B0cy5tYXhTbG93IHx8IDUKICAgIHRoaXMuY2xvc2VzdFJlcGxpZXMgPSBbXQoKICAgIHRoaXMuX3Nsb3cgPSAwCiAgICB0aGlzLl9vbmxpbmUgPSBmYWxzZQogICAgdGhpcy5fc2xvd2Rvd24gPSBmYWxzZQogICAgdGhpcy5fc2VlbiA9IG5ldyBNYXAoKQogICAgdGhpcy5fcGVuZGluZyA9IFtdCiAgICB0aGlzLl9mcm9tVGFibGUgPSBmYWxzZQogICAgdGhpcy5fY29tbWl0ID0gb3B0cy5jb21taXQgPT09IHRydWUgPyBhdXRvQ29tbWl0IDogb3B0cy5jb21taXQgfHwgbnVsbAogICAgdGhpcy5fY29tbWl0aW5nID0gZmFsc2UKICAgIHRoaXMuX3Nlc3Npb24gPSBvcHRzLnNlc3Npb24gfHwgZGh0LnNlc3Npb24oKQogICAgdGhpcy5fYXV0b0Rlc3Ryb3lTZXNzaW9uID0gIW9wdHMuc2Vzc2lvbgogICAgdGhpcy5fb25seUNsb3Nlc3ROb2RlcyA9IGZhbHNlCgogICAgdGhpcy5fb252aXNpdGJvdW5kID0gdGhpcy5fb252aXNpdC5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmVycm9yYm91bmQgPSB0aGlzLl9vbmVycm9yLmJpbmQodGhpcykKICAgIHRoaXMuX29uY3ljbGVib3VuZCA9IHRoaXMuX29uY3ljbGUuYmluZCh0aGlzKQoKICAgIGNvbnN0IG5vZGVzID0gb3B0cy5ub2RlcyB8fCBvcHRzLmNsb3Nlc3ROb2RlcwogICAgY29uc3QgcmVwbGllcyA9IG9wdHMucmVwbGllcyB8fCBvcHRzLmNsb3Nlc3RSZXBsaWVzCgogICAgLy8gYWRkIHRoZW0gcmV2ZXJzZSBhcyB3ZSBwb3AgYmVsb3cKICAgIGlmIChub2RlcykgewogICAgICBmb3IgKGxldCBpID0gbm9kZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCBub2RlID0gbm9kZXNbaV0KICAgICAgICB0aGlzLl9hZGRQZW5kaW5nKAogICAgICAgICAgewogICAgICAgICAgICBpZDogbm9kZS5pZCB8fCBwZWVyLmlkKG5vZGUuaG9zdCwgbm9kZS5wb3J0KSwKICAgICAgICAgICAgaG9zdDogbm9kZS5ob3N0LAogICAgICAgICAgICBwb3J0OiBub2RlLnBvcnQKICAgICAgICAgIH0sCiAgICAgICAgICBudWxsCiAgICAgICAgKQogICAgICB9CiAgICB9IGVsc2UgaWYgKHJlcGxpZXMpIHsKICAgICAgZm9yIChsZXQgaSA9IHJlcGxpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aGlzLl9hZGRQZW5kaW5nKHJlcGxpZXNbaV0uZnJvbSwgbnVsbCkKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRzLm9ubHlDbG9zZXN0Tm9kZXMpIHRoaXMuX29ubHlDbG9zZXN0Tm9kZXMgPSB0cnVlCiAgfQoKICBnZXQgY2xvc2VzdE5vZGVzKCkgewogICAgY29uc3Qgbm9kZXMgPSBuZXcgQXJyYXkodGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBub2Rlc1tpXSA9IHRoaXMuY2xvc2VzdFJlcGxpZXNbaV0uZnJvbQogICAgfQoKICAgIHJldHVybiBub2RlcwogIH0KCiAgZmluaXNoZWQoKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICBjb25zdCBlcnJvciA9IGdldFN0cmVhbUVycm9yKHRoaXMpCiAgICAgICAgaWYgKGVycm9yKSByZWplY3QoZXJyb3IpCiAgICAgICAgZWxzZSByZXNvbHZlKCkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgICAgbGV0IGVycm9yID0gbnVsbAoKICAgICAgdGhpcy5yZXN1bWUoKQogICAgICB0aGlzLm9uKCdlcnJvcicsIG9uZXJyb3IpCiAgICAgIHRoaXMub24oJ2Nsb3NlJywgb25jbG9zZSkKCiAgICAgIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICAgICAgc2VsZi5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKQogICAgICAgIHNlbGYucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgb25jbG9zZSkKICAgICAgICBpZiAoZXJyb3IpIHJlamVjdChlcnJvcikKICAgICAgICBlbHNlIHJlc29sdmUoKQogICAgICB9CgogICAgICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgICAgIGVycm9yID0gZXJyCiAgICAgIH0KICAgIH0pCiAgfQoKICBfYWRkRnJvbVRhYmxlKCkgewogICAgaWYgKHRoaXMuX3BlbmRpbmcubGVuZ3RoID49IHRoaXMuaykgcmV0dXJuCiAgICB0aGlzLl9mcm9tVGFibGUgPSB0cnVlCgogICAgY29uc3QgY2xvc2VzdCA9IHRoaXMuZGh0LnRhYmxlLmNsb3Nlc3QodGhpcy50YXJnZXQsIHRoaXMuayAtIHRoaXMuX3BlbmRpbmcubGVuZ3RoKQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBjbG9zZXN0KSB7CiAgICAgIHRoaXMuX2FkZFBlbmRpbmcoeyBpZDogbm9kZS5pZCwgaG9zdDogbm9kZS5ob3N0LCBwb3J0OiBub2RlLnBvcnQgfSwgbnVsbCkKICAgIH0KICB9CgogIGFzeW5jIF9vcGVuKGNiKSB7CiAgICB0aGlzLl9hZGRGcm9tVGFibGUoKQogICAgaWYgKHRoaXMuX3BlbmRpbmcubGVuZ3RoID49IHRoaXMuaykgcmV0dXJuIGNiKG51bGwpCgogICAgZm9yIGF3YWl0IChjb25zdCBub2RlIG9mIHRoaXMuZGh0Ll9yZXNvbHZlQm9vdHN0cmFwTm9kZXMoKSkgewogICAgICB0aGlzLl9hZGRQZW5kaW5nKG5vZGUsIG51bGwpCiAgICB9CgogICAgY2IobnVsbCkKICB9CgogIF9pc0Nsb3NlcihpZCkgewogICAgcmV0dXJuICgKICAgICAgdGhpcy5jbG9zZXN0UmVwbGllcy5sZW5ndGggPCB0aGlzLmsgfHwKICAgICAgdGhpcy5fY29tcGFyZShpZCwgdGhpcy5jbG9zZXN0UmVwbGllc1t0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCAtIDFdLmZyb20uaWQpIDwgMAogICAgKQogIH0KCiAgX2FkZFBlbmRpbmcobm9kZSwgcmVmKSB7CiAgICBpZiAodGhpcy5fb25seUNsb3Nlc3ROb2RlcykgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgYWRkciA9IG5vZGUuaG9zdCArICc6JyArIG5vZGUucG9ydAogICAgY29uc3QgcmVmcyA9IHRoaXMuX3NlZW4uZ2V0KGFkZHIpCiAgICBjb25zdCBpc0Nsb3NlciA9IHRoaXMuX2lzQ2xvc2VyKG5vZGUuaWQpCgogICAgaWYgKHJlZnMgPT09IERPTkUpIHsKICAgICAgcmV0dXJuIGlzQ2xvc2VyCiAgICB9CgogICAgaWYgKHJlZnMgPT09IERPV04pIHsKICAgICAgaWYgKHJlZikgdGhpcy5fZG93bkhpbnQocmVmLCBub2RlKQogICAgICByZXR1cm4gaXNDbG9zZXIKICAgIH0KCiAgICBpZiAocmVmcykgewogICAgICBpZiAocmVmICE9PSBudWxsKSByZWZzLnB1c2gocmVmKQogICAgICByZXR1cm4gaXNDbG9zZXIKICAgIH0KCiAgICBpZiAoIWlzQ2xvc2VyKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMuX3NlZW4uc2V0KGFkZHIsIHJlZiA9PT0gbnVsbCA/IFtdIDogW3JlZl0pCiAgICB0aGlzLl9wZW5kaW5nLnB1c2gobm9kZSkKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMuX3JlYWRNb3JlKCkKICAgIGNiKG51bGwpCiAgfQoKICBfcmVhZE1vcmUoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95aW5nIHx8IHRoaXMuX2NvbW1pdGluZykgcmV0dXJuCgogICAgY29uc3QgY29uY3VycmVuY3kgPSAodGhpcy5fc2xvd2Rvd24gPyAzIDogdGhpcy5jb25jdXJyZW5jeSkgKyB0aGlzLl9zbG93CgogICAgd2hpbGUgKHRoaXMuaW5mbGlnaHQgPCBjb25jdXJyZW5jeSAmJiB0aGlzLl9wZW5kaW5nLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbmV4dCA9IHRoaXMuX3BlbmRpbmcucG9wKCkKICAgICAgaWYgKG5leHQgJiYgbmV4dC5pZCAmJiAhdGhpcy5faXNDbG9zZXIobmV4dC5pZCkpIGNvbnRpbnVlCiAgICAgIHRoaXMuX3Zpc2l0KG5leHQpCiAgICB9CgogICAgLy8gaWYgcmV1c2luZyBjbG9zZXN0IG5vZGVzLCBzbG93IGRvd24gYWZ0ZXIgdGhlIGZpcnN0IHJlYWRNb3JlIHRpY2sgdG8gYWxsb3cKICAgIC8vIHRoZSBjbG9zZXN0IG5vZGUgYSBjaGFuY2UgdG8gcmVwbHkgYmVmb3JlIGdvaW5nIGJyb2FkIHRvIHF1ZXN0aW9uIG1vcmUKICAgIGlmICghdGhpcy5fZnJvbVRhYmxlICYmIHRoaXMuc3VjY2Vzc2VzID09PSAwICYmIHRoaXMuZXJyb3JzID09PSAwKSB7CiAgICAgIHRoaXMuX3Nsb3dkb3duID0gdHJ1ZQogICAgfQoKICAgIGlmICh0aGlzLl9wZW5kaW5nLmxlbmd0aCA+IDApIHJldHVybgoKICAgIC8vIGlmIG5vIGluZmxpZ2h0IE9SIGFsbCB0aGUgcXVlcmllcyB3ZSBhcmUgd2FpdGluZyBvbiBhcmUgbWFya2VkIGFzIHNsb3cgKHdpdGhpbiBvdXIgbGltaXRzKSBhbmQgd2UgaGF2ZSBhIGZ1bGwgcmVzdWx0LgogICAgaWYgKAogICAgICB0aGlzLmluZmxpZ2h0ID09PSAwIHx8CiAgICAgICh0aGlzLl9zbG93IDw9IHRoaXMubWF4U2xvdyAmJgogICAgICAgIHRoaXMuX3Nsb3cgPT09IHRoaXMuaW5mbGlnaHQgJiYKICAgICAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCA+PSB0aGlzLmspCiAgICApIHsKICAgICAgLy8gaWYgbW9yZSB0aGFuIDMvNCBmYWlsZWQgYW5kIHdlIG9ubHkgdXNlZCBjYWNoZWQgbm9kZXMsIHRyeSBhZ2FpbiBmcm9tIHRoZSByb3V0aW5nIHRhYmxlCiAgICAgIGlmICghdGhpcy5fZnJvbVRhYmxlICYmIHRoaXMuc3VjY2Vzc2VzIDwgdGhpcy5rIC8gNCkgewogICAgICAgIHRoaXMuX2FkZEZyb21UYWJsZSgpCiAgICAgICAgdGhpcy5fcmVhZE1vcmUoKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICB0aGlzLl9mbHVzaCgpCiAgICB9CiAgfQoKICBfZmx1c2goKSB7CiAgICBpZiAodGhpcy5fY29tbWl0aW5nKSByZXR1cm4KICAgIHRoaXMuX2NvbW1pdGluZyA9IHRydWUKCiAgICBpZiAodGhpcy5fY29tbWl0ID09PSBudWxsKSB7CiAgICAgIHRoaXMucHVzaChudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBwID0gW10KICAgIGZvciAoY29uc3QgbSBvZiB0aGlzLmNsb3Nlc3RSZXBsaWVzKSBwLnB1c2godGhpcy5fY29tbWl0KG0sIHRoaXMuZGh0LCB0aGlzKSkKICAgIHRoaXMuX2VuZEFmdGVyQ29tbWl0KHApCiAgfQoKICBfZW5kQWZ0ZXJDb21taXQocHMpIHsKICAgIGlmICghcHMubGVuZ3RoKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ1RvbyBmZXcgbm9kZXMgcmVzcG9uZGVkJykpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHNlbGYgPSB0aGlzCgogICAgbGV0IHBlbmRpbmcgPSBwcy5sZW5ndGgKICAgIGxldCBzdWNjZXNzID0gMAoKICAgIGZvciAoY29uc3QgcCBvZiBwcykgcC50aGVuKG9uZG9uZSwgb25lcnJvcikKCiAgICBmdW5jdGlvbiBvbmRvbmUoKSB7CiAgICAgIHN1Y2Nlc3MrKwogICAgICBpZiAoLS1wZW5kaW5nID09PSAwKSBzZWxmLnB1c2gobnVsbCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmVycm9yKGVycikgewogICAgICBpZiAoLS1wZW5kaW5nID4gMCkgcmV0dXJuCiAgICAgIGlmIChzdWNjZXNzKSBzZWxmLnB1c2gobnVsbCkKICAgICAgZWxzZSBzZWxmLmRlc3Ryb3koZXJyKQogICAgfQogIH0KCiAgX2RlYyhyZXEpIHsKICAgIGlmIChyZXEub25jeWNsZSA9PT0gbm9vcCkgewogICAgICB0aGlzLl9zbG93LS0KICAgIH0gZWxzZSB7CiAgICAgIHJlcS5vbmN5Y2xlID0gbm9vcAogICAgfQogICAgdGhpcy5pbmZsaWdodC0tCiAgfQoKICBfb252aXNpdChtLCByZXEpIHsKICAgIHRoaXMuX2RlYyhyZXEpCgogICAgdGhpcy5fb25saW5lID0gdHJ1ZQogICAgaWYgKCF0aGlzLmRodC5vbmxpbmUpIHRoaXMuZGh0Ll9vbmxpbmUoKQoKICAgIGNvbnN0IGFkZHIgPSByZXEudG8uaG9zdCArICc6JyArIHJlcS50by5wb3J0CiAgICB0aGlzLl9zZWVuLnNldChhZGRyLCBET05FKQoKICAgIGlmICh0aGlzLl9jb21taXRpbmcpIHJldHVybgoKICAgIGlmIChtLmVycm9yID09PSAwKSB0aGlzLnN1Y2Nlc3NlcysrCiAgICBlbHNlIHRoaXMuZXJyb3JzKysKCiAgICBpZiAobS5lcnJvciA9PT0gMCAmJiBtLmZyb20uaWQgIT09IG51bGwgJiYgdGhpcy5faXNDbG9zZXIobS5mcm9tLmlkKSkgdGhpcy5fcHVzaENsb3Nlc3QobSkKCiAgICBpZiAobS5jbG9zZXJOb2RlcyAhPT0gbnVsbCkgewogICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgbS5jbG9zZXJOb2RlcykgewogICAgICAgIG5vZGUuaWQgPSBwZWVyLmlkKG5vZGUuaG9zdCwgbm9kZS5wb3J0KQogICAgICAgIGlmICh0aGlzLmRodC5fZmlsdGVyTm9kZSAhPT0gbnVsbCAmJiAhdGhpcy5kaHQuX2ZpbHRlck5vZGUobm9kZSkpIGNvbnRpbnVlCiAgICAgICAgaWYgKGI0YS5lcXVhbHMobm9kZS5pZCwgdGhpcy5kaHQudGFibGUuaWQpKSBjb250aW51ZQogICAgICAgIC8vIFRPRE86IHdlIGNvdWxkIGNvbnRpbnVlIGhlcmUgaW5zdGVhZCBvZiBicmVha2luZyB0byBlbnN1cmUgdGhhdCBvbmUgb2YgdGhlIG5vZGVzIGluIHRoZSBjbG9zZXIgbGlzdAogICAgICAgIC8vIGlzIGxhdGVyIG1hcmtlZCBhcyBET1dOIHRoYXQgd2UgZ29zc2lwIHRoYXQgYmFjawogICAgICAgIGlmICghdGhpcy5fYWRkUGVuZGluZyhub2RlLCBtLmZyb20pKSBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKCF0aGlzLl9mcm9tVGFibGUgJiYgdGhpcy5zdWNjZXNzZXMgKyB0aGlzLmVycm9ycyA+PSB0aGlzLmNvbmN1cnJlbmN5KSB7CiAgICAgIHRoaXMuX3Nsb3dkb3duID0gZmFsc2UKICAgIH0KCiAgICBpZiAobS5lcnJvciAhPT0gMCkgewogICAgICB0aGlzLl9yZWFkTW9yZSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGRhdGEgPSB0aGlzLm1hcChtKQogICAgaWYgKCFkYXRhIHx8IHRoaXMucHVzaChkYXRhKSAhPT0gZmFsc2UpIHsKICAgICAgdGhpcy5fcmVhZE1vcmUoKQogICAgfQogIH0KCiAgX29uZXJyb3IoZXJyLCByZXEpIHsKICAgIGNvbnN0IGFkZHIgPSByZXEudG8uaG9zdCArICc6JyArIHJlcS50by5wb3J0CiAgICBjb25zdCByZWZzID0gdGhpcy5fc2Vlbi5nZXQoYWRkcikKCiAgICBpZiAoZXJyLmNvZGUgPT09ICdSRVFVRVNUX1RJTUVPVVQnKSB7CiAgICAgIHRoaXMuX3NlZW4uc2V0KGFkZHIsIERPV04pCiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiByZWZzKSB0aGlzLl9kb3duSGludChub2RlLCByZXEudG8pCiAgICB9CgogICAgdGhpcy5fZGVjKHJlcSkKICAgIHRoaXMuZXJyb3JzKysKICAgIHRoaXMuX3JlYWRNb3JlKCkKICB9CgogIF9vbmN5Y2xlKHJlcSkgewogICAgcmVxLm9uY3ljbGUgPSBub29wCiAgICB0aGlzLl9zbG93KysKICAgIHRoaXMuX3JlYWRNb3JlKCkKICB9CgogIF9kb3duSGludChub2RlLCBkb3duKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDAsIGVuZDogNiwgYnVmZmVyOiBiNGEuYWxsb2NVbnNhZmUoNikgfQogICAgcGVlci5pcHY0LmVuY29kZShzdGF0ZSwgZG93bikKICAgIHRoaXMuZGh0Ll9yZXF1ZXN0KG5vZGUsIGZhbHNlLCB0cnVlLCBET1dOX0hJTlQsIG51bGwsIHN0YXRlLmJ1ZmZlciwgdGhpcy5fc2Vzc2lvbiwgbm9vcCwgbm9vcCkKICB9CgogIF9wdXNoQ2xvc2VzdChtKSB7CiAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzLnB1c2gobSkKICAgIGZvciAobGV0IGkgPSB0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHByZXYgPSB0aGlzLmNsb3Nlc3RSZXBsaWVzW2ldCiAgICAgIGNvbnN0IGNtcCA9IHRoaXMuX2NvbXBhcmUocHJldi5mcm9tLmlkLCBtLmZyb20uaWQpCiAgICAgIC8vIGlmIHNvcnRlZCwgZG9uZSEKICAgICAgaWYgKGNtcCA8IDApIGJyZWFrCiAgICAgIC8vIGlmIGR1cCwgc3BsaWNlIGl0IG91dCAocmFyZSkKICAgICAgaWYgKGNtcCA9PT0gMCkgewogICAgICAgIHRoaXMuY2xvc2VzdFJlcGxpZXMuc3BsaWNlKGkgKyAxLCAxKQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgICAgLy8gc3dhcCBhbmQgY29udGludWUgZG93bgogICAgICB0aGlzLmNsb3Nlc3RSZXBsaWVzW2kgKyAxXSA9IHByZXYKICAgICAgdGhpcy5jbG9zZXN0UmVwbGllc1tpXSA9IG0KICAgIH0KICAgIGlmICh0aGlzLmNsb3Nlc3RSZXBsaWVzLmxlbmd0aCA+IHRoaXMuaykgdGhpcy5jbG9zZXN0UmVwbGllcy5wb3AoKQogIH0KCiAgX2NvbXBhcmUoYSwgYikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChhW2ldID09PSBiW2ldKSBjb250aW51ZQogICAgICBjb25zdCB0ID0gdGhpcy50YXJnZXRbaV0KICAgICAgcmV0dXJuICh0IF4gYVtpXSkgLSAodCBeIGJbaV0pCiAgICB9CiAgICByZXR1cm4gMAogIH0KCiAgX3Zpc2l0KHRvKSB7CiAgICB0aGlzLmluZmxpZ2h0KysKCiAgICBjb25zdCByZXEgPSB0aGlzLmRodC5fcmVxdWVzdCgKICAgICAgdG8sCiAgICAgIHRoaXMuZm9yY2UsCiAgICAgIHRoaXMuaW50ZXJuYWwsCiAgICAgIHRoaXMuY29tbWFuZCwKICAgICAgdGhpcy50YXJnZXQsCiAgICAgIHRoaXMudmFsdWUsCiAgICAgIHRoaXMuX3Nlc3Npb24sCiAgICAgIHRoaXMuX29udmlzaXRib3VuZCwKICAgICAgdGhpcy5fb25lcnJvcmJvdW5kCiAgICApCiAgICBpZiAocmVxID09PSBudWxsKSB7CiAgICAgIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ05vZGUgd2FzIGRlc3Ryb3llZCcpKQogICAgICByZXR1cm4KICAgIH0KICAgIHJlcS5yZXRyaWVzID0gdGhpcy5yZXRyaWVzCiAgICByZXEub25jeWNsZSA9IHRoaXMuX29uY3ljbGVib3VuZAogICAgaWYgKHRoaXMuZm9yY2UpIHJlcS5yZXRyaWVzID0gMAogIH0KCiAgX2Rlc3Ryb3koY2IpIHsKICAgIHRoaXMuZGh0LnN0YXRzLnF1ZXJpZXMuYWN0aXZlLS0KICAgIGlmICghdGhpcy5fb25saW5lICYmIHRoaXMuZGh0Lm9ubGluZSkgdGhpcy5kaHQuX29mZmxpbmUoKQogICAgaWYgKHRoaXMuX2F1dG9EZXN0cm95U2Vzc2lvbikgdGhpcy5fc2Vzc2lvbi5kZXN0cm95KCkKICAgIGNiKG51bGwpCiAgfQp9CgpmdW5jdGlvbiBhdXRvQ29tbWl0KHJlcGx5LCBkaHQsIHF1ZXJ5KSB7CiAgaWYgKCFyZXBseS50b2tlbikgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignTm8gdG9rZW4gcmVjZWl2ZWQgZm9yIGNsb3Nlc3Qgbm9kZScpKQogIHJldHVybiBkaHQucmVxdWVzdCgKICAgIHsKICAgICAgdG9rZW46IHJlcGx5LnRva2VuLAogICAgICB0YXJnZXQ6IHF1ZXJ5LnRhcmdldCwKICAgICAgY29tbWFuZDogcXVlcnkuY29tbWFuZCwKICAgICAgdmFsdWU6IHF1ZXJ5LnZhbHVlCiAgICB9LAogICAgcmVwbHkuZnJvbQogICkKfQoKZnVuY3Rpb24gZGVmYXVsdE1hcChtKSB7CiAgcmV0dXJuIG0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2Vzc2lvbiB7CiAgY29uc3RydWN0b3IoZGh0KSB7CiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5pbmZsaWdodCA9IFtdCiAgfQoKICBfYXR0YWNoKHJlcSkgewogICAgcmVxLmluZGV4ID0gdGhpcy5pbmZsaWdodC5wdXNoKHJlcSkgLSAxCiAgfQoKICBfZGV0YWNoKHJlcSkgewogICAgY29uc3QgaSA9IHJlcS5pbmRleAogICAgaWYgKGkgPT09IC0xKSByZXR1cm4KICAgIHJlcS5pbmRleCA9IC0xCgogICAgaWYgKGkgPT09IHRoaXMuaW5mbGlnaHQubGVuZ3RoIC0gMSkgdGhpcy5pbmZsaWdodC5wb3AoKQogICAgZWxzZSB7CiAgICAgIGNvbnN0IHJlcSA9ICh0aGlzLmluZmxpZ2h0W2ldID0gdGhpcy5pbmZsaWdodC5wb3AoKSkKICAgICAgcmVxLmluZGV4ID0gaQogICAgfQogIH0KCiAgcXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQsIHZhbHVlIH0sIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIHRoaXMuZGh0LnF1ZXJ5KHsgdGFyZ2V0LCBjb21tYW5kLCB2YWx1ZSB9LCB7IC4uLm9wdHMsIHNlc3Npb246IHRoaXMgfSkKICB9CgogIHJlcXVlc3QoeyB0b2tlbiwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSB9LCB7IGhvc3QsIHBvcnQgfSwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5kaHQucmVxdWVzdCgKICAgICAgeyB0b2tlbiwgY29tbWFuZCwgdGFyZ2V0LCB2YWx1ZSB9LAogICAgICB7IGhvc3QsIHBvcnQgfSwKICAgICAgeyAuLi5vcHRzLCBzZXNzaW9uOiB0aGlzIH0KICAgICkKICB9CgogIHBpbmcoeyBob3N0LCBwb3J0IH0sIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIHRoaXMuZGh0LnBpbmcoeyBob3N0LCBwb3J0IH0sIHsgLi4ub3B0cywgc2Vzc2lvbjogdGhpcyB9KQogIH0KCiAgZGVzdHJveShlcnIpIHsKICAgIHdoaWxlICh0aGlzLmluZmxpZ2h0Lmxlbmd0aCkgewogICAgICBjb25zdCByZXEgPSB0aGlzLmluZmxpZ2h0WzBdCiAgICAgIC8vIHByZXZlbnQgZGVzdHJveWVkIHJlcXVlc3RzIGZyb20gY29udHJpYnV0aW5nIHRvIGNvbmdlc3Rpb24gY291bnRzCiAgICAgIHRoaXMuZGh0LmlvLmNvbmdlc3Rpb24ucmVjdigpCiAgICAgIHJlcS5kZXN0cm95KGVycikKICAgIH0KICB9Cn0KewogICJuYW1lIjogImRodC1ycGMiLAogICJ2ZXJzaW9uIjogIjYuMjAuMiIsCiAgImRlc2NyaXB0aW9uIjogIk1ha2UgUlBDIGNhbGxzIG92ZXIgYSBLYWRlbWxpYSBiYXNlZCBESFQiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qLmpzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMSIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgImNvbXBhY3QtZW5jb2RpbmctbmV0IjogIl4xLjIuMCIsCiAgICAiZmFzdC1maWZvIjogIl4xLjEuMCIsCiAgICAia2FkZW1saWEtcm91dGluZy10YWJsZSI6ICJeMS4wLjEiLAogICAgIm5hdC1zYW1wbGVyIjogIl4xLjAuMSIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiLAogICAgInN0cmVhbXgiOiAiXjIuMTMuMiIsCiAgICAidGltZS1vcmRlcmVkLXNldCI6ICJeMi4wLjAiLAogICAgInVkeC1uYXRpdmUiOiAiXjEuNS4zIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAibHVudGUiOiAiXjEuMy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJ0ZXN0LXN1c3BlbmQiOiAiXjEuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAidGVzdCI6ICJucG0gcnVuIHRlc3Q6bm9kZSAmJiBucG0gcnVuIHRlc3Q6YmFyZSIsCiAgICAidGVzdDpiYXJlIjogImJyaXR0bGUtYmFyZSAtLWNvdmVyYWdlIHRlc3QuanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIGx1bnRlIiwKICAgICJ0ZXN0Om5vZGUiOiAiYnJpdHRsZS1ub2RlIC0tY292ZXJhZ2UgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kaHQtcnBjLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9kaHQtcnBjL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2RodC1ycGMiCn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCdiYXJlLWV2ZW50cycpCnsKICAibmFtZSI6ICJldmVudHMtdW5pdmVyc2FsIiwKICAidmVyc2lvbiI6ICIxLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIlVuaXZlcnNhbCB3cmFwcGVyIGZvciB0aGUgTm9kZS5qcyBldmVudHMgbW9kdWxlIiwKICAiZXhwb3J0cyI6IHsKICAgICIuL3BhY2thZ2UiOiAiLi9wYWNrYWdlLmpzb24iLAogICAgIi4iOiB7CiAgICAgICJiYXJlIjogIi4vYmFyZS5qcyIsCiAgICAgICJyZWFjdC1uYXRpdmUiOiAiLi9yZWFjdC1uYXRpdmUuanMiLAogICAgICAiZGVmYXVsdCI6ICIuL2RlZmF1bHQuanMiCiAgICB9CiAgfSwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImRlZmF1bHQuanMiLAogICAgImJhcmUuanMiLAogICAgInJlYWN0LW5hdGl2ZS5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2V2ZW50cy11bml2ZXJzYWwuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vZXZlbnRzLXVuaXZlcnNhbC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2V2ZW50cy11bml2ZXJzYWwjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZXZlbnRzIjogIl4yLjcuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9Cn0KbW9kdWxlLmV4","cG9ydHMgPSBjbGFzcyBGaXhlZEZJRk8gewogIGNvbnN0cnVjdG9yIChod20pIHsKICAgIGlmICghKGh3bSA+IDApIHx8ICgoaHdtIC0gMSkgJiBod20pICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ01heCBzaXplIGZvciBhIEZpeGVkRklGTyBzaG91bGQgYmUgYSBwb3dlciBvZiB0d28nKQogICAgdGhpcy5idWZmZXIgPSBuZXcgQXJyYXkoaHdtKQogICAgdGhpcy5tYXNrID0gaHdtIC0gMQogICAgdGhpcy50b3AgPSAwCiAgICB0aGlzLmJ0bSA9IDAKICAgIHRoaXMubmV4dCA9IG51bGwKICB9CgogIGNsZWFyICgpIHsKICAgIHRoaXMudG9wID0gdGhpcy5idG0gPSAwCiAgICB0aGlzLm5leHQgPSBudWxsCiAgICB0aGlzLmJ1ZmZlci5maWxsKHVuZGVmaW5lZCkKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGlmICh0aGlzLmJ1ZmZlclt0aGlzLnRvcF0gIT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLmJ1ZmZlclt0aGlzLnRvcF0gPSBkYXRhCiAgICB0aGlzLnRvcCA9ICh0aGlzLnRvcCArIDEpICYgdGhpcy5tYXNrCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgc2hpZnQgKCkgewogICAgY29uc3QgbGFzdCA9IHRoaXMuYnVmZmVyW3RoaXMuYnRtXQogICAgaWYgKGxhc3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZAogICAgdGhpcy5idWZmZXJbdGhpcy5idG1dID0gdW5kZWZpbmVkCiAgICB0aGlzLmJ0bSA9ICh0aGlzLmJ0bSArIDEpICYgdGhpcy5tYXNrCiAgICByZXR1cm4gbGFzdAogIH0KCiAgcGVlayAoKSB7CiAgICByZXR1cm4gdGhpcy5idWZmZXJbdGhpcy5idG1dCiAgfQoKICBpc0VtcHR5ICgpIHsKICAgIHJldHVybiB0aGlzLmJ1ZmZlclt0aGlzLmJ0bV0gPT09IHVuZGVmaW5lZAogIH0KfQpjb25zdCBGaXhlZEZJRk8gPSByZXF1aXJlKCcuL2ZpeGVkLXNpemUnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBGYXN0RklGTyB7CiAgY29uc3RydWN0b3IgKGh3bSkgewogICAgdGhpcy5od20gPSBod20gfHwgMTYKICAgIHRoaXMuaGVhZCA9IG5ldyBGaXhlZEZJRk8odGhpcy5od20pCiAgICB0aGlzLnRhaWwgPSB0aGlzLmhlYWQKICAgIHRoaXMubGVuZ3RoID0gMAogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy5oZWFkID0gdGhpcy50YWlsCiAgICB0aGlzLmhlYWQuY2xlYXIoKQogICAgdGhpcy5sZW5ndGggPSAwCiAgfQoKICBwdXNoICh2YWwpIHsKICAgIHRoaXMubGVuZ3RoKysKICAgIGlmICghdGhpcy5oZWFkLnB1c2godmFsKSkgewogICAgICBjb25zdCBwcmV2ID0gdGhpcy5oZWFkCiAgICAgIHRoaXMuaGVhZCA9IHByZXYubmV4dCA9IG5ldyBGaXhlZEZJRk8oMiAqIHRoaXMuaGVhZC5idWZmZXIubGVuZ3RoKQogICAgICB0aGlzLmhlYWQucHVzaCh2YWwpCiAgICB9CiAgfQoKICBzaGlmdCAoKSB7CiAgICBpZiAodGhpcy5sZW5ndGggIT09IDApIHRoaXMubGVuZ3RoLS0KICAgIGNvbnN0IHZhbCA9IHRoaXMudGFpbC5zaGlmdCgpCiAgICBpZiAodmFsID09PSB1bmRlZmluZWQgJiYgdGhpcy50YWlsLm5leHQpIHsKICAgICAgY29uc3QgbmV4dCA9IHRoaXMudGFpbC5uZXh0CiAgICAgIHRoaXMudGFpbC5uZXh0ID0gbnVsbAogICAgICB0aGlzLnRhaWwgPSBuZXh0CiAgICAgIHJldHVybiB0aGlzLnRhaWwuc2hpZnQoKQogICAgfQoKICAgIHJldHVybiB2YWwKICB9CgogIHBlZWsgKCkgewogICAgY29uc3QgdmFsID0gdGhpcy50YWlsLnBlZWsoKQogICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkICYmIHRoaXMudGFpbC5uZXh0KSByZXR1cm4gdGhpcy50YWlsLm5leHQucGVlaygpCiAgICByZXR1cm4gdmFsCiAgfQoKICBpc0VtcHR5ICgpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMAogIH0KfQp7CiAgIm5hbWUiOiAiZmFzdC1maWZvIiwKICAidmVyc2lvbiI6ICIxLjMuMiIsCiAgImRlc2NyaXB0aW9uIjogIkEgZmFzdCBmaWZvIGltcGxlbWVudGF0aW9uIHNpbWlsYXIgdG8gdGhlIG9uZSBwb3dlcmluZyBuZXh0VGljayBpbiBOb2RlLmpzIGNvcmUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiLi9pbmRleC5qcyIsCiAgICAiLi9maXhlZC1zaXplLmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mYXN0LWZpZm8uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2Zhc3QtZmlmby9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9mYXN0LWZpZm8iCn0KY29uc3QgZnMgPSByZXF1aXJlKCdmcycpCmNvbnN0IGZzeCA9IHJlcXVpcmUoJ2ZzLW5hdGl2ZS1leHRlbnNpb25zJykKY29uc3Qgb25leGl0ID0gcmVxdWlyZSgncmVzb3VyY2Utb24tZXhpdCcpCmNvbnN0IFJlYWR5UmVzb3VyY2UgPSByZXF1aXJlKCdyZWFkeS1yZXNvdXJjZScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEZETG9jayBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yKGZkLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgd2FpdCA9IGZhbHNlIH0gPSBvcHRzCgogICAgc3VwZXIoKQoKICAgIHRoaXMuX2ZkID0gZmQKICAgIHRoaXMuX3dhaXQgPSB3YWl0CiAgICB0aGlzLl9sb2NrZWQgPSBmYWxzZQoKICAgIG9uZXhpdC5hZGQodGhpcywgY2xvc2VTeW5jKQogIH0KCiAgYXN5bmMgX29wZW4oKSB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9yZXN1bWUoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIG9uZXhpdC5yZW1vdmUodGhpcykKICAgICAgYXdhaXQgY2xvc2UodGhpcykKICAgICAgdGhyb3cgZXJyCiAgICB9CiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBvbmV4aXQucmVtb3ZlKHRoaXMpCiAgICBhd2FpdCBjbG9zZSh0aGlzKQogIH0KCiAgdHJhbnNmZXIoKSB7CiAgICBjb25zdCBmZCA9IHRoaXMuX2ZkCiAgICBpZiAoZmQgPT09IC0xKSB0aHJvdyBuZXcgRXJyb3IoJ0xvY2sgaGFzIGFscmVhZHkgYmVlbiB0cmFuc2ZlcnJlZCcpCiAgICB0aGlzLl9mZCA9IC0xCiAgICBvbmV4aXQucmVtb3ZlKHRoaXMpCiAgICByZXR1cm4gZmQKICB9CgogIGFzeW5jIHN1c3BlbmQoKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLnJlYWR5KCkKICAgIHJldHVybiB0aGlzLl9zdXNwZW5kKCkKICB9CgogIGFzeW5jIF9zdXNwZW5kKCkgewogICAgaWYgKHRoaXMuX2ZkID09PSAtMSB8fCB0aGlzLl9sb2NrZWQgPT09IGZhbHNlKSByZXR1cm4KICAgIGZzeC51bmxvY2sodGhpcy5fZmQpCiAgICB0aGlzLl9sb2NrZWQgPSBmYWxzZQogIH0KCiAgYXN5bmMgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLm9wZW5lZCkgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICByZXR1cm4gdGhpcy5fcmVzdW1lKCkKICB9CgogIGFzeW5jIF9yZXN1bWUoKSB7CiAgICBpZiAodGhpcy5fZmQgPT09IC0xIHx8IHRoaXMuX2xvY2tlZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBpZiAodGhpcy5fd2FpdCkgYXdhaXQgZnN4LndhaXRGb3JMb2NrKHRoaXMuX2ZkKQogICAgZWxzZSBpZiAoIWZzeC50cnlMb2NrKHRoaXMuX2ZkKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZpbGUgZGVzY3JpcHRvciBjb3VsZCBub3QgYmUgbG9ja2VkJykKICAgIH0KICAgIHRoaXMuX2xvY2tlZCA9IHRydWUKICB9Cn0KCmZ1bmN0aW9uIGNsb3NlKGxvY2spIHsKICBjb25zdCBmZCA9IGxvY2suX2ZkCiAgaWYgKGZkID09PSAtMSkgcmV0dXJuCiAgbG9jay5fZmQgPSAtMQogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gZnMuY2xvc2UoZmQsICgpID0+IHJlc29sdmUoKSkpCn0KCmZ1bmN0aW9uIGNsb3NlU3luYyhsb2NrKSB7CiAgY29uc3QgZmQgPSBsb2NrLl9mZAogIGlmIChmZCA9PT0gLTEpIHJldHVybgogIGxvY2suX2ZkID0gLTEKICB0cnkgewogICAgZnMuY2xvc2VTeW5jKGZkKQogIH0gY2F0Y2gge30KfQp7CiAgIm5hbWUiOiAiZmQtbG9jayIsCiAgInZlcnNpb24iOiAiMi4xLjEiLAogICJkZXNjcmlwdGlvbiI6ICJTdGF0ZWZ1bCBmaWxlIGRlc2NyaXB0b3IgbG9ja3MgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6ICIuL2luZGV4LmpzIgogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibnBtIHJ1biBsaW50ICYmIG5wbSBydW4gdGVzdDpiYXJlICYmIG5wbSBydW4gdGVzdDpub2RlIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0LmpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0LmpzIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiIsCiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mZC1sb2NrLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZkLWxvY2svaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mZC1sb2NrI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWZzIjogIl40LjUuMCIsCiAgICAiZnMtbmF0aXZlLWV4dGVuc2lvbnMiOiAiXjEuNC40IiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4yLjAiLAogICAgInJlc291cmNlLW9uLWV4aXQiOiAiXjEuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNC4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9Cn0KZXhwb3J0cy5mdWxsUm9vdHMgPSBmdW5jdGlvbiAoaW5kZXgsIHJlc3VsdCkgewogIGlmIChpbmRleCAmIDEpIHRocm93IG5ldyBFcnJvcignWW91IGNhbiBvbmx5IGxvb2sgdXAgcm9vdHMgZm9yIGRlcHRoKDApIGJsb2NrcycpCiAgaWYgKCFyZXN1bHQpIHJlc3VsdCA9IFtdCgogIGluZGV4IC89IDIKCiAgbGV0IG9mZnNldCA9IDAKICBsZXQgZmFjdG9yID0gMQoKICB3aGlsZSAodHJ1ZSkgewogICAgaWYgKCFpbmRleCkgcmV0dXJuIHJlc3VsdAogICAgd2hpbGUgKGZhY3RvciAqIDIgPD0gaW5kZXgpIGZhY3RvciAqPSAyCiAgICByZXN1bHQucHVzaChvZmZzZXQgKyBmYWN0b3IgLSAxKQogICAgb2Zmc2V0ID0gb2Zmc2V0ICsgMiAqIGZhY3RvcgogICAgaW5kZXggLT0gZmFjdG9yCiAgICBmYWN0b3IgPSAxCiAgfQp9CgpleHBvcnRzLmZ1dHVyZVJvb3RzID0gZnVuY3Rpb24gKGluZGV4LCByZXN1bHQpIHsKICBpZiAoaW5kZXggJiAxKSB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBjYW4gb25seSBsb29rIHVwIGZ1dHVyZSByb290cyBmb3IgZGVwdGgoMCkgYmxvY2tzJykKICBpZiAoIXJlc3VsdCkgcmVzdWx0ID0gW10KCiAgbGV0IGZhY3RvciA9IDEKCiAgLy8gbWFrZSBmaXJzdCByb290CiAgd2hpbGUgKGZhY3RvciAqIDIgPD0gaW5kZXgpIGZhY3RvciAqPSAyCgogIC8vIGZ1bGwgZmFjdG9yIG9mIDIgLSBkb25lCiAgaWYgKGZhY3RvciAqIDIgLSAyID09PSBpbmRleCkgcmV0dXJuIHJlc3VsdAoKICBsZXQgcG9zID0gZmFjdG9yIC8gMiAtIDEKCiAgLy8gd2hpbGUgaXRzIG5vdCBhIGZ1bGwgdHJlZQogIHdoaWxlICgocG9zICsgZmFjdG9yIC8gMiAtIDEpICE9PSBpbmRleCkgewogICAgcG9zICs9IGZhY3RvcgoKICAgIC8vIHJlYWQgdG9vIGZhciwgdG8gdG8gbGVmdCBjaGlsZAogICAgd2hpbGUgKChwb3MgKyBmYWN0b3IgLyAyIC0gMSkgPiBpbmRleCkgewogICAgICBmYWN0b3IgLz0gMgogICAgICBwb3MgLT0gZmFjdG9yIC8gMgogICAgfQoKICAgIC8vIHRoZSAiZ2FwIiBpcyBhIGZ1dHVyZSByb290CiAgICByZXN1bHQucHVzaChwb3MgLSBmYWN0b3IgLyAyKQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CgpleHBvcnRzLnBhdGNoID0gZnVuY3Rpb24gKGZyb20sIHRvKSB7CiAgaWYgKGZyb20gPT09IDAgfHwgZnJvbSA+PSB0bykgcmV0dXJuIFtdCgogIGNvbnN0IHJvb3RzID0gZXhwb3J0cy5mdWxsUm9vdHMoZnJvbSkKICBjb25zdCB0YXJnZXQgPSBleHBvcnRzLmZ1bGxSb290cyh0bykKCiAgLy8gZmlyc3QgZmluZCB0aGUgZmlyc3Qgcm9vdCB0aGF0IGlzIGRpZmZlcmVudAoKICBsZXQgaSA9IDAKICBmb3IgKDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgewogICAgaWYgKGkgPj0gcm9vdHMubGVuZ3RoIHx8IHJvb3RzW2ldICE9PSB0YXJnZXRbaV0pIGJyZWFrCiAgfQoKICBjb25zdCBwYXRjaCA9IFtdCgogIGlmIChpIDwgcm9vdHMubGVuZ3RoKSB7CiAgICAvLyBub3cgd2UgbmVlZCB0byBncm93IHRoZSBuZXdlc3Qgcm9vdCB1bnRpbCBpdCBoaXRzIHRoZSBkaWZmIG9uZQogICAgbGV0IHByZXYgPSByb290cy5sZW5ndGggLSAxCgogICAgY29uc3QgaXRlID0gZXhwb3J0cy5pdGVyYXRvcihyb290c1twcmV2LS1dKQoKICAgIHdoaWxlIChpdGUuaW5kZXggIT09IHRhcmdldFtpXSkgewogICAgICBpdGUuc2libGluZygpCgogICAgICBpZiAocHJldiA+PSAwICYmIGl0ZS5pbmRleCA9PT0gcm9vdHNbcHJldl0pIHsKICAgICAgICBwcmV2LS0KICAgICAgfSBlbHNlIHsKICAgICAgICBwYXRjaC5wdXNoKGl0ZS5pbmRleCkKICAgICAgfQoKICAgICAgcGF0Y2gucHVzaChpdGUucGFyZW50KCkpCiAgICB9CgogICAgaSsrIC8vIHBhdGNoZWQgdG8gbmV4dCByb290LCBzbyBpbmMKICB9CgogIC8vIGluY2x1ZGUgdGhlIHJlc3QKCiAgZm9yICg7IGkgPCB0YXJnZXQubGVuZ3RoOyBpKyspIHBhdGNoLnB1c2godGFyZ2V0W2ldKQoKICByZXR1cm4gcGF0Y2gKfQoKZXhwb3J0cy5kZXB0aCA9IGZ1bmN0aW9uIChpbmRleCkgewogIGxldCBkZXB0aCA9IDAKCiAgaW5kZXggKz0gMQogIHdoaWxlICghKGluZGV4ICYgMSkpIHsKICAgIGRlcHRoKysKICAgIGluZGV4ID0gcmlnaHRTaGlmdChpbmRleCkKICB9CgogIHJldHVybiBkZXB0aAp9CgpleHBvcnRzLnNpYmxpbmcgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkKCiAgcmV0dXJuIGV4cG9ydHMuaW5kZXgoZGVwdGgsIG9mZnNldCAmIDEgPyBvZmZzZXQgLSAxIDogb2Zmc2V0ICsgMSkKfQoKZXhwb3J0cy5wYXJlbnQgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkKCiAgcmV0dXJuIGV4cG9ydHMuaW5kZXgoZGVwdGggKyAxLCByaWdodFNoaWZ0KG9mZnNldCkpCn0KCmV4cG9ydHMubGVmdENoaWxkID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiAtMQogIGlmICghZGVwdGgpIGRlcHRoID0gZXhwb3J0cy5kZXB0aChpbmRleCkKICByZXR1cm4gZXhwb3J0cy5pbmRleChkZXB0aCAtIDEsIGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKiAyKQp9CgpleHBvcnRzLnJpZ2h0Q2hpbGQgPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIC0xCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIHJldHVybiBleHBvcnRzLmluZGV4KGRlcHRoIC0gMSwgMSArIChleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpICogMikpCn0KCmV4cG9ydHMuY2hpbGRyZW4gPSBmdW5jdGlvbiAoaW5kZXgsIGRlcHRoKSB7CiAgaWYgKCEoaW5kZXggJiAxKSkgcmV0dXJuIG51bGwKCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKiAyCgogIHJldHVybiBbCiAgICBleHBvcnRzLmluZGV4KGRlcHRoIC0gMSwgb2Zmc2V0KSwKICAgIGV4cG9ydHMuaW5kZXgoZGVwdGggLSAxLCBvZmZzZXQgKyAxKQogIF0KfQoKZXhwb3J0cy5sZWZ0U3BhbiA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gaW5kZXgKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgcmV0dXJuIGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkgKiB0d29Qb3coZGVwdGggKyAxKQp9CgpleHBvcnRzLnJpZ2h0U3BhbiA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gaW5kZXgKICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCiAgcmV0dXJuIChleHBvcnRzLm9mZnNldChpbmRleCwgZGVwdGgpICsgMSkgKiB0d29Qb3coZGVwdGggKyAxKSAtIDIKfQoKZXhwb3J0cy5uZXh0TGVhZiA9IGZ1bmN0aW9uIChpbmRleCkgewogIGxldCBmYWN0b3IgPSAxCiAgbGV0IHIgPSBpbmRleAoKICB3aGlsZSAoKHIgJiAxKSA9PT0gMSkgewogICAgciA9IChyIC0gMSkgLyAyCiAgICBmYWN0b3IgKj0gMgogIH0KCiAgcmV0dXJuIGluZGV4ICsgZmFjdG9yICsgMQp9CgpleHBvcnRzLmNvdW50ID0gZnVuY3Rpb24gKGluZGV4LCBkZXB0aCkgewogIGlmICghKGluZGV4ICYgMSkpIHJldHVybiAxCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQogIHJldHVybiB0d29Qb3coZGVwdGggKyAxKSAtIDEKfQoKZXhwb3J0cy5jb3VudExlYXZlcyA9IGZ1bmN0aW9uIChpbmRleCkgewogIHJldHVybiAoZXhwb3J0cy5jb3VudChpbmRleCkgKyAxKSAvIDIKfQoKZXhwb3J0cy5zcGFucyA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gW2luZGV4LCBpbmRleF0KICBpZiAoIWRlcHRoKSBkZXB0aCA9IGV4cG9ydHMuZGVwdGgoaW5kZXgpCgogIGNvbnN0IG9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4LCBkZXB0aCkKICBjb25zdCB3aWR0aCA9IHR3b1BvdyhkZXB0aCArIDEpCgogIHJldHVybiBbb2Zmc2V0ICogd2lkdGgsIChvZmZzZXQgKyAxKSAqIHdpZHRoIC0gMl0KfQoKZXhwb3J0cy5pbmRleCA9IGZ1bmN0aW9uIChkZXB0aCwgb2Zmc2V0KSB7CiAgcmV0dXJuICgxICsgMiAqIG9mZnNldCkgKiB0d29Qb3coZGVwdGgpIC0gMQp9CgpleHBvcnRzLm9mZnNldCA9IGZ1bmN0aW9uIChpbmRleCwgZGVwdGgpIHsKICBpZiAoIShpbmRleCAmIDEpKSByZXR1cm4gaW5kZXggLyAyCiAgaWYgKCFkZXB0aCkgZGVwdGggPSBleHBvcnRzLmRlcHRoKGluZGV4KQoKICByZXR1cm4gKChpbmRleCArIDEpIC8gdHdvUG93KGRlcHRoKSAtIDEpIC8gMgp9CgpleHBvcnRzLml0ZXJhdG9yID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgY29uc3QgaXRlID0gbmV3IEl0ZXJhdG9yKCkKICBpdGUuc2VlayhpbmRleCB8fCAwKQogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gdHdvUG93IChuKSB7CiAgcmV0dXJuIG4gPCAzMSA/IDEgPDwgbiA6ICgoMSA8PCAzMCkgKiAoMSA8PCAobiAtIDMwKSkpCn0KCmZ1bmN0aW9uIHJpZ2h0U2hpZnQgKG4pIHsKICByZXR1cm4gKG4gLSAobiAmIDEpKSAvIDIKfQoKZnVuY3Rpb24gSXRlcmF0b3IgKCkgewogIHRoaXMuaW5kZXggPSAwCiAgdGhpcy5vZmZzZXQgPSAwCiAgdGhpcy5mYWN0b3IgPSAwCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5zZWVrID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgdGhpcy5pbmRleCA9IGluZGV4CiAgaWYgKHRoaXMuaW5kZXggJiAxKSB7CiAgICB0aGlzLm9mZnNldCA9IGV4cG9ydHMub2Zmc2V0KGluZGV4KQogICAgdGhpcy5mYWN0b3IgPSB0d29Qb3coZXhwb3J0cy5kZXB0aChpbmRleCkgKyAxKQogIH0gZWxzZSB7CiAgICB0aGlzLm9mZnNldCA9IGluZGV4IC8gMgogICAgdGhpcy5mYWN0b3IgPSAyCiAgfQp9CgpJdGVyYXRvci5wcm90b3R5cGUuaXNMZWZ0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiAodGhpcy5vZmZzZXQgJiAxKSA9PT0gMAp9CgpJdGVyYXRvci5wcm90b3R5cGUuaXNSaWdodCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gKHRoaXMub2Zmc2V0ICYgMSkgPT09IDEKfQoKSXRlcmF0b3IucHJvdG90eXBlLmlzUm9vdCA9IGZ1bmN0aW9uIChsZW5ndGgpIHsKICBjb25zdCBjdXJyZW50TGVuZ3RoID0gMSArICh0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyIC0gMSkgLyAyCiAgaWYgKGxlbmd0aCA8IGN1cnJlbnRMZW5ndGgpIHJldHVybiBmYWxzZQoKICBjb25zdCBmYWN0b3IgPSB0aGlzLmZhY3RvciAqIDIKICBjb25zdCBpbmRleCA9ICh0aGlzLm9mZnNldCAmIDEpCiAgICA/IHRoaXMuaW5kZXggLSB0aGlzLmZhY3RvciAvIDIKICAgIDogdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMgoKICBjb25zdCBwYXJlbnRMZW5ndGggPSAxICsgKGluZGV4ICsgZmFjdG9yIC8gMiAtIDEpIC8gMgogIHJldHVybiBwYXJlbnRMZW5ndGggPiBsZW5ndGgKfQoKSXRlcmF0b3IucHJvdG90eXBlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgcmV0dXJuIGluZGV4ID4gdGhpcy5pbmRleAogICAgPyBpbmRleCA8ICh0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyKQogICAgOiBpbmRleCA8IHRoaXMuaW5kZXgKICAgICAgPyBpbmRleCA+ICh0aGlzLmluZGV4IC0gdGhpcy5mYWN0b3IgLyAyKQogICAgICA6IHRydWUKfQoKSXRlcmF0b3IucHJvdG90eXBlLnByZXYgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKCF0aGlzLm9mZnNldCkgcmV0dXJuIHRoaXMuaW5kZXgKICB0aGlzLm9mZnNldC0tCiAgdGhpcy5pbmRleCAtPSB0aGlzLmZhY3RvcgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKCkgewogIHRoaXMub2Zmc2V0KysKICB0aGlzLmluZGV4ICs9IHRoaXMuZmFjdG9yCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLmNvdW50ID0gZnVuY3Rpb24gKCkgewogIGlmICghKHRoaXMuaW5kZXggJiAxKSkgcmV0dXJuIDEKICByZXR1cm4gdGhpcy5mYWN0b3IgLSAxCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5jb3VudExlYXZlcyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gKHRoaXMuY291bnQoKSArIDEpIC8gMgp9CgpJdGVyYXRvci5wcm90b3R5cGUuc2libGluZyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5pc0xlZnQoKSA/IHRoaXMubmV4dCgpIDogdGhpcy5wcmV2KCkKfQoKSXRlcmF0b3IucHJvdG90eXBlLnBhcmVudCA9IGZ1bmN0aW9uICgpIHsKICBpZiAodGhpcy5vZmZzZXQgJiAxKSB7CiAgICB0aGlzLmluZGV4IC09IHRoaXMuZmFjdG9yIC8gMgogICAgdGhpcy5vZmZzZXQgPSAodGhpcy5vZmZzZXQgLSAxKSAvIDIKICB9IGVsc2UgewogICAgdGhpcy5pbmRleCArPSB0aGlzLmZhY3RvciAvIDIKICAgIHRoaXMub2Zmc2V0IC89IDIKICB9CiAgdGhpcy5mYWN0b3IgKj0gMgogIHJldHVybiB0aGlzLmluZGV4Cn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5sZWZ0U3BhbiA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLmluZGV4ID0gdGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMiArIDEKICB0aGlzLm9mZnNldCA9IHRoaXMuaW5kZXggLyAyCiAgdGhpcy5mYWN0b3IgPSAyCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLnBlZWtMZWZ0U3BhbiA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMiArIDEKfQoKSXRlcmF0b3IucHJvdG90eXBlLnJpZ2h0U3BhbiA9IGZ1bmN0aW9uICgpIHsKICB0aGlzLmluZGV4ID0gdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yIC8gMiAtIDEKICB0aGlzLm9mZnNldCA9IHRoaXMuaW5kZXggLyAyCiAgdGhpcy5mYWN0b3IgPSAyCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLnBlZWtSaWdodFNwYW4gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuaW5kZXggKyB0aGlzLmZhY3RvciAvIDIgLSAxCn0KCkl0ZXJhdG9yLnByb3RvdHlwZS5sZWZ0Q2hpbGQgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKHRoaXMuZmFjdG9yID09PSAyKSByZXR1cm4gdGhpcy5pbmRleAogIHRoaXMuZmFjdG9yIC89IDIKICB0aGlzLmluZGV4IC09IHRoaXMuZmFjdG9yIC8gMgogIHRoaXMub2Zmc2V0ICo9IDIKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUucmlnaHRDaGlsZCA9IGZ1bmN0aW9uICgpIHsKICBpZiAodGhpcy5mYWN0b3IgPT09IDIpIHJldHVybiB0aGlzLmluZGV4CiAgdGhpcy5mYWN0b3IgLz0gMgogIHRoaXMuaW5kZXggKz0gdGhpcy5mYWN0b3IgLyAyCiAgdGhpcy5vZmZzZXQgPSAyICogdGhpcy5vZmZzZXQgKyAxCiAgcmV0dXJuIHRoaXMuaW5kZXgKfQoKSXRlcmF0b3IucHJvdG90eXBlLm5leHRUcmVlID0gZnVuY3Rpb24gKCkgewogIHRoaXMuaW5kZXggPSB0aGlzLmluZGV4ICsgdGhpcy5mYWN0b3IgLyAyICsgMQogIHRoaXMub2Zmc2V0ID0gdGhpcy5pbmRleCAvIDIKICB0aGlzLmZhY3RvciA9IDIKICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUucHJldlRyZWUgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKCF0aGlzLm9mZnNldCkgewogICAgdGhpcy5pbmRleCA9IDAKICAgIHRoaXMuZmFjdG9yID0gMgogIH0gZWxzZSB7CiAgICB0aGlzLmluZGV4ID0gdGhpcy5pbmRleCAtIHRoaXMuZmFjdG9yIC8gMiAtIDEKICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5pbmRleCAvIDIKICAgIHRoaXMuZmFjdG9yID0gMgogIH0KICByZXR1cm4gdGhpcy5pbmRleAp9CgpJdGVyYXRvci5wcm90b3R5cGUuZnVsbFJvb3QgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICBpZiAoaW5kZXggPD0gdGhpcy5pbmRleCB8fCAodGhpcy5pbmRleCAmIDEpID4gMCkgcmV0dXJuIGZhbHNlCiAgd2hpbGUgKGluZGV4ID4gdGhpcy5pbmRleCArIHRoaXMuZmFjdG9yICsgdGhpcy5mYWN0b3IgLyAyKSB7CiAgICB0aGlzLmluZGV4ICs9IHRoaXMuZmFjdG9yIC8gMgogICAgdGhpcy5mYWN0b3IgKj0gMgogICAgdGhpcy5vZmZzZXQgLz0gMgogIH0KICByZXR1cm4gdHJ1ZQp9CnsKICAibmFtZSI6ICJmbGF0LXRyZWUiLAogICJ2ZXJzaW9uIjogIjEuMTMuMCIsCiAgImRlc2NyaXB0aW9uIjogIkEgc2VyaWVzIG9mIGZ1bmN0aW9ucyB0byBtYXAgYSBiaW5hcnkgdHJlZSB0byBhIGxpc3QiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2ZsYXQtdHJlZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvZmxhdC10cmVlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2ZsYXQtdHJlZSIKfQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCgptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUuYWRkb24oJy4nLCBfX2ZpbGVuYW1lKQpjb25zdCB7IGlzV2luZG93cyB9ID0gcmVxdWlyZSgnd2hpY2gtcnVudGltZScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQoKZnVuY3Rpb24gb253b3JrKGVyciwgcmVzdWx0KSB7CiAgaWYgKGVycikgdGhpcy5yZWplY3QoZXJyKQogIGVsc2UgdGhpcy5yZXNvbHZlKHJlc3VsdCkKfQoKZXhwb3J0cy50cnlMb2NrID0gZnVuY3Rpb24gdHJ5TG9jayhmZCwgb2Zmc2V0ID0gMCwgbGVuZ3RoID0gMCwgb3B0cyA9IHt9KSB7CiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdvYmplY3QnKSB7CiAgICBvcHRzID0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgfQoKICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gJ29iamVjdCcpIHsKICAgIG9wdHMgPSBsZW5ndGgKICAgIGxlbmd0aCA9IDAKICB9CgogIGlmICh0eXBlb2Ygb3B0cyAhPT0gJ29iamVjdCcgfHwgb3B0cyA9PT0gbnVsbCkgewogICAgb3B0cyA9IHt9CiAgfQoKICB0cnkgewogICAgYmluZGluZy50cnlMb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCwgb3B0cy5zaGFyZWQgIT09IHRydWUpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBpZiAoZXJyLmNvZGUgPT09ICdFQUdBSU4nKSByZXR1cm4gZmFsc2UKICAgIHRocm93IGVycgogIH0KCiAgcmV0dXJuIHRydWUKfQoKZXhwb3J0cy53YWl0Rm9yTG9jayA9IGZ1bmN0aW9uIHdhaXRGb3JMb2NrKAogIGZkLAogIG9mZnNldCA9IDAsCiAgbGVuZ3RoID0gMCwKICBvcHRzID0ge30KKSB7CiAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdvYmplY3QnKSB7CiAgICBvcHRzID0gb2Zmc2V0CiAgICBvZmZzZXQgPSAwCiAgfQoKICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gJ29iamVjdCcpIHsKICAgIG9wdHMgPSBsZW5ndGgKICAgIGxlbmd0aCA9IDAKICB9CgogIGlmICh0eXBlb2Ygb3B0cyAhPT0gJ29iamVjdCcgfHwgb3B0cyA9PT0gbnVsbCkgewogICAgb3B0cyA9IHt9CiAgfQoKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLndhaXRGb3JMb2NrKAogICAgICBmZCwKICAgICAgb2Zmc2V0LAogICAgICBsZW5ndGgsCiAgICAgIG9wdHMuc2hhcmVkICE9PSB0cnVlLAogICAgICByZXEsCiAgICAgIG9ud29yawogICAgKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMudHJ5RG93bmdyYWRlTG9jayA9IGZ1bmN0aW9uIHRyeURvd25ncmFkZUxvY2soCiAgZmQsCiAgb2Zmc2V0ID0gMCwKICBsZW5ndGggPSAwCikgewogIHRyeSB7CiAgICBiaW5kaW5nLnRyeURvd25ncmFkZUxvY2soZmQsIG9mZnNldCwgbGVuZ3RoKQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyci5jb2RlID09PSAnRUFHQUlOJykgcmV0dXJuIGZhbHNlCiAgICB0aHJvdyBlcnIKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMud2FpdEZvckRvd25ncmFkZUxvY2sgPSBmdW5jdGlvbiBkb3duZ3JhZGVMb2NrKAogIGZkLAogIG9mZnNldCA9IDAsCiAgbGVuZ3RoID0gMAopIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLndhaXRGb3JEb3duZ3JhZGVMb2NrKGZkLCBvZmZzZXQsIGxlbmd0aCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy50cnlVcGdyYWRlTG9jayA9IGZ1bmN0aW9uIHRyeVVwZ3JhZGVMb2NrKGZkLCBvZmZzZXQgPSAwLCBsZW5ndGggPSAwKSB7CiAgdHJ5IHsKICAgIGJpbmRpbmcudHJ5VXBncmFkZUxvY2soZmQsIG9mZnNldCwgbGVuZ3RoKQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyci5jb2RlID09PSAnRUFHQUlOJykgcmV0dXJuIGZhbHNlCiAgICB0aHJvdyBlcnIKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMud2FpdEZvclVwZ3JhZGVMb2NrID0gZnVuY3Rpb24gdXBncmFkZUxvY2soZmQsIG9mZnNldCA9IDAsIGxlbmd0aCA9IDApIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLndhaXRGb3JVcGdyYWRlTG9jayhmZCwgb2Zmc2V0LCBsZW5ndGgsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMudW5sb2NrID0gZnVuY3Rpb24gdW5sb2NrKGZkLCBvZmZzZXQgPSAwLCBsZW5ndGggPSAwKSB7CiAgYmluZGluZy51bmxvY2soZmQsIG9mZnNldCwgbGVuZ3RoKQp9CgpleHBvcnRzLnRyaW0gPSBmdW5jdGlvbiB0cmltKGZkLCBvZmZzZXQsIGxlbmd0aCkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcudHJpbShmZCwgb2Zmc2V0LCBsZW5ndGgsIHJlcSwgb253b3JrKQogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycikKICB9CgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuc3BhcnNlID0gZnVuY3Rpb24gc3BhcnNlKGZkKSB7CiAgLy8gU2hvcnQgY2lyY3VpdCBvbiBldmVyeXRoaW5nIGJ1dCBXaW5kb3dzCiAgaWYgKCFpc1dpbmRvd3MpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQoKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnNwYXJzZShmZCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5zd2FwID0gZnVuY3Rpb24gc3dhcChmcm9tLCB0bykgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuc3dhcChmcm9tLCB0bywgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5nZXRBdHRyID0gZnVuY3Rpb24gZ2V0QXR0cihmZCwgbmFtZSkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuZ2V0QXR0cihmZCwgbmFtZSwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UudGhlbigoYnVmZmVyKSA9PgogICAgYnVmZmVyID09PSBudWxsID8gbnVsbCA6IEJ1ZmZlci5mcm9tKGJ1ZmZlcikKICApCn0KCmV4cG9ydHMuc2V0QXR0ciA9IGZ1bmN0aW9uIHNldEF0dHIoZmQsIG5hbWUsIHZhbHVlLCBlbmNvZGluZykgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB2YWx1ZSA9IEJ1ZmZlci5mcm9tKHZhbHVlLCBlbmNvZGluZykKCiAgY29uc3QgcmVxID0gewogICAgdmFsdWUsCiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLnNldEF0dHIoCiAgICAgIGZkLAogICAgICBuYW1lLAogICAgICB2YWx1ZS5idWZmZXIsCiAgICAgIHZhbHVlLmJ5dGVPZmZzZXQsCiAgICAgIHZhbHVlLmJ5dGVMZW5ndGgsCiAgICAgIHJlcSwKICAgICAgb253b3JrCiAgICApCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5yZW1vdmVBdHRyID0gZnVuY3Rpb24gcmVtb3ZlQXR0cihmZCwgbmFtZSkgewogIGNvbnN0IHJlcSA9IHsKICAgIGhhbmRsZTogbnVsbCwKICAgIHJlc29sdmU6IG51bGwsCiAgICByZWplY3Q6IG51bGwKICB9CgogIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgIHJlcS5yZWplY3QgPSByZWplY3QKICB9KQoKICB0cnkgewogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcucmVtb3ZlQXR0cihmZCwgbmFtZSwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5saXN0QXR0cnMgPSBmdW5jdGlvbiBsaXN0QXR0cnMoZmQpIHsKICBjb25zdCByZXEgPSB7CiAgICBoYW5kbGU6IG51bGwsCiAgICByZXNvbHZlOiBudWxsLAogICAgcmVqZWN0OiBudWxsCiAgfQoKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgfSkKCiAgdHJ5IHsKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmxpc3RBdHRycyhmZCwgcmVxLCBvbndvcmspCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKQogIH0KCiAgcmV0dXJuIHByb21pc2UKfQp7CiAgIm5hbWUiOiAiZnMtbmF0aXZlLWV4dGVuc2lvbnMiLAogICJ2ZXJzaW9uIjogIjEuNC41IiwKICAiZGVzY3JpcHRpb24iOiAiTmF0aXZlIGZpbGUgc3lzdGVtIGV4dGVuc2lvbnMgZm9yIGFkdmFuY2VkIGZpbGUgb3BlcmF0aW9ucyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibWFjcm9zLmgiLAogICAgImJpbmRpbmcuYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImluY2x1ZGUiLAogICAgInNyYyIsCiAgICAicHJlYnVpbGRzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiY2hpbGRfcHJvY2VzcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1zdWJwcm9jZXNzIiwKICAgICAgImRlZmF1bHQiOiAiY2hpbGRfcHJvY2VzcyIKICAgIH0sCiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAiZnMvKiI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcy8qIiwKICAgICAgImRlZmF1bHQiOiAiZnMvKiIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0KICB9LAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QuanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QuanMiLAogICAgImxpbnQiOiAicHJldHRpZXIgLiAtLWNoZWNrIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZzLW5hdGl2ZS1leHRlbnNpb25zLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9mcy1uYXRpdmUtZXh0ZW5zaW9ucy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2ZzLW5hdGl2ZS1leHRlbnNpb25zI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjEuMCIsCiAgICAid2hpY2gtcnVudGltZSI6ICJeMS4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy44IiwKICAgICJiYXJlLWZzIjogIl40LjQuNCIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiYmFyZS1zdWJwcm9jZXNzIjogIl40LjAuNSIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS4xMCIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuNC43IiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjAuNSIsCiAgICAiY21ha2UtbnBtIjogIl4xLjEuMCIsCiAgICAibWluaW1pc3QiOiAiXjEuMi42IiwKICAgICJwcmV0dGllciI6ICJeMy41LjMiLAogICAgInByZXR0aWVyLWNvbmZpZy1zdGFuZGFyZCI6ICJeNy4wLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjIuMSIKICB9Cn0KY29uc3QgY29kZWNzID0gcmVxdWlyZSgnY29kZWNzJykKY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IG11dGV4aWZ5ID0gcmVxdWlyZSgnbXV0ZXhpZnkvcHJvbWlzZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgUmVhZHlSZXNvdXJjZSA9IHJlcXVpcmUoJ3JlYWR5LXJlc291cmNlJykKY29uc3QgZGVib3VuY2UgPSByZXF1aXJlKCdkZWJvdW5jZWlmeScpCmNvbnN0IFJhY2hlID0gcmVxdWlyZSgncmFjaGUnKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKCmNvbnN0IHsgYWxsOiB1bnNsYWJBbGwgfSA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBSYW5nZUl0ZXJhdG9yID0gcmVxdWlyZSgnLi9pdGVyYXRvcnMvcmFuZ2UnKQpjb25zdCBIaXN0b3J5SXRlcmF0b3IgPSByZXF1aXJlKCcuL2l0ZXJhdG9ycy9oaXN0b3J5JykKY29uc3QgRGlmZkl0ZXJhdG9yID0gcmVxdWlyZSgnLi9pdGVyYXRvcnMvZGlmZicpCmNvbnN0IExvY2FsQmxvY2tJdGVyYXRvciA9IHJlcXVpcmUoJy4vaXRlcmF0b3JzL2xvY2FsJykKY29uc3QgRXh0ZW5zaW9uID0gcmVxdWlyZSgnLi9saWIvZXh0ZW5zaW9uJykKY29uc3QgeyBZb2xvSW5kZXgsIE5vZGUsIEhlYWRlciB9ID0gcmVxdWlyZSgnLi9saWIvbWVzc2FnZXMnKQpjb25zdCB7IEJMT0NLX05PVF9BVkFJTEFCTEUsIERFQ09ESU5HX0VSUk9SIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKCmNvbnN0IFQgPSA1CmNvbnN0IE1JTl9LRVlTID0gVCAtIDEKY29uc3QgTUFYX0NISUxEUkVOID0gTUlOX0tFWVMgKiAyICsgMQoKY29uc3QgU0VQID0gYjRhLmFsbG9jKDEpCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgpjbGFzcyBLZXkgewogIGNvbnN0cnVjdG9yIChzZXEsIHZhbHVlKSB7CiAgICB0aGlzLnNlcSA9IHNlcQogICAgdGhpcy52YWx1ZSA9IHZhbHVlCiAgfQp9CgpjbGFzcyBDaGlsZCB7CiAgY29uc3RydWN0b3IgKHNlcSwgb2Zmc2V0LCB2YWx1ZSkgewogICAgdGhpcy5zZXEgPSBzZXEKICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0CiAgICB0aGlzLnZhbHVlID0gdmFsdWUKICB9Cn0KCmNsYXNzIENhY2hlIHsKICBjb25zdHJ1Y3RvciAocmFjaGUpIHsKICAgIHRoaXMua2V5cyA9IHJhY2hlCiAgICB0aGlzLmxlbmd0aCA9IDAKICB9CgogIGdldCAoc2VxKSB7CiAgICByZXR1cm4gdGhpcy5rZXlzLmdldChzZXEpIHx8IG51bGwKICB9CgogIHNldCAoc2VxLCBrZXkpIHsKICAgIHRoaXMua2V5cy5zZXQoc2VxLCBrZXkpCiAgICBpZiAoc2VxID49IHRoaXMubGVuZ3RoKSB0aGlzLmxlbmd0aCA9IHNlcSArIDEKICB9CgogIGdjIChsZW5ndGgpIHsKICAgIC8vIGlmIHdlIG5lZWQgdG8gIndvcmsiIG1vcmUgdGhhbiAxMjggdGlja3MsIGp1c3QgYnVzdCB0aGUgY2FjaGUuLi4KICAgIGlmICh0aGlzLmxlbmd0aCAtIGxlbmd0aCA+IDEyOCkgewogICAgICB0aGlzLmtleXMuY2xlYXIoKQogICAgfSBlbHNlIHsKICAgICAgZm9yIChsZXQgaSA9IGxlbmd0aDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmtleXMuZGVsZXRlKGkpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy5rZXlzLmNsZWFyKCkKICB9Cn0KCmNsYXNzIFBvaW50ZXJzIHsKICBjb25zdHJ1Y3RvciAoZGVjb2RlZCkgewogICAgdGhpcy5sZXZlbHMgPSBkZWNvZGVkLmxldmVscy5tYXAobCA9PiB7CiAgICAgIGNvbnN0IGNoaWxkcmVuID0gW10KICAgICAgY29uc3Qga2V5cyA9IFtdCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGtleXMucHVzaChuZXcgS2V5KGwua2V5c1tpXSwgbnVsbCkpCiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbC5jaGlsZHJlbi5sZW5ndGg7IGkgKz0gMikgewogICAgICAgIGNoaWxkcmVuLnB1c2gobmV3IENoaWxkKGwuY2hpbGRyZW5baV0sIGwuY2hpbGRyZW5baSArIDFdLCBudWxsKSkKICAgICAgfQoKICAgICAgcmV0dXJuIHsga2V5cywgY2hpbGRyZW4gfQogICAgfSkKICB9CgogIGdldCAoaSkgewogICAgcmV0dXJuIHRoaXMubGV2ZWxzW2ldCiAgfQoKICBoYXNLZXkgKHNlcSkgewogICAgZm9yIChjb25zdCBsdmwgb2YgdGhpcy5sZXZlbHMpIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2YgbHZsLmtleXMpIHsKICAgICAgICBpZiAoa2V5LnNlcSA9PT0gc2VxKSByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmZ1bmN0aW9uIGluZmxhdGUgKGVudHJ5KSB7CiAgaWYgKGVudHJ5LmluZmxhdGVkID09PSBudWxsKSB7CiAgICBlbnRyeS5pbmZsYXRlZCA9IFlvbG9JbmRleC5kZWNvZGUoZW50cnkuaW5kZXgpCiAgICBlbnRyeS5pbmRleCA9IG51bGwKICB9CiAgcmV0dXJuIG5ldyBQb2ludGVycyhlbnRyeS5pbmZsYXRlZCkKfQoKZnVuY3Rpb24gZGVmbGF0ZSAoaW5kZXgpIHsKICBjb25zdCBsZXZlbHMgPSBpbmRleC5tYXAobCA9PiB7CiAgICBjb25zdCBrZXlzID0gW10KICAgIGNvbnN0IGNoaWxkcmVuID0gW10KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwudmFsdWUua2V5cy5sZW5ndGg7IGkrKykgewogICAgICBrZXlzLnB1c2gobC52YWx1ZS5rZXlzW2ldLnNlcSkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGwudmFsdWUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgY2hpbGRyZW4ucHVzaChsLnZhbHVlLmNoaWxkcmVuW2ldLnNlcSwgbC52YWx1ZS5jaGlsZHJlbltpXS5vZmZzZXQpCiAgICB9CgogICAgcmV0dXJuIHsga2V5cywgY2hpbGRyZW4gfQogIH0pCgogIHJldHVybiBZb2xvSW5kZXguZW5jb2RlKHsgbGV2ZWxzIH0pCn0KCmNsYXNzIFRyZWVOb2RlIHsKICBjb25zdHJ1Y3RvciAoYmxvY2ssIGtleXMsIGNoaWxkcmVuLCBvZmZzZXQpIHsKICAgIHRoaXMuYmxvY2sgPSBibG9jawogICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQKICAgIHRoaXMua2V5cyA9IGtleXMKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbgogICAgdGhpcy5jaGFuZ2VkID0gZmFsc2UKCiAgICB0aGlzLnByZWxvYWQoKQogIH0KCiAgcHJlbG9hZCAoKSB7CiAgICBpZiAodGhpcy5ibG9jayA9PT0gbnVsbCkgcmV0dXJuCgogICAgY29uc3QgY29yZSA9IGdldEJhY2tpbmdDb3JlKHRoaXMuYmxvY2sudHJlZS5jb3JlKQogICAgaWYgKCFjb3JlKSByZXR1cm4KCiAgICBjb25zdCBiaXRmaWVsZCA9IGNvcmUuY29yZS5iaXRmaWVsZAogICAgY29uc3QgYmxvY2tzID0gW10KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMua2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBrID0gdGhpcy5rZXlzW2ldCiAgICAgIGlmIChrLnZhbHVlKSBjb250aW51ZQogICAgICBpZiAoay5zZXEgPj0gY29yZS5zaWduZWRMZW5ndGggfHwgKGJpdGZpZWxkICYmIGJpdGZpZWxkLmdldChrLnNlcSkpKSBjb250aW51ZQogICAgICBibG9ja3MucHVzaChrLnNlcSkKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjID0gdGhpcy5jaGlsZHJlbltpXQogICAgICBpZiAoYy52YWx1ZSkgY29udGludWUKICAgICAgaWYgKGMuc2VxID49IGNvcmUuc2lnbmVkTGVuZ3RoIHx8IChiaXRmaWVsZCAmJiBiaXRmaWVsZC5nZXQoYy5zZXEpKSkgY29udGludWUKICAgICAgYmxvY2tzLnB1c2goYy5zZXEpCiAgICB9CgogICAgaWYgKGJsb2Nrcy5sZW5ndGgpIGNvcmUuZG93bmxvYWQoeyBibG9ja3MgfSkKICB9CgogIGFzeW5jIGluc2VydEtleSAoa2V5LCB2YWx1ZSwgY2hpbGQsIG5vZGUsIGVuY29kaW5nLCBjYXMpIHsKICAgIGxldCBzID0gMAogICAgbGV0IGUgPSB0aGlzLmtleXMubGVuZ3RoCiAgICBsZXQgYwoKICAgIHdoaWxlIChzIDwgZSkgewogICAgICBjb25zdCBtaWQgPSAocyArIGUpID4+IDEKICAgICAgYyA9IGI0YS5jb21wYXJlKGtleS52YWx1ZSwgYXdhaXQgdGhpcy5nZXRLZXkobWlkKSkKCiAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgaWYgKGNhcykgewogICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IHRoaXMuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICBpZiAoIShhd2FpdCBjYXMocHJldi5maW5hbChlbmNvZGluZyksIG5vZGUpKSkgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmJsb2NrLnRyZWUudHJlZS5hbHdheXNEdXBsaWNhdGUpIHsKICAgICAgICAgIGNvbnN0IHByZXYgPSBhd2FpdCB0aGlzLmdldEtleU5vZGUobWlkKQogICAgICAgICAgaWYgKHNhbWVWYWx1ZShwcmV2LnZhbHVlLCB2YWx1ZSkpIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKICAgICAgICB0aGlzLmtleXNbbWlkXSA9IGtleQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICB9CgogICAgY29uc3QgaSA9IGMgPCAwID8gZSA6IHMKICAgIHRoaXMua2V5cy5zcGxpY2UoaSwgMCwga2V5KQogICAgaWYgKGNoaWxkKSB0aGlzLmNoaWxkcmVuLnNwbGljZShpICsgMSwgMCwgbmV3IENoaWxkKDAsIDAsIGNoaWxkKSkKICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKCiAgICByZXR1cm4gdGhpcy5rZXlzLmxlbmd0aCA8IE1BWF9DSElMRFJFTgogIH0KCiAgcmVtb3ZlS2V5IChpbmRleCkgewogICAgdGhpcy5rZXlzLnNwbGljZShpbmRleCwgMSkKICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICB0aGlzLmNoaWxkcmVuW2luZGV4ICsgMV0uc2VxID0gMCAvLyBtYXJrIGFzIGZyZWVkCiAgICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGluZGV4ICsgMSwgMSkKICAgIH0KICAgIHRoaXMuY2hhbmdlZCA9IHRydWUKICB9CgogIGFzeW5jIHNpYmxpbmdzIChwYXJlbnQpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyZW50LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChwYXJlbnQuY2hpbGRyZW5baV0udmFsdWUgPT09IHRoaXMpIHsKICAgICAgICBjb25zdCBbbGVmdCwgcmlnaHRdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICAgICAgaSA/IHBhcmVudC5nZXRDaGlsZE5vZGUoaSAtIDEpIDogbnVsbCwKICAgICAgICAgIGkgPCBwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoIC0gMSA/IHBhcmVudC5nZXRDaGlsZE5vZGUoaSArIDEpIDogbnVsbAogICAgICAgIF0pCiAgICAgICAgcmV0dXJuIHsgbGVmdCwgaW5kZXg6IGksIHJpZ2h0IH0KICAgICAgfQogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignQmFkIHBhcmVudCcpCiAgfQoKICBtZXJnZSAobm9kZSwgbWVkaWFuKSB7CiAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCiAgICB0aGlzLmtleXMucHVzaChtZWRpYW4pCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUua2V5cy5sZW5ndGg7IGkrKykgdGhpcy5rZXlzLnB1c2gobm9kZS5rZXlzW2ldKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB0aGlzLmNoaWxkcmVuLnB1c2gobm9kZS5jaGlsZHJlbltpXSkKICB9CgogIGFzeW5jIHNwbGl0ICgpIHsKICAgIGNvbnN0IGxlbiA9IHRoaXMua2V5cy5sZW5ndGggPj4gMQogICAgY29uc3QgcmlnaHQgPSBUcmVlTm9kZS5jcmVhdGUodGhpcy5ibG9jaykKCiAgICB3aGlsZSAocmlnaHQua2V5cy5sZW5ndGggPCBsZW4pIHJpZ2h0LmtleXMucHVzaCh0aGlzLmtleXMucG9wKCkpCiAgICByaWdodC5rZXlzLnJldmVyc2UoKQoKICAgIGF3YWl0IHRoaXMuZ2V0S2V5KHRoaXMua2V5cy5sZW5ndGggLSAxKSAvLyBtYWtlIHN1cmUgdGhlIG1lZGlhbiBpcyBsb2FkZWQKICAgIGNvbnN0IG1lZGlhbiA9IHRoaXMua2V5cy5wb3AoKQoKICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICB3aGlsZSAocmlnaHQuY2hpbGRyZW4ubGVuZ3RoIDwgbGVuICsgMSkgcmlnaHQuY2hpbGRyZW4ucHVzaCh0aGlzLmNoaWxkcmVuLnBvcCgpKQogICAgICByaWdodC5jaGlsZHJlbi5yZXZlcnNlKCkKICAgIH0KCiAgICB0aGlzLmNoYW5nZWQgPSB0cnVlCgogICAgcmV0dXJuIHsKICAgICAgbGVmdDogdGhpcywKICAgICAgbWVkaWFuLAogICAgICByaWdodAogICAgfQogIH0KCiAgZ2V0S2V5Tm9kZSAoaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLmJsb2NrLnRyZWUuZ2V0QmxvY2sodGhpcy5rZXlzW2luZGV4XS5zZXEpCiAgfQoKICBhc3luYyBnZXRDaGlsZE5vZGUgKGluZGV4KSB7CiAgICBjb25zdCBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baW5kZXhdCiAgICBpZiAoY2hpbGQudmFsdWUpIHJldHVybiBjaGlsZC52YWx1ZQogICAgY29uc3QgYmxvY2sgPSBjaGlsZC5zZXEgPT09IHRoaXMuYmxvY2suc2VxID8gdGhpcy5ibG9jayA6IGF3YWl0IHRoaXMuYmxvY2sudHJlZS5nZXRCbG9jayhjaGlsZC5zZXEpCiAgICByZXR1cm4gKGNoaWxkLnZhbHVlID0gYmxvY2suZ2V0VHJlZU5vZGUoY2hpbGQub2Zmc2V0KSkKICB9CgogIHNldEtleSAoaW5kZXgsIGtleSkgewogICAgdGhpcy5rZXlzW2luZGV4XSA9IGtleQogICAgdGhpcy5jaGFuZ2VkID0gdHJ1ZQogIH0KCiAgYXN5bmMgZ2V0S2V5IChpbmRleCkgewogICAgY29uc3Qga2V5ID0gdGhpcy5rZXlzW2luZGV4XQogICAgaWYgKGtleS52YWx1ZSkgcmV0dXJuIGtleS52YWx1ZQogICAgY29uc3QgayA9IGtleS5zZXEgPT09IHRoaXMuYmxvY2suc2VxID8gdGhpcy5ibG9jay5rZXkgOiBhd2FpdCB0aGlzLmJsb2NrLnRyZWUuZ2V0S2V5KGtleS5zZXEpCiAgICByZXR1cm4gKGtleS52YWx1ZSA9IGspCiAgfQoKICBpbmRleENoYW5nZXMgKGluZGV4LCBzZXEpIHsKICAgIGNvbnN0IG9mZnNldCA9IGluZGV4LnB1c2gobnVsbCkgLSAxCiAgICB0aGlzLmNoYW5nZWQgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikgewogICAgICBpZiAoIWNoaWxkLnZhbHVlIHx8ICFjaGlsZC52YWx1ZS5jaGFuZ2VkKSBjb250aW51ZQogICAgICBjaGlsZC5zZXEgPSBzZXEKICAgICAgY2hpbGQub2Zmc2V0ID0gY2hpbGQudmFsdWUuaW5kZXhDaGFuZ2VzKGluZGV4LCBzZXEpCiAgICAgIGluZGV4W2NoaWxkLm9mZnNldF0gPSBjaGlsZAogICAgfQoKICAgIHJldHVybiBvZmZzZXQKICB9CgogIHVwZGF0ZUNoaWxkcmVuIChzZXEsIGJsb2NrKSB7CiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHsKICAgICAgaWYgKCFjaGlsZC52YWx1ZSB8fCBjaGlsZC5zZXEgIT09IHNlcSkgY29udGludWUKICAgICAgY2hpbGQudmFsdWUuYmxvY2sgPSBibG9jawogICAgICBjaGlsZC52YWx1ZS51cGRhdGVDaGlsZHJlbihzZXEsIGJsb2NrKQogICAgfQogIH0KCiAgc3RhdGljIGNyZWF0ZSAoYmxvY2spIHsKICAgIGNvbnN0IG5vZGUgPSBuZXcgVHJlZU5vZGUoYmxvY2ssIFtdLCBbXSwgMCkKICAgIG5vZGUuY2hhbmdlZCA9IHRydWUKICAgIHJldHVybiBub2RlCiAgfQp9CgpjbGFzcyBCbG9ja0VudHJ5IHsKICBjb25zdHJ1Y3RvciAoc2VxLCB0cmVlLCBlbnRyeSkgewogICAgdGhpcy5zZXEgPSBzZXEKICAgIHRoaXMudHJlZSA9IHRyZWUKICAgIHRoaXMuaW5kZXggPSBudWxsCiAgICB0aGlzLmVudHJ5ID0gZW50cnkKICAgIHRoaXMua2V5ID0gZW50cnkua2V5CiAgICB0aGlzLnZhbHVlID0gZW50cnkudmFsdWUKICB9CgogIGlzVGFyZ2V0IChrZXkpIHsKICAgIHJldHVybiBiNGEuZXF1YWxzKHRoaXMua2V5LCBrZXkpCiAgfQoKICBpbmZsYXRlICgpIHsKICAgIGlmICh0aGlzLmluZGV4ID09PSBudWxsKSB7CiAgICAgIHRoaXMuaW5kZXggPSBpbmZsYXRlKHRoaXMuZW50cnkpCiAgICB9CiAgfQoKICBpc0RlbGV0aW9uICgpIHsKICAgIGlmICh0aGlzLnZhbHVlICE9PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy5pbmRleCA9PT0gbnVsbCkgewogICAgICB0aGlzLmluZGV4ID0gaW5mbGF0ZSh0aGlzLmVudHJ5KQogICAgfQoKICAgIHJldHVybiAhdGhpcy5pbmRleC5oYXNLZXkodGhpcy5zZXEpCiAgfQoKICBmaW5hbCAoZW5jb2RpbmcpIHsKICAgIHJldHVybiB7CiAgICAgIHNlcTogdGhpcy5zZXEsCiAgICAgIGtleTogZW5jb2Rpbmcua2V5ID8gZW5jb2Rpbmcua2V5LmRlY29kZSh0aGlzLmtleSkgOiB0aGlzLmtleSwKICAgICAgdmFsdWU6IHRoaXMudmFsdWUgJiYgKGVuY29kaW5nLnZhbHVlID8gZW5jb2RpbmcudmFsdWUuZGVjb2RlKHRoaXMudmFsdWUpIDogdGhpcy52YWx1ZSkKICAgIH0KICB9CgogIGdldFRyZWVOb2RlIChvZmZzZXQpIHsKICAgIGlmICh0aGlzLmluZGV4ID09PSBudWxsKSB7CiAgICAgIHRoaXMuaW5kZXggPSBpbmZsYXRlKHRoaXMuZW50cnkpCiAgICB9CiAgICBjb25zdCBlbnRyeSA9IHRoaXMuaW5kZXguZ2V0KG9mZnNldCkKICAgIHJldHVybiBuZXcgVHJlZU5vZGUodGhpcywgZW50cnkua2V5cywgZW50cnkuY2hpbGRyZW4sIG9mZnNldCkKICB9Cn0KCmNsYXNzIENhY2hlTG9jayB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5tYXAgPSBuZXcgTWFwKCkKICB9CgogIGVudGVyIChzZXEpIHsKICAgIGNvbnN0IHBlbmRpbmcgPSB0aGlzLm1hcC5nZXQoc2VxKQoKICAgIGlmICghcGVuZGluZykgewogICAgICB0aGlzLm1hcC5zZXQoc2VxLCBbXSkKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCiAgICB9CgogICAgY29uc3QgeyByZXNvbHZlLCBwcm9taXNlIH0gPSBycnAoKQogICAgcGVuZGluZy5wdXNoKHJlc29sdmUpCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgZXhpdCAoc2VxKSB7CiAgICBjb25zdCBwZW5kaW5nID0gdGhpcy5tYXAuZ2V0KHNlcSkKICAgIGlmICghcGVuZGluZy5sZW5ndGgpIHsKICAgICAgdGhpcy5tYXAuZGVsZXRlKHNlcSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgcGVuZGluZy5wb3AoKSgpCiAgfQp9CgpjbGFzcyBCYXRjaEVudHJ5IGV4dGVuZHMgQmxvY2tFbnRyeSB7CiAgY29uc3RydWN0b3IgKHNlcSwgdHJlZSwga2V5LCB2YWx1ZSwgaW5kZXgpIHsKICAgIHN1cGVyKHNlcSwgdHJlZSwgeyBrZXksIHZhbHVlLCBpbmRleDogbnVsbCwgaW5mbGF0ZWQ6IG51bGwgfSkKICAgIHRoaXMucGVuZGluZ0luZGV4ID0gaW5kZXgKICB9CgogIGlzVGFyZ2V0IChrZXkpIHsKICAgIHJldHVybiBmYWxzZQogIH0KCiAgZ2V0VHJlZU5vZGUgKG9mZnNldCkgewogICAgcmV0dXJuIHRoaXMucGVuZGluZ0luZGV4W29mZnNldF0udmFsdWUKICB9Cn0KCmNsYXNzIEh5cGVyYmVlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IgKGNvcmUsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQogICAgLy8gdGhpcy5mZWVkIGlzIG5vdyBkZXByZWNhdGVkLCBhbmQgd2lsbCBiZSB0aGlzLmNvcmUgZ29pbmcgZm9yd2FyZAogICAgdGhpcy5mZWVkID0gY29yZQogICAgdGhpcy5jb3JlID0gY29yZQoKICAgIHRoaXMua2V5RW5jb2RpbmcgPSBvcHRzLmtleUVuY29kaW5nID8gY29kZWNzKG9wdHMua2V5RW5jb2RpbmcpIDogbnVsbAogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gb3B0cy52YWx1ZUVuY29kaW5nID8gY29kZWNzKG9wdHMudmFsdWVFbmNvZGluZykgOiBudWxsCiAgICB0aGlzLmV4dGVuc2lvbiA9IG9wdHMuZXh0ZW5zaW9uICE9PSBmYWxzZSA/IGdldEV4dGVuc2lvbih0aGlzLCBvcHRzKSA6IG51bGwKICAgIHRoaXMubWV0YWRhdGEgPSBvcHRzLm1ldGFkYXRhIHx8IG51bGwKICAgIHRoaXMubG9jayA9IG9wdHMubG9jayB8fCBtdXRleGlmeSgpCiAgICB0aGlzLnNlcCA9IG9wdHMuc2VwIHx8IFNFUAogICAgdGhpcy5yZWFkb25seSA9ICEhb3B0cy5yZWFkb25seQogICAgdGhpcy5wcmVmaXggPSBvcHRzLnByZWZpeCB8fCBudWxsCgogICAgLy8gSW4gYSBmdXR1cmUgdmVyc2lvbiwgdGhpcyBzaG91bGQgYmUgZmFsc2UgYnkgZGVmYXVsdAogICAgdGhpcy5hbHdheXNEdXBsaWNhdGUgPSBvcHRzLmFsd2F5c0R1cGxpY2F0ZSAhPT0gZmFsc2UKCiAgICB0aGlzLl91bnByZWZpeGVkS2V5RW5jb2RpbmcgPSB0aGlzLmtleUVuY29kaW5nCiAgICB0aGlzLl9zdWIgPSAhIXRoaXMucHJlZml4CiAgICB0aGlzLl9jaGVja291dCA9IG9wdHMuY2hlY2tvdXQgfHwgMAogICAgdGhpcy5fdmlldyA9ICEhb3B0cy5fdmlldwoKICAgIHRoaXMuX29uYXBwZW5kQm91bmQgPSB0aGlzLl92aWV3ID8gbnVsbCA6IHRoaXMuX29uYXBwZW5kLmJpbmQodGhpcykKICAgIHRoaXMuX29udHJ1bmNhdGVCb3VuZCA9IHRoaXMuX3ZpZXcgPyBudWxsIDogdGhpcy5fb250cnVuY2F0ZS5iaW5kKHRoaXMpCiAgICB0aGlzLl93YXRjaGVycyA9IHRoaXMuX29uYXBwZW5kQm91bmQgPyBbXSA6IG51bGwKICAgIHRoaXMuX2VudHJ5V2F0Y2hlcnMgPSB0aGlzLl9vbmFwcGVuZEJvdW5kID8gW10gOiBudWxsCiAgICB0aGlzLl9zZXNzaW9ucyA9IG9wdHMuc2Vzc2lvbnMgIT09IGZhbHNlCgogICAgdGhpcy5fa2V5Q2FjaGUgPSBudWxsCiAgICB0aGlzLl9ub2RlQ2FjaGUgPSBudWxsCiAgICB0aGlzLl9jYWNoZUxvY2sgPSBuZXcgQ2FjaGVMb2NrKCkKCiAgICB0aGlzLl9iYXRjaGVzID0gW10KCiAgICBpZiAodGhpcy5fd2F0Y2hlcnMpIHsKICAgICAgdGhpcy5jb3JlLm9uKCdhcHBlbmQnLCB0aGlzLl9vbmFwcGVuZEJvdW5kKQogICAgICB0aGlzLmNvcmUub24oJ3RydW5jYXRlJywgdGhpcy5fb250cnVuY2F0ZUJvdW5kKQogICAgfQoKICAgIGlmICh0aGlzLnByZWZpeCAmJiBvcHRzLl9zdWIpIHsKICAgICAgdGhpcy5rZXlFbmNvZGluZyA9IHByZWZpeEVuY29kaW5nKHRoaXMucHJlZml4LCB0aGlzLmtleUVuY29kaW5nKQogICAgfQoKICAgIHRoaXMucmVhZHkoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIGFzeW5jIF9vcGVuICgpIHsKICAgIGlmICh0aGlzLmNvcmUub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5jb3JlLnJlYWR5KCkKCiAgICAvLyBzbmFwc2hvdAogICAgaWYgKHRoaXMuX2NoZWNrb3V0ID09PSAtMSkgdGhpcy5fY2hlY2tvdXQgPSBNYXRoLm1heCgxLCB0aGlzLmNvcmUubGVuZ3RoKQoKICAgIGNvbnN0IGJhc2VDYWNoZSA9IFJhY2hlLmZyb20odGhpcy5jb3JlLmdsb2JhbENhY2hlKQogICAgdGhpcy5fa2V5Q2FjaGUgPSBuZXcgQ2FjaGUoYmFzZUNhY2hlKQogICAgdGhpcy5fbm9kZUNhY2hlID0gbmV3IENhY2hlKFJhY2hlLmZyb20oYmFzZUNhY2hlKSkKICB9CgogIGdldCB2ZXJzaW9uICgpIHsKICAgIHJldHVybiBNYXRoLm1heCgxLCB0aGlzLl9jaGVja291dCB8fCB0aGlzLmNvcmUubGVuZ3RoKQogIH0KCiAgZ2V0IGlkICgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuaWQKICB9CgogIGdldCBrZXkgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5rZXkKICB9CgogIGdldCBkaXNjb3ZlcnlLZXkgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkKICB9CgogIGdldCB3cml0YWJsZSAoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLndyaXRhYmxlCiAgfQoKICBnZXQgcmVhZGFibGUgKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5yZWFkYWJsZQogIH0KCiAgcmVwbGljYXRlIChpc0luaXRpYXRvciwgb3B0cykgewogICAgcmV0dXJuIHRoaXMuY29yZS5yZXBsaWNhdGUoaXNJbml0aWF0b3IsIG9wdHMpCiAgfQoKICB1cGRhdGUgKG9wdHMpIHsKICAgIHJldHVybiB0aGlzLmNvcmUudXBkYXRlKG9wdHMpCiAgfQoKICBwZWVrIChyYW5nZSwgb3B0cykgewogICAgcmV0dXJuIGl0ZXJhdG9yUGVlayh0aGlzLmNyZWF0ZVJhbmdlSXRlcmF0b3IocmFuZ2UsIHsgLi4ub3B0cywgbGltaXQ6IDEgfSkpCiAgfQoKICBjcmVhdGVSYW5nZUl0ZXJhdG9yIChyYW5nZSwgb3B0cyA9IHt9KSB7CiAgICAvLyBiYWNrd2FyZHMgY29tcGF0IHJhbmdlIGFyZwogICAgb3B0cyA9IG9wdHMgPyB7IC4uLm9wdHMsIC4uLnJhbmdlIH0gOiByYW5nZQoKICAgIGNvbnN0IGV4dGVuc2lvbiA9IChvcHRzLmV4dGVuc2lvbiA9PT0gZmFsc2UgJiYgb3B0cy5saW1pdCAhPT0gMCkgPyBudWxsIDogdGhpcy5leHRlbnNpb24KICAgIGNvbnN0IGtleUVuY29kaW5nID0gb3B0cy5rZXlFbmNvZGluZyA/IGNvZGVjcyhvcHRzLmtleUVuY29kaW5nKSA6IHRoaXMua2V5RW5jb2RpbmcKCiAgICBpZiAoZXh0ZW5zaW9uKSB7CiAgICAgIGNvbnN0IHsgb25zZXEsIG9ud2FpdCB9ID0gb3B0cwogICAgICBsZXQgdmVyc2lvbiA9IDAKICAgICAgbGV0IG5leHQgPSAwCgogICAgICBvcHRzID0gZW5jUmFuZ2Uoa2V5RW5jb2RpbmcsIHsKICAgICAgICAuLi5vcHRzLAogICAgICAgIHN1YjogdGhpcy5fc3ViLAogICAgICAgIG9uc2VxIChzZXEpIHsKICAgICAgICAgIGlmICghdmVyc2lvbikgdmVyc2lvbiA9IHNlcSArIDEKICAgICAgICAgIGlmIChuZXh0KSBuZXh0LS0KICAgICAgICAgIGlmIChvbnNlcSkgb25zZXEoc2VxKQogICAgICAgIH0sCiAgICAgICAgb253YWl0IChzZXEpIHsKICAgICAgICAgIGlmICghbmV4dCkgewogICAgICAgICAgICBuZXh0ID0gRXh0ZW5zaW9uLkJBVENIX1NJWkUKICAgICAgICAgICAgZXh0ZW5zaW9uLml0ZXJhdG9yKGl0ZS5zbmFwc2hvdCh2ZXJzaW9uKSkKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbndhaXQpIG9ud2FpdChzZXEpCiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgb3B0cyA9IGVuY1JhbmdlKGtleUVuY29kaW5nLCB7IC4uLm9wdHMsIHN1YjogdGhpcy5fc3ViIH0pCiAgICB9CgogICAgY29uc3QgaXRlID0gbmV3IFJhbmdlSXRlcmF0b3IobmV3IEJhdGNoKHRoaXMsIHRoaXMuX21ha2VTbmFwc2hvdCgpLCBudWxsLCBmYWxzZSwgb3B0cyksIG51bGwsIG9wdHMpCiAgICByZXR1cm4gaXRlCiAgfQoKICBjcmVhdGVSZWFkU3RyZWFtIChyYW5nZSwgb3B0cykgewogICAgY29uc3Qgc2lnbmFsID0gKG9wdHMgJiYgb3B0cy5zaWduYWwpIHx8IG51bGwKICAgIHJldHVybiBpdGVyYXRvclRvU3RyZWFtKHRoaXMuY3JlYXRlUmFuZ2VJdGVyYXRvcihyYW5nZSwgb3B0cyksIHNpZ25hbCkKICB9CgogIGNyZWF0ZUhpc3RvcnlTdHJlYW0gKG9wdHMpIHsKICAgIGNvbnN0IHNlc3Npb24gPSAob3B0cyAmJiBvcHRzLmxpdmUpID8gdGhpcy5jb3JlLnNlc3Npb24oKSA6IHRoaXMuX21ha2VTbmFwc2hvdCgpCiAgICBjb25zdCBzaWduYWwgPSAob3B0cyAmJiBvcHRzLnNpZ25hbCkgfHwgbnVsbAogICAgcmV0dXJuIGl0ZXJhdG9yVG9TdHJlYW0obmV3IEhpc3RvcnlJdGVyYXRvcihuZXcgQmF0Y2godGhpcywgc2Vzc2lvbiwgbnVsbCwgZmFsc2UsIG9wdHMpLCBvcHRzKSwgc2lnbmFsKQogIH0KCiAgY3JlYXRlRGlmZlN0cmVhbSAocmlnaHQsIHJhbmdlLCBvcHRzKSB7CiAgICBpZiAodHlwZW9mIHJpZ2h0ID09PSAnbnVtYmVyJykgcmlnaHQgPSB0aGlzLmNoZWNrb3V0KE1hdGgubWF4KDEsIHJpZ2h0KSwgeyByZXVzZVNlc3Npb246IHRydWUgfSkKCiAgICAvLyBiYWNrd2FyZHMgY29tcGF0IHJhbmdlIGFyZwogICAgb3B0cyA9IG9wdHMgPyB7IC4uLm9wdHMsIC4uLnJhbmdlIH0gOiByYW5nZQoKICAgIGNvbnN0IHNpZ25hbCA9IChvcHRzICYmIG9wdHMuc2lnbmFsKSB8fCBudWxsCgogICAgY29uc3Qga2V5RW5jb2RpbmcgPSBvcHRzICYmIG9wdHMua2V5RW5jb2RpbmcgPyBjb2RlY3Mob3B0cy5rZXlFbmNvZGluZykgOiB0aGlzLmtleUVuY29kaW5nCiAgICBpZiAoa2V5RW5jb2RpbmcpIG9wdHMgPSBlbmNSYW5nZShrZXlFbmNvZGluZywgeyAuLi5vcHRzLCBzdWI6IHRoaXMuX3N1YiB9KQoKICAgIGxldCBkb25lCiAgICBsZXQgY2xvc2luZwogICAgbGV0IGl0ZQoKICAgIGNvbnN0IGxlZnQgPSB0aGlzCgogICAgY29uc3QgcnMgPSBuZXcgUmVhZGFibGUoewogICAgICBzaWduYWwsCiAgICAgIGVhZ2VyT3BlbjogdHJ1ZSwKICAgICAgYXN5bmMgb3BlbiAoY2IpIHsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKHJpZ2h0Lm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHJpZ2h0LnJlYWR5KCkKICAgICAgICAgIGlmIChsZWZ0Lm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IGxlZnQucmVhZHkoKQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgY2IoZXJyKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBpZiAoY2xvc2luZykgewogICAgICAgICAgY2IobnVsbCkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaWYgKGxlZnQuY29yZS5jbG9zaW5nIHx8IHJpZ2h0LmNvcmUuY2xvc2luZykgewogICAgICAgICAgY2IobmV3IEVycm9yKCdCZWUgY2xvc2VkJykpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGNvbnN0IHNuYXBzaG90ID0gcmlnaHQudmVyc2lvbiA+IGxlZnQudmVyc2lvbgogICAgICAgICAgPyByaWdodC5fbWFrZVNuYXBzaG90KCkKICAgICAgICAgIDogbGVmdC5fbWFrZVNuYXBzaG90KCkKCiAgICAgICAgZG9uZSA9IGNiCiAgICAgICAgaXRlID0gbmV3IERpZmZJdGVyYXRvcigKICAgICAgICAgIG5ldyBCYXRjaChsZWZ0LCBzbmFwc2hvdCwgbnVsbCwgZmFsc2UsIG9wdHMpLAogICAgICAgICAgbmV3IEJhdGNoKHJpZ2h0LCBzbmFwc2hvdCwgbnVsbCwgZmFsc2UsIG9wdHMpLAogICAgICAgICAgb3B0cwogICAgICAgICkKICAgICAgICBpdGUub3BlbigpLnRoZW4oZmluLCBmaW4pCiAgICAgIH0sCiAgICAgIHJlYWQgKGNiKSB7CiAgICAgICAgZG9uZSA9IGNiCiAgICAgICAgaXRlLm5leHQoKS50aGVuKHB1c2gsIGZpbikKICAgICAgfSwKICAgICAgcHJlZGVzdHJveSAoKSB7CiAgICAgICAgaWYgKCFpdGUpIHsKICAgICAgICAgIGNsb3NpbmcgPSBQcm9taXNlLnJlc29sdmUoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjbG9zaW5nID0gaXRlLmNsb3NlKCkKICAgICAgICAgIGNsb3NpbmcuY2F0Y2gobm9vcCkKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3kgKGNiKSB7CiAgICAgICAgZG9uZSA9IGNiCiAgICAgICAgaWYgKCFjbG9zaW5nKSBjbG9zaW5nID0gaXRlLmNsb3NlKCkKICAgICAgICBjbG9zaW5nLnRoZW4oZmluLCBmaW4pCiAgICAgIH0KICAgIH0pCgogICAgcmV0dXJuIHJzCgogICAgZnVuY3Rpb24gZmluIChlcnIpIHsKICAgICAgZG9uZShlcnIpCiAgICB9CgogICAgZnVuY3Rpb24gcHVzaCAodmFsKSB7CiAgICAgIHJzLnB1c2godmFsKQogICAgICBkb25lKG51bGwpCiAgICB9CiAgfQoKICBnZXQgKGtleSwgb3B0cykgewogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLCB0aGlzLl9tYWtlU25hcHNob3QoKSwgbnVsbCwgdHJ1ZSwgb3B0cykKICAgIHJldHVybiBiLmdldChrZXkpCiAgfQoKICBnZXRCeVNlcSAoc2VxLCBvcHRzKSB7CiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMsIHRoaXMuX21ha2VTbmFwc2hvdCgpLCBudWxsLCB0cnVlLCBvcHRzKQogICAgcmV0dXJuIGIuZ2V0QnlTZXEoc2VxKQogIH0KCiAgcHV0IChrZXksIHZhbHVlLCBvcHRzKSB7CiAgICBjb25zdCBiID0gbmV3IEJhdGNoKHRoaXMsIHRoaXMuY29yZSwgbnVsbCwgdHJ1ZSwgb3B0cykKICAgIHJldHVybiBiLnB1dChrZXksIHZhbHVlLCBvcHRzKQogIH0KCiAgYmF0Y2ggKG9wdHMpIHsKICAgIHJldHVybiBuZXcgQmF0Y2godGhpcywgdGhpcy5jb3JlLCBtdXRleGlmeSgpLCB0cnVlLCBvcHRzKQogIH0KCiAgZGVsIChrZXksIG9wdHMpIHsKICAgIGNvbnN0IGIgPSBuZXcgQmF0Y2godGhpcywgdGhpcy5jb3JlLCBudWxsLCB0cnVlLCBvcHRzKQogICAgcmV0dXJuIGIuZGVsKGtleSwgb3B0cykKICB9CgogIHdhdGNoIChyYW5nZSwgb3B0cykgewogICAgaWYgKCF0aGlzLl93YXRjaGVycykgdGhyb3cgbmV3IEVycm9yKCdDYW4gb25seSB3YXRjaCB0aGUgbWFpbiBiZWUgaW5zdGFuY2UnKQogICAgcmV0dXJuIG5ldyBXYXRjaGVyKHRoaXMsIHJhbmdlLCBvcHRzKQogIH0KCiAgYXN5bmMgZ2V0QW5kV2F0Y2ggKGtleSwgb3B0cykgewogICAgaWYgKCF0aGlzLl93YXRjaGVycykgdGhyb3cgbmV3IEVycm9yKCdDYW4gb25seSB3YXRjaCB0aGUgbWFpbiBiZWUgaW5zdGFuY2UnKQoKICAgIGNvbnN0IHdhdGNoZXIgPSBuZXcgRW50cnlXYXRjaGVyKHRoaXMsIGtleSwgb3B0cykKICAgIGF3YWl0IHdhdGNoZXIuX2RlYm91bmNlZFVwZGF0ZSgpCgogICAgaWYgKHRoaXMuY2xvc2luZykgewogICAgICBhd2FpdCB3YXRjaGVyLmNsb3NlKCkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCZWUgY2xvc2VkJykKICAgIH0KCiAgICByZXR1cm4gd2F0Y2hlcgogIH0KCiAgX29uYXBwZW5kICgpIHsKICAgIGZvciAoY29uc3Qgd2F0Y2hlciBvZiB0aGlzLl93YXRjaGVycykgewogICAgICB3YXRjaGVyLl9vbmFwcGVuZCgpCiAgICB9CgogICAgZm9yIChjb25zdCB3YXRjaGVyIG9mIHRoaXMuX2VudHJ5V2F0Y2hlcnMpIHsKICAgICAgd2F0Y2hlci5fb25hcHBlbmQoKQogICAgfQogIH0KCiAgX29udHJ1bmNhdGUgKGxlbmd0aCkgewogICAgZm9yIChjb25zdCB3YXRjaGVyIG9mIHRoaXMuX3dhdGNoZXJzKSB7CiAgICAgIHdhdGNoZXIuX29udHJ1bmNhdGUoKQogICAgfQoKICAgIGZvciAoY29uc3Qgd2F0Y2hlciBvZiB0aGlzLl9lbnRyeVdhdGNoZXJzKSB7CiAgICAgIHdhdGNoZXIuX29udHJ1bmNhdGUoKQogICAgfQoKICAgIHRoaXMuX25vZGVDYWNoZS5nYyhsZW5ndGgpCiAgICB0aGlzLl9rZXlDYWNoZS5nYyhsZW5ndGgpCiAgfQoKICBfbWFrZVNuYXBzaG90ICgpIHsKICAgIGlmICh0aGlzLl9zZXNzaW9ucyA9PT0gZmFsc2UpIHJldHVybiB0aGlzLmNvcmUKICAgIC8vIFRPRE86IGJldHRlciBpZiB3ZSBjb3VsZCBlbmNhcHN1bGF0ZSB0aGlzIGluIGh5cGVyY29yZSBpbiB0aGUgZnV0dXJlCiAgICByZXR1cm4gKHRoaXMuX2NoZWNrb3V0IDw9IHRoaXMuY29yZS5sZW5ndGggfHwgdGhpcy5fY2hlY2tvdXQgPD0gMSkgPyB0aGlzLmNvcmUuc25hcHNob3QoKSA6IHRoaXMuY29yZS5zZXNzaW9uKHsgc25hcHNob3Q6IGZhbHNlIH0pCiAgfQoKICBhc3luYyBjbGVhclVubGlua2VkIChvcHRpb25zID0ge30pIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIGNvbnN0IHsgZ3RlID0gMCwgbHQgPSB0aGlzLnZlcnNpb24gLSAxLCBiYXRjaFNpemUgPSA0MDk2LCB3YWl0ID0gdHJ1ZSB9ID0gb3B0aW9ucwogICAgY29uc3QgY2hlY2tvdXQgPSB0aGlzLnZlcnNpb24KCiAgICBsZXQgcHJldiA9IHRoaXMuYmF0Y2goeyB3YWl0OiBmYWxzZSwgY2hlY2tvdXQ6IGd0ZSB9KQogICAgbGV0IGIgPSB0aGlzLmJhdGNoKHsgd2FpdCwgY2hlY2tvdXQgfSkKCiAgICBjb25zdCBpdGVCYXRjaCA9IHRoaXMuYmF0Y2goeyB3YWl0OiBmYWxzZSwgY2hlY2tvdXQgfSkKICAgIGNvbnN0IGl0ZSA9IG5ldyBMb2NhbEJsb2NrSXRlcmF0b3IoaXRlQmF0Y2gsIHsgZ3RlLCBsdCB9KQogICAgYXdhaXQgaXRlLm9wZW4oKQoKICAgIGxldCB0aWNrcyA9IDAKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBkYXRhID0gYXdhaXQgaXRlLm5leHQoKQogICAgICBpZiAoIWRhdGEpIGJyZWFrCgogICAgICBpZiAoIShhd2FpdCBpc0xpbmtlZChiLCBkYXRhKSkpIHsKICAgICAgICBpZiAoYi5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jbG9zaW5nKSBicmVhawogICAgICAgIGF3YWl0IHRoaXMuY29yZS5jbGVhcihkYXRhLnNlcSkKICAgICAgfQoKICAgICAgY29uc3QgcHJldk5vZGUgPSBhd2FpdCBwcmV2LmdldChkYXRhLmtleSwgeyBmaW5hbGl6ZTogZmFsc2UgfSkuY2F0Y2godG9OdWxsKQoKICAgICAgaWYgKHByZXZOb2RlICYmICEoYXdhaXQgaXNMaW5rZWQoYiwgcHJldk5vZGUpKSkgewogICAgICAgIGlmIChiLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNvcmUuY2xvc2luZyB8fCB0aGlzLmNsb3NpbmcpIGJyZWFrCiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLmNsZWFyKHByZXZOb2RlLnNlcSkKICAgICAgfQoKICAgICAgaWYgKHRpY2tzKysgPj0gYmF0Y2hTaXplKSB7CiAgICAgICAgdGlja3MgPSAwCiAgICAgICAgYXdhaXQgcHJldi5jbG9zZSgpCiAgICAgICAgYXdhaXQgYi5jbG9zZSgpCgogICAgICAgIHByZXYgPSB0aGlzLmJhdGNoKHsgd2FpdDogZmFsc2UsIGNoZWNrb3V0OiBndGUgfSkKICAgICAgICBiID0gdGhpcy5iYXRjaCh7IHdhaXQsIGNoZWNrb3V0IH0pCiAgICAgIH0KICAgIH0KCiAgICBpZiAoYi5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jb3JlLmNsb3NpbmcgfHwgdGhpcy5jbG9zaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgaXMgY2xvc2VkJykKCiAgICBhd2FpdCBiLmNsb3NlKCkKICAgIGF3YWl0IHByZXYuY2xvc2UoKQogICAgYXdhaXQgaXRlLmNsb3NlKCkKICAgIGF3YWl0IGl0ZUJhdGNoLmNsb3NlKCkKCiAgICByZXR1cm4gbHQKICB9CgogIGNoZWNrb3V0ICh2ZXJzaW9uLCBvcHRzID0ge30pIHsKICAgIGlmICh2ZXJzaW9uID09PSAwKSB2ZXJzaW9uID0gMQoKICAgIC8vIHNhbWUgYXMgYWJvdmUsIGp1c3QgY2hlY2tvdXQgaXNuJ3Qgc2V0IHlldC4uLgogICAgY29uc3Qgc25hcCA9IChvcHRzLnJldXNlU2Vzc2lvbiB8fCB0aGlzLl9zZXNzaW9ucyA9PT0gZmFsc2UpCiAgICAgID8gdGhpcy5jb3JlCiAgICAgIDogKHZlcnNpb24gPD0gdGhpcy5jb3JlLmxlbmd0aCB8fCB2ZXJzaW9uIDw9IDEpID8gdGhpcy5jb3JlLnNuYXBzaG90KCkgOiB0aGlzLmNvcmUuc2Vzc2lvbih7IHNuYXBzaG90OiBmYWxzZSB9KQoKICAgIHJldHVybiBuZXcgSHlwZXJiZWUoc25hcCwgewogICAgICBfdmlldzogdHJ1ZSwKICAgICAgX3N1YjogZmFsc2UsCiAgICAgIHByZWZpeDogdGhpcy5wcmVmaXgsCiAgICAgIHNlcDogdGhpcy5zZXAsCiAgICAgIGxvY2s6IHRoaXMubG9jaywKICAgICAgY2hlY2tvdXQ6IHZlcnNpb24sCiAgICAgIGtleUVuY29kaW5nOiBvcHRzLmtleUVuY29kaW5nIHx8IHRoaXMua2V5RW5jb2RpbmcsCiAgICAgIHZhbHVlRW5jb2Rpbmc6IG9wdHMudmFsdWVFbmNvZGluZyB8fCB0aGlzLnZhbHVlRW5jb2RpbmcsCiAgICAgIGV4dGVuc2lvbjogdGhpcy5leHRlbnNpb24gIT09IG51bGwgPyB0aGlzLmV4dGVuc2lvbiA6IGZhbHNlCiAgICB9KQogIH0KCiAgc25hcHNob3QgKG9wdHMpIHsKICAgIHJldHVybiB0aGlzLmNoZWNrb3V0KCh0aGlzLmNvcmUub3BlbmVkID09PSBmYWxzZSB8fCB0aGlzLl9jaGVja291dCA8PSAwKSA/IC0xIDogTWF0aC5tYXgoMSwgdGhpcy52ZXJzaW9uKSwgb3B0cykKICB9CgogIHN1YiAocHJlZml4LCBvcHRzID0ge30pIHsKICAgIGxldCBzZXAgPSBvcHRzLnNlcCB8fCB0aGlzLnNlcAogICAgaWYgKCFiNGEuaXNCdWZmZXIoc2VwKSkgc2VwID0gYjRhLmZyb20oc2VwKQoKICAgIHByZWZpeCA9IGI0YS5jb25jYXQoW3RoaXMucHJlZml4IHx8IEVNUFRZLCBiNGEuZnJvbShwcmVmaXgpLCBzZXBdKQoKICAgIGNvbnN0IHZhbHVlRW5jb2RpbmcgPSBjb2RlY3Mob3B0cy52YWx1ZUVuY29kaW5nIHx8IHRoaXMudmFsdWVFbmNvZGluZykKICAgIGNvbnN0IGtleUVuY29kaW5nID0gY29kZWNzKG9wdHMua2V5RW5jb2RpbmcgfHwgdGhpcy5fdW5wcmVmaXhlZEtleUVuY29kaW5nKQoKICAgIHJldHVybiBuZXcgSHlwZXJiZWUodGhpcy5jb3JlLCB7CiAgICAgIF92aWV3OiB0cnVlLAogICAgICBfc3ViOiB0cnVlLAogICAgICBwcmVmaXgsCiAgICAgIHNlcDogdGhpcy5zZXAsCiAgICAgIGxvY2s6IHRoaXMubG9jaywKICAgICAgY2hlY2tvdXQ6IHRoaXMuX2NoZWNrb3V0LAogICAgICB2YWx1ZUVuY29kaW5nLAogICAgICBrZXlFbmNvZGluZywKICAgICAgZXh0ZW5zaW9uOiB0aGlzLmV4dGVuc2lvbiAhPT0gbnVsbCA/IHRoaXMuZXh0ZW5zaW9uIDogZmFsc2UsCiAgICAgIG1ldGFkYXRhOiB0aGlzLm1ldGFkYXRhCiAgICB9KQogIH0KCiAgYXN5bmMgZ2V0SGVhZGVyIChvcHRzKSB7CiAgICBjb25zdCBibGsgPSBhd2FpdCB0aGlzLmNvcmUuZ2V0KDAsIG9wdHMpCiAgICB0cnkgewogICAgICByZXR1cm4gYmxrICYmIEhlYWRlci5kZWNvZGUoYmxrKQogICAgfSBjYXRjaCB7CiAgICAgIHRocm93IERFQ09ESU5HX0VSUk9SKCkKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZSAoKSB7CiAgICBpZiAoIXRoaXMuX3ZpZXcpIHsKICAgICAgaWYgKHRoaXMuX2tleUNhY2hlKSB0aGlzLl9rZXlDYWNoZS5jbGVhcigpCiAgICAgIGlmICh0aGlzLl9ub2RlQ2FjaGUpIHRoaXMuX25vZGVDYWNoZS5jbGVhcigpCiAgICB9CgogICAgaWYgKHRoaXMuX3dhdGNoZXJzKSB7CiAgICAgIHRoaXMuY29yZS5vZmYoJ2FwcGVuZCcsIHRoaXMuX29uYXBwZW5kQm91bmQpCiAgICAgIHRoaXMuY29yZS5vZmYoJ3RydW5jYXRlJywgdGhpcy5fb250cnVuY2F0ZUJvdW5kKQoKICAgICAgd2hpbGUgKHRoaXMuX3dhdGNoZXJzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHRoaXMuX3dhdGNoZXJzW3RoaXMuX3dhdGNoZXJzLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLl9lbnRyeVdhdGNoZXJzKSB7CiAgICAgIHdoaWxlICh0aGlzLl9lbnRyeVdhdGNoZXJzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHRoaXMuX2VudHJ5V2F0Y2hlcnNbdGhpcy5fZW50cnlXYXRjaGVycy5sZW5ndGggLSAxXS5jbG9zZSgpCiAgICAgIH0KICAgIH0KCiAgICB3aGlsZSAodGhpcy5fYmF0Y2hlcy5sZW5ndGgpIHsKICAgICAgYXdhaXQgdGhpcy5fYmF0Y2hlc1t0aGlzLl9iYXRjaGVzLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgIH0KCiAgICByZXR1cm4gdGhpcy5jb3JlLmNsb3NlKCkKICB9CgogIHN0YXRpYyBhc3luYyBpc0h5cGVyYmVlIChjb3JlLCBvcHRzKSB7CiAgICBhd2FpdCBjb3JlLnJlYWR5KCkKCiAgICBjb25zdCBibGswID0gYXdhaXQgY29yZS5nZXQoMCwgb3B0cykKICAgIGlmIChibGswID09PSBudWxsKSB0aHJvdyBCTE9DS19OT1RfQVZBSUxBQkxFKCkKCiAgICB0cnkgewogICAgICByZXR1cm4gSGVhZGVyLmRlY29kZShibGswKS5wcm90b2NvbCA9PT0gJ2h5cGVyYmVlJwogICAgfSBjYXRjaCAoZXJyKSB7IC8vIHVuZGVjb2RhYmxlCiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KfQoKY2xhc3MgQmF0Y2ggewogIGNvbnN0cnVjdG9yICh0cmVlLCBjb3JlLCBiYXRjaExvY2ssIGNhY2hlLCBvcHRpb25zID0ge30pIHsKICAgIHRoaXMudHJlZSA9IHRyZWUKICAgIC8vIHRoaXMuZmVlZCBpcyBub3cgZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgdGhpcy5jb3JlIGdvaW5nIGZvcndhcmQKICAgIHRoaXMuZmVlZCA9IGNvcmUKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuaW5kZXggPSB0cmVlLl9iYXRjaGVzLnB1c2godGhpcykgLSAxCiAgICB0aGlzLmJsb2NrcyA9IGNhY2hlID8gbmV3IE1hcCgpIDogbnVsbAogICAgdGhpcy5hdXRvRmx1c2ggPSAhYmF0Y2hMb2NrCiAgICB0aGlzLm1heEJsb2Nrc0NhY2hlZCA9IG9wdGlvbnMubWF4QmxvY2tzQ2FjaGVkIHx8IDEyOAogICAgdGhpcy5yb290U2VxID0gMAogICAgdGhpcy5yb290ID0gbnVsbAogICAgdGhpcy5sZW5ndGggPSAwCiAgICB0aGlzLmNoZWNrb3V0ID0gb3B0aW9ucy5jaGVja291dCA9PT0gdW5kZWZpbmVkID8gLTEgOiBvcHRpb25zLmNoZWNrb3V0CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zCiAgICB0aGlzLmxvY2tlZCA9IG51bGwKICAgIHRoaXMuYmF0Y2hMb2NrID0gYmF0Y2hMb2NrCiAgICB0aGlzLm9uc2VxID0gdGhpcy5vcHRpb25zLm9uc2VxIHx8IG5vb3AKICAgIHRoaXMuYXBwZW5kaW5nID0gbnVsbAogICAgdGhpcy5pc1NuYXBzaG90ID0gdGhpcy5jb3JlICE9PSB0aGlzLnRyZWUuY29yZQogICAgdGhpcy5zaG91bGRVcGRhdGUgPSB0aGlzLm9wdGlvbnMudXBkYXRlICE9PSBmYWxzZQogICAgdGhpcy51cGRhdGluZyA9IG51bGwKICAgIHRoaXMuZW5jb2RpbmcgPSB7CiAgICAgIGtleTogb3B0aW9ucy5rZXlFbmNvZGluZyA/IGNvZGVjcyhvcHRpb25zLmtleUVuY29kaW5nKSA6IHRyZWUua2V5RW5jb2RpbmcsCiAgICAgIHZhbHVlOiBvcHRpb25zLnZhbHVlRW5jb2RpbmcgPyBjb2RlY3Mob3B0aW9ucy52YWx1ZUVuY29kaW5nKSA6IHRyZWUudmFsdWVFbmNvZGluZwogICAgfQogIH0KCiAgYXN5bmMgcmVhZHkgKCkgewogICAgaWYgKHRoaXMuY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQogICAgaWYgKHRoaXMudHJlZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnRyZWUucmVhZHkoKQogIH0KCiAgYXN5bmMgbG9jayAoKSB7CiAgICBpZiAodGhpcy50cmVlLnJlYWRvbmx5KSB0aHJvdyBuZXcgRXJyb3IoJ0h5cGVyYmVlIGlzIG1hcmtlZCBhcyByZWFkLW9ubHknKQogICAgaWYgKHRoaXMubG9ja2VkID09PSBudWxsKSB0aGlzLmxvY2tlZCA9IGF3YWl0IHRoaXMudHJlZS5sb2NrKCkKICB9CgogIGdldCB2ZXJzaW9uICgpIHsKICAgIGlmICh0aGlzLmNoZWNrb3V0ICE9PSAtMSkgcmV0dXJuIE1hdGgubWF4KDEsIHRoaXMuY2hlY2tvdXQpCiAgICByZXR1cm4gTWF0aC5tYXgoMSwgdGhpcy50cmVlLl9jaGVja291dCB8fCAodGhpcy5jb3JlLmxlbmd0aCArIHRoaXMubGVuZ3RoKSkKICB9CgogIGFzeW5jIGdldFJvb3QgKGVuc3VyZUhlYWRlcikgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCiAgICBpZiAoZW5zdXJlSGVhZGVyKSB7CiAgICAgIGlmICh0aGlzLmNvcmUubGVuZ3RoID09PSAwICYmIHRoaXMuY29yZS53cml0YWJsZSAmJiAhdGhpcy50cmVlLnJlYWRvbmx5KSB7CiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLmFwcGVuZChIZWFkZXIuZW5jb2RlKHsKICAgICAgICAgIHByb3RvY29sOiAnaHlwZXJiZWUnLAogICAgICAgICAgbWV0YWRhdGE6IHRoaXMudHJlZS5tZXRhZGF0YQogICAgICAgIH0pKQogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy50cmVlLl9jaGVja291dCA9PT0gMCAmJiB0aGlzLmNoZWNrb3V0ID09PSAtMSAmJiB0aGlzLnNob3VsZFVwZGF0ZSkgewogICAgICBpZiAodGhpcy51cGRhdGluZyA9PT0gbnVsbCkgdGhpcy51cGRhdGluZyA9IHRoaXMuY29yZS51cGRhdGUoKQogICAgICBhd2FpdCB0aGlzLnVwZGF0aW5nCiAgICB9CiAgICBpZiAodGhpcy52ZXJzaW9uIDwgMikgcmV0dXJuIG51bGwKICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRCbG9jayh0aGlzLnZlcnNpb24gLSAxKSkuZ2V0VHJlZU5vZGUoMCkKICB9CgogIGFzeW5jIGdldEtleSAoc2VxKSB7CiAgICBhd2FpdCB0aGlzLnRyZWUuX2NhY2hlTG9jay5lbnRlcihzZXEpCgogICAgdHJ5IHsKICAgICAgY29uc3QgayA9IHRoaXMuY29yZS5mb3JrID09PSB0aGlzLnRyZWUuY29yZS5mb3JrID8gdGhpcy50cmVlLl9rZXlDYWNoZS5nZXQoc2VxKSA6IG51bGwKICAgICAgaWYgKGsgIT09IG51bGwpIHJldHVybiBrCiAgICAgIGNvbnN0IGtleSA9IChhd2FpdCB0aGlzLl9nZXRCbG9jayhzZXEpKS5rZXkKICAgICAgaWYgKHRoaXMuY29yZS5mb3JrID09PSB0aGlzLnRyZWUuY29yZS5mb3JrKSB0aGlzLnRyZWUuX2tleUNhY2hlLnNldChzZXEsIGtleSkKICAgICAgcmV0dXJuIGtleQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy50cmVlLl9jYWNoZUxvY2suZXhpdChzZXEpCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0Tm9kZSAoc2VxKSB7CiAgICBjb25zdCBjYWNoZWQgPSAodGhpcy50cmVlLl9ub2RlQ2FjaGUgIT09IG51bGwgJiYgdGhpcy5jb3JlLmZvcmsgPT09IHRoaXMudHJlZS5jb3JlLmZvcmspID8gdGhpcy50cmVlLl9ub2RlQ2FjaGUuZ2V0KHNlcSkgOiBudWxsCiAgICBpZiAoY2FjaGVkICE9PSBudWxsKSByZXR1cm4gY2FjaGVkCiAgICBjb25zdCBlbnRyeSA9IGF3YWl0IHRoaXMuY29yZS5nZXQoc2VxLCB7IC4uLnRoaXMub3B0aW9ucywgdmFsdWVFbmNvZGluZzogTm9kZSB9KQogICAgaWYgKGVudHJ5ID09PSBudWxsKSB0aHJvdyBCTE9DS19OT1RfQVZBSUxBQkxFKCkKICAgIGNvbnN0IHdyYXAgPSBjb3B5RW50cnkoZW50cnkpCiAgICBpZiAodGhpcy5jb3JlLmZvcmsgPT09IHRoaXMudHJlZS5jb3JlLmZvcmsgJiYgdGhpcy50cmVlLl9ub2RlQ2FjaGUgIT09IG51bGwpIHRoaXMudHJlZS5fbm9kZUNhY2hlLnNldChzZXEsIHdyYXApCiAgICByZXR1cm4gd3JhcAogIH0KCiAgYXN5bmMgZ2V0QmxvY2sgKHNlcSkgewogICAgaWYgKHRoaXMucm9vdFNlcSA9PT0gMCkgdGhpcy5yb290U2VxID0gc2VxCiAgICBhd2FpdCB0aGlzLnRyZWUuX2NhY2hlTG9jay5lbnRlcihzZXEpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2dldEJsb2NrKHNlcSkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMudHJlZS5fY2FjaGVMb2NrLmV4aXQoc2VxKQogICAgfQogIH0KCiAgYXN5bmMgX2dldEJsb2NrIChzZXEpIHsKICAgIGxldCBiID0gdGhpcy5ibG9ja3MgJiYgdGhpcy5ibG9ja3MuZ2V0KHNlcSkKICAgIGlmIChiKSByZXR1cm4gYgogICAgdGhpcy5vbnNlcShzZXEpCiAgICBjb25zdCBlbnRyeSA9IGF3YWl0IHRoaXMuX2dldE5vZGUoc2VxKQogICAgYiA9IHRoaXMuYmxvY2tzICYmIHRoaXMuYmxvY2tzLmdldChzZXEpCiAgICBpZiAoYikgcmV0dXJuIGIKICAgIGIgPSBuZXcgQmxvY2tFbnRyeShzZXEsIHRoaXMsIGVudHJ5KQogICAgaWYgKHRoaXMuYmxvY2tzICYmICh0aGlzLmJsb2Nrcy5zaXplIC0gdGhpcy5sZW5ndGgpIDwgdGhpcy5tYXhCbG9ja3NDYWNoZWQpIHRoaXMuYmxvY2tzLnNldChzZXEsIGIpCiAgICByZXR1cm4gYgogIH0KCiAgX29ud2FpdCAoa2V5KSB7CiAgICB0aGlzLm9wdGlvbnMub253YWl0ID0gbnVsbAogICAgdGhpcy50cmVlLmV4dGVuc2lvbi5nZXQodGhpcy5yb290U2VxICsgMSwga2V5KQogIH0KCiAgX2dldEVuY29kaW5nIChvcHRzKSB7CiAgICBpZiAoIW9wdHMpIHJldHVybiB0aGlzLmVuY29kaW5nCiAgICByZXR1cm4gewogICAgICBrZXk6IG9wdHMua2V5RW5jb2RpbmcgPyBjb2RlY3Mob3B0cy5rZXlFbmNvZGluZykgOiB0aGlzLmVuY29kaW5nLmtleSwKICAgICAgdmFsdWU6IG9wdHMudmFsdWVFbmNvZGluZyA/IGNvZGVjcyhvcHRzLnZhbHVlRW5jb2RpbmcpIDogdGhpcy5lbmNvZGluZy52YWx1ZQogICAgfQogIH0KCiAgcGVlayAocmFuZ2UsIG9wdHMpIHsKICAgIHJldHVybiBpdGVyYXRvclBlZWsodGhpcy5jcmVhdGVSYW5nZUl0ZXJhdG9yKHJhbmdlLCB7IC4uLm9wdHMsIGxpbWl0OiAxIH0pKQogIH0KCiAgY3JlYXRlUmFuZ2VJdGVyYXRvciAocmFuZ2UsIG9wdHMgPSB7fSkgewogICAgLy8gYmFja3dhcmRzIGNvbXBhdCByYW5nZSBhcmcKICAgIG9wdHMgPSBvcHRzID8geyAuLi5vcHRzLCAuLi5yYW5nZSB9IDogcmFuZ2UKCiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCiAgICByZXR1cm4gbmV3IFJhbmdlSXRlcmF0b3IodGhpcywgZW5jb2RpbmcsIGVuY1JhbmdlKGVuY29kaW5nLmtleSwgeyAuLi5vcHRzLCBzdWI6IHRoaXMudHJlZS5fc3ViIH0pKQogIH0KCiAgY3JlYXRlUmVhZFN0cmVhbSAocmFuZ2UsIG9wdHMpIHsKICAgIGNvbnN0IHNpZ25hbCA9IChvcHRzICYmIG9wdHMuc2lnbmFsKSB8fCBudWxsCiAgICByZXR1cm4gaXRlcmF0b3JUb1N0cmVhbSh0aGlzLmNyZWF0ZVJhbmdlSXRlcmF0b3IocmFuZ2UsIG9wdHMpLCBzaWduYWwpCiAgfQoKICBhc3luYyBnZXRCeVNlcSAoc2VxLCBvcHRzKSB7CiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCgogICAgdHJ5IHsKICAgICAgY29uc3QgYmxvY2sgPSAoYXdhaXQgdGhpcy5nZXRCbG9jayhzZXEpKS5maW5hbChlbmNvZGluZykKICAgICAgcmV0dXJuIHsga2V5OiBibG9jay5rZXksIHZhbHVlOiBibG9jay52YWx1ZSB9CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9jbG9zZVNuYXBzaG90KCkKICAgIH0KICB9CgogIGFzeW5jIGdldCAoa2V5LCBvcHRzKSB7CiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCiAgICBjb25zdCBmaW5hbGl6ZSA9IG9wdHMgPyBvcHRzLmZpbmFsaXplICE9PSBmYWxzZSA6IHRydWUKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0KGtleSwgZW5jb2RpbmcsIGZpbmFsaXplKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fY2xvc2VTbmFwc2hvdCgpCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0IChrZXksIGVuY29kaW5nLCBmaW5hbGl6ZSkgewogICAga2V5ID0gZW5jKGVuY29kaW5nLmtleSwga2V5KQoKICAgIGlmICh0aGlzLnRyZWUuZXh0ZW5zaW9uICE9PSBudWxsICYmIHRoaXMub3B0aW9ucy5leHRlbnNpb24gIT09IGZhbHNlKSB7CiAgICAgIHRoaXMub3B0aW9ucy5vbndhaXQgPSB0aGlzLl9vbndhaXQuYmluZCh0aGlzLCBrZXkpCiAgICB9CgogICAgbGV0IG5vZGUgPSBhd2FpdCB0aGlzLmdldFJvb3QoZmFsc2UpCiAgICBpZiAoIW5vZGUpIHJldHVybiBudWxsCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKG5vZGUuYmxvY2suaXNUYXJnZXQoa2V5KSkgewogICAgICAgIHJldHVybiBub2RlLmJsb2NrLmlzRGVsZXRpb24oKSA/IG51bGwgOiAoZmluYWxpemUgPyBub2RlLmJsb2NrLmZpbmFsKGVuY29kaW5nKSA6IG5vZGUuYmxvY2spCiAgICAgIH0KCiAgICAgIGxldCBzID0gMAogICAgICBsZXQgZSA9IG5vZGUua2V5cy5sZW5ndGgKICAgICAgbGV0IGMKCiAgICAgIHdoaWxlIChzIDwgZSkgewogICAgICAgIGNvbnN0IG1pZCA9IChzICsgZSkgPj4gMQoKICAgICAgICBjID0gYjRhLmNvbXBhcmUoa2V5LCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgY29uc3QgYmxvY2sgPSBhd2FpdCB0aGlzLmdldEJsb2NrKG5vZGUua2V5c1ttaWRdLnNlcSkKICAgICAgICAgIHJldHVybiBmaW5hbGl6ZSA/IGJsb2NrLmZpbmFsKGVuY29kaW5nKSA6IGJsb2NrCiAgICAgICAgfQoKICAgICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICAgIH0KCiAgICAgIGlmICghbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHJldHVybiBudWxsCgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoaSkKICAgIH0KICB9CgogIGFzeW5jIGxpbmtzIChrZXksIHNlcSkgewogICAgbGV0IG5vZGUgPSBhd2FpdCB0aGlzLmdldFJvb3QoZmFsc2UpCiAgICBpZiAoIW5vZGUpIHJldHVybiBmYWxzZQoKICAgIGlmIChub2RlLmJsb2NrLnNlcSA9PT0gc2VxKSByZXR1cm4gdHJ1ZQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChub2RlLmJsb2NrLmlzVGFyZ2V0KGtleSkpIHJldHVybiBmYWxzZQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCgogICAgICAgIGlmIChub2RlLmtleXNbbWlkXS5zZXEgPT09IHNlcSkgcmV0dXJuIHRydWUKICAgICAgICBjID0gYjRhLmNvbXBhcmUoa2V5LCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgcmV0dXJuIGZhbHNlCgogICAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgICAgfQoKICAgICAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoaSkKICAgICAgaWYgKG5vZGUuYmxvY2suc2VxID09PSBzZXEpIHJldHVybiB0cnVlCiAgICB9CiAgfQoKICBhc3luYyBwdXQgKGtleSwgdmFsdWUsIG9wdHMpIHsKICAgIGNvbnN0IHJlbGVhc2UgPSB0aGlzLmJhdGNoTG9jayA/IGF3YWl0IHRoaXMuYmF0Y2hMb2NrKCkgOiBudWxsCgogICAgY29uc3QgY2FzID0gKG9wdHMgJiYgb3B0cy5jYXMpIHx8IG51bGwKICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy5fZ2V0RW5jb2Rpbmcob3B0cykKCiAgICBpZiAoIXRoaXMubG9ja2VkKSBhd2FpdCB0aGlzLmxvY2soKQogICAgaWYgKCFyZWxlYXNlKSByZXR1cm4gdGhpcy5fcHV0KGtleSwgdmFsdWUsIGVuY29kaW5nLCBjYXMpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3B1dChrZXksIHZhbHVlLCBlbmNvZGluZywgY2FzKQogICAgfSBmaW5hbGx5IHsKICAgICAgcmVsZWFzZSgpCiAgICB9CiAgfQoKICBhc3luYyBfcHV0IChrZXksIHZhbHVlLCBlbmNvZGluZywgY2FzKSB7CiAgICBjb25zdCBuZXdOb2RlID0gewogICAgICBzZXE6IDAsCiAgICAgIGtleSwKICAgICAgdmFsdWUKICAgIH0KICAgIGtleSA9IGVuYyhlbmNvZGluZy5rZXksIGtleSkKICAgIHZhbHVlID0gZW5jKGVuY29kaW5nLnZhbHVlLCB2YWx1ZSkKCiAgICBjb25zdCBzdGFjayA9IFtdCgogICAgbGV0IHJvb3QKICAgIGxldCBub2RlID0gcm9vdCA9IGF3YWl0IHRoaXMuZ2V0Um9vdCh0cnVlKQogICAgaWYgKCFub2RlKSBub2RlID0gcm9vdCA9IFRyZWVOb2RlLmNyZWF0ZShudWxsKQoKICAgIGNvbnN0IHNlcSA9IG5ld05vZGUuc2VxID0gdGhpcy5jb3JlLmxlbmd0aCArIHRoaXMubGVuZ3RoCiAgICBjb25zdCB0YXJnZXQgPSBuZXcgS2V5KHNlcSwga2V5KQoKICAgIHdoaWxlIChub2RlLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICBzdGFjay5wdXNoKG5vZGUpCiAgICAgIG5vZGUuY2hhbmdlZCA9IHRydWUgLy8gY2hhbmdlZCwgYnV0IGNvbXByZXNzaWJsZQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKHRhcmdldC52YWx1ZSwgYXdhaXQgbm9kZS5nZXRLZXkobWlkKSkKCiAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgIGlmIChjYXMpIHsKICAgICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IG5vZGUuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICAgIGlmICghKGF3YWl0IGNhcyhwcmV2LmZpbmFsKGVuY29kaW5nKSwgbmV3Tm9kZSkpKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0aGlzLnRyZWUuYWx3YXlzRHVwbGljYXRlKSB7CiAgICAgICAgICAgIGNvbnN0IHByZXYgPSBhd2FpdCBub2RlLmdldEtleU5vZGUobWlkKQogICAgICAgICAgICBpZiAoc2FtZVZhbHVlKHByZXYudmFsdWUsIHZhbHVlKSkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuc2V0S2V5KG1pZCwgdGFyZ2V0KQogICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChyb290LCBzZXEsIGtleSwgdmFsdWUpCiAgICAgICAgfQoKICAgICAgICBpZiAoYyA8IDApIGUgPSBtaWQKICAgICAgICBlbHNlIHMgPSBtaWQgKyAxCiAgICAgIH0KCiAgICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgfQoKICAgIGxldCBuZWVkc1NwbGl0ID0gIShhd2FpdCBub2RlLmluc2VydEtleSh0YXJnZXQsIHZhbHVlLCBudWxsLCBuZXdOb2RlLCBlbmNvZGluZywgY2FzKSkKICAgIGlmICghbm9kZS5jaGFuZ2VkKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQoKICAgIHdoaWxlIChuZWVkc1NwbGl0KSB7CiAgICAgIGNvbnN0IHBhcmVudCA9IHN0YWNrLnBvcCgpCiAgICAgIGNvbnN0IHsgbWVkaWFuLCByaWdodCB9ID0gYXdhaXQgbm9kZS5zcGxpdCgpCgogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgbmVlZHNTcGxpdCA9ICEoYXdhaXQgcGFyZW50Lmluc2VydEtleShtZWRpYW4sIHZhbHVlLCByaWdodCwgbnVsbCwgZW5jb2RpbmcsIG51bGwpKQogICAgICAgIG5vZGUgPSBwYXJlbnQKICAgICAgfSBlbHNlIHsKICAgICAgICByb290ID0gVHJlZU5vZGUuY3JlYXRlKG5vZGUuYmxvY2spCiAgICAgICAgcm9vdC5jaGFuZ2VkID0gdHJ1ZQogICAgICAgIHJvb3Qua2V5cy5wdXNoKG1lZGlhbikKICAgICAgICByb290LmNoaWxkcmVuLnB1c2gobmV3IENoaWxkKDAsIDAsIG5vZGUpLCBuZXcgQ2hpbGQoMCwgMCwgcmlnaHQpKQogICAgICAgIG5lZWRzU3BsaXQgPSBmYWxzZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2FwcGVuZChyb290LCBzZXEsIGtleSwgdmFsdWUpCiAgfQoKICBhc3luYyBkZWwgKGtleSwgb3B0cykgewogICAgY29uc3QgcmVsZWFzZSA9IHRoaXMuYmF0Y2hMb2NrID8gYXdhaXQgdGhpcy5iYXRjaExvY2soKSA6IG51bGwKICAgIGNvbnN0IGNhcyA9IChvcHRzICYmIG9wdHMuY2FzKSB8fCBudWxsCiAgICBjb25zdCBlbmNvZGluZyA9IHRoaXMuX2dldEVuY29kaW5nKG9wdHMpCgogICAgaWYgKCF0aGlzLmxvY2tlZCkgYXdhaXQgdGhpcy5sb2NrKCkKICAgIGlmICghcmVsZWFzZSkgcmV0dXJuIHRoaXMuX2RlbChrZXksIGVuY29kaW5nLCBjYXMpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2RlbChrZXksIGVuY29kaW5nLCBjYXMpCiAgICB9IGZpbmFsbHkgewogICAgICByZWxlYXNlKCkKICAgIH0KICB9CgogIGFzeW5jIF9kZWwgKGtleSwgZW5jb2RpbmcsIGNhcykgewogICAgY29uc3QgZGVsTm9kZSA9IHsKICAgICAgc2VxOiAwLAogICAgICBrZXksCiAgICAgIHZhbHVlOiBudWxsCiAgICB9CgogICAga2V5ID0gZW5jKGVuY29kaW5nLmtleSwga2V5KQoKICAgIGNvbnN0IHN0YWNrID0gW10KCiAgICBsZXQgbm9kZSA9IGF3YWl0IHRoaXMuZ2V0Um9vdCh0cnVlKQogICAgaWYgKCFub2RlKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQoKICAgIGNvbnN0IHNlcSA9IGRlbE5vZGUuc2VxID0gdGhpcy5jb3JlLmxlbmd0aCArIHRoaXMubGVuZ3RoCgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgc3RhY2sucHVzaChub2RlKQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKGtleSwgYXdhaXQgbm9kZS5nZXRLZXkobWlkKSkKCiAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgIGlmIChjYXMpIHsKICAgICAgICAgICAgY29uc3QgcHJldiA9IGF3YWl0IG5vZGUuZ2V0S2V5Tm9kZShtaWQpCiAgICAgICAgICAgIGlmICghKGF3YWl0IGNhcyhwcmV2LmZpbmFsKGVuY29kaW5nKSwgZGVsTm9kZSkpKSByZXR1cm4gdGhpcy5fdW5sb2NrTWF5YmUoKQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSBhd2FpdCBzZXRLZXlUb05lYXJlc3RMZWFmKG5vZGUsIG1pZCwgc3RhY2spCiAgICAgICAgICBlbHNlIG5vZGUucmVtb3ZlS2V5KG1pZCkKICAgICAgICAgIC8vIHdlIG1hcmsgdGhlc2UgYXMgY2hhbmdlZCBsYXRlLCBzbyB3ZSBkb24ndCByZXdyaXRlIHRoZW0gaWYgaXQgaXMgYSA0MDQKICAgICAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBzdGFjaykgbm9kZS5jaGFuZ2VkID0gdHJ1ZQogICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChhd2FpdCByZWJhbGFuY2Uoc3RhY2spLCBzZXEsIGtleSwgbnVsbCkKICAgICAgICB9CgogICAgICAgIGlmIChjIDwgMCkgZSA9IG1pZAogICAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgICAgfQoKICAgICAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkgcmV0dXJuIHRoaXMuX3VubG9ja01heWJlKCkKCiAgICAgIGNvbnN0IGkgPSBjIDwgMCA/IGUgOiBzCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgfQogIH0KCiAgYXN5bmMgX2Nsb3NlU25hcHNob3QgKCkgewogICAgaWYgKHRoaXMuaXNTbmFwc2hvdCkgewogICAgICBhd2FpdCB0aGlzLmNvcmUuY2xvc2UoKQogICAgICB0aGlzLl9maW5hbGl6ZSgpCiAgICB9CiAgfQoKICBhc3luYyBjbG9zZSAoKSB7CiAgICBpZiAodGhpcy5pc1NuYXBzaG90KSByZXR1cm4gdGhpcy5fY2xvc2VTbmFwc2hvdCgpCgogICAgdGhpcy5yb290ID0gbnVsbAogICAgaWYgKHRoaXMuYmxvY2tzKSB0aGlzLmJsb2Nrcy5jbGVhcigpCiAgICB0aGlzLmxlbmd0aCA9IDAKICAgIHRoaXMuX3VubG9jaygpCiAgfQoKICBkZXN0cm95ICgpIHsgLy8gY29tcGF0LCByZW1vdmUgbGF0ZXIKICAgIHRoaXMuY2xvc2UoKS5jYXRjaChub29wKQogIH0KCiAgdG9CbG9ja3MgKCkgewogICAgaWYgKHRoaXMuYXBwZW5kaW5nKSByZXR1cm4gdGhpcy5hcHBlbmRpbmcKCiAgICBjb25zdCBiYXRjaCA9IG5ldyBBcnJheSh0aGlzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgc2VxID0gdGhpcy5jb3JlLmxlbmd0aCArIGkKICAgICAgY29uc3QgeyBwZW5kaW5nSW5kZXgsIGtleSwgdmFsdWUgfSA9IHRoaXMuYmxvY2tzLmdldChzZXEpCgogICAgICBpZiAoaSA8IHRoaXMubGVuZ3RoIC0gMSkgewogICAgICAgIHBlbmRpbmdJbmRleFswXSA9IG51bGwKICAgICAgICBsZXQgaiA9IDAKCiAgICAgICAgd2hpbGUgKGogPCBwZW5kaW5nSW5kZXgubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBpZHggPSBwZW5kaW5nSW5kZXhbal0KICAgICAgICAgIGlmIChpZHggIT09IG51bGwgJiYgaWR4LnNlcSA9PT0gc2VxKSB7CiAgICAgICAgICAgIGlkeC5vZmZzZXQgPSBqKysKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KICAgICAgICAgIGlmIChqID09PSBwZW5kaW5nSW5kZXgubGVuZ3RoIC0gMSkgcGVuZGluZ0luZGV4LnBvcCgpCiAgICAgICAgICBlbHNlIHBlbmRpbmdJbmRleFtqXSA9IHBlbmRpbmdJbmRleC5wb3AoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgYmF0Y2hbaV0gPSBOb2RlLmVuY29kZSh7CiAgICAgICAga2V5LAogICAgICAgIHZhbHVlLAogICAgICAgIGluZGV4OiBkZWZsYXRlKHBlbmRpbmdJbmRleCkKICAgICAgfSkKICAgIH0KCiAgICB0aGlzLmFwcGVuZGluZyA9IGJhdGNoCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIGZsdXNoICgpIHsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzLmNsb3NlKCkKCiAgICBjb25zdCBiYXRjaCA9IHRoaXMudG9CbG9ja3MoKQoKICAgIHRoaXMucm9vdCA9IG51bGwKICAgIHRoaXMuYmxvY2tzLmNsZWFyKCkKICAgIHRoaXMubGVuZ3RoID0gMAoKICAgIHJldHVybiB0aGlzLl9hcHBlbmRCYXRjaChiYXRjaCkKICB9CgogIF91bmxvY2tNYXliZSAoKSB7CiAgICBpZiAodGhpcy5hdXRvRmx1c2gpIHRoaXMuX3VubG9jaygpCiAgfQoKICBfdW5sb2NrICgpIHsKICAgIGNvbnN0IGxvY2tlZCA9IHRoaXMubG9ja2VkCiAgICB0aGlzLmxvY2tlZCA9IG51bGwKICAgIGlmIChsb2NrZWQgIT09IG51bGwpIGxvY2tlZCgpCiAgICB0aGlzLl9maW5hbGl6ZSgpCiAgfQoKICBfZmluYWxpemUgKCkgewogICAgLy8gdGVjaG5pY2FsbHkgZmluYWxpemUgY2FuIGJlIGNhbGxlZCBtb3JlIHRoYW4gb25jZSwgc28gaGVyZSB3ZSBqdXN0IGNoZWNrIGlmIHdlIGFscmVhZHkgaGF2ZSBiZWVuIHJlbW92ZWQKICAgIGlmICh0aGlzLmluZGV4ID49IHRoaXMudHJlZS5fYmF0Y2hlcy5sZW5ndGggfHwgdGhpcy50cmVlLl9iYXRjaGVzW3RoaXMuaW5kZXhdICE9PSB0aGlzKSByZXR1cm4KICAgIGNvbnN0IHRvcCA9IHRoaXMudHJlZS5fYmF0Y2hlcy5wb3AoKQogICAgaWYgKHRvcCA9PT0gdGhpcykgcmV0dXJuCiAgICB0b3AuaW5kZXggPSB0aGlzLmluZGV4CiAgICB0aGlzLnRyZWUuX2JhdGNoZXNbdG9wLmluZGV4XSA9IHRvcAogIH0KCiAgX2FwcGVuZCAocm9vdCwgc2VxLCBrZXksIHZhbHVlKSB7CiAgICBjb25zdCBpbmRleCA9IFtdCiAgICByb290LmluZGV4Q2hhbmdlcyhpbmRleCwgc2VxKQogICAgaW5kZXhbMF0gPSBuZXcgQ2hpbGQoc2VxLCAwLCByb290KQoKICAgIGlmICghdGhpcy5hdXRvRmx1c2gpIHsKICAgICAgY29uc3QgYmxvY2sgPSBuZXcgQmF0Y2hFbnRyeShzZXEsIHRoaXMsIGtleSwgdmFsdWUsIGluZGV4KQogICAgICByb290LmJsb2NrID0gYmxvY2sKICAgICAgdGhpcy5yb290ID0gcm9vdAogICAgICB0aGlzLmxlbmd0aCsrCiAgICAgIHRoaXMuYmxvY2tzLnNldChzZXEsIGJsb2NrKQoKICAgICAgcm9vdC51cGRhdGVDaGlsZHJlbihzZXEsIGJsb2NrKQogICAgICByZXR1cm4KICAgIH0KCiAgICByZXR1cm4gdGhpcy5fYXBwZW5kQmF0Y2goTm9kZS5lbmNvZGUoewogICAgICBrZXksCiAgICAgIHZhbHVlLAogICAgICBpbmRleDogZGVmbGF0ZShpbmRleCkKICAgIH0pKQogIH0KCiAgYXN5bmMgX2FwcGVuZEJhdGNoIChyYXcpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuY29yZS5hcHBlbmQocmF3KQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdW5sb2NrKCkKICAgIH0KICB9Cn0KCmNsYXNzIEVudHJ5V2F0Y2hlciBleHRlbmRzIFJlYWR5UmVzb3VyY2UgewogIGNvbnN0cnVjdG9yIChiZWUsIGtleSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5rZXlFbmNvZGluZyA9IG9wdHMua2V5RW5jb2RpbmcgfHwgYmVlLmtleUVuY29kaW5nCiAgICB0aGlzLnZhbHVlRW5jb2RpbmcgPSBvcHRzLnZhbHVlRW5jb2RpbmcgfHwgYmVlLnZhbHVlRW5jb2RpbmcKCiAgICB0aGlzLmluZGV4ID0gYmVlLl9lbnRyeVdhdGNoZXJzLnB1c2godGhpcykgLSAxCiAgICB0aGlzLmJlZSA9IGJlZQoKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLm5vZGUgPSBudWxsCgogICAgdGhpcy5fZm9yY2VVcGRhdGUgPSBmYWxzZQogICAgdGhpcy5fZGVib3VuY2VkVXBkYXRlID0gZGVib3VuY2UodGhpcy5fcHJvY2Vzc1VwZGF0ZS5iaW5kKHRoaXMpKQogIH0KCiAgX2Nsb3NlICgpIHsKICAgIGNvbnN0IHRvcCA9IHRoaXMuYmVlLl9lbnRyeVdhdGNoZXJzLnBvcCgpCiAgICBpZiAodG9wICE9PSB0aGlzKSB7CiAgICAgIHRvcC5pbmRleCA9IHRoaXMuaW5kZXgKICAgICAgdGhpcy5iZWUuX2VudHJ5V2F0Y2hlcnNbdG9wLmluZGV4XSA9IHRvcAogICAgfQogIH0KCiAgX29uYXBwZW5kICgpIHsKICAgIHRoaXMuX2RlYm91bmNlZFVwZGF0ZSgpCiAgfQoKICBfb250cnVuY2F0ZSAoKSB7CiAgICB0aGlzLl9mb3JjZVVwZGF0ZSA9IHRydWUKICAgIHRoaXMuX2RlYm91bmNlZFVwZGF0ZSgpCiAgfQoKICBhc3luYyBfcHJvY2Vzc1VwZGF0ZSAoKSB7CiAgICBjb25zdCBmb3JjZSA9IHRoaXMuX2ZvcmNlVXBkYXRlCiAgICB0aGlzLl9mb3JjZVVwZGF0ZSA9IGZhbHNlCgogICAgbGV0IG5ld05vZGUKICAgIHRyeSB7CiAgICAgIG5ld05vZGUgPSBhd2FpdCB0aGlzLmJlZS5nZXQodGhpcy5rZXksIHsKICAgICAgICBrZXlFbmNvZGluZzogdGhpcy5rZXlFbmNvZGluZywKICAgICAgICB2YWx1ZUVuY29kaW5nOiB0aGlzLnZhbHVlRW5jb2RpbmcKICAgICAgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKGUuY29kZSA9PT0gJ1NOQVBTSE9UX05PVF9BVkFJTEFCTEUnKSB7CiAgICAgICAgLy8gVGhlcmUgd2FzIGEgdHJ1bmNhdGUgZXZlbnQgYmVmb3JlIHRoZSBnZXQgcmVzb2x2ZWQKICAgICAgICAvLyBTbyB0aGlzIGhhbmRsZXIgd2lsbCBydW4gYWdhaW4gYW55d2F5CiAgICAgICAgcmV0dXJuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5iZWUuY2xvc2luZykgewogICAgICAgIHRoaXMuY2xvc2UoKS5jYXRjaChzYWZldHlDYXRjaCkKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGZvcmNlIHx8IG5ld05vZGU/LnNlcSAhPT0gdGhpcy5ub2RlPy5zZXEpIHsKICAgICAgdGhpcy5ub2RlID0gbmV3Tm9kZQogICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICB9CiAgfQp9CgpjbGFzcyBXYXRjaGVyIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IgKGJlZSwgcmFuZ2UsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMua2V5RW5jb2RpbmcgPSBvcHRzLmtleUVuY29kaW5nIHx8IGJlZS5rZXlFbmNvZGluZwogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gb3B0cy52YWx1ZUVuY29kaW5nIHx8IGJlZS52YWx1ZUVuY29kaW5nCiAgICB0aGlzLmluZGV4ID0gYmVlLl93YXRjaGVycy5wdXNoKHRoaXMpIC0gMQogICAgdGhpcy5iZWUgPSBiZWUKICAgIHRoaXMuY29yZSA9IGJlZS5jb3JlCgogICAgdGhpcy5sYXRlc3REaWZmID0gMAogICAgdGhpcy5yYW5nZSA9IHJhbmdlCiAgICB0aGlzLm1hcCA9IG9wdHMubWFwIHx8IGRlZmF1bHRXYXRjaE1hcAoKICAgIHRoaXMuY3VycmVudCA9IG51bGwKICAgIHRoaXMucHJldmlvdXMgPSBudWxsCiAgICB0aGlzLmN1cnJlbnRNYXBwZWQgPSBudWxsCiAgICB0aGlzLnByZXZpb3VzTWFwcGVkID0gbnVsbAogICAgdGhpcy5zdHJlYW0gPSBudWxsCgogICAgdGhpcy5fbG9jayA9IG11dGV4aWZ5KCkKICAgIHRoaXMuX2Zsb3dpbmcgPSBmYWxzZQogICAgdGhpcy5fcmVzb2x2ZU9uQ2hhbmdlID0gbnVsbAogICAgdGhpcy5fZGlmZmVyID0gb3B0cy5kaWZmZXIgfHwgZGVmYXVsdERpZmZlcgogICAgdGhpcy5fZWFnZXIgPSAhIW9wdHMuZWFnZXIKICAgIHRoaXMuX29uY2hhbmdlID0gb3B0cy5vbmNoYW5nZSB8fCBudWxsCgogICAgdGhpcy5vbignbmV3TGlzdGVuZXInLCBhdXRvRmxvd09uVXBkYXRlKQoKICAgIHRoaXMucmVhZHkoKS5jYXRjaChzYWZldHlDYXRjaCkKICB9CgogIGFzeW5jIF9jb25zdW1lICgpIHsKICAgIGlmICh0aGlzLl9mbG93aW5nKSByZXR1cm4KICAgIHRyeSB7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgXyBvZiB0aGlzKSB7fSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICB9IGNhdGNoIHt9CiAgfQoKICBhc3luYyBfb3BlbiAoKSB7CiAgICBhd2FpdCB0aGlzLmJlZS5yZWFkeSgpCgogICAgY29uc3Qgb3B0cyA9IHsKICAgICAga2V5RW5jb2Rpbmc6IHRoaXMua2V5RW5jb2RpbmcsCiAgICAgIHZhbHVlRW5jb2Rpbmc6IHRoaXMudmFsdWVFbmNvZGluZwogICAgfQoKICAgIC8vIFBvaW50IGZyb20gd2hpY2ggdG8gc3RhcnQgd2F0Y2hpbmcKICAgIHRoaXMuY3VycmVudCA9IHRoaXMuX2VhZ2VyID8gdGhpcy5iZWUuY2hlY2tvdXQoMSwgb3B0cykgOiB0aGlzLmJlZS5zbmFwc2hvdChvcHRzKQogICAgYXdhaXQgdGhpcy5jdXJyZW50LnJlYWR5KCkKCiAgICBpZiAodGhpcy5fb25jaGFuZ2UpIHsKICAgICAgaWYgKHRoaXMuX2VhZ2VyKSBhd2FpdCB0aGlzLl9vbmNoYW5nZSgpCiAgICAgIHRoaXMuX2NvbnN1bWUoKQogICAgfQogIH0KCiAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSAoKSB7CiAgICB0aGlzLl9mbG93aW5nID0gdHJ1ZQogICAgcmV0dXJuIHRoaXMKICB9CgogIF9vbnRydW5jYXRlICgpIHsKICAgIHRoaXMuX29uYXBwZW5kKCkKICB9CgogIF9vbmFwcGVuZCAoKSB7CiAgICBjb25zdCByZXNvbHZlID0gdGhpcy5fcmVzb2x2ZU9uQ2hhbmdlCiAgICB0aGlzLl9yZXNvbHZlT25DaGFuZ2UgPSBudWxsCiAgICBpZiAocmVzb2x2ZSkgcmVzb2x2ZSgpCiAgfQoKICBhc3luYyBfd2FpdEZvckNoYW5nZXMgKCkgewogICAgaWYgKHRoaXMuY3VycmVudC52ZXJzaW9uIDwgdGhpcy5iZWUudmVyc2lvbiB8fCB0aGlzLmNsb3NpbmcpIHJldHVybgoKICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewogICAgICB0aGlzLl9yZXNvbHZlT25DaGFuZ2UgPSByZXNvbHZlCiAgICB9KQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fbmV4dCgpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9CiAgICAgIGF3YWl0IHRoaXMuY2xvc2UoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIF9uZXh0ICgpIHsKICAgIGNvbnN0IHJlbGVhc2UgPSBhd2FpdCB0aGlzLl9sb2NrKCkKCiAgICB0cnkgewogICAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4geyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0KCiAgICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBhd2FpdCB0aGlzLl93YWl0Rm9yQ2hhbmdlcygpCgogICAgICAgIGlmICh0aGlzLmNsb3NpbmcpIHJldHVybiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfQoKICAgICAgICBhd2FpdCB0aGlzLl9jbG9zZVByZXZpb3VzKCkKICAgICAgICB0aGlzLnByZXZpb3VzID0gdGhpcy5jdXJyZW50LnNuYXBzaG90KCkKCiAgICAgICAgYXdhaXQgdGhpcy5fY2xvc2VDdXJyZW50KCkKICAgICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLmJlZS5zbmFwc2hvdCh7CiAgICAgICAgICBrZXlFbmNvZGluZzogdGhpcy5rZXlFbmNvZGluZywKICAgICAgICAgIHZhbHVlRW5jb2Rpbmc6IHRoaXMudmFsdWVFbmNvZGluZwogICAgICAgIH0pCgogICAgICAgIGF3YWl0IHRoaXMuY3VycmVudC5yZWFkeSgpCiAgICAgICAgYXdhaXQgdGhpcy5wcmV2aW91cy5yZWFkeSgpCgogICAgICAgIGlmICh0aGlzLmN1cnJlbnQuY29yZS5mb3JrICE9PSB0aGlzLnByZXZpb3VzLmNvcmUuZm9yaykgewogICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3lpZWxkKCkKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RyZWFtID0gdGhpcy5fZGlmZmVyKHRoaXMuY3VycmVudCwgdGhpcy5wcmV2aW91cywgdGhpcy5yYW5nZSkKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiB0aGlzLnN0cmVhbSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl95aWVsZCgpCiAgICAgICAgICB9CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIHRoaXMuc3RyZWFtID0gbnVsbAogICAgICAgIH0KICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgcmVsZWFzZSgpCiAgICB9CiAgfQoKICBhc3luYyBfeWllbGQgKCkgewogICAgdGhpcy5jdXJyZW50TWFwcGVkID0gdGhpcy5tYXAodGhpcy5jdXJyZW50KQogICAgdGhpcy5wcmV2aW91c01hcHBlZCA9IHRoaXMubWFwKHRoaXMucHJldmlvdXMpCgogICAgaWYgKHRoaXMuX29uY2hhbmdlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5fb25jaGFuZ2UoKQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgICByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWU6IFt0aGlzLmN1cnJlbnRNYXBwZWQsIHRoaXMucHJldmlvdXNNYXBwZWRdIH0KICB9CgogIGFzeW5jIHJldHVybiAoKSB7CiAgICBhd2FpdCB0aGlzLmNsb3NlKCkKICAgIHJldHVybiB7IGRvbmU6IHRydWUgfQogIH0KCiAgYXN5bmMgX2Nsb3NlICgpIHsKICAgIGNvbnN0IHRvcCA9IHRoaXMuYmVlLl93YXRjaGVycy5wb3AoKQogICAgaWYgKHRvcCAhPT0gdGhpcykgewogICAgICB0b3AuaW5kZXggPSB0aGlzLmluZGV4CiAgICAgIHRoaXMuYmVlLl93YXRjaGVyc1t0b3AuaW5kZXhdID0gdG9wCiAgICB9CgogICAgaWYgKHRoaXMuc3RyZWFtICYmICF0aGlzLnN0cmVhbS5kZXN0cm95aW5nKSB7CiAgICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koKQogICAgfQoKICAgIHRoaXMuX29uYXBwZW5kKCkgLy8gQ29udGludWUgZXhlY3V0aW9uIGJlaW5nIGNsb3NlZAoKICAgIGF3YWl0IHRoaXMuX2Nsb3NlQ3VycmVudCgpLmNhdGNoKHNhZmV0eUNhdGNoKQogICAgYXdhaXQgdGhpcy5fY2xvc2VQcmV2aW91cygpLmNhdGNoKHNhZmV0eUNhdGNoKQoKICAgIGNvbnN0IHJlbGVhc2UgPSBhd2FpdCB0aGlzLl9sb2NrKCkKICAgIHJlbGVhc2UoKQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICByZXR1cm4gdGhpcy5jbG9zZSgpCiAgfQoKICBhc3luYyBfY2xvc2VDdXJyZW50ICgpIHsKICAgIGlmICh0aGlzLmN1cnJlbnRNYXBwZWQpIGF3YWl0IHRoaXMuY3VycmVudE1hcHBlZC5jbG9zZSgpCiAgICBpZiAodGhpcy5jdXJyZW50KSBhd2FpdCB0aGlzLmN1cnJlbnQuY2xvc2UoKQogICAgdGhpcy5jdXJyZW50ID0gdGhpcy5jdXJyZW50TWFwcGVkID0gbnVsbAogIH0KCiAgYXN5bmMgX2Nsb3NlUHJldmlvdXMgKCkgewogICAgaWYgKHRoaXMucHJldmlvdXNNYXBwZWQpIGF3YWl0IHRoaXMucHJldmlvdXNNYXBwZWQuY2xvc2UoKQogICAgaWYgKHRoaXMucHJldmlvdXMpIGF3YWl0IHRoaXMucHJldmlvdXMuY2xvc2UoKQogICAgdGhpcy5wcmV2aW91cyA9IHRoaXMucHJldmlvdXNNYXBwZWQgPSBudWxsCiAgfQp9CgpmdW5jdGlvbiBhdXRvRmxvd09uVXBkYXRlIChuYW1lKSB7CiAgaWYgKG5hbWUgPT09ICd1cGRhdGUnKSB0aGlzLl9jb25zdW1lKCkKfQoKZnVuY3Rpb24gZGVmYXVsdFdhdGNoTWFwIChzbmFwc2hvdCkgewogIHJldHVybiBzbmFwc2hvdAp9Cgphc3luYyBmdW5jdGlvbiBsZWFmU2l6ZSAobm9kZSwgZ29MZWZ0KSB7CiAgd2hpbGUgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSBub2RlID0gYXdhaXQgbm9kZS5nZXRDaGlsZE5vZGUoZ29MZWZ0ID8gMCA6IG5vZGUuY2hpbGRyZW4ubGVuZ3RoIC0gMSkKICByZXR1cm4gbm9kZS5rZXlzLmxlbmd0aAp9Cgphc3luYyBmdW5jdGlvbiBzZXRLZXlUb05lYXJlc3RMZWFmIChub2RlLCBpbmRleCwgc3RhY2spIHsKICBsZXQgW2xlZnQsIHJpZ2h0XSA9IGF3YWl0IFByb21pc2UuYWxsKFtub2RlLmdldENoaWxkTm9kZShpbmRleCksIG5vZGUuZ2V0Q2hpbGROb2RlKGluZGV4ICsgMSldKQogIGNvbnN0IFtscywgcnNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2xlYWZTaXplKGxlZnQsIGZhbHNlKSwgbGVhZlNpemUocmlnaHQsIHRydWUpXSkKCiAgaWYgKGxzIDwgcnMpIHsgLy8gaWYgZmV3ZXIgbGVhdmVzIG9uIHRoZSBsZWZ0CiAgICBzdGFjay5wdXNoKHJpZ2h0KQogICAgd2hpbGUgKHJpZ2h0LmNoaWxkcmVuLmxlbmd0aCkgc3RhY2sucHVzaChyaWdodCA9IHJpZ2h0LmNoaWxkcmVuWzBdLnZhbHVlKQogICAgbm9kZS5rZXlzW2luZGV4XSA9IHJpZ2h0LmtleXMuc2hpZnQoKQogIH0gZWxzZSB7IC8vIGlmIGZld2VyIGxlYXZlcyBvbiB0aGUgcmlnaHQKICAgIHN0YWNrLnB1c2gobGVmdCkKICAgIHdoaWxlIChsZWZ0LmNoaWxkcmVuLmxlbmd0aCkgc3RhY2sucHVzaChsZWZ0ID0gbGVmdC5jaGlsZHJlbltsZWZ0LmNoaWxkcmVuLmxlbmd0aCAtIDFdLnZhbHVlKQogICAgbm9kZS5rZXlzW2luZGV4XSA9IGxlZnQua2V5cy5wb3AoKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcmViYWxhbmNlIChzdGFjaykgewogIGNvbnN0IHJvb3QgPSBzdGFja1swXQoKICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMSkgewogICAgY29uc3Qgbm9kZSA9IHN0YWNrLnBvcCgpCiAgICBjb25zdCBwYXJlbnQgPSBzdGFja1tzdGFjay5sZW5ndGggLSAxXQoKICAgIGlmIChub2RlLmtleXMubGVuZ3RoID49IE1JTl9LRVlTKSByZXR1cm4gcm9vdAoKICAgIGxldCB7IGxlZnQsIGluZGV4LCByaWdodCB9ID0gYXdhaXQgbm9kZS5zaWJsaW5ncyhwYXJlbnQpCgogICAgLy8gbWF5YmUgYm9ycm93IGZyb20gbGVmdCBzaWJsaW5nPwogICAgaWYgKGxlZnQgJiYgbGVmdC5rZXlzLmxlbmd0aCA+IE1JTl9LRVlTKSB7CiAgICAgIGxlZnQuY2hhbmdlZCA9IHRydWUKICAgICAgbm9kZS5rZXlzLnVuc2hpZnQocGFyZW50LmtleXNbaW5kZXggLSAxXSkKICAgICAgaWYgKGxlZnQuY2hpbGRyZW4ubGVuZ3RoKSBub2RlLmNoaWxkcmVuLnVuc2hpZnQobGVmdC5jaGlsZHJlbi5wb3AoKSkKICAgICAgcGFyZW50LmtleXNbaW5kZXggLSAxXSA9IGxlZnQua2V5cy5wb3AoKQogICAgICByZXR1cm4gcm9vdAogICAgfQoKICAgIC8vIG1heWJlIGJvcnJvdyBmcm9tIHJpZ2h0IHNpYmxpbmc/CiAgICBpZiAocmlnaHQgJiYgcmlnaHQua2V5cy5sZW5ndGggPiBNSU5fS0VZUykgewogICAgICByaWdodC5jaGFuZ2VkID0gdHJ1ZQogICAgICBub2RlLmtleXMucHVzaChwYXJlbnQua2V5c1tpbmRleF0pCiAgICAgIGlmIChyaWdodC5jaGlsZHJlbi5sZW5ndGgpIG5vZGUuY2hpbGRyZW4ucHVzaChyaWdodC5jaGlsZHJlbi5zaGlmdCgpKQogICAgICBwYXJlbnQua2V5c1tpbmRleF0gPSByaWdodC5rZXlzLnNoaWZ0KCkKICAgICAgcmV0dXJuIHJvb3QKICAgIH0KCiAgICAvLyBtZXJnZSBub2RlIHdpdGggYW5vdGhlciBzaWJsaW5nCiAgICBpZiAobGVmdCkgewogICAgICBpbmRleC0tCiAgICAgIHJpZ2h0ID0gbm9kZQogICAgfSBlbHNlIHsKICAgICAgbGVmdCA9IG5vZGUKICAgIH0KCiAgICBsZWZ0Lm1lcmdlKHJpZ2h0LCBwYXJlbnQua2V5c1tpbmRleF0pCiAgICBwYXJlbnQucmVtb3ZlS2V5KGluZGV4KQogIH0KCiAgLy8gY2hlY2sgaWYgdGhlIHRyZWUgc2hydW5rCiAgaWYgKCFyb290LmtleXMubGVuZ3RoICYmIHJvb3QuY2hpbGRyZW4ubGVuZ3RoKSByZXR1cm4gcm9vdC5nZXRDaGlsZE5vZGUoMCkKICByZXR1cm4gcm9vdAp9CgpmdW5jdGlvbiBpdGVyYXRvclRvU3RyZWFtIChpdGUsIHNpZ25hbCkgewogIGxldCBkb25lCiAgbGV0IGNsb3NpbmcKCiAgY29uc3QgcnMgPSBuZXcgUmVhZGFibGUoewogICAgc2lnbmFsLAogICAgb3BlbiAoY2IpIHsKICAgICAgZG9uZSA9IGNiCiAgICAgIGl0ZS5vcGVuKCkudGhlbihmaW4sIGZpbikKICAgIH0sCiAgICByZWFkIChjYikgewogICAgICBkb25lID0gY2IKICAgICAgaXRlLm5leHQoKS50aGVuKHB1c2gsIGZpbikKICAgIH0sCiAgICBwcmVkZXN0cm95ICgpIHsKICAgICAgY2xvc2luZyA9IGl0ZS5jbG9zZSgpCiAgICAgIGNsb3NpbmcuY2F0Y2gobm9vcCkKICAgIH0sCiAgICBkZXN0cm95IChjYikgewogICAgICBkb25lID0gY2IKICAgICAgaWYgKCFjbG9zaW5nKSBjbG9zaW5nID0gaXRlLmNsb3NlKCkKICAgICAgY2xvc2luZy50aGVuKGZpbiwgZmluKQogICAgfQogIH0pCgogIHJldHVybiBycwoKICBmdW5jdGlvbiBmaW4gKGVycikgewogICAgZG9uZShlcnIpCiAgfQoKICBmdW5jdGlvbiBwdXNoICh2YWwpIHsKICAgIHJzLnB1c2godmFsKQogICAgZG9uZShudWxsKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gaXRlcmF0b3JQZWVrIChpdGUpIHsKICB0cnkgewogICAgYXdhaXQgaXRlLm9wZW4oKQogICAgcmV0dXJuIGF3YWl0IGl0ZS5uZXh0KCkKICB9IGZpbmFsbHkgewogICAgYXdhaXQgaXRlLmNsb3NlKCkKICB9Cn0KCmZ1bmN0aW9uIGVuY1JhbmdlIChlLCBvcHRzKSB7CiAgaWYgKCFlKSByZXR1cm4gb3B0cwoKICBpZiAoZS5lbmNvZGVSYW5nZSkgewogICAgY29uc3QgciA9IGUuZW5jb2RlUmFuZ2UoeyBndDogb3B0cy5ndCwgZ3RlOiBvcHRzLmd0ZSwgbHQ6IG9wdHMubHQsIGx0ZTogb3B0cy5sdGUgfSkKICAgIG9wdHMuZ3QgPSByLmd0CiAgICBvcHRzLmd0ZSA9IHIuZ3RlCiAgICBvcHRzLmx0ID0gci5sdAogICAgb3B0cy5sdGUgPSByLmx0ZQogICAgcmV0dXJuIG9wdHMKICB9CgogIGlmIChvcHRzLmd0ICE9PSB1bmRlZmluZWQpIG9wdHMuZ3QgPSBlbmMoZSwgb3B0cy5ndCkKICBpZiAob3B0cy5ndGUgIT09IHVuZGVmaW5lZCkgb3B0cy5ndGUgPSBlbmMoZSwgb3B0cy5ndGUpCiAgaWYgKG9wdHMubHQgIT09IHVuZGVmaW5lZCkgb3B0cy5sdCA9IGVuYyhlLCBvcHRzLmx0KQogIGlmIChvcHRzLmx0ZSAhPT0gdW5kZWZpbmVkKSBvcHRzLmx0ZSA9IGVuYyhlLCBvcHRzLmx0ZSkKICBpZiAob3B0cy5zdWIgJiYgIW9wdHMuZ3QgJiYgIW9wdHMuZ3RlKSBvcHRzLmd0ID0gZW5jKGUsIFNFUCkKICBpZiAob3B0cy5zdWIgJiYgIW9wdHMubHQgJiYgIW9wdHMubHRlKSBvcHRzLmx0ID0gYnVtcChlbmMoZSwgRU1QVFkpKQoKICByZXR1cm4gb3B0cwp9CgpmdW5jdGlvbiBidW1wIChrZXkpIHsKICAvLyBrZXkgc2hvdWxkIGhhdmUgYmVlbiBjb3BpZWQgYnkgZW5jIGFib3ZlIGJlZm9yZSBoaXR0aW5nIHRoaXMKICBrZXlba2V5Lmxlbmd0aCAtIDFdKysKICByZXR1cm4ga2V5Cn0KCmZ1bmN0aW9uIGVuYyAoZSwgdikgewogIGlmICh2ID09PSB1bmRlZmluZWQgfHwgdiA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICBpZiAoZSAhPT0gbnVsbCkgcmV0dXJuIGUuZW5jb2RlKHYpCiAgaWYgKHR5cGVvZiB2ID09PSAnc3RyaW5nJykgcmV0dXJuIGI0YS5mcm9tKHYpCiAgcmV0dXJuIHYKfQoKZnVuY3Rpb24gcHJlZml4RW5jb2RpbmcgKHByZWZpeCwga2V5RW5jb2RpbmcpIHsKICByZXR1cm4gewogICAgZW5jb2RlIChrZXkpIHsKICAgICAgcmV0dXJuIGI0YS5jb25jYXQoW3ByZWZpeCwgYjRhLmlzQnVmZmVyKGtleSkgPyBrZXkgOiBlbmMoa2V5RW5jb2RpbmcsIGtleSldKQogICAgfSwKICAgIGRlY29kZSAoa2V5KSB7CiAgICAgIGNvbnN0IHNsaWNlZCA9IGtleS5zbGljZShwcmVmaXgubGVuZ3RoLCBrZXkubGVuZ3RoKQogICAgICByZXR1cm4ga2V5RW5jb2RpbmcgPyBrZXlFbmNvZGluZy5kZWNvZGUoc2xpY2VkKSA6IHNsaWNlZAogICAgfQogIH0KfQoKZnVuY3Rpb24gY29weUVudHJ5IChlbnRyeSkgewogIGxldCBrZXkgPSBlbnRyeS5rZXkKICBsZXQgdmFsdWUgPSBlbnRyeS52YWx1ZQogIGxldCBpbmRleCA9IGVudHJ5LmluZGV4CgogIC8vIGtleSwgdmFsdWUgYW5kIGluZGV4IGFsbCByZWZlciB0byB0aGUgc2FtZSBidWZmZXIgKG9uZSBoeXBlcmNvcmUgYmxvY2spCiAgLy8gSWYgdG9nZXRoZXIgdGhleSBhcmUgbGFyZ2VyIHRoYW4gaGFsZiB0aGUgYnVmZmVyJ3MgYnl0ZUxlbmd0aCwKICAvLyB0aGlzIG1lYW5zIHRoYXQgdGhleSBnb3QgdGhlaXIgb3duIHByaXZhdGUgc2xhYiAoc2VlIEJ1ZmZlci5hbGxvY1Vuc2FmZSBkb2NzKQogIC8vIHNvIG5vIG5lZWQgdG8gdW5zbGFiCiAgY29uc3Qgc2l6ZSA9IGtleS5ieXRlTGVuZ3RoICsgKHZhbHVlID09PSBudWxsID8gMCA6IHZhbHVlLmJ5dGVMZW5ndGgpICsgKGluZGV4ID09PSBudWxsID8gMCA6IGluZGV4LmJ5dGVMZW5ndGgpCiAgaWYgKDIgKiBzaXplIDwga2V5LmJ1ZmZlci5ieXRlTGVuZ3RoKSB7CiAgICBjb25zdCBbbmV3S2V5LCBuZXdWYWx1ZSwgbmV3SW5kZXhdID0gdW5zbGFiQWxsKFtlbnRyeS5rZXksIGVudHJ5LnZhbHVlLCBlbnRyeS5pbmRleF0pCiAgICBrZXkgPSBuZXdLZXkKICAgIHZhbHVlID0gbmV3VmFsdWUKICAgIGluZGV4ID0gbmV3SW5kZXgKICB9CgogIHJldHVybiB7CiAgICBrZXksCiAgICB2YWx1ZSwKICAgIGluZGV4LAogICAgaW5mbGF0ZWQ6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGRlZmF1bHREaWZmZXIgKGN1cnJlbnRTbmFwLCBwcmV2aW91c1NuYXAsIG9wdHMpIHsKICByZXR1cm4gY3VycmVudFNuYXAuY3JlYXRlRGlmZlN0cmVhbShwcmV2aW91c1NuYXAsIG9wdHMpCn0KCmZ1bmN0aW9uIHRvTnVsbCAoKSB7CiAgcmV0dXJuIG51bGwKfQoKZnVuY3Rpb24gZ2V0QmFja2luZ0NvcmUgKGNvcmUpIHsKICBpZiAoY29yZS5jb3JlKSByZXR1cm4gY29yZQogIGlmIChjb3JlLmdldEJhY2tpbmdDb3JlKSByZXR1cm4gY29yZS5nZXRCYWNraW5nQ29yZSgpLnNlc3Npb24KICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBzYW1lVmFsdWUgKGEsIGIpIHsKICByZXR1cm4gYSA9PT0gYiB8fCAoYSAhPT0gbnVsbCAmJiBiICE9PSBudWxsICYmIGI0YS5lcXVhbHMoYSwgYikpCn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KCmZ1bmN0aW9uIGdldEV4dGVuc2lvbiAoZGIsIG9wdHMpIHsKICBpZiAob3B0cy5leHRlbnNpb24gPT09IGZhbHNlKSByZXR1cm4gbnVsbAogIGlmIChvcHRzLmV4dGVuc2lvbiAmJiBvcHRzLmV4dGVuc2lvbiAhPT0gdHJ1ZSkgcmV0dXJuIG9wdHMuZXh0ZW5zaW9uCiAgcmV0dXJuIEV4dGVuc2lvbi5yZWdpc3RlcihkYikKfQoKYXN5bmMgZnVuY3Rpb24gaXNMaW5rZWQgKGJhdGNoLCBibG9jaykgewogIGNvbnN0IHNlcSA9IGJsb2NrLnNlcQogIGJsb2NrLmluZmxhdGUoKQoKICBjb25zdCBrZXlzID0gW2Jsb2NrLmtleV0KICBjb25zdCB3YWl0ID0gYmF0Y2gub3B0aW9ucy53YWl0CgogIGZvciAoY29uc3QgbCBvZiBibG9jay5pbmRleC5sZXZlbHMpIHsKICAgIGlmICghbC5rZXlzLmxlbmd0aCkgY29udGludWUKICAgIGJhdGNoLm9wdGlvbnMud2FpdCA9IGZhbHNlCiAgICB0cnkgewogICAgICBrZXlzLnB1c2goYXdhaXQgYmF0Y2guZ2V0S2V5KGwua2V5c1swXS5zZXEpKQogICAgfSBjYXRjaCB7fQogICAgYmF0Y2gub3B0aW9ucy53YWl0ID0gd2FpdAogIH0KCiAgZm9yIChjb25zdCBrIG9mIGtleXMpIHsKICAgIGlmIChhd2FpdCBiYXRjaC5saW5rcyhrLCBzZXEpKSByZXR1cm4gdHJ1ZQogIH0KCiAgaWYgKGJhdGNoLmNvcmUuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdDb3JlIGlzIGNsb3NlZCcpCgogIHJldHVybiBmYWxzZQp9Cgptb2R1bGUuZXhwb3J0cyA9IEh5cGVyYmVlCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpjbGFzcyBTdWJUcmVlIHsKICBjb25zdHJ1Y3RvciAobm9kZSwgcGFyZW50KSB7CiAgICB0aGlzLm5vZGUgPSBub2RlCiAgICB0aGlzLnBhcmVudCA9IHBhcmVudAoKICAgIHRoaXMuaXNLZXkgPSBub2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMAogICAgdGhpcy5pID0gdGhpcy5pc0tleSA/IDEgOiAwCiAgICB0aGlzLm4gPSAwCgogICAgY29uc3QgY2hpbGQgPSB0aGlzLmlzS2V5ID8gbnVsbCA6IHRoaXMubm9kZS5jaGlsZHJlblswXQogICAgdGhpcy5zZXEgPSBjaGlsZCAhPT0gbnVsbCA/IGNoaWxkLnNlcSA6IHRoaXMubm9kZS5rZXlzWzBdLnNlcQogICAgdGhpcy5vZmZzZXQgPSBjaGlsZCAhPT0gbnVsbCA/IGNoaWxkLm9mZnNldCA6IDAKICB9CgogIG5leHQgKCkgewogICAgdGhpcy5pKysKICAgIHRoaXMuaXNLZXkgPSAodGhpcy5pICYgMSkgPT09IDEKICAgIGlmICghdGhpcy5pc0tleSAmJiAhdGhpcy5ub2RlLmNoaWxkcmVuLmxlbmd0aCkgdGhpcy5pKysKICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpCiAgfQoKICBhc3luYyBiaXNlY3QgKGtleSwgaW5jbCkgewogICAgbGV0IHMgPSAwCiAgICBsZXQgZSA9IHRoaXMubm9kZS5rZXlzLmxlbmd0aAogICAgbGV0IGMKCiAgICB3aGlsZSAocyA8IGUpIHsKICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgIGMgPSBjbXAoa2V5LCBhd2FpdCB0aGlzLm5vZGUuZ2V0S2V5KG1pZCkpCgogICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgIGlmIChpbmNsKSB0aGlzLmkgPSBtaWQgKiAyICsgMQogICAgICAgIGVsc2UgdGhpcy5pID0gbWlkICogMiArICh0aGlzLm5vZGUuY2hpbGRyZW4ubGVuZ3RoID8gMiA6IDMpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgIGVsc2UgcyA9IG1pZCArIDEKICAgIH0KCiAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgdGhpcy5pID0gMiAqIGkgKyAodGhpcy5ub2RlLmNoaWxkcmVuLmxlbmd0aCA/IDAgOiAxKQogICAgcmV0dXJuIHRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGggPT09IDAKICB9CgogIHVwZGF0ZSAoKSB7CiAgICB0aGlzLmlzS2V5ID0gKHRoaXMuaSAmIDEpID09PSAxCiAgICB0aGlzLm4gPSB0aGlzLmkgPj4gMQogICAgaWYgKHRoaXMubiA+PSAodGhpcy5pc0tleSA/IHRoaXMubm9kZS5rZXlzLmxlbmd0aCA6IHRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGgpKSByZXR1cm4gZmFsc2UKICAgIGNvbnN0IGNoaWxkID0gdGhpcy5pc0tleSA/IG51bGwgOiB0aGlzLm5vZGUuY2hpbGRyZW5bdGhpcy5uXQogICAgdGhpcy5zZXEgPSBjaGlsZCAhPT0gbnVsbCA/IGNoaWxkLnNlcSA6IHRoaXMubm9kZS5rZXlzW3RoaXMubl0uc2VxCiAgICB0aGlzLm9mZnNldCA9IGNoaWxkICE9PSBudWxsID8gY2hpbGQub2Zmc2V0IDogMAogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGtleSAoKSB7CiAgICByZXR1cm4gdGhpcy5uIDwgdGhpcy5ub2RlLmtleXMubGVuZ3RoID8gdGhpcy5ub2RlLmdldEtleSh0aGlzLm4pIDogKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmtleSgpKQogIH0KCiAgYXN5bmMgY29tcGFyZSAodHJlZSkgewogICAgY29uc3QgW2EsIGJdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3RoaXMua2V5KCksIHRyZWUua2V5KCldKQogICAgcmV0dXJuIGNtcChhLCBiKQogIH0KfQoKY2xhc3MgVHJlZUl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAoYmF0Y2gsIG9wdHMpIHsKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5zdGFjayA9IFtdCiAgICB0aGlzLmx0ID0gb3B0cy5sdCB8fCBvcHRzLmx0ZSB8fCBudWxsCiAgICB0aGlzLmx0ZSA9ICEhb3B0cy5sdGUKICAgIHRoaXMuZ3QgPSBvcHRzLmd0IHx8IG9wdHMuZ3RlIHx8IG51bGwKICAgIHRoaXMuZ3RlID0gISFvcHRzLmd0ZQogICAgdGhpcy5zZWVraW5nID0gISF0aGlzLmd0CiAgICB0aGlzLmVuY29kaW5nID0gb3B0cy5lbmNvZGluZyB8fCBiYXRjaC5lbmNvZGluZwogIH0KCiAgYXN5bmMgb3BlbiAoKSB7CiAgICBjb25zdCBub2RlID0gYXdhaXQgdGhpcy5iYXRjaC5nZXRSb290KGZhbHNlKQogICAgaWYgKCFub2RlIHx8ICFub2RlLmtleXMubGVuZ3RoKSByZXR1cm4KICAgIGNvbnN0IHRyZWUgPSBuZXcgU3ViVHJlZShub2RlLCBudWxsKQogICAgaWYgKHRoaXMuc2Vla2luZyAmJiAhKGF3YWl0IHRoaXMuX3NlZWsodHJlZSkpKSByZXR1cm4KICAgIHRoaXMuc3RhY2sucHVzaCh0cmVlKQogIH0KCiAgYXN5bmMgX3NlZWsgKHRyZWUpIHsKICAgIGNvbnN0IGRvbmUgPSBhd2FpdCB0cmVlLmJpc2VjdCh0aGlzLmd0LCB0aGlzLmd0ZSkKICAgIGNvbnN0IG9vYiA9ICF0cmVlLnVwZGF0ZSgpCiAgICBpZiAoZG9uZSB8fCBvb2IpIHsKICAgICAgdGhpcy5zZWVraW5nID0gZmFsc2UKICAgICAgaWYgKG9vYikgcmV0dXJuIGZhbHNlCiAgICB9CiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcGVlayAoKSB7CiAgICBpZiAoIXRoaXMuc3RhY2subGVuZ3RoKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGggLSAxXQogIH0KCiAgc2tpcCAoKSB7CiAgICBpZiAoIXRoaXMuc3RhY2subGVuZ3RoKSByZXR1cm4KICAgIGlmICghdGhpcy5zdGFja1t0aGlzLnN0YWNrLmxlbmd0aCAtIDFdLm5leHQoKSkgdGhpcy5zdGFjay5wb3AoKQogIH0KCiAgYXN5bmMgbmV4dEtleSAoKSB7CiAgICBsZXQgbiA9IG51bGwKICAgIHdoaWxlICh0aGlzLnN0YWNrLmxlbmd0aCAmJiBuID09PSBudWxsKSBuID0gYXdhaXQgdGhpcy5uZXh0KCkKICAgIGlmIChuID09PSBudWxsKSByZXR1cm4gbnVsbAogICAgaWYgKCF0aGlzLmx0KSByZXR1cm4gbi5maW5hbCh0aGlzLmVuY29kaW5nKQoKICAgIGNvbnN0IGMgPSBjbXAobi5rZXksIHRoaXMubHQpCiAgICBpZiAodGhpcy5sdGUgPyBjIDw9IDAgOiBjIDwgMCkgcmV0dXJuIG4uZmluYWwodGhpcy5lbmNvZGluZykKICAgIHRoaXMuc3RhY2sgPSBbXQogICAgcmV0dXJuIG51bGwKICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgaWYgKCF0aGlzLnN0YWNrLmxlbmd0aCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCB0b3AgPSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0KICAgIGNvbnN0IHsgaXNLZXksIG4sIHNlcSB9ID0gdG9wCgogICAgaWYgKCF0b3AubmV4dCgpKSB7CiAgICAgIHRoaXMuc3RhY2sucG9wKCkKICAgIH0KCiAgICBpZiAoaXNLZXkpIHsKICAgICAgdGhpcy5zZWVraW5nID0gZmFsc2UKICAgICAgcmV0dXJuIHRoaXMuYmF0Y2guZ2V0QmxvY2soc2VxKQogICAgfQoKICAgIGNvbnN0IGNoaWxkID0gYXdhaXQgdG9wLm5vZGUuZ2V0Q2hpbGROb2RlKG4pCiAgICB0b3Aubm9kZS5jaGlsZHJlbltuXSA9IG51bGwgLy8gdW5saW5rIHRvIHNhdmUgbWVtb3J5CiAgICBjb25zdCB0cmVlID0gbmV3IFN1YlRyZWUoY2hpbGQsIHRvcCkKICAgIGlmICh0aGlzLnNlZWtpbmcgJiYgIShhd2FpdCB0aGlzLl9zZWVrKHRyZWUpKSkgcmV0dXJuIG51bGwKICAgIHRoaXMuc3RhY2sucHVzaCh0cmVlKQoKICAgIHJldHVybiBudWxsCiAgfQoKICBjbG9zZSAoKSB7CiAgICByZXR1cm4gdGhpcy5iYXRjaC5fY2xvc2VTbmFwc2hvdCgpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIERpZmZJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKGxlZnQsIHJpZ2h0LCBvcHRzID0ge30pIHsKICAgIHRoaXMubGVmdCA9IG5ldyBUcmVlSXRlcmF0b3IobGVmdCwgb3B0cykKICAgIHRoaXMucmlnaHQgPSBuZXcgVHJlZUl0ZXJhdG9yKHJpZ2h0LCBvcHRzKQogICAgdGhpcy5saW1pdCA9IHR5cGVvZiBvcHRzLmxpbWl0ID09PSAnbnVtYmVyJyA/IG9wdHMubGltaXQgOiAtMQogIH0KCiAgYXN5bmMgb3BlbiAoKSB7CiAgICBhd2FpdCBQcm9taXNlLmFsbChbdGhpcy5sZWZ0Lm9wZW4oKSwgdGhpcy5yaWdodC5vcGVuKCldKQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICBpZiAodGhpcy5saW1pdCA9PT0gMCkgcmV0dXJuIG51bGwKICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuX25leHQoKQogICAgaWYgKCFyZXMgfHwgKHJlcy5sZWZ0ID09PSBudWxsICYmIHJlcy5yaWdodCA9PT0gbnVsbCkpIHJldHVybiBudWxsCiAgICB0aGlzLmxpbWl0LS0KICAgIHJldHVybiByZXMKICB9CgogIGFzeW5jIF9uZXh0ICgpIHsKICAgIGNvbnN0IGEgPSB0aGlzLmxlZnQKICAgIGNvbnN0IGIgPSB0aGlzLnJpZ2h0CgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgY29uc3QgW2wsIHJdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2EucGVlaygpLCBiLnBlZWsoKV0pCgogICAgICBpZiAoIWwgJiYgIXIpIHJldHVybiBudWxsCiAgICAgIGlmICghbCkgcmV0dXJuIHsgbGVmdDogbnVsbCwgcmlnaHQ6IGF3YWl0IGIubmV4dEtleSgpIH0KICAgICAgaWYgKCFyKSByZXR1cm4geyBsZWZ0OiBhd2FpdCBhLm5leHRLZXkoKSwgcmlnaHQ6IG51bGwgfQoKICAgICAgaWYgKGwuc2VxID09PSByLnNlcSAmJiBsLmlzS2V5ID09PSByLmlzS2V5ICYmIGwub2Zmc2V0ID09PSByLm9mZnNldCkgewogICAgICAgIGEuc2tpcCgpCiAgICAgICAgYi5za2lwKCkKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCBjID0gYXdhaXQgbC5jb21wYXJlKHIpCgogICAgICBpZiAobC5pc0tleSAmJiAhci5pc0tleSkgewogICAgICAgIGF3YWl0IGIubmV4dCgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKCFsLmlzS2V5ICYmIHIuaXNLZXkpIHsKICAgICAgICBhd2FpdCBhLm5leHQoKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmIChsLmlzS2V5ICYmIHIuaXNLZXkpIHsKICAgICAgICBpZiAoYyA9PT0gMCkgcmV0dXJuIHsgbGVmdDogYXdhaXQgYS5uZXh0S2V5KCksIHJpZ2h0OiBhd2FpdCBiLm5leHRLZXkoKSB9CiAgICAgICAgaWYgKGMgPCAwKSByZXR1cm4geyBsZWZ0OiBhd2FpdCBhLm5leHRLZXkoKSwgcmlnaHQ6IG51bGwgfQogICAgICAgIHJldHVybiB7IGxlZnQ6IG51bGwsIHJpZ2h0OiBhd2FpdCBiLm5leHRLZXkoKSB9CiAgICAgIH0KCiAgICAgIGlmIChjID09PSAwKSBhd2FpdCBQcm9taXNlLmFsbChbYS5uZXh0KCksIGIubmV4dCgpXSkKICAgICAgZWxzZSBpZiAoYyA8IDApIGF3YWl0IGIubmV4dCgpCiAgICAgIGVsc2UgYXdhaXQgYS5uZXh0KCkKICAgIH0KICB9CgogIGFzeW5jIGNsb3NlICgpIHsKICAgIGF3YWl0IFByb21pc2UuYWxsKFt0aGlzLmxlZnQuY2xvc2UoKSwgdGhpcy5yaWdodC5jbG9zZSgpXSkKICB9Cn0KCmZ1bmN0aW9uIGNtcCAoYSwgYikgewogIGlmICghYSkgcmV0dXJuIGIgPyAxIDogMAogIGlmICghYikgcmV0dXJuIGEgPyAtMSA6IDAKICByZXR1cm4gYjRhLmNvbXBhcmUoYSwgYikKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhpc3RvcnlJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKGJhdGNoLCBvcHRzID0ge30pIHsKICAgIHRoaXMuYmF0Y2ggPSBiYXRjaAogICAgdGhpcy5vcHRpb25zID0gb3B0cwogICAgdGhpcy5saXZlID0gISFvcHRzLmxpdmUKICAgIHRoaXMuZ3RlID0gMAogICAgdGhpcy5sdCA9IDAKICAgIHRoaXMucmV2ZXJzZSA9ICEhb3B0cy5yZXZlcnNlCiAgICB0aGlzLmxpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xCiAgICB0aGlzLmVuY29kaW5nID0gb3B0cy5lbmNvZGluZyB8fCBiYXRjaC5lbmNvZGluZwogICAgaWYgKHRoaXMubGl2ZSAmJiB0aGlzLnJldmVyc2UpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGF2ZSBib3RoIGxpdmUgYW5kIHJldmVyc2UgZW5hYmxlZCcpCiAgICB9CiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGF3YWl0IHRoaXMuYmF0Y2guZ2V0Um9vdChmYWxzZSkgLy8gZG9lcyB0aGUgdXBkYXRlIGRhbmNlCiAgICB0aGlzLmd0ZSA9IGd0ZSh0aGlzLm9wdGlvbnMsIHRoaXMuYmF0Y2gudmVyc2lvbikKICAgIHRoaXMubHQgPSB0aGlzLmxpdmUgPyBJbmZpbml0eSA6IGx0KHRoaXMub3B0aW9ucywgdGhpcy5iYXRjaC52ZXJzaW9uKQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICBpZiAodGhpcy5saW1pdCA9PT0gMCkgcmV0dXJuIG51bGwKICAgIGlmICh0aGlzLmxpbWl0ID4gMCkgdGhpcy5saW1pdC0tCgogICAgaWYgKHRoaXMuZ3RlID49IHRoaXMubHQpIHJldHVybiBudWxsCgogICAgaWYgKHRoaXMucmV2ZXJzZSkgewogICAgICBpZiAodGhpcy5sdCA8PSAxKSByZXR1cm4gbnVsbAogICAgICByZXR1cm4gZmluYWwoYXdhaXQgdGhpcy5iYXRjaC5nZXRCbG9jaygtLXRoaXMubHQpLCB0aGlzLmVuY29kaW5nKQogICAgfQoKICAgIHJldHVybiBmaW5hbChhd2FpdCB0aGlzLmJhdGNoLmdldEJsb2NrKHRoaXMuZ3RlKyspLCB0aGlzLmVuY29kaW5nKQogIH0KCiAgY2xvc2UgKCkgewogICAgcmV0dXJuIHRoaXMuYmF0Y2guX2Nsb3NlU25hcHNob3QoKQogIH0KfQoKZnVuY3Rpb24gZmluYWwgKG5vZGUsIGVuY29kaW5nKSB7CiAgY29uc3QgdHlwZSA9IG5vZGUuaXNEZWxldGlvbigpID8gJ2RlbCcgOiAncHV0JwogIHJldHVybiB7IHR5cGUsIC4uLm5vZGUuZmluYWwoZW5jb2RpbmcpIH0KfQoKZnVuY3Rpb24gZ3RlIChvcHRzLCB2ZXJzaW9uKSB7CiAgaWYgKG9wdHMuZ3QpIHJldHVybiAob3B0cy5ndCA8IDAgPyAob3B0cy5ndCArIHZlcnNpb24pIDogb3B0cy5ndCkgKyAxCiAgY29uc3QgZ3RlID0gb3B0cy5ndGUgfHwgb3B0cy5zaW5jZSB8fCAxCiAgcmV0dXJuIGd0ZSA8IDAgPyBndGUgKyB2ZXJzaW9uIDogZ3RlCn0KCmZ1bmN0aW9uIGx0IChvcHRzLCB2ZXJzaW9uKSB7CiAgaWYgKG9wdHMubHRlID09PSAwIHx8IG9wdHMubHQgPT09IDAgfHwgb3B0cy5lbmQgPT09IDApIHJldHVybiAwCiAgaWYgKG9wdHMubHRlKSByZXR1cm4gKG9wdHMubHRlIDwgMCA/IChvcHRzLmx0ZSArIHZlcnNpb24pIDogb3B0cy5sdGUpICsgMQogIGNvbnN0IGx0ID0gb3B0cy5sdCB8fCBvcHRzLmVuZCB8fCB2ZXJzaW9uCiAgcmV0dXJuIGx0IDwgMCA/IGx0ICsgdmVyc2lvbiA6IGx0Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBMb2NhbEJsb2Nrc0l0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAoYmF0Y2gsIG9wdHMgPSB7fSkgewogICAgdGhpcy5iYXRjaCA9IGJhdGNoCiAgICB0aGlzLm9wdGlvbnMgPSBvcHRzCiAgICB0aGlzLmd0ZSA9IDAKICAgIHRoaXMubHQgPSAwCiAgICB0aGlzLmxpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xCiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGF3YWl0IHRoaXMuYmF0Y2guZ2V0Um9vdChmYWxzZSkgLy8gZG9lcyB0aGUgdXBkYXRlIGRhbmNlCiAgICB0aGlzLmd0ZSA9IGd0ZSh0aGlzLm9wdGlvbnMsIHRoaXMuYmF0Y2gudmVyc2lvbikKICAgIHRoaXMubHQgPSBsdCh0aGlzLm9wdGlvbnMsIHRoaXMuYmF0Y2gudmVyc2lvbikKICB9CgogIGFzeW5jIG5leHQgKCkgewogICAgaWYgKHRoaXMubGltaXQgPT09IDApIHJldHVybiBudWxsCiAgICBpZiAodGhpcy5saW1pdCA+IDApIHRoaXMubGltaXQtLQoKICAgIHdoaWxlICh0aGlzLmd0ZSA8IHRoaXMubHQpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5iYXRjaC5nZXRCbG9jayh0aGlzLmd0ZSsrKQogICAgICB9IGNhdGNoIHsKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGNsb3NlICgpIHsKICAgIHJldHVybiB0aGlzLmJhdGNoLl9jbG9zZVNuYXBzaG90KCkKICB9Cn0KCmZ1bmN0aW9uIGd0ZSAob3B0cywgdmVyc2lvbikgewogIGlmIChvcHRzLmd0KSByZXR1cm4gKG9wdHMuZ3QgPCAwID8gKG9wdHMuZ3QgKyB2ZXJzaW9uKSA6IG9wdHMuZ3QpICsgMQogIGNvbnN0IGd0ZSA9IG9wdHMuZ3RlIHx8IG9wdHMuc2luY2UgfHwgMQogIHJldHVybiBndGUgPCAwID8gZ3RlICsgdmVyc2lvbiA6IGd0ZQp9CgpmdW5jdGlvbiBsdCAob3B0cywgdmVyc2lvbikgewogIGlmIChvcHRzLmx0ZSA9PT0gMCB8fCBvcHRzLmx0ID09PSAwIHx8IG9wdHMuZW5kID09PSAwKSByZXR1cm4gMAogIGlmIChvcHRzLmx0ZSkgcmV0dXJuIChvcHRzLmx0ZSA8IDAgPyAob3B0cy5sdGUgKyB2ZXJzaW9uKSA6IG9wdHMubHRlKSArIDEKICBjb25zdCBsdCA9IG9wdHMubHQgfHwgb3B0cy5lbmQgfHwgdmVyc2lvbgogIHJldHVybiBsdCA8IDAgPyBsdCArIHZlcnNpb24gOiBsdAp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJhbmdlSXRlcmF0b3IgewogIGNvbnN0cnVjdG9yIChiYXRjaCwgZW5jb2RpbmcsIG9wdHMgPSB7fSkgewogICAgdGhpcy5iYXRjaCA9IGJhdGNoCiAgICB0aGlzLnN0YWNrID0gW10KICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBiYXRjaC5lbmNvZGluZwoKICAgIHRoaXMuX2xpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xCiAgICB0aGlzLl9nSW5jbCA9ICFvcHRzLmd0CiAgICB0aGlzLl9nS2V5ID0gb3B0cy5ndCB8fCBvcHRzLmd0ZSB8fCBudWxsCiAgICB0aGlzLl9sSW5jbCA9ICFvcHRzLmx0CiAgICB0aGlzLl9sS2V5ID0gb3B0cy5sdCB8fCBvcHRzLmx0ZSB8fCBudWxsCiAgICB0aGlzLl9yZXZlcnNlID0gISFvcHRzLnJldmVyc2UKICAgIHRoaXMuX3ZlcnNpb24gPSAwCiAgICB0aGlzLl9jaGVja3BvaW50ID0gKG9wdHMuY2hlY2twb2ludCAmJiBvcHRzLmNoZWNrcG9pbnQubGVuZ3RoKSA/IG9wdHMuY2hlY2twb2ludCA6IG51bGwKICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogIH0KCiAgc25hcHNob3QgKHZlcnNpb24gPSB0aGlzLmJhdGNoLnZlcnNpb24pIHsKICAgIGNvbnN0IGNoZWNrcG9pbnQgPSBbXQogICAgZm9yIChjb25zdCBzIG9mIHRoaXMuc3RhY2spIHsKICAgICAgbGV0IHsgbm9kZSwgaSB9ID0gcwogICAgICBpZiAodGhpcy5fbmV4dGluZyAmJiBzID09PSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0pIGkgPSB0aGlzLl9yZXZlcnNlID8gaSArIDEgOiBpIC0gMQogICAgICBpZiAoIW5vZGUuYmxvY2spIGNvbnRpbnVlCiAgICAgIGlmIChpIDwgMCkgY29udGludWUKICAgICAgY2hlY2twb2ludC5wdXNoKG5vZGUuYmxvY2suc2VxLCBub2RlLm9mZnNldCwgaSkKICAgIH0KCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBndGU6IHRoaXMuX2dJbmNsID8gdGhpcy5fZ0tleSA6IG51bGwsCiAgICAgIGd0OiB0aGlzLl9nSW5jbCA/IG51bGwgOiB0aGlzLl9nS2V5LAogICAgICBsdGU6IHRoaXMuX2xJbmNsID8gdGhpcy5fbEtleSA6IG51bGwsCiAgICAgIGx0OiB0aGlzLl9sSW5jbCA/IG51bGwgOiB0aGlzLl9sS2V5LAogICAgICBsaW1pdDogdGhpcy5fbGltaXQsCiAgICAgIHJldmVyc2U6IHRoaXMuX3JldmVyc2UsCiAgICAgIGVuZGVkOiB0aGlzLm9wZW5lZCAmJiAhY2hlY2twb2ludC5sZW5ndGgsCiAgICAgIGNoZWNrcG9pbnQ6IHRoaXMub3BlbmVkID8gY2hlY2twb2ludCA6IFtdCiAgICB9CiAgfQoKICBhc3luYyBvcGVuICgpIHsKICAgIGF3YWl0IHRoaXMuX29wZW4oKQogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgfQoKICBhc3luYyBfb3BlbiAoKSB7CiAgICBpZiAodGhpcy5fY2hlY2twb2ludCkgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMuX2NoZWNrcG9pbnQubGVuZ3RoOyBqICs9IDMpIHsKICAgICAgICBjb25zdCBzZXEgPSB0aGlzLl9jaGVja3BvaW50W2pdCiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5fY2hlY2twb2ludFtqICsgMV0KICAgICAgICBjb25zdCBpID0gdGhpcy5fY2hlY2twb2ludFtqICsgMl0KICAgICAgICB0aGlzLnN0YWNrLnB1c2goewogICAgICAgICAgbm9kZTogKGF3YWl0IHRoaXMuYmF0Y2guZ2V0QmxvY2soc2VxKSkuZ2V0VHJlZU5vZGUob2Zmc2V0KSwKICAgICAgICAgIGkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX25leHRpbmcgPSB0cnVlCgogICAgbGV0IG5vZGUgPSBhd2FpdCB0aGlzLmJhdGNoLmdldFJvb3QoZmFsc2UpCiAgICBpZiAoIW5vZGUpIHsKICAgICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGluY2wgPSB0aGlzLl9yZXZlcnNlID8gdGhpcy5fbEluY2wgOiB0aGlzLl9nSW5jbAogICAgY29uc3Qgc3RhcnQgPSB0aGlzLl9yZXZlcnNlID8gdGhpcy5fbEtleSA6IHRoaXMuX2dLZXkKCiAgICBpZiAoIXN0YXJ0KSB7CiAgICAgIHRoaXMuc3RhY2sucHVzaCh7IG5vZGUsIGk6IHRoaXMuX3JldmVyc2UgPyBub2RlLmtleXMubGVuZ3RoIDw8IDEgOiAwIH0pCiAgICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBlbnRyeSA9IHsgbm9kZSwgaTogdGhpcy5fcmV2ZXJzZSA/IG5vZGUua2V5cy5sZW5ndGggPDwgMSA6IDAgfQoKICAgICAgbGV0IHMgPSAwCiAgICAgIGxldCBlID0gbm9kZS5rZXlzLmxlbmd0aAogICAgICBsZXQgYwoKICAgICAgd2hpbGUgKHMgPCBlKSB7CiAgICAgICAgY29uc3QgbWlkID0gKHMgKyBlKSA+PiAxCiAgICAgICAgYyA9IGI0YS5jb21wYXJlKHN0YXJ0LCBhd2FpdCBub2RlLmdldEtleShtaWQpKQoKICAgICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgICAgaWYgKGluY2wpIGVudHJ5LmkgPSBtaWQgKiAyICsgMQogICAgICAgICAgZWxzZSBlbnRyeS5pID0gbWlkICogMiArICh0aGlzLl9yZXZlcnNlID8gMCA6IDIpCiAgICAgICAgICB0aGlzLnN0YWNrLnB1c2goZW50cnkpCiAgICAgICAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaWYgKGMgPCAwKSBlID0gbWlkCiAgICAgICAgZWxzZSBzID0gbWlkICsgMQogICAgICB9CgogICAgICBjb25zdCBpID0gYyA8IDAgPyBlIDogcwogICAgICBlbnRyeS5pID0gMiAqIGkgKyAodGhpcy5fcmV2ZXJzZSA/IC0xIDogMSkKCiAgICAgIGlmIChlbnRyeS5pID49IDAgJiYgZW50cnkuaSA8PSAobm9kZS5rZXlzLmxlbmd0aCA8PCAxKSkgdGhpcy5zdGFjay5wdXNoKGVudHJ5KQogICAgICBpZiAoIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5fbmV4dGluZyA9IGZhbHNlCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIG5vZGUgPSBhd2FpdCBub2RlLmdldENoaWxkTm9kZShpKQogICAgfQogIH0KCiAgYXN5bmMgbmV4dCAoKSB7CiAgICAvLyBUT0RPOiB0aGlzIG5leHRpbmcgZmxhZyBpcyBvbmx5IG5lZWRlZCBpZiBzb21lb25lIGFza3MgZm9yIGEgc25hcHNob3QgZHVyaW5nCiAgICAvLyBhIGxvb2t1cCAoaWUgdGhlIGV4dGVuc2lvbiwgcHJldHR5IGltcG9ydGFudC4uLikuCiAgICAvLyBBIGJldHRlciBzb2x1dGlvbiB3b3VsZCBiZSB0byByZWZhY3RvciB0aGlzIHNvIHRvcC5pIGlzIGluY3JlbWVudGVkIGVhZ2VybHkKICAgIC8vIHRvIGdldCB0aGUgY3VycmVudCBibG9jayBpbnN0ZWFkIG9mIHRoZSB3YXkgaXQgaXMgZG9uZSBub3cgKCsraSB2cyBpKyspCiAgICB0aGlzLl9uZXh0aW5nID0gdHJ1ZQoKICAgIGNvbnN0IGVuZCA9IHRoaXMuX3JldmVyc2UgPyB0aGlzLl9nS2V5IDogdGhpcy5fbEtleQogICAgY29uc3QgaW5jbCA9IHRoaXMuX3JldmVyc2UgPyB0aGlzLl9nSW5jbCA6IHRoaXMuX2xJbmNsCgogICAgd2hpbGUgKHRoaXMuc3RhY2subGVuZ3RoICYmICh0aGlzLl9saW1pdCA9PT0gLTEgfHwgdGhpcy5fbGltaXQgPiAwKSkgewogICAgICBjb25zdCB0b3AgPSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV0KICAgICAgY29uc3QgaXNLZXkgPSAodG9wLmkgJiAxKSA9PT0gMQogICAgICBjb25zdCBuID0gdGhpcy5fcmV2ZXJzZQogICAgICAgID8gKHRvcC5pIDwgMCA/IHRvcC5ub2RlLmtleXMubGVuZ3RoIDogdG9wLmktLSA+PiAxKQogICAgICAgIDogdG9wLmkrKyA+PiAxCgogICAgICBpZiAoIWlzS2V5KSB7CiAgICAgICAgaWYgKCF0b3Aubm9kZS5jaGlsZHJlbi5sZW5ndGgpIGNvbnRpbnVlCiAgICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHRvcC5ub2RlLmdldENoaWxkTm9kZShuKQogICAgICAgIGlmICh0b3Aubm9kZS5ibG9jay5zZXEgPCB0aGlzLmJhdGNoLmNvcmUubGVuZ3RoKSB7CiAgICAgICAgICB0b3Aubm9kZS5jaGlsZHJlbltuXS52YWx1ZSA9IG51bGwgLy8gdW5saW5rIGl0IHRvIHNhdmUgbWVtb3J5CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhY2sucHVzaCh7IGk6IHRoaXMuX3JldmVyc2UgPyBub2RlLmtleXMubGVuZ3RoIDw8IDEgOiAwLCBub2RlIH0pCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgaWYgKG4gPj0gdG9wLm5vZGUua2V5cy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnN0YWNrLnBvcCgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3Qga2V5ID0gdG9wLm5vZGUua2V5c1tuXQogICAgICBjb25zdCBibG9jayA9IGF3YWl0IHRoaXMuYmF0Y2guZ2V0QmxvY2soa2V5LnNlcSkKICAgICAgaWYgKGVuZCkgewogICAgICAgIGNvbnN0IGMgPSBiNGEuY29tcGFyZShibG9jay5rZXksIGVuZCkKICAgICAgICBpZiAoYyA9PT0gMCA/ICFpbmNsIDogKHRoaXMuX3JldmVyc2UgPyBjIDwgMCA6IGMgPiAwKSkgewogICAgICAgICAgdGhpcy5fbGltaXQgPSAwCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodGhpcy5fbGltaXQgPiAwKSB0aGlzLl9saW1pdC0tCiAgICAgIHRoaXMuX25leHRpbmcgPSBmYWxzZQogICAgICByZXR1cm4gYmxvY2suZmluYWwodGhpcy5lbmNvZGluZykKICAgIH0KCiAgICB0aGlzLl9uZXh0aW5nID0gZmFsc2UKICAgIHJldHVybiBudWxsCiAgfQoKICBjbG9zZSAoKSB7CiAgICByZXR1cm4gdGhpcy5iYXRjaC5fY2xvc2VTbmFwc2hvdCgpCiAgfQp9CmNvbnN0IHsgRXh0ZW5zaW9uIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKCi8vIGNvbnN0IE1BWF9BQ1RJVkUgPSAzMgpjb25zdCBGTFVTSF9CQVRDSCA9IDEyOApjb25zdCBNQVhfUEFTU0lWRV9CQVRDSCA9IDIwNDgKY29uc3QgTUFYX0FDVElWRV9CQVRDSCA9IE1BWF9QQVNTSVZFX0JBVENIICsgRkxVU0hfQkFUQ0gKCmNsYXNzIEJhdGNoIHsKICBjb25zdHJ1Y3RvciAob3V0Z29pbmcsIGZyb20pIHsKICAgIHRoaXMuYmxvY2tzID0gW10KICAgIHRoaXMuc3RhcnQgPSAwCiAgICB0aGlzLmVuZCA9IDAKICAgIHRoaXMub3V0Z29pbmcgPSBvdXRnb2luZwogICAgdGhpcy5mcm9tID0gZnJvbQogIH0KCiAgcHVzaCAoc2VxKSB7CiAgICBjb25zdCBsZW4gPSB0aGlzLmJsb2Nrcy5wdXNoKHNlcSkKICAgIGlmIChsZW4gPT09IDEgfHwgc2VxIDwgdGhpcy5zdGFydCkgdGhpcy5zdGFydCA9IHNlcQogICAgaWYgKGxlbiA9PT0gMSB8fCBzZXEgPj0gdGhpcy5lbmQpIHRoaXMuZW5kID0gc2VxICsgMQogICAgaWYgKGxlbiA+PSBGTFVTSF9CQVRDSCkgewogICAgICB0aGlzLnNlbmQoKQogICAgICB0aGlzLmNsZWFyKCkKICAgIH0KICB9CgogIHNlbmQgKCkgewogICAgaWYgKCF0aGlzLmJsb2Nrcy5sZW5ndGgpIHJldHVybgogICAgdGhpcy5vdXRnb2luZy5zZW5kKEV4dGVuc2lvbi5lbmNvZGUoeyBjYWNoZTogeyBibG9ja3M6IHRoaXMuYmxvY2tzLCBzdGFydDogdGhpcy5zdGFydCwgZW5kOiB0aGlzLmVuZCB9IH0pLCB0aGlzLmZyb20pCiAgfQoKICBjbGVhciAoKSB7CiAgICB0aGlzLnN0YXJ0ID0gdGhpcy5lbmQgPSAwCiAgICB0aGlzLmJsb2NrcyA9IFtdCiAgfQp9CgpjbGFzcyBIeXBlcmJlZUV4dGVuc2lvbiB7CiAgY29uc3RydWN0b3IgKGRiKSB7CiAgICB0aGlzLmVuY29kaW5nID0gbnVsbAogICAgdGhpcy5vdXRnb2luZyA9IG51bGwKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy5hY3RpdmUgPSAwCiAgfQoKICBnZXQgKHZlcnNpb24sIGtleSkgewogICAgdGhpcy5vdXRnb2luZy5icm9hZGNhc3QoRXh0ZW5zaW9uLmVuY29kZSh7IGdldDogeyB2ZXJzaW9uLCBrZXkgfSB9KSkKICB9CgogIGl0ZXJhdG9yIChzbmFwc2hvdCkgewogICAgaWYgKHNuYXBzaG90LmVuZGVkKSByZXR1cm4KICAgIGlmIChzbmFwc2hvdC5saW1pdCA9PT0gMCkgcmV0dXJuCiAgICBpZiAoc25hcHNob3QubGltaXQgPT09IC0xKSBzbmFwc2hvdC5saW1pdCA9IDAKICAgIHRoaXMub3V0Z29pbmcuYnJvYWRjYXN0KEV4dGVuc2lvbi5lbmNvZGUoeyBpdGVyYXRvcjogc25hcHNob3QgfSkpCiAgfQoKICBvbm1lc3NhZ2UgKGJ1ZiwgZnJvbSkgewogICAgLy8gVE9ETzogaGFuZGxlIG1heCBhY3RpdmUgZXh0ZW5zaW9uIG1lc3NhZ2VzCiAgICAvLyB0aGlzLmFjdGl2ZSsrCgogICAgY29uc3QgbWVzc2FnZSA9IGRlY29kZShidWYpCiAgICBpZiAoIW1lc3NhZ2UpIHJldHVybgoKICAgIGlmIChtZXNzYWdlLmNhY2hlKSB0aGlzLm9uY2FjaGUobWVzc2FnZS5jYWNoZSwgZnJvbSkKICAgIGlmIChtZXNzYWdlLmdldCkgdGhpcy5vbmdldChtZXNzYWdlLmdldCwgZnJvbSkKICAgIGlmIChtZXNzYWdlLml0ZXJhdG9yKSB0aGlzLm9uaXRlcmF0b3IobWVzc2FnZS5pdGVyYXRvciwgZnJvbSkKICB9CgogIG9uY2FjaGUgKG1lc3NhZ2UsIGZyb20pIHsKICAgIGlmICghbWVzc2FnZS5ibG9ja3MubGVuZ3RoKSByZXR1cm4KICAgIHRoaXMuZGIuY29yZS5kb3dubG9hZChtZXNzYWdlKQogIH0KCiAgb25nZXQgKG1lc3NhZ2UsIGZyb20pIHsKICAgIGlmICghbWVzc2FnZS52ZXJzaW9uIHx8IG1lc3NhZ2UudmVyc2lvbiA+IHRoaXMuZGIudmVyc2lvbikgcmV0dXJuCgogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLm91dGdvaW5nLCBmcm9tKQogICAgY29uc3QgZGIgPSB0aGlzLmRiLmNoZWNrb3V0KG1lc3NhZ2UudmVyc2lvbikKCiAgICBkYi5nZXQobWVzc2FnZS5rZXksIHsgZXh0ZW5zaW9uOiBmYWxzZSwgd2FpdDogZmFsc2UsIHVwZGF0ZTogZmFsc2UsIG9uc2VxIH0pLnRoZW4oZG9uZSwgZG9uZSkKCiAgICBmdW5jdGlvbiBkb25lICgpIHsKICAgICAgZGIuY2xvc2UoKS5jYXRjaChub29wKQogICAgICBiLnNlbmQoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uc2VxIChzZXEpIHsKICAgICAgYi5wdXNoKHNlcSkKICAgIH0KICB9CgogIGFzeW5jIG9uaXRlcmF0b3IgKG1lc3NhZ2UsIGZyb20pIHsKICAgIGlmICghbWVzc2FnZS52ZXJzaW9uIHx8IG1lc3NhZ2UudmVyc2lvbiA+IHRoaXMuZGIudmVyc2lvbikgcmV0dXJuCgogICAgY29uc3QgYiA9IG5ldyBCYXRjaCh0aGlzLm91dGdvaW5nLCBmcm9tKQogICAgY29uc3Qgc2VxcyA9IG5ldyBTZXQoKQoKICAgIGxldCBza2lwID0gbWVzc2FnZS5jaGVja3BvaW50Lmxlbmd0aAogICAgbGV0IHdvcmsgPSAwCgogICAgY29uc3QgZGIgPSB0aGlzLmRiLmNoZWNrb3V0KG1lc3NhZ2UudmVyc2lvbikKICAgIGNvbnN0IGl0ZSA9IGRiLmNyZWF0ZVJhbmdlSXRlcmF0b3IoewogICAgICAuLi5tZXNzYWdlLAogICAgICB3YWl0OiBmYWxzZSwKICAgICAgZXh0ZW5zaW9uOiBmYWxzZSwKICAgICAgdXBkYXRlOiBmYWxzZSwKICAgICAgbGltaXQ6IG1lc3NhZ2UubGltaXQgPT09IDAgPyAtMSA6IG1lc3NhZ2UubGltaXQsCiAgICAgIG9uc2VxIChzZXEpIHsKICAgICAgICBpZiAoc2tpcCAmJiBza2lwLS0pIHJldHVybgogICAgICAgIGlmIChzZXFzLmhhcyhzZXEpKSByZXR1cm4KICAgICAgICB3b3JrKysKICAgICAgICBzZXFzLmFkZChzZXEpCiAgICAgICAgYi5wdXNoKHNlcSkKICAgICAgfQogICAgfSkKCiAgICB0cnkgewogICAgICBhd2FpdCBpdGUub3BlbigpCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bm1vZGlmaWVkLWxvb3AtY29uZGl0aW9uCiAgICAgIHdoaWxlICh3b3JrIDwgTUFYX0FDVElWRV9CQVRDSCkgewogICAgICAgIGlmICghKGF3YWl0IGl0ZS5uZXh0KCkpKSBicmVhawogICAgICB9CiAgICB9IGNhdGNoIChfKSB7CiAgICAgIC8vIGRvIG5vdGhpbmcKICAgIH0gZmluYWxseSB7CiAgICAgIGl0ZS5jbG9zZSgpLmNhdGNoKG5vb3ApCiAgICAgIGRiLmNsb3NlKCkuY2F0Y2gobm9vcCkKICAgICAgYi5zZW5kKCkKICAgIH0KICB9CgogIHN0YXRpYyByZWdpc3RlciAoZGIpIHsKICAgIGNvbnN0IGUgPSBuZXcgdGhpcyhkYikKICAgIGUub3V0Z29pbmcgPSBkYi5jb3JlLnJlZ2lzdGVyRXh0ZW5zaW9uKCdoeXBlcmJlZScsIGUpCiAgICByZXR1cm4gZQogIH0KfQoKSHlwZXJiZWVFeHRlbnNpb24uQkFUQ0hfU0laRSA9IE1BWF9QQVNTSVZFX0JBVENICgptb2R1bGUuZXhwb3J0cyA9IEh5cGVyYmVlRXh0ZW5zaW9uCgpmdW5jdGlvbiBkZWNvZGUgKGJ1ZikgewogIHRyeSB7CiAgICByZXR1cm4gRXh0ZW5zaW9uLmRlY29kZShidWYpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQovLyBUaGlzIGZpbGUgaXMgYXV0byBnZW5lcmF0ZWQgYnkgdGhlIHByb3RvY29sLWJ1ZmZlcnMgY29tcGlsZXIKCi8qIGVzbGludC1kaXNhYmxlIHF1b3RlcyAqLwovKiBlc2xpbnQtZGlzYWJsZSBpbmRlbnQgKi8KLyogZXNsaW50LWRpc2FibGUgbm8tcmVkZWNsYXJlICovCi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBuby12YXIgKi8KCi8vIFJlbWVtYmVyIHRvIGBucG0gaW5zdGFsbCAtLXNhdmUgcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3NgCnZhciBlbmNvZGluZ3MgPSByZXF1aXJlKCdwcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncycpCnZhciBiNGEgPSByZXF1aXJlKCdiNGEnKQp2YXIgdmFyaW50ID0gZW5jb2RpbmdzLnZhcmludAp2YXIgc2tpcCA9IGVuY29kaW5ncy5za2lwCgp2YXIgWW9sb0luZGV4ID0gZXhwb3J0cy5Zb2xvSW5kZXggPSB7CiAgYnVmZmVyOiB0cnVlLAogIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogIGVuY29kZTogbnVsbCwKICBkZWNvZGU6IG51bGwKfQoKdmFyIEhlYWRlciA9IGV4cG9ydHMuSGVhZGVyID0gewogIGJ1ZmZlcjogdHJ1ZSwKICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICBlbmNvZGU6IG51bGwsCiAgZGVjb2RlOiBudWxsCn0KCnZhciBOb2RlID0gZXhwb3J0cy5Ob2RlID0gewogIGJ1ZmZlcjogdHJ1ZSwKICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICBlbmNvZGU6IG51bGwsCiAgZGVjb2RlOiBudWxsCn0KCnZhciBFeHRlbnNpb24gPSBleHBvcnRzLkV4dGVuc2lvbiA9IHsKICBidWZmZXI6IHRydWUsCiAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgZW5jb2RlOiBudWxsLAogIGRlY29kZTogbnVsbAp9CgpkZWZpbmVZb2xvSW5kZXgoKQpkZWZpbmVIZWFkZXIoKQpkZWZpbmVOb2RlKCkKZGVmaW5lRXh0ZW5zaW9uKCkKCmZ1bmN0aW9uIGRlZmluZVlvbG9JbmRleCAoKSB7CiAgdmFyIExldmVsID0gWW9sb0luZGV4LkxldmVsID0gewogICAgYnVmZmVyOiB0cnVlLAogICAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgICBlbmNvZGU6IG51bGwsCiAgICBkZWNvZGU6IG51bGwKICB9CgogIGRlZmluZUxldmVsKCkKCiAgZnVuY3Rpb24gZGVmaW5lTGV2ZWwgKCkgewogICAgTGV2ZWwuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogICAgTGV2ZWwuZW5jb2RlID0gZW5jb2RlCiAgICBMZXZlbC5kZWNvZGUgPSBkZWNvZGUKCiAgICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICAgIHZhciBsZW5ndGggPSAwCiAgICAgIGlmIChkZWZpbmVkKG9iai5rZXlzKSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5rZXlzW2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5rZXlzW2ldKQogICAgICAgICAgcGFja2VkTGVuICs9IGxlbgogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBsZW5ndGggKz0gMSArIHBhY2tlZExlbiArIHZhcmludC5lbmNvZGluZ0xlbmd0aChwYWNrZWRMZW4pCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5jaGlsZHJlbikpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoaWxkcmVuW2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5jaGlsZHJlbltpXSkKICAgICAgICAgIHBhY2tlZExlbiArPSBsZW4KICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgbGVuZ3RoICs9IDEgKyBwYWNrZWRMZW4gKyB2YXJpbnQuZW5jb2RpbmdMZW5ndGgocGFja2VkTGVuKQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbGVuZ3RoCiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICBpZiAoZGVmaW5lZChvYmoua2V5cykpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmoua2V5c1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICBwYWNrZWRMZW4gKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGluZ0xlbmd0aChvYmoua2V5c1tpXSkKICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICAgICAgICB2YXJpbnQuZW5jb2RlKHBhY2tlZExlbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmtleXNbaV0pKSBjb250aW51ZQogICAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLmtleXNbaV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5jaGlsZHJlbikpIHsKICAgICAgICB2YXIgcGFja2VkTGVuID0gMAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoaWxkcmVuW2ldKSkgY29udGludWUKICAgICAgICAgIHBhY2tlZExlbiArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5jaGlsZHJlbltpXSkKICAgICAgICB9CiAgICAgICAgaWYgKHBhY2tlZExlbikgewogICAgICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgICAgICB2YXJpbnQuZW5jb2RlKHBhY2tlZExlbiwgYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGlsZHJlbltpXSkpIGNvbnRpbnVlCiAgICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouY2hpbGRyZW5baV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgfQogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIGtleXM6IFtdLAogICAgICAgIGNoaWxkcmVuOiBbXQogICAgICB9CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgICAgcmV0dXJuIG9iagogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICB2YXIgcGFja2VkRW5kID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBwYWNrZWRFbmQgKz0gb2Zmc2V0CiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgcGFja2VkRW5kKSB7CiAgICAgICAgICAgIG9iai5rZXlzLnB1c2goZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpKQogICAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICB2YXIgcGFja2VkRW5kID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBwYWNrZWRFbmQgKz0gb2Zmc2V0CiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgcGFja2VkRW5kKSB7CiAgICAgICAgICAgIG9iai5jaGlsZHJlbi5wdXNoKGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KSkKICAgICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBZb2xvSW5kZXguZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogIFlvbG9JbmRleC5lbmNvZGUgPSBlbmNvZGUKICBZb2xvSW5kZXguZGVjb2RlID0gZGVjb2RlCgogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgIHZhciBsZW5ndGggPSAwCiAgICBpZiAoZGVmaW5lZChvYmoubGV2ZWxzKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5sZXZlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWRlZmluZWQob2JqLmxldmVsc1tpXSkpIGNvbnRpbnVlCiAgICAgICAgdmFyIGxlbiA9IExldmVsLmVuY29kaW5nTGVuZ3RoKG9iai5sZXZlbHNbaV0pCiAgICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgfQogICAgcmV0dXJuIGxlbmd0aAogIH0KCiAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgaWYgKGRlZmluZWQob2JqLmxldmVscykpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoubGV2ZWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5sZXZlbHNbaV0pKSBjb250aW51ZQogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgICAgIHZhcmludC5lbmNvZGUoTGV2ZWwuZW5jb2RpbmdMZW5ndGgob2JqLmxldmVsc1tpXSksIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgICAgTGV2ZWwuZW5jb2RlKG9iai5sZXZlbHNbaV0sIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBMZXZlbC5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgfQogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmCiAgfQoKICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIG9iaiA9IHsKICAgICAgbGV2ZWxzOiBbXQogICAgfQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgMToKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5sZXZlbHMucHVzaChMZXZlbC5kZWNvZGUoYnVmLCBvZmZzZXQsIG9mZnNldCArIGxlbikpCiAgICAgICAgb2Zmc2V0ICs9IExldmVsLmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgZGVmYXVsdDoKICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVIZWFkZXIgKCkgewogIHZhciBNZXRhZGF0YSA9IEhlYWRlci5NZXRhZGF0YSA9IHsKICAgIGJ1ZmZlcjogdHJ1ZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogICAgZW5jb2RlOiBudWxsLAogICAgZGVjb2RlOiBudWxsCiAgfQoKICBkZWZpbmVNZXRhZGF0YSgpCgogIGZ1bmN0aW9uIGRlZmluZU1ldGFkYXRhICgpIHsKICAgIE1ldGFkYXRhLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICAgIE1ldGFkYXRhLmVuY29kZSA9IGVuY29kZQogICAgTWV0YWRhdGEuZGVjb2RlID0gZGVjb2RlCgogICAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgICB2YXIgbGVuZ3RoID0gMAogICAgICBpZiAoZGVmaW5lZChvYmouY29udGVudEZlZWQpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmouY29udGVudEZlZWQpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoudXNlckRhdGEpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoudXNlckRhdGEpCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICByZXR1cm4gbGVuZ3RoCiAgICB9CgogICAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghYnVmKSBidWYgPSBiNGEuYWxsb2NVbnNhZmUoZW5jb2RpbmdMZW5ndGgob2JqKSkKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICBpZiAoZGVmaW5lZChvYmouY29udGVudEZlZWQpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmouY29udGVudEZlZWQsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLnVzZXJEYXRhKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAxOAogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLnVzZXJEYXRhLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIGNvbnRlbnRGZWVkOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBudWxsCiAgICAgIH0KICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgIG9iai5jb250ZW50RmVlZCA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIG9iai51c2VyRGF0YSA9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgSGVhZGVyLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICBIZWFkZXIuZW5jb2RlID0gZW5jb2RlCiAgSGVhZGVyLmRlY29kZSA9IGRlY29kZQoKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAob2JqKSB7CiAgICB2YXIgbGVuZ3RoID0gMAogICAgaWYgKCFkZWZpbmVkKG9iai5wcm90b2NvbCkpIHRocm93IG5ldyBFcnJvcigicHJvdG9jb2wgaXMgcmVxdWlyZWQiKQogICAgdmFyIGxlbiA9IGVuY29kaW5ncy5zdHJpbmcuZW5jb2RpbmdMZW5ndGgob2JqLnByb3RvY29sKQogICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIGlmIChkZWZpbmVkKG9iai5tZXRhZGF0YSkpIHsKICAgICAgdmFyIGxlbiA9IE1ldGFkYXRhLmVuY29kaW5nTGVuZ3RoKG9iai5tZXRhZGF0YSkKICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICB9CiAgICByZXR1cm4gbGVuZ3RoCiAgfQoKICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICBpZiAoIWRlZmluZWQob2JqLnByb3RvY29sKSkgdGhyb3cgbmV3IEVycm9yKCJwcm90b2NvbCBpcyByZXF1aXJlZCIpCiAgICBidWZbb2Zmc2V0KytdID0gMTAKICAgIGVuY29kaW5ncy5zdHJpbmcuZW5jb2RlKG9iai5wcm90b2NvbCwgYnVmLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnN0cmluZy5lbmNvZGUuYnl0ZXMKICAgIGlmIChkZWZpbmVkKG9iai5tZXRhZGF0YSkpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgIHZhcmludC5lbmNvZGUoTWV0YWRhdGEuZW5jb2RpbmdMZW5ndGgob2JqLm1ldGFkYXRhKSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIE1ldGFkYXRhLmVuY29kZShvYmoubWV0YWRhdGEsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gTWV0YWRhdGEuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWYKICB9CgogIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgb2JqID0gewogICAgICBwcm90b2NvbDogIiIsCiAgICAgIG1ldGFkYXRhOiBudWxsCiAgICB9CiAgICB2YXIgZm91bmQwID0gZmFsc2UKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgaWYgKCFmb3VuZDApIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgcmV0dXJuIG9iagogICAgICB9CiAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgb2JqLnByb3RvY29sID0gZW5jb2RpbmdzLnN0cmluZy5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5zdHJpbmcuZGVjb2RlLmJ5dGVzCiAgICAgICAgZm91bmQwID0gdHJ1ZQogICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAyOgogICAgICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgb2JqLm1ldGFkYXRhID0gTWV0YWRhdGEuZGVjb2RlKGJ1Ziwgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICAgICAgb2Zmc2V0ICs9IE1ldGFkYXRhLmRlY29kZS5ieXRlcwogICAgICAgIGJyZWFrCiAgICAgICAgZGVmYXVsdDoKICAgICAgICBvZmZzZXQgPSBza2lwKHByZWZpeCAmIDcsIGJ1Ziwgb2Zmc2V0KQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVOb2RlICgpIHsKICBOb2RlLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICBOb2RlLmVuY29kZSA9IGVuY29kZQogIE5vZGUuZGVjb2RlID0gZGVjb2RlCgogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgIHZhciBsZW5ndGggPSAwCiAgICBpZiAoIWRlZmluZWQob2JqLmluZGV4KSkgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyByZXF1aXJlZCIpCiAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5pbmRleCkKICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICBpZiAoIWRlZmluZWQob2JqLmtleSkpIHRocm93IG5ldyBFcnJvcigia2V5IGlzIHJlcXVpcmVkIikKICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmtleSkKICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICBpZiAoZGVmaW5lZChvYmoudmFsdWUpKSB7CiAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLnZhbHVlKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgfQogICAgcmV0dXJuIGxlbmd0aAogIH0KCiAgZnVuY3Rpb24gZW5jb2RlIChvYmosIGJ1Ziwgb2Zmc2V0KSB7CiAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgaWYgKCFkZWZpbmVkKG9iai5pbmRleCkpIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgcmVxdWlyZWQiKQogICAgYnVmW29mZnNldCsrXSA9IDEwCiAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5pbmRleCwgYnVmLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgaWYgKCFkZWZpbmVkKG9iai5rZXkpKSB0aHJvdyBuZXcgRXJyb3IoImtleSBpcyByZXF1aXJlZCIpCiAgICBidWZbb2Zmc2V0KytdID0gMTgKICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmtleSwgYnVmLCBvZmZzZXQpCiAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgaWYgKGRlZmluZWQob2JqLnZhbHVlKSkgewogICAgICBidWZbb2Zmc2V0KytdID0gMjYKICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoudmFsdWUsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgfQogICAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gYnVmCiAgfQoKICBmdW5jdGlvbiBkZWNvZGUgKGJ1Ziwgb2Zmc2V0LCBlbmQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgaWYgKCEoZW5kIDw9IGJ1Zi5sZW5ndGggJiYgb2Zmc2V0IDw9IGJ1Zi5sZW5ndGgpKSB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgbWVzc2FnZSBpcyBub3QgdmFsaWQiKQogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgdmFyIG9iaiA9IHsKICAgICAgaW5kZXg6IG51bGwsCiAgICAgIGtleTogbnVsbCwKICAgICAgdmFsdWU6IG51bGwKICAgIH0KICAgIHZhciBmb3VuZDAgPSBmYWxzZQogICAgdmFyIGZvdW5kMSA9IGZhbHNlCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgIGlmICghZm91bmQwIHx8ICFmb3VuZDEpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgcmV0dXJuIG9iagogICAgICB9CiAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgb2JqLmluZGV4ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgIGZvdW5kMCA9IHRydWUKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMjoKICAgICAgICBvYmoua2V5ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZS5ieXRlcwogICAgICAgIGZvdW5kMSA9IHRydWUKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMzoKICAgICAgICBvYmoudmFsdWUgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgYnJlYWsKICAgICAgICBkZWZhdWx0OgogICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlZmluZUV4dGVuc2lvbiAoKSB7CiAgdmFyIEdldCA9IEV4dGVuc2lvbi5HZXQgPSB7CiAgICBidWZmZXI6IHRydWUsCiAgICBlbmNvZGluZ0xlbmd0aDogbnVsbCwKICAgIGVuY29kZTogbnVsbCwKICAgIGRlY29kZTogbnVsbAogIH0KCiAgdmFyIEl0ZXJhdG9yID0gRXh0ZW5zaW9uLkl0ZXJhdG9yID0gewogICAgYnVmZmVyOiB0cnVlLAogICAgZW5jb2RpbmdMZW5ndGg6IG51bGwsCiAgICBlbmNvZGU6IG51bGwsCiAgICBkZWNvZGU6IG51bGwKICB9CgogIHZhciBDYWNoZSA9IEV4dGVuc2lvbi5DYWNoZSA9IHsKICAgIGJ1ZmZlcjogdHJ1ZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBudWxsLAogICAgZW5jb2RlOiBudWxsLAogICAgZGVjb2RlOiBudWxsCiAgfQoKICBkZWZpbmVHZXQoKQogIGRlZmluZUl0ZXJhdG9yKCkKICBkZWZpbmVDYWNoZSgpCgogIGZ1bmN0aW9uIGRlZmluZUdldCAoKSB7CiAgICBHZXQuZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogICAgR2V0LmVuY29kZSA9IGVuY29kZQogICAgR2V0LmRlY29kZSA9IGRlY29kZQoKICAgIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgICAgdmFyIGxlbmd0aCA9IDAKICAgICAgaWYgKGRlZmluZWQob2JqLnZlcnNpb24pKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLnZlcnNpb24pCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoua2V5KSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmtleSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGgKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIGlmIChkZWZpbmVkKG9iai52ZXJzaW9uKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA4CiAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLnZlcnNpb24sIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5rZXkpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoua2V5LCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICByZXR1cm4gYnVmCiAgICB9CgogICAgZnVuY3Rpb24gZGVjb2RlIChidWYsIG9mZnNldCwgZW5kKSB7CiAgICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICAgIGlmICghKGVuZCA8PSBidWYubGVuZ3RoICYmIG9mZnNldCA8PSBidWYubGVuZ3RoKSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAogICAgICB2YXIgb2JqID0gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAga2V5OiBudWxsCiAgICAgIH0KICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgfQogICAgICAgIHZhciBwcmVmaXggPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgdmFyIHRhZyA9IHByZWZpeCA+PiAzCiAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgIG9iai52ZXJzaW9uID0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICBvYmoua2V5ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWZpbmVJdGVyYXRvciAoKSB7CiAgICBJdGVyYXRvci5lbmNvZGluZ0xlbmd0aCA9IGVuY29kaW5nTGVuZ3RoCiAgICBJdGVyYXRvci5lbmNvZGUgPSBlbmNvZGUKICAgIEl0ZXJhdG9yLmRlY29kZSA9IGRlY29kZQoKICAgIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgICAgdmFyIGxlbmd0aCA9IDAKICAgICAgaWYgKGRlZmluZWQob2JqLnZlcnNpb24pKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLnZlcnNpb24pCiAgICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmouZ3RlKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmd0ZSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5ndCkpIHsKICAgICAgICB2YXIgbGVuID0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kaW5nTGVuZ3RoKG9iai5ndCkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5sdGUpKSB7CiAgICAgICAgdmFyIGxlbiA9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGluZ0xlbmd0aChvYmoubHRlKQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmx0KSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RpbmdMZW5ndGgob2JqLmx0KQogICAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmxpbWl0KSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5saW1pdCkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5yZXZlcnNlKSkgewogICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MuYm9vbC5lbmNvZGluZ0xlbmd0aChvYmoucmV2ZXJzZSkKICAgICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5jaGVja3BvaW50KSkgewogICAgICAgIHZhciBwYWNrZWRMZW4gPSAwCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hlY2twb2ludC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGVja3BvaW50W2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5jaGVja3BvaW50W2ldKQogICAgICAgICAgcGFja2VkTGVuICs9IGxlbgogICAgICAgIH0KICAgICAgICBpZiAocGFja2VkTGVuKSB7CiAgICAgICAgICBsZW5ndGggKz0gMSArIHBhY2tlZExlbiArIHZhcmludC5lbmNvZGluZ0xlbmd0aChwYWNrZWRMZW4pCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBsZW5ndGgKICAgIH0KCiAgICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgICAgaWYgKCFidWYpIGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShlbmNvZGluZ0xlbmd0aChvYmopKQogICAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICAgIGlmIChkZWZpbmVkKG9iai52ZXJzaW9uKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA4CiAgICAgICAgZW5jb2RpbmdzLnZhcmludC5lbmNvZGUob2JqLnZlcnNpb24sIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5ndGUpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmouZ3RlLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJ5dGVzLmVuY29kZS5ieXRlcwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkKG9iai5ndCkpIHsKICAgICAgICBidWZbb2Zmc2V0KytdID0gMjYKICAgICAgICBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlKG9iai5ndCwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubHRlKSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSAzNAogICAgICAgIGVuY29kaW5ncy5ieXRlcy5lbmNvZGUob2JqLmx0ZSwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5lbmNvZGUuYnl0ZXMKICAgICAgfQogICAgICBpZiAoZGVmaW5lZChvYmoubHQpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDQyCiAgICAgICAgZW5jb2RpbmdzLmJ5dGVzLmVuY29kZShvYmoubHQsIGJ1Ziwgb2Zmc2V0KQogICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmxpbWl0KSkgewogICAgICAgIGJ1ZltvZmZzZXQrK10gPSA0OAogICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5saW1pdCwgYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLnJldmVyc2UpKSB7CiAgICAgICAgYnVmW29mZnNldCsrXSA9IDU2CiAgICAgICAgZW5jb2RpbmdzLmJvb2wuZW5jb2RlKG9iai5yZXZlcnNlLCBidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLmJvb2wuZW5jb2RlLmJ5dGVzCiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQob2JqLmNoZWNrcG9pbnQpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5jaGVja3BvaW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmNoZWNrcG9pbnRbaV0pKSBjb250aW51ZQogICAgICAgICAgcGFja2VkTGVuICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RpbmdMZW5ndGgob2JqLmNoZWNrcG9pbnRbaV0pCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGJ1ZltvZmZzZXQrK10gPSA2NgogICAgICAgICAgdmFyaW50LmVuY29kZShwYWNrZWRMZW4sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouY2hlY2twb2ludC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKCFkZWZpbmVkKG9iai5jaGVja3BvaW50W2ldKSkgY29udGludWUKICAgICAgICAgIGVuY29kaW5ncy52YXJpbnQuZW5jb2RlKG9iai5jaGVja3BvaW50W2ldLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgfQogICAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgcmV0dXJuIGJ1ZgogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgdmFyIG9iaiA9IHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGd0ZTogbnVsbCwKICAgICAgICBndDogbnVsbCwKICAgICAgICBsdGU6IG51bGwsCiAgICAgICAgbHQ6IG51bGwsCiAgICAgICAgbGltaXQ6IDAsCiAgICAgICAgcmV2ZXJzZTogZmFsc2UsCiAgICAgICAgY2hlY2twb2ludDogW10KICAgICAgfQogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmIChlbmQgPD0gb2Zmc2V0KSB7CiAgICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICAgIHJldHVybiBvYmoKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICB2YXIgdGFnID0gcHJlZml4ID4+IDMKICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgb2JqLnZlcnNpb24gPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIG9iai5ndGUgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICBvYmouZ3QgPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy5ieXRlcy5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBvYmoubHRlID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgb2JqLmx0ID0gZW5jb2RpbmdzLmJ5dGVzLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYnl0ZXMuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgb2JqLmxpbWl0ID0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICBvYmoucmV2ZXJzZSA9IGVuY29kaW5ncy5ib29sLmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MuYm9vbC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICB2YXIgcGFja2VkRW5kID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICBwYWNrZWRFbmQgKz0gb2Zmc2V0CiAgICAgICAgICB3aGlsZSAob2Zmc2V0IDwgcGFja2VkRW5kKSB7CiAgICAgICAgICAgIG9iai5jaGVja3BvaW50LnB1c2goZW5jb2RpbmdzLnZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpKQogICAgICAgICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGRlZmluZUNhY2hlICgpIHsKICAgIENhY2hlLmVuY29kaW5nTGVuZ3RoID0gZW5jb2RpbmdMZW5ndGgKICAgIENhY2hlLmVuY29kZSA9IGVuY29kZQogICAgQ2FjaGUuZGVjb2RlID0gZGVjb2RlCgogICAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKG9iaikgewogICAgICB2YXIgbGVuZ3RoID0gMAogICAgICBpZiAoIWRlZmluZWQob2JqLnN0YXJ0KSkgdGhyb3cgbmV3IEVycm9yKCJzdGFydCBpcyByZXF1aXJlZCIpCiAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5zdGFydCkKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgICAgaWYgKCFkZWZpbmVkKG9iai5lbmQpKSB0aHJvdyBuZXcgRXJyb3IoImVuZCBpcyByZXF1aXJlZCIpCiAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5lbmQpCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICAgIGlmIChkZWZpbmVkKG9iai5ibG9ja3MpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5ibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouYmxvY2tzW2ldKSkgY29udGludWUKICAgICAgICAgIHZhciBsZW4gPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5ibG9ja3NbaV0pCiAgICAgICAgICBwYWNrZWRMZW4gKz0gbGVuCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGxlbmd0aCArPSAxICsgcGFja2VkTGVuICsgdmFyaW50LmVuY29kaW5nTGVuZ3RoKHBhY2tlZExlbikKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxlbmd0aAogICAgfQoKICAgIGZ1bmN0aW9uIGVuY29kZSAob2JqLCBidWYsIG9mZnNldCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgaWYgKCFkZWZpbmVkKG9iai5zdGFydCkpIHRocm93IG5ldyBFcnJvcigic3RhcnQgaXMgcmVxdWlyZWQiKQogICAgICBidWZbb2Zmc2V0KytdID0gOAogICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouc3RhcnQsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gZW5jb2RpbmdzLnZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgaWYgKCFkZWZpbmVkKG9iai5lbmQpKSB0aHJvdyBuZXcgRXJyb3IoImVuZCBpcyByZXF1aXJlZCIpCiAgICAgIGJ1ZltvZmZzZXQrK10gPSAxNgogICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouZW5kLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIGlmIChkZWZpbmVkKG9iai5ibG9ja3MpKSB7CiAgICAgICAgdmFyIHBhY2tlZExlbiA9IDAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5ibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghZGVmaW5lZChvYmouYmxvY2tzW2ldKSkgY29udGludWUKICAgICAgICAgIHBhY2tlZExlbiArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kaW5nTGVuZ3RoKG9iai5ibG9ja3NbaV0pCiAgICAgICAgfQogICAgICAgIGlmIChwYWNrZWRMZW4pIHsKICAgICAgICAgIGJ1ZltvZmZzZXQrK10gPSAyNgogICAgICAgICAgdmFyaW50LmVuY29kZShwYWNrZWRMZW4sIGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWQob2JqLmJsb2Nrc1tpXSkpIGNvbnRpbnVlCiAgICAgICAgICBlbmNvZGluZ3MudmFyaW50LmVuY29kZShvYmouYmxvY2tzW2ldLCBidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmVuY29kZS5ieXRlcwogICAgICAgIH0KICAgICAgfQogICAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgcmV0dXJuIGJ1ZgogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMAogICAgICBpZiAoIWVuZCkgZW5kID0gYnVmLmxlbmd0aAogICAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgICAgdmFyIG9iaiA9IHsKICAgICAgICBzdGFydDogMCwKICAgICAgICBlbmQ6IDAsCiAgICAgICAgYmxvY2tzOiBbXQogICAgICB9CiAgICAgIHZhciBmb3VuZDAgPSBmYWxzZQogICAgICB2YXIgZm91bmQxID0gZmFsc2UKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoZW5kIDw9IG9mZnNldCkgewogICAgICAgICAgaWYgKCFmb3VuZDAgfHwgIWZvdW5kMSkgdGhyb3cgbmV3IEVycm9yKCJEZWNvZGVkIG1lc3NhZ2UgaXMgbm90IHZhbGlkIikKICAgICAgICAgIGRlY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgICAgICAgcmV0dXJuIG9iagogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICBvYmouc3RhcnQgPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgZm91bmQwID0gdHJ1ZQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgIG9iai5lbmQgPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICAgIG9mZnNldCArPSBlbmNvZGluZ3MudmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgICAgZm91bmQxID0gdHJ1ZQogICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgIHZhciBwYWNrZWRFbmQgPSB2YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KQogICAgICAgICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgICAgICAgIHBhY2tlZEVuZCArPSBvZmZzZXQKICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBwYWNrZWRFbmQpIHsKICAgICAgICAgICAgb2JqLmJsb2Nrcy5wdXNoKGVuY29kaW5ncy52YXJpbnQuZGVjb2RlKGJ1Ziwgb2Zmc2V0KSkKICAgICAgICAgICAgb2Zmc2V0ICs9IGVuY29kaW5ncy52YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIG9mZnNldCA9IHNraXAocHJlZml4ICYgNywgYnVmLCBvZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBFeHRlbnNpb24uZW5jb2RpbmdMZW5ndGggPSBlbmNvZGluZ0xlbmd0aAogIEV4dGVuc2lvbi5lbmNvZGUgPSBlbmNvZGUKICBFeHRlbnNpb24uZGVjb2RlID0gZGVjb2RlCgogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoIChvYmopIHsKICAgIHZhciBsZW5ndGggPSAwCiAgICBpZiAoZGVmaW5lZChvYmouY2FjaGUpKSB7CiAgICAgIHZhciBsZW4gPSBDYWNoZS5lbmNvZGluZ0xlbmd0aChvYmouY2FjaGUpCiAgICAgIGxlbmd0aCArPSB2YXJpbnQuZW5jb2RpbmdMZW5ndGgobGVuKQogICAgICBsZW5ndGggKz0gMSArIGxlbgogICAgfQogICAgaWYgKGRlZmluZWQob2JqLmdldCkpIHsKICAgICAgdmFyIGxlbiA9IEdldC5lbmNvZGluZ0xlbmd0aChvYmouZ2V0KQogICAgICBsZW5ndGggKz0gdmFyaW50LmVuY29kaW5nTGVuZ3RoKGxlbikKICAgICAgbGVuZ3RoICs9IDEgKyBsZW4KICAgIH0KICAgIGlmIChkZWZpbmVkKG9iai5pdGVyYXRvcikpIHsKICAgICAgdmFyIGxlbiA9IEl0ZXJhdG9yLmVuY29kaW5nTGVuZ3RoKG9iai5pdGVyYXRvcikKICAgICAgbGVuZ3RoICs9IHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pCiAgICAgIGxlbmd0aCArPSAxICsgbGVuCiAgICB9CiAgICByZXR1cm4gbGVuZ3RoCiAgfQoKICBmdW5jdGlvbiBlbmNvZGUgKG9iaiwgYnVmLCBvZmZzZXQpIHsKICAgIGlmICghb2Zmc2V0KSBvZmZzZXQgPSAwCiAgICBpZiAoIWJ1ZikgYnVmID0gYjRhLmFsbG9jVW5zYWZlKGVuY29kaW5nTGVuZ3RoKG9iaikpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICBpZiAoZGVmaW5lZChvYmouY2FjaGUpKSB7CiAgICAgIGJ1ZltvZmZzZXQrK10gPSAxMAogICAgICB2YXJpbnQuZW5jb2RlKENhY2hlLmVuY29kaW5nTGVuZ3RoKG9iai5jYWNoZSksIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgICBDYWNoZS5lbmNvZGUob2JqLmNhY2hlLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IENhY2hlLmVuY29kZS5ieXRlcwogICAgfQogICAgaWYgKGRlZmluZWQob2JqLmdldCkpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDE4CiAgICAgIHZhcmludC5lbmNvZGUoR2V0LmVuY29kaW5nTGVuZ3RoKG9iai5nZXQpLCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKICAgICAgR2V0LmVuY29kZShvYmouZ2V0LCBidWYsIG9mZnNldCkKICAgICAgb2Zmc2V0ICs9IEdldC5lbmNvZGUuYnl0ZXMKICAgIH0KICAgIGlmIChkZWZpbmVkKG9iai5pdGVyYXRvcikpIHsKICAgICAgYnVmW29mZnNldCsrXSA9IDI2CiAgICAgIHZhcmludC5lbmNvZGUoSXRlcmF0b3IuZW5jb2RpbmdMZW5ndGgob2JqLml0ZXJhdG9yKSwgYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICAgIEl0ZXJhdG9yLmVuY29kZShvYmouaXRlcmF0b3IsIGJ1Ziwgb2Zmc2V0KQogICAgICBvZmZzZXQgKz0gSXRlcmF0b3IuZW5jb2RlLmJ5dGVzCiAgICB9CiAgICBlbmNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiBidWYKICB9CgogIGZ1bmN0aW9uIGRlY29kZSAoYnVmLCBvZmZzZXQsIGVuZCkgewogICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDAKICAgIGlmICghZW5kKSBlbmQgPSBidWYubGVuZ3RoCiAgICBpZiAoIShlbmQgPD0gYnVmLmxlbmd0aCAmJiBvZmZzZXQgPD0gYnVmLmxlbmd0aCkpIHRocm93IG5ldyBFcnJvcigiRGVjb2RlZCBtZXNzYWdlIGlzIG5vdCB2YWxpZCIpCiAgICB2YXIgb2xkT2Zmc2V0ID0gb2Zmc2V0CiAgICB2YXIgb2JqID0gewogICAgICBjYWNoZTogbnVsbCwKICAgICAgZ2V0OiBudWxsLAogICAgICBpdGVyYXRvcjogbnVsbAogICAgfQogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKGVuZCA8PSBvZmZzZXQpIHsKICAgICAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KICAgICAgdmFyIHByZWZpeCA9IHZhcmludC5kZWNvZGUoYnVmLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICAgIHZhciB0YWcgPSBwcmVmaXggPj4gMwogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgMToKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5jYWNoZSA9IENhY2hlLmRlY29kZShidWYsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgICAgIG9mZnNldCArPSBDYWNoZS5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5nZXQgPSBHZXQuZGVjb2RlKGJ1Ziwgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICAgICAgb2Zmc2V0ICs9IEdldC5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWYsIG9mZnNldCkKICAgICAgICBvZmZzZXQgKz0gdmFyaW50LmRlY29kZS5ieXRlcwogICAgICAgIG9iai5pdGVyYXRvciA9IEl0ZXJhdG9yLmRlY29kZShidWYsIG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgICAgIG9mZnNldCArPSBJdGVyYXRvci5kZWNvZGUuYnl0ZXMKICAgICAgICBicmVhawogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgb2Zmc2V0ID0gc2tpcChwcmVmaXggJiA3LCBidWYsIG9mZnNldCkKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVmaW5lZCAodmFsKSB7CiAgcmV0dXJuIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHVuZGVmaW5lZCAmJiAodHlwZW9mIHZhbCAhPT0gJ251bWJlcicgfHwgIWlzTmFOKHZhbCkpCn0KewogICJuYW1lIjogImh5cGVyYmVlIiwKICAidmVyc2lvbiI6ICIyLjI2LjUiLAogICJkZXNjcmlwdGlvbiI6ICJBbiBhcHBlbmQtb25seSBCLXRyZWUgcnVubmluZyBvbiBhIEh5cGVyY29yZS4iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYi8qKi5qcyIsCiAgICAiaXRlcmF0b3JzLyoqLmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIiwKICAgICJjb2RlY3MiOiAiXjMuMC4wIiwKICAgICJkZWJvdW5jZWlmeSI6ICJeMS4wLjAiLAogICAgImh5cGVyY29yZS1lcnJvcnMiOiAiXjEuMC4wIiwKICAgICJtdXRleGlmeSI6ICJeMS40LjAiLAogICAgInByb3RvY29sLWJ1ZmZlcnMtZW5jb2RpbmdzIjogIl4xLjIuMCIsCiAgICAicmFjaGUiOiAiXjEuMC4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4wLjAiLAogICAgInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiAiXjEuMS4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIiwKICAgICJzdHJlYW14IjogIl4yLjEyLjQiLAogICAgInVuc2xhYiI6ICJeMS4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4wIiwKICAgICJoeXBlcmNvcmUiOiAiXjExLjAuMCIsCiAgICAicHJvdG9jb2wtYnVmZmVycyI6ICJeNC4yLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiLAogICAgInN1Yi1lbmNvZGVyIjogIl4xLjAuNiIsCiAgICAidHJlZS10by1zdHJpbmciOiAiXjEuMS4xIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QvKi5qcyIsCiAgICAicHJvdG9idWYiOiAicHJvdG9jb2wtYnVmZmVycyBzY2hlbWEucHJvdG8gLW8gLi9saWIvbWVzc2FnZXMuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmJlZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmJlZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyYmVlIgp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgovLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9NZXJrbGVfdHJlZSNTZWNvbmRfcHJlaW1hZ2VfYXR0YWNrCmNvbnN0IExFQUZfVFlQRSA9IGI0YS5mcm9tKFswXSkKY29uc3QgUEFSRU5UX1RZUEUgPSBiNGEuZnJvbShbMV0pCmNvbnN0IFJPT1RfVFlQRSA9IGI0YS5mcm9tKFsyXSkKCmNvbnN0IEhZUEVSQ09SRSA9IGI0YS5mcm9tKCdoeXBlcmNvcmUnKQoKZXhwb3J0cy5rZXlQYWlyID0gZnVuY3Rpb24gKHNlZWQpIHsKICAvLyBrZXkgcGFpcnMgbWlnaHQgc3RheSBhcm91bmQgZm9yIGEgd2hpbGUsIHNvIGJldHRlciBub3QgdG8gdXNlIGEgZGVmYXVsdCBzbGFiIHRvIGF2b2lkIHJldGFpbmluZyBpdCBjb21wbGV0ZWx5CiAgY29uc3Qgc2xhYiA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTICsgc29kaXVtLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogIGNvbnN0IHB1YmxpY0tleSA9IHNsYWIuc3ViYXJyYXkoMCwgc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogIGNvbnN0IHNlY3JldEtleSA9IHNsYWIuc3ViYXJyYXkoc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQoKICBpZiAoc2VlZCkgc29kaXVtLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSwgc2VlZCkKICBlbHNlIHNvZGl1bS5jcnlwdG9fc2lnbl9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5KQoKICByZXR1cm4gewogICAgcHVibGljS2V5LAogICAgc2VjcmV0S2V5CiAgfQp9CgpleHBvcnRzLnZhbGlkYXRlS2V5UGFpciA9IGZ1bmN0aW9uIChrZXlQYWlyKSB7CiAgY29uc3QgcGsgPSBiNGEuYWxsb2NVbnNhZmUoc29kaXVtLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogIHNvZGl1bS5jcnlwdG9fc2lnbl9lZDI1NTE5X3NrX3RvX3BrKHBrLCBrZXlQYWlyLnNlY3JldEtleSkKICByZXR1cm4gYjRhLmVxdWFscyhwaywga2V5UGFpci5wdWJsaWNLZXkpCn0KCmV4cG9ydHMuc2lnbiA9IGZ1bmN0aW9uIChtZXNzYWdlLCBzZWNyZXRLZXkpIHsKICAvLyBEZWRpY2F0ZWQgc2xhYiBmb3IgdGhlIHNpZ25hdHVyZSwgdG8gYXZvaWQgcmV0YWluaW5nIHVubmVlZGVkIG1lbSBhbmQgZm9yIHNlY3VyaXR5CiAgY29uc3Qgc2lnbmF0dXJlID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhzb2RpdW0uY3J5cHRvX3NpZ25fQllURVMpCiAgc29kaXVtLmNyeXB0b19zaWduX2RldGFjaGVkKHNpZ25hdHVyZSwgbWVzc2FnZSwgc2VjcmV0S2V5KQogIHJldHVybiBzaWduYXR1cmUKfQoKZXhwb3J0cy52ZXJpZnkgPSBmdW5jdGlvbiAobWVzc2FnZSwgc2lnbmF0dXJlLCBwdWJsaWNLZXkpIHsKICBpZiAoc2lnbmF0dXJlLmJ5dGVMZW5ndGggIT09IHNvZGl1bS5jcnlwdG9fc2lnbl9CWVRFUykgcmV0dXJuIGZhbHNlCiAgaWYgKHB1YmxpY0tleS5ieXRlTGVuZ3RoICE9PSBzb2RpdW0uY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpIHJldHVybiBmYWxzZQogIHJldHVybiBzb2RpdW0uY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKHNpZ25hdHVyZSwgbWVzc2FnZSwgcHVibGljS2V5KQp9CgpleHBvcnRzLmVuY3J5cHQgPSBmdW5jdGlvbiAobWVzc2FnZSwgcHVibGljS2V5KSB7CiAgY29uc3QgY2lwaGVydGV4dCA9IGI0YS5hbGxvYyhtZXNzYWdlLmJ5dGVMZW5ndGggKyBzb2RpdW0uY3J5cHRvX2JveF9TRUFMQllURVMpCiAgc29kaXVtLmNyeXB0b19ib3hfc2VhbChjaXBoZXJ0ZXh0LCBtZXNzYWdlLCBwdWJsaWNLZXkpCiAgcmV0dXJuIGNpcGhlcnRleHQKfQoKZXhwb3J0cy5kZWNyeXB0ID0gZnVuY3Rpb24gKGNpcGhlcnRleHQsIGtleVBhaXIpIHsKICBpZiAoY2lwaGVydGV4dC5ieXRlTGVuZ3RoIDwgc29kaXVtLmNyeXB0b19ib3hfU0VBTEJZVEVTKSByZXR1cm4gbnVsbAoKICBjb25zdCBwbGFpbnRleHQgPSBiNGEuYWxsb2MoY2lwaGVydGV4dC5ieXRlTGVuZ3RoIC0gc29kaXVtLmNyeXB0b19ib3hfU0VBTEJZVEVTKQoKICBpZiAoIXNvZGl1bS5jcnlwdG9fYm94X3NlYWxfb3BlbihwbGFpbnRleHQsIGNpcGhlcnRleHQsIGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSkpIHsKICAgIHJldHVybiBudWxsCiAgfQoKICByZXR1cm4gcGxhaW50ZXh0Cn0KCmV4cG9ydHMuZW5jcnlwdGlvbktleVBhaXIgPSBmdW5jdGlvbiAoc2VlZCkgewogIGNvbnN0IHB1YmxpY0tleSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX2JveF9QVUJMSUNLRVlCWVRFUykKICBjb25zdCBzZWNyZXRLZXkgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMpCgogIGlmIChzZWVkKSB7CiAgICBzb2RpdW0uY3J5cHRvX2JveF9zZWVkX2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXksIHNlZWQpCiAgfSBlbHNlIHsKICAgIHNvZGl1bS5jcnlwdG9fYm94X2tleXBhaXIocHVibGljS2V5LCBzZWNyZXRLZXkpCiAgfQoKICByZXR1cm4gewogICAgcHVibGljS2V5LAogICAgc2VjcmV0S2V5CiAgfQp9CgpleHBvcnRzLmRhdGEgPSBmdW5jdGlvbiAoZGF0YSkgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFsKICAgIExFQUZfVFlQRSwKICAgIGMuZW5jb2RlKGMudWludDY0LCBkYXRhLmJ5dGVMZW5ndGgpLAogICAgZGF0YQogIF0pCgogIHJldHVybiBvdXQKfQoKZXhwb3J0cy5wYXJlbnQgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhLmluZGV4ID4gYi5pbmRleCkgewogICAgY29uc3QgdG1wID0gYQogICAgYSA9IGIKICAgIGIgPSB0bXAKICB9CgogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChvdXQsIFsKICAgIFBBUkVOVF9UWVBFLAogICAgYy5lbmNvZGUoYy51aW50NjQsIGEuc2l6ZSArIGIuc2l6ZSksCiAgICBhLmhhc2gsCiAgICBiLmhhc2gKICBdKQoKICByZXR1cm4gb3V0Cn0KCmV4cG9ydHMudHJlZSA9IGZ1bmN0aW9uIChyb290cywgb3V0KSB7CiAgY29uc3QgYnVmZmVycyA9IG5ldyBBcnJheSgzICogcm9vdHMubGVuZ3RoICsgMSkKICBsZXQgaiA9IDAKCiAgYnVmZmVyc1tqKytdID0gUk9PVF9UWVBFCgogIGZvciAobGV0IGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHIgPSByb290c1tpXQogICAgYnVmZmVyc1tqKytdID0gci5oYXNoCiAgICBidWZmZXJzW2orK10gPSBjLmVuY29kZShjLnVpbnQ2NCwgci5pbmRleCkKICAgIGJ1ZmZlcnNbaisrXSA9IGMuZW5jb2RlKGMudWludDY0LCByLnNpemUpCiAgfQoKICBpZiAoIW91dCkgb3V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBidWZmZXJzKQogIHJldHVybiBvdXQKfQoKZXhwb3J0cy5oYXNoID0gZnVuY3Rpb24gKGRhdGEsIG91dCkgewogIGlmICghb3V0KSBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEpKSBkYXRhID0gW2RhdGFdCgogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBkYXRhKQoKICByZXR1cm4gb3V0Cn0KCmV4cG9ydHMucmFuZG9tQnl0ZXMgPSBmdW5jdGlvbiAobikgewogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZShuKQogIHNvZGl1bS5yYW5kb21ieXRlc19idWYoYnVmKQogIHJldHVybiBidWYKfQoKZXhwb3J0cy5kaXNjb3ZlcnlLZXkgPSBmdW5jdGlvbiAoa2V5KSB7CiAgaWYgKCFrZXkgfHwga2V5LmJ5dGVMZW5ndGggIT09IDMyKSB0aHJvdyBuZXcgRXJyb3IoJ011c3QgcGFzcyBhIDMyIGJ5dGUgYnVmZmVyJykKICAvLyBEaXNjb3Zlcnkga2V5cyBtaWdodCBzdGF5IGFyb3VuZCBmb3IgYSB3aGlsZSwgc28gYmV0dGVyIG5vdCB0byB1c2Ugc2xhYiBtZW1vcnkgKGZvciBiZXR0ZXIgZ2MpCiAgY29uc3QgZGlnZXN0ID0gYjRhLmFsbG9jVW5zYWZlU2xvdygzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGRpZ2VzdCwgSFlQRVJDT1JFLCBrZXkpCiAgcmV0dXJuIGRpZ2VzdAp9CgppZiAoc29kaXVtLnNvZGl1bV9mcmVlKSB7CiAgZXhwb3J0cy5mcmVlID0gZnVuY3Rpb24gKHNlY3VyZUJ1ZikgewogICAgaWYgKHNlY3VyZUJ1Zi5zZWN1cmUpIHNvZGl1bS5zb2RpdW1fZnJlZShzZWN1cmVCdWYpCiAgfQp9IGVsc2UgewogIGV4cG9ydHMuZnJlZSA9IGZ1bmN0aW9uICgpIHt9Cn0KCmV4cG9ydHMubmFtZXNwYWNlID0gZnVuY3Rpb24gKG5hbWUsIGNvdW50KSB7CiAgY29uc3QgaWRzID0gdHlwZW9mIGNvdW50ID09PSAnbnVtYmVyJyA/IHJhbmdlKGNvdW50KSA6IGNvdW50CgogIC8vIE5hbWVzcGFjZXMgYXJlIGxvbmctbGl2ZWQsIHNvIGJldHRlciB0byB1c2UgYSBkZWRpY2F0ZWQgc2xhYgogIGNvbnN0IGJ1ZiA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coMzIgKiBpZHMubGVuZ3RoKQoKICBjb25zdCBsaXN0ID0gbmV3IEFycmF5KGlkcy5sZW5ndGgpCgogIC8vIG5zIGlzIGVtaGVtZXJhbCwgc28gZGVmYXVsdCBzbGFiCiAgY29uc3QgbnMgPSBiNGEuYWxsb2NVbnNhZmUoMzMpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChucy5zdWJhcnJheSgwLCAzMiksIHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJyA/IGI0YS5mcm9tKG5hbWUpIDogbmFtZSkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBsaXN0W2ldID0gYnVmLnN1YmFycmF5KDMyICogaSwgMzIgKiBpICsgMzIpCiAgICBuc1szMl0gPSBpZHNbaV0KICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gobGlzdFtpXSwgbnMpCiAgfQoKICByZXR1cm4gbGlzdAp9CgpmdW5jdGlvbiByYW5nZSAoY291bnQpIHsKICBjb25zdCBhcnIgPSBuZXcgQXJyYXkoY291bnQpCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSBhcnJbaV0gPSBpCiAgcmV0dXJuIGFycgp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUtY3J5cHRvIiwKICAidmVyc2lvbiI6ICIzLjYuMSIsCiAgImRlc2NyaXB0aW9uIjogIlRoZSBjcnlwdG8gcHJpbWl0aXZlcyB1c2VkIGluIGh5cGVyY29yZSwgZXh0cmFjdGVkIGludG8gYSBzZXBhcmF0ZSBtb2R1bGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjYiLAogICAgImNvbXBhY3QtZW5jb2RpbmciOiAiXjIuMTUuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNS4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaHlwZXJjb3JlLWNyeXB0by5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvaHlwZXJjb3JlLWNyeXB0by9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9oeXBlcmNvcmUtY3J5cHRvIgp9CmNvbnN0IElkRW5jID0gcmVxdWlyZSgnaHlwZXJjb3JlLWlkLWVuY29kaW5nJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSHlwZXJjb3JlRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IgKG1zZywgY29kZSwgZm4gPSBIeXBlcmNvcmVFcnJvciwgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgaWYgKGRpc2NvdmVyeUtleSkgbXNnID0gYCR7bXNnfSAoZGlzY292ZXJ5IGtleTogJHtJZEVuYy5ub3JtYWxpemUoZGlzY292ZXJ5S2V5KX0pYAogICAgc3VwZXIoYCR7Y29kZX06ICR7bXNnfWApCgogICAgdGhpcy5jb2RlID0gY29kZQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBkaXNjb3ZlcnlLZXkKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSAoKSB7CiAgICByZXR1cm4gJ0h5cGVyY29yZUVycm9yJwogIH0KCiAgc3RhdGljIEFTU0VSVElPTiAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7IC8vIEVSUl9BU1NFUlRJT04gaXMgcGlja2VkIHVwIGJ5IHNhZmV0eS1jYXRjaCBhbHNvCiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0VSUl9BU1NFUlRJT04nLCBIeXBlcmNvcmVFcnJvci5BU1NFUlQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCQURfQVJHVU1FTlQgKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdCQURfQVJHVU1FTlQnLCBIeXBlcmNvcmVFcnJvci5CQURfQVJHVU1FTlQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTVE9SQUdFX0VNUFRZIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU1RPUkFHRV9FTVBUWScsIEh5cGVyY29yZUVycm9yLlNUT1JBR0VfRU1QVFksIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBTVE9SQUdFX0NPTkZMSUNUIChtc2csIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU1RPUkFHRV9DT05GTElDVCcsIEh5cGVyY29yZUVycm9yLlNUT1JBR0VfQ09ORkxJQ1QsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX1NJR05BVFVSRSAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfU0lHTkFUVVJFJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9TSUdOQVRVUkUsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0NBUEFCSUxJVFkgKG1zZywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdJTlZBTElEX0NBUEFCSUxJVFknLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX0NBUEFCSUxJVFksIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX0NIRUNLU1VNIChtc2cgPSAnSW52YWxpZCBjaGVja3N1bScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnSU5WQUxJRF9DSEVDS1NVTScsIEh5cGVyY29yZUVycm9yLklOVkFMSURfQ0hFQ0tTVU0sIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX09QRVJBVElPTiAobXNnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfT1BFUkFUSU9OJywgSHlwZXJjb3JlRXJyb3IuSU5WQUxJRF9PUEVSQVRJT04sIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBJTlZBTElEX1BST09GIChtc2cgPSAnUHJvb2Ygbm90IHZlcmlmaWFibGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfUFJPT0YnLCBIeXBlcmNvcmVFcnJvci5JTlZBTElEX1BST09GLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgQkxPQ0tfTk9UX0FWQUlMQUJMRSAobXNnID0gJ0Jsb2NrIGlzIG5vdCBhdmFpbGFibGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JMT0NLX05PVF9BVkFJTEFCTEUnLCBIeXBlcmNvcmVFcnJvci5CTE9DS19OT1RfQVZBSUxBQkxFLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSAobXNnID0gJ1NuYXBzaG90IGlzIG5vdCBhdmFpbGFibGUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NOQVBTSE9UX05PVF9BVkFJTEFCTEUnLCBIeXBlcmNvcmVFcnJvci5TTkFQU0hPVF9OT1RfQVZBSUxBQkxFLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgUkVRVUVTVF9DQU5DRUxMRUQgKG1zZyA9ICdSZXF1ZXN0IHdhcyBjYW5jZWxsZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1JFUVVFU1RfQ0FOQ0VMTEVEJywgSHlwZXJjb3JlRXJyb3IuUkVRVUVTVF9DQU5DRUxMRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBSRVFVRVNUX1RJTUVPVVQgKG1zZyA9ICdSZXF1ZXN0IHRpbWVkIG91dCcsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnUkVRVUVTVF9USU1FT1VUJywgSHlwZXJjb3JlRXJyb3IuUkVRVUVTVF9USU1FT1VULCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU0VTU0lPTl9OT1RfV1JJVEFCTEUgKG1zZyA9ICdTZXNzaW9uIGlzIG5vdCB3cml0YWJsZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnU0VTU0lPTl9OT1RfV1JJVEFCTEUnLCBIeXBlcmNvcmVFcnJvci5TRVNTSU9OX05PVF9XUklUQUJMRSwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFNFU1NJT05fQ0xPU0VEIChtc2cgPSAnU2Vzc2lvbiBpcyBjbG9zZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NFU1NJT05fQ0xPU0VEJywgSHlwZXJjb3JlRXJyb3IuU0VTU0lPTl9DTE9TRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCQVRDSF9VTkZMVVNIRUQgKG1zZyA9ICdCYXRjaCBub3QgeWV0IGZsdXNoZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JBVENIX1VORkxVU0hFRCcsIEh5cGVyY29yZUVycm9yLkJBVENIX1VORkxVU0hFRCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIEJBVENIX0FMUkVBRFlfRVhJU1RTIChtc2cgPSAnQmF0Y2ggYWxyZWFkeSBleGlzdHMnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JBVENIX0FMUkVBRFlfRVhJU1RTJywgSHlwZXJjb3JlRXJyb3IuQkFUQ0hfQUxSRUFEWV9FWElTVFMsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBCQVRDSF9BTFJFQURZX0ZMVVNIRUQgKG1zZyA9ICdCYXRjaCBoYXMgYWxyZWFkeSBiZWVuIGZsdXNoZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0JBVENIX0FMUkVBRFlfRkxVU0hFRCcsIEh5cGVyY29yZUVycm9yLkJBVENIX0FMUkVBRFlfRkxVU0hFRCwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIE9QTE9HX0NPUlJVUFQgKG1zZyA9ICdPcGxvZyBmaWxlIGFwcGVhcnMgY29ycnVwdCBvciBvdXQgb2YgZGF0ZScsIGRpc2NvdmVyeUtleSA9IG51bGwpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlRXJyb3IobXNnLCAnT1BMT0dfQ09SUlVQVCcsIEh5cGVyY29yZUVycm9yLk9QTE9HX0NPUlJVUFQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBPUExPR19IRUFERVJfT1ZFUkZMT1cgKG1zZyA9ICdPcGxvZyBoZWFkZXIgZXhjZWVkcyBwYWdlIHNpemUnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ09QTE9HX0hFQURFUl9PVkVSRkxPVycsIEh5cGVyY29yZUVycm9yLk9QTE9HX0hFQURFUl9PVkVSRkxPVywgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIElOVkFMSURfT1BMT0dfVkVSU0lPTiAobXNnID0gJ0ludmFsaWQgaGVhZGVyIHZlcnNpb24nLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ0lOVkFMSURfT1BMT0dfVkVSU0lPTicsIEh5cGVyY29yZUVycm9yLklOVkFMSURfT1BMT0dfVkVSU0lPTiwgZGlzY292ZXJ5S2V5KQogIH0KCiAgc3RhdGljIFdSSVRFX0ZBSUxFRCAobXNnID0gJ1dyaXRlIHRvIHN0b3JhZ2UgZmFpbGVkJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdXUklURV9GQUlMRUQnLCBIeXBlcmNvcmVFcnJvci5XUklURV9GQUlMRUQsIGRpc2NvdmVyeUtleSkKICB9CgogIHN0YXRpYyBERUNPRElOR19FUlJPUiAobXNnID0gJ0RlY29kaW5nIGVycm9yJywgZGlzY292ZXJ5S2V5ID0gbnVsbCkgewogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVFcnJvcihtc2csICdERUNPRElOR19FUlJPUicsIEh5cGVyY29yZUVycm9yLkRFQ09ESU5HX0VSUk9SLCBkaXNjb3ZlcnlLZXkpCiAgfQoKICBzdGF0aWMgU0VTU0lPTl9NT1ZFRCAobXNnID0gJ1Nlc3Npb24gbW92ZWQnLCBkaXNjb3ZlcnlLZXkgPSBudWxsKSB7CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZUVycm9yKG1zZywgJ1NFU1NJT05fTU9WRUQnLCBIeXBlcmNvcmVFcnJvci5TRVNTSU9OX01PVkVELCBkaXNjb3ZlcnlLZXkpCiAgfQp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUtZXJyb3JzIiwKICAidmVyc2lvbiI6ICIxLjUuMCIsCiAgImRlc2NyaXB0aW9uIjogIkh5cGVyY29yZSBlcnJvcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1lcnJvcnMuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWVycm9ycy9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyY29yZS1lcnJvcnMjcmVhZG1lIiwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImJyaXR0bGUiOiAiXjMuMS4zIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMy4wIgogIH0KfQpjb25zdCB6MzIgPSByZXF1aXJlKCd6MzInKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgZW5jb2RlLAogIGRlY29kZSwKICBub3JtYWxpemUsCiAgaXNWYWxpZAp9CgpmdW5jdGlvbiBlbmNvZGUgKGtleSkgewogIGlmICghYjRhLmlzQnVmZmVyKGtleSkpIHRocm93IG5ldyBFcnJvcignS2V5IG11c3QgYmUgYSBCdWZmZXInKQogIGlmIChrZXkuYnl0ZUxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcignS2V5IG11c3QgYmUgMzItYnl0ZXMgbG9uZycpCiAgcmV0dXJuIHozMi5lbmNvZGUoa2V5KQp9CgpmdW5jdGlvbiBkZWNvZGUgKGlkKSB7CiAgaWYgKGI0YS5pc0J1ZmZlcihpZCkpIHsKICAgIGlmIChpZC5ieXRlTGVuZ3RoICE9PSAzMikgdGhyb3cgbmV3IEVycm9yKCdJRCBtdXN0IGJlIDMyLWJ5dGVzIGxvbmcnKQogICAgcmV0dXJuIGlkCiAgfQogIGlmICh0eXBlb2YgaWQgPT09ICdzdHJpbmcnKSB7CiAgICBpZiAoaWQuc3RhcnRzV2l0aCgncGVhcjovLycpKSBpZCA9IGlkLnNsaWNlKDcpLnNwbGl0KCcvJylbMF0KICAgIGlmIChpZC5sZW5ndGggPT09IDUyKSByZXR1cm4gejMyLmRlY29kZShpZCkKICAgIGlmIChpZC5sZW5ndGggPT09IDY0KSB7CiAgICAgIGNvbnN0IGJ1ZiA9IGI0YS5mcm9tKGlkLCAnaGV4JykKICAgICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoID09PSAzMikgcmV0dXJuIGJ1ZgogICAgfQogIH0KICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgSHlwZXJjb3JlIGtleScpCn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZSAoYW55KSB7CiAgcmV0dXJuIGVuY29kZShkZWNvZGUoYW55KSkKfQoKZnVuY3Rpb24gaXNWYWxpZCAoYW55KSB7CiAgdHJ5IHsKICAgIGRlY29kZShhbnkpCiAgICByZXR1cm4gdHJ1ZQogIH0gY2F0Y2ggewogICAgcmV0dXJuIGZhbHNlCiAgfQp9CnsKICAibmFtZSI6ICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciLAogICJ2ZXJzaW9uIjogIjEuMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiQ29udmVydCBIeXBlcmNvcmUga2V5cyB0by9mcm9tIHotYmFzZTMyIG9yIGhleCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNS4zIiwKICAgICJ6MzIiOiAiXjEuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjEuMSIsCiAgICAiaHlwZXJjb3JlIjogIl4xMC4wLjAiLAogICAgInJhbmRvbS1hY2Nlc3MtbWVtb3J5IjogIl42LjAuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUtaWQtZW5jb2RpbmcuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogW10sCiAgImF1dGhvciI6ICIiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWlkLWVuY29kaW5nL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJjb3JlLWlkLWVuY29kaW5nI3JlYWRtZSIKfQpjb25zdCBSb2Nrc0RCID0gcmVxdWlyZSgncm9ja3NkYi1uYXRpdmUnKQpjb25zdCBycnAgPSByZXF1aXJlKCdyZXNvbHZlLXJlamVjdC1wcm9taXNlJykKY29uc3QgU2NvcGVMb2NrID0gcmVxdWlyZSgnc2NvcGUtbG9jaycpCmNvbnN0IERldmljZUZpbGUgPSByZXF1aXJlKCdkZXZpY2UtZmlsZScpCmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJykKY29uc3QgZnMgPSByZXF1aXJlKCdmcycpCmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuL2xpYi92aWV3LmpzJykKCmNvbnN0IFZFUlNJT04gPSAxCmNvbnN0IENPTFVNTl9GQU1JTFkgPSAnY29yZXN0b3JlJwoKY29uc3QgeyBzdG9yZSwgY29yZSB9ID0gcmVxdWlyZSgnLi9saWIva2V5cy5qcycpCgpjb25zdCB7IENvcmVzdG9yZVJYLCBDb3Jlc3RvcmVUWCwgQ29yZVRYLCBDb3JlUlggfSA9IHJlcXVpcmUoJy4vbGliL3R4LmpzJykKCmNvbnN0IHsKICBjcmVhdGVDb3JlU3RyZWFtLAogIGNyZWF0ZUFsaWFzU3RyZWFtLAogIGNyZWF0ZURpc2NvdmVyeUtleVN0cmVhbSwKICBjcmVhdGVCbG9ja1N0cmVhbSwKICBjcmVhdGVCaXRmaWVsZFN0cmVhbSwKICBjcmVhdGVVc2VyRGF0YVN0cmVhbSwKICBjcmVhdGVUcmVlTm9kZVN0cmVhbSwKICBjcmVhdGVMb2NhbFN0cmVhbQp9ID0gcmVxdWlyZSgnLi9saWIvc3RyZWFtcy5qcycpCgpjb25zdCBFTVBUWSA9IG5ldyBWaWV3KCkKCmNsYXNzIEF0b20gewogIGNvbnN0cnVjdG9yKGRiKSB7CiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMudmlldyA9IG5ldyBWaWV3KCkKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBudWxsCiAgICB0aGlzLmZsdXNoaW5nID0gZmFsc2UKICAgIHRoaXMuZmx1c2hlcyA9IFtdCiAgfQoKICBvbmZsdXNoKGZuKSB7CiAgICB0aGlzLmZsdXNoZXMucHVzaChmbikKICB9CgogIGZsdXNoZWQoKSB7CiAgICBpZiAoIXRoaXMuZmx1c2hpbmcpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuZmx1c2hlZFByb21pc2UgIT09IG51bGwpIHJldHVybiB0aGlzLmZsdXNoZWRQcm9taXNlLnByb21pc2UKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBycnAoKQogICAgcmV0dXJuIHRoaXMuZmx1c2hlZFByb21pc2UucHJvbWlzZQogIH0KCiAgX3Jlc29sdmUoKSB7CiAgICBjb25zdCBmID0gdGhpcy5mbHVzaGVkUHJvbWlzZQogICAgdGhpcy5mbHVzaGVkUHJvbWlzZSA9IG51bGwKICAgIGYucmVzb2x2ZSgpCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICh0aGlzLmZsdXNoaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ0F0b20gYWxyZWFkeSBmbHVzaGluZycpCiAgICB0aGlzLmZsdXNoaW5nID0gdHJ1ZQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IFZpZXcuZmx1c2godGhpcy52aWV3LmNoYW5nZXMsIHRoaXMuZGIpCiAgICAgIHRoaXMudmlldy5yZXNldCgpCgogICAgICBjb25zdCBwcm9taXNlcyA9IFtdCiAgICAgIGNvbnN0IGxlbiA9IHRoaXMuZmx1c2hlcy5sZW5ndGggLy8gaW4gY2FzZSBvZiByZWVudHJ5CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHByb21pc2VzLnB1c2godGhpcy5mbHVzaGVzW2ldKCkpCgogICAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuZmx1c2hpbmcgPSBmYWxzZQogICAgICBpZiAodGhpcy5mbHVzaGVkUHJvbWlzZSAhPT0gbnVsbCkgdGhpcy5fcmVzb2x2ZSgpCiAgICB9CiAgfQp9CgpjbGFzcyBIeXBlcmNvcmVTdG9yYWdlIHsKICBjb25zdHJ1Y3RvcihzdG9yZSwgZGIsIGNvcmUsIHZpZXcsIGF0b20pIHsKICAgIHRoaXMuc3RvcmUgPSBzdG9yZQogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLnZpZXcgPSB2aWV3CiAgICB0aGlzLmF0b20gPSBhdG9tCgogICAgdGhpcy52aWV3LnJlYWRTdGFydCgpCiAgfQoKICBnZXQgcmVhZE9ubHkoKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yZS5yZWFkT25seQogIH0KCiAgZ2V0IGRlcGVuZGVuY2llcygpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCiAgfQoKICBnZXREZXBlbmRlbmN5TGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoCiAgICAgID8gdGhpcy5jb3JlLmRlcGVuZGVuY2llc1t0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aCAtIDFdLmxlbmd0aAogICAgICA6IC0xCiAgfQoKICBnZXREZXBlbmRlbmN5KGxlbmd0aCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgZGVwID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llc1tpXQogICAgICBpZiAoZGVwLmxlbmd0aCA8IGxlbmd0aCkgcmV0dXJuIGRlcAogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBzZXREZXBlbmRlbmN5SGVhZChkZXApIHsKICAgIGNvbnN0IGRlcHMgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCgogICAgZm9yIChsZXQgaSA9IGRlcHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgZCA9IGRlcHNbaV0KCiAgICAgIGlmIChkLmRhdGFQb2ludGVyICE9PSBkZXAuZGF0YVBvaW50ZXIpIGNvbnRpbnVlCgogICAgICAvLyBjaGVjayBpZiBub3RoaW5nIGNoYW5nZWQKICAgICAgaWYgKGQubGVuZ3RoID09PSBkZXAubGVuZ3RoICYmIGkgPT09IGRlcHMubGVuZ3RoIC0gMSkgcmV0dXJuCgogICAgICB0aGlzLmNvcmUgPSB7CiAgICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgICBkYXRhUG9pbnRlcjogdGhpcy5jb3JlLmRhdGFQb2ludGVyLAogICAgICAgIGRlcGVuZGVuY2llczogZGVwcy5zbGljZSgwLCBpICsgMSkKICAgICAgfQoKICAgICAgdGhpcy5jb3JlLmRlcGVuZGVuY2llc1tpXSA9IHsKICAgICAgICBkYXRhUG9pbnRlcjogZGVwLmRhdGFQb2ludGVyLAogICAgICAgIGxlbmd0aDogZGVwLmxlbmd0aAogICAgICB9CiAgICB9CgogICAgdGhpcy5jb3JlLmRlcGVuZGVuY2llcyA9IFsKICAgICAgewogICAgICAgIGRhdGFQb2ludGVyOiBkZXAuZGF0YVBvaW50ZXIsCiAgICAgICAgbGVuZ3RoOiBkZXAubGVuZ3RoCiAgICAgIH0KICAgIF0KICB9CgogIC8vIFRPRE86IHRoaXMgbWlnaHQgaGF2ZSB0byBiZSBhc3luYyBpZiB0aGUgZGVwZW5kZW50cyBoYXZlIGNoYW5nZWQsIGJ1dCBwcm9wIG9rIGZvciBub3cKICB1cGRhdGVEZXBlbmRlbmN5TGVuZ3RoKGxlbmd0aCwgdHJ1bmNhdGVkKSB7CiAgICBjb25zdCBkZXBzID0gdGhpcy5jb3JlLmRlcGVuZGVuY2llcwoKICAgIGNvbnN0IGkgPSB0aGlzLmZpbmREZXBlbmRlbmN5SW5kZXgobGVuZ3RoLCB0cnVuY2F0ZWQpCiAgICBpZiAoaSA9PT0gLTEpIHRocm93IG5ldyBFcnJvcignRGVwZW5kZW5jeSBub3QgZm91bmQnKQoKICAgIHRoaXMuY29yZSA9IHsKICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgZGF0YVBvaW50ZXI6IHRoaXMuY29yZS5kYXRhUG9pbnRlciwKICAgICAgZGVwZW5kZW5jaWVzOiBkZXBzLnNsaWNlKDAsIGkgKyAxKQogICAgfQoKICAgIGlmICh0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW2ldLmxlbmd0aCAhPT0gbGVuZ3RoKSB7CiAgICAgIHRoaXMuY29yZS5kZXBlbmRlbmNpZXNbaV0gPSB7CiAgICAgICAgZGF0YVBvaW50ZXI6IGRlcHNbaV0uZGF0YVBvaW50ZXIsCiAgICAgICAgbGVuZ3RoCiAgICAgIH0KICAgIH0KICB9CgogIGZpbmREZXBlbmRlbmN5SW5kZXgobGVuZ3RoLCB0cnVuY2F0ZWQpIHsKICAgIGNvbnN0IGRlcHMgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzCgogICAgaWYgKHRydW5jYXRlZCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoZGVwc1tpXS5sZW5ndGggPj0gbGVuZ3RoKSByZXR1cm4gaQogICAgICB9CgogICAgICByZXR1cm4gLTEKICAgIH0KCiAgICBmb3IgKGxldCBpID0gZGVwcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAoZGVwc1tpXS5sZW5ndGggPD0gbGVuZ3RoKSByZXR1cm4gaQogICAgfQoKICAgIHJldHVybiAtMQogIH0KCiAgZ2V0IHNuYXBzaG90dGVkKCkgewogICAgcmV0dXJuIHRoaXMuZGIuX3NuYXBzaG90ICE9PSBudWxsCiAgfQoKICBzbmFwc2hvdCgpIHsKICAgIHJldHVybiBuZXcgSHlwZXJjb3JlU3RvcmFnZSgKICAgICAgdGhpcy5zdG9yZSwKICAgICAgdGhpcy5kYi5zbmFwc2hvdCgpLAogICAgICB0aGlzLmNvcmUsCiAgICAgIHRoaXMudmlldy5zbmFwc2hvdCgpLAogICAgICB0aGlzLmF0b20KICAgICkKICB9CgogIGNvbXBhY3QoKSB7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoWwogICAgICB0aGlzLmRiLmNvbXBhY3RSYW5nZShjb3JlLmNvcmUodGhpcy5jb3JlLmNvcmVQb2ludGVyKSwgY29yZS5jb3JlKHRoaXMuY29yZS5jb3JlUG9pbnRlcikpLAogICAgICB0aGlzLmRiLmNvbXBhY3RSYW5nZShjb3JlLmRhdGEodGhpcy5jb3JlLmRhdGFQb2ludGVyKSwgY29yZS5kYXRhKHRoaXMuY29yZS5kYXRhUG9pbnRlcikpCiAgICBdKQogIH0KCiAgYXRvbWl6ZShhdG9tKSB7CiAgICBpZiAodGhpcy5hdG9tICYmIHRoaXMuYXRvbSAhPT0gYXRvbSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBhdG9taXplIGFuZCBhdG9taXplZCBzZXNzaW9uIHdpdGggYSBuZXcgYXRvbScpCiAgICB9CiAgICByZXR1cm4gbmV3IEh5cGVyY29yZVN0b3JhZ2UodGhpcy5zdG9yZSwgdGhpcy5kYi5zZXNzaW9uKCksIHRoaXMuY29yZSwgYXRvbS52aWV3LCBhdG9tKQogIH0KCiAgY3JlYXRlQXRvbSgpIHsKICAgIHJldHVybiB0aGlzLnN0b3JlLmNyZWF0ZUF0b20oKQogIH0KCiAgY3JlYXRlQmxvY2tTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZUJsb2NrU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlVHJlZU5vZGVTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZVRyZWVOb2RlU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlQml0ZmllbGRTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZUJpdGZpZWxkU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlVXNlckRhdGFTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZVVzZXJEYXRhU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgY3JlYXRlTG9jYWxTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIGNyZWF0ZUxvY2FsU3RyZWFtKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3LCBvcHRzKQogIH0KCiAgYXN5bmMgcmVzdW1lU2Vzc2lvbihuYW1lKSB7CiAgICBjb25zdCByeCA9IHRoaXMucmVhZCgpCiAgICBjb25zdCBleGlzdGluZ1Nlc3Npb25zUHJvbWlzZSA9IHJ4LmdldFNlc3Npb25zKCkKCiAgICByeC50cnlGbHVzaCgpCiAgICBjb25zdCBleGlzdGluZ1Nlc3Npb25zID0gYXdhaXQgZXhpc3RpbmdTZXNzaW9uc1Byb21pc2UKCiAgICBjb25zdCBzZXNzaW9ucyA9IGV4aXN0aW5nU2Vzc2lvbnMgfHwgW10KICAgIGNvbnN0IHNlc3Npb24gPSBnZXRCYXRjaChzZXNzaW9ucywgbmFtZSwgZmFsc2UpCgogICAgaWYgKHNlc3Npb24gPT09IG51bGwpIHJldHVybiBudWxsCgogICAgY29uc3QgY29yZSA9IHsKICAgICAgY29yZVBvaW50ZXI6IHRoaXMuY29yZS5jb3JlUG9pbnRlciwKICAgICAgZGF0YVBvaW50ZXI6IHNlc3Npb24uZGF0YVBvaW50ZXIsCiAgICAgIGRlcGVuZGVuY2llczogW10KICAgIH0KCiAgICBjb25zdCBjb3JlUnggPSBuZXcgQ29yZVJYKGNvcmUsIHRoaXMuZGIsIHRoaXMudmlldykKCiAgICBjb25zdCBkZXBlbmRlbmN5UHJvbWlzZSA9IGNvcmVSeC5nZXREZXBlbmRlbmN5KCkKICAgIGNvcmVSeC50cnlGbHVzaCgpCgogICAgY29uc3QgZGVwZW5kZW5jeSA9IGF3YWl0IGRlcGVuZGVuY3lQcm9taXNlCiAgICBpZiAoZGVwZW5kZW5jeSkgY29yZS5kZXBlbmRlbmNpZXMgPSB0aGlzLl9hZGREZXBlbmRlbmN5KGRlcGVuZGVuY3kpCgogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVTdG9yYWdlKAogICAgICB0aGlzLnN0b3JlLAogICAgICB0aGlzLmRiLnNlc3Npb24oKSwKICAgICAgY29yZSwKICAgICAgdGhpcy5hdG9tID8gdGhpcy52aWV3IDogbmV3IFZpZXcoKSwKICAgICAgdGhpcy5hdG9tCiAgICApCiAgfQoKICBhc3luYyBjcmVhdGVTZXNzaW9uKG5hbWUsIGhlYWQpIHsKICAgIGNvbnN0IHJ4ID0gdGhpcy5yZWFkKCkKCiAgICBjb25zdCBleGlzdGluZ1Nlc3Npb25zUHJvbWlzZSA9IHJ4LmdldFNlc3Npb25zKCkKICAgIGNvbnN0IGV4aXN0aW5nSGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgW2V4aXN0aW5nU2Vzc2lvbnMsIGV4aXN0aW5nSGVhZF0gPSBhd2FpdCBQcm9taXNlLmFsbChbCiAgICAgIGV4aXN0aW5nU2Vzc2lvbnNQcm9taXNlLAogICAgICBleGlzdGluZ0hlYWRQcm9taXNlCiAgICBdKQogICAgaWYgKGhlYWQgPT09IG51bGwpIGhlYWQgPSBleGlzdGluZ0hlYWQKCiAgICBpZiAoZXhpc3RpbmdIZWFkICE9PSBudWxsICYmIGhlYWQubGVuZ3RoID4gZXhpc3RpbmdIZWFkLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGVhZCBwYXNzZWQsIGFoZWFkIG9mIGNvcmUnKQogICAgfQoKICAgIGNvbnN0IHNlc3Npb25zID0gZXhpc3RpbmdTZXNzaW9ucyB8fCBbXQogICAgY29uc3Qgc2Vzc2lvbiA9IGdldEJhdGNoKHNlc3Npb25zLCBuYW1lLCB0cnVlKQogICAgY29uc3QgZnJlc2ggPSBzZXNzaW9uLmRhdGFQb2ludGVyID09PSAtMQoKICAgIGlmIChmcmVzaCkgewogICAgICBzZXNzaW9uLmRhdGFQb2ludGVyID0gYXdhaXQgdGhpcy5zdG9yZS5fYWxsb2NEYXRhKCkKICAgIH0KCiAgICBjb25zdCB0eCA9IHRoaXMud3JpdGUoKQoKICAgIHR4LnNldFNlc3Npb25zKHNlc3Npb25zKQoKICAgIGNvbnN0IGxlbmd0aCA9IGhlYWQgPT09IG51bGwgPyAwIDogaGVhZC5sZW5ndGgKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIGNvcmVQb2ludGVyOiB0aGlzLmNvcmUuY29yZVBvaW50ZXIsCiAgICAgIGRhdGFQb2ludGVyOiBzZXNzaW9uLmRhdGFQb2ludGVyLAogICAgICBkZXBlbmRlbmNpZXM6IHRoaXMuX2FkZERlcGVuZGVuY3koewogICAgICAgIGRhdGFQb2ludGVyOiB0aGlzLmNvcmUuZGF0YVBvaW50ZXIsCiAgICAgICAgbGVuZ3RoCiAgICAgIH0pCiAgICB9CgogICAgY29uc3QgY29yZVR4ID0gbmV3IENvcmVUWChjb3JlLCB0aGlzLmRiLCB0eC52aWV3LCB0eC5jaGFuZ2VzKQoKICAgIGlmIChsZW5ndGggPiAwKSBjb3JlVHguc2V0SGVhZChoZWFkKQogICAgY29yZVR4LnNldERlcGVuZGVuY3koY29yZS5kZXBlbmRlbmNpZXNbY29yZS5kZXBlbmRlbmNpZXMubGVuZ3RoIC0gMV0pCgogICAgaWYgKCFmcmVzaCkgewogICAgICAvLyBudWtlIGFsbCBleGlzdGluZyBzdGF0ZS4uLgogICAgICBjb3JlVHguZGVsZXRlQmxvY2tSYW5nZSgwLCAtMSkKICAgICAgY29yZVR4LmRlbGV0ZVRyZWVOb2RlUmFuZ2UoMCwgLTEpCiAgICAgIGNvcmVUeC5kZWxldGVCaXRmaWVsZFBhZ2VSYW5nZSgwLCAtMSkKICAgIH0KCiAgICBhd2FpdCB0eC5mbHVzaCgpCgogICAgcmV0dXJuIG5ldyBIeXBlcmNvcmVTdG9yYWdlKAogICAgICB0aGlzLnN0b3JlLAogICAgICB0aGlzLmRiLnNlc3Npb24oKSwKICAgICAgY29yZSwKICAgICAgdGhpcy5hdG9tID8gdGhpcy52aWV3IDogbmV3IFZpZXcoKSwKICAgICAgdGhpcy5hdG9tCiAgICApCiAgfQoKICBhc3luYyBjcmVhdGVBdG9taWNTZXNzaW9uKGF0b20sIGhlYWQpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGhlYWQgPT09IG51bGwgPyAwIDogaGVhZC5sZW5ndGgKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIGNvcmVQb2ludGVyOiB0aGlzLmNvcmUuY29yZVBvaW50ZXIsCiAgICAgIGRhdGFQb2ludGVyOiB0aGlzLmNvcmUuZGF0YVBvaW50ZXIsCiAgICAgIGRlcGVuZGVuY2llczogdGhpcy5fYWRkRGVwZW5kZW5jeShudWxsKQogICAgfQoKICAgIGNvbnN0IGNvcmVUeCA9IG5ldyBDb3JlVFgoY29yZSwgdGhpcy5kYiwgYXRvbS52aWV3LCBbXSkKCiAgICBpZiAobGVuZ3RoID4gMCkgY29yZVR4LnNldEhlYWQoaGVhZCkKCiAgICBhd2FpdCBjb3JlVHguZmx1c2goKQoKICAgIHJldHVybiB0aGlzLmF0b21pemUoYXRvbSkKICB9CgogIF9hZGREZXBlbmRlbmN5KGRlcCkgewogICAgY29uc3QgZGVwcyA9IFtdCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGQgPSB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzW2ldCgogICAgICBpZiAoZGVwICE9PSBudWxsICYmIGQubGVuZ3RoID4gZGVwLmxlbmd0aCkgewogICAgICAgIGlmIChkLmRhdGFQb2ludGVyICE9PSBkZXAuZGF0YVBvaW50ZXIpIHsKICAgICAgICAgIGRlcHMucHVzaCh7IGRhdGFQb2ludGVyOiBkLmRhdGFQb2ludGVyLCBsZW5ndGg6IGRlcC5sZW5ndGggfSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlcHMKICAgICAgfQoKICAgICAgZGVwcy5wdXNoKGQpCiAgICB9CgogICAgaWYgKAogICAgICBkZXAgIT09IG51bGwgJiYKICAgICAgKGRlcHMubGVuZ3RoID09PSAwIHx8IGRlcHNbZGVwcy5sZW5ndGggLSAxXS5kYXRhUG9pbnRlciAhPT0gZGVwLmRhdGFQb2ludGVyKQogICAgKSB7CiAgICAgIGRlcHMucHVzaChkZXApCiAgICB9CiAgICByZXR1cm4gZGVwcwogIH0KCiAgcmVhZCgpIHsKICAgIHJldHVybiBuZXcgQ29yZVJYKHRoaXMuY29yZSwgdGhpcy5kYiwgdGhpcy52aWV3KQogIH0KCiAgd3JpdGUoKSB7CiAgICByZXR1cm4gbmV3IENvcmVUWCh0aGlzLmNvcmUsIHRoaXMuZGIsIHRoaXMuYXRvbSA/IHRoaXMudmlldyA6IG51bGwsIFtdKQogIH0KCiAgY2xvc2UoKSB7CiAgICBpZiAodGhpcy52aWV3ICE9PSBudWxsKSB7CiAgICAgIHRoaXMudmlldy5yZWFkU3RvcCgpCiAgICAgIHRoaXMudmlldyA9IG51bGwKICAgIH0KCiAgICByZXR1cm4gdGhpcy5kYi5jbG9zZSgpCiAgfQoKICBzdGF0aWMgYXN5bmMgZXhwb3J0KHB0ciwgZGIsIHsgYmF0Y2hlcyA9IGZhbHNlIH0gPSB7fSkgewogICAgY29uc3QgcnggPSBuZXcgQ29yZVJYKHB0ciwgZGIsIEVNUFRZKQoKICAgIGNvbnN0IGNvcmUgPSB7CiAgICAgIGhlYWQ6IG51bGwsCiAgICAgIGF1dGg6IG51bGwsCiAgICAgIHNlc3Npb25zOiBbXSwKICAgICAgZGF0YTogbnVsbAogICAgfQoKICAgIGNvbnN0IHNlc3Npb25zUHJvbWlzZSA9IHJ4LmdldFNlc3Npb25zKCkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IHJ4LmdldEF1dGgoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBbc2Vzc2lvbnMsIGhlYWQsIGF1dGhdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3Nlc3Npb25zUHJvbWlzZSwgaGVhZFByb21pc2UsIGF1dGhQcm9taXNlXSkKCiAgICBjb3JlLmhlYWQgPSBoZWFkCiAgICBjb3JlLmF1dGggPSB7IC4uLmF1dGgsIGtleVBhaXI6IG51bGwgfQogICAgaWYgKHNlc3Npb25zKSBjb3JlLnNlc3Npb25zID0gc2Vzc2lvbnMubWFwKChzKSA9PiBzLm5hbWUpCgogICAgY29uc3QgZGF0YSA9IFtdCgogICAgZGF0YS5wdXNoKGV4cG9ydERhdGEocHRyLCBkYikpCgogICAgaWYgKGJhdGNoZXMpIHsKICAgICAgZm9yIChjb25zdCB7IGRhdGFQb2ludGVyIH0gb2Ygc2Vzc2lvbnMpIHsKICAgICAgICBkYXRhLnB1c2goZXhwb3J0RGF0YSh7IGRhdGFQb2ludGVyLCBkZXBlbmRlbmNpZXM6IFtdIH0sIGRiKSkKICAgICAgfQogICAgfQoKICAgIGNvcmUuZGF0YSA9IGF3YWl0IFByb21pc2UuYWxsKGRhdGEpCgogICAgcmV0dXJuIGNvcmUKICB9Cn0KCmNsYXNzIENvcmVzdG9yZVN0b3JhZ2UgewogIGNvbnN0cnVjdG9yKGRiLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHN0b3JhZ2UgPSB0eXBlb2YgZGIgPT09ICdzdHJpbmcnID8gZGIgOiBudWxsCgogICAgdGhpcy5ib290c3RyYXAgPSBzdG9yYWdlICE9PSBudWxsCiAgICB0aGlzLnBhdGggPSBzdG9yYWdlICE9PSBudWxsID8gc3RvcmFnZSA6IHBhdGguam9pbihkYi5wYXRoLCAnLi4nKQogICAgdGhpcy5yZWFkT25seSA9ICEhb3B0cy5yZWFkT25seQogICAgdGhpcy5hbGxvd0JhY2t1cCA9ICEhb3B0cy5hbGxvd0JhY2t1cAogICAgdGhpcy5kZXZpY2VGaWxlID0gbnVsbAogICAgdGhpcy53YWl0ID0gISFvcHRzLndhaXQKCiAgICAvLyB0bXAgc3luYyBmaXggZm9yIHNpbXBsaWN0eSBzaW5jZSBub3Qgc3VwZXIgZGVwbG95ZWQgeWV0CiAgICBpZiAodGhpcy5ib290c3RyYXAgJiYgIXRoaXMucmVhZE9ubHkpIHRtcEZpeFN0b3JhZ2UodGhpcy5wYXRoKQoKICAgIHRoaXMuaWQgPSBvcHRzLmlkIHx8IG51bGwKICAgIHRoaXMudmlldyA9IG51bGwKICAgIHRoaXMuZW50ZXJzID0gMAogICAgdGhpcy5sb2NrID0gbmV3IFNjb3BlTG9jaygpCiAgICB0aGlzLmZsdXNoaW5nID0gbnVsbAogICAgdGhpcy52ZXJzaW9uID0gMAogICAgdGhpcy5taWdyYXRpbmcgPSBudWxsCgogICAgaWYgKCh0aGlzLmJvb3RzdHJhcCAmJiAhdGhpcy5yZWFkT25seSAmJiAhdGhpcy5hbGxvd0JhY2t1cCkgfHwgdGhpcy53YWl0KSB7CiAgICAgIGNvbnN0IGNvcmVzdG9yZUZpbGUgPSBwYXRoLmpvaW4odGhpcy5wYXRoLCAnQ09SRVNUT1JFJykKCiAgICAgIHRoaXMuZGV2aWNlRmlsZSA9IG5ldyBEZXZpY2VGaWxlKGNvcmVzdG9yZUZpbGUsIHsKICAgICAgICBsb2NrOiB0cnVlLAogICAgICAgIHdhaXQ6IHRoaXMud2FpdCwKICAgICAgICBkYXRhOiB7IGlkOiB0aGlzLmlkIH0KICAgICAgfSkKICAgIH0KCiAgICBjb25zdCBkYlBhdGggPSBwYXRoLmpvaW4odGhpcy5wYXRoLCAnZGInKQoKICAgIHRoaXMucm9ja3MgPSBzdG9yYWdlID09PSBudWxsID8gZGIgOiBuZXcgUm9ja3NEQihkYlBhdGgsIHsgLi4ub3B0cywgbG9jazogdGhpcy5kZXZpY2VGaWxlIH0pCiAgICB0aGlzLmRiID0gY3JlYXRlQ29sdW1uRmFtaWx5KHRoaXMucm9ja3MsIG9wdHMpCiAgfQoKICBnZXQgb3BlbmVkKCkgewogICAgcmV0dXJuIHRoaXMuZGIub3BlbmVkCiAgfQoKICBnZXQgY2xvc2VkKCkgewogICAgcmV0dXJuIHRoaXMuZGIuY2xvc2VkCiAgfQoKICBhc3luYyByZWFkeSgpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCiAgICByZXR1cm4gdGhpcy5kYi5yZWFkeSgpCiAgfQoKICBjb21wYWN0KCkgewogICAgcmV0dXJuIHRoaXMuZGIuY29tcGFjdFJhbmdlKCkKICB9CgogIGFzeW5jIGF1ZGl0KCkgewogICAgZm9yIGF3YWl0IChjb25zdCB7IGNvcmUgfSBvZiB0aGlzLmNyZWF0ZUNvcmVTdHJlYW0oKSkgewogICAgICBjb25zdCBjb3JlUnggPSBuZXcgQ29yZVJYKGNvcmUsIHRoaXMuZGIsIEVNUFRZKQogICAgICBjb25zdCBhdXRoUHJvbWlzZSA9IGNvcmVSeC5nZXRBdXRoKCkKCiAgICAgIGNvcmVSeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBhdXRoID0gYXdhaXQgYXV0aFByb21pc2UKCiAgICAgIGlmICghYXV0aC5tYW5pZmVzdCB8fCBhdXRoLm1hbmlmZXN0LnZlcnNpb24gPiAwKSBjb250aW51ZQogICAgICBpZiAoYXV0aC5tYW5pZmVzdC5saW5rZWQgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICBhdXRoLm1hbmlmZXN0LmxpbmtlZCA9IG51bGwKICAgICAgY29uc3QgY29yZVR4ID0gbmV3IENvcmVUWChjb3JlLCB0aGlzLmRiLCBudWxsLCBbXSkKICAgICAgY29yZVR4LnNldEF1dGgoYXV0aCkKICAgICAgYXdhaXQgY29yZVR4LmZsdXNoKCkKICAgIH0KICB9CgogIGFzeW5jIGRlbGV0ZUNvcmUocHRyKSB7CiAgICBjb25zdCByeCA9IG5ldyBDb3JlUlgocHRyLCB0aGlzLmRiLCBFTVBUWSkKCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IHJ4LmdldEF1dGgoKQogICAgY29uc3Qgc2Vzc2lvbnNQcm9taXNlID0gcnguZ2V0U2Vzc2lvbnMoKQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBhdXRoID0gYXdhaXQgYXV0aFByb21pc2UKICAgIGNvbnN0IHNlc3Npb25zID0gYXdhaXQgc2Vzc2lvbnNQcm9taXNlCgogICAgLy8gbm8gY29yZSBzdG9yZWQgaGVyZQogICAgaWYgKCFhdXRoKSByZXR1cm4KCiAgICBjb25zdCB0eCA9IHRoaXMuZGIud3JpdGUoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQoKICAgIHR4LnRyeURlbGV0ZShzdG9yZS5jb3JlKGF1dGguZGlzY292ZXJ5S2V5KSkKCiAgICAvLyBjbGVhciBjb3JlCiAgICBjb25zdCBzdGFydCA9IGNvcmUuY29yZShwdHIuY29yZVBvaW50ZXIpCiAgICBjb25zdCBlbmQgPSBjb3JlLmNvcmUocHRyLmNvcmVQb2ludGVyICsgMSkKICAgIHR4LnRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpCgogICAgaWYgKHNlc3Npb25zKSB7CiAgICAgIGZvciAoY29uc3QgeyBkYXRhUG9pbnRlciB9IG9mIHNlc3Npb25zKSB7CiAgICAgICAgY29uc3Qgc3RhcnQgPSBjb3JlLmRhdGEoZGF0YVBvaW50ZXIpCiAgICAgICAgY29uc3QgZW5kID0gY29yZS5kYXRhKGRhdGFQb2ludGVyICsgMSkKICAgICAgICB0eC50cnlEZWxldGVSYW5nZShzdGFydCwgZW5kKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHR4LmZsdXNoKCkKICB9CgogIHN0YXRpYyBpc0NvcmVTdG9yYWdlKGRiKSB7CiAgICByZXR1cm4gaXNDb3Jlc3RvcmVTdG9yYWdlKGRiKQogIH0KCiAgc3RhdGljIGZyb20oZGIpIHsKICAgIGlmIChpc0NvcmVzdG9yZVN0b3JhZ2UoZGIpKSByZXR1cm4gZGIKICAgIHJldHVybiBuZXcgdGhpcyhkYikKICB9CgogIGFzeW5jIF9mbHVzaCgpIHsKICAgIHdoaWxlICh0aGlzLmVudGVycyA+IDApIHsKICAgICAgYXdhaXQgdGhpcy5sb2NrLmxvY2soKQogICAgICBhd2FpdCB0aGlzLmxvY2sudW5sb2NrKCkKICAgIH0KICB9CgogIC8vIHJ1bnMgcHJlIGFueSBvdGhlciBtdXRhdGlvbiBhbmQgcmVhZAogIGFzeW5jIF9taWdyYXRlU3RvcmUoKSB7CiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQoKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLnZlcnNpb24gPT09IFZFUlNJT04pIHJldHVybgoKICAgICAgYXdhaXQgdGhpcy5fcHJlb3BlbgogICAgICBhd2FpdCB0aGlzLmRiLnJlYWR5KCkKCiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIHZpZXcpCiAgICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgICByeC50cnlGbHVzaCgpCiAgICAgIGNvbnN0IGhlYWQgPSBhd2FpdCBoZWFkUHJvbWlzZQoKICAgICAgY29uc3QgdmVyc2lvbiA9IGhlYWQgPT09IG51bGwgPyAwIDogaGVhZC52ZXJzaW9uCiAgICAgIGlmICh2ZXJzaW9uID09PSBWRVJTSU9OKSB7CiAgICAgICAgdGhpcy52ZXJzaW9uID0gVkVSU0lPTgogICAgICAgIHJldHVybgogICAgICB9CgogICAgICBjb25zdCB0YXJnZXQgPSB7IHZlcnNpb246IFZFUlNJT04sIGRyeVJ1bjogZmFsc2UgfQoKICAgICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgICAgY2FzZSAwOiB7CiAgICAgICAgICBhd2FpdCByZXF1aXJlKCcuL21pZ3JhdGlvbnMvMCcpLnN0b3JlKHRoaXMsIHRhcmdldCkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgJ1Vuc3VwcG9ydGVkIHZlcnNpb246ICcgKyB2ZXJzaW9uICsgJyAtIHlvdSBzaG91bGQgcHJvYmFibHkgdXBncmFkZSB5b3VyIGRlcGVuZGVuY2llcycKICAgICAgICAgICkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMudmVyc2lvbiA9IFZFUlNJT04KICAgIH0gZmluYWxseSB7CiAgICAgIGF3YWl0IHRoaXMuX2V4aXQoKQogICAgfQogIH0KCiAgLy8gcnVucyBwcmUgdGhlIGNvcmUgaXMgcmV0dXJuZWQgdG8gdGhlIHVzZXIKICBhc3luYyBfbWlncmF0ZUNvcmUoY29yZSwgZGlzY292ZXJ5S2V5LCB2ZXJzaW9uLCBsb2NrZWQpIHsKICAgIGNvbnN0IHZpZXcgPSBsb2NrZWQgPyB0aGlzLnZpZXcgOiBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICB0cnkgewogICAgICBpZiAodmVyc2lvbiA9PT0gVkVSU0lPTikgcmV0dXJuCgogICAgICBjb25zdCB0YXJnZXQgPSB7IHZlcnNpb246IFZFUlNJT04sIGRyeVJ1bjogZmFsc2UgfQoKICAgICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgICAgY2FzZSAwOiB7CiAgICAgICAgICBhd2FpdCByZXF1aXJlKCcuL21pZ3JhdGlvbnMvMCcpLmNvcmUoY29yZSwgdGFyZ2V0KQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAnVW5zdXBwb3J0ZWQgdmVyc2lvbjogJyArIHZlcnNpb24gKyAnIC0geW91IHNob3VsZCBwcm9iYWJseSB1cGdyYWRlIHlvdXIgZGVwZW5kZW5jaWVzJwogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGxvY2tlZCA9PT0gZmFsc2UpIHJldHVybgoKICAgICAgLy8gaWYgaXRzIGxvY2tlZCwgdGhlbiBtb3ZlIHRoZSBjb3JlIHN0YXRlIGludG8gdGhlIG1lbXZpZXcKICAgICAgLy8gaW4gY2FzZSB0aGUgY29yZSBpcyByZW9wZW5lZCBmcm9tIHRoZSBtZW12aWV3LCBwcmUgZmx1c2gKCiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgICAgY29uc3QgY29yZVByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgdHgucHV0Q29yZShkaXNjb3ZlcnlLZXksIGF3YWl0IGNvcmVQcm9taXNlKQogICAgICB0eC5hcHBseSgpCiAgICB9IGZpbmFsbHkgewogICAgICBpZiAoIWxvY2tlZCkgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CiAgfQoKICBhc3luYyBfZW50ZXIoKSB7CiAgICB0aGlzLmVudGVycysrCiAgICBhd2FpdCB0aGlzLmxvY2subG9jaygpCiAgICBpZiAodGhpcy52aWV3ID09PSBudWxsKSB0aGlzLnZpZXcgPSBuZXcgVmlldygpCiAgICByZXR1cm4gdGhpcy52aWV3CiAgfQoKICBhc3luYyBfZXhpdCgpIHsKICAgIHRoaXMuZW50ZXJzLS0KCiAgICBpZiAodGhpcy5mbHVzaGluZyA9PT0gbnVsbCkgdGhpcy5mbHVzaGluZyA9IHJycCgpCiAgICBjb25zdCBmbHVzaGVkID0gdGhpcy5mbHVzaGluZy5wcm9taXNlCgogICAgaWYgKHRoaXMuZW50ZXJzID09PSAwIHx8IHRoaXMudmlldy5zaXplKCkgPiAxMjgpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBWaWV3LmZsdXNoKHRoaXMudmlldy5jaGFuZ2VzLCB0aGlzLmRiKQogICAgICAgIHRoaXMuZmx1c2hpbmcucmVzb2x2ZSgpCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHRoaXMuZmx1c2hpbmcucmVqZWN0KGVycikKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLmZsdXNoaW5nID0gbnVsbAogICAgICAgIHRoaXMudmlldyA9IG51bGwKICAgICAgfQogICAgfQoKICAgIHRoaXMubG9jay51bmxvY2soKQogICAgcmV0dXJuIGZsdXNoZWQKICB9CgogIC8vIHdoZW4gdXNlZCB3aXRoIGNvcmUgY2F0Y2hlcyB0aGlzIGlzbnQgdHJhbnNhY3Rpb25hbCBmb3Igc2ltcGxpY2l0eSwgSE9XRVZFUiwgaXRzIGp1c3QgYSBudW1iZXIKICAvLyBzbyB3b3J0aCB0aGUgdHJhZGVvZmYKICBhc3luYyBfYWxsb2NEYXRhKCkgewogICAgbGV0IGRhdGFQb2ludGVyID0gMAoKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IGhlYWQgPSBhd2FpdCB0aGlzLl9nZXRIZWFkKHZpZXcpCgogICAgICBkYXRhUG9pbnRlciA9IGhlYWQuYWxsb2NhdGVkLmRhdGFzKysKCiAgICAgIHR4LnNldEhlYWQoaGVhZCkKICAgICAgdHguYXBwbHkoKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgICB9CgogICAgcmV0dXJuIGRhdGFQb2ludGVyCiAgfQoKICAvLyBleHBvc2VzIGhlcmUgc28gbWlncmF0aW9ucyBjYW4gZWFzaWx5IGFjY2VzcyB0aGUgaGVhZCBpbiBhbiBpbml0IHN0YXRlCiAgYXN5bmMgX2dldEhlYWQodmlldykgewogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgaGVhZCA9IGF3YWl0IGhlYWRQcm9taXNlCiAgICByZXR1cm4gaGVhZCA9PT0gbnVsbCA/IGluaXRTdG9yZUhlYWQoKSA6IGhlYWQKICB9CgogIGNyZWF0ZUF0b20oKSB7CiAgICByZXR1cm4gbmV3IEF0b20odGhpcy5kYikKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgYXdhaXQgdGhpcy5yb2Nrcy5mbHVzaCgpCiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmRiLmNsb3NlZCkgcmV0dXJuCiAgICBhd2FpdCB0aGlzLl9mbHVzaCgpCiAgICBhd2FpdCB0aGlzLmRiLmNsb3NlKCkKICAgIGF3YWl0IHRoaXMucm9ja3MuY2xvc2UoKQogICAgaWYgKHRoaXMuZGV2aWNlRmlsZSkgYXdhaXQgdGhpcy5kZXZpY2VGaWxlLmNsb3NlKCkKICB9CgogIGFzeW5jIGNsZWFyKCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCB2aWV3ID0gYXdhaXQgdGhpcy5fZW50ZXIoKQogICAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKCiAgICB0eC5jbGVhcigpCiAgICB0eC5hcHBseSgpCgogICAgYXdhaXQgdGhpcy5fZXhpdCgpCiAgfQoKICBjcmVhdGVDb3JlU3RyZWFtKCkgewogICAgLy8gVE9ETzogYmUgbmljZSB0byBydW4gdGhlIG1naXJhdGlvbiBoZXJlIGFsc28sIGJ1dCB0b28gbXVjaCBwbHVtYmluZyBhdG0KICAgIHJldHVybiBjcmVhdGVDb3JlU3RyZWFtKHRoaXMuZGIsIEVNUFRZKQogIH0KCiAgY3JlYXRlQWxpYXNTdHJlYW0obmFtZXNwYWNlKSB7CiAgICAvLyBUT0RPOiBiZSBuaWNlIHRvIHJ1biB0aGUgbWdpcmF0aW9uIGhlcmUgYWxzbywgYnV0IHRvbyBtdWNoIHBsdW1iaW5nIGF0bQogICAgcmV0dXJuIGNyZWF0ZUFsaWFzU3RyZWFtKHRoaXMuZGIsIEVNUFRZLCBuYW1lc3BhY2UpCiAgfQoKICBjcmVhdGVEaXNjb3ZlcnlLZXlTdHJlYW0obmFtZXNwYWNlKSB7CiAgICByZXR1cm4gY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtKHRoaXMuZGIsIEVNUFRZLCBuYW1lc3BhY2UpCiAgfQoKICBhc3luYyBnZXRBbGlhcyhhbGlhcykgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGRpc2NvdmVyeUtleVByb21pc2UgPSByeC5nZXRDb3JlQnlBbGlhcyhhbGlhcykKICAgIHJ4LnRyeUZsdXNoKCkKICAgIHJldHVybiBkaXNjb3ZlcnlLZXlQcm9taXNlCiAgfQoKICBhc3luYyBnZXRTZWVkKCkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGhlYWQgPSBhd2FpdCBoZWFkUHJvbWlzZQogICAgcmV0dXJuIGhlYWQgPT09IG51bGwgPyBudWxsIDogaGVhZC5zZWVkCiAgfQoKICBhc3luYyBzZXRTZWVkKHNlZWQsIHsgb3ZlcndyaXRlID0gdHJ1ZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgdHJ5IHsKICAgICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IGhlYWQgPSAoYXdhaXQgaGVhZFByb21pc2UpIHx8IGluaXRTdG9yZUhlYWQoKQoKICAgICAgaWYgKGhlYWQuc2VlZCA9PT0gbnVsbCB8fCBvdmVyd3JpdGUpIGhlYWQuc2VlZCA9IHNlZWQKICAgICAgdHguc2V0SGVhZChoZWFkKQogICAgICB0eC5hcHBseSgpCgogICAgICByZXR1cm4gaGVhZC5zZWVkCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9CgogIGFzeW5jIGdldERlZmF1bHREaXNjb3ZlcnlLZXkoKSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIEVNUFRZKQogICAgY29uc3QgaGVhZFByb21pc2UgPSByeC5nZXRIZWFkKCkKCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3QgaGVhZCA9IGF3YWl0IGhlYWRQcm9taXNlCiAgICByZXR1cm4gaGVhZCA9PT0gbnVsbCA/IG51bGwgOiBoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkKICB9CgogIGFzeW5jIHNldERlZmF1bHREaXNjb3ZlcnlLZXkoZGlzY292ZXJ5S2V5LCB7IG92ZXJ3cml0ZSA9IHRydWUgfSA9IHt9KSB7CiAgICBpZiAodGhpcy52ZXJzaW9uID09PSAwKSBhd2FpdCB0aGlzLl9taWdyYXRlU3RvcmUoKQoKICAgIGNvbnN0IHZpZXcgPSBhd2FpdCB0aGlzLl9lbnRlcigpCiAgICBjb25zdCB0eCA9IG5ldyBDb3Jlc3RvcmVUWCh2aWV3KQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVzdG9yZVJYKHRoaXMuZGIsIHZpZXcpCiAgICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBoZWFkID0gKGF3YWl0IGhlYWRQcm9taXNlKSB8fCBpbml0U3RvcmVIZWFkKCkKCiAgICAgIGlmIChoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPT09IG51bGwgfHwgb3ZlcndyaXRlKSBoZWFkLmRlZmF1bHREaXNjb3ZlcnlLZXkgPSBkaXNjb3ZlcnlLZXkKICAgICAgdHguc2V0SGVhZChoZWFkKQogICAgICB0eC5hcHBseSgpCgogICAgICByZXR1cm4gaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9CgogIGFzeW5jIGhhc0NvcmUoZGlzY292ZXJ5S2V5LCB7IGlmTWlncmF0ZWQgPSBmYWxzZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBwcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGNvcmUgPSBhd2FpdCBwcm9taXNlCgogICAgaWYgKGNvcmUgPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgaWYgKGNvcmUudmVyc2lvbiAhPT0gVkVSU0lPTiAmJiBpZk1pZ3JhdGVkKSByZXR1cm4gZmFsc2UKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgZ2V0QXV0aChkaXNjb3ZlcnlLZXkpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBjb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBjb3JlID0gYXdhaXQgY29yZVByb21pc2UKICAgIGlmIChjb3JlID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHJlYWQgPSB0aGlzLmRiLnJlYWQoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgY29uc3QgYXV0aFByb21pc2UgPSBDb3JlUlguZ2V0QXV0aChyZWFkLCBjb3JlKQoKICAgIHJlYWQudHJ5Rmx1c2goKQoKICAgIHJldHVybiBhdXRoUHJvbWlzZQogIH0KCiAgYXN5bmMgZ2V0SW5mbyhkaXNjb3ZlcnlLZXksIG9wdHMpIHsKICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRJbmZvcyhbZGlzY292ZXJ5S2V5XSwgb3B0cykpWzBdCiAgfQoKICBhc3luYyBnZXRJbmZvcyhkaXNjb3ZlcnlLZXlzLCB7IGF1dGggPSB0cnVlLCBoZWFkID0gdHJ1ZSwgaGludHMgPSB0cnVlIH0gPSB7fSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGNvcmVQcm9taXNlcyA9IG5ldyBBcnJheShkaXNjb3ZlcnlLZXlzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpc2NvdmVyeUtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29yZVByb21pc2VzW2ldID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXlzW2ldKQogICAgfQoKICAgIHJ4LnRyeUZsdXNoKCkKCiAgICBjb25zdCBjb3JlcyA9IGF3YWl0IFByb21pc2UuYWxsKGNvcmVQcm9taXNlcykKICAgIGNvbnN0IHJlYWQgPSB0aGlzLmRiLnJlYWQoeyBhdXRvRGVzdHJveTogdHJ1ZSB9KQoKICAgIGNvbnN0IHJlc3VsdFByb21pc2VzID0gbmV3IEFycmF5KGNvcmVzLmxlbmd0aCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvcmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFByb21pc2VzW2ldID0gY29yZXNbaV0KICAgICAgICA/IGdldEluZm9Gcm9tQmF0Y2gocmVhZCwgY29yZXNbaV0sIGRpc2NvdmVyeUtleXNbaV0sIGF1dGgsIGhlYWQsIGhpbnRzKQogICAgICAgIDogbnVsbAogICAgfQoKICAgIHJlYWQudHJ5Rmx1c2goKQoKICAgIHJldHVybiBQcm9taXNlLmFsbChyZXN1bHRQcm9taXNlcykKICB9CgogIGFzeW5jIHN1c3BlbmQoKSB7CiAgICBhd2FpdCB0aGlzLmRiLnN1c3BlbmQoKQogICAgaWYgKHRoaXMuZGV2aWNlRmlsZSkgYXdhaXQgdGhpcy5kZXZpY2VGaWxlLnN1c3BlbmQoKQogIH0KCiAgYXN5bmMgcmVzdW1lKCkgewogICAgaWYgKHRoaXMuZGV2aWNlRmlsZSkgYXdhaXQgdGhpcy5kZXZpY2VGaWxlLnJlc3VtZSgpCiAgICBhd2FpdCB0aGlzLmRiLnJlc3VtZSgpCiAgfQoKICBhc3luYyByZXN1bWVDb3JlKGRpc2NvdmVyeUtleSkgewogICAgaWYgKHRoaXMudmVyc2lvbiA9PT0gMCkgYXdhaXQgdGhpcy5fbWlncmF0ZVN0b3JlKCkKCiAgICBpZiAoIWRpc2NvdmVyeUtleSkgewogICAgICBkaXNjb3ZlcnlLZXkgPSBhd2FpdCB0aGlzLmdldERlZmF1bHREaXNjb3ZlcnlLZXkoKQogICAgICBpZiAoIWRpc2NvdmVyeUtleSkgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWCh0aGlzLmRiLCBFTVBUWSkKICAgIGNvbnN0IGNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShkaXNjb3ZlcnlLZXkpCgogICAgcngudHJ5Rmx1c2goKQogICAgY29uc3QgY29yZSA9IGF3YWl0IGNvcmVQcm9taXNlCgogICAgaWYgKGNvcmUgPT09IG51bGwpIHJldHVybiBudWxsCiAgICByZXR1cm4gdGhpcy5fcmVzdW1lRnJvbVBvaW50ZXJzKEVNUFRZLCBkaXNjb3ZlcnlLZXksIGZhbHNlLCBjb3JlKQogIH0KCiAgYXN5bmMgZXhwb3J0KGRpc2NvdmVyeUtleSwgb3B0cykgewogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgRU1QVFkpCiAgICBjb25zdCBjb3JlUHJvbWlzZSA9IHJ4LmdldENvcmUoZGlzY292ZXJ5S2V5KQoKICAgIHJ4LnRyeUZsdXNoKCkKICAgIGNvbnN0IGNvcmUgPSBhd2FpdCBjb3JlUHJvbWlzZQogICAgaWYgKGNvcmUgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgbGV0IHsgZGF0YVBvaW50ZXIsIGNvcmVQb2ludGVyIH0gPSBjb3JlCgogICAgY29uc3QgcHRyID0geyBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVSWCh7IGRhdGFQb2ludGVyLCBjb3JlUG9pbnRlcjogMCwgZGVwZW5kZW5jaWVzOiBbXSB9LCB0aGlzLmRiLCBFTVBUWSkKICAgICAgY29uc3QgZGVwZW5kZW5jeVByb21pc2UgPSByeC5nZXREZXBlbmRlbmN5KCkKICAgICAgcngudHJ5Rmx1c2goKQogICAgICBjb25zdCBkZXBlbmRlbmN5ID0gYXdhaXQgZGVwZW5kZW5jeVByb21pc2UKICAgICAgaWYgKCFkZXBlbmRlbmN5KSBicmVhawogICAgICBwdHIuZGVwZW5kZW5jaWVzLnB1c2goZGVwZW5kZW5jeSkKICAgICAgZGF0YVBvaW50ZXIgPSBkZXBlbmRlbmN5LmRhdGFQb2ludGVyCiAgICB9CgogICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuZGIuc2Vzc2lvbigpCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgSHlwZXJjb3JlU3RvcmFnZS5leHBvcnQocHRyLCBzZXNzaW9uLCBvcHRzKQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgc2Vzc2lvbi5jbG9zZSgpCiAgICB9CiAgfQoKICBhc3luYyBfcmVzdW1lRnJvbVBvaW50ZXJzKHZpZXcsIGRpc2NvdmVyeUtleSwgY3JlYXRlLCB7IHZlcnNpb24sIGNvcmVQb2ludGVyLCBkYXRhUG9pbnRlciB9KSB7CiAgICBjb25zdCBjb3JlID0geyBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfQoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IHJ4ID0gbmV3IENvcmVSWCh7IGRhdGFQb2ludGVyLCBjb3JlUG9pbnRlcjogMCwgZGVwZW5kZW5jaWVzOiBbXSB9LCB0aGlzLmRiLCB2aWV3KQogICAgICBjb25zdCBkZXBlbmRlbmN5UHJvbWlzZSA9IHJ4LmdldERlcGVuZGVuY3koKQogICAgICByeC50cnlGbHVzaCgpCiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBhd2FpdCBkZXBlbmRlbmN5UHJvbWlzZQogICAgICBpZiAoIWRlcGVuZGVuY3kpIGJyZWFrCiAgICAgIGNvcmUuZGVwZW5kZW5jaWVzLnB1c2goZGVwZW5kZW5jeSkKICAgICAgZGF0YVBvaW50ZXIgPSBkZXBlbmRlbmN5LmRhdGFQb2ludGVyCiAgICB9CgogICAgY29uc3QgcmVzdWx0ID0gbmV3IEh5cGVyY29yZVN0b3JhZ2UodGhpcywgdGhpcy5kYi5zZXNzaW9uKCksIGNvcmUsIEVNUFRZLCBudWxsKQoKICAgIGlmICh2ZXJzaW9uIDwgVkVSU0lPTikgYXdhaXQgdGhpcy5fbWlncmF0ZUNvcmUocmVzdWx0LCBkaXNjb3ZlcnlLZXksIHZlcnNpb24sIGNyZWF0ZSkKICAgIHJldHVybiByZXN1bHQKICB9CgogIC8vIG5vdCBhbGxvd2VkIHRvIHRocm93IHZhbGlkYXRpb24gZXJyb3JzIGFzIGl0cyBhIHNoYXJlZCB0eCEKICBhc3luYyBfY3JlYXRlKAogICAgdmlldywKICAgIHsga2V5LCBtYW5pZmVzdCwga2V5UGFpciwgZW5jcnlwdGlvbktleSwgZGlzY292ZXJ5S2V5LCBhbGlhcywgdXNlckRhdGEsIGNvcmU6IHB0cnMgfQogICkgewogICAgY29uc3QgcnggPSBuZXcgQ29yZXN0b3JlUlgodGhpcy5kYiwgdmlldykKICAgIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogICAgY29uc3QgY29yZVByb21pc2UgPSByeC5nZXRDb3JlKGRpc2NvdmVyeUtleSkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCgogICAgcngudHJ5Rmx1c2goKQoKICAgIGxldCBbY29yZSwgaGVhZF0gPSBhd2FpdCBQcm9taXNlLmFsbChbY29yZVByb21pc2UsIGhlYWRQcm9taXNlXSkKICAgIGlmIChjb3JlKSByZXR1cm4gdGhpcy5fcmVzdW1lRnJvbVBvaW50ZXJzKHZpZXcsIGRpc2NvdmVyeUtleSwgdHJ1ZSwgY29yZSkKCiAgICBpZiAoaGVhZCA9PT0gbnVsbCkgaGVhZCA9IGluaXRTdG9yZUhlYWQoKQogICAgaWYgKGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9PT0gbnVsbCkgaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CgogICAgY29uc3QgY29yZVBvaW50ZXIgPSBwdHJzID8gcHRycy5jb3JlUG9pbnRlciA6IGhlYWQuYWxsb2NhdGVkLmNvcmVzKysKICAgIGNvbnN0IGRhdGFQb2ludGVyID0gcHRycyA/IHB0cnMuZGF0YVBvaW50ZXIgOiBoZWFkLmFsbG9jYXRlZC5kYXRhcysrCgogICAgY29yZSA9IHsgdmVyc2lvbjogVkVSU0lPTiwgY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyLCBhbGlhcyB9CgogICAgdHguc2V0SGVhZChoZWFkKQogICAgdHgucHV0Q29yZShkaXNjb3ZlcnlLZXksIGNvcmUpCiAgICBpZiAoYWxpYXMpIHR4LnB1dENvcmVCeUFsaWFzKGFsaWFzLCBkaXNjb3ZlcnlLZXkpCgogICAgY29uc3QgcHRyID0geyBjb3JlUG9pbnRlciwgZGF0YVBvaW50ZXIsIGRlcGVuZGVuY2llczogW10gfQogICAgY29uc3QgY3R4ID0gbmV3IENvcmVUWChwdHIsIHRoaXMuZGIsIHZpZXcsIHR4LmNoYW5nZXMpCgogICAgY3R4LnNldEF1dGgoewogICAgICBrZXksCiAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgbWFuaWZlc3QsCiAgICAgIGtleVBhaXIsCiAgICAgIGVuY3J5cHRpb25LZXkKICAgIH0pCgogICAgaWYgKHVzZXJEYXRhKSB7CiAgICAgIGZvciAoY29uc3QgeyBrZXksIHZhbHVlIH0gb2YgdXNlckRhdGEpIHsKICAgICAgICBjdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICAgICAgfQogICAgfQoKICAgIHR4LmFwcGx5KCkKCiAgICByZXR1cm4gbmV3IEh5cGVyY29yZVN0b3JhZ2UodGhpcywgdGhpcy5kYi5zZXNzaW9uKCksIHB0ciwgRU1QVFksIG51bGwpCiAgfQoKICBhc3luYyBjcmVhdGVDb3JlKGRhdGEpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIGF3YWl0IHRoaXMuX21pZ3JhdGVTdG9yZSgpCgogICAgY29uc3QgdmlldyA9IGF3YWl0IHRoaXMuX2VudGVyKCkKCiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY3JlYXRlKHZpZXcsIGRhdGEpCiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9leGl0KCkKICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gQ29yZXN0b3JlU3RvcmFnZQoKZnVuY3Rpb24gaW5pdFN0b3JlSGVhZCgpIHsKICByZXR1cm4gewogICAgdmVyc2lvbjogMCwgLy8gY2F1c2Ugd2Ugd2FubmEgcnVuIHRoZSBtaWdyYXRpb24KICAgIGFsbG9jYXRlZDogewogICAgICBkYXRhczogMCwKICAgICAgY29yZXM6IDAKICAgIH0sCiAgICBzZWVkOiBudWxsLAogICAgZGVmYXVsdERpc2NvdmVyeUtleTogbnVsbAogIH0KfQoKZnVuY3Rpb24gZ2V0QmF0Y2goc2Vzc2lvbnMsIG5hbWUsIGFsbG9jKSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZXNzaW9ucy5sZW5ndGg7IGkrKykgewogICAgaWYgKHNlc3Npb25zW2ldLm5hbWUgPT09IG5hbWUpIHJldHVybiBzZXNzaW9uc1tpXQogIH0KCiAgaWYgKCFhbGxvYykgcmV0dXJuIG51bGwKCiAgY29uc3QgcmVzdWx0ID0geyBuYW1lLCBkYXRhUG9pbnRlcjogLTEgfQogIHNlc3Npb25zLnB1c2gocmVzdWx0KQogIHJldHVybiByZXN1bHQKfQoKZnVuY3Rpb24gaXNDb3Jlc3RvcmVTdG9yYWdlKHMpIHsKICByZXR1cm4gdHlwZW9mIHMgPT09ICdvYmplY3QnICYmICEhcyAmJiB0eXBlb2Ygcy5zZXREZWZhdWx0RGlzY292ZXJ5S2V5ID09PSAnZnVuY3Rpb24nCn0KCmZ1bmN0aW9uIGNyZWF0ZUNvbHVtbkZhbWlseShkYiwgb3B0cyA9IHt9KSB7CiAgY29uc3QgewogICAgdGFibGVDYWNoZUluZGV4QW5kRmlsdGVyQmxvY2tzID0gdHJ1ZSwKICAgIGJsb2NrQ2FjaGUgPSB0cnVlLAogICAgb3B0aW1pemVGaWx0ZXJzRm9yTWVtb3J5ID0gZmFsc2UKICB9ID0gb3B0cwoKICBjb25zdCBjb2wgPSBuZXcgUm9ja3NEQi5Db2x1bW5GYW1pbHkoQ09MVU1OX0ZBTUlMWSwgewogICAgZW5hYmxlQmxvYkZpbGVzOiB0cnVlLAogICAgbWluQmxvYlNpemU6IDQwOTYsCiAgICBibG9iRmlsZVNpemU6IDI1NiAqIDEwMjQgKiAxMDI0LAogICAgZW5hYmxlQmxvYkdhcmJhZ2VDb2xsZWN0aW9uOiB0cnVlLAogICAgdGFibGVCbG9ja1NpemU6IDgxOTIsCiAgICB0YWJsZUNhY2hlSW5kZXhBbmRGaWx0ZXJCbG9ja3MsCiAgICB0YWJsZUZvcm1hdFZlcnNpb246IDYsCiAgICBvcHRpbWl6ZUZpbHRlcnNGb3JNZW1vcnksCiAgICBibG9ja0NhY2hlCiAgfSkKCiAgcmV0dXJuIGRiLmNvbHVtbkZhbWlseShjb2wpCn0KCi8vIFRPRE86IHJlbW92ZSBpbiBsaWtlIDMtNiBtbwpmdW5jdGlvbiB0bXBGaXhTdG9yYWdlKHApIHsKICAvLyBpZiBDT1JFU1RPUkUgZmlsZSBpcyB3cml0dGVuLCBuZXcgZm9ybWF0CiAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKHAsICdDT1JFU1RPUkUnKSkpIHJldHVybgoKICBsZXQgZmlsZXMgPSBbXQoKICB0cnkgewogICAgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhwKQogIH0gY2F0Y2gge30KCiAgY29uc3Qgbm90Um9ja3MgPSBuZXcgU2V0KFsKICAgICdDT1JFU1RPUkUnLAogICAgJ3ByaW1hcnkta2V5JywKICAgICdjb3JlcycsCiAgICAnYXBwLXByZWZlcmVuY2VzJywKICAgICdjYWNoZScsCiAgICAncHJlZmVyZW5jZXMuanNvbicsCiAgICAnZGInLAogICAgJ2Nsb25lJywKICAgICdjb3JlJywKICAgICdub3RpZmljYXRpb25zJwogIF0pCgogIGZvciAoY29uc3QgZiBvZiBmaWxlcykgewogICAgaWYgKG5vdFJvY2tzLmhhcyhmKSkgY29udGludWUKCiAgICB0cnkgewogICAgICBmcy5ta2RpclN5bmMocGF0aC5qb2luKHAsICdkYicpKQogICAgfSBjYXRjaCB7fQoKICAgIGZzLnJlbmFtZVN5bmMocGF0aC5qb2luKHAsIGYpLCBwYXRoLmpvaW4ocCwgJ2RiJywgZikpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBleHBvcnREYXRhKHB0ciwgZGIsIG9wdHMpIHsKICAvLyBqdXN0IG5lZWQgZGF0YVBvaW50ZXIKICBjb25zdCByZWFkcyA9IFsKICAgIHRvQXJyYXkoY3JlYXRlQmxvY2tTdHJlYW0ocHRyLCBkYiwgRU1QVFksIG9wdHMpKSwKICAgIHRvQXJyYXkoY3JlYXRlVHJlZU5vZGVTdHJlYW0ocHRyLCBkYiwgRU1QVFksIG9wdHMpKSwKICAgIHRvQXJyYXkoY3JlYXRlQml0ZmllbGRTdHJlYW0ocHRyLCBkYiwgRU1QVFksIG9wdHMpKQogIF0KCiAgY29uc3QgW2Jsb2NrcywgdHJlZSwgYml0ZmllbGRdID0gYXdhaXQgUHJvbWlzZS5hbGwocmVhZHMpCgogIHJldHVybiB7CiAgICBibG9ja3MsCiAgICB0cmVlLAogICAgYml0ZmllbGQKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHRvQXJyYXkoc3RyZWFtKSB7CiAgY29uc3QgYWxsID0gW10KICBmb3IgYXdhaXQgKGNvbnN0IGUgb2Ygc3RyZWFtKSBhbGwucHVzaChlKQogIHJldHVybiBhbGwKfQoKZnVuY3Rpb24gbm9vcCgpIHt9Cgphc3luYyBmdW5jdGlvbiBnZXRJbmZvRnJvbUJhdGNoKGRiLCBjLCBkaXNjb3ZlcnlLZXksIGdldEF1dGgsIGdldEhlYWQsIGdldEhpbnRzKSB7CiAgY29uc3QgYXV0aFByb21pc2UgPSBnZXRBdXRoID8gQ29yZVJYLmdldEF1dGgoZGIsIGMpIDogbnVsbAogIGNvbnN0IGhlYWRQcm9taXNlID0gZ2V0SGVhZCA/IENvcmVSWC5nZXRIZWFkKGRiLCBjKSA6IG51bGwKICBjb25zdCBoaW50c1Byb21pc2UgPSBnZXRIaW50cyA/IENvcmVSWC5nZXRIaW50cyhkYiwgYykgOiBudWxsCgogIC8vIGVuc3VyZSBubyB1bmNhdWdodHMKICBpZiAoYXV0aFByb21pc2UpIGF1dGhQcm9taXNlLmNhdGNoKG5vb3ApCiAgaWYgKGhlYWRQcm9taXNlKSBoZWFkUHJvbWlzZS5jYXRjaChub29wKQogIGlmIChoaW50c1Byb21pc2UpIGhpbnRzUHJvbWlzZS5jYXRjaChub29wKQoKICByZXR1cm4gewogICAgZGlzY292ZXJ5S2V5LAogICAgY29yZTogYywKICAgIGF1dGg6IGF3YWl0IGF1dGhQcm9taXNlLAogICAgaGVhZDogYXdhaXQgaGVhZFByb21pc2UsCiAgICBoaW50czogYXdhaXQgaGludHNQcm9taXNlCiAgfQp9CmNvbnN0IHsgUmVhZGFibGUsIGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgeyBjb3JlIH0gPSByZXF1aXJlKCcuL2tleXMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCbG9ja1N0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBkYiwgdXBkYXRlcywgc3RhcnQsIGVuZCwgcmV2ZXJzZSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy51cGRhdGVzID0gdXBkYXRlcwogICAgdGhpcy5zdGFydCA9IHN0YXJ0CiAgICB0aGlzLmVuZCA9IGVuZAogICAgdGhpcy5yZXZlcnNlID0gcmV2ZXJzZSA9PT0gdHJ1ZQoKICAgIHRoaXMuX2RyYWluZWQgPSB0cnVlCiAgICB0aGlzLl9jb25zdW1lZCA9IDAKICAgIHRoaXMuX3N0cmVhbSA9IG51bGwKICAgIHRoaXMuX29uY2xvc2VCb3VuZCA9IHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKQogICAgdGhpcy5fbWF5YmVEcmFpbkJvdW5kID0gdGhpcy5fbWF5YmVEcmFpbi5iaW5kKHRoaXMpCgogICAgdGhpcy5fdXBkYXRlKCkKICB9CgogIF91cGRhdGUoKSB7CiAgICBpZiAodGhpcy5fY29uc3VtZWQgPiB0aGlzLmNvcmUuZGVwZW5kZW5jaWVzLmxlbmd0aCkgcmV0dXJuCgogICAgY29uc3QgZGVwcyA9IHRoaXMuY29yZS5kZXBlbmRlbmNpZXMKICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fZmluZERlcGVuZGVuY3lJbmRleChkZXBzKQoKICAgIGNvbnN0IGN1cnIgPSBpbmRleCA8IGRlcHMubGVuZ3RoID8gZGVwc1tpbmRleF0gOiBudWxsCiAgICBjb25zdCBwcmV2ID0gaW5kZXggPiAwICYmIGluZGV4IC0gMSA8IGRlcHMubGVuZ3RoID8gZGVwc1tpbmRleCAtIDFdIDogbnVsbAoKICAgIGNvbnN0IHN0YXJ0ID0gcHJldiAmJiBwcmV2Lmxlbmd0aCA+IHRoaXMuc3RhcnQgPyBwcmV2Lmxlbmd0aCA6IHRoaXMuc3RhcnQKICAgIGNvbnN0IGVuZCA9IGN1cnIgJiYgKHRoaXMuZW5kID09PSAtMSB8fCBjdXJyLmxlbmd0aCA8IHRoaXMuZW5kKSA/IGN1cnIubGVuZ3RoIDogdGhpcy5lbmQKCiAgICBjb25zdCBwdHIgPSBjdXJyID8gY3Vyci5kYXRhUG9pbnRlciA6IHRoaXMuY29yZS5kYXRhUG9pbnRlcgoKICAgIHRoaXMuX21ha2VTdHJlYW0oY29yZS5ibG9jayhwdHIsIHN0YXJ0KSwgY29yZS5ibG9jayhwdHIsIGVuZCkpCiAgfQoKICBfZmluZERlcGVuZGVuY3lJbmRleChkZXBzKSB7CiAgICBpZiAoIXRoaXMucmV2ZXJzZSkgcmV0dXJuIHRoaXMuX2NvbnN1bWVkKysKCiAgICBsZXQgaSA9IGRlcHMubGVuZ3RoIC0gdGhpcy5fY29uc3VtZWQrKwogICAgd2hpbGUgKGkgPiAwKSB7CiAgICAgIGlmIChkZXBzW2kgLSAxXS5sZW5ndGggPD0gdGhpcy5lbmQpIHJldHVybiBpCiAgICAgIGktLQogICAgICB0aGlzLl9jb25zdW1lZCsrCiAgICB9CgogICAgcmV0dXJuIDAKICB9CgogIF9wcmVkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX3N0cmVhbSAhPT0gbnVsbCkgdGhpcy5fc3RyZWFtLmRlc3Ryb3koKQogIH0KCiAgX3JlYWQoY2IpIHsKICAgIHRoaXMuX2RyYWluZWQgPSB0aGlzLl9vbnJlYWRhYmxlKCkKICAgIGNiKG51bGwpCiAgfQoKICBfbWF5YmVEcmFpbigpIHsKICAgIGlmICh0aGlzLl9kcmFpbmVkID09PSB0cnVlKSByZXR1cm4KICAgIHRoaXMuX2RyYWluZWQgPSB0aGlzLl9vbnJlYWRhYmxlKCkKICB9CgogIF9vbnJlYWRhYmxlKCkgewogICAgaWYgKHRoaXMuX3N0cmVhbSA9PT0gbnVsbCkgewogICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBsZXQgZGF0YSA9IHRoaXMuX3N0cmVhbS5yZWFkKCkKCiAgICBpZiAoZGF0YSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgZG8gewogICAgICB0aGlzLnB1c2goZGF0YSkKICAgICAgZGF0YSA9IHRoaXMuX3N0cmVhbS5yZWFkKCkKICAgIH0gd2hpbGUgKGRhdGEgIT09IG51bGwpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9vbmNsb3NlKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuCgogICAgY29uc3QgZXJyID0gZ2V0U3RyZWFtRXJyb3IodGhpcy5fc3RyZWFtKQoKICAgIGlmIChlcnIgIT09IG51bGwpIHsKICAgICAgdGhpcy5kZXN0cm95KGVycikKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gZW1wdHkgdGhlIGN1cnJlbnQgc3RyZWFtCiAgICBpZiAodGhpcy5fb25yZWFkYWJsZSgpID09PSB0cnVlKSB0aGlzLl9kcmFpbmVkID0gdHJ1ZQoKICAgIHRoaXMuX3N0cmVhbSA9IG51bGwKCiAgICB0aGlzLl91cGRhdGUoKQogICAgdGhpcy5fbWF5YmVEcmFpbigpCiAgfQoKICBfbWFrZVN0cmVhbShzdGFydCwgZW5kKSB7CiAgICB0aGlzLl9zdHJlYW0gPSB0aGlzLnVwZGF0ZXMuaXRlcmF0b3IodGhpcy5kYiwgc3RhcnQsIGVuZCwgdGhpcy5yZXZlcnNlKQogICAgdGhpcy5fc3RyZWFtLm9uKCdyZWFkYWJsZScsIHRoaXMuX21heWJlRHJhaW5Cb3VuZCkKICAgIHRoaXMuX3N0cmVhbS5vbignZXJyb3InLCBub29wKQogICAgdGhpcy5fc3RyZWFtLm9uKCdjbG9zZScsIHRoaXMuX29uY2xvc2VCb3VuZCkKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCB7IFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKCi8vIHVzZWQgZm9yIHJldHVybmVkIGEgc3RyZWFtIHRoYXQganVzdCBlcnJvcnMgKGR1cmluZyByZWFkIGR1cmluZyB0ZWFyZG93bikKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ2xvc2VFcnJvclN0cmVhbSBleHRlbmRzIFJlYWRhYmxlIHsKICBjb25zdHJ1Y3RvcihlcnIpIHsKICAgIHN1cGVyKCkKICAgIHRoaXMuZXJyb3IgPSBlcnIKICB9CgogIF9vcGVuKGNiKSB7CiAgICBjYih0aGlzLmVycm9yKQogIH0KfQpjb25zdCB7IFVJTlQsIFNUUklORyB9ID0gcmVxdWlyZSgnaW5kZXgtZW5jb2RlcicpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IFRMX0hFQUQgPSAwCmNvbnN0IFRMX0NPUkVfQllfREtFWSA9IDEKY29uc3QgVExfQ09SRV9CWV9BTElBUyA9IDIKY29uc3QgVExfQ09SRSA9IDMKY29uc3QgVExfREFUQSA9IDQKCmNvbnN0IFRMX0VORCA9IFRMX0RBVEEgKyAxCgpjb25zdCBDT1JFX0FVVEggPSAwCmNvbnN0IENPUkVfU0VTU0lPTlMgPSAxCgpjb25zdCBEQVRBX0hFQUQgPSAwCmNvbnN0IERBVEFfREVQRU5ERU5DWSA9IDEKY29uc3QgREFUQV9ISU5UUyA9IDIKY29uc3QgREFUQV9CTE9DSyA9IDMKY29uc3QgREFUQV9UUkVFID0gNApjb25zdCBEQVRBX0JJVEZJRUxEID0gNQpjb25zdCBEQVRBX1VTRVJfREFUQSA9IDYKY29uc3QgREFUQV9MT0NBTCA9IDcKCmNvbnN0IHNsYWIgPSB7IGJ1ZmZlcjogYjRhLmFsbG9jVW5zYWZlKDY1NTM2KSwgc3RhcnQ6IDAsIGVuZDogMCB9Cgpjb25zdCBzdG9yZSA9IHt9CmNvbnN0IGNvcmUgPSB7fQoKc3RvcmUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgbGV0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgMCkKICBjb25zdCBhID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKICBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0VORCkKICBjb25zdCBiID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKICByZXR1cm4gW2EsIGJdCn0KCnN0b3JlLmhlYWQgPSBmdW5jdGlvbiAoKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9IRUFEKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlID0gZnVuY3Rpb24gKGRpc2NvdmVyeUtleSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9ES0VZKQogIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIGRpc2NvdmVyeUtleSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZVN0YXJ0ID0gZnVuY3Rpb24gKCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9ES0VZKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlRW5kID0gZnVuY3Rpb24gKCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9ES0VZICsgMSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZUJ5QWxpYXMgPSBmdW5jdGlvbiAoeyBuYW1lc3BhY2UsIG5hbWUgfSkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9BTElBUykKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuYW1lc3BhY2UpCiAgU1RSSU5HLmVuY29kZShzdGF0ZSwgbmFtZSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuY29yZUJ5QWxpYXNTdGFydCA9IGZ1bmN0aW9uIChuYW1lc3BhY2UpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkVfQllfQUxJQVMpCiAgaWYgKG5hbWVzcGFjZSkgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbmFtZXNwYWNlKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9CgpzdG9yZS5jb3JlQnlBbGlhc0VuZCA9IGZ1bmN0aW9uIChuYW1lc3BhY2UpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CgogIGlmIChuYW1lc3BhY2UpIHsKICAgIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9DT1JFX0JZX0FMSUFTKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbmFtZXNwYWNlKQogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZgogIH0gZWxzZSB7CiAgICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRV9CWV9BTElBUyArIDEpCiAgfQoKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKc3RvcmUuYWxpYXMgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIGNvbnN0IG5hbWVzcGFjZSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgY29uc3QgbmFtZSA9IFNUUklORy5kZWNvZGUoc3RhdGUpCiAgcmV0dXJuIHsgbmFtZXNwYWNlLCBuYW1lIH0KfQoKc3RvcmUuZGlzY292ZXJ5S2V5ID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGNvbnN0IHN0YXRlID0geyBidWZmZXIsIHN0YXJ0OiAwLCBlbmQ6IGJ1ZmZlci5ieXRlTGVuZ3RoIH0KICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gbnMKICByZXR1cm4gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKfQoKY29yZS5jb3JlID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmRhdGEgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuYXV0aCA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0NPUkUpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgQ09SRV9BVVRIKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLnNlc3Npb25zID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfQ09SRSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBDT1JFX1NFU1NJT05TKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmhlYWQgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfSEVBRCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5kZXBlbmRlbmN5ID0gZnVuY3Rpb24gKHB0cikgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0RFUEVOREVOQ1kpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuaGludHMgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfSElOVFMpCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUuYmxvY2sgPSBmdW5jdGlvbiAocHRyLCBpbmRleCkgewogIGNvbnN0IHN0YXRlID0gYWxsb2MoKQogIGNvbnN0IHN0YXJ0ID0gc3RhdGUuc3RhcnQKICBVSU5ULmVuY29kZShzdGF0ZSwgVExfREFUQSkKICBVSU5ULmVuY29kZShzdGF0ZSwgcHRyKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBEQVRBX0JMT0NLKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBpbmRleCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS50cmVlID0gZnVuY3Rpb24gKHB0ciwgaW5kZXgpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9UUkVFKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBpbmRleCkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS5iaXRmaWVsZCA9IGZ1bmN0aW9uIChwdHIsIGluZGV4LCB0eXBlKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfQklURklFTEQpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIGluZGV4KQogIFVJTlQuZW5jb2RlKHN0YXRlLCB0eXBlKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLnVzZXJEYXRhID0gZnVuY3Rpb24gKHB0ciwga2V5KSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfVVNFUl9EQVRBKQogIFNUUklORy5lbmNvZGUoc3RhdGUsIGtleSkKICByZXR1cm4gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXJ0LCBzdGF0ZS5zdGFydCkKfQoKY29yZS51c2VyRGF0YUVuZCA9IGZ1bmN0aW9uIChwdHIpIHsKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9VU0VSX0RBVEEgKyAxKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmxvY2FsID0gZnVuY3Rpb24gKHB0ciwga2V5KSB7CiAgaWYgKGtleS5ieXRlTGVuZ3RoID4gMjA0OCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdsb2NhbCBrZXlzIGhhcyBhbiB1cHBlciBsaW1pdCBvZiAyMDQ4IGJ5dGVzIGF0bScpCiAgfQoKICBjb25zdCBzdGF0ZSA9IGFsbG9jKCkKICBjb25zdCBzdGFydCA9IHN0YXRlLnN0YXJ0CiAgVUlOVC5lbmNvZGUoc3RhdGUsIFRMX0RBVEEpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIHB0cikKICBVSU5ULmVuY29kZShzdGF0ZSwgREFUQV9MT0NBTCkKCiAgc3RhdGUuYnVmZmVyLnNldChrZXksIHN0YXRlLnN0YXJ0KQogIHN0YXRlLnN0YXJ0ICs9IGtleS5ieXRlTGVuZ3RoCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGFydCwgc3RhdGUuc3RhcnQpCn0KCmNvcmUubG9jYWxFbmQgPSBmdW5jdGlvbiAocHRyKSB7CiAgY29uc3Qgc3RhdGUgPSBhbGxvYygpCiAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5zdGFydAogIFVJTlQuZW5jb2RlKHN0YXRlLCBUTF9EQVRBKQogIFVJTlQuZW5jb2RlKHN0YXRlLCBwdHIpCiAgVUlOVC5lbmNvZGUoc3RhdGUsIERBVEFfTE9DQUwgKyAxKQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIHN0YXRlLnN0YXJ0KQp9Cgpjb3JlLmJsb2NrSW5kZXggPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBwdHIKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gdHlwZQogIHJldHVybiBVSU5ULmRlY29kZShzdGF0ZSkKfQoKY29yZS5iaXRmaWVsZEluZGV4QW5kVHlwZSA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHB0cgogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyB0eXBlCiAgcmV0dXJuIFtVSU5ULmRlY29kZShzdGF0ZSksIFVJTlQuZGVjb2RlKHN0YXRlKV0KfQoKY29yZS51c2VyRGF0YUtleSA9IGZ1bmN0aW9uIChidWZmZXIpIHsKICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyLCBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCB9CiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIG5zCiAgVUlOVC5kZWNvZGUoc3RhdGUpIC8vIHB0cgogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyB0eXBlCiAgcmV0dXJuIFNUUklORy5kZWNvZGUoc3RhdGUpCn0KCmNvcmUubG9jYWxLZXkgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBucwogIFVJTlQuZGVjb2RlKHN0YXRlKSAvLyBwdHIKICBVSU5ULmRlY29kZShzdGF0ZSkgLy8gdHlwZQogIHJldHVybiBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKfQoKbW9kdWxlLmV4cG9ydHMgPSB7IHN0b3JlLCBjb3JlIH0KCmZ1bmN0aW9uIGFsbG9jKCkgewogIGlmIChzbGFiLmJ1ZmZlci5ieXRlTGVuZ3RoIC0gc2xhYi5zdGFydCA8IDQwOTYpIHsKICAgIHNsYWIuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHNsYWIuYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICBzbGFiLnN0YXJ0ID0gMAogIH0KICByZXR1cm4gc2xhYgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IEJsb2NrRGVwZW5kZW5jeVN0cmVhbSA9IHJlcXVpcmUoJy4vYmxvY2stZGVwZW5kZW5jeS1zdHJlYW0uanMnKQpjb25zdCB7IGNvcmUsIHN0b3JlIH0gPSByZXF1aXJlKCcuL2tleXMuanMnKQpjb25zdCBzY2hlbWEgPSByZXF1aXJlKCcuLi9zcGVjL2h5cGVyc2NoZW1hJykKCmNvbnN0IENPUkVTVE9SRV9DT1JFID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZXN0b3JlL2NvcmUnKQpjb25zdCBDT1JFX1RSRUVfTk9ERSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvdHJlZS1ub2RlJykKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gewogIGNyZWF0ZUJsb2NrU3RyZWFtLAogIGNyZWF0ZUJpdGZpZWxkU3RyZWFtLAogIGNyZWF0ZVVzZXJEYXRhU3RyZWFtLAogIGNyZWF0ZUNvcmVTdHJlYW0sCiAgY3JlYXRlQWxpYXNTdHJlYW0sCiAgY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtLAogIGNyZWF0ZVRyZWVOb2RlU3RyZWFtLAogIGNyZWF0ZUxvY2FsU3RyZWFtCn0KCmZ1bmN0aW9uIGNyZWF0ZUNvcmVTdHJlYW0oZGIsIHZpZXcpIHsKICBjb25zdCBzdGFydCA9IHN0b3JlLmNvcmVTdGFydCgpCiAgY29uc3QgZW5kID0gc3RvcmUuY29yZUVuZCgpCgogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHN0YXJ0LCBlbmQsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwQ29yZQogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlRGlzY292ZXJ5S2V5U3RyZWFtKGRiLCB2aWV3LCBuYW1lc3BhY2UpIHsKICBjb25zdCBzdGFydCA9IG5hbWVzcGFjZSA/IHN0b3JlLmNvcmVCeUFsaWFzU3RhcnQobmFtZXNwYWNlKSA6IHN0b3JlLmNvcmVTdGFydCgpCiAgY29uc3QgZW5kID0gbmFtZXNwYWNlID8gc3RvcmUuY29yZUJ5QWxpYXNFbmQobmFtZXNwYWNlKSA6IHN0b3JlLmNvcmVFbmQoKQoKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzdGFydCwgZW5kLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG5hbWVzcGFjZSA/IG1hcE5hbWVzcGFjZURpc2NvdmVyeUtleXMgOiBtYXBBbGxEaXNjb3ZlcnlLZXlzCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBjcmVhdGVBbGlhc1N0cmVhbShkYiwgdmlldywgbmFtZXNwYWNlKSB7CiAgY29uc3Qgc3RhcnQgPSBzdG9yZS5jb3JlQnlBbGlhc1N0YXJ0KG5hbWVzcGFjZSkKICBjb25zdCBlbmQgPSBzdG9yZS5jb3JlQnlBbGlhc0VuZChuYW1lc3BhY2UpCgogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHN0YXJ0LCBlbmQsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwQWxpYXMKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZUJsb2NrSXRlcmF0b3IocHRyLCBkYiwgdmlldywgc3RhcnQsIGVuZCwgcmV2ZXJzZSkgewogIGlmIChwdHIuZGVwZW5kZW5jaWVzLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBuZXcgQmxvY2tEZXBlbmRlbmN5U3RyZWFtKHB0ciwgZGIsIHZpZXcsIHN0YXJ0LCBlbmQsIHJldmVyc2UpCiAgfQoKICBjb25zdCBzID0gY29yZS5ibG9jayhwdHIuZGF0YVBvaW50ZXIsIHN0YXJ0KQogIGNvbnN0IGUgPSBjb3JlLmJsb2NrKHB0ci5kYXRhUG9pbnRlciwgZW5kID09PSAtMSA/IEluZmluaXR5IDogZW5kKQogIHJldHVybiB2aWV3Lml0ZXJhdG9yKGRiLCBzLCBlLCByZXZlcnNlKQp9CgpmdW5jdGlvbiBjcmVhdGVCbG9ja1N0cmVhbSgKICBwdHIsCiAgZGIsCiAgdmlldywKICB7IGd0ID0gLTEsIGd0ZSA9IGd0ICsgMSwgbHRlID0gLTEsIGx0ID0gbHRlID09PSAtMSA/IC0xIDogbHRlICsgMSwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fQopIHsKICBjb25zdCBpdGUgPSBjcmVhdGVCbG9ja0l0ZXJhdG9yKHB0ciwgZGIsIHZpZXcsIGd0ZSwgbHQsIHJldmVyc2UpCgogIGl0ZS5fcmVhZGFibGVTdGF0ZS5tYXAgPSBtYXBCbG9jawogIHJldHVybiBpdGUKfQoKZnVuY3Rpb24gY3JlYXRlQml0ZmllbGRTdHJlYW0oCiAgcHRyLAogIGRiLAogIHZpZXcsCiAgeyBndCA9IC0xLCBndGUgPSBndCArIDEsIGx0ZSA9IC0xLCBsdCA9IGx0ZSA9PT0gLTEgPyAtMSA6IGx0ZSArIDEsIHJldmVyc2UgPSBmYWxzZSB9ID0ge30KKSB7CiAgY29uc3QgcyA9IGNvcmUuYml0ZmllbGQocHRyLmRhdGFQb2ludGVyLCBndGUsIDApCiAgY29uc3QgZSA9IGNvcmUuYml0ZmllbGQocHRyLmRhdGFQb2ludGVyLCBsdCA9PT0gLTEgPyBJbmZpbml0eSA6IGx0LCAwKQogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwQml0ZmllbGQKICByZXR1cm4gaXRlCn0KCi8vIE5PVEU6IHRoaXMgZG9lcyBub3QgZG8gZGVwZW5kZW5jeSBsb29rdXBzIGF0bQpmdW5jdGlvbiBjcmVhdGVUcmVlTm9kZVN0cmVhbSgKICBwdHIsCiAgZGIsCiAgdmlldywKICB7IGd0ID0gLTEsIGd0ZSA9IGd0ICsgMSwgbHRlID0gLTEsIGx0ID0gbHRlID09PSAtMSA/IC0xIDogbHRlICsgMSwgcmV2ZXJzZSA9IGZhbHNlIH0gPSB7fQopIHsKICBjb25zdCBzID0gY29yZS50cmVlKHB0ci5kYXRhUG9pbnRlciwgZ3RlLCAwKQogIGNvbnN0IGUgPSBjb3JlLnRyZWUocHRyLmRhdGFQb2ludGVyLCBsdCA9PT0gLTEgPyBJbmZpbml0eSA6IGx0LCAwKQogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwVHJlZU5vZGUKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZVVzZXJEYXRhU3RyZWFtKAogIHB0ciwKICBkYiwKICB2aWV3LAogIHsgZ3QgPSBudWxsLCBndGUgPSAnJywgbHRlID0gbnVsbCwgbHQgPSBudWxsLCByZXZlcnNlID0gZmFsc2UgfSA9IHt9CikgewogIGlmIChndCAhPT0gbnVsbCB8fCBsdGUgIT09IG51bGwpIHsKICAgIHRocm93IG5ldyBFcnJvcignZ3QgYW5kIGx0ZSBub3QgeWV0IHN1cHBvcnRlZCBmb3IgdXNlciBkYXRhIHN0cmVhbXMnKQogIH0KCiAgY29uc3QgcyA9IGNvcmUudXNlckRhdGEocHRyLmRhdGFQb2ludGVyLCBndGUpCiAgY29uc3QgZSA9IGx0ID09PSBudWxsID8gY29yZS51c2VyRGF0YUVuZChwdHIuZGF0YVBvaW50ZXIpIDogY29yZS51c2VyRGF0YShwdHIuZGF0YVBvaW50ZXIsIGx0KQogIGNvbnN0IGl0ZSA9IHZpZXcuaXRlcmF0b3IoZGIsIHMsIGUsIGZhbHNlKQoKICBpdGUuX3JlYWRhYmxlU3RhdGUubWFwID0gbWFwVXNlckRhdGEKICByZXR1cm4gaXRlCn0KCmZ1bmN0aW9uIGNyZWF0ZUxvY2FsU3RyZWFtKAogIHB0ciwKICBkYiwKICB2aWV3LAogIHsgZ3QgPSBudWxsLCBndGUgPSBFTVBUWSwgbHRlID0gbnVsbCwgbHQgPSBudWxsLCByZXZlcnNlID0gZmFsc2UgfSA9IHt9CikgewogIGlmIChndCAhPT0gbnVsbCB8fCBsdGUgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignZ3QgYW5kIGx0ZSBub3QgeWV0IHN1cHBvcnRlZCBmb3IgbG9jYWwgc3RyZWFtcycpCgogIGNvbnN0IHMgPSBjb3JlLmxvY2FsKHB0ci5kYXRhUG9pbnRlciwgZ3RlKQogIGNvbnN0IGUgPSBsdCA9PT0gbnVsbCA/IGNvcmUubG9jYWxFbmQocHRyLmRhdGFQb2ludGVyKSA6IGNvcmUubG9jYWwocHRyLmRhdGFQb2ludGVyLCBsdCkKICBjb25zdCBpdGUgPSB2aWV3Lml0ZXJhdG9yKGRiLCBzLCBlLCBmYWxzZSkKCiAgaXRlLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcExvY2FsCiAgcmV0dXJuIGl0ZQp9CgpmdW5jdGlvbiBtYXBCaXRmaWVsZChkYXRhKSB7CiAgY29uc3QgW2luZGV4LCB0eXBlXSA9IGNvcmUuYml0ZmllbGRJbmRleEFuZFR5cGUoZGF0YS5rZXkpCiAgaWYgKHR5cGUgIT09IDApIHJldHVybiBudWxsIC8vIGlnbm9yZSBmb3Igbm93CiAgcmV0dXJuIHsgaW5kZXgsIHBhZ2U6IGRhdGEudmFsdWUgfQp9CgpmdW5jdGlvbiBtYXBMb2NhbChkYXRhKSB7CiAgY29uc3Qga2V5ID0gY29yZS5sb2NhbEtleShkYXRhLmtleSkKICByZXR1cm4geyBrZXksIHZhbHVlOiBkYXRhLnZhbHVlIH0KfQoKZnVuY3Rpb24gbWFwVXNlckRhdGEoZGF0YSkgewogIGNvbnN0IGtleSA9IGNvcmUudXNlckRhdGFLZXkoZGF0YS5rZXkpCiAgcmV0dXJuIHsga2V5LCB2YWx1ZTogZGF0YS52YWx1ZSB9Cn0KCmZ1bmN0aW9uIG1hcENvcmUoZGF0YSkgewogIGNvbnN0IGRpc2NvdmVyeUtleSA9IHN0b3JlLmRpc2NvdmVyeUtleShkYXRhLmtleSkKICBjb25zdCBjb3JlID0gQ09SRVNUT1JFX0NPUkUuZGVjb2RlKHsKICAgIHN0YXJ0OiAwLAogICAgZW5kOiBkYXRhLnZhbHVlLmJ5dGVMZW5ndGgsCiAgICBidWZmZXI6IGRhdGEudmFsdWUKICB9KQogIHJldHVybiB7IGRpc2NvdmVyeUtleSwgY29yZSB9Cn0KCmZ1bmN0aW9uIG1hcEFsbERpc2NvdmVyeUtleXMoZGF0YSkgewogIHJldHVybiBzdG9yZS5kaXNjb3ZlcnlLZXkoZGF0YS5rZXkpCn0KCmZ1bmN0aW9uIG1hcE5hbWVzcGFjZURpc2NvdmVyeUtleXMoZGF0YSkgewogIHJldHVybiBkYXRhLnZhbHVlCn0KCmZ1bmN0aW9uIG1hcEFsaWFzKGRhdGEpIHsKICBjb25zdCBhbGlhcyA9IHN0b3JlLmFsaWFzKGRhdGEua2V5KQogIHJldHVybiB7IGFsaWFzLCBkaXNjb3ZlcnlLZXk6IGRhdGEudmFsdWUgfQp9CgpmdW5jdGlvbiBtYXBCbG9jayhkYXRhKSB7CiAgcmV0dXJuIHsgaW5kZXg6IGNvcmUuYmxvY2tJbmRleChkYXRhLmtleSksIHZhbHVlOiBkYXRhLnZhbHVlIH0KfQoKZnVuY3Rpb24gbWFwVHJlZU5vZGUoZGF0YSkgewogIHJldHVybiBDT1JFX1RSRUVfTk9ERS5kZWNvZGUoewogICAgc3RhcnQ6IDAsCiAgICBlbmQ6IGRhdGEudmFsdWUuYnl0ZUxlbmd0aCwKICAgIGJ1ZmZlcjogZGF0YS52YWx1ZQogIH0pCn0KY29uc3Qgc2NoZW1hID0gcmVxdWlyZSgnLi4vc3BlYy9oeXBlcnNjaGVtYScpCmNvbnN0IHsgc3RvcmUsIGNvcmUgfSA9IHJlcXVpcmUoJy4va2V5cy5qcycpCmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuL3ZpZXcuanMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKCmNvbnN0IENPUkVTVE9SRV9IRUFEID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZXN0b3JlL2hlYWQnKQpjb25zdCBDT1JFU1RPUkVfQ09SRSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmVzdG9yZS9jb3JlJykKCmNvbnN0IENPUkVfQVVUSCA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvYXV0aCcpCmNvbnN0IENPUkVfU0VTU0lPTlMgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL3Nlc3Npb25zJykKY29uc3QgQ09SRV9IRUFEID0gc2NoZW1hLmdldEVuY29kaW5nKCdAY29yZS9oZWFkJykKY29uc3QgQ09SRV9UUkVFX05PREUgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL3RyZWUtbm9kZScpCmNvbnN0IENPUkVfREVQRU5ERU5DWSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQGNvcmUvZGVwZW5kZW5jeScpCmNvbnN0IENPUkVfSElOVFMgPSBzY2hlbWEuZ2V0RW5jb2RpbmcoJ0Bjb3JlL2hpbnRzJykKCmNsYXNzIENvcmVUWCB7CiAgY29uc3RydWN0b3IoY29yZSwgZGIsIHZpZXcsIGNoYW5nZXMpIHsKICAgIGlmIChkYi5zbmFwc2hvdHRlZCkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgb3BlbiBjb3JlIHR4IG9uIHNuYXBzaG90JykKICAgIHRoaXMuY29yZSA9IGNvcmUKICAgIHRoaXMuZGIgPSBkYgogICAgdGhpcy52aWV3ID0gdmlldwogICAgdGhpcy5jaGFuZ2VzID0gY2hhbmdlcwogIH0KCiAgc2V0QXV0aChhdXRoKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5hdXRoKHRoaXMuY29yZS5jb3JlUG9pbnRlciksIGVuY29kZShDT1JFX0FVVEgsIGF1dGgpLCBudWxsXSkKICB9CgogIHNldFNlc3Npb25zKHNlc3Npb25zKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5zZXNzaW9ucyh0aGlzLmNvcmUuY29yZVBvaW50ZXIpLCBlbmNvZGUoQ09SRV9TRVNTSU9OUywgc2Vzc2lvbnMpLCBudWxsXSkKICB9CgogIHNldEhlYWQoaGVhZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuaGVhZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpLCBlbmNvZGUoQ09SRV9IRUFELCBoZWFkKSwgbnVsbF0pCiAgfQoKICBkZWxldGVIZWFkKCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuaGVhZCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpLCBudWxsLCBudWxsXSkKICB9CgogIHNldERlcGVuZGVuY3koZGVwKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5kZXBlbmRlbmN5KHRoaXMuY29yZS5kYXRhUG9pbnRlciksIGVuY29kZShDT1JFX0RFUEVOREVOQ1ksIGRlcCksIG51bGxdKQogIH0KCiAgc2V0SGludHMoaGludHMpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmhpbnRzKHRoaXMuY29yZS5kYXRhUG9pbnRlciksIGVuY29kZShDT1JFX0hJTlRTLCBoaW50cyksIG51bGxdKQogIH0KCiAgcHV0QmxvY2soaW5kZXgsIGRhdGEpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmJsb2NrKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgpLCBkYXRhLCBudWxsXSkKICB9CgogIGRlbGV0ZUJsb2NrKGluZGV4KSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5ibG9jayh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4KSwgbnVsbCwgbnVsbF0pCiAgfQoKICBkZWxldGVCbG9ja1JhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS5ibG9jayh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIHN0YXJ0KSwKICAgICAgbnVsbCwKICAgICAgY29yZS5ibG9jayh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGVuZCA9PT0gLTEgPyBJbmZpbml0eSA6IGVuZCkKICAgIF0pCiAgfQoKICBwdXRCaXRmaWVsZFBhZ2UoaW5kZXgsIGRhdGEpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgaW5kZXgsIDApLCBkYXRhLCBudWxsXSkKICB9CgogIGRlbGV0ZUJpdGZpZWxkUGFnZShpbmRleCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUuYml0ZmllbGQodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCwgMCksIG51bGwsIG51bGxdKQogIH0KCiAgZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goWwogICAgICBjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgc3RhcnQsIDApLAogICAgICBudWxsLAogICAgICBjb3JlLmJpdGZpZWxkKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgZW5kID09PSAtMSA/IEluZmluaXR5IDogZW5kLCAwKQogICAgXSkKICB9CgogIHB1dFRyZWVOb2RlKG5vZGUpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS50cmVlKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgbm9kZS5pbmRleCksCiAgICAgIGVuY29kZShDT1JFX1RSRUVfTk9ERSwgbm9kZSksCiAgICAgIG51bGwKICAgIF0pCiAgfQoKICBkZWxldGVUcmVlTm9kZShpbmRleCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUudHJlZSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGluZGV4KSwgbnVsbCwgbnVsbF0pCiAgfQoKICBkZWxldGVUcmVlTm9kZVJhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFsKICAgICAgY29yZS50cmVlKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgc3RhcnQpLAogICAgICBudWxsLAogICAgICBjb3JlLnRyZWUodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBlbmQgPT09IC0xID8gSW5maW5pdHkgOiBlbmQpCiAgICBdKQogIH0KCiAgcHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkgewogICAgY29uc3QgYnVmZmVyID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IGI0YS5mcm9tKHZhbHVlKSA6IHZhbHVlCiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS51c2VyRGF0YSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSksIGJ1ZmZlciwgbnVsbF0pCiAgfQoKICBkZWxldGVVc2VyRGF0YShrZXkpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtjb3JlLnVzZXJEYXRhKHRoaXMuY29yZS5kYXRhUG9pbnRlciwga2V5KSwgbnVsbCwgbnVsbF0pCiAgfQoKICBwdXRMb2NhbChrZXksIHZhbHVlKSB7CiAgICB0aGlzLmNoYW5nZXMucHVzaChbY29yZS5sb2NhbCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSksIHZhbHVlLCBudWxsXSkKICB9CgogIGRlbGV0ZUxvY2FsKGtleSkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW2NvcmUubG9jYWwodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBrZXkpLCBudWxsLCBudWxsXSkKICB9CgogIGRlbGV0ZUxvY2FsUmFuZ2Uoc3RhcnQsIGVuZCkgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goWwogICAgICBjb3JlLmxvY2FsKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgc3RhcnQpLAogICAgICBudWxsLAogICAgICBlbmQgPT09IG51bGwgPyBjb3JlLmxvY2FsRW5kKHRoaXMuY29yZS5kYXRhUG9pbnRlcikgOiBjb3JlLmxvY2FsKHRoaXMuY29yZS5kYXRhUG9pbnRlciwgZW5kKQogICAgXSkKICB9CgogIGZsdXNoKCkgewogICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuY2hhbmdlcwogICAgaWYgKGNoYW5nZXMgPT09IG51bGwpIHJldHVybiBQcm9taXNlLnJlc29sdmUoIXRoaXMudmlldykKCiAgICB0aGlzLmNoYW5nZXMgPSBudWxsCgogICAgaWYgKHRoaXMudmlldykgewogICAgICB0aGlzLnZpZXcuYXBwbHkoY2hhbmdlcykKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSkKICAgIH0KCiAgICByZXR1cm4gVmlldy5mbHVzaChjaGFuZ2VzLCB0aGlzLmRiKQogIH0KfQoKY2xhc3MgQ29yZVJYIHsKICBjb25zdHJ1Y3Rvcihjb3JlLCBkYiwgdmlldykgewogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5yZWFkID0gZGIucmVhZCh7IGF1dG9EZXN0cm95OiB0cnVlIH0pCiAgICB0aGlzLnZpZXcgPSB2aWV3CgogICAgdmlldy5yZWFkU3RhcnQoKQogIH0KCiAgc3RhdGljIGFzeW5jIGdldEF1dGgoZGIsIGMpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoQ09SRV9BVVRILCBhd2FpdCBkYi5nZXQoY29yZS5hdXRoKGMuY29yZVBvaW50ZXIpKSkKICB9CgogIGFzeW5jIGdldEF1dGgoKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKENPUkVfQVVUSCwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuYXV0aCh0aGlzLmNvcmUuY29yZVBvaW50ZXIpKSkKICB9CgogIGFzeW5jIGdldFNlc3Npb25zKCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZSgKICAgICAgQ09SRV9TRVNTSU9OUywKICAgICAgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuc2Vzc2lvbnModGhpcy5jb3JlLmNvcmVQb2ludGVyKSkKICAgICkKICB9CgogIHN0YXRpYyBhc3luYyBnZXRIZWFkKGRiLCBjKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKENPUkVfSEVBRCwgYXdhaXQgZGIuZ2V0KGNvcmUuaGVhZChjLmRhdGFQb2ludGVyKSkpCiAgfQoKICBhc3luYyBnZXRIZWFkKCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZShDT1JFX0hFQUQsIGF3YWl0IHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBjb3JlLmhlYWQodGhpcy5jb3JlLmRhdGFQb2ludGVyKSkpCiAgfQoKICBhc3luYyBnZXREZXBlbmRlbmN5KCkgewogICAgcmV0dXJuIGF3YWl0IGRlY29kZSgKICAgICAgQ09SRV9ERVBFTkRFTkNZLAogICAgICBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5kZXBlbmRlbmN5KHRoaXMuY29yZS5kYXRhUG9pbnRlcikpCiAgICApCiAgfQoKICBzdGF0aWMgYXN5bmMgZ2V0SGludHMoZGIsIGMpIHsKICAgIHJldHVybiBhd2FpdCBkZWNvZGUoQ09SRV9ISU5UUywgYXdhaXQgZGIuZ2V0KGNvcmUuaGludHMoYy5kYXRhUG9pbnRlcikpKQogIH0KCiAgYXN5bmMgZ2V0SGludHMoKSB7CiAgICByZXR1cm4gYXdhaXQgZGVjb2RlKAogICAgICBDT1JFX0hJTlRTLAogICAgICBhd2FpdCB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5oaW50cyh0aGlzLmNvcmUuZGF0YVBvaW50ZXIpKQogICAgKQogIH0KCiAgZ2V0QmxvY2soaW5kZXgpIHsKICAgIGNvbnN0IGRlcCA9IGZpbmRCbG9ja0RlcGVuZGVuY3kodGhpcy5jb3JlLmRlcGVuZGVuY2llcywgaW5kZXgpCiAgICBjb25zdCBkYXRhID0gZGVwID09PSBudWxsID8gdGhpcy5jb3JlLmRhdGFQb2ludGVyIDogZGVwLmRhdGFQb2ludGVyCiAgICByZXR1cm4gdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuYmxvY2soZGF0YSwgaW5kZXgpKQogIH0KCiAgZ2V0Qml0ZmllbGRQYWdlKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUuYml0ZmllbGQodGhpcy5jb3JlLmRhdGFQb2ludGVyLCBpbmRleCwgMCkpCiAgfQoKICBhc3luYyBnZXRUcmVlTm9kZShpbmRleCkgewogICAgY29uc3QgZGVwID0gZmluZFRyZWVEZXBlbmRlbmN5KHRoaXMuY29yZS5kZXBlbmRlbmNpZXMsIGluZGV4KQogICAgY29uc3QgZGF0YSA9IGRlcCA9PT0gbnVsbCA/IHRoaXMuY29yZS5kYXRhUG9pbnRlciA6IGRlcC5kYXRhUG9pbnRlcgogICAgcmV0dXJuIGRlY29kZShDT1JFX1RSRUVfTk9ERSwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIGNvcmUudHJlZShkYXRhLCBpbmRleCkpKQogIH0KCiAgYXN5bmMgaGFzVHJlZU5vZGUoaW5kZXgpIHsKICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRUcmVlTm9kZShpbmRleCkpICE9PSBudWxsCiAgfQoKICBnZXRVc2VyRGF0YShrZXkpIHsKICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS51c2VyRGF0YSh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSkpCiAgfQoKICBnZXRMb2NhbChrZXkpIHsKICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0KHRoaXMucmVhZCwgY29yZS5sb2NhbCh0aGlzLmNvcmUuZGF0YVBvaW50ZXIsIGtleSkpCiAgfQoKICB0cnlGbHVzaCgpIHsKICAgIHRoaXMucmVhZC50cnlGbHVzaCgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLnJlYWQuZGVzdHJveSgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIF9mcmVlKCkgewogICAgaWYgKHRoaXMudmlldyA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLnZpZXcucmVhZFN0b3AoKQogICAgdGhpcy52aWV3ID0gbnVsbAogIH0KfQoKY2xhc3MgQ29yZXN0b3JlVFggewogIGNvbnN0cnVjdG9yKHZpZXcpIHsKICAgIHRoaXMudmlldyA9IHZpZXcKICAgIHRoaXMuY2hhbmdlcyA9IFtdCiAgfQoKICBzZXRIZWFkKGhlYWQpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtzdG9yZS5oZWFkKCksIGVuY29kZShDT1JFU1RPUkVfSEVBRCwgaGVhZCksIG51bGxdKQogIH0KCiAgcHV0Q29yZShkaXNjb3ZlcnlLZXksIHB0cikgewogICAgdGhpcy5jaGFuZ2VzLnB1c2goW3N0b3JlLmNvcmUoZGlzY292ZXJ5S2V5KSwgZW5jb2RlKENPUkVTVE9SRV9DT1JFLCBwdHIpLCBudWxsXSkKICB9CgogIHB1dENvcmVCeUFsaWFzKGFsaWFzLCBkaXNjb3ZlcnlLZXkpIHsKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtzdG9yZS5jb3JlQnlBbGlhcyhhbGlhcyksIGRpc2NvdmVyeUtleSwgbnVsbF0pCiAgfQoKICBjbGVhcigpIHsKICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IHN0b3JlLmNsZWFyKCkKICAgIHRoaXMuY2hhbmdlcy5wdXNoKFtzdGFydCwgbnVsbCwgZW5kXSkKICB9CgogIGFwcGx5KCkgewogICAgaWYgKHRoaXMuY2hhbmdlcyA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLnZpZXcuYXBwbHkodGhpcy5jaGFuZ2VzKQogICAgdGhpcy5jaGFuZ2VzID0gbnVsbAogIH0KfQoKY2xhc3MgQ29yZXN0b3JlUlggewogIGNvbnN0cnVjdG9yKGRiLCB2aWV3KSB7CiAgICB0aGlzLnJlYWQgPSBkYi5yZWFkKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIHRoaXMudmlldyA9IHZpZXcKCiAgICB2aWV3LnJlYWRTdGFydCgpCiAgfQoKICBhc3luYyBnZXRIZWFkKCkgewogICAgcmV0dXJuIGRlY29kZShDT1JFU1RPUkVfSEVBRCwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIHN0b3JlLmhlYWQoKSkpCiAgfQoKICBhc3luYyBnZXRDb3JlKGRpc2NvdmVyeUtleSkgewogICAgcmV0dXJuIGRlY29kZShDT1JFU1RPUkVfQ09SRSwgYXdhaXQgdGhpcy52aWV3LmdldCh0aGlzLnJlYWQsIHN0b3JlLmNvcmUoZGlzY292ZXJ5S2V5KSkpCiAgfQoKICBnZXRDb3JlQnlBbGlhcyhhbGlhcykgewogICAgcmV0dXJuIHRoaXMudmlldy5nZXQodGhpcy5yZWFkLCBzdG9yZS5jb3JlQnlBbGlhcyhhbGlhcykpCiAgfQoKICB0cnlGbHVzaCgpIHsKICAgIHRoaXMucmVhZC50cnlGbHVzaCgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLnJlYWQuZGVzdHJveSgpCiAgICB0aGlzLl9mcmVlKCkKICB9CgogIF9mcmVlKCkgewogICAgaWYgKHRoaXMudmlldyA9PT0gbnVsbCkgcmV0dXJuCiAgICB0aGlzLnZpZXcucmVhZFN0b3AoKQogICAgdGhpcy52aWV3ID0gbnVsbAogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7IENvcmVzdG9yZVRYLCBDb3Jlc3RvcmVSWCwgQ29yZVRYLCBDb3JlUlggfQoKZnVuY3Rpb24gZmluZEJsb2NrRGVwZW5kZW5jeShkZXBlbmRlbmNpZXMsIGluZGV4KSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGRlcCA9IGRlcGVuZGVuY2llc1tpXQogICAgaWYgKGluZGV4IDwgZGVwLmxlbmd0aCkgcmV0dXJuIGRlcAogIH0KCiAgcmV0dXJuIG51bGwKfQoKZnVuY3Rpb24gZmluZFRyZWVEZXBlbmRlbmN5KGRlcGVuZGVuY2llcywgaW5kZXgpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgZGVwID0gZGVwZW5kZW5jaWVzW2ldCiAgICBpZiAoZmxhdC5yaWdodFNwYW4oaW5kZXgpIDw9IChkZXAubGVuZ3RoIC0gMSkgKiAyKSByZXR1cm4gZGVwCiAgfQoKICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBkZWNvZGUoZW5jLCBidWZmZXIpIHsKICBpZiAoYnVmZmVyID09PSBudWxsKSByZXR1cm4gbnVsbAogIHJldHVybiBlbmMuZGVjb2RlKHsgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGgsIGJ1ZmZlciB9KQp9CgpmdW5jdGlvbiBlbmNvZGUoZW5jLCBtKSB7CiAgLy8gVE9ETzogdXNlIGZhbmN5IHNsYWIgZm9yIHNtYWxsIG1lc3NhZ2VzCiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CiAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgp9CmNvbnN0IHsgUmVhZGFibGUsIGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgQ2xvc2VFcnJvclN0cmVhbSA9IHJlcXVpcmUoJy4vY2xvc2UtZXJyb3Itc3RyZWFtLmpzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNsYXNzIE92ZXJsYXlTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3Ioc3RyZWFtLCBzdGFydCwgZW5kLCByZXZlcnNlLCBjaGFuZ2VzLCBjbGVhcmVkKSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5zdGFydCA9IHN0YXJ0CiAgICB0aGlzLmVuZCA9IGVuZAogICAgdGhpcy5yZXZlcnNlID0gcmV2ZXJzZQogICAgdGhpcy5jaGFuZ2VzID0gY2hhbmdlcwogICAgdGhpcy5jbGVhcmVkID0gY2xlYXJlZAogICAgdGhpcy5jaGFuZ2UgPSAwCiAgICB0aGlzLnJhbmdlID0gMAoKICAgIHRoaXMuX3N0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5fZHJhaW5lZCA9IGZhbHNlCgogICAgdGhpcy5fc3RyZWFtLm9uKCdyZWFkYWJsZScsIHRoaXMuX2RyYWluTWF5YmUuYmluZCh0aGlzKSkKICAgIHRoaXMuX3N0cmVhbS5vbignZXJyb3InLCBub29wKQogICAgdGhpcy5fc3RyZWFtLm9uKCdjbG9zZScsIHRoaXMuX29uY2xvc2UuYmluZCh0aGlzKSkKICB9CgogIF9kcmFpbk1heWJlKCkgewogICAgaWYgKHRoaXMuX2RyYWluZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5fZHJhaW5lZCA9IHRoaXMuX29ucmVhZGFibGUoKQogIH0KCiAgX29uY2xvc2UoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95aW5nKSByZXR1cm4KCiAgICBjb25zdCBlcnIgPSBnZXRTdHJlYW1FcnJvcih0aGlzLl9zdHJlYW0pCgogICAgaWYgKGVyciAhPT0gbnVsbCkgewogICAgICB0aGlzLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICB3aGlsZSAodGhpcy5jaGFuZ2UgPCB0aGlzLmNoYW5nZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLmNoYW5nZXNbdGhpcy5jaGFuZ2UrK10KICAgICAgY29uc3Qga2V5ID0gY1swXQogICAgICBjb25zdCB2YWx1ZSA9IGNbMV0KCiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0aGlzLl9pblJhbmdlKGtleSkpIHRoaXMucHVzaCh7IGtleSwgdmFsdWUgfSkKICAgIH0KCiAgICB0aGlzLnB1c2gobnVsbCkKICAgIHRoaXMuX3N0cmVhbSA9IG51bGwKICB9CgogIF9vbnJlYWRhYmxlKCkgewogICAgbGV0IGRhdGEgPSB0aGlzLl9zdHJlYW0ucmVhZCgpCiAgICBpZiAoZGF0YSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgbGV0IGRyYWluZWQgPSBmYWxzZQoKICAgIGRvIHsKICAgICAgaWYgKHRoaXMuX3B1c2goZGF0YSkgPT09IHRydWUpIGRyYWluZWQgPSB0cnVlCiAgICAgIGRhdGEgPSB0aGlzLl9zdHJlYW0ucmVhZCgpCiAgICB9IHdoaWxlIChkYXRhICE9PSBudWxsKQoKICAgIHJldHVybiBkcmFpbmVkCiAgfQoKICBfcmVhZChjYikgewogICAgdGhpcy5fZHJhaW5lZCA9IHRoaXMuX29ucmVhZGFibGUoKQogICAgY2IobnVsbCkKICB9CgogIF9wcmVkZXN0cm95KCkgewogICAgdGhpcy5zdHJlYW0uZGVzdHJveSgpCiAgfQoKICBfcHVzaChlbnRyeSkgewogICAgY29uc3Qga2V5ID0gZW50cnkua2V5CgogICAgd2hpbGUgKHRoaXMucmFuZ2UgPCB0aGlzLmNsZWFyZWQubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGMgPSB0aGlzLmNsZWFyZWRbdGhpcy5yYW5nZV0KCiAgICAgIC8vIHdlIG1vdmVkIHBhc3QgdGhlIHJhbmdlCiAgICAgIGlmICh0aGlzLnJldmVyc2UgPyBiNGEuY29tcGFyZShrZXksIGNbMF0pIDwgMCA6IGI0YS5jb21wYXJlKGNbMl0sIGtleSkgPD0gMCkgewogICAgICAgIHRoaXMucmFuZ2UrKwogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIHdlIGRpZG50IG1vdmUgcGFzdCBhbmQgYXJlIGluLCBkcm9wCiAgICAgIGlmIChiNGEuY29tcGFyZShjWzBdLCBrZXkpIDw9IDAgJiYgYjRhLmNvbXBhcmUoa2V5LCBjWzJdKSA8IDApIHsKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQoKICAgICAgYnJlYWsKICAgIH0KCiAgICBsZXQgdXBkYXRlZCA9IGZhbHNlCgogICAgd2hpbGUgKHRoaXMuY2hhbmdlIDwgdGhpcy5jaGFuZ2VzLmxlbmd0aCkgewogICAgICBjb25zdCBjID0gdGhpcy5jaGFuZ2VzW3RoaXMuY2hhbmdlXQogICAgICBjb25zdCBrZXkgPSBjWzBdCiAgICAgIGNvbnN0IHZhbHVlID0gdHlwZW9mIGNbMV0gPT09ICdzdHJpbmcnID8gYjRhLmZyb20oY1sxXSkgOiBjWzFdCiAgICAgIGNvbnN0IGNtcCA9IGI0YS5jb21wYXJlKGtleSwgZW50cnkua2V5KQoKICAgICAgLy8gc2FtZSB2YWx1ZSwgaWYgbm90IGRlbGV0ZWQsIHJldHVybiBuZXcgb25lCiAgICAgIGlmIChjbXAgPT09IDApIHsKICAgICAgICB0aGlzLmNoYW5nZSsrCiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHRoaXMuX2luUmFuZ2Uoa2V5KSA9PT0gZmFsc2UpIHJldHVybiB1cGRhdGVkCiAgICAgICAgdGhpcy5wdXNoKHsga2V5LCB2YWx1ZSB9KQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIC8vIHdlIG1vdmVkIHBhc3QgdGhlIGNoYW5nZSwgcHVzaCBpdAogICAgICBpZiAodGhpcy5yZXZlcnNlID8gY21wID4gMCA6IGNtcCA8IDApIHsKICAgICAgICB0aGlzLmNoYW5nZSsrCiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHRoaXMuX2luUmFuZ2Uoa2V5KSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgICAgdGhpcy5wdXNoKHsga2V5LCB2YWx1ZSB9KQogICAgICAgIHVwZGF0ZWQgPSB0cnVlCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgdGhpcy5wdXNoKGVudHJ5KQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMucHVzaChlbnRyeSkKICAgIHJldHVybiB0cnVlCiAgfQoKICBfaW5SYW5nZShrZXkpIHsKICAgIHJldHVybiBiNGEuY29tcGFyZSh0aGlzLnN0YXJ0LCBrZXkpIDw9IDAgJiYgYjRhLmNvbXBhcmUoa2V5LCB0aGlzLmVuZCkgPCAwCiAgfQp9CgpjbGFzcyBPdmVybGF5IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuaW5kZXhlZCA9IDAKICAgIHRoaXMuY2hhbmdlcyA9IG51bGwKICAgIHRoaXMuY2xlYXJlZCA9IG51bGwKICAgIHRoaXMucmV2ZXJzZSA9IGZhbHNlCiAgfQoKICB1cGRhdGUodmlldywgcmV2ZXJzZSkgewogICAgaWYgKHZpZXcuaW5kZXhlZCA9PT0gdGhpcy5pbmRleGVkKSByZXR1cm4KCiAgICBjb25zdCBjaGFuZ2VzID0gdmlldy5tYXAgPT09IG51bGwgPyBbXSA6IFsuLi52aWV3Lm1hcC52YWx1ZXMoKV0KICAgIGNvbnN0IGNsZWFyZWQgPSB2aWV3LmNsZWFyZWQgPT09IG51bGwgPyBbXSA6IHZpZXcuY2xlYXJlZC5zbGljZSgwKQoKICAgIGNvbnN0IGNtcCA9IHJldmVyc2UgPyBjbXBDaGFuZ2VSZXZlcnNlIDogY21wQ2hhbmdlCgogICAgY2hhbmdlcy5zb3J0KGNtcCkKICAgIGNsZWFyZWQuc29ydChjbXApCgogICAgdGhpcy5pbmRleGVkID0gdmlldy5pbmRleGVkCiAgICB0aGlzLmNoYW5nZXMgPSBjaGFuZ2VzCiAgICB0aGlzLmNsZWFyZWQgPSBjbGVhcmVkCiAgICB0aGlzLnJldmVyc2UgPSByZXZlcnNlCiAgfQoKICBjcmVhdGVTdHJlYW0oc3RyZWFtLCBzdGFydCwgZW5kLCByZXZlcnNlKSB7CiAgICByZXR1cm4gbmV3IE92ZXJsYXlTdHJlYW0oCiAgICAgIHN0cmVhbSwKICAgICAgc3RhcnQsCiAgICAgIGVuZCwKICAgICAgcmV2ZXJzZSwKICAgICAgdGhpcy5yZXZlcnNlID09PSByZXZlcnNlID8gdGhpcy5jaGFuZ2VzIDogcmV2ZXJzZUFycmF5KHRoaXMuY2hhbmdlcyksCiAgICAgIHRoaXMucmV2ZXJzZSA9PT0gcmV2ZXJzZSA/IHRoaXMuY2xlYXJlZCA6IHJldmVyc2VBcnJheSh0aGlzLmNsZWFyZWQpCiAgICApCiAgfQp9CgpjbGFzcyBWaWV3IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFwID0gbnVsbAogICAgdGhpcy5pbmRleGVkID0gMAogICAgdGhpcy5jaGFuZ2VzID0gbnVsbAogICAgdGhpcy5jbGVhcmVkID0gbnVsbAogICAgdGhpcy5vdmVybGF5ID0gbnVsbAogICAgdGhpcy5zbmFwID0gbnVsbAogICAgdGhpcy5yZWFkZXJzID0gMAogIH0KCiAgc25hcHNob3QoKSB7CiAgICBpZiAodGhpcy5fYXR0YWNoZWQoKSkgcmV0dXJuIHRoaXMuc25hcC5zbmFwc2hvdCgpCgogICAgY29uc3Qgc25hcCA9IG5ldyBWaWV3KCkKCiAgICBzbmFwLm1hcCA9IHRoaXMubWFwCiAgICBzbmFwLmluZGV4ZWQgPSB0aGlzLmluZGV4ZWQKICAgIHNuYXAuY2hhbmdlcyA9IHRoaXMuY2hhbmdlcwogICAgc25hcC5jbGVhcmVkID0gdGhpcy5jbGVhcmVkCgogICAgaWYgKHRoaXMuX2Zyb3plbigpKSByZXR1cm4gc25hcAoKICAgIHRoaXMucmVhZGVycysrCiAgICBzbmFwLnNuYXAgPSB0aGlzCgogICAgcmV0dXJuIHNuYXAKICB9CgogIHJlYWRTdGFydCgpIHsKICAgIGlmICh0aGlzLnNuYXAgIT09IG51bGwpIHRoaXMucmVhZGVycysrCiAgfQoKICByZWFkU3RvcCgpIHsKICAgIGlmICh0aGlzLnNuYXAgIT09IG51bGwgJiYgLS10aGlzLnJlYWRlcnMgPT09IDApIHRoaXMuc25hcC5yZWFkZXJzLS0KICB9CgogIHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5jaGFuZ2VzID09PSBudWxsID8gMCA6IHRoaXMuY2hhbmdlcy5sZW5ndGgKICB9CgogIHVwZGF0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5jaGFuZ2VzID09PSBudWxsCiAgfQoKICBnZXQocmVhZCwga2V5KSB7CiAgICByZXR1cm4gdGhpcy5jaGFuZ2VzID09PSBudWxsID8gcmVhZC5nZXQoa2V5KSA6IHRoaXMuX2luZGV4QW5kR2V0KHJlYWQsIGtleSkKICB9CgogIHJlc2V0KCkgewogICAgdGhpcy5pbmRleGVkID0gMAogICAgdGhpcy5zbmFwID0gdGhpcy5tYXAgPSB0aGlzLmNoYW5nZXMgPSB0aGlzLmNsZWFyZWQgPSB0aGlzLm92ZXJsYXkgPSBudWxsCiAgfQoKICBpdGVyYXRvcihkYiwgc3RhcnQsIGVuZCwgcmV2ZXJzZSkgewogICAgaWYgKGRiQ2xvc2luZyhkYikpIHJldHVybiBuZXcgQ2xvc2VFcnJvclN0cmVhbShuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKSkKCiAgICBjb25zdCBzdHJlYW0gPSBkYi5pdGVyYXRvcih7IGd0ZTogc3RhcnQsIGx0OiBlbmQsIHJldmVyc2UgfSkKICAgIGlmICh0aGlzLmNoYW5nZXMgPT09IG51bGwpIHJldHVybiBzdHJlYW0KCiAgICB0aGlzLl9pbmRleCgpCgogICAgaWYgKHRoaXMub3ZlcmxheSA9PT0gbnVsbCkgdGhpcy5vdmVybGF5ID0gbmV3IE92ZXJsYXkoKQogICAgdGhpcy5vdmVybGF5LnVwZGF0ZSh0aGlzLCByZXZlcnNlKQogICAgcmV0dXJuIHRoaXMub3ZlcmxheS5jcmVhdGVTdHJlYW0oc3RyZWFtLCBzdGFydCwgZW5kLCByZXZlcnNlKQogIH0KCiAgX2luZGV4QW5kR2V0KHJlYWQsIGtleSkgewogICAgdGhpcy5faW5kZXgoKQogICAgY29uc3QgY2hhbmdlID0gdGhpcy5tYXAuZ2V0KGI0YS50b1N0cmluZyhrZXksICdoZXgnKSkKCiAgICBpZiAoY2hhbmdlID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xlYXJlZCA9PT0gbnVsbCA/IHJlYWQuZ2V0KGtleSkgOiB0aGlzLl9yZWFkQW5kTWF5YmVEcm9wKHJlYWQsIGtleSkKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNoYW5nZVsxXSkKICB9CgogIGFzeW5jIF9yZWFkQW5kTWF5YmVEcm9wKHJlYWQsIGtleSkgewogICAgY29uc3QgY2xlYXJlZCA9IHRoaXMuY2xlYXJlZCAvLyBpbiBjYXNlIGl0cyBjbGVhcmVkCiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHJlYWQuZ2V0KGtleSkKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIG51bGwKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNsZWFyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYyA9IGNsZWFyZWRbaV0KICAgICAgLy8gY2hlY2sgaWYgaW4gcmFuZ2UKICAgICAgaWYgKGI0YS5jb21wYXJlKGNbMF0sIGtleSkgPD0gMCAmJiBiNGEuY29tcGFyZShrZXksIGNbMl0pIDwgMCkgcmV0dXJuIG51bGwKICAgIH0KCiAgICByZXR1cm4gdmFsdWUKICB9CgogIF9hdHRhY2hlZCgpIHsKICAgIHJldHVybiB0aGlzLnNuYXAgIT09IG51bGwgJiYgdGhpcy5jaGFuZ2VzID09PSB0aGlzLnNuYXAuY2hhbmdlcwogIH0KCiAgX2Zyb3plbigpIHsKICAgIHJldHVybiB0aGlzLmNoYW5nZXMgPT09IG51bGwgfHwgKHRoaXMuc25hcCAhPT0gbnVsbCAmJiB0aGlzLmNoYW5nZXMgIT09IHRoaXMuc25hcC5jaGFuZ2VzKQogIH0KCiAgX2luZGV4KCkgewogICAgLy8gaWYgd2UgYXJlIGEgc25hcCBhbmQgd2UgYXJlIHN0aWxsIGF0dGFjaGVkIChpZSBubyBtdXRhdGlvbnMpLCBzaW1wbHkgY29weSB0aGUgcmVmcwogICAgaWYgKHRoaXMuX2F0dGFjaGVkKCkpIHsKICAgICAgdGhpcy5zbmFwLl9pbmRleCgpCiAgICAgIHRoaXMubWFwID0gdGhpcy5zbmFwLm1hcAogICAgICB0aGlzLmNsZWFyZWQgPSB0aGlzLnNuYXAuY2xlYXJlZAogICAgICB0aGlzLmluZGV4ZWQgPSB0aGlzLnNuYXAuaW5kZXhlZAogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5tYXAgPT09IG51bGwpIHRoaXMubWFwID0gbmV3IE1hcCgpCiAgICBpZiAodGhpcy5jaGFuZ2VzLmxlbmd0aCA9PT0gdGhpcy5pbmRleGVkKSByZXR1cm4KCiAgICB3aGlsZSAodGhpcy5pbmRleGVkIDwgdGhpcy5jaGFuZ2VzLmxlbmd0aCkgewogICAgICBjb25zdCBjID0gdGhpcy5jaGFuZ2VzW3RoaXMuaW5kZXhlZCsrXQoKICAgICAgaWYgKGNbMl0gPT09IG51bGwpIHRoaXMubWFwLnNldChiNGEudG9TdHJpbmcoY1swXSwgJ2hleCcpLCBjKQogICAgICBlbHNlIHRoaXMuX2luZGV4UmFuZ2UoYykKICAgIH0KICB9CgogIF9pbmRleFJhbmdlKHJhbmdlKSB7CiAgICBjb25zdCBzID0gYjRhLnRvU3RyaW5nKHJhbmdlWzBdLCAnaGV4JykKICAgIGNvbnN0IGUgPSBiNGEudG9TdHJpbmcocmFuZ2VbMl0sICdoZXgnKQoKICAgIGZvciAoY29uc3QgW2tleSwgY10gb2YgdGhpcy5tYXApIHsKICAgICAgaWYgKHMgPD0ga2V5ICYmIGtleSA8IGUpIHRoaXMubWFwLnNldChrZXksIFtjWzBdLCBudWxsLCBudWxsXSkKICAgIH0KCiAgICBpZiAodGhpcy5jbGVhcmVkID09PSBudWxsKSB0aGlzLmNsZWFyZWQgPSBbXQogICAgdGhpcy5jbGVhcmVkLnB1c2gocmFuZ2UpCiAgfQoKICBhcHBseShjaGFuZ2VzKSB7CiAgICBpZiAodGhpcy5zbmFwICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ0lsbGVnYWwgdG8gcHVzaCBjaGFuZ2VzIHRvIGEgc25hcHNob3QnKQoKICAgIGlmICh0aGlzLnJlYWRlcnMgIT09IDAgJiYgdGhpcy5jaGFuZ2VzICE9PSBudWxsKSB7CiAgICAgIHRoaXMuY2hhbmdlcyA9IHRoaXMuY2hhbmdlcy5zbGljZSgwKQogICAgICB0aGlzLmNsZWFyZWQgPSB0aGlzLmNsZWFyZWQgPT09IG51bGwgPyBudWxsIDogdGhpcy5jbGVhcmVkLnNsaWNlKDApCiAgICAgIHRoaXMubWFwID0gdGhpcy5tYXAgPT09IG51bGwgPyBudWxsIDogbmV3IE1hcChbLi4udGhpcy5tYXBdKQogICAgfQoKICAgIGlmICh0aGlzLmNoYW5nZXMgPT09IG51bGwpIHsKICAgICAgdGhpcy5jaGFuZ2VzID0gY2hhbmdlcwogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5jaGFuZ2VzLnB1c2goY2hhbmdlc1tpXSkKICAgIH0KICB9CgogIHN0YXRpYyBhc3luYyBmbHVzaChjaGFuZ2VzLCBkYikgewogICAgaWYgKGNoYW5nZXMgPT09IG51bGwpIHJldHVybiB0cnVlCgogICAgY29uc3QgdyA9IGRiLndyaXRlKHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKCiAgICBmb3IgKGNvbnN0IFtzdGFydCwgdmFsdWUsIGVuZF0gb2YgY2hhbmdlcykgewogICAgICBpZiAoZW5kICE9PSBudWxsKSB3LnRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpCiAgICAgIGVsc2UgaWYgKHZhbHVlICE9PSBudWxsKSB3LnRyeVB1dChzdGFydCwgdmFsdWUpCiAgICAgIGVsc2Ugdy50cnlEZWxldGUoc3RhcnQpCiAgICB9CgogICAgYXdhaXQgdy5mbHVzaCgpCgogICAgcmV0dXJuIHRydWUKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gVmlldwoKZnVuY3Rpb24gY21wQ2hhbmdlKGEsIGIpIHsKICBjb25zdCBjID0gYjRhLmNvbXBhcmUoYVswXSwgYlswXSkKICByZXR1cm4gYyA9PT0gMCA/IGI0YS5jb21wYXJlKGFbMl0sIGJbMl0pIDogYwp9CgpmdW5jdGlvbiBjbXBDaGFuZ2VSZXZlcnNlKGEsIGIpIHsKICByZXR1cm4gY21wQ2hhbmdlKGIsIGEpCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gcmV2ZXJzZUFycmF5KGxpc3QpIHsKICBjb25zdCByID0gbmV3IEFycmF5KGxpc3QubGVuZ3RoKQogIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgcltyLmxlbmd0aCAtIDEgLSBpXSA9IGxpc3RbaV0KICByZXR1cm4gcgp9CgovLyBUT0RPOiBleHBvc2UgZnJvbSByb2NrcyBpbnN0ZWFkCmZ1bmN0aW9uIGRiQ2xvc2luZyhkYikgewogIHJldHVybiBkYi5fc3RhdGUuY2xvc2luZyB8fCBkYi5faW5kZXggPT09IC0xCn0KY29uc3QgZnMgPSByZXF1aXJlKCdmcycpCmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJykKY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcy5qcycpCmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuLi8uLi9saWIvdmlldy5qcycpCmNvbnN0IHsgQ29yZXN0b3JlVFgsIENvcmVUWCwgQ29yZXN0b3JlUlggfSA9IHJlcXVpcmUoJy4uLy4uL2xpYi90eC5qcycpCgpjb25zdCBFTVBUWV9OT0RFID0gYjRhLmFsbG9jKDQwKQpjb25zdCBFTVBUWV9QQUdFID0gYjRhLmFsbG9jKDQwOTYpCgpsZXQgVFJFRV8wMV9TS0lQID0gbnVsbApsZXQgVFJFRV8wNF9TS0lQID0gbnVsbApsZXQgVFJFRV8xNl9TS0lQID0gbnVsbAoKY2xhc3MgQ29yZUxpc3RTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IgKHN0b3JhZ2UpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlCiAgICB0aGlzLnN0YWNrID0gW10KICB9CgogIGFzeW5jIF9vcGVuIChjYikgewogICAgZm9yIChjb25zdCBhIG9mIGF3YWl0IHJlYWRkaXIocGF0aC5qb2luKHRoaXMuc3RvcmFnZSwgJ2NvcmVzJykpKSB7CiAgICAgIGZvciAoY29uc3QgYiBvZiBhd2FpdCByZWFkZGlyKHBhdGguam9pbih0aGlzLnN0b3JhZ2UsICdjb3JlcycsIGEpKSkgewogICAgICAgIGZvciAoY29uc3QgZGtleSBvZiBhd2FpdCByZWFkZGlyKHBhdGguam9pbih0aGlzLnN0b3JhZ2UsICdjb3JlcycsIGEsIGIpKSkgewogICAgICAgICAgdGhpcy5zdGFjay5wdXNoKHBhdGguam9pbih0aGlzLnN0b3JhZ2UsICdjb3JlcycsIGEsIGIsIGRrZXkpKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNiKG51bGwpCiAgfQoKICBhc3luYyBfcmVhZCAoY2IpIHsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IG5leHQgPSB0aGlzLnN0YWNrLnBvcCgpCiAgICAgIGlmICghbmV4dCkgewogICAgICAgIHRoaXMucHVzaChudWxsKQogICAgICAgIGJyZWFrCiAgICAgIH0KCiAgICAgIGNvbnN0IG9wbG9nID0gcGF0aC5qb2luKG5leHQsICdvcGxvZycpCiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlYWRPcGxvZyhvcGxvZykKICAgICAgaWYgKCFyZXN1bHQpIGNvbnRpbnVlCgogICAgICB0aGlzLnB1c2gocmVzdWx0KQogICAgICBicmVhawogICAgfQoKICAgIGNiKG51bGwpCiAgfQp9CgpmdW5jdGlvbiBkZWNvZGVPcGxvZ0hlYWRlciAoc3RhdGUpIHsKICBjLnVpbnQzMi5kZWNvZGUoc3RhdGUpIC8vIGNrc3VtLCBpZ25vcmUgZm9yIG5vdwoKICBjb25zdCBsID0gYy51aW50MzIuZGVjb2RlKHN0YXRlKQogIGNvbnN0IGxlbmd0aCA9IGwgPj4gMgogIGNvbnN0IGhlYWRlckJpdCA9IGwgJiAxCiAgY29uc3QgcGFydGlhbEJpdCA9IGwgJiAyCgogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IGxlbmd0aCkgcmV0dXJuIG51bGwKCiAgY29uc3QgZW5kID0gc3RhdGUuc3RhcnQgKyBsZW5ndGgKICBjb25zdCByZXN1bHQgPSB7IGhlYWRlcjogaGVhZGVyQml0LCBwYXJ0aWFsOiBwYXJ0aWFsQml0ICE9PSAwLCBieXRlTGVuZ3RoOiBsZW5ndGggKyA4LCBtZXNzYWdlOiBudWxsIH0KCiAgdHJ5IHsKICAgIHJlc3VsdC5tZXNzYWdlID0gbS5vcGxvZy5oZWFkZXIuZGVjb2RlKHsgc3RhcnQ6IHN0YXRlLnN0YXJ0LCBlbmQsIGJ1ZmZlcjogc3RhdGUuYnVmZmVyIH0pCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KCiAgc3RhdGUuc3RhcnQgPSBlbmQKICByZXR1cm4gcmVzdWx0Cn0KCmZ1bmN0aW9uIGRlY29kZU9wbG9nRW50cnkgKHN0YXRlKSB7CiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgOCkgcmV0dXJuIG51bGwKCiAgYy51aW50MzIuZGVjb2RlKHN0YXRlKSAvLyBja3N1bSwgaWdub3JlIGZvciBub3cKCiAgY29uc3QgbCA9IGMudWludDMyLmRlY29kZShzdGF0ZSkKICBjb25zdCBsZW5ndGggPSBsID4+PiAyCiAgY29uc3QgaGVhZGVyQml0ID0gbCAmIDEKICBjb25zdCBwYXJ0aWFsQml0ID0gbCAmIDIKCiAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgbGVuZ3RoKSByZXR1cm4gbnVsbAoKICBjb25zdCBlbmQgPSBzdGF0ZS5zdGFydCArIGxlbmd0aAoKICBjb25zdCByZXN1bHQgPSB7IGhlYWRlcjogaGVhZGVyQml0LCBwYXJ0aWFsOiBwYXJ0aWFsQml0ICE9PSAwLCBieXRlTGVuZ3RoOiBsZW5ndGggKyA4LCBtZXNzYWdlOiBudWxsIH0KCiAgdHJ5IHsKICAgIHJlc3VsdC5tZXNzYWdlID0gbS5vcGxvZy5lbnRyeS5kZWNvZGUoeyBzdGFydDogc3RhdGUuc3RhcnQsIGVuZCwgYnVmZmVyOiBzdGF0ZS5idWZmZXIgfSkKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQoKICBzdGF0ZS5zdGFydCA9IGVuZAoKICByZXR1cm4gcmVzdWx0Cn0KCm1vZHVsZS5leHBvcnRzID0geyBzdG9yZSwgY29yZSB9Cgphc3luYyBmdW5jdGlvbiBzdG9yZSAoc3RvcmFnZSwgeyB2ZXJzaW9uLCBkcnlSdW4gPSB0cnVlLCBnYyA9IHRydWUgfSkgewogIGNvbnN0IHN0cmVhbSA9IG5ldyBDb3JlTGlzdFN0cmVhbShzdG9yYWdlLnBhdGgpCiAgY29uc3QgdmlldyA9IG5ldyBWaWV3KCkKCiAgY29uc3QgdHggPSBuZXcgQ29yZXN0b3JlVFgodmlldykKICBjb25zdCBoZWFkID0gYXdhaXQgc3RvcmFnZS5fZ2V0SGVhZCh2aWV3KQogIGNvbnN0IHByaW1hcnlLZXlGaWxlID0gcGF0aC5qb2luKHN0b3JhZ2UucGF0aCwgJ3ByaW1hcnkta2V5JykKCiAgY29uc3QgcHJpbWFyeUtleSA9IGF3YWl0IHJlYWRGaWxlKHByaW1hcnlLZXlGaWxlKQoKICBpZiAoIWhlYWQuc2VlZCkgaGVhZC5zZWVkID0gcHJpbWFyeUtleQoKICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2Ygc3RyZWFtKSB7CiAgICBjb25zdCBrZXkgPSBkYXRhLmhlYWRlci5rZXkKICAgIGNvbnN0IGRpc2NvdmVyeUtleSA9IGNyeXB0by5kaXNjb3ZlcnlLZXkoZGF0YS5oZWFkZXIua2V5KQogICAgY29uc3QgZmlsZXMgPSBnZXRGaWxlcyhkYXRhLnBhdGgpCgogICAgaWYgKGhlYWQuZGVmYXVsdERpc2NvdmVyeUtleSA9PT0gbnVsbCkgaGVhZC5kZWZhdWx0RGlzY292ZXJ5S2V5ID0gZGlzY292ZXJ5S2V5CgogICAgY29uc3QgY29yZSA9IHsKICAgICAgdmVyc2lvbjogMCwgLy8gbmVlZCBsYXRlciBtaWdyYXRpb24KICAgICAgY29yZVBvaW50ZXI6IGhlYWQuYWxsb2NhdGVkLmNvcmVzKyssCiAgICAgIGRhdGFQb2ludGVyOiBoZWFkLmFsbG9jYXRlZC5kYXRhcysrLAogICAgICBhbGlhczogbnVsbAogICAgfQoKICAgIGNvbnN0IHB0ciA9IHsgdmVyc2lvbjogMCwgY29yZVBvaW50ZXI6IGNvcmUuY29yZVBvaW50ZXIsIGRhdGFQb2ludGVyOiBjb3JlLmRhdGFQb2ludGVyLCBkZXBlbmRlbmNpZXM6IFtdIH0KICAgIGNvbnN0IGN0eCA9IG5ldyBDb3JlVFgocHRyLCBzdG9yYWdlLmRiLCB2aWV3LCBbXSkKICAgIGNvbnN0IHVzZXJEYXRhID0gbmV3IE1hcCgpCiAgICBjb25zdCB0cmVlTm9kZXMgPSBuZXcgTWFwKCkKCiAgICBjb25zdCBhdXRoID0gewogICAgICBrZXksCiAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgbWFuaWZlc3Q6IGRhdGEuaGVhZGVyLm1hbmlmZXN0LAogICAgICBrZXlQYWlyOiBkYXRhLmhlYWRlci5rZXlQYWlyLAogICAgICBlbmNyeXB0aW9uS2V5OiBudWxsCiAgICB9CgogICAgY29uc3QgdHJlZSA9IHsKICAgICAgbGVuZ3RoOiAwLAogICAgICBmb3JrOiAwLAogICAgICByb290SGFzaDogbnVsbCwKICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICB9CgogICAgaWYgKGRhdGEuaGVhZGVyLnRyZWUgJiYgZGF0YS5oZWFkZXIudHJlZS5sZW5ndGgpIHsKICAgICAgdHJlZS5sZW5ndGggPSBkYXRhLmhlYWRlci50cmVlLmxlbmd0aAogICAgICB0cmVlLmZvcmsgPSBkYXRhLmhlYWRlci50cmVlLmZvcmsKICAgICAgdHJlZS5yb290SGFzaCA9IGRhdGEuaGVhZGVyLnRyZWUucm9vdEhhc2gKICAgICAgdHJlZS5zaWduYXR1cmUgPSBkYXRhLmhlYWRlci50cmVlLnNpZ25hdHVyZQogICAgfQoKICAgIGZvciAoY29uc3QgeyBrZXksIHZhbHVlIH0gb2YgZGF0YS5oZWFkZXIudXNlckRhdGEpIHsKICAgICAgdXNlckRhdGEuc2V0KGtleSwgdmFsdWUpCiAgICB9CgogICAgZm9yIChjb25zdCBlIG9mIGRhdGEuZW50cmllcykgewogICAgICBpZiAoZS51c2VyRGF0YSkgdXNlckRhdGEuc2V0KGUudXNlckRhdGEua2V5LCBlLnVzZXJEYXRhLnZhbHVlKQoKICAgICAgaWYgKGUudHJlZU5vZGVzKSB7CiAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIGUudHJlZU5vZGVzKSB7CiAgICAgICAgICB0cmVlTm9kZXMuc2V0KG5vZGUuaW5kZXgsIG5vZGUpCiAgICAgICAgICBjdHgucHV0VHJlZU5vZGUobm9kZSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChlLnRyZWVVcGdyYWRlKSB7CiAgICAgICAgaWYgKGUudHJlZVVwZ3JhZGUuYW5jZXN0b3JzICE9PSB0cmVlLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmZsdXNoZWQgdHJ1bmNhdGlvbnMgbm90IG1pZ3JhdGUtYWJsZSBhdG0nKQogICAgICAgIH0KCiAgICAgICAgdHJlZS5sZW5ndGggPSBlLnRyZWVVcGdyYWRlLmxlbmd0aAogICAgICAgIHRyZWUuZm9yayA9IGUudHJlZVVwZ3JhZGUuZm9yawogICAgICAgIHRyZWUucm9vdEhhc2ggPSBudWxsCiAgICAgICAgdHJlZS5zaWduYXR1cmUgPSBlLnRyZWVVcGdyYWRlLnNpZ25hdHVyZQogICAgICB9CiAgICB9CgogICAgaWYgKHVzZXJEYXRhLmhhcygnY29yZXN0b3JlL25hbWUnKSAmJiB1c2VyRGF0YS5oYXMoJ2NvcmVzdG9yZS9uYW1lc3BhY2UnKSkgewogICAgICBjb3JlLmFsaWFzID0gewogICAgICAgIG5hbWU6IGI0YS50b1N0cmluZyh1c2VyRGF0YS5nZXQoJ2NvcmVzdG9yZS9uYW1lJykpLAogICAgICAgIG5hbWVzcGFjZTogdXNlckRhdGEuZ2V0KCdjb3Jlc3RvcmUvbmFtZXNwYWNlJykKICAgICAgfQogICAgICB1c2VyRGF0YS5kZWxldGUoJ2NvcmVzdG9yZS9uYW1lJykKICAgICAgdXNlckRhdGEuZGVsZXRlKCdjb3Jlc3RvcmUvbmFtZXNwYWNlJykKICAgIH0KCiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB1c2VyRGF0YSkgewogICAgICBjdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICAgIH0KCiAgICBjdHguc2V0QXV0aChhdXRoKQoKICAgIGNvbnN0IGdldFRyZWVOb2RlID0gKGluZGV4KSA9PiAodHJlZU5vZGVzLmdldChpbmRleCkgfHwgZ2V0VHJlZU5vZGVGcm9tRmlsZShmaWxlcy50cmVlLCBpbmRleCkpCgogICAgaWYgKHRyZWUubGVuZ3RoKSB7CiAgICAgIGlmICh0cmVlLnJvb3RIYXNoID09PSBudWxsKSB0cmVlLnJvb3RIYXNoID0gY3J5cHRvLnRyZWUoYXdhaXQgZ2V0Um9vdHModHJlZS5sZW5ndGgsIGdldFRyZWVOb2RlKSkKICAgICAgY3R4LnNldEhlYWQodHJlZSkKICAgIH0KCiAgICB0eC5wdXRDb3JlKGRpc2NvdmVyeUtleSwgY29yZSkKICAgIGlmIChjb3JlLmFsaWFzKSB0eC5wdXRDb3JlQnlBbGlhcyhjb3JlLmFsaWFzLCBkaXNjb3ZlcnlLZXkpCgogICAgYXdhaXQgY3R4LmZsdXNoKCkKICB9CgogIGhlYWQudmVyc2lvbiA9IHZlcnNpb24KICB0eC5zZXRIZWFkKGhlYWQpCiAgdHguYXBwbHkoKQoKICBpZiAoZHJ5UnVuKSByZXR1cm4KCiAgYXdhaXQgVmlldy5mbHVzaCh2aWV3LmNoYW5nZXMsIHN0b3JhZ2UuZGIpCgogIGlmIChnYykgYXdhaXQgcm0ocHJpbWFyeUtleUZpbGUpCn0KCmNsYXNzIEJsb2NrU2xpY2VyIHsKICBjb25zdHJ1Y3RvciAoZmlsZW5hbWUpIHsKICAgIHRoaXMuc3RyZWFtID0gZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlbmFtZSkKICAgIHRoaXMuY2xvc2VkID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB0aGlzLnN0cmVhbS5vbmNlKCdjbG9zZScsIHJlc29sdmUpKQogICAgdGhpcy5vZmZzZXQgPSAwCiAgICB0aGlzLm92ZXJmbG93ID0gbnVsbAogIH0KCiAgYXN5bmMgdGFrZSAob2Zmc2V0LCBzaXplKSB7CiAgICBsZXQgYnVmZmVyID0gbnVsbAogICAgaWYgKG9mZnNldCA8IHRoaXMub2Zmc2V0KSB0aHJvdyBuZXcgRXJyb3IoJ292ZXJyZWFkJykKCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBsZXQgZGF0YSA9IG51bGwKCiAgICAgIGlmICh0aGlzLm92ZXJmbG93KSB7CiAgICAgICAgZGF0YSA9IHRoaXMub3ZlcmZsb3cKICAgICAgICB0aGlzLm92ZXJmbG93ID0gbnVsbAogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSB0aGlzLnN0cmVhbS5yZWFkKCkKCiAgICAgICAgaWYgKCFkYXRhKSB7CiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHRoaXMuc3RyZWFtLm9uY2UoJ3JlYWRhYmxlJywgcmVzb2x2ZSkpCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQoKICAgICAgbGV0IGNodW5rID0gbnVsbAoKICAgICAgaWYgKHRoaXMub2Zmc2V0ID09PSBvZmZzZXQgfHwgYnVmZmVyKSB7CiAgICAgICAgY2h1bmsgPSBkYXRhCiAgICAgIH0gZWxzZSBpZiAodGhpcy5vZmZzZXQgKyBkYXRhLmJ5dGVMZW5ndGggPiBvZmZzZXQpIHsKICAgICAgICBjaHVuayA9IGRhdGEuc3ViYXJyYXkob2Zmc2V0IC0gdGhpcy5vZmZzZXQpCiAgICAgIH0KCiAgICAgIHRoaXMub2Zmc2V0ICs9IGRhdGEuYnl0ZUxlbmd0aAogICAgICBpZiAoIWNodW5rKSBjb250aW51ZQoKICAgICAgaWYgKGJ1ZmZlcikgYnVmZmVyID0gYjRhLmNvbmNhdChbYnVmZmVyLCBjaHVua10pCiAgICAgIGVsc2UgYnVmZmVyID0gY2h1bmsKCiAgICAgIGlmIChidWZmZXIuYnl0ZUxlbmd0aCA8IHNpemUpIGNvbnRpbnVlCgogICAgICBjb25zdCByZXN1bHQgPSBidWZmZXIuc3ViYXJyYXkoMCwgc2l6ZSkKICAgICAgdGhpcy5vdmVyZmxvdyA9IHNpemUgPT09IGJ1ZmZlci5ieXRlTGVuZ3RoID8gbnVsbCA6IGJ1ZmZlci5zdWJhcnJheShyZXN1bHQuYnl0ZUxlbmd0aCkKICAgICAgdGhpcy5vZmZzZXQgLT0gKHRoaXMub3ZlcmZsb3cgPyB0aGlzLm92ZXJmbG93LmJ5dGVMZW5ndGggOiAwKQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9CiAgfQoKICBjbG9zZSAoKSB7CiAgICB0aGlzLnN0cmVhbS5vbignZXJyb3InLCBub29wKQogICAgdGhpcy5zdHJlYW0uZGVzdHJveSgpCiAgICByZXR1cm4gdGhpcy5jbG9zZWQKICB9Cn0KCmNsYXNzIFRyZWVTbGljZXIgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMuYnVmZmVyID0gbnVsbAogICAgdGhpcy5vZmZzZXQgPSAwCiAgfQoKICBnZXQgc2l6ZSAoKSB7CiAgICByZXR1cm4gdGhpcy5idWZmZXIgPT09IG51bGwgPyAwIDogdGhpcy5idWZmZXIuYnl0ZUxlbmd0aAogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgaWYgKHRoaXMuYnVmZmVyID09PSBudWxsKSB0aGlzLmJ1ZmZlciA9IGRhdGEKICAgIGVsc2UgdGhpcy5idWZmZXIgPSBiNGEuY29uY2F0KFt0aGlzLmJ1ZmZlciwgZGF0YV0pCiAgICB0aGlzLm9mZnNldCArPSBkYXRhLmJ5dGVMZW5ndGgKICB9CgogIHNraXAgKCkgewogICAgbGV0IHNraXBwZWQgPSAwCgogICAgaWYgKFRSRUVfMDFfU0tJUCA9PT0gbnVsbCkgewogICAgICBUUkVFXzE2X1NLSVAgPSBiNGEuYWxsb2MoMTYgKiA0MCAqIDEwMCkKICAgICAgVFJFRV8wNF9TS0lQID0gVFJFRV8xNl9TS0lQLnN1YmFycmF5KDAsIDQgKiA0MCAqIDEwMCkKICAgICAgVFJFRV8wMV9TS0lQID0gVFJFRV8xNl9TS0lQLnN1YmFycmF5KDAsIDEgKiA0MCAqIDEwMCkKICAgIH0KCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAodGhpcy5idWZmZXIuYnl0ZUxlbmd0aCA+PSBUUkVFXzE2X1NLSVAuYnl0ZUxlbmd0aCkgewogICAgICAgIGlmIChiNGEuZXF1YWxzKHRoaXMuYnVmZmVyLnN1YmFycmF5KDAsIFRSRUVfMTZfU0tJUC5ieXRlTGVuZ3RoKSwgVFJFRV8xNl9TS0lQKSkgewogICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheShUUkVFXzE2X1NLSVAuYnl0ZUxlbmd0aCkKICAgICAgICAgIHNraXBwZWQgKz0gMTYwMAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoID49IFRSRUVfMDRfU0tJUC5ieXRlTGVuZ3RoKSB7CiAgICAgICAgaWYgKGI0YS5lcXVhbHModGhpcy5idWZmZXIuc3ViYXJyYXkoMCwgVFJFRV8wNF9TS0lQLmJ5dGVMZW5ndGgpLCBUUkVFXzA0X1NLSVApKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnN1YmFycmF5KFRSRUVfMDRfU0tJUC5ieXRlTGVuZ3RoKQogICAgICAgICAgc2tpcHBlZCArPSA0MDAKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5idWZmZXIuYnl0ZUxlbmd0aCA+PSBUUkVFXzAxX1NLSVAuYnl0ZUxlbmd0aCkgewogICAgICAgIGlmIChiNGEuZXF1YWxzKHRoaXMuYnVmZmVyLnN1YmFycmF5KDAsIFRSRUVfMDFfU0tJUC5ieXRlTGVuZ3RoKSwgVFJFRV8wMV9TS0lQKSkgewogICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheShUUkVFXzAxX1NLSVAuYnl0ZUxlbmd0aCkKICAgICAgICAgIHNraXBwZWQgKz0gMTAwCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAgICAgfQogICAgICBicmVhawogICAgfQoKICAgIHJldHVybiBza2lwcGVkCiAgfQoKICB0YWtlICgpIHsKICAgIGNvbnN0IGxlbiA9IDQwCgogICAgaWYgKGxlbiA8PSB0aGlzLnNpemUpIHsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLmJ1ZmZlci5zdWJhcnJheSgwLCBsZW4pCiAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc3ViYXJyYXkobGVuKQogICAgICByZXR1cm4gY2h1bmsKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gY29yZSAoY29yZSwgeyB2ZXJzaW9uLCBkcnlSdW4gPSB0cnVlLCBnYyA9IHRydWUgfSkgewogIGlmIChkcnlSdW4pIHJldHVybiAvLyBkcnlSdW4gbW9kZSBub3Qgc3VwcG9ydGVkIGF0bQoKICBjb25zdCByeCA9IGNvcmUucmVhZCgpCgogIGNvbnN0IHByb21pc2VzID0gW3J4LmdldEF1dGgoKSwgcnguZ2V0SGVhZCgpXQogIHJ4LnRyeUZsdXNoKCkKCiAgY29uc3QgW2F1dGgsIGhlYWRdID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCgogIGlmICghYXV0aCkgcmV0dXJuCgogIGNvbnN0IGRrID0gYjRhLnRvU3RyaW5nKGF1dGguZGlzY292ZXJ5S2V5LCAnaGV4JykKICBjb25zdCBmaWxlcyA9IGdldEZpbGVzKHBhdGguam9pbihjb3JlLnN0b3JlLnBhdGgsICdjb3JlcycsIGRrLnNsaWNlKDAsIDIpLCBkay5zbGljZSgyLCA0KSwgZGspKQoKICBpZiAoaGVhZCA9PT0gbnVsbCB8fCBoZWFkLmxlbmd0aCA9PT0gMCkgewogICAgYXdhaXQgY29tbWl0Q29yZU1pZ3JhdGlvbihhdXRoLCBjb3JlLCB2ZXJzaW9uKQogICAgaWYgKGdjKSBhd2FpdCBydW5HQygpCiAgICByZXR1cm4gLy8gbm8gZGF0YQogIH0KCiAgY29uc3Qgb3Bsb2cgPSBhd2FpdCByZWFkT3Bsb2coZmlsZXMub3Bsb2cpCiAgaWYgKCFvcGxvZykgewogICAgY29uc3Qgd3JpdGFibGUgPSAhIWF1dGgua2V5UGFpcgoKICAgIGlmICh3cml0YWJsZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIG9wbG9nIGF2YWlsYWJsZSB3cml0YWJsZSBjb3JlIGZvciAnICsgZmlsZXMub3Bsb2cgKyAnLCBsZW5ndGggPSAnICsgKGhlYWQgPyBoZWFkLmxlbmd0aCA6IDApKQogICAgfQoKICAgIC8vIGlmIG5vdCB3cml0YWJsZSwganVzdCBudWtlIGl0IHRvIHJlY292ZXIsIHNvbWUgYmFkIHN0YXRlIGhhcHBlbmVkIGhlcmUsIHByb3AgY29ycnVwdGlvbiBmcm9tIGVhcmxpZXIgdmVyc2lvbnMKICAgIGNvbnN0IHcgPSBjb3JlLndyaXRlKCkKCiAgICB3LmRlbGV0ZUJsb2NrUmFuZ2UoMCwgLTEpCiAgICB3LmRlbGV0ZVRyZWVOb2RlUmFuZ2UoMCwgLTEpCiAgICB3LmRlbGV0ZUJpdGZpZWxkUGFnZVJhbmdlKDAsIC0xKQogICAgdy5kZWxldGVIZWFkKCkKCiAgICBhd2FpdCB3LmZsdXNoKCkKCiAgICBhd2FpdCBjb21taXRDb3JlTWlncmF0aW9uKGF1dGgsIGNvcmUsIHZlcnNpb24pCiAgICBpZiAoZ2MpIGF3YWl0IHJ1bkdDKCkKICAgIHJldHVybiAvLyBubyBkYXRhCiAgfQoKICBjb25zdCB0cmVlRGF0YSA9IG5ldyBUcmVlU2xpY2VyKCkKCiAgbGV0IHRyZWVJbmRleCA9IDAKCiAgaWYgKGF3YWl0IGV4aXN0cyhmaWxlcy50cmVlKSkgewogICAgZm9yIGF3YWl0IChjb25zdCBkYXRhIG9mIGZzLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZXMudHJlZSkpIHsKICAgICAgdHJlZURhdGEucHVzaChkYXRhKQoKICAgICAgbGV0IHdyaXRlID0gbnVsbAoKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBjb25zdCBza2lwID0gdHJlZURhdGEuc2tpcCgpCiAgICAgICAgdHJlZUluZGV4ICs9IHNraXAKCiAgICAgICAgY29uc3QgYnVmID0gdHJlZURhdGEudGFrZSgpCiAgICAgICAgaWYgKGJ1ZiA9PT0gbnVsbCkgYnJlYWsKCiAgICAgICAgY29uc3QgaW5kZXggPSB0cmVlSW5kZXgrKwogICAgICAgIGlmIChiNGEuZXF1YWxzKGJ1ZiwgRU1QVFlfTk9ERSkpIGNvbnRpbnVlCgogICAgICAgIGlmICh3cml0ZSA9PT0gbnVsbCkgd3JpdGUgPSBjb3JlLndyaXRlKCkKICAgICAgICB3cml0ZS5wdXRUcmVlTm9kZShkZWNvZGVUcmVlTm9kZShpbmRleCwgYnVmKSkKICAgICAgfQoKICAgICAgaWYgKHdyaXRlICE9PSBudWxsKSBhd2FpdCB3cml0ZS5mbHVzaCgpCiAgICB9CiAgfQoKICBjb25zdCBidWYgPSBbXQogIGlmIChhd2FpdCBleGlzdHMoZmlsZXMuYml0ZmllbGQpKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlcy5iaXRmaWVsZCkpIHsKICAgICAgYnVmLnB1c2goZGF0YSkKICAgIH0KICB9CgogIGxldCBiaXRmaWVsZCA9IGI0YS5jb25jYXQoYnVmKQogIGlmIChiaXRmaWVsZC5ieXRlTGVuZ3RoICYgNDA5NSkgYml0ZmllbGQgPSBiNGEuY29uY2F0KFtiaXRmaWVsZCwgYjRhLmFsbG9jKDQwOTYgLSAoYml0ZmllbGQuYnl0ZUxlbmd0aCAmIDQwOTUpKV0pCgogIGNvbnN0IHBhZ2VzID0gbmV3IE1hcCgpCiAgY29uc3QgaGVhZGVyQml0cyA9IG5ldyBNYXAoKQoKICBjb25zdCByb290cyA9IGF3YWl0IGdldFJvb3RzRnJvbVN0b3JhZ2UoY29yZSwgaGVhZC5sZW5ndGgpCgogIGZvciAoY29uc3QgZSBvZiBvcGxvZy5lbnRyaWVzKSB7CiAgICBpZiAoIWUuYml0ZmllbGQpIGNvbnRpbnVlCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlLmJpdGZpZWxkLmxlbmd0aDsgaSsrKSB7CiAgICAgIGhlYWRlckJpdHMuc2V0KGkgKyBlLmJpdGZpZWxkLnN0YXJ0LCAhZS5iaXRmaWVsZC5kcm9wKQogICAgfQogIH0KCiAgbGV0IGJhdGNoID0gW10KCiAgY29uc3QgY2FjaGUgPSBuZXcgTWFwKCkKICBjb25zdCBibG9ja3MgPSBuZXcgQmxvY2tTbGljZXIoZmlsZXMuZGF0YSkKCiAgZm9yIChjb25zdCBpbmRleCBvZiBhbGxCaXRzKGJpdGZpZWxkKSkgewogICAgaWYgKGhlYWRlckJpdHMuZ2V0KGluZGV4KSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICBpZiAoaW5kZXggPj0gaGVhZC5sZW5ndGgpIGNvbnRpbnVlCgogICAgc2V0Qml0SW5QYWdlKGluZGV4KQoKICAgIGJhdGNoLnB1c2goaW5kZXgpCiAgICBpZiAoYmF0Y2gubGVuZ3RoIDwgMTAyNCkgY29udGludWUKCiAgICBhd2FpdCB3cml0ZUJsb2Nrc0JhdGNoKCkKICAgIGNvbnRpbnVlCiAgfQoKICBpZiAoYmF0Y2gubGVuZ3RoKSBhd2FpdCB3cml0ZUJsb2Nrc0JhdGNoKCkKCiAgYXdhaXQgYmxvY2tzLmNsb3NlKCkKCiAgY29uc3QgdyA9IGNvcmUud3JpdGUoKQoKICBmb3IgKGNvbnN0IFtpbmRleCwgYml0XSBvZiBoZWFkZXJCaXRzKSB7CiAgICBpZiAoIWJpdCkgY29udGludWUKICAgIGlmIChpbmRleCA+PSBoZWFkLmxlbmd0aCkgY29udGludWUKCiAgICBzZXRCaXRJblBhZ2UoaW5kZXgpCgogICAgY29uc3QgYmxrID0gYXdhaXQgZ2V0QmxvY2tGcm9tRmlsZShmaWxlcy5kYXRhLCBjb3JlLCBpbmRleCwgcm9vdHMsIGNhY2hlKQogICAgdy5wdXRCbG9jayhpbmRleCwgYmxrKQogIH0KCiAgZm9yIChjb25zdCBbaW5kZXgsIHBhZ2VdIG9mIHBhZ2VzKSB7CiAgICB3LnB1dEJpdGZpZWxkUGFnZShpbmRleCwgYjRhLmZyb20ocGFnZS5idWZmZXIsIHBhZ2UuYnl0ZU9mZnNldCwgcGFnZS5ieXRlTGVuZ3RoKSkKICB9CgogIGF3YWl0IHcuZmx1c2goKQoKICBsZXQgY29udGlndW91c0xlbmd0aCA9IDAKICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgY29yZS5jcmVhdGVCbG9ja1N0cmVhbSgpKSB7CiAgICBpZiAoZGF0YS5pbmRleCA9PT0gY29udGlndW91c0xlbmd0aCkgY29udGlndW91c0xlbmd0aCsrCiAgICBlbHNlIGJyZWFrCiAgfQoKICBpZiAoY29udGlndW91c0xlbmd0aCkgewogICAgY29uc3QgdyA9IGNvcmUud3JpdGUoKQogICAgdy5zZXRIaW50cyh7IGNvbnRpZ3VvdXNMZW5ndGggfSkKICAgIGF3YWl0IHcuZmx1c2goKQogIH0KCiAgYXdhaXQgY29tbWl0Q29yZU1pZ3JhdGlvbihhdXRoLCBjb3JlLCB2ZXJzaW9uKQoKICBpZiAoZ2MpIGF3YWl0IHJ1bkdDKCkKCiAgYXN5bmMgZnVuY3Rpb24gcnVuR0MgKCkgewogICAgYXdhaXQgcm0oZmlsZXMucGF0aCkKICAgIGF3YWl0IHJtZGlyKHBhdGguam9pbihmaWxlcy5wYXRoLCAnLi4nKSkKICAgIGF3YWl0IHJtZGlyKHBhdGguam9pbihmaWxlcy5wYXRoLCAnLi4vLi4nKSkKICAgIGF3YWl0IHJtZGlyKHBhdGguam9pbihjb3JlLnN0b3JlLnBhdGgsICdjb3JlcycpKQogIH0KCiAgZnVuY3Rpb24gc2V0Qml0SW5QYWdlIChpbmRleCkgewogICAgY29uc3QgbiA9IGluZGV4ICYgMzI3NjcKICAgIGNvbnN0IHAgPSAoaW5kZXggLSBuKSAvIDMyNzY4CgogICAgbGV0IHBhZ2UgPSBwYWdlcy5nZXQocCkKCiAgICBpZiAoIXBhZ2UpIHsKICAgICAgcGFnZSA9IG5ldyBVaW50MzJBcnJheSgxMDI0KQogICAgICBwYWdlcy5zZXQocCwgcGFnZSkKICAgIH0KCiAgICBjb25zdCBvID0gbiAmIDMxCiAgICBjb25zdCBiID0gKG4gLSBvKSAvIDMyCiAgICBjb25zdCB2ID0gMSA8PCBvCgogICAgcGFnZVtiXSB8PSB2CiAgfQoKICBhc3luYyBmdW5jdGlvbiB3cml0ZUJsb2Nrc0JhdGNoICgpIHsKICAgIGNvbnN0IHJlYWQgPSBjb3JlLnJlYWQoKQogICAgY29uc3QgcHJvbWlzZXMgPSBbXQogICAgZm9yIChjb25zdCBpbmRleCBvZiBiYXRjaCkgcHJvbWlzZXMucHVzaChnZXRCeXRlUmFuZ2VGcm9tU3RvcmFnZShyZWFkLCAyICogaW5kZXgsIHJvb3RzLCBjYWNoZSkpCiAgICByZWFkLnRyeUZsdXNoKCkKCiAgICBjb25zdCByID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgICBjb25zdCB0eCA9IGNvcmUud3JpdGUoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgci5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBpbmRleCA9IGJhdGNoW2ldCiAgICAgIGNvbnN0IFtvZmZzZXQsIHNpemVdID0gcltpXQoKICAgICAgY29uc3QgYmxrID0gYXdhaXQgYmxvY2tzLnRha2Uob2Zmc2V0LCBzaXplKQogICAgICB0eC5wdXRCbG9jayhpbmRleCwgYmxrKQogICAgfQoKICAgIGJhdGNoID0gW10KICAgIGlmIChjYWNoZS5zaXplID4gMTYzODQpIGNhY2hlLmNsZWFyKCkKCiAgICBhd2FpdCB0eC5mbHVzaCgpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjb21taXRDb3JlTWlncmF0aW9uIChhdXRoLCBjb3JlLCB2ZXJzaW9uKSB7CiAgY29uc3QgdmlldyA9IG5ldyBWaWV3KCkKICBjb25zdCByeCA9IG5ldyBDb3Jlc3RvcmVSWChjb3JlLmRiLCB2aWV3KQoKICBjb25zdCBzdG9yZUNvcmVQcm9taXNlID0gcnguZ2V0Q29yZShhdXRoLmRpc2NvdmVyeUtleSkKICByeC50cnlGbHVzaCgpCgogIGNvbnN0IHN0b3JlQ29yZSA9IGF3YWl0IHN0b3JlQ29yZVByb21pc2UKCiAgc3RvcmVDb3JlLnZlcnNpb24gPSB2ZXJzaW9uCgogIGNvbnN0IHR4ID0gbmV3IENvcmVzdG9yZVRYKHZpZXcpCgogIHR4LnB1dENvcmUoYXV0aC5kaXNjb3ZlcnlLZXksIHN0b3JlQ29yZSkKICB0eC5hcHBseSgpCgogIGF3YWl0IFZpZXcuZmx1c2godmlldy5jaGFuZ2VzLCBjb3JlLmRiKQp9Cgphc3luYyBmdW5jdGlvbiBnZXRCbG9ja0Zyb21GaWxlIChmaWxlLCBjb3JlLCBpbmRleCwgcm9vdHMsIGNhY2hlKSB7CiAgY29uc3QgcnggPSBjb3JlLnJlYWQoKQogIGNvbnN0IHByb21pc2UgPSBnZXRCeXRlUmFuZ2VGcm9tU3RvcmFnZShyeCwgMiAqIGluZGV4LCByb290cywgY2FjaGUpCiAgcngudHJ5Rmx1c2goKQogIGNvbnN0IFtvZmZzZXQsIHNpemVdID0gYXdhaXQgcHJvbWlzZQoKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIHJlYWRBbGwoZmlsZSwgc2l6ZSwgb2Zmc2V0LCBmdW5jdGlvbiAoZXJyLCBidWYpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlc29sdmUobnVsbCkKICAgICAgcmVzb2x2ZShidWYpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIGdldEZpbGVzIChkaXIpIHsKICByZXR1cm4gewogICAgcGF0aDogZGlyLAogICAgb3Bsb2c6IHBhdGguam9pbihkaXIsICdvcGxvZycpLAogICAgZGF0YTogcGF0aC5qb2luKGRpciwgJ2RhdGEnKSwKICAgIHRyZWU6IHBhdGguam9pbihkaXIsICd0cmVlJyksCiAgICBiaXRmaWVsZDogcGF0aC5qb2luKGRpciwgJ2JpdGZpZWxkJykKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGdldFJvb3RzRnJvbVN0b3JhZ2UgKGNvcmUsIGxlbmd0aCkgewogIGNvbnN0IGFsbCA9IFtdCiAgY29uc3QgcnggPSBjb3JlLnJlYWQoKQogIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5mdWxsUm9vdHMoMiAqIGxlbmd0aCkpIHsKICAgIGFsbC5wdXNoKHJ4LmdldFRyZWVOb2RlKGluZGV4KSkKICB9CiAgcngudHJ5Rmx1c2goKQogIHJldHVybiBQcm9taXNlLmFsbChhbGwpCn0KCmFzeW5jIGZ1bmN0aW9uIGdldFJvb3RzIChsZW5ndGgsIGdldFRyZWVOb2RlKSB7CiAgY29uc3QgYWxsID0gW10KICBmb3IgKGNvbnN0IGluZGV4IG9mIGZsYXQuZnVsbFJvb3RzKDIgKiBsZW5ndGgpKSB7CiAgICBhbGwucHVzaChhd2FpdCBnZXRUcmVlTm9kZShpbmRleCkpCiAgfQogIHJldHVybiBhbGwKfQoKZnVuY3Rpb24gZ2V0Q2FjaGVkIChyZWFkLCBjYWNoZSwgaW5kZXgpIHsKICBpZiAoY2FjaGUuaGFzKGluZGV4KSkgcmV0dXJuIGNhY2hlLmdldChpbmRleCkKICBjb25zdCBwID0gcmVhZC5nZXRUcmVlTm9kZShpbmRleCkKICBjYWNoZS5zZXQoaW5kZXgsIHApCiAgcmV0dXJuIHAKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Qnl0ZVJhbmdlRnJvbVN0b3JhZ2UgKHJlYWQsIGluZGV4LCByb290cywgY2FjaGUpIHsKICBjb25zdCBwcm9taXNlcyA9IFtnZXRDYWNoZWQocmVhZCwgY2FjaGUsIGluZGV4KSwgZ2V0Qnl0ZU9mZnNldEZyb21TdG9yYWdlKHJlYWQsIGluZGV4LCByb290cywgY2FjaGUpXQogIGNvbnN0IFtub2RlLCBvZmZzZXRdID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgaWYgKCFub2RlKSB0aHJvdyBuZXcgRXJyb3IoJ05vZGUgbm90IGZvdW5kIGR1cmluZyBtaWdyYXRpb246ICcgKyBpbmRleCkKICByZXR1cm4gW29mZnNldCwgbm9kZS5zaXplXQp9Cgphc3luYyBmdW5jdGlvbiBnZXRCeXRlT2Zmc2V0RnJvbVN0b3JhZ2UgKHJ4LCBpbmRleCwgcm9vdHMsIGNhY2hlKSB7CiAgaWYgKGluZGV4ID09PSAwKSByZXR1cm4gMAogIGlmICgoaW5kZXggJiAxKSA9PT0gMSkgaW5kZXggPSBmbGF0LmxlZnRTcGFuKGluZGV4KQoKICBsZXQgaGVhZCA9IDAKICBsZXQgb2Zmc2V0ID0gMAoKICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsgLy8gYWxsIGFzeW5jIHRpY2tzIGhhcHBlbiBvbmNlIHdlIGZpbmQgdGhlIHJvb3Qgc28gc2FmZQogICAgaGVhZCArPSAyICogKChub2RlLmluZGV4IC0gaGVhZCkgKyAxKQoKICAgIGlmIChpbmRleCA+PSBoZWFkKSB7CiAgICAgIG9mZnNldCArPSBub2RlLnNpemUKICAgICAgY29udGludWUKICAgIH0KCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUuaW5kZXgpCiAgICBjb25zdCBwcm9taXNlcyA9IFtdCgogICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gaW5kZXgpIHsKICAgICAgaWYgKGluZGV4IDwgaXRlLmluZGV4KSB7CiAgICAgICAgaXRlLmxlZnRDaGlsZCgpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZXMucHVzaChnZXRDYWNoZWQocngsIGNhY2hlLCBpdGUubGVmdENoaWxkKCkpKQogICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgfQogICAgfQoKICAgIGNvbnN0IG5vZGVzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIG9mZnNldCArPSBub2RlLnNpemUKCiAgICByZXR1cm4gb2Zmc2V0CiAgfQoKICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmaW5kIG9mZnNldCcpCn0KCmZ1bmN0aW9uIGRlY29kZVRyZWVOb2RlIChpbmRleCwgYnVmKSB7CiAgcmV0dXJuIHsgaW5kZXgsIHNpemU6IGMuZGVjb2RlKGMudWludDY0LCBidWYpLCBoYXNoOiBidWYuc3ViYXJyYXkoOCkgfQp9Cgphc3luYyBmdW5jdGlvbiBnZXRUcmVlTm9kZUZyb21GaWxlIChmaWxlLCBpbmRleCkgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgcmVhZEFsbChmaWxlLCA0MCwgaW5kZXggKiA0MCwgZnVuY3Rpb24gKGVyciwgYnVmKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZXNvbHZlKG51bGwpCiAgICAgIHJlc29sdmUoZGVjb2RlVHJlZU5vZGUoaW5kZXgsIGJ1ZikpCiAgICB9KQogIH0pCn0KCmZ1bmN0aW9uIHJlYWRBbGwgKGZpbGVuYW1lLCBsZW5ndGgsIHBvcywgY2IpIHsKICBjb25zdCBidWYgPSBiNGEuYWxsb2MobGVuZ3RoKQoKICBmcy5vcGVuKGZpbGVuYW1lLCAncicsIGZ1bmN0aW9uIChlcnIsIGZkKSB7CiAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQoKICAgIGxldCBvZmZzZXQgPSAwCgogICAgZnMucmVhZChmZCwgYnVmLCBvZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoLCBwb3MsIGZ1bmN0aW9uIGxvb3AgKGVyciwgcmVhZCkgewogICAgICBpZiAoZXJyKSByZXR1cm4gZG9uZShlcnIpCiAgICAgIGlmIChyZWFkID09PSAwKSByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ1BhcnRpYWwgcmVhZCcpKQogICAgICBvZmZzZXQgKz0gcmVhZAogICAgICBpZiAob2Zmc2V0ID09PSBidWYuYnl0ZUxlbmd0aCkgcmV0dXJuIGRvbmUobnVsbCwgYnVmKQogICAgICBmcy5yZWFkKGZkLCBvZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoIC0gb2Zmc2V0LCBidWYsIHBvcyArIG9mZnNldCwgbG9vcCkKICAgIH0pCgogICAgZnVuY3Rpb24gZG9uZSAoZXJyLCB2YWx1ZSkgewogICAgICBmcy5jbG9zZShmZCwgKCkgPT4gY2IoZXJyLCB2YWx1ZSkpCiAgICB9CiAgfSkKfQoKYXN5bmMgZnVuY3Rpb24gcmVhZGRpciAoZGlyKSB7CiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBmcy5wcm9taXNlcy5yZWFkZGlyKGRpcikKICB9IGNhdGNoIHsKICAgIHJldHVybiBbXQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZXhpc3RzIChmaWxlKSB7CiAgdHJ5IHsKICAgIGF3YWl0IGZzLnByb21pc2VzLnN0YXQoZmlsZSkKICAgIHJldHVybiB0cnVlCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRGaWxlIChmaWxlKSB7CiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmaWxlKQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJtIChkaXIpIHsKICB0cnkgewogICAgYXdhaXQgZnMucHJvbWlzZXMucm0oZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KQogIH0gY2F0Y2gge30KfQoKYXN5bmMgZnVuY3Rpb24gcm1kaXIgKGRpcikgewogIHRyeSB7CiAgICBhd2FpdCBmcy5wcm9taXNlcy5ybWRpcihkaXIpCiAgfSBjYXRjaCB7fQp9CgpmdW5jdGlvbiAqIGFsbEJpdHMgKGJ1ZmZlcikgewogIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyLmJ5dGVMZW5ndGg7IGkgKz0gRU1QVFlfUEFHRS5ieXRlTGVuZ3RoKSB7CiAgICBjb25zdCBwYWdlID0gYnVmZmVyLnN1YmFycmF5KGksIGkgKyBFTVBUWV9OT0RFLmJ5dGVMZW5ndGgpCiAgICBpZiAoYjRhLmVxdWFscyhwYWdlLCBFTVBUWV9QQUdFKSkgY29udGludWUKCiAgICBjb25zdCB2aWV3ID0gbmV3IFVpbnQzMkFycmF5KHBhZ2UuYnVmZmVyLCBwYWdlLmJ5dGVPZmZzZXQsIEVNUFRZX1BBR0UuYnl0ZUxlbmd0aCAvIDQpCgogICAgZm9yIChsZXQgaiA9IDA7IGogPCB2aWV3Lmxlbmd0aDsgaisrKSB7CiAgICAgIGNvbnN0IG4gPSB2aWV3W2pdCiAgICAgIGlmIChuID09PSAwKSBjb250aW51ZQoKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCAzMjsgaysrKSB7CiAgICAgICAgY29uc3QgbSA9IDEgPDwgawogICAgICAgIGlmIChuICYgbSkgeWllbGQgaSAqIDggKyBqICogMzIgKyBrCiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHJlYWRPcGxvZyAob3Bsb2cpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIGZzLnJlYWRGaWxlKG9wbG9nLCBmdW5jdGlvbiAoZXJyLCBidWZmZXIpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlc29sdmUobnVsbCkKCiAgICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KICAgICAgY29uc3QgaGVhZGVycyA9IFsxLCAwXQoKICAgICAgY29uc3QgaDEgPSBkZWNvZGVPcGxvZ0hlYWRlcihzdGF0ZSkKICAgICAgc3RhdGUuc3RhcnQgPSA0MDk2CgogICAgICBjb25zdCBoMiA9IGRlY29kZU9wbG9nSGVhZGVyKHN0YXRlKQogICAgICBzdGF0ZS5zdGFydCA9IDQwOTYgKiAyCgogICAgICBpZiAoIWgxICYmICFoMikgcmV0dXJuIHJlc29sdmUobnVsbCkKCiAgICAgIGlmIChoMSAmJiAhaDIpIHsKICAgICAgICBoZWFkZXJzWzBdID0gaDEuaGVhZGVyCiAgICAgICAgaGVhZGVyc1sxXSA9IGgxLmhlYWRlcgogICAgICB9IGVsc2UgaWYgKCFoMSAmJiBoMikgewogICAgICAgIGhlYWRlcnNbMF0gPSAoaDIuaGVhZGVyICsgMSkgJiAxCiAgICAgICAgaGVhZGVyc1sxXSA9IGgyLmhlYWRlcgogICAgICB9IGVsc2UgewogICAgICAgIGhlYWRlcnNbMF0gPSBoMS5oZWFkZXIKICAgICAgICBoZWFkZXJzWzFdID0gaDIuaGVhZGVyCiAgICAgIH0KCiAgICAgIGNvbnN0IGhlYWRlciA9IChoZWFkZXJzWzBdICsgaGVhZGVyc1sxXSkgJiAxCiAgICAgIGNvbnN0IHJlc3VsdCA9IHsgcGF0aDogcGF0aC5kaXJuYW1lKG9wbG9nKSwgaGVhZGVyOiBudWxsLCBlbnRyaWVzOiBbXSB9CiAgICAgIGNvbnN0IGRlY29kZWQgPSBbXQoKICAgICAgcmVzdWx0LmhlYWRlciA9IGhlYWRlciA/IGgyLm1lc3NhZ2UgOiBoMS5tZXNzYWdlCgogICAgICBpZiAocmVzdWx0LmhlYWRlci5leHRlcm5hbCkgewogICAgICAgIGZzLnJlYWRGaWxlKHBhdGguam9pbihvcGxvZywgJy4uL2hlYWRlcicpLCBmdW5jdGlvbiAoZXJyLCBidWZmZXIpIHsKICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZXNvbHZlKG51bGwpCiAgICAgICAgICBjb25zdCBzdGFydCA9IHJlc3VsdC5oZWFkZXIuZXh0ZXJuYWwuc3RhcnQKICAgICAgICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgcmVzdWx0LmhlYWRlci5leHRlcm5hbC5sZW5ndGgKICAgICAgICAgIHJlc3VsdC5oZWFkZXIgPSBtLm9wbG9nLmhlYWRlci5kZWNvZGUoeyBidWZmZXIsIHN0YXJ0LCBlbmQgfSkKICAgICAgICAgIGZpbmlzaCgpCiAgICAgICAgfSkKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgZmluaXNoKCkKCiAgICAgIGZ1bmN0aW9uIGZpbmlzaCAoKSB7CiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIGNvbnN0IGVudHJ5ID0gZGVjb2RlT3Bsb2dFbnRyeShzdGF0ZSkKICAgICAgICAgIGlmICghZW50cnkpIGJyZWFrCiAgICAgICAgICBpZiAoZW50cnkuaGVhZGVyICE9PSBoZWFkZXIpIGJyZWFrCgogICAgICAgICAgZGVjb2RlZC5wdXNoKGVudHJ5KQogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGRlY29kZWQubGVuZ3RoID4gMCAmJiBkZWNvZGVkW2RlY29kZWQubGVuZ3RoIC0gMV0ucGFydGlhbCkgZGVjb2RlZC5wb3AoKQoKICAgICAgICBmb3IgKGNvbnN0IGUgb2YgZGVjb2RlZCkgewogICAgICAgICAgcmVzdWx0LmVudHJpZXMucHVzaChlLm1lc3NhZ2UpCiAgICAgICAgfQoKICAgICAgICByZXNvbHZlKHJlc3VsdCkKICAgICAgfQogICAgfSkKICB9KQp9CgpmdW5jdGlvbiBub29wICgpIHt9Ci8vIG5lZWRlZCBoZXJlIGZvciBjb21wYXQsIGNvcGllZCBmcm9tIG9sZCBoeXBlcmNvcmUsIGRvIG5vdCBjaGFuZ2UgdGhpcwoKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgREVGQVVMVF9OQU1FU1BBQ0UgPSBiNGEuZnJvbSgnNDE0NGVlYTUzMWU0ODNkNTRlMGMxNGY0Y2E2OGUwNjQ0ZjM1NTM0M2ZmNmZjYjBmMDA1MjAwZTEyY2Q3NDdjYicsICdoZXgnKQoKY29uc3QgaGFzaGVzID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHNtYWxsIHVpbnQKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGlmIChtID09PSAnYmxha2UyYicpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGhhc2g6ICcgKyBtKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdibGFrZTJiJwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGhhc2ggaWQ6ICcgKyBuKQogIH0KfQoKY29uc3Qgc2lnbmF0dXJlcyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBzbWFsbCB1aW50CiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBpZiAobSA9PT0gJ2VkMjU1MTknKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIHJldHVybgogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduYXR1cmU6ICcgKyBtKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdlZDI1NTE5JwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25hdHVyZSBpZDogJyArIG4pCiAgfQp9Cgpjb25zdCBzaWduZXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc2lnbmF0dXJlcy5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHNpZ25hdHVyZXMuZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IHNpZ25hdHVyZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgbmFtZXNwYWNlOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgc2lnbmVyQXJyYXkgPSBjLmFycmF5KHNpZ25lcikKCmNvbnN0IHByb2xvZ3VlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHApIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIHAuaGFzaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHAubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcCkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgcC5oYXNoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcC5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgbWFuaWZlc3R2MCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBoYXNoZXMucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBzdGF0ZS5lbmQrKyAvLyB0eXBlCgogICAgaWYgKG0ucHJvbG9ndWUgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlLmhhc2gpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChtLnF1b3J1bSA9PT0gMSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAxICYmICFtLmFsbG93UGF0Y2gpIHsKICAgICAgc2lnbmVyLnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzWzBdKQogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICAgIHNpZ25lckFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgfQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgaGFzaGVzLmVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGlmIChtLnByb2xvZ3VlICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDApIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5wcm9sb2d1ZS5oYXNoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobS5xdW9ydW0gPT09IDEgJiYgbS5zaWduZXJzLmxlbmd0aCA9PT0gMSAmJiAhbS5hbGxvd1BhdGNoKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICAgIHNpZ25lci5lbmNvZGUoc3RhdGUsIG0uc2lnbmVyc1swXSkKICAgIH0gZWxzZSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDIpCiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYWxsb3dQYXRjaCA/IDEgOiAwKQogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgICAgc2lnbmVyQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICB9CiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBoYXNoID0gaGFzaGVzLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh0eXBlID4gMikgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHR5cGU6ICcgKyB0eXBlKQoKICAgIGlmICh0eXBlID09PSAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBoYXNoLAogICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgIHF1b3J1bTogMCwKICAgICAgICBzaWduZXJzOiBbXSwKICAgICAgICBwcm9sb2d1ZTogewogICAgICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgICAgICBsZW5ndGg6IDAKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAodHlwZSA9PT0gMSkgewogICAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgaGFzaCwKICAgICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgICBxdW9ydW06IDEsCiAgICAgICAgc2lnbmVyczogW3NpZ25lci5kZWNvZGUoc3RhdGUpXSwKICAgICAgICBwcm9sb2d1ZTogbnVsbAogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDAsCiAgICAgIGhhc2gsCiAgICAgIGFsbG93UGF0Y2g6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBxdW9ydW06IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduZXJzOiBzaWduZXJBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBwcm9sb2d1ZTogbnVsbAogICAgfQogIH0KfQoKY29uc3QgbWFuaWZlc3QgPSBleHBvcnRzLm1hbmlmZXN0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHZlcnNpb24KICAgIGlmIChtLnZlcnNpb24gPT09IDApIHJldHVybiBtYW5pZmVzdHYwLnByZWVuY29kZShzdGF0ZSwgbSkKCiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaGFzaGVzLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgc2lnbmVyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICBpZiAobS5wcm9sb2d1ZSkgcHJvbG9ndWUucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAuZW5jb2RlKHN0YXRlLCBtKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIChtLmFsbG93UGF0Y2ggPyAxIDogMCkgfCAobS5wcm9sb2d1ZSA/IDIgOiAwKSB8IChtLnVuZW5jcnlwdGVkID8gNCA6IDApKQogICAgaGFzaGVzLmVuY29kZShzdGF0ZSwgbS5oYXNoKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgc2lnbmVyQXJyYXkuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICBpZiAobS5wcm9sb2d1ZSkgcHJvbG9ndWUuZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgdiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAodiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAuZGVjb2RlKHN0YXRlKQogICAgaWYgKHYgIT09IDEpIHRocm93IG5ldyBFcnJvcignVW5rbm93biB2ZXJzaW9uOiAnICsgdikKCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBoYXNoID0gaGFzaGVzLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHF1b3J1bSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBzaWduZXJzID0gc2lnbmVyQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgdW5lbmNyeXB0ZWQgPSAoZmxhZ3MgJiA0KSAhPT0gMAoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IDEsCiAgICAgIGhhc2gsCiAgICAgIGFsbG93UGF0Y2g6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBxdW9ydW0sCiAgICAgIHNpZ25lcnMsCiAgICAgIHByb2xvZ3VlOiAoZmxhZ3MgJiAyKSA9PT0gMCA/IG51bGwgOiBwcm9sb2d1ZS5kZWNvZGUoc3RhdGUpLAogICAgICB1bmVuY3J5cHRlZAogICAgfQogIH0KfQoKY29uc3Qgbm9kZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5pbmRleCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2l6ZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG4uaGFzaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2l6ZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBub2RlQXJyYXkgPSBjLmFycmF5KG5vZGUpCgpjb25zdCB3aXJlID0gZXhwb3J0cy53aXJlID0ge30KCndpcmUuaGFuZHNoYWtlID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlZWtzID8gMSA6IDApCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBzZWVrczogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIGNhcGFiaWxpdHk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0QmxvY2sgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0U2VlayA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5wYWRkaW5nKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcykgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHMucGFkZGluZykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGJ5dGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGFkZGluZzogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlcXVlc3RVcGdyYWRlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5yZXF1ZXN0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSByZXF1ZXN0QmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgcmVxdWVzdEJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgcmVxdWVzdFNlZWsucHJlZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSByZXF1ZXN0VXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLnByaW9yaXR5KSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnByaW9yaXR5KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5ibG9jayA/IDEgOiAwKSB8IChtLmhhc2ggPyAyIDogMCkgfCAobS5zZWVrID8gNCA6IDApIHwgKG0udXBncmFkZSA/IDggOiAwKSB8IChtLm1hbmlmZXN0ID8gMTYgOiAwKSB8IChtLnByaW9yaXR5ID8gMzIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKCiAgICBpZiAobS5ibG9jaykgcmVxdWVzdEJsb2NrLmVuY29kZShzdGF0ZSwgbS5ibG9jaykKICAgIGlmIChtLmhhc2gpIHJlcXVlc3RCbG9jay5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIHJlcXVlc3RTZWVrLmVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgcmVxdWVzdFVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5wcmlvcml0eSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5wcmlvcml0eSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBibG9jazogZmxhZ3MgJiAxID8gcmVxdWVzdEJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBoYXNoOiBmbGFncyAmIDIgPyByZXF1ZXN0QmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHNlZWs6IGZsYWdzICYgNCA/IHJlcXVlc3RTZWVrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1cGdyYWRlOiBmbGFncyAmIDggPyByZXF1ZXN0VXBncmFkZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDE2KSAhPT0gMCwKICAgICAgcHJpb3JpdHk6IGZsYWdzICYgMzIgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCndpcmUuY2FuY2VsID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGRlY29kZSAoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3Q6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhVXBncmFkZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCB1Lm5vZGVzKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgdS5hZGRpdGlvbmFsTm9kZXMpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgdS5ub2RlcykKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHUuYWRkaXRpb25hbE5vZGVzKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBhZGRpdGlvbmFsTm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFTZWVrID0gewogIHByZWVuY29kZSAoc3RhdGUsIHMpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcykgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5ieXRlcykKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIHMubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBieXRlczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YUJsb2NrID0gewogIHByZWVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGIudmFsdWUpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgYi52YWx1ZSkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIHx8IEVNUFRZLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFIYXNoID0gewogIHByZWVuY29kZSAoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgYikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5kYXRhID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIGRhdGFCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSBkYXRhSGFzaC5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIGRhdGFTZWVrLnByZWVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgZGF0YVVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5tYW5pZmVzdCkgbWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5ibG9jayA/IDEgOiAwKSB8IChtLmhhc2ggPyAyIDogMCkgfCAobS5zZWVrID8gNCA6IDApIHwgKG0udXBncmFkZSA/IDggOiAwKSB8IChtLm1hbmlmZXN0ID8gMTYgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSBkYXRhQmxvY2suZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgZGF0YUhhc2guZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBpZiAobS5zZWVrKSBkYXRhU2Vlay5lbmNvZGUoc3RhdGUsIG0uc2VlaykKICAgIGlmIChtLnVwZ3JhZGUpIGRhdGFVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS51cGdyYWRlKQogICAgaWYgKG0ubWFuaWZlc3QpIG1hbmlmZXN0LmVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICByZXF1ZXN0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGJsb2NrOiBmbGFncyAmIDEgPyBkYXRhQmxvY2suZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGhhc2g6IGZsYWdzICYgMiA/IGRhdGFIYXNoLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVrOiBmbGFncyAmIDQgPyBkYXRhU2Vlay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXBncmFkZTogZmxhZ3MgJiA4ID8gZGF0YVVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIG1hbmlmZXN0OiBmbGFncyAmIDE2ID8gbWFuaWZlc3QuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCndpcmUubm9EYXRhID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGRlY29kZSAoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHJlcXVlc3Q6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLndhbnQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnVud2FudCA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUucmFuZ2UgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBpZiAobS5sZW5ndGggIT09IDEpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKG0uZHJvcCA/IDEgOiAwKSB8IChtLmxlbmd0aCA9PT0gMSA/IDIgOiAwKSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBpZiAobS5sZW5ndGggIT09IDEpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGRyb3A6IChmbGFncyAmIDEpICE9PSAwLAogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogKGZsYWdzICYgMikgIT09IDAgPyAxIDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuYml0ZmllbGQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludDMyYXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludDMyYXJyYXkuZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZGVjb2RlIChzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBiaXRmaWVsZDogYy51aW50MzJhcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnN5bmMgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZW1vdGVMZW5ndGgpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAobS5jYW5VcGdyYWRlID8gMSA6IDApIHwgKG0udXBsb2FkaW5nID8gMiA6IDApIHwgKG0uZG93bmxvYWRpbmcgPyA0IDogMCkgfCAobS5oYXNNYW5pZmVzdCA/IDggOiAwKSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZW1vdGVMZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJlbW90ZUxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGNhblVwZ3JhZGU6IChmbGFncyAmIDEpICE9PSAwLAogICAgICB1cGxvYWRpbmc6IChmbGFncyAmIDIpICE9PSAwLAogICAgICBkb3dubG9hZGluZzogKGZsYWdzICYgNCkgIT09IDAsCiAgICAgIGhhc01hbmlmZXN0OiAoZmxhZ3MgJiA4KSAhPT0gMAogICAgfQogIH0KfQoKd2lyZS5yZW9yZ0hpbnQgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mcm9tKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS50bykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYW5jZXN0b3JzKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mcm9tKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50bykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYW5jZXN0b3JzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZnJvbTogYy51aW50LmVuY29kZShzdGF0ZSksCiAgICAgIHRvOiBjLnVpbnQuZW5jb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZW5jb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5leHRlbnNpb24gPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnJhdy5wcmVlbmNvZGUoc3RhdGUsIG0ubWVzc2FnZSkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5yYXcuZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBuYW1lOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBtZXNzYWdlOiBjLnJhdy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlWYWx1ZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBwKSB7CiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHAua2V5KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBwLnZhbHVlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcCkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBwLmtleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgcC52YWx1ZSkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGtleTogYy5zdHJpbmcuZGVjb2RlKHN0YXRlKSwKICAgICAgdmFsdWU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHRyZWVVcGdyYWRlID0gewogIHByZWVuY29kZSAoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuYW5jZXN0b3JzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5hbmNlc3RvcnMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYW5jZXN0b3JzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBiaXRmaWVsZFVwZGF0ZSA9IHsgLy8gVE9ETzogY2FuIG1heWJlIGJlIGZvbGRlZCBpbnRvIGEgSEFWRSBsYXRlciBvbiB3aXRoIHRoZSBtb3N0IHJlY2VudCBzcGVjCiAgcHJlZW5jb2RlIChzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIGIpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IGIuZHJvcCA/IDEgOiAwCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgYi5sZW5ndGgpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBkcm9wOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBvcGxvZyA9IGV4cG9ydHMub3Bsb2cgPSB7fQoKb3Bsb2cuZW50cnkgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGlmIChtLnVzZXJEYXRhKSBrZXlWYWx1ZS5wcmVlbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgICBpZiAobS50cmVlTm9kZXMpIG5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0udHJlZU5vZGVzKQogICAgaWYgKG0udHJlZVVwZ3JhZGUpIHRyZWVVcGdyYWRlLnByZWVuY29kZShzdGF0ZSwgbS50cmVlVXBncmFkZSkKICAgIGlmIChtLmJpdGZpZWxkKSBiaXRmaWVsZFVwZGF0ZS5wcmVlbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBjb25zdCBzID0gc3RhdGUuc3RhcnQrKwogICAgbGV0IGZsYWdzID0gMAoKICAgIGlmIChtLnVzZXJEYXRhKSB7CiAgICAgIGZsYWdzIHw9IDEKICAgICAga2V5VmFsdWUuZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogICAgfQogICAgaWYgKG0udHJlZU5vZGVzKSB7CiAgICAgIGZsYWdzIHw9IDIKICAgICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgbS50cmVlTm9kZXMpCiAgICB9CiAgICBpZiAobS50cmVlVXBncmFkZSkgewogICAgICBmbGFncyB8PSA0CiAgICAgIHRyZWVVcGdyYWRlLmVuY29kZShzdGF0ZSwgbS50cmVlVXBncmFkZSkKICAgIH0KICAgIGlmIChtLmJpdGZpZWxkKSB7CiAgICAgIGZsYWdzIHw9IDgKICAgICAgYml0ZmllbGRVcGRhdGUuZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogICAgfQoKICAgIHN0YXRlLmJ1ZmZlcltzXSA9IGZsYWdzCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICB1c2VyRGF0YTogKGZsYWdzICYgMSkgIT09IDAgPyBrZXlWYWx1ZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZU5vZGVzOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZVVwZ3JhZGU6IChmbGFncyAmIDQpICE9PSAwID8gdHJlZVVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGJpdGZpZWxkOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGJpdGZpZWxkVXBkYXRlLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlQYWlyID0gewogIHByZWVuY29kZSAoc3RhdGUsIGtwKSB7CiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGtwLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwga3Auc2VjcmV0S2V5KQogIH0sCiAgZW5jb2RlIChzdGF0ZSwga3ApIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwga3AucHVibGljS2V5KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBrcC5zZWNyZXRLZXkpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNlY3JldEtleTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVvcmdIaW50ID0gewogIHByZWVuY29kZSAoc3RhdGUsIHIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIuZnJvbSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIudG8pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCByLmFuY2VzdG9ycykKICB9LAogIGVuY29kZSAoc3RhdGUsIHIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIuZnJvbSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHIudG8pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLmFuY2VzdG9ycykKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZyb206IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB0bzogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlb3JnSGludEFycmF5ID0gYy5hcnJheShyZW9yZ0hpbnQpCgpjb25zdCBoaW50cyA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBoKSB7CiAgICByZW9yZ0hpbnRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGgucmVvcmdzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaC5jb250aWd1b3VzTGVuZ3RoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgaCkgewogICAgcmVvcmdIaW50QXJyYXkuZW5jb2RlKHN0YXRlLCBoLnJlb3JncykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGguY29udGlndW91c0xlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlb3JnczogcmVvcmdIaW50QXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgY29udGlndW91c0xlbmd0aDogc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmNvbnN0IHRyZWVIZWFkZXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgdCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdC5mb3JrKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdC5sZW5ndGgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHQucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHQuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgdCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdC5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdC5sZW5ndGgpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHQucm9vdEhhc2gpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHQuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJvb3RIYXNoOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHR5cGVzID0gewogIHByZWVuY29kZSAoc3RhdGUsIHQpIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdC50cmVlKQogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LmJpdGZpZWxkKQogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LnNpZ25lcikKICB9LAogIGVuY29kZSAoc3RhdGUsIHQpIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC50cmVlKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LmJpdGZpZWxkKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0LnNpZ25lcikKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHRyZWU6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIGJpdGZpZWxkOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduZXI6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGV4dGVybmFsSGVhZGVyID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZSAoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qga2V5VmFsdWVBcnJheSA9IGMuYXJyYXkoa2V5VmFsdWUpCgpvcGxvZy5oZWFkZXIgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgaCkgewogICAgc3RhdGUuZW5kICs9IDIgLy8gdmVyc2lvbiArIGZsYWdzCiAgICBpZiAoaC5leHRlcm5hbCkgewogICAgICBleHRlcm5hbEhlYWRlci5wcmVlbmNvZGUoc3RhdGUsIGguZXh0ZXJuYWwpCiAgICAgIHJldHVybgogICAgfQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgaC5rZXkpCiAgICBpZiAoaC5tYW5pZmVzdCkgbWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBoLm1hbmlmZXN0KQogICAgaWYgKGgua2V5UGFpcikga2V5UGFpci5wcmVlbmNvZGUoc3RhdGUsIGgua2V5UGFpcikKICAgIGtleVZhbHVlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBoLnVzZXJEYXRhKQogICAgdHJlZUhlYWRlci5wcmVlbmNvZGUoc3RhdGUsIGgudHJlZSkKICAgIGhpbnRzLnByZWVuY29kZShzdGF0ZSwgaC5oaW50cykKICB9LAogIGVuY29kZSAoc3RhdGUsIGgpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgICBpZiAoaC5leHRlcm5hbCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKSAvLyBPTkxZIHNldCB0aGUgZmlyc3QgYmlnIGZvciBjbGFyaXR5CiAgICAgIGV4dGVybmFsSGVhZGVyLmVuY29kZShzdGF0ZSwgaC5leHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAoaC5tYW5pZmVzdCA/IDIgOiAwKSB8IChoLmtleVBhaXIgPyA0IDogMCkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBoLmtleSkKICAgIGlmIChoLm1hbmlmZXN0KSBtYW5pZmVzdC5lbmNvZGUoc3RhdGUsIGgubWFuaWZlc3QpCiAgICBpZiAoaC5rZXlQYWlyKSBrZXlQYWlyLmVuY29kZShzdGF0ZSwgaC5rZXlQYWlyKQogICAga2V5VmFsdWVBcnJheS5lbmNvZGUoc3RhdGUsIGgudXNlckRhdGEpCiAgICB0cmVlSGVhZGVyLmVuY29kZShzdGF0ZSwgaC50cmVlKQogICAgaGludHMuZW5jb2RlKHN0YXRlLCBoLmhpbnRzKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHZlcnNpb24gPiAxKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBoZWFkZXIgdmVyc2lvbi4gRXhwZWN0ZWQgPD0gMSwgZ290ICcgKyB2ZXJzaW9uKQogICAgfQoKICAgIGlmICh2ZXJzaW9uID09PSAwKSB7CiAgICAgIGNvbnN0IG9sZCA9IHsKICAgICAgICB0eXBlczogdHlwZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgICB1c2VyRGF0YToga2V5VmFsdWVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICAgIHRyZWU6IHRyZWVIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBzaWduZXI6IGtleVBhaXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBoaW50czogaGludHMuZGVjb2RlKHN0YXRlKQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGV4dGVybmFsOiBudWxsLAogICAgICAgIGtleTogb2xkLnNpZ25lci5wdWJsaWNLZXksCiAgICAgICAgbWFuaWZlc3Q6IHsKICAgICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgICBoYXNoOiBvbGQudHlwZXMudHJlZSwKICAgICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgICAgcXVvcnVtOiAxLAogICAgICAgICAgc2lnbmVyczogW3sKICAgICAgICAgICAgc2lnbmF0dXJlOiBvbGQudHlwZXMuc2lnbmVyLAogICAgICAgICAgICBuYW1lc3BhY2U6IERFRkFVTFRfTkFNRVNQQUNFLAogICAgICAgICAgICBwdWJsaWNLZXk6IG9sZC5zaWduZXIucHVibGljS2V5CiAgICAgICAgICB9XSwKICAgICAgICAgIHByb2xvZ3VlOiBudWxsCiAgICAgICAgfSwKICAgICAgICBrZXlQYWlyOiBvbGQuc2lnbmVyLnNlY3JldEtleSA/IG9sZC5zaWduZXIgOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBvbGQudXNlckRhdGEsCiAgICAgICAgdHJlZTogb2xkLnRyZWUsCiAgICAgICAgaGludHM6IG9sZC5oaW50cwogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmIChmbGFncyAmIDEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBleHRlcm5hbDogZXh0ZXJuYWxIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBrZXk6IG51bGwsCiAgICAgICAgbWFuaWZlc3Q6IG51bGwsCiAgICAgICAga2V5UGFpcjogbnVsbCwKICAgICAgICB1c2VyRGF0YTogbnVsbCwKICAgICAgICB0cmVlOiBudWxsLAogICAgICAgIGhpbnRzOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBleHRlcm5hbDogbnVsbCwKICAgICAga2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDIpICE9PSAwID8gbWFuaWZlc3QuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGtleVBhaXI6IChmbGFncyAmIDQpICE9PSAwID8ga2V5UGFpci5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXNlckRhdGE6IGtleVZhbHVlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgdHJlZTogdHJlZUhlYWRlci5kZWNvZGUoc3RhdGUpLAogICAgICBoaW50czogaGludHMuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdWludEFycmF5ID0gYy5hcnJheShjLnVpbnQpCgpjb25zdCBtdWx0aXNpZ0lucHV0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIGlucCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaW5wLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIGlucC5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBpbnAucGF0Y2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBpbnApIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGlucC5zaWduZXIpCiAgICBjLmZpeGVkNjQuZW5jb2RlKHN0YXRlLCBpbnAuc2lnbmF0dXJlKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaW5wLnBhdGNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc2lnbmVyOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBwYXRjaEVuY29kaW5ndjAgPSB7CiAgcHJlZW5jb2RlIChzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4ubGVuZ3RoKQogICAgdWludEFycmF5LnByZWVuY29kZShzdGF0ZSwgbi5ub2RlcykKICB9LAogIGVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmxlbmd0aCkKICAgIHVpbnRBcnJheS5lbmNvZGUoc3RhdGUsIG4ubm9kZXMpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiB1aW50QXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgbXVsdGlzaWdJbnB1dHYwID0gewogIHByZWVuY29kZSAoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCsrCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG4uc2lnbmF0dXJlKQogICAgaWYgKG4ucGF0Y2gpIHBhdGNoRW5jb2Rpbmd2MC5wcmVlbmNvZGUoc3RhdGUsIG4ucGF0Y2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnBhdGNoID8gMSA6IDApCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIG4uc2lnbmF0dXJlKQogICAgaWYgKG4ucGF0Y2gpIHBhdGNoRW5jb2Rpbmd2MC5lbmNvZGUoc3RhdGUsIG4ucGF0Y2gpCiAgfSwKICBkZWNvZGUgKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICBzaWduZXI6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogKGZsYWdzICYgMSkgPyBwYXRjaEVuY29kaW5ndjAuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IG11bHRpc2lnSW5wdXRBcnJheXYwID0gYy5hcnJheShtdWx0aXNpZ0lucHV0djApCmNvbnN0IG11bHRpc2lnSW5wdXRBcnJheSA9IGMuYXJyYXkobXVsdGlzaWdJbnB1dCkKCmNvbnN0IGNvbXBhY3ROb2RlID0gewogIHByZWVuY29kZSAoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZGVjb2RlIChzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaXplOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGNvbXBhY3ROb2RlQXJyYXkgPSBjLmFycmF5KGNvbXBhY3ROb2RlKQoKZXhwb3J0cy5tdWx0aVNpZ25hdHVyZXYwID0gewogIHByZWVuY29kZSAoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheXYwLnByZWVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGVuY29kZSAoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheXYwLmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHByb29mczogbXVsdGlzaWdJbnB1dEFycmF5djAuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGNvbXBhY3ROb2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKZXhwb3J0cy5tdWx0aVNpZ25hdHVyZSA9IHsKICBwcmVlbmNvZGUgKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnByb29mcykKICAgIGNvbXBhY3ROb2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLnBhdGNoKQogIH0sCiAgZW5jb2RlIChzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5LmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHByb29mczogbXVsdGlzaWdJbnB1dEFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjb21wYWN0Tm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KewogICJuYW1lIjogImh5cGVyY29yZS1zdG9yYWdlIiwKICAidmVyc2lvbiI6ICIyLjQuMSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyouanMiLAogICAgInNwZWMvaHlwZXJzY2hlbWEvKi5qcyIsCiAgICAibWlncmF0aW9ucy8wLyouanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBsdW50ZSIsCiAgICAidGVzdCI6ICJub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJTdG9yYWdlIGVuZ2luZSBmb3IgSHlwZXJjb3JlIiwKICAiaW1wb3J0cyI6IHsKICAgICJmcyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1mcyIsCiAgICAgICJkZWZhdWx0IjogImZzIgogICAgfSwKICAgICJwYXRoIjogewogICAgICAiYmFyZSI6ICJiYXJlLXBhdGgiLAogICAgICAiZGVmYXVsdCI6ICJwYXRoIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi43IiwKICAgICJiYXJlLWZzIjogIl40LjAuMSIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNi4wIiwKICAgICJkZXZpY2UtZmlsZSI6ICJeMi4xLjIiLAogICAgImZsYXQtdHJlZSI6ICJeMS4xMi4xIiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjQuMiIsCiAgICAiaHlwZXJzY2hlbWEiOiAiXjEuNy4wIiwKICAgICJpbmRleC1lbmNvZGVyIjogIl4zLjMuMiIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4wLjAiLAogICAgInJvY2tzZGItbmF0aXZlIjogIl4zLjExLjAiLAogICAgInNjb3BlLWxvY2siOiAiXjEuMi40IiwKICAgICJzdHJlYW14IjogIl4yLjIxLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNy4wIiwKICAgICJsdW50ZSI6ICJeMS4yLjAiLAogICAgInByZXR0aWVyIjogIl4zLjYuMiIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICJeMi4wLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjMuMSIKICB9Cn0KLy8gVGhpcyBmaWxlIGlzIGF1dG9nZW5lcmF0ZWQgYnkgdGhlIGh5cGVyc2NoZW1hIGNvbXBpbGVyCi8vIFNjaGVtYSBWZXJzaW9uOiAxCi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBxdW90ZXMgKi8KLyogZXNsaW50LWRpc2FibGUgc3BhY2UtYmVmb3JlLWZ1bmN0aW9uLXBhcmVuICovCgpjb25zdCB7IGMgfSA9IHJlcXVpcmUoJ2h5cGVyc2NoZW1hL3J1bnRpbWUnKQoKY29uc3QgVkVSU0lPTiA9IDEKCi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycwpsZXQgdmVyc2lvbiA9IFZFUlNJT04KCi8vIEBjb3Jlc3RvcmUvYWxsb2NhdGVkCmNvbnN0IGVuY29kaW5nMCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY29yZXMpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGFzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmNvcmVzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5kYXRhcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGNvcmVzOiByMCwKICAgICAgZGF0YXM6IHIxCiAgICB9CiAgfQp9CgovLyBAY29yZXN0b3JlL2hlYWQKY29uc3QgZW5jb2RpbmcxID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgNCBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5hbGxvY2F0ZWQpIGVuY29kaW5nMC5wcmVlbmNvZGUoc3RhdGUsIG0uYWxsb2NhdGVkKQogICAgaWYgKG0uc2VlZCkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5zZWVkKQogICAgaWYgKG0uZGVmYXVsdERpc2NvdmVyeUtleSkgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5kZWZhdWx0RGlzY292ZXJ5S2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmFsbG9jYXRlZCA/IDEgOiAwKSB8CiAgICAgIChtLnNlZWQgPyAyIDogMCkgfAogICAgICAobS5kZWZhdWx0RGlzY292ZXJ5S2V5ID8gNCA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCgogICAgaWYgKG0uYWxsb2NhdGVkKSBlbmNvZGluZzAuZW5jb2RlKHN0YXRlLCBtLmFsbG9jYXRlZCkKICAgIGlmIChtLnNlZWQpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uc2VlZCkKICAgIGlmIChtLmRlZmF1bHREaXNjb3ZlcnlLZXkpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uZGVmYXVsdERpc2NvdmVyeUtleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBhbGxvY2F0ZWQ6IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2RpbmcwLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVkOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgZGVmYXVsdERpc2NvdmVyeUtleTogKGZsYWdzICYgNCkgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBjb3Jlc3RvcmUvYWxpYXMKY29uc3QgZW5jb2RpbmcyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnN0cmluZy5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgbmFtZTogcjAsCiAgICAgIG5hbWVzcGFjZTogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3Jlc3RvcmUvY29yZQpjb25zdCBlbmNvZGluZzMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmNvcmVQb2ludGVyKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5kYXRhUG9pbnRlcikKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBmbGFnIGlzIDEgc28gYWx3YXlzIG9uZSBieXRlCgogICAgaWYgKG0uYWxpYXMpIGVuY29kaW5nMi5wcmVlbmNvZGUoc3RhdGUsIG0uYWxpYXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0gbS5hbGlhcyA/IDEgOiAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5jb3JlUG9pbnRlcikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKCiAgICBpZiAobS5hbGlhcykgZW5jb2RpbmcyLmVuY29kZShzdGF0ZSwgbS5hbGlhcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBjb3JlUG9pbnRlcjogcjEsCiAgICAgIGRhdGFQb2ludGVyOiByMiwKICAgICAgYWxpYXM6IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2RpbmcyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBlbmNvZGluZzRfZW51bSA9IHsKICBibGFrZTJiOiAnYmxha2UyYicKfQoKLy8gQGNvcmUvaGFzaGVzIGVudW0KY29uc3QgZW5jb2Rpbmc0ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBlbnVtIGlzIDAgc28gYWx3YXlzIG9uZSBieXRlCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzd2l0Y2ggKG0pIHsKICAgICAgY2FzZSAnYmxha2UyYic6CiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbnVtJykKICAgIH0KICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHN3aXRjaCAoYy51aW50LmRlY29kZShzdGF0ZSkpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiAnYmxha2UyYicKICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IGVuY29kaW5nNV9lbnVtID0gewogIGVkMjU1MTk6ICdlZDI1NTE5Jwp9CgovLyBAY29yZS9zaWduYXR1cmVzIGVudW0KY29uc3QgZW5jb2Rpbmc1ID0gewogIHByZWVuY29kZSAoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIG1heCBlbnVtIGlzIDAgc28gYWx3YXlzIG9uZSBieXRlCiAgfSwKICBlbmNvZGUgKHN0YXRlLCBtKSB7CiAgICBzd2l0Y2ggKG0pIHsKICAgICAgY2FzZSAnZWQyNTUxOSc6CiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMCkKICAgICAgICBicmVhawogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbnVtJykKICAgIH0KICB9LAogIGRlY29kZSAoc3RhdGUpIHsKICAgIHN3aXRjaCAoYy51aW50LmRlY29kZShzdGF0ZSkpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiAnZWQyNTUxOScKICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGwKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3RyZWUtbm9kZQpjb25zdCBlbmNvZGluZzYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMiA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IHIwLAogICAgICBzaXplOiByMSwKICAgICAgaGFzaDogcjIKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3NpZ25lcgpjb25zdCBlbmNvZGluZzcgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBlbmNvZGluZzUucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25hdHVyZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ubmFtZXNwYWNlKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGVuY29kaW5nNS5lbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5uYW1lc3BhY2UpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBlbmNvZGluZzUuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjIgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHNpZ25hdHVyZTogcjAsCiAgICAgIG5hbWVzcGFjZTogcjEsCiAgICAgIHB1YmxpY0tleTogcjIKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3Byb2xvZ3VlCmNvbnN0IGVuY29kaW5nOCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGhhc2g6IHIwLAogICAgICBsZW5ndGg6IHIxCiAgICB9CiAgfQp9CgovLyBAY29yZS9tYW5pZmVzdC5zaWduZXJzCmNvbnN0IGVuY29kaW5nOV80ID0gYy5hcnJheShlbmNvZGluZzcpCi8vIEBjb3JlL21hbmlmZXN0LmxpbmtlZApjb25zdCBlbmNvZGluZzlfNiA9IGMuYXJyYXkoYy5maXhlZDMyKQoKLy8gQGNvcmUvbWFuaWZlc3QKY29uc3QgZW5jb2Rpbmc5ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgOCBzbyBhbHdheXMgb25lIGJ5dGUKICAgIGVuY29kaW5nNC5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucXVvcnVtKQogICAgZW5jb2Rpbmc5XzQucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCgogICAgaWYgKG0ucHJvbG9ndWUpIGVuY29kaW5nOC5wcmVlbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgICBpZiAobS5saW5rZWQpIGVuY29kaW5nOV82LnByZWVuY29kZShzdGF0ZSwgbS5saW5rZWQpCiAgICBpZiAobS51c2VyRGF0YSkgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnVzZXJEYXRhKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmFsbG93UGF0Y2ggPyAxIDogMCkgfAogICAgICAobS5wcm9sb2d1ZSA/IDIgOiAwKSB8CiAgICAgIChtLmxpbmtlZCA/IDQgOiAwKSB8CiAgICAgIChtLnVzZXJEYXRhID8gOCA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS52ZXJzaW9uKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBlbmNvZGluZzQuZW5jb2RlKHN0YXRlLCBtLmhhc2gpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIGVuY29kaW5nOV80LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQoKICAgIGlmIChtLnByb2xvZ3VlKSBlbmNvZGluZzguZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogICAgaWYgKG0ubGlua2VkKSBlbmNvZGluZzlfNi5lbmNvZGUoc3RhdGUsIG0ubGlua2VkKQogICAgaWYgKG0udXNlckRhdGEpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBoYXNoOiBlbmNvZGluZzQuZGVjb2RlKHN0YXRlKSwKICAgICAgcXVvcnVtOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYWxsb3dQYXRjaDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHNpZ25lcnM6IGVuY29kaW5nOV80LmRlY29kZShzdGF0ZSksCiAgICAgIHByb2xvZ3VlOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nOC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbGlua2VkOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGVuY29kaW5nOV82LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICB1c2VyRGF0YTogKGZsYWdzICYgOCkgIT09IDAgPyBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKLy8gQGNvcmUva2V5UGFpcgpjb25zdCBlbmNvZGluZzEwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5zZWNyZXRLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0uc2VjcmV0S2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogcjAsCiAgICAgIHNlY3JldEtleTogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3JlL2F1dGgubWFuaWZlc3QKY29uc3QgZW5jb2RpbmcxMV8yID0gYy5mcmFtZShlbmNvZGluZzkpCgovLyBAY29yZS9hdXRoCmNvbnN0IGVuY29kaW5nMTEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmtleSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uZGlzY292ZXJ5S2V5KQogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgNCBzbyBhbHdheXMgb25lIGJ5dGUKCiAgICBpZiAobS5tYW5pZmVzdCkgZW5jb2RpbmcxMV8yLnByZWVuY29kZShzdGF0ZSwgbS5tYW5pZmVzdCkKICAgIGlmIChtLmtleVBhaXIpIGVuY29kaW5nMTAucHJlZW5jb2RlKHN0YXRlLCBtLmtleVBhaXIpCiAgICBpZiAobS5lbmNyeXB0aW9uS2V5KSBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0uZW5jcnlwdGlvbktleSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5tYW5pZmVzdCA/IDEgOiAwKSB8CiAgICAgIChtLmtleVBhaXIgPyAyIDogMCkgfAogICAgICAobS5lbmNyeXB0aW9uS2V5ID8gNCA6IDApCgogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmRpc2NvdmVyeUtleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLm1hbmlmZXN0KSBlbmNvZGluZzExXzIuZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogICAgaWYgKG0ua2V5UGFpcikgZW5jb2RpbmcxMC5lbmNvZGUoc3RhdGUsIG0ua2V5UGFpcikKICAgIGlmIChtLmVuY3J5cHRpb25LZXkpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5lbmNyeXB0aW9uS2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCByMCA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCByMSA9IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAga2V5OiByMCwKICAgICAgZGlzY292ZXJ5S2V5OiByMSwKICAgICAgbWFuaWZlc3Q6IChmbGFncyAmIDEpICE9PSAwID8gZW5jb2RpbmcxMV8yLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBrZXlQYWlyOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGVuY29kaW5nMTAuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGVuY3J5cHRpb25LZXk6IChmbGFncyAmIDQpICE9PSAwID8gYy5idWZmZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCi8vIEBjb3JlL2hlYWQKY29uc3QgZW5jb2RpbmcxMiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5yb290SGFzaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5yb290SGFzaCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIxID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIyID0gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHIzID0gYy5idWZmZXIuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGZvcms6IHIwLAogICAgICBsZW5ndGg6IHIxLAogICAgICByb290SGFzaDogcjIsCiAgICAgIHNpZ25hdHVyZTogcjMKICAgIH0KICB9Cn0KCi8vIEBjb3JlL2hpbnRzCmNvbnN0IGVuY29kaW5nMTMgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAyIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uY29udGlndW91c0xlbmd0aCkKICAgIGlmIChtLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPQogICAgICAobS5jb250aWd1b3VzTGVuZ3RoID8gMSA6IDApIHwKICAgICAgKG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCA/IDIgOiAwKQoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5lbmNvZGUoc3RhdGUsIG0uY29udGlndW91c0xlbmd0aCkKICAgIGlmIChtLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucmVtb3RlQ29udGlndW91c0xlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IChmbGFncyAmIDEpICE9PSAwID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwLAogICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKLy8gQGNvcmUvc2Vzc2lvbgpjb25zdCBlbmNvZGluZzE0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIG0ubmFtZSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHIwID0gYy5zdHJpbmcuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHIwLAogICAgICBkYXRhUG9pbnRlcjogcjEKICAgIH0KICB9Cn0KCi8vIEBjb3JlL3Nlc3Npb25zCmNvbnN0IGVuY29kaW5nMTUgPSBjLmFycmF5KGVuY29kaW5nMTQpCgovLyBAY29yZS9kZXBlbmRlbmN5CmNvbnN0IGVuY29kaW5nMTYgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmRhdGFQb2ludGVyKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZGF0YVBvaW50ZXIpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGRhdGFQb2ludGVyOiByMCwKICAgICAgbGVuZ3RoOiByMQogICAgfQogIH0KfQoKZnVuY3Rpb24gc2V0VmVyc2lvbih2KSB7CiAgdmVyc2lvbiA9IHYKfQoKZnVuY3Rpb24gZW5jb2RlKG5hbWUsIHZhbHVlLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZW5jb2RlKGdldEVuY29kaW5nKG5hbWUpLCB2YWx1ZSkKfQoKZnVuY3Rpb24gZGVjb2RlKG5hbWUsIGJ1ZmZlciwgdiA9IFZFUlNJT04pIHsKICB2ZXJzaW9uID0gdgogIHJldHVybiBjLmRlY29kZShnZXRFbmNvZGluZyhuYW1lKSwgYnVmZmVyKQp9CgpmdW5jdGlvbiBnZXRFbnVtKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGNhc2UgJ0Bjb3JlL2hhc2hlcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzRfZW51bQogICAgY2FzZSAnQGNvcmUvc2lnbmF0dXJlcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzVfZW51bQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbnVtIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldEVuY29kaW5nKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGNhc2UgJ0Bjb3Jlc3RvcmUvYWxsb2NhdGVkJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMAogICAgY2FzZSAnQGNvcmVzdG9yZS9oZWFkJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMQogICAgY2FzZSAnQGNvcmVzdG9yZS9hbGlhcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzIKICAgIGNhc2UgJ0Bjb3Jlc3RvcmUvY29yZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzMKICAgIGNhc2UgJ0Bjb3JlL2hhc2hlcyc6CiAgICAgIHJldHVybiBlbmNvZGluZzQKICAgIGNhc2UgJ0Bjb3JlL3NpZ25hdHVyZXMnOgogICAgICByZXR1cm4gZW5jb2Rpbmc1CiAgICBjYXNlICdAY29yZS90cmVlLW5vZGUnOgogICAgICByZXR1cm4gZW5jb2Rpbmc2CiAgICBjYXNlICdAY29yZS9zaWduZXInOgogICAgICByZXR1cm4gZW5jb2Rpbmc3CiAgICBjYXNlICdAY29yZS9wcm9sb2d1ZSc6CiAgICAgIHJldHVybiBlbmNvZGluZzgKICAgIGNhc2UgJ0Bjb3JlL21hbmlmZXN0JzoKICAgICAgcmV0dXJuIGVuY29kaW5nOQogICAgY2FzZSAnQGNvcmUva2V5UGFpcic6CiAgICAgIHJldHVybiBlbmNvZGluZzEwCiAgICBjYXNlICdAY29yZS9hdXRoJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTEKICAgIGNhc2UgJ0Bjb3JlL2hlYWQnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMgogICAgY2FzZSAnQGNvcmUvaGludHMnOgogICAgICByZXR1cm4gZW5jb2RpbmcxMwogICAgY2FzZSAnQGNvcmUvc2Vzc2lvbic6CiAgICAgIHJldHVybiBlbmNvZGluZzE0CiAgICBjYXNlICdAY29yZS9zZXNzaW9ucyc6CiAgICAgIHJldHVybiBlbmNvZGluZzE1CiAgICBjYXNlICdAY29yZS9kZXBlbmRlbmN5JzoKICAgICAgcmV0dXJuIGVuY29kaW5nMTYKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignRW5jb2RlciBub3QgZm91bmQgJyArIG5hbWUpCiAgfQp9CgpmdW5jdGlvbiBnZXRTdHJ1Y3QobmFtZSwgdiA9IFZFUlNJT04pIHsKICBjb25zdCBlbmMgPSBnZXRFbmNvZGluZyhuYW1lKQogIHJldHVybiB7CiAgICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLnByZWVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICAgIH0sCiAgICBkZWNvZGUoc3RhdGUpIHsKICAgICAgdmVyc2lvbiA9IHYKICAgICAgcmV0dXJuIGVuYy5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXNvbHZlU3RydWN0ID0gZ2V0U3RydWN0IC8vIGNvbXBhdAoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcmVzb2x2ZVN0cnVjdCwKICBnZXRTdHJ1Y3QsCiAgZ2V0RW51bSwKICBnZXRFbmNvZGluZywKICBlbmNvZGUsCiAgZGVjb2RlLAogIHNldFZlcnNpb24sCiAgdmVyc2lvbgp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBpc09wdGlvbnMgPSByZXF1aXJlKCdpcy1vcHRpb25zJykKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IENvcmVTdG9yYWdlID0gcmVxdWlyZSgnaHlwZXJjb3JlLXN0b3JhZ2UnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IE5vaXNlU2VjcmV0U3RyZWFtID0gcmVxdWlyZSgnQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbScpCmNvbnN0IFByb3RvbXV4ID0gcmVxdWlyZSgncHJvdG9tdXgnKQpjb25zdCBpZCA9IHJlcXVpcmUoJ2h5cGVyY29yZS1pZC1lbmNvZGluZycpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IGluc3BlY3QgPSByZXF1aXJlKCcuL2xpYi9pbnNwZWN0JykKY29uc3QgQ29yZSA9IHJlcXVpcmUoJy4vbGliL2NvcmUnKQpjb25zdCBJbmZvID0gcmVxdWlyZSgnLi9saWIvaW5mbycpCmNvbnN0IERvd25sb2FkID0gcmVxdWlyZSgnLi9saWIvZG93bmxvYWQnKQpjb25zdCBEZWZhdWx0RW5jcnlwdGlvbiA9IHJlcXVpcmUoJy4vbGliL2RlZmF1bHQtZW5jcnlwdGlvbicpCmNvbnN0IGNhcHMgPSByZXF1aXJlKCcuL2xpYi9jYXBzJykKY29uc3QgUmVwbGljYXRvciA9IHJlcXVpcmUoJy4vbGliL3JlcGxpY2F0b3InKQpjb25zdCB7IG1hbmlmZXN0SGFzaCwgY3JlYXRlTWFuaWZlc3QgfSA9IHJlcXVpcmUoJy4vbGliL3ZlcmlmaWVyJykKY29uc3QgeyBSZWFkU3RyZWFtLCBXcml0ZVN0cmVhbSwgQnl0ZVN0cmVhbSB9ID0gcmVxdWlyZSgnLi9saWIvc3RyZWFtcycpCmNvbnN0IHsgTWVya2xlVHJlZSB9ID0gcmVxdWlyZSgnLi9saWIvbWVya2xlLXRyZWUnKQpjb25zdCB7CiAgQVNTRVJUSU9OLAogIEJBRF9BUkdVTUVOVCwKICBTRVNTSU9OX0NMT1NFRCwKICBTRVNTSU9OX01PVkVELAogIFNFU1NJT05fTk9UX1dSSVRBQkxFLAogIFNOQVBTSE9UX05PVF9BVkFJTEFCTEUsCiAgREVDT0RJTkdfRVJST1IKfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQoKLy8gSHlwZXJjb3JlIGFjdHVhbGx5IGRvZXMgbm90IGhhdmUgYW55IG5vdGlvbiBvZiBtYXgvbWluIGJsb2NrIHNpemVzCi8vIGJ1dCB3ZSBlbmZvcmNlIDE1bWIgdG8gZW5zdXJlIHNtb290aCByZXBsaWNhdGlvbiAoZWFjaCBibG9jayBpcyB0cmFuc21pdHRlZCBhdG9taWNhbGx5KQpjb25zdCBNQVhfU1VHR0VTVEVEX0JMT0NLX1NJWkUgPSAxNSAqIDEwMjQgKiAxMDI0CgpjbGFzcyBIeXBlcmNvcmUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKHN0b3JhZ2UsIGtleSwgb3B0cykgewogICAgc3VwZXIoKQoKICAgIGlmIChpc09wdGlvbnMoc3RvcmFnZSkgJiYgIXN0b3JhZ2UuZGIpIHsKICAgICAgb3B0cyA9IHN0b3JhZ2UKICAgICAgc3RvcmFnZSA9IG51bGwKICAgICAga2V5ID0gb3B0cy5rZXkgfHwgbnVsbAogICAgfSBlbHNlIGlmIChpc09wdGlvbnMoa2V5KSkgewogICAgICBvcHRzID0ga2V5CiAgICAgIGtleSA9IG9wdHMua2V5IHx8IG51bGwKICAgIH0KCiAgICBpZiAoa2V5ICYmIHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSBrZXkgPSBpZC5kZWNvZGUoa2V5KQogICAgaWYgKCFvcHRzKSBvcHRzID0ge30KCiAgICBpZiAoIXN0b3JhZ2UpIHN0b3JhZ2UgPSBvcHRzLnN0b3JhZ2UKCiAgICB0aGlzLmNvcmUgPSBudWxsCiAgICB0aGlzLnN0YXRlID0gbnVsbAogICAgdGhpcy5lbmNyeXB0aW9uID0gbnVsbAogICAgdGhpcy5leHRlbnNpb25zID0gbmV3IE1hcCgpCgogICAgdGhpcy52YWx1ZUVuY29kaW5nID0gbnVsbAogICAgdGhpcy5lbmNvZGVCYXRjaCA9IG51bGwKICAgIHRoaXMuYWN0aXZlUmVxdWVzdHMgPSBbXQogICAgdGhpcy5zZXNzaW9ucyA9IG51bGwKICAgIHRoaXMub25nYyA9IG51bGwKCiAgICB0aGlzLmtleVBhaXIgPSBvcHRzLmtleVBhaXIgfHwgbnVsbAogICAgdGhpcy5yZWFkYWJsZSA9IHRydWUKICAgIHRoaXMud3JpdGFibGUgPSBmYWxzZQogICAgdGhpcy5leGNsdXNpdmUgPSBmYWxzZQogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogICAgdGhpcy53ZWFrID0gISFvcHRzLndlYWsKICAgIHRoaXMuc25hcHNob3R0ZWQgPSAhIW9wdHMuc25hcHNob3QKICAgIHRoaXMub25zZXEgPSBvcHRzLm9uc2VxIHx8IG51bGwKICAgIHRoaXMub253YWl0ID0gb3B0cy5vbndhaXQgfHwgbnVsbAogICAgdGhpcy53YWl0ID0gb3B0cy53YWl0ICE9PSBmYWxzZQogICAgdGhpcy50aW1lb3V0ID0gb3B0cy50aW1lb3V0IHx8IDAKICAgIHRoaXMucHJlbG9hZCA9IG51bGwKICAgIHRoaXMuY2xvc2luZyA9IG51bGwKICAgIHRoaXMub3BlbmluZyA9IG51bGwKCiAgICB0aGlzLl9yZWFkb25seSA9IG9wdHMud3JpdGFibGUgPT09IGZhbHNlCiAgICB0aGlzLl9wcmVhcHBlbmQgPSBwcmVhcHBlbmQuYmluZCh0aGlzKQogICAgdGhpcy5fc25hcHNob3QgPSBudWxsCiAgICB0aGlzLl9maW5kaW5nUGVlcnMgPSAwCiAgICB0aGlzLl9hY3RpdmUgPSBvcHRzLndlYWsgPyAhIW9wdHMuYWN0aXZlIDogb3B0cy5hY3RpdmUgIT09IGZhbHNlCgogICAgdGhpcy5fc2Vzc2lvbkluZGV4ID0gLTEKICAgIHRoaXMuX3N0YXRlSW5kZXggPSAtMSAvLyBtYWludGFpbmVkIGJ5IHNlc3Npb24gc3RhdGUKICAgIHRoaXMuX21vbml0b3JJbmRleCA9IC0xIC8vIG1haW50YWluZWQgYnkgcmVwbGljYXRpb24gc3RhdGUKCiAgICB0aGlzLm9wZW5pbmcgPSB0aGlzLl9vcGVuKHN0b3JhZ2UsIGtleSwgb3B0cykKICAgIHRoaXMub3BlbmluZy5jYXRjaChzYWZldHlDYXRjaCkKCiAgICB0aGlzLm9uKCduZXdMaXN0ZW5lcicsIG1heWJlQWRkTW9uaXRvcikKICB9CgogIFtTeW1ib2wuZm9yKCdub2RlanMudXRpbC5pbnNwZWN0LmN1c3RvbScpXShkZXB0aCwgb3B0cykgewogICAgcmV0dXJuIGluc3BlY3QodGhpcywgZGVwdGgsIG9wdHMpCiAgfQoKICBzdGF0aWMgTUFYX1NVR0dFU1RFRF9CTE9DS19TSVpFID0gTUFYX1NVR0dFU1RFRF9CTE9DS19TSVpFCgogIHN0YXRpYyBEZWZhdWx0RW5jcnlwdGlvbiA9IERlZmF1bHRFbmNyeXB0aW9uCgogIHN0YXRpYyBrZXkobWFuaWZlc3QsIHsgY29tcGF0LCB2ZXJzaW9uLCBuYW1lc3BhY2UgfSA9IHt9KSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKG1hbmlmZXN0KSkgewogICAgICBtYW5pZmVzdCA9IHsgdmVyc2lvbiwgc2lnbmVyczogW3sgcHVibGljS2V5OiBtYW5pZmVzdCwgbmFtZXNwYWNlIH1dIH0KICAgIH0KICAgIHJldHVybiBjb21wYXQgPyBtYW5pZmVzdC5zaWduZXJzWzBdLnB1YmxpY0tleSA6IG1hbmlmZXN0SGFzaChjcmVhdGVNYW5pZmVzdChtYW5pZmVzdCkpCiAgfQoKICBzdGF0aWMgZGlzY292ZXJ5S2V5KGtleSkgewogICAgcmV0dXJuIGNyeXB0by5kaXNjb3ZlcnlLZXkoa2V5KQogIH0KCiAgc3RhdGljIGJsb2NrRW5jcnlwdGlvbktleShrZXksIGVuY3J5cHRpb25LZXkpIHsKICAgIHJldHVybiBEZWZhdWx0RW5jcnlwdGlvbi5ibG9ja0VuY3J5cHRpb25LZXkoa2V5LCBlbmNyeXB0aW9uS2V5KQogIH0KCiAgc3RhdGljIGdldFByb3RvY29sTXV4ZXIoc3RyZWFtKSB7CiAgICByZXR1cm4gc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhCiAgfQoKICBzdGF0aWMgY3JlYXRlQ29yZShzdG9yYWdlLCBvcHRzKSB7CiAgICByZXR1cm4gbmV3IENvcmUoSHlwZXJjb3JlLmRlZmF1bHRTdG9yYWdlKHN0b3JhZ2UpLCB7IGF1dG9DbG9zZTogZmFsc2UsIC4uLm9wdHMgfSkKICB9CgogIHN0YXRpYyBjcmVhdGVQcm90b2NvbFN0cmVhbShpc0luaXRpYXRvciwgb3B0cyA9IHt9KSB7CiAgICBsZXQgb3V0ZXJTdHJlYW0gPSBQcm90b211eC5pc1Byb3RvbXV4KGlzSW5pdGlhdG9yKQogICAgICA/IGlzSW5pdGlhdG9yLnN0cmVhbQogICAgICA6IGlzU3RyZWFtKGlzSW5pdGlhdG9yKQogICAgICAgID8gaXNJbml0aWF0b3IKICAgICAgICA6IG9wdHMuc3RyZWFtCgogICAgbGV0IG5vaXNlU3RyZWFtID0gbnVsbAoKICAgIGlmIChvdXRlclN0cmVhbSkgewogICAgICBub2lzZVN0cmVhbSA9IG91dGVyU3RyZWFtLm5vaXNlU3RyZWFtCiAgICB9IGVsc2UgewogICAgICBub2lzZVN0cmVhbSA9IG5ldyBOb2lzZVNlY3JldFN0cmVhbShpc0luaXRpYXRvciwgbnVsbCwgb3B0cykKICAgICAgb3V0ZXJTdHJlYW0gPSBub2lzZVN0cmVhbS5yYXdTdHJlYW0KICAgIH0KICAgIGlmICghbm9pc2VTdHJlYW0pIHRocm93IEJBRF9BUkdVTUVOVCgnSW52YWxpZCBzdHJlYW0nLCB0aGlzLmRpc2NvdmVyeUtleSkKCiAgICBpZiAoIW5vaXNlU3RyZWFtLnVzZXJEYXRhKSB7CiAgICAgIGNvbnN0IHByb3RvY29sID0gUHJvdG9tdXguZnJvbShub2lzZVN0cmVhbSkKCiAgICAgIGlmIChvcHRzLmtlZXBBbGl2ZSAhPT0gZmFsc2UgJiYgbm9pc2VTdHJlYW0ua2VlcEFsaXZlID09PSAwKSB7CiAgICAgICAgbm9pc2VTdHJlYW0uc2V0S2VlcEFsaXZlKDUwMDApCiAgICAgIH0KICAgICAgbm9pc2VTdHJlYW0udXNlckRhdGEgPSBwcm90b2NvbAogICAgfQoKICAgIGlmIChvcHRzLm9uZGlzY292ZXJ5a2V5KSB7CiAgICAgIG5vaXNlU3RyZWFtLnVzZXJEYXRhLnBhaXIoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScgfSwgb3B0cy5vbmRpc2NvdmVyeWtleSkKICAgIH0KCiAgICByZXR1cm4gb3V0ZXJTdHJlYW0KICB9CgogIHN0YXRpYyBkZWZhdWx0U3RvcmFnZShzdG9yYWdlLCBvcHRzID0ge30pIHsKICAgIGlmIChDb3JlU3RvcmFnZS5pc0NvcmVTdG9yYWdlKHN0b3JhZ2UpKSByZXR1cm4gc3RvcmFnZQoKICAgIGNvbnN0IGRpcmVjdG9yeSA9IHN0b3JhZ2UKICAgIHJldHVybiBuZXcgQ29yZVN0b3JhZ2UoZGlyZWN0b3J5LCBvcHRzKQogIH0KCiAgc3RhdGljIGNsZWFyUmVxdWVzdHMoc2Vzc2lvbiwgZXJyKSB7CiAgICByZXR1cm4gUmVwbGljYXRvci5jbGVhclJlcXVlc3RzKHNlc3Npb24sIGVycikKICB9CgogIHNuYXBzaG90KG9wdHMpIHsKICAgIHJldHVybiB0aGlzLnNlc3Npb24oeyAuLi5vcHRzLCBzbmFwc2hvdDogdHJ1ZSB9KQogIH0KCiAgY29tcGFjdCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUuY29tcGFjdCgpCiAgfQoKICBzZXNzaW9uKG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuY2xvc2luZykgewogICAgICAvLyBUaGlzIG1ha2VzIHRoZSBjbG9zaW5nIGxvZ2ljIGEgbG90IGVhc2llci4gSWYgdGhpcyB0dXJucyBvdXQgdG8gYmUgYSBwcm9ibGVtCiAgICAgIC8vIGluIHByYWN0aWNlLCBvcGVuIGFuIGlzc3VlIGFuZCB3ZSdsbCB0cnkgdG8gbWFrZSBhIHNvbHV0aW9uIGZvciBpdC4KICAgICAgdGhyb3cgU0VTU0lPTl9DTE9TRUQoJ0Nhbm5vdCBtYWtlIHNlc3Npb25zIG9uIGEgY2xvc2luZyBjb3JlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CiAgICBpZiAob3B0cy5jaGVja291dCAhPT0gdW5kZWZpbmVkICYmICFvcHRzLm5hbWUgJiYgIW9wdHMuYXRvbSkgewogICAgICB0aHJvdyBBU1NFUlRJT04oJ0NoZWNrb3V0cyBhcmUgb25seSBzdXBwb3J0ZWQgb24gYXRvbXMgb3IgbmFtZWQgc2Vzc2lvbnMnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBjb25zdCB3YWl0ID0gb3B0cy53YWl0ID09PSBmYWxzZSA/IGZhbHNlIDogdGhpcy53YWl0CiAgICBjb25zdCB3cml0YWJsZSA9IG9wdHMud3JpdGFibGUgPT09IHVuZGVmaW5lZCA/ICF0aGlzLl9yZWFkb25seSA6IG9wdHMud3JpdGFibGUgPT09IHRydWUKICAgIGNvbnN0IG9ud2FpdCA9IG9wdHMub253YWl0ID09PSB1bmRlZmluZWQgPyB0aGlzLm9ud2FpdCA6IG9wdHMub253YWl0CiAgICBjb25zdCBvbnNlcSA9IG9wdHMub25zZXEgPT09IHVuZGVmaW5lZCA/IHRoaXMub25zZXEgOiBvcHRzLm9uc2VxCiAgICBjb25zdCB0aW1lb3V0ID0gb3B0cy50aW1lb3V0ID09PSB1bmRlZmluZWQgPyB0aGlzLnRpbWVvdXQgOiBvcHRzLnRpbWVvdXQKICAgIGNvbnN0IHdlYWsgPSBvcHRzLndlYWsgPT09IHVuZGVmaW5lZCA/IHRoaXMud2VhayA6IG9wdHMud2VhawogICAgY29uc3QgQ2x6ID0gb3B0cy5jbGFzcyB8fCBIeXBlcmNvcmUKICAgIGNvbnN0IHMgPSBuZXcgQ2x6KG51bGwsIHRoaXMua2V5LCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIHdhaXQsCiAgICAgIG9ud2FpdCwKICAgICAgb25zZXEsCiAgICAgIHRpbWVvdXQsCiAgICAgIHdyaXRhYmxlLAogICAgICB3ZWFrLAogICAgICBwYXJlbnQ6IHRoaXMKICAgIH0pCgogICAgcmV0dXJuIHMKICB9CgogIGFzeW5jIHNldEVuY3J5cHRpb25LZXkoa2V5LCBvcHRzKSB7CiAgICBpZiAoIXRoaXMub3BlbmVkKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGNvbnN0IGVuY3J5cHRpb24gPSB0aGlzLl9nZXRFbmNyeXB0aW9uUHJvdmlkZXIoeyBrZXksIGJsb2NrOiAhIShvcHRzICYmIG9wdHMuYmxvY2spIH0pCiAgICByZXR1cm4gdGhpcy5zZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24pCiAgfQoKICBhc3luYyBzZXRFbmNyeXB0aW9uKGVuY3J5cHRpb24pIHsKICAgIGlmICghdGhpcy5vcGVuZWQpIGF3YWl0IHRoaXMub3BlbmluZwoKICAgIGlmIChlbmNyeXB0aW9uID09PSBudWxsKSB7CiAgICAgIHRoaXMuZW5jcnlwdGlvbiA9IGVuY3J5cHRpb24KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCFpc0VuY3J5cHRpb25Qcm92aWRlcihlbmNyeXB0aW9uKSkgewogICAgICB0aHJvdyBBU1NFUlRJT04oJ1Byb3ZpZGVyIGRvZXMgbm90IHNhdGlzZnkgSHlwZXJjb3JlRW5jcnlwdGlvbiBpbnRlcmZhY2UnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICB0aGlzLmVuY3J5cHRpb24gPSBlbmNyeXB0aW9uCiAgfQoKICBzZXRLZXlQYWlyKGtleVBhaXIpIHsKICAgIHRoaXMua2V5UGFpciA9IGtleVBhaXIKICB9CgogIHNldEFjdGl2ZShib29sKSB7CiAgICBjb25zdCBhY3RpdmUgPSAhIWJvb2wKICAgIGlmIChhY3RpdmUgPT09IHRoaXMuX2FjdGl2ZSB8fCB0aGlzLmNsb3NpbmcpIHJldHVybgogICAgdGhpcy5fYWN0aXZlID0gYWN0aXZlCiAgICBpZiAoIXRoaXMub3BlbmVkKSByZXR1cm4KICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLnVwZGF0ZUFjdGl2aXR5KHRoaXMuX2FjdGl2ZSA/IDEgOiAtMSkKICB9CgogIGFzeW5jIF9vcGVuKHN0b3JhZ2UsIGtleSwgb3B0cykgewogICAgY29uc3QgcHJlbG9hZCA9IG9wdHMucHJlbG9hZCB8fCAob3B0cy5wYXJlbnQgJiYgb3B0cy5wYXJlbnQucHJlbG9hZCkKCiAgICBpZiAocHJlbG9hZCkgewogICAgICB0aGlzLnNlc3Npb25zID0gW10gLy8gaW4gY2FzZSBzb21lb25lIGxvb2tzIGF0IGl0IGxpa2Ugd2l0aCBwZWVycwogICAgICB0aGlzLnByZWxvYWQgPSBwcmVsb2FkCiAgICAgIG9wdHMgPSB7IC4uLm9wdHMsIC4uLihhd2FpdCB0aGlzLnByZWxvYWQpIH0KICAgICAgdGhpcy5wcmVsb2FkID0gbnVsbAogICAgfQoKICAgIGNvbnN0IHBhcmVudCA9IG9wdHMucGFyZW50IHx8IG51bGwKICAgIGNvbnN0IGNvcmUgPSBvcHRzLmNvcmUgfHwgKHBhcmVudCAmJiBwYXJlbnQuY29yZSkKICAgIGNvbnN0IHNlc3Npb25zID0gb3B0cy5zZXNzaW9ucyB8fCAocGFyZW50ICYmIHBhcmVudC5zZXNzaW9ucykKICAgIGNvbnN0IG9uZ2MgPSBvcHRzLm9uZ2MgfHwgKHBhcmVudCAmJiBwYXJlbnQub25nYykKCiAgICBpZiAoY29yZSkgdGhpcy5jb3JlID0gY29yZQogICAgaWYgKG9uZ2MpIHRoaXMub25nYyA9IG9uZ2MKICAgIGlmIChzZXNzaW9ucykgdGhpcy5zZXNzaW9ucyA9IHNlc3Npb25zCgogICAgaWYgKHRoaXMuc2Vzc2lvbnMgPT09IG51bGwpIHRoaXMuc2Vzc2lvbnMgPSBbXQogICAgdGhpcy5fc2Vzc2lvbkluZGV4ID0gdGhpcy5zZXNzaW9ucy5wdXNoKHRoaXMpIC0gMQoKICAgIGlmICh0aGlzLmNvcmUgPT09IG51bGwpIGluaXRPbmNlKHRoaXMsIHN0b3JhZ2UsIGtleSwgb3B0cykKICAgIGlmICh0aGlzLl9tb25pdG9ySW5kZXggPT09IC0yKSB0aGlzLmNvcmUuYWRkTW9uaXRvcih0aGlzKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX29wZW5TZXNzaW9uKG9wdHMpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKHRoaXMuY29yZS5hdXRvQ2xvc2UgJiYgdGhpcy5jb3JlLmhhc1Nlc3Npb24oKSA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuY29yZS5jbG9zZSgpCgogICAgICBpZiAodGhpcy5leGNsdXNpdmUpIHRoaXMuY29yZS51bmxvY2tFeGNsdXNpdmUoKQoKICAgICAgdGhpcy5jb3JlLnJlbW92ZU1vbml0b3IodGhpcykKICAgICAgdGhpcy5fcmVtb3ZlU2Vzc2lvbigpCgogICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gbnVsbCkgdGhpcy5zdGF0ZS5yZW1vdmVTZXNzaW9uKHRoaXMpCgogICAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIHRoaXMuZW1pdCgncmVhZHknKQoKICAgIC8vIGlmIHdlIGFyZSBhIHdlYWsgc2Vzc2lvbiB0aGUgY29yZSBtaWdodCBoYXZlIGNsb3NlZC4uLgogICAgaWYgKHRoaXMuY29yZS5jbG9zaW5nKSB0aGlzLmNsb3NlKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgfQoKICBfcmVtb3ZlU2Vzc2lvbigpIHsKICAgIGlmICh0aGlzLl9zZXNzaW9uSW5kZXggPT09IC0xKSByZXR1cm4KICAgIGNvbnN0IGhlYWQgPSB0aGlzLnNlc3Npb25zLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gdGhpcykgdGhpcy5zZXNzaW9uc1soaGVhZC5fc2Vzc2lvbkluZGV4ID0gdGhpcy5fc2Vzc2lvbkluZGV4KV0gPSBoZWFkCiAgICB0aGlzLl9zZXNzaW9uSW5kZXggPSAtMQogICAgaWYgKHRoaXMub25nYyAhPT0gbnVsbCkgdGhpcy5vbmdjKHRoaXMpCiAgfQoKICBhc3luYyBfb3BlblNlc3Npb24ob3B0cykgewogICAgaWYgKHRoaXMuY29yZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLmNvcmUucmVhZHkoKQoKICAgIGlmICh0aGlzLmtleVBhaXIgPT09IG51bGwpIHRoaXMua2V5UGFpciA9IG9wdHMua2V5UGFpciB8fCB0aGlzLmNvcmUuaGVhZGVyLmtleVBhaXIKCiAgICBjb25zdCBwYXJlbnQgPSBvcHRzLnBhcmVudCB8fCBudWxsCiAgICBpZiAocGFyZW50ICYmIHBhcmVudC5lbmNyeXB0aW9uKSB0aGlzLmVuY3J5cHRpb24gPSBwYXJlbnQuZW5jcnlwdGlvbgoKICAgIGNvbnN0IGUgPSBnZXRFbmNyeXB0aW9uT3B0aW9uKG9wdHMpCiAgICBpZiAoIXRoaXMuZW5jcnlwdGlvbikgdGhpcy5lbmNyeXB0aW9uID0gdGhpcy5fZ2V0RW5jcnlwdGlvblByb3ZpZGVyKGUpCgogICAgdGhpcy53cml0YWJsZSA9IHRoaXMuX2lzV3JpdGFibGUoKQoKICAgIGlmIChvcHRzLnZhbHVlRW5jb2RpbmcpIHsKICAgICAgdGhpcy52YWx1ZUVuY29kaW5nID0gYy5mcm9tKG9wdHMudmFsdWVFbmNvZGluZykKICAgIH0KICAgIGlmIChvcHRzLmVuY29kZUJhdGNoKSB7CiAgICAgIHRoaXMuZW5jb2RlQmF0Y2ggPSBvcHRzLmVuY29kZUJhdGNoCiAgICB9CgogICAgaWYgKHBhcmVudCkgewogICAgICBpZiAocGFyZW50Ll9zdGF0ZUluZGV4ID09PSAtMSkgYXdhaXQgcGFyZW50LnJlYWR5KCkKICAgICAgaWYgKCF0aGlzLmtleVBhaXIpIHRoaXMua2V5UGFpciA9IHBhcmVudC5rZXlQYWlyCgogICAgICBjb25zdCBwcyA9IHBhcmVudC5zdGF0ZQoKICAgICAgaWYgKHBzKSB7CiAgICAgICAgY29uc3Qgc2hvdWxkU25hcHNob3QgPSB0aGlzLnNuYXBzaG90dGVkICYmICFwcy5pc1NuYXBzaG90KCkKICAgICAgICB0aGlzLnN0YXRlID0gc2hvdWxkU25hcHNob3QgPyBhd2FpdCBwcy5zbmFwc2hvdCgpIDogcHMucmVmKCkKICAgICAgfQoKICAgICAgaWYgKHRoaXMuc25hcHNob3R0ZWQgJiYgdGhpcy5jb3JlICYmICF0aGlzLl9zbmFwc2hvdCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVNuYXBzaG90KCkKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRzLmV4Y2x1c2l2ZSAmJiBvcHRzLndyaXRhYmxlICE9PSBmYWxzZSkgewogICAgICB0aGlzLmV4Y2x1c2l2ZSA9IHRydWUKICAgICAgYXdhaXQgdGhpcy5jb3JlLmxvY2tFeGNsdXNpdmUoKQogICAgfQoKICAgIGNvbnN0IHBhcmVudFN0YXRlID0gcGFyZW50ID8gcGFyZW50LnN0YXRlIDogdGhpcy5jb3JlLnN0YXRlCiAgICBjb25zdCBjaGVja291dCA9IG9wdHMuY2hlY2tvdXQgPT09IHVuZGVmaW5lZCA/IC0xIDogb3B0cy5jaGVja291dAogICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlCgogICAgaWYgKG9wdHMuYXRvbSkgewogICAgICB0aGlzLnN0YXRlID0gYXdhaXQgcGFyZW50U3RhdGUuY3JlYXRlU2Vzc2lvbihudWxsLCBmYWxzZSwgb3B0cy5hdG9tKQogICAgICBpZiAoc3RhdGUpIHN0YXRlLnVucmVmKCkKICAgIH0gZWxzZSBpZiAob3B0cy5uYW1lKSB7CiAgICAgIC8vIHRvZG86IG5lZWQgdG8gbWFrZSBuYW1lZCBzZXNzaW9ucyBzYWZlIGJlZm9yZSByZWFkeQogICAgICAvLyBhdG0gd2UgYWx3YXlzIGNvcHkgdGhlIHN0YXRlIGluIHBhc3NDYXBhYmlsaXRpZXMKICAgICAgdGhpcy5zdGF0ZSA9IGF3YWl0IHBhcmVudFN0YXRlLmNyZWF0ZVNlc3Npb24ob3B0cy5uYW1lLCAhIW9wdHMub3ZlcndyaXRlLCBudWxsKQogICAgICBpZiAoc3RhdGUpIHN0YXRlLnVucmVmKCkgLy8gcmVmJ2VkIGFib3ZlIGluIHNldHVwIHNlc3Npb24KICAgIH0KCiAgICBpZiAodGhpcy5zdGF0ZSAmJiBjaGVja291dCAhPT0gLTEpIHsKICAgICAgaWYgKCFvcHRzLm5hbWUgJiYgIW9wdHMuYXRvbSkgewogICAgICAgIHRocm93IEFTU0VSVElPTignQ2hlY2tvdXRzIG11c3QgYmUgbmFtZWQgb3IgYXRvbWl6ZWQnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgfQogICAgICBpZiAoY2hlY2tvdXQgPiB0aGlzLnN0YXRlLmxlbmd0aCkgewogICAgICAgIHRocm93IEFTU0VSVElPTigKICAgICAgICAgIGBJbnZhbGlkIGNoZWNrb3V0ICR7Y2hlY2tvdXR9IGZvciAke29wdHMubmFtZX0sIGxlbmd0aCBpcyAke3RoaXMuc3RhdGUubGVuZ3RofWAsCiAgICAgICAgICB0aGlzLmRpc2NvdmVyeUtleQogICAgICAgICkKICAgICAgfQogICAgICBpZiAodGhpcy5zdGF0ZS5wcm9sb2d1ZSAmJiBjaGVja291dCA8IHRoaXMuc3RhdGUucHJvbG9ndWUubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgQVNTRVJUSU9OKAogICAgICAgICAgYEludmFsaWQgY2hlY2tvdXQgJHtjaGVja291dH0gZm9yICR7b3B0cy5uYW1lfSwgcHJvbG9ndWUgbGVuZ3RoIGlzICR7dGhpcy5zdGF0ZS5wcm9sb2d1ZS5sZW5ndGh9YCwKICAgICAgICAgIHRoaXMuZGlzY292ZXJ5S2V5CiAgICAgICAgKQogICAgICB9CiAgICAgIGlmIChjaGVja291dCA8IHRoaXMuc3RhdGUubGVuZ3RoKSBhd2FpdCB0aGlzLnN0YXRlLnRydW5jYXRlKGNoZWNrb3V0LCB0aGlzLmZvcmspCiAgICB9CgogICAgaWYgKHRoaXMuc3RhdGUgPT09IG51bGwpIHsKICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMuY29yZS5zdGF0ZS5yZWYoKQogICAgfQoKICAgIHRoaXMud3JpdGFibGUgPSB0aGlzLl9pc1dyaXRhYmxlKCkKCiAgICBpZiAodGhpcy5zbmFwc2hvdHRlZCAmJiB0aGlzLmNvcmUpIHRoaXMuX3VwZGF0ZVNuYXBzaG90KCkKCiAgICB0aGlzLnN0YXRlLmFkZFNlc3Npb24odGhpcykKICAgIC8vIFRPRE86IHdlIG5lZWQgdG8gcmV3b3JrIHRoZSBjb3JlIHJlZmVyZW5jZSBmbG93LCBhcyB0aGUgc3RhdGUgYW5kIHNlc3Npb24gZG8gbm90IGFsd2F5cyBhZ3JlZSBub3cgZHVlIHRvIG1vdmVUbwogICAgdGhpcy5jb3JlID0gdGhpcy5zdGF0ZS5jb3JlIC8vIGluIGNhc2UgaXQgd2FzIHdyb25nLi4uCgogICAgaWYgKG9wdHMudXNlckRhdGEpIHsKICAgICAgY29uc3QgdHggPSB0aGlzLnN0YXRlLnN0b3JhZ2Uud3JpdGUoKQogICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvcHRzLnVzZXJEYXRhKSkgewogICAgICAgIHR4LnB1dFVzZXJEYXRhKGtleSwgdmFsdWUpCiAgICAgIH0KICAgICAgYXdhaXQgdHguZmx1c2goKQogICAgfQoKICAgIGlmIChvcHRzLm1hbmlmZXN0ICYmICF0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIGF3YWl0IHRoaXMuY29yZS5zZXRNYW5pZmVzdChjcmVhdGVNYW5pZmVzdChvcHRzLm1hbmlmZXN0KSkKICAgIH0KCiAgICB0aGlzLmNvcmUucmVwbGljYXRvci51cGRhdGVBY3Rpdml0eSh0aGlzLl9hY3RpdmUgPyAxIDogMCkKCiAgICB0aGlzLm9wZW5lZCA9IHRydWUKICB9CgogIGdldCByZXBsaWNhdG9yKCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUucmVwbGljYXRvcgogIH0KCiAgX2dldFNuYXBzaG90KCkgewogICAgcmV0dXJuIHsKICAgICAgbGVuZ3RoOiB0aGlzLnN0YXRlLmxlbmd0aCwKICAgICAgYnl0ZUxlbmd0aDogdGhpcy5zdGF0ZS5ieXRlTGVuZ3RoLAogICAgICBmb3JrOiB0aGlzLnN0YXRlLmZvcmsKICAgIH0KICB9CgogIF91cGRhdGVTbmFwc2hvdCgpIHsKICAgIGNvbnN0IHByZXYgPSB0aGlzLl9zbmFwc2hvdAogICAgY29uc3QgbmV4dCA9ICh0aGlzLl9zbmFwc2hvdCA9IHRoaXMuX2dldFNuYXBzaG90KCkpCgogICAgaWYgKCFwcmV2KSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuIHByZXYubGVuZ3RoICE9PSBuZXh0Lmxlbmd0aCB8fCBwcmV2LmZvcmsgIT09IG5leHQuZm9yawogIH0KCiAgX2lzV3JpdGFibGUoKSB7CiAgICBpZiAodGhpcy5fcmVhZG9ubHkpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuc3RhdGUgJiYgIXRoaXMuc3RhdGUuaXNEZWZhdWx0KCkpIHJldHVybiB0cnVlCiAgICByZXR1cm4gISEodGhpcy5rZXlQYWlyICYmIHRoaXMua2V5UGFpci5zZWNyZXRLZXkpCiAgfQoKICBjbG9zZSh7IGVycm9yIH0gPSB7fSkgewogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuIHRoaXMuY2xvc2luZwoKICAgIHRoaXMuY2xvc2luZyA9IHRoaXMuX2Nsb3NlKGVycm9yIHx8IG51bGwpCiAgICByZXR1cm4gdGhpcy5jbG9zaW5nCiAgfQoKICBjbGVhclJlcXVlc3RzKGFjdGl2ZVJlcXVlc3RzLCBlcnJvcikgewogICAgaWYgKCFhY3RpdmVSZXF1ZXN0cy5sZW5ndGgpIHJldHVybgogICAgaWYgKHRoaXMuY29yZSkgdGhpcy5jb3JlLnJlcGxpY2F0b3IuY2xlYXJSZXF1ZXN0cyhhY3RpdmVSZXF1ZXN0cywgZXJyb3IpCiAgfQoKICBhc3luYyBfY2xvc2UoZXJyb3IpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLm9wZW5pbmcKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKCF0aGlzLmNsb3NlZCkgdGhyb3cgZXJyCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5jbG9zZWQgPT09IHRydWUpIHJldHVybgoKICAgIHRoaXMuY29yZS5yZW1vdmVNb25pdG9yKHRoaXMpCiAgICB0aGlzLnN0YXRlLnJlbW92ZVNlc3Npb24odGhpcykKICAgIHRoaXMuX3JlbW92ZVNlc3Npb24oKQoKICAgIHRoaXMucmVhZGFibGUgPSBmYWxzZQogICAgdGhpcy53cml0YWJsZSA9IGZhbHNlCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCgogICAgY29uc3QgZ2MgPSBbXQogICAgZm9yIChjb25zdCBleHQgb2YgdGhpcy5leHRlbnNpb25zLnZhbHVlcygpKSB7CiAgICAgIGlmIChleHQuc2Vzc2lvbiA9PT0gdGhpcykgZ2MucHVzaChleHQpCiAgICB9CiAgICBmb3IgKGNvbnN0IGV4dCBvZiBnYykgZXh0LmRlc3Ryb3koKQoKICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLmZpbmRpbmdQZWVycyAtPSB0aGlzLl9maW5kaW5nUGVlcnMKICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLmNsZWFyUmVxdWVzdHModGhpcy5hY3RpdmVSZXF1ZXN0cywgZXJyb3IpCiAgICB0aGlzLmNvcmUucmVwbGljYXRvci51cGRhdGVBY3Rpdml0eSh0aGlzLl9hY3RpdmUgPyAtMSA6IDApCgogICAgdGhpcy5fZmluZGluZ1BlZXJzID0gMAoKICAgIHRoaXMuc3RhdGUudW5yZWYoKQoKICAgIGlmICh0aGlzLmV4Y2x1c2l2ZSkgdGhpcy5jb3JlLnVubG9ja0V4Y2x1c2l2ZSgpCgogICAgaWYgKHRoaXMuY29yZS5oYXNTZXNzaW9uKCkpIHsKICAgICAgLy8gZW1pdCAiZmFrZSIgY2xvc2UgYXMgdGhpcyBpcyBhIHNlc3Npb24KICAgICAgdGhpcy5jbG9zZWQgPSB0cnVlCiAgICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLmF1dG9DbG9zZSkgYXdhaXQgdGhpcy5jb3JlLmNsb3NlKCkKCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgYXN5bmMgY29tbWl0KHNlc3Npb24sIG9wdHMpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQogICAgYXdhaXQgc2Vzc2lvbi5yZWFkeSgpCgogICAgcmV0dXJuIHRoaXMuc3RhdGUuY29tbWl0KHNlc3Npb24uc3RhdGUsIHsga2V5UGFpcjogdGhpcy5rZXlQYWlyLCAuLi5vcHRzIH0pCiAgfQoKICByZXBsaWNhdGUoaXNJbml0aWF0b3IsIG9wdHMgPSB7fSkgewogICAgLy8gT25seSBsaW1pdGF0aW9uIGhlcmUgaXMgdGhhdCBvbmRpc2NvdmVyeWtleSBkb2Vzbid0IHdvcmsgYXRtIHdoZW4gcGFzc2luZyBhIG11eGVyIGRpcmVjdGx5LAogICAgLy8gYmVjYXVzZSBpdCBkb2Vzbid0IHJlYWxseSBtYWtlIGEgbG90IG9mIHNlbnNlLgogICAgaWYgKFByb3RvbXV4LmlzUHJvdG9tdXgoaXNJbml0aWF0b3IpKSByZXR1cm4gdGhpcy5fYXR0YWNoVG9NdXhlcihpc0luaXRpYXRvcikKCiAgICAvLyBpZiBzYW1lIHN0cmVhbSBpcyBwYXNzZWQgdHdpY2UsIGlnbm9yZSB0aGUgMm5kIG9uZSBiZWZvcmUgd2UgbWFrZSBzZXNzaW9ucyBldGMKICAgIGlmIChpc1N0cmVhbShpc0luaXRpYXRvcikgJiYgdGhpcy5faXNBdHRhY2hlZChpc0luaXRpYXRvcikpIHJldHVybiBpc0luaXRpYXRvcgoKICAgIGNvbnN0IHByb3RvY29sU3RyZWFtID0gSHlwZXJjb3JlLmNyZWF0ZVByb3RvY29sU3RyZWFtKGlzSW5pdGlhdG9yLCBvcHRzKQogICAgY29uc3Qgbm9pc2VTdHJlYW0gPSBwcm90b2NvbFN0cmVhbS5ub2lzZVN0cmVhbQogICAgY29uc3QgcHJvdG9jb2wgPSBub2lzZVN0cmVhbS51c2VyRGF0YQoKICAgIHRoaXMuX2F0dGFjaFRvTXV4ZXIocHJvdG9jb2wpCgogICAgcmV0dXJuIHByb3RvY29sU3RyZWFtCiAgfQoKICBfaXNBdHRhY2hlZChzdHJlYW0pIHsKICAgIHJldHVybiAoCiAgICAgIHN0cmVhbS51c2VyRGF0YSAmJgogICAgICB0aGlzLmNvcmUgJiYKICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IgJiYKICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXR0YWNoZWQoc3RyZWFtLnVzZXJEYXRhKQogICAgKQogIH0KCiAgX2F0dGFjaFRvTXV4ZXIobXV4KSB7CiAgICBpZiAodGhpcy5vcGVuZWQpIHsKICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXR0YWNoVG8obXV4KQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5vcGVuaW5nLnRoZW4oKCkgPT4gdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXR0YWNoVG8obXV4KSwgbXV4LmRlc3Ryb3kuYmluZChtdXgpKQogICAgfQoKICAgIHJldHVybiBtdXgKICB9CgogIGdldCBpZCgpIHsKICAgIHJldHVybiB0aGlzLmNvcmUgPT09IG51bGwgPyBudWxsIDogdGhpcy5jb3JlLmlkCiAgfQoKICBnZXQga2V5KCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUua2V5CiAgfQoKICBnZXQgZGlzY292ZXJ5S2V5KCkgewogICAgcmV0dXJuIHRoaXMuY29yZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5CiAgfQoKICBnZXQgbWFuaWZlc3QoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlID09PSBudWxsID8gbnVsbCA6IHRoaXMuY29yZS5tYW5pZmVzdAogIH0KCiAgZ2V0IGxlbmd0aCgpIHsKICAgIGlmICh0aGlzLl9zbmFwc2hvdCkgcmV0dXJuIHRoaXMuX3NuYXBzaG90Lmxlbmd0aAogICAgcmV0dXJuIHRoaXMub3BlbmVkID09PSBmYWxzZSA/IDAgOiB0aGlzLnN0YXRlLmxlbmd0aAogIH0KCiAgZ2V0IHNpZ25lZExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLm9wZW5lZCA9PT0gZmFsc2UgPyAwIDogdGhpcy5zdGF0ZS5zaWduZWRMZW5ndGgoKQogIH0KCiAgLyoqCiAgICogRGVwcmVjYXRlZC4gVXNlIGBjb25zdCB7IGJ5dGVMZW5ndGggfSA9IGF3YWl0IGNvcmUuaW5mbygpYC4KICAgKi8KICBnZXQgYnl0ZUxlbmd0aCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHJldHVybiAwCiAgICBpZiAodGhpcy5fc25hcHNob3QpIHJldHVybiB0aGlzLl9zbmFwc2hvdC5ieXRlTGVuZ3RoCiAgICByZXR1cm4gdGhpcy5zdGF0ZS5ieXRlTGVuZ3RoIC0gdGhpcy5zdGF0ZS5sZW5ndGggKiB0aGlzLnBhZGRpbmcKICB9CgogIGdldCByZW1vdGVDb250aWd1b3VzTGVuZ3RoKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgcmV0dXJuIDAKICAgIHJldHVybiBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpCiAgfQoKICBnZXQgY29udGlndW91c0xlbmd0aCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIHJldHVybiAwCiAgICByZXR1cm4gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQogIH0KCiAgZ2V0IGNvbnRpZ3VvdXNCeXRlTGVuZ3RoKCkgewogICAgcmV0dXJuIDAKICB9CgogIGdldCBmb3JrKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgcmV0dXJuIDAKICAgIHJldHVybiB0aGlzLnN0YXRlLmZvcmsKICB9CgogIGdldCBwYWRkaW5nKCkgewogICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAmJiB0aGlzLmtleSAmJiB0aGlzLm1hbmlmZXN0KSB7CiAgICAgIHJldHVybiB0aGlzLmVuY3J5cHRpb24ucGFkZGluZyh0aGlzLmNvcmUsIHRoaXMubGVuZ3RoKQogICAgfQoKICAgIHJldHVybiAwCiAgfQoKICBnZXQgcGVlcnMoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuZWQgPT09IGZhbHNlID8gW10gOiB0aGlzLmNvcmUucmVwbGljYXRvci5wZWVycwogIH0KCiAgZ2V0IGdsb2JhbENhY2hlKCkgewogICAgcmV0dXJuIHRoaXMub3BlbmVkID09PSBmYWxzZSA/IG51bGwgOiB0aGlzLmNvcmUuZ2xvYmFsQ2FjaGUKICB9CgogIHJlYWR5KCkgewogICAgcmV0dXJuIHRoaXMub3BlbmluZwogIH0KCiAgYXN5bmMgc2V0VXNlckRhdGEoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMuZ2V0VXNlckRhdGEoa2V5KQogICAgaWYgKGV4aXN0aW5nICYmIGI0YS5pc0J1ZmZlcih2YWx1ZSkgJiYgYjRhLmVxdWFscyhleGlzdGluZywgdmFsdWUpKSByZXR1cm4KICAgIGF3YWl0IHRoaXMuc3RhdGUuc2V0VXNlckRhdGEoa2V5LCB2YWx1ZSkKICB9CgogIGFzeW5jIGdldFVzZXJEYXRhKGtleSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IHAgPSBiYXRjaC5nZXRVc2VyRGF0YShrZXkpCiAgICBiYXRjaC50cnlGbHVzaCgpCiAgICByZXR1cm4gcAogIH0KCiAgdHJhbnNmZXJTZXNzaW9uKGNvcmUpIHsKICAgIC8vIHRvZG86IHZhbGlkYXRlIHdlIGNhbiBtb3ZlCgogICAgaWYgKHRoaXMud2VhayA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5jb3JlLmFjdGl2ZVNlc3Npb25zLS0KICAgICAgY29yZS5hY3RpdmVTZXNzaW9ucysrCiAgICB9CgogICAgaWYgKHRoaXMuX21vbml0b3JJbmRleCA+PSAwKSB7CiAgICAgIHRoaXMuY29yZS5yZW1vdmVNb25pdG9yKHRoaXMpCiAgICAgIGNvcmUuYWRkTW9uaXRvcih0aGlzKQogICAgfQoKICAgIGNvbnN0IG9sZCA9IHRoaXMuY29yZQoKICAgIHRoaXMuY29yZSA9IGNvcmUKCiAgICBvbGQucmVwbGljYXRvci5jbGVhclJlcXVlc3RzKHRoaXMuYWN0aXZlUmVxdWVzdHMsIFNFU1NJT05fTU9WRUQoKSkKCiAgICB0aGlzLmVtaXQoJ21pZ3JhdGUnLCB0aGlzLmtleSkKICB9CgogIGZpbmRpbmdQZWVycygpIHsKICAgIHRoaXMuX2ZpbmRpbmdQZWVycysrCiAgICBpZiAodGhpcy5jb3JlICE9PSBudWxsICYmICF0aGlzLmNsb3NpbmcpIHRoaXMuY29yZS5yZXBsaWNhdG9yLmZpbmRpbmdQZWVycysrCgogICAgbGV0IG9uY2UgPSB0cnVlCgogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHRoaXMuY2xvc2luZyB8fCAhb25jZSkgcmV0dXJuCiAgICAgIG9uY2UgPSBmYWxzZQogICAgICB0aGlzLl9maW5kaW5nUGVlcnMtLQogICAgICBpZiAodGhpcy5jb3JlICE9PSBudWxsICYmIC0tdGhpcy5jb3JlLnJlcGxpY2F0b3IuZmluZGluZ1BlZXJzID09PSAwKSB7CiAgICAgICAgdGhpcy5jb3JlLnJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgaW5mbyhvcHRzKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKCiAgICByZXR1cm4gSW5mby5mcm9tKHRoaXMsIG9wdHMpCiAgfQoKICBhc3luYyB1cGRhdGUob3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLnNuYXBzaG90dGVkKSByZXR1cm4gZmFsc2UKCiAgICBpZiAodGhpcy53cml0YWJsZSAmJiAoIW9wdHMgfHwgb3B0cy5mb3JjZSAhPT0gdHJ1ZSkpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHJlbW90ZVdhaXQgPSB0aGlzLl9zaG91bGRXYWl0KG9wdHMsIHRoaXMuY29yZS5yZXBsaWNhdG9yLmZpbmRpbmdQZWVycyA+IDApCgogICAgbGV0IHVwZ3JhZGVkID0gZmFsc2UKCiAgICBpZiAoYXdhaXQgdGhpcy5jb3JlLnJlcGxpY2F0b3IuYXBwbHlQZW5kaW5nUmVvcmcoKSkgewogICAgICB1cGdyYWRlZCA9IHRydWUKICAgIH0KCiAgICBpZiAoIXVwZ3JhZGVkICYmIHJlbW90ZVdhaXQpIHsKICAgICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSAob3B0cyAmJiBvcHRzLmFjdGl2ZVJlcXVlc3RzKSB8fCB0aGlzLmFjdGl2ZVJlcXVlc3RzCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuY29yZS5yZXBsaWNhdG9yLmFkZFVwZ3JhZGUoYWN0aXZlUmVxdWVzdHMpCgogICAgICB0cnkgewogICAgICAgIHVwZ3JhZGVkID0gYXdhaXQgcmVxLnByb21pc2UKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLnVwZGF0ZShvcHRzKQogICAgICAgIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgaWYgKCF1cGdyYWRlZCkgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgc2VlayhieXRlcywgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAoIWlzVmFsaWRJbmRleChieXRlcykpIHRocm93IEFTU0VSVElPTignc2VlayBpcyBpbnZhbGlkJywgdGhpcy5kaXNjb3ZlcnlLZXkpCgogICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSAob3B0cyAmJiBvcHRzLmFjdGl2ZVJlcXVlc3RzKSB8fCB0aGlzLmFjdGl2ZVJlcXVlc3RzCgogICAgaWYgKHRoaXMuZW5jcnlwdGlvbiAmJiAhdGhpcy5jb3JlLm1hbmlmZXN0KSB7CiAgICAgIGNvbnN0IHJlcSA9IHRoaXMucmVwbGljYXRvci5hZGRVcGdyYWRlKGFjdGl2ZVJlcXVlc3RzKQogICAgICB0cnkgewogICAgICAgIGF3YWl0IHJlcS5wcm9taXNlCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChpc1Nlc3Npb25Nb3ZlZChlcnIpKSByZXR1cm4gdGhpcy5zZWVrKGJ5dGVzLCBvcHRzKQogICAgICAgIHRocm93IGVycgogICAgICB9CiAgICB9CgogICAgY29uc3QgcyA9IE1lcmtsZVRyZWUuc2Vlayh0aGlzLnN0YXRlLCBieXRlcywgdGhpcy5wYWRkaW5nKQoKICAgIGNvbnN0IG9mZnNldCA9IGF3YWl0IHMudXBkYXRlKCkKICAgIGlmIChvZmZzZXQpIHJldHVybiBvZmZzZXQKCiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSB7CiAgICAgIHRocm93IFNFU1NJT05fQ0xPU0VEKCdjYW5ub3Qgc2VlayBvbiBhIGNsb3NlZCBzZXNzaW9uJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgaWYgKCF0aGlzLl9zaG91bGRXYWl0KG9wdHMsIHRoaXMud2FpdCkpIHJldHVybiBudWxsCgogICAgY29uc3QgcmVxID0gdGhpcy5jb3JlLnJlcGxpY2F0b3IuYWRkU2VlayhhY3RpdmVSZXF1ZXN0cywgcykKCiAgICBjb25zdCB0aW1lb3V0ID0gb3B0cyAmJiBvcHRzLnRpbWVvdXQgIT09IHVuZGVmaW5lZCA/IG9wdHMudGltZW91dCA6IHRoaXMudGltZW91dAogICAgaWYgKHRpbWVvdXQpIHJlcS5jb250ZXh0LnNldFRpbWVvdXQocmVxLCB0aW1lb3V0KQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCByZXEucHJvbWlzZQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChpc1Nlc3Npb25Nb3ZlZChlcnIpKSByZXR1cm4gdGhpcy5zZWVrKGJ5dGVzLCBvcHRzKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIGFzeW5jIGhhcyhzdGFydCwgZW5kID0gc3RhcnQgKyAxKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICghaXNWYWxpZEluZGV4KHN0YXJ0KSB8fCAhaXNWYWxpZEluZGV4KGVuZCkpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKCdoYXMgcmFuZ2UgaXMgaW52YWxpZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGlmICh0aGlzLnN0YXRlLmlzRGVmYXVsdCgpKSB7CiAgICAgIGlmIChlbmQgPT09IHN0YXJ0ICsgMSkgcmV0dXJuIHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoc3RhcnQpCgogICAgICBjb25zdCBpID0gdGhpcy5jb3JlLmJpdGZpZWxkLmZpcnN0VW5zZXQoc3RhcnQpCiAgICAgIHJldHVybiBpID09PSAtMSB8fCBpID49IGVuZAogICAgfQoKICAgIGlmIChlbmQgPT09IHN0YXJ0ICsgMSkgewogICAgICBjb25zdCByeCA9IHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCkKICAgICAgY29uc3QgYmxvY2sgPSByeC5nZXRCbG9jayhzdGFydCkKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgcmV0dXJuIChhd2FpdCBibG9jaykgIT09IG51bGwKICAgIH0KCiAgICBsZXQgY291bnQgPSAwCgogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdGF0ZS5zdG9yYWdlLmNyZWF0ZUJsb2NrU3RyZWFtKHsgZ3RlOiBzdGFydCwgbHQ6IGVuZCB9KQogICAgZm9yIGF3YWl0IChjb25zdCBibG9jayBvZiBzdHJlYW0pIHsKICAgICAgaWYgKGJsb2NrID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgICAgY291bnQrKwogICAgfQoKICAgIHJldHVybiBjb3VudCA9PT0gZW5kIC0gc3RhcnQKICB9CgogIGFzeW5jIGdldChpbmRleCwgb3B0cykgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAoIWlzVmFsaWRJbmRleChpbmRleCkpIHRocm93IEFTU0VSVElPTignYmxvY2sgaW5kZXggaXMgaW52YWxpZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQoKICAgIGlmICh0aGlzLmNsb3NpbmcgIT09IG51bGwpIHsKICAgICAgdGhyb3cgU0VTU0lPTl9DTE9TRUQoJ2Nhbm5vdCBnZXQgb24gYSBjbG9zZWQgc2Vzc2lvbicsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGNvbnN0IGVuY29kaW5nID0KICAgICAgKG9wdHMgJiYgb3B0cy52YWx1ZUVuY29kaW5nICYmIGMuZnJvbShvcHRzLnZhbHVlRW5jb2RpbmcpKSB8fCB0aGlzLnZhbHVlRW5jb2RpbmcKCiAgICBpZiAodGhpcy5vbnNlcSAhPT0gbnVsbCkgdGhpcy5vbnNlcShpbmRleCwgdGhpcykKCiAgICBjb25zdCByZXEgPSB0aGlzLl9nZXQoaW5kZXgsIG9wdHMpCgogICAgbGV0IGJsb2NrID0gYXdhaXQgcmVxCiAgICBpZiAoIWJsb2NrKSByZXR1cm4gbnVsbAoKICAgIGlmIChvcHRzICYmIG9wdHMucmF3KSByZXR1cm4gYmxvY2sKCiAgICBpZiAodGhpcy5lbmNyeXB0aW9uICYmICghb3B0cyB8fCBvcHRzLmRlY3J5cHQgIT09IGZhbHNlKSkgewogICAgICAvLyBDb3B5IHRoZSBibG9jayBhcyBpdCBtaWdodCBiZSBzaGFyZWQgd2l0aCBvdGhlciBzZXNzaW9ucy4KICAgICAgYmxvY2sgPSBiNGEuZnJvbShibG9jaykKCiAgICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5kZWNyeXB0KGluZGV4LCBibG9jaywgdGhpcy5jb3JlKQogICAgfQoKICAgIHJldHVybiB0aGlzLl9kZWNvZGUoZW5jb2RpbmcsIGJsb2NrLCBpbmRleCkKICB9CgogIGFzeW5jIGNsZWFyKHN0YXJ0LCBlbmQgPSBzdGFydCArIDEsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgewogICAgICB0aHJvdyBTRVNTSU9OX0NMT1NFRCgnY2Fubm90IGNsZWFyIG9uIGEgY2xvc2VkIHNlc3Npb24nLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBpZiAodHlwZW9mIGVuZCA9PT0gJ29iamVjdCcpIHsKICAgICAgb3B0cyA9IGVuZAogICAgICBlbmQgPSBzdGFydCArIDEKICAgIH0KCiAgICBpZiAoIWlzVmFsaWRJbmRleChzdGFydCkgfHwgIWlzVmFsaWRJbmRleChlbmQpKSB7CiAgICAgIHRocm93IEFTU0VSVElPTignY2xlYXIgcmFuZ2UgaXMgaW52YWxpZCcsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIGNvbnN0IGNsZWFyZWQgPSBvcHRzICYmIG9wdHMuZGlmZiA/IHsgYmxvY2tzOiAwIH0gOiBudWxsCgogICAgaWYgKHN0YXJ0ID49IGVuZCkgcmV0dXJuIGNsZWFyZWQKICAgIGlmIChzdGFydCA+PSB0aGlzLmxlbmd0aCkgcmV0dXJuIGNsZWFyZWQKCiAgICBhd2FpdCB0aGlzLnN0YXRlLmNsZWFyKHN0YXJ0LCBlbmQsIGNsZWFyZWQpCgogICAgcmV0dXJuIGNsZWFyZWQKICB9CgogIGFzeW5jIHB1cmdlKCkgewogICAgYXdhaXQgdGhpcy5fY2xvc2VBbGxTZXNzaW9ucyhudWxsKQogICAgYXdhaXQgdGhpcy5jb3JlLnB1cmdlKCkKICB9CgogIGFzeW5jIF9nZXQoaW5kZXgsIG9wdHMpIHsKICAgIGNvbnN0IGJsb2NrID0gYXdhaXQgcmVhZEJsb2NrKHRoaXMuc3RhdGUuc3RvcmFnZS5yZWFkKCksIGluZGV4KQoKICAgIGlmIChibG9jayAhPT0gbnVsbCkgcmV0dXJuIGJsb2NrCgogICAgaWYgKHRoaXMuY2xvc2luZyAhPT0gbnVsbCkgewogICAgICB0aHJvdyBTRVNTSU9OX0NMT1NFRCgnY2Fubm90IGdldCBvbiBhIGNsb3NlZCBzZXNzaW9uJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgLy8gc25hcHNob3Qgc2hvdWxkIGNoZWNrIGlmIGNvcmUgaGFzIGJsb2NrCiAgICBpZiAodGhpcy5fc25hcHNob3QgIT09IG51bGwpIHsKICAgICAgY2hlY2tTbmFwc2hvdCh0aGlzLCBpbmRleCkKICAgICAgY29uc3QgY29yZUJsb2NrID0gYXdhaXQgcmVhZEJsb2NrKHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKSwgaW5kZXgpCgogICAgICBjaGVja1NuYXBzaG90KHRoaXMsIGluZGV4KQogICAgICBpZiAoY29yZUJsb2NrICE9PSBudWxsKSByZXR1cm4gY29yZUJsb2NrCiAgICB9CgogICAgLy8gbGV0cyBjaGVjayB0aGUgYml0ZmllbGQgdG8gc2VlIGlmIHdlIGdvdCBpdCBkdXJpbmcgdGhlIGFib3ZlIGFzeW5jIGNhbGxzCiAgICAvLyB0aGlzIGlzIHRoZSBsYXN0IHJlc29ydCBiZWZvcmUgcmVwbGljYXRpb24sIHNvIGFsd2F5cyBzYWZlLgogICAgaWYgKHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoaW5kZXgpKSB7CiAgICAgIGNvbnN0IGNvcmVCbG9jayA9IGF3YWl0IHJlYWRCbG9jayh0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpLCBpbmRleCkKICAgICAgLy8gVE9ETzogdGhpcyBzaG91bGQgbm90IGJlIG5lZWRlZCwgb25seSBuZWVkZWQgYXRtIGluIGNhc2Ugd2UgYXJlIGRvaW5nIGEgbW92ZVRvIGR1cmluZyB0aGlzICh3ZSBzaG91bGQgZml4KQogICAgICBpZiAoY29yZUJsb2NrICE9PSBudWxsKSByZXR1cm4gY29yZUJsb2NrCiAgICB9CgogICAgaWYgKCF0aGlzLl9zaG91bGRXYWl0KG9wdHMsIHRoaXMud2FpdCkpIHJldHVybiBudWxsCgogICAgaWYgKG9wdHMgJiYgb3B0cy5vbndhaXQpIG9wdHMub253YWl0KGluZGV4LCB0aGlzKQogICAgaWYgKHRoaXMub253YWl0KSB0aGlzLm9ud2FpdChpbmRleCwgdGhpcykKCiAgICBjb25zdCBhY3RpdmVSZXF1ZXN0cyA9IChvcHRzICYmIG9wdHMuYWN0aXZlUmVxdWVzdHMpIHx8IHRoaXMuYWN0aXZlUmVxdWVzdHMKCiAgICBjb25zdCByZXEgPSB0aGlzLmNvcmUucmVwbGljYXRvci5hZGRCbG9jayhhY3RpdmVSZXF1ZXN0cywgaW5kZXgpCiAgICByZXEuc25hcHNob3QgPSBpbmRleCA8IHRoaXMubGVuZ3RoCgogICAgY29uc3QgdGltZW91dCA9IG9wdHMgJiYgb3B0cy50aW1lb3V0ICE9PSB1bmRlZmluZWQgPyBvcHRzLnRpbWVvdXQgOiB0aGlzLnRpbWVvdXQKICAgIGlmICh0aW1lb3V0KSByZXEuY29udGV4dC5zZXRUaW1lb3V0KHJlcSwgdGltZW91dCkKCiAgICBsZXQgcmVwbGljYXRlZEJsb2NrID0gbnVsbAoKICAgIHRyeSB7CiAgICAgIHJlcGxpY2F0ZWRCbG9jayA9IGF3YWl0IHJlcS5wcm9taXNlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLl9nZXQoaW5kZXgsIG9wdHMpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIGlmICh0aGlzLl9zbmFwc2hvdCAhPT0gbnVsbCkgY2hlY2tTbmFwc2hvdCh0aGlzLCBpbmRleCkKICAgIHJldHVybiBtYXliZVVuc2xhYihyZXBsaWNhdGVkQmxvY2spCiAgfQoKICBfc2hvdWxkV2FpdChvcHRzLCBkZWZhdWx0VmFsdWUpIHsKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmIChvcHRzLndhaXQgPT09IGZhbHNlKSByZXR1cm4gZmFsc2UKICAgICAgaWYgKG9wdHMud2FpdCA9PT0gdHJ1ZSkgcmV0dXJuIHRydWUKICAgIH0KICAgIHJldHVybiBkZWZhdWx0VmFsdWUKICB9CgogIGNyZWF0ZVJlYWRTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIG5ldyBSZWFkU3RyZWFtKHRoaXMsIG9wdHMpCiAgfQoKICBjcmVhdGVXcml0ZVN0cmVhbSgpIHsKICAgIHJldHVybiBuZXcgV3JpdGVTdHJlYW0odGhpcykKICB9CgogIGNyZWF0ZUJ5dGVTdHJlYW0ob3B0cykgewogICAgcmV0dXJuIG5ldyBCeXRlU3RyZWFtKHRoaXMsIG9wdHMpCiAgfQoKICBkb3dubG9hZChyYW5nZSkgewogICAgcmV0dXJuIG5ldyBEb3dubG9hZCh0aGlzLCByYW5nZSkKICB9CgogIC8vIFRPRE86IGdldCByaWQgb2YgdGhpcyAvIGRlcHJlY2F0ZSBpdD8KICB1bmRvd25sb2FkKHJhbmdlKSB7CiAgICByYW5nZS5kZXN0cm95KG51bGwpCiAgfQoKICAvLyBUT0RPOiBnZXQgcmlkIG9mIHRoaXMgLyBkZXByZWNhdGUgaXQ/CiAgY2FuY2VsKHJlcXVlc3QpIHsKICAgIC8vIERvIG5vdGhpbmcgZm9yIG5vdwogIH0KCiAgYXN5bmMgdHJ1bmNhdGUobmV3TGVuZ3RoID0gMCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKCiAgICBjb25zdCB7CiAgICAgIGZvcmsgPSB0aGlzLnN0YXRlLmZvcmsgKyAxLAogICAgICBrZXlQYWlyID0gdGhpcy5rZXlQYWlyLAogICAgICBzaWduYXR1cmUgPSBudWxsCiAgICB9ID0gdHlwZW9mIG9wdHMgPT09ICdudW1iZXInID8geyBmb3JrOiBvcHRzIH0gOiBvcHRzCgogICAgY29uc3QgaXNEZWZhdWx0ID0gdGhpcy5zdGF0ZSA9PT0gdGhpcy5jb3JlLnN0YXRlCiAgICBjb25zdCB3cml0YWJsZSA9ICF0aGlzLl9yZWFkb25seSAmJiAhIShzaWduYXR1cmUgfHwgKGtleVBhaXIgJiYga2V5UGFpci5zZWNyZXRLZXkpKQogICAgaWYgKGlzRGVmYXVsdCAmJiB3cml0YWJsZSA9PT0gZmFsc2UgJiYgKG5ld0xlbmd0aCA+IDAgfHwgZm9yayAhPT0gdGhpcy5zdGF0ZS5mb3JrKSkgewogICAgICB0aHJvdyBTRVNTSU9OX05PVF9XUklUQUJMRSgnY2Fubm90IGFwcGVuZCB0byBhIG5vbi13cml0YWJsZSBjb3JlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgYXdhaXQgdGhpcy5zdGF0ZS50cnVuY2F0ZShuZXdMZW5ndGgsIGZvcmssIHsga2V5UGFpciwgc2lnbmF0dXJlIH0pCgogICAgLy8gVE9ETzogU2hvdWxkIHByb3BhZ2F0ZSBmcm9tIGFuIGV2ZW50IHRyaWdnZXJlZCBieSB0aGUgb3Bsb2cKICAgIGlmICh0aGlzLnN0YXRlID09PSB0aGlzLmNvcmUuc3RhdGUpIHRoaXMuY29yZS5yZXBsaWNhdG9yLnVwZGF0ZUFsbCgpCiAgfQoKICBhc3luYyBhcHBlbmQoYmxvY2tzLCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwoKICAgIGNvbnN0IGlzRGVmYXVsdCA9IHRoaXMuc3RhdGUgPT09IHRoaXMuY29yZS5zdGF0ZQogICAgY29uc3QgZGVmYXVsdEtleVBhaXIgPSB0aGlzLnN0YXRlLm5hbWUgPT09IG51bGwgPyB0aGlzLmtleVBhaXIgOiBudWxsCgogICAgY29uc3QgeyBrZXlQYWlyID0gZGVmYXVsdEtleVBhaXIsIHNpZ25hdHVyZSA9IG51bGwsIG1heExlbmd0aCwgcG9zdGFwcGVuZCA9IG51bGwgfSA9IG9wdHMKICAgIGNvbnN0IHdyaXRhYmxlID0KICAgICAgIWlzRGVmYXVsdCB8fCAhIXNpZ25hdHVyZSB8fCAhIShrZXlQYWlyICYmIGtleVBhaXIuc2VjcmV0S2V5KSB8fCBvcHRzLndyaXRhYmxlID09PSB0cnVlCgogICAgaWYgKHRoaXMuX3JlYWRvbmx5IHx8IHdyaXRhYmxlID09PSBmYWxzZSkgewogICAgICB0aHJvdyBTRVNTSU9OX05PVF9XUklUQUJMRSgnY2Fubm90IGFwcGVuZCB0byBhIHJlYWRvbmx5IGNvcmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICBibG9ja3MgPSBBcnJheS5pc0FycmF5KGJsb2NrcykgPyBibG9ja3MgOiBbYmxvY2tzXQoKICAgIGNvbnN0IHByZWFwcGVuZCA9IHRoaXMuZW5jcnlwdGlvbiAmJiB0aGlzLl9wcmVhcHBlbmQKCiAgICBjb25zdCBidWZmZXJzID0gdGhpcy5lbmNvZGVCYXRjaCAhPT0gbnVsbCA/IHRoaXMuZW5jb2RlQmF0Y2goYmxvY2tzKSA6IG5ldyBBcnJheShibG9ja3MubGVuZ3RoKQoKICAgIGlmICh0aGlzLmVuY29kZUJhdGNoID09PSBudWxsKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYnVmZmVyc1tpXSA9IHRoaXMuX2VuY29kZSh0aGlzLnZhbHVlRW5jb2RpbmcsIGJsb2Nrc1tpXSkKICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCBiIG9mIGJ1ZmZlcnMpIHsKICAgICAgaWYgKGIuYnl0ZUxlbmd0aCA+IE1BWF9TVUdHRVNURURfQkxPQ0tfU0laRSkgewogICAgICAgIHRocm93IEJBRF9BUkdVTUVOVCgKICAgICAgICAgICdBcHBlbmRlZCBibG9jayBleGNlZWRzIHRoZSBtYXhpbXVtIHN1Z2dlc3RlZCBibG9jayBzaXplJywKICAgICAgICAgIHRoaXMuZGlzY292ZXJ5S2V5CiAgICAgICAgKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuc3RhdGUuYXBwZW5kKGJ1ZmZlcnMsIHsga2V5UGFpciwgc2lnbmF0dXJlLCBwcmVhcHBlbmQsIHBvc3RhcHBlbmQsIG1heExlbmd0aCB9KQogIH0KCiAgYXN5bmMgc2lnbmFibGUobGVuZ3RoID0gLTEsIGZvcmsgPSAtMSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAobGVuZ3RoID09PSAtMSkgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgIGlmIChmb3JrID09PSAtMSkgZm9yayA9IHRoaXMuZm9yawoKICAgIHJldHVybiBjYXBzLnRyZWVTaWduYWJsZSh0aGlzLmtleSwgYXdhaXQgdGhpcy50cmVlSGFzaChsZW5ndGgpLCBsZW5ndGgsIGZvcmspCiAgfQoKICBhc3luYyB0cmVlSGFzaChsZW5ndGggPSAtMSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICBpZiAobGVuZ3RoID09PSAtMSkgbGVuZ3RoID0gdGhpcy5sZW5ndGgKCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHModGhpcy5zdGF0ZSwgbGVuZ3RoKQogICAgcmV0dXJuIGNyeXB0by50cmVlKHJvb3RzKQogIH0KCiAgYXN5bmMgbWlzc2luZ05vZGVzKGluZGV4KSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIHJldHVybiBhd2FpdCBNZXJrbGVUcmVlLm1pc3NpbmdOb2Rlcyh0aGlzLmNvcmUuc3RhdGUsIDIgKiBpbmRleCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICB9CgogIGFzeW5jIHByb29mKG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMub3BlbmluZwogICAgY29uc3QgcnggPSB0aGlzLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICBjb25zdCBwcm9vZlByb21pc2UgPSBNZXJrbGVUcmVlLnByb29mKHRoaXMuc3RhdGUsIHJ4LCBvcHRzKQogICAgY29uc3QgYmxvY2tQcm9taXNlID0gb3B0cyAmJiBvcHRzLmJsb2NrID8gcnguZ2V0QmxvY2sob3B0cy5ibG9jay5pbmRleCkgOiBudWxsCiAgICByeC50cnlGbHVzaCgpCiAgICBjb25zdCBbcHJvb2YsIGJsb2NrXSA9IGF3YWl0IFByb21pc2UuYWxsKFtwcm9vZlByb21pc2UsIGJsb2NrUHJvbWlzZV0pCiAgICBjb25zdCBzZXR0bGVkID0gYXdhaXQgcHJvb2Yuc2V0dGxlKCkKICAgIGlmIChibG9jaykgc2V0dGxlZC5ibG9jay52YWx1ZSA9IGJsb2NrCiAgICByZXR1cm4gc2V0dGxlZAogIH0KCiAgYXN5bmMgYXBwbHlQcm9vZihwcm9vZiwgZnJvbSkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSBmYWxzZSkgYXdhaXQgdGhpcy5vcGVuaW5nCiAgICByZXR1cm4gdGhpcy5jb3JlLnZlcmlmeShwcm9vZiwgZnJvbSkKICB9CgogIGFzeW5jIHZlcmlmeUZ1bGx5UmVtb3RlKHByb29mKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGNvbnN0IGJhdGNoID0gYXdhaXQgTWVya2xlVHJlZS52ZXJpZnlGdWxseVJlbW90ZSh0aGlzLnN0YXRlLCBwcm9vZikKICAgIGF3YWl0IHRoaXMuY29yZS5fdmVyaWZ5QmF0Y2hVcGdyYWRlKGJhdGNoLCBwcm9vZi5tYW5pZmVzdCkKICAgIHJldHVybiBiYXRjaAogIH0KCiAgcmVnaXN0ZXJFeHRlbnNpb24obmFtZSwgaGFuZGxlcnMgPSB7fSkgewogICAgaWYgKHRoaXMuZXh0ZW5zaW9ucy5oYXMobmFtZSkpIHsKICAgICAgY29uc3QgZXh0ID0gdGhpcy5leHRlbnNpb25zLmdldChuYW1lKQogICAgICBleHQuaGFuZGxlcnMgPSBoYW5kbGVycwogICAgICBleHQuZW5jb2RpbmcgPSBjLmZyb20oaGFuZGxlcnMuZW5jb2RpbmcgfHwgYy5idWZmZXIpCiAgICAgIGV4dC5zZXNzaW9uID0gdGhpcwogICAgICByZXR1cm4gZXh0CiAgICB9CgogICAgY29uc3QgZXh0ID0gewogICAgICBuYW1lLAogICAgICBoYW5kbGVycywKICAgICAgZW5jb2Rpbmc6IGMuZnJvbShoYW5kbGVycy5lbmNvZGluZyB8fCBjLmJ1ZmZlciksCiAgICAgIHNlc3Npb246IHRoaXMsCiAgICAgIHNlbmQobWVzc2FnZSwgcGVlcikgewogICAgICAgIGNvbnN0IGJ1ZmZlciA9IGMuZW5jb2RlKHRoaXMuZW5jb2RpbmcsIG1lc3NhZ2UpCiAgICAgICAgcGVlci5leHRlbnNpb24obmFtZSwgYnVmZmVyKQogICAgICB9LAogICAgICBicm9hZGNhc3QobWVzc2FnZSkgewogICAgICAgIGNvbnN0IGJ1ZmZlciA9IGMuZW5jb2RlKHRoaXMuZW5jb2RpbmcsIG1lc3NhZ2UpCiAgICAgICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMuc2Vzc2lvbi5wZWVycykgewogICAgICAgICAgcGVlci5leHRlbnNpb24obmFtZSwgYnVmZmVyKQogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVzdHJveSgpIHsKICAgICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5zZXNzaW9uLnBlZXJzKSB7CiAgICAgICAgICBpZiAocGVlci5leHRlbnNpb25zLmdldChuYW1lKSA9PT0gZXh0KSBwZWVyLmV4dGVuc2lvbnMuZGVsZXRlKG5hbWUpCiAgICAgICAgfQogICAgICAgIHRoaXMuc2Vzc2lvbi5leHRlbnNpb25zLmRlbGV0ZShuYW1lKQogICAgICB9LAogICAgICBfb25tZXNzYWdlKHN0YXRlLCBwZWVyKSB7CiAgICAgICAgY29uc3QgbSA9IHRoaXMuZW5jb2RpbmcuZGVjb2RlKHN0YXRlKQogICAgICAgIGlmICh0aGlzLmhhbmRsZXJzLm9ubWVzc2FnZSkgdGhpcy5oYW5kbGVycy5vbm1lc3NhZ2UobSwgcGVlcikKICAgICAgfQogICAgfQoKICAgIHRoaXMuZXh0ZW5zaW9ucy5zZXQobmFtZSwgZXh0KQoKICAgIGlmICh0aGlzLmNvcmUgPT09IG51bGwpIHRoaXMuX21vbml0b3JJbmRleCA9IC0yCiAgICBlbHNlIHRoaXMuY29yZS5hZGRNb25pdG9yKHRoaXMpCgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHsKICAgICAgcGVlci5leHRlbnNpb25zLnNldChuYW1lLCBleHQpCiAgICB9CgogICAgcmV0dXJuIGV4dAogIH0KCiAgX2VuY29kZShlbmMsIHZhbCkgewogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiB0aGlzLnBhZGRpbmcsIGVuZDogdGhpcy5wYWRkaW5nLCBidWZmZXI6IG51bGwgfQoKICAgIGlmIChiNGEuaXNCdWZmZXIodmFsKSkgewogICAgICBpZiAoc3RhdGUuc3RhcnQgPT09IDApIHJldHVybiB2YWwKICAgICAgc3RhdGUuZW5kICs9IHZhbC5ieXRlTGVuZ3RoCiAgICB9IGVsc2UgaWYgKGVuYykgewogICAgICBlbmMucHJlZW5jb2RlKHN0YXRlLCB2YWwpCiAgICB9IGVsc2UgewogICAgICB2YWwgPSBiNGEuZnJvbSh2YWwpCiAgICAgIGlmIChzdGF0ZS5zdGFydCA9PT0gMCkgcmV0dXJuIHZhbAogICAgICBzdGF0ZS5lbmQgKz0gdmFsLmJ5dGVMZW5ndGgKICAgIH0KCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQoKICAgIGlmIChlbmMpIGVuYy5lbmNvZGUoc3RhdGUsIHZhbCkKICAgIGVsc2Ugc3RhdGUuYnVmZmVyLnNldCh2YWwsIHN0YXRlLnN0YXJ0KQoKICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICB9CgogIF9kZWNvZGUoZW5jLCBibG9jaywgaW5kZXgpIHsKICAgIGlmICh0aGlzLmVuY3J5cHRpb24pIGJsb2NrID0gYmxvY2suc3ViYXJyYXkodGhpcy5lbmNyeXB0aW9uLnBhZGRpbmcodGhpcy5jb3JlLCBpbmRleCkpCiAgICB0cnkgewogICAgICBpZiAoZW5jKSByZXR1cm4gYy5kZWNvZGUoZW5jLCBibG9jaykKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aHJvdyBERUNPRElOR19FUlJPUihlcnIubWVzc2FnZSwgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CiAgICByZXR1cm4gYmxvY2sKICB9CgogIF9nZXRFbmNyeXB0aW9uUHJvdmlkZXIoZSkgewogICAgaWYgKGlzRW5jcnlwdGlvblByb3ZpZGVyKGUpKSByZXR1cm4gZQogICAgaWYgKCFlIHx8ICFlLmtleSkgcmV0dXJuIG51bGwKICAgIHJldHVybiBuZXcgRGVmYXVsdEVuY3J5cHRpb24oZS5rZXksIHRoaXMua2V5LCB7IGJsb2NrOiBlLmJsb2NrLCBjb21wYXQ6IHRoaXMuY29yZS5jb21wYXQgfSkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gSHlwZXJjb3JlCgpmdW5jdGlvbiBpc1N0cmVhbShzKSB7CiAgcmV0dXJuIHR5cGVvZiBzID09PSAnb2JqZWN0JyAmJiBzICYmIHR5cGVvZiBzLnBpcGUgPT09ICdmdW5jdGlvbicKfQoKYXN5bmMgZnVuY3Rpb24gcHJlYXBwZW5kKGJsb2NrcykgewogIGNvbnN0IG9mZnNldCA9IHRoaXMuc3RhdGUubGVuZ3RoCiAgY29uc3QgZm9yayA9IHRoaXMuc3RhdGUuZW5jcnlwdGlvbkZvcmsKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHsKICAgIGF3YWl0IHRoaXMuZW5jcnlwdGlvbi5lbmNyeXB0KG9mZnNldCArIGksIGJsb2Nrc1tpXSwgZm9yaywgdGhpcy5jb3JlKQogIH0KfQoKZnVuY3Rpb24gaXNWYWxpZEluZGV4KGluZGV4KSB7CiAgcmV0dXJuIGluZGV4ID09PSAwIHx8IGluZGV4ID4gMAp9CgpmdW5jdGlvbiBtYXliZVVuc2xhYihibG9jaykgewogIC8vIFVuc2xhYiBvbmx5IHdoZW4gaXQgdGFrZXMgdXAgbGVzcyB0aGVuIGhhbGYgdGhlIHNsYWIKICByZXR1cm4gYmxvY2sgIT09IG51bGwgJiYgMiAqIGJsb2NrLmJ5dGVMZW5ndGggPCBibG9jay5idWZmZXIuYnl0ZUxlbmd0aCA/IHVuc2xhYihibG9jaykgOiBibG9jawp9CgpmdW5jdGlvbiBjaGVja1NuYXBzaG90KHNuYXBzaG90LCBpbmRleCkgewogIGlmIChpbmRleCA+PSBzbmFwc2hvdC5zdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aCkgewogICAgdGhyb3cgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSgKICAgICAgYHNuYXBzaG90IGF0IGluZGV4ICR7aW5kZXh9IG5vdCBhdmFpbGFibGUgKG1heCBjb21wYXQgbGVuZ3RoICR7c25hcHNob3Quc3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGh9KWAsCiAgICAgIHNuYXBzaG90LmRpc2NvdmVyeUtleQogICAgKQogIH0KfQoKZnVuY3Rpb24gcmVhZEJsb2NrKHJ4LCBpbmRleCkgewogIGNvbnN0IHByb21pc2UgPSByeC5nZXRCbG9jayhpbmRleCkKICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIHByb21pc2UKfQoKZnVuY3Rpb24gaW5pdE9uY2Uoc2Vzc2lvbiwgc3RvcmFnZSwga2V5LCBvcHRzKSB7CiAgaWYgKHN0b3JhZ2UgPT09IG51bGwpIHN0b3JhZ2UgPSBvcHRzLnN0b3JhZ2UgfHwgbnVsbAogIGlmIChrZXkgPT09IG51bGwpIGtleSA9IG9wdHMua2V5IHx8IG51bGwKCiAgc2Vzc2lvbi5jb3JlID0gbmV3IENvcmUoSHlwZXJjb3JlLmRlZmF1bHRTdG9yYWdlKHN0b3JhZ2UpLCB7CiAgICBwcmVvcGVuOiBvcHRzLnByZW9wZW4sCiAgICBlYWdlclVwZ3JhZGU6IG9wdHMuZWFnZXJVcGdyYWRlICE9PSBmYWxzZSwKICAgIG5vdERvd25sb2FkaW5nTGluZ2VyOiBvcHRzLm5vdERvd25sb2FkaW5nTGluZ2VyLAogICAgYWxsb3dGb3JrOiBvcHRzLmFsbG93Rm9yayAhPT0gZmFsc2UsCiAgICBhbGxvd1B1c2g6ICEhb3B0cy5hbGxvd1B1c2gsCiAgICBhbHdheXNMYXRlc3RCbG9jazogISFvcHRzLmFsbG93TGF0ZXN0QmxvY2ssCiAgICBpbmZsaWdodFJhbmdlOiBvcHRzLmluZmxpZ2h0UmFuZ2UsCiAgICBjb21wYXQ6IG9wdHMuY29tcGF0ID09PSB0cnVlLAogICAgZm9yY2U6IG9wdHMuZm9yY2UsCiAgICBjcmVhdGVJZk1pc3Npbmc6IG9wdHMuY3JlYXRlSWZNaXNzaW5nLAogICAgZGlzY292ZXJ5S2V5OiBvcHRzLmRpc2NvdmVyeUtleSwKICAgIG92ZXJ3cml0ZTogb3B0cy5vdmVyd3JpdGUsCiAgICBrZXksCiAgICBrZXlQYWlyOiBvcHRzLmtleVBhaXIsCiAgICBsZWdhY3k6IG9wdHMubGVnYWN5LAogICAgbWFuaWZlc3Q6IG9wdHMubWFuaWZlc3QsCiAgICBnbG9iYWxDYWNoZTogb3B0cy5nbG9iYWxDYWNoZSB8fCBudWxsIC8vIHNlc3Npb24gaXMgYSB0ZW1wIG9wdGlvbiwgbm90IHRvIGJlIHJlbGllZCBvbiB1bmxlc3MgeW91IGtub3cgd2hhdCB5b3UgYXJlIGRvaW5nIChubyBzZW12ZXIgZ3VhcmFudGVlcykKICB9KQp9CgpmdW5jdGlvbiBtYXliZUFkZE1vbml0b3IobmFtZSkgewogIGlmIChuYW1lID09PSAnYXBwZW5kJyB8fCBuYW1lID09PSAndHJ1bmNhdGUnKSByZXR1cm4KICBpZiAodGhpcy5fbW9uaXRvckluZGV4ID49IDAgfHwgdGhpcy5jbG9zaW5nKSByZXR1cm4KCiAgaWYgKHRoaXMuY29yZSA9PT0gbnVsbCkgewogICAgdGhpcy5fbW9uaXRvckluZGV4ID0gLTIKICB9IGVsc2UgewogICAgdGhpcy5jb3JlLmFkZE1vbml0b3IodGhpcykKICB9Cn0KCmZ1bmN0aW9uIGlzU2Vzc2lvbk1vdmVkKGVycikgewogIHJldHVybiBlcnIuY29kZSA9PT0gJ1NFU1NJT05fTU9WRUQnCn0KCmZ1bmN0aW9uIGdldEVuY3J5cHRpb25PcHRpb24ob3B0cykgewogIC8vIG9sZCBzdHlsZSwgc3VwcG9ydGVkIGZvciBub3cgYnV0IHdpbGwgZ28gYXdheQogIGlmIChvcHRzLmVuY3J5cHRpb25LZXkpIHJldHVybiB7IGtleTogb3B0cy5lbmNyeXB0aW9uS2V5LCBibG9jazogISFvcHRzLmlzQmxvY2tLZXkgfQogIGlmICghb3B0cy5lbmNyeXB0aW9uKSByZXR1cm4gbnVsbAogIHJldHVybiBiNGEuaXNCdWZmZXIob3B0cy5lbmNyeXB0aW9uKSA/IHsga2V5OiBvcHRzLmVuY3J5cHRpb24gfSA6IG9wdHMuZW5jcnlwdGlvbgp9CgpmdW5jdGlvbiBpc0VuY3J5cHRpb25Qcm92aWRlcihlKSB7CiAgcmV0dXJuIGUgJiYgaXNGdW5jdGlvbihlLnBhZGRpbmcpICYmIGlzRnVuY3Rpb24oZS5lbmNyeXB0KSAmJiBpc0Z1bmN0aW9uKGUuZGVjcnlwdCkKfQoKZnVuY3Rpb24gaXNGdW5jdGlvbihmbikgewogIHJldHVybiAhIWZuICYmIHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJwp9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgeyBNZXJrbGVUcmVlIH0gPSByZXF1aXJlKCcuL21lcmtsZS10cmVlJykKCm1vZHVsZS5leHBvcnRzID0gYXN5bmMgZnVuY3Rpb24gYXVkaXRDb3JlKAogIGNvcmUsCiAgeyB0cmVlID0gdHJ1ZSwgYmxvY2tzID0gdHJ1ZSwgYml0ZmllbGQgPSB0cnVlLCBkcnlSdW4gPSBmYWxzZSB9ID0ge30KKSB7CiAgY29uc3QgbGVuZ3RoID0gY29yZS5zdGF0ZS5sZW5ndGgKICBjb25zdCBzdGF0cyA9IHsKICAgIHRyZWVOb2RlczogMCwKICAgIGJsb2NrczogMCwKICAgIGJpdHM6IDAsCiAgICBkcm9wcGVkVHJlZU5vZGVzOiAwLAogICAgZHJvcHBlZEJsb2NrczogMCwKICAgIGRyb3BwZWRCaXRzOiAwLAogICAgY29ycnVwdDogZmFsc2UKICB9CgogIC8vIGF1ZGl0IHRoZSB0cmVlCiAgaWYgKHRyZWUpIHsKICAgIGxldCB0eCA9IG51bGwKCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZShjb3JlLnN0YXRlLnN0b3JhZ2UsIGxlbmd0aCkKICAgIGNvbnN0IHN0YWNrID0gW10KCiAgICBmb3IgKGNvbnN0IHIgb2Ygcm9vdHMpIHsKICAgICAgaWYgKHIgPT09IG51bGwpIHsKICAgICAgICBpZiAoIWRyeVJ1bikgewogICAgICAgICAgY29uc3Qgc3RvcmFnZSA9IGNvcmUuc3RhdGUuc3RvcmFnZQogICAgICAgICAgYXdhaXQgc3RvcmFnZS5zdG9yZS5kZWxldGVDb3JlKHN0b3JhZ2UuY29yZSkKICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgfQoKICAgICAgICBzdGF0cy5jb3JydXB0ID0gdHJ1ZQogICAgICB9CgogICAgICBzdGFjay5wdXNoKHIpCiAgICB9CgogICAgc3RhdHMudHJlZU5vZGVzICs9IHJvb3RzLmxlbmd0aAoKICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQoKICAgICAgaWYgKChub2RlLmluZGV4ICYgMSkgPT09IDApIGNvbnRpbnVlCgogICAgICBjb25zdCBbbGVmdCwgcmlnaHRdID0gZmxhdC5jaGlsZHJlbihub2RlLmluZGV4KQoKICAgICAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGxlZnROb2RlUHJvbWlzZSA9IHJ4LmdldFRyZWVOb2RlKGxlZnQpCiAgICAgIGNvbnN0IHJpZ2h0Tm9kZVByb21pc2UgPSByeC5nZXRUcmVlTm9kZShyaWdodCkKCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IFtsZWZ0Tm9kZSwgcmlnaHROb2RlXSA9IGF3YWl0IFByb21pc2UuYWxsKFtsZWZ0Tm9kZVByb21pc2UsIHJpZ2h0Tm9kZVByb21pc2VdKQoKICAgICAgaWYgKGlzQmFkVHJlZShub2RlLCBsZWZ0Tm9kZSwgcmlnaHROb2RlKSkgewogICAgICAgIGlmICghdHggJiYgIXN0YXRzLmNvcnJ1cHQpIHR4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKICAgICAgICBjb25zdCBbbCwgcl0gPSBmbGF0LnNwYW5zKG5vZGUuaW5kZXgpCiAgICAgICAgdHguZGVsZXRlVHJlZU5vZGVSYW5nZShsLCByICsgMSkKICAgICAgICBzdGF0cy5kcm9wcGVkVHJlZU5vZGVzKysKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAoIWxlZnROb2RlKSBjb250aW51ZQoKICAgICAgc3RhdHMudHJlZU5vZGVzICs9IDIKICAgICAgc3RhY2sucHVzaChsZWZ0Tm9kZSwgcmlnaHROb2RlKQogICAgfQoKICAgIGlmICh0eCAmJiAhZHJ5UnVuKSBhd2FpdCB0eC5mbHVzaCgpCiAgfQoKICAvLyBhdWRpdCB0aGUgYmxvY2tzCiAgaWYgKGJsb2NrcykgewogICAgbGV0IHR4ID0gbnVsbAoKICAgIGZvciBhd2FpdCAoY29uc3QgYmxvY2sgb2YgY29yZS5zdGF0ZS5zdG9yYWdlLmNyZWF0ZUJsb2NrU3RyZWFtKCkpIHsKICAgICAgaWYgKCFjb3JlLmJpdGZpZWxkLmdldChibG9jay5pbmRleCkpIHsKICAgICAgICBpZiAoIXR4ICYmICFzdGF0cy5jb3JydXB0KSB0eCA9IGNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCiAgICAgICAgdHguZGVsZXRlQmxvY2soYmxvY2suaW5kZXgpCiAgICAgICAgc3RhdHMuZHJvcHBlZEJsb2NrcysrCiAgICAgIH0KCiAgICAgIGNvbnN0IHJ4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCB0cmVlTm9kZVByb21pc2UgPSByeC5nZXRUcmVlTm9kZSgyICogYmxvY2suaW5kZXgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCB0cmVlTm9kZSA9IGF3YWl0IHRyZWVOb2RlUHJvbWlzZQoKICAgICAgaWYgKGlzQmFkQmxvY2sodHJlZU5vZGUsIGJsb2NrLnZhbHVlKSkgewogICAgICAgIGlmICghdHggJiYgIXN0YXRzLmNvcnJ1cHQpIHR4ID0gY29yZS5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKICAgICAgICB0eC5kZWxldGVCbG9jayhibG9jay5pbmRleCkKICAgICAgICBzdGF0cy5kcm9wcGVkQmxvY2tzKysKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBzdGF0cy5ibG9ja3MrKwogICAgfQoKICAgIGlmICh0eCAmJiAhZHJ5UnVuKSBhd2FpdCB0eC5mbHVzaCgpCiAgfQoKICBpZiAoYml0ZmllbGQpIHsKICAgIGxldCB0eCA9IG51bGwKCiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGFsbEJpdHMoY29yZS5iaXRmaWVsZCkpIHsKICAgICAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGJsb2NrUHJvbWlzZSA9IHJ4LmdldEJsb2NrKGluZGV4KQoKICAgICAgcngudHJ5Rmx1c2goKQoKICAgICAgY29uc3QgYmxvY2sgPSBhd2FpdCBibG9ja1Byb21pc2UKICAgICAgaWYgKCFibG9jaykgewogICAgICAgIHN0YXRzLmRyb3BwZWRCaXRzKysKICAgICAgICBpZiAoZHJ5UnVuKSBjb250aW51ZQoKICAgICAgICBpZiAoIXR4ICYmICFzdGF0cy5jb3JydXB0KSB0eCA9IGNvcmUuc3RhdGUuc3RvcmFnZS53cml0ZSgpCgogICAgICAgIGNvcmUuYml0ZmllbGQuc2V0KGluZGV4LCBmYWxzZSkKCiAgICAgICAgY29uc3QgcGFnZSA9IGNvcmUuYml0ZmllbGQuZ2V0Qml0ZmllbGQoaW5kZXgpCiAgICAgICAgaWYgKHBhZ2UuYml0ZmllbGQpIHR4LnB1dEJpdGZpZWxkUGFnZShwYWdlLmluZGV4LCBwYWdlLmJpdGZpZWxkKQogICAgICAgIGVsc2UgdHguZGVsZXRlQml0ZmllbGRQYWdlKHBhZ2UuaW5kZXgpCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgc3RhdHMuYml0cysrCiAgICB9CgogICAgaWYgKHR4ICYmICFkcnlSdW4pIGF3YWl0IHR4LmZsdXNoKCkKICB9CgogIHJldHVybiBzdGF0cwp9CgpmdW5jdGlvbiBpc0JhZEJsb2NrKG5vZGUsIGJsb2NrKSB7CiAgaWYgKCFub2RlKSByZXR1cm4gdHJ1ZQogIGNvbnN0IGhhc2ggPSBjcnlwdG8uZGF0YShibG9jaykKICByZXR1cm4gIWI0YS5lcXVhbHMoaGFzaCwgbm9kZS5oYXNoKSB8fCBub2RlLnNpemUgIT09IGJsb2NrLmJ5dGVMZW5ndGgKfQoKZnVuY3Rpb24gaXNCYWRUcmVlKHBhcmVudCwgbGVmdCwgcmlnaHQpIHsKICBpZiAoIWxlZnQgJiYgIXJpZ2h0KSByZXR1cm4gZmFsc2UKICBpZiAoIWxlZnQgfHwgIXJpZ2h0KSByZXR1cm4gdHJ1ZQogIGNvbnN0IGhhc2ggPSBjcnlwdG8ucGFyZW50KGxlZnQsIHJpZ2h0KQogIHJldHVybiAhYjRhLmVxdWFscyhoYXNoLCBwYXJlbnQuaGFzaCkgfHwgcGFyZW50LnNpemUgIT09IGxlZnQuc2l6ZSArIHJpZ2h0LnNpemUKfQoKZnVuY3Rpb24qIGFsbEJpdHMoYml0ZmllbGQpIHsKICBsZXQgaSA9IDAKICBpZiAoYml0ZmllbGQuZ2V0KDApKSB5aWVsZCAwCiAgd2hpbGUgKHRydWUpIHsKICAgIGkgPSBiaXRmaWVsZC5maW5kRmlyc3QodHJ1ZSwgaSArIDEpCiAgICBpZiAoaSA9PT0gLTEpIGJyZWFrCiAgICB5aWVsZCBpCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHF1aWNrYml0ID0gcmVxdWlyZSgnLi9jb21wYXQnKS5xdWlja2JpdAoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCaXRJbnRlcmx1ZGUgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5yYW5nZXMgPSBbXQogIH0KCiAgY29udGlndW91c0xlbmd0aChmcm9tKSB7CiAgICBmb3IgKGNvbnN0IHIgb2YgdGhpcy5yYW5nZXMpIHsKICAgICAgaWYgKHIuc3RhcnQgPiBmcm9tKSBicmVhawogICAgICBpZiAoIXIudmFsdWUgJiYgci5zdGFydCA8PSBmcm9tKSByZXR1cm4gci5zdGFydAogICAgfQoKICAgIC8vIFRPRE86IGJlIHNtYXJ0ZXIKICAgIHdoaWxlICh0aGlzLmdldChmcm9tKSA9PT0gdHJ1ZSkgZnJvbSsrCiAgICByZXR1cm4gZnJvbQogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICBsZXQgc3RhcnQgPSAwCiAgICBsZXQgZW5kID0gdGhpcy5yYW5nZXMubGVuZ3RoCgogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIGNvbnN0IG1pZCA9IChzdGFydCArIGVuZCkgPj4gMQogICAgICBjb25zdCByID0gdGhpcy5yYW5nZXNbbWlkXQoKICAgICAgaWYgKGluZGV4IDwgci5zdGFydCkgewogICAgICAgIGVuZCA9IG1pZAogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIGlmIChpbmRleCA+PSByLmVuZCkgewogICAgICAgIGlmIChtaWQgPT09IHN0YXJ0KSBicmVhawogICAgICAgIHN0YXJ0ID0gbWlkCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgcmV0dXJuIHIudmFsdWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbHVlKSB7CiAgICBpZiAoc3RhcnQgPT09IGVuZCkgcmV0dXJuCgogICAgbGV0IHIgPSBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICByID0gdGhpcy5yYW5nZXNbaV0KCiAgICAgIC8vIGlmIGFscmVhZHkgaW5zaWRlLCBzdG9wCiAgICAgIGlmIChyLnN0YXJ0IDw9IHN0YXJ0ICYmIGVuZCA8PSByLmVuZCkgewogICAgICAgIGlmICh2YWx1ZSA9PT0gci52YWx1ZSkgcmV0dXJuCgogICAgICAgIGNvbnN0IHJhbmdlcyA9IG1lcmdlUmFuZ2VzKHIsIHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICAgICAgICB0aGlzLnJhbmdlcy5zcGxpY2UoaSwgMSwgLi4ucmFuZ2VzKQoKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gd2Ugd2FubmEgb3ZlcnVuIHRoZSBpbnRlcnZhbAogICAgICBpZiAoc3RhcnQgPiByLmVuZCkgewogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIHdlIG92ZXJyYW4gYnV0IHRoaXMgaW50ZXJ2YWwgaXMgZW5kaW5nIGFmdGVyIHVzLCBtb3ZlIGl0IGJhY2sKICAgICAgaWYgKGVuZCA+PSByLnN0YXJ0ICYmIGVuZCA8PSByLmVuZCkgewogICAgICAgIHIuc3RhcnQgPSByLnZhbHVlID09PSB2YWx1ZSA/IHN0YXJ0IDogZW5kCiAgICAgICAgaWYgKHIudmFsdWUgIT09IHZhbHVlKSB0aGlzLnJhbmdlcy5zcGxpY2UoaSwgMCwgeyBzdGFydCwgZW5kLCB2YWx1ZSB9KQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyB3ZSBvdmVycmFuIGJ1dCBvdXIgc3RhcnQgaXMgY29udGFpbmVkIGluIHRoaXMgaW50ZXJ2YWwsIG1vdmUgc3RhcnQgYmFjawogICAgICBpZiAoc3RhcnQgPj0gci5zdGFydCAmJiBzdGFydCA8PSByLmVuZCkgewogICAgICAgIGlmIChyLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgci5lbmQgPSBzdGFydCAvLyBDcm9wIGN1cnJlbnQgY29tcGFyaXNvbgoKICAgICAgICAgIC8vIElmIHRoZXJlJ3MgYSBuZXh0IHJhbmdlCiAgICAgICAgICBpZiAodGhpcy5yYW5nZXMubGVuZ3RoIC0gMSA+IGkpIHsKICAgICAgICAgICAgY29uc3QgbmV4dCA9IHRoaXMucmFuZ2VzW2kgKyAxXQogICAgICAgICAgICAvLyBJZiB0aGUgc2FtZSwgZ28gbmV4dAogICAgICAgICAgICBpZiAobmV4dC52YWx1ZSA9PT0gdmFsdWUpIGNvbnRpbnVlCiAgICAgICAgICAgIC8vIEVsc2Ugd2Ugb3ZlcmxhcCBzbyB1cGRhdGUgbmV4dCByYW5nZQogICAgICAgICAgICBpZiAobmV4dC5zdGFydCA8IGVuZCkgbmV4dC5zdGFydCA9IGVuZAogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMucmFuZ2VzLnNwbGljZSgrK2ksIDAsIHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgc3RhcnQgPSByLnN0YXJ0CiAgICAgIH0KCiAgICAgIGxldCByZW1vdmUgPSAwCgogICAgICBmb3IgKGxldCBqID0gaTsgaiA8IHRoaXMucmFuZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgY29uc3QgbiA9IHRoaXMucmFuZ2VzW2pdCiAgICAgICAgaWYgKG4uc3RhcnQgPiBlbmQgfHwgbi52YWx1ZSAhPT0gdmFsdWUpIGJyZWFrCiAgICAgICAgaWYgKG4uc3RhcnQgPD0gZW5kICYmIG4uZW5kID4gZW5kKSBlbmQgPSBuLmVuZAogICAgICAgIHJlbW92ZSsrCiAgICAgIH0KCiAgICAgIHRoaXMucmFuZ2VzLnNwbGljZShpLCByZW1vdmUsIHsgc3RhcnQsIGVuZCwgdmFsdWUgfSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHIgIT09IG51bGwpIHsKICAgICAgaWYgKHN0YXJ0IDw9IHIuZW5kICYmIGVuZCA+IHIuZW5kKSB7CiAgICAgICAgci5lbmQgPSBlbmQKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gd2UgbmV2ZXIKICAgICAgaWYgKHIuZW5kID4gc3RhcnQpIHJldHVybgogICAgfQoKICAgIHRoaXMucmFuZ2VzLnB1c2goeyBzdGFydCwgZW5kLCB2YWx1ZSB9KQogIH0KCiAgZmx1c2godHgsIGJpdGZpZWxkKSB7CiAgICBpZiAoIXRoaXMucmFuZ2VzLmxlbmd0aCkgcmV0dXJuIFtdCgogICAgbGV0IGluZGV4ID0gdGhpcy5yYW5nZXNbMF0uc3RhcnQKICAgIGNvbnN0IGZpbmFsID0gdGhpcy5yYW5nZXNbdGhpcy5yYW5nZXMubGVuZ3RoIC0gMV0uZW5kCgogICAgbGV0IGkgPSAwCgogICAgd2hpbGUgKGluZGV4IDwgZmluYWwpIHsKICAgICAgY29uc3QgcGFnZSA9IGJpdGZpZWxkLmdldEJpdGZpZWxkKGluZGV4KSAvLyByZWFkIG9ubHkKICAgICAgY29uc3QgcGFnZUluZGV4ID0gcGFnZSA/IHBhZ2UuaW5kZXggOiBiaXRmaWVsZC5nZXRQYWdlSW5kZXgoaW5kZXgpCgogICAgICBjb25zdCBidWYgPSBiNGEuYWxsb2NVbnNhZmUoYml0ZmllbGQuZ2V0UGFnZUJ5dGVMZW5ndGgoKSkKCiAgICAgIGlmIChwYWdlKSB7CiAgICAgICAgY29uc3Qgc3JjID0gcGFnZS5iaXRmaWVsZCAvLyBVaW50MzJBcnJheQogICAgICAgIGJ1Zi5zZXQoYjRhLmZyb20oc3JjLmJ1ZmZlciwgc3JjLmJ5dGVPZmZzZXQsIHNyYy5ieXRlTGVuZ3RoKSwgMCkKICAgICAgfSBlbHNlIHsKICAgICAgICBiNGEuZmlsbChidWYsIDApCiAgICAgIH0KCiAgICAgIGNvbnN0IGxhc3QgPSAocGFnZUluZGV4ICsgMSkgKiAoYnVmLmJ5dGVMZW5ndGggPDwgMykKICAgICAgY29uc3Qgb2Zmc2V0ID0gcGFnZUluZGV4ICogKGJ1Zi5ieXRlTGVuZ3RoIDw8IDMpCgogICAgICBsZXQgaGFzVmFsdWUgPSBmYWxzZQoKICAgICAgd2hpbGUgKGkgPCB0aGlzLnJhbmdlcy5sZW5ndGgpIHsKICAgICAgICBjb25zdCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0gPSB0aGlzLnJhbmdlc1tpXQoKICAgICAgICBpZiAoIWhhc1ZhbHVlICYmIHZhbHVlKSBoYXNWYWx1ZSA9IHRydWUKCiAgICAgICAgY29uc3QgZnJvbSA9IHN0YXJ0IDwgaW5kZXggPyBpbmRleCA6IHN0YXJ0CiAgICAgICAgY29uc3QgdG8gPSBlbmQgPCBsYXN0ID8gZW5kIDogbGFzdAoKICAgICAgICBxdWlja2JpdC5maWxsKGJ1ZiwgdmFsdWUsIGZyb20gLSBvZmZzZXQsIHRvIC0gb2Zmc2V0KQoKICAgICAgICBpbmRleCA9IHRvCgogICAgICAgIGlmICh0byA9PT0gbGFzdCkgYnJlYWsKCiAgICAgICAgaSsrCiAgICAgIH0KCiAgICAgIGlmIChwYWdlIHx8IGhhc1ZhbHVlKSB0eC5wdXRCaXRmaWVsZFBhZ2UocGFnZUluZGV4LCBidWYpCiAgICB9CgogICAgcmV0dXJuIHRoaXMucmFuZ2VzCiAgfQp9CgpmdW5jdGlvbiBtZXJnZVJhbmdlcyhhLCBiKSB7CiAgY29uc3QgcmFuZ2VzID0gW10KICBpZiAoYS5zdGFydCA8IGIuc3RhcnQpIHJhbmdlcy5wdXNoKHsgc3RhcnQ6IGEuc3RhcnQsIGVuZDogYi5zdGFydCwgdmFsdWU6IGEudmFsdWUgfSkKICByYW5nZXMucHVzaCh7IHN0YXJ0OiBiLnN0YXJ0LCBlbmQ6IGIuZW5kLCB2YWx1ZTogYi52YWx1ZSB9KQogIGlmIChiLmVuZCA8IGEuZW5kKSByYW5nZXMucHVzaCh7IHN0YXJ0OiBiLmVuZCwgZW5kOiBhLmVuZCwgdmFsdWU6IGEudmFsdWUgfSkKCiAgcmV0dXJuIHJhbmdlcwp9CmNvbnN0IEJpZ1NwYXJzZUFycmF5ID0gcmVxdWlyZSgnYmlnLXNwYXJzZS1hcnJheScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHF1aWNrYml0ID0gcmVxdWlyZSgnLi9jb21wYXQnKS5xdWlja2JpdAoKY29uc3QgQklUU19QRVJfUEFHRSA9IDMyNzY4CmNvbnN0IEJZVEVTX1BFUl9QQUdFID0gQklUU19QRVJfUEFHRSAvIDgKY29uc3QgV09SRFNfUEVSX1BBR0UgPSBCWVRFU19QRVJfUEFHRSAvIDQKY29uc3QgQklUU19QRVJfU0VHTUVOVCA9IDIwOTcxNTIKY29uc3QgQllURVNfUEVSX1NFR01FTlQgPSBCSVRTX1BFUl9TRUdNRU5UIC8gOApjb25zdCBXT1JEU19QRVJfU0VHTUVOVCA9IEJZVEVTX1BFUl9TRUdNRU5UIC8gNApjb25zdCBJTklUSUFMX1dPUkRTX1BFUl9TRUdNRU5UID0gMTAyNApjb25zdCBQQUdFU19QRVJfU0VHTUVOVCA9IEJJVFNfUEVSX1NFR01FTlQgLyBCSVRTX1BFUl9QQUdFCmNvbnN0IFNFR01FTlRfR1JPV1RIX0ZBQ1RPUiA9IDQKCmNsYXNzIEJpdGZpZWxkUGFnZSB7CiAgY29uc3RydWN0b3IoaW5kZXgsIHNlZ21lbnQpIHsKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5vZmZzZXQgPSBpbmRleCAqIEJZVEVTX1BFUl9QQUdFIC0gc2VnbWVudC5vZmZzZXQKICAgIHRoaXMuYml0ZmllbGQgPSBudWxsCiAgICB0aGlzLnNlZ21lbnQgPSBzZWdtZW50CgogICAgc2VnbWVudC5hZGQodGhpcykKICB9CgogIGdldCB0cmVlKCkgewogICAgcmV0dXJuIHRoaXMuc2VnbWVudC50cmVlCiAgfQoKICBnZXQoaW5kZXgsIGRpcnR5KSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZ2V0KHRoaXMuYml0ZmllbGQsIGluZGV4KQogIH0KCiAgc2V0KGluZGV4LCB2YWwpIHsKICAgIGlmIChxdWlja2JpdC5zZXQodGhpcy5iaXRmaWVsZCwgaW5kZXgsIHZhbCkpIHsKICAgICAgdGhpcy50cmVlLnVwZGF0ZSh0aGlzLm9mZnNldCAqIDggKyBpbmRleCkKICAgIH0KICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbCkgewogICAgcXVpY2tiaXQuZmlsbCh0aGlzLmJpdGZpZWxkLCB2YWwsIHN0YXJ0LCBlbmQpCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gMTI4KQogICAgY29uc3QgbiA9IGkgKyBNYXRoLmNlaWwoKGVuZCAtIHN0YXJ0KSAvIDEyOCkKCiAgICB3aGlsZSAoaSA8PSBuKSB0aGlzLnRyZWUudXBkYXRlKHRoaXMub2Zmc2V0ICogOCArIGkrKyAqIDEyOCkKICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZEZpcnN0KHRoaXMuYml0ZmllbGQsIHZhbCwgcG9zaXRpb24pCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZExhc3QodGhpcy5iaXRmaWVsZCwgdmFsLCBwb3NpdGlvbikKICB9CgogIGNvdW50KHN0YXJ0LCBsZW5ndGgsIHZhbCkgewogICAgY29uc3QgZW5kID0gc3RhcnQgKyBsZW5ndGgKCiAgICBsZXQgaSA9IHN0YXJ0CiAgICBsZXQgYyA9IDAKCiAgICB3aGlsZSAobGVuZ3RoID4gMCkgewogICAgICBjb25zdCBsID0gdGhpcy5maW5kRmlyc3QodmFsLCBpKQogICAgICBpZiAobCA9PT0gLTEgfHwgbCA+PSBlbmQpIHJldHVybiBjCgogICAgICBjb25zdCBoID0gdGhpcy5maW5kRmlyc3QoIXZhbCwgbCArIDEpCiAgICAgIGlmIChoID09PSAtMSB8fCBoID49IGVuZCkgcmV0dXJuIGMgKyBlbmQgLSBsCgogICAgICBjICs9IGggLSBsCiAgICAgIGxlbmd0aCAtPSBoIC0gaQogICAgICBpID0gaAogICAgfQoKICAgIHJldHVybiBjCiAgfQp9CgpjbGFzcyBCaXRmaWVsZFNlZ21lbnQgewogIGNvbnN0cnVjdG9yKGluZGV4LCBiaXRmaWVsZCkgewogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLm9mZnNldCA9IGluZGV4ICogQllURVNfUEVSX1NFR01FTlQKICAgIHRoaXMudHJlZSA9IHF1aWNrYml0LkluZGV4LmZyb20oYml0ZmllbGQsIEJZVEVTX1BFUl9TRUdNRU5UKQogICAgdGhpcy5wYWdlcyA9IG5ldyBBcnJheShQQUdFU19QRVJfU0VHTUVOVCkKICB9CgogIGdldCBiaXRmaWVsZCgpIHsKICAgIHJldHVybiB0aGlzLnRyZWUuZmllbGQKICB9CgogIGFkZChwYWdlKSB7CiAgICBjb25zdCBpID0gcGFnZS5pbmRleCAtIHRoaXMuaW5kZXggKiBQQUdFU19QRVJfU0VHTUVOVAogICAgdGhpcy5wYWdlc1tpXSA9IHBhZ2UKCiAgICBjb25zdCBzdGFydCA9IGkgKiBXT1JEU19QRVJfUEFHRQogICAgY29uc3QgZW5kID0gc3RhcnQgKyBXT1JEU19QRVJfUEFHRQoKICAgIGlmIChlbmQgPj0gdGhpcy5iaXRmaWVsZC5sZW5ndGgpIHRoaXMucmVhbGxvY2F0ZShlbmQpCgogICAgcGFnZS5iaXRmaWVsZCA9IHRoaXMuYml0ZmllbGQuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICB9CgogIHJlYWxsb2NhdGUobGVuZ3RoKSB7CiAgICBsZXQgdGFyZ2V0ID0gdGhpcy5iaXRmaWVsZC5sZW5ndGgKICAgIHdoaWxlICh0YXJnZXQgPCBsZW5ndGgpIHRhcmdldCAqPSBTRUdNRU5UX0dST1dUSF9GQUNUT1IKCiAgICBjb25zdCBiaXRmaWVsZCA9IG5ldyBVaW50MzJBcnJheSh0YXJnZXQpCiAgICBiaXRmaWVsZC5zZXQodGhpcy5iaXRmaWVsZCkKCiAgICB0aGlzLnRyZWUgPSBxdWlja2JpdC5JbmRleC5mcm9tKGJpdGZpZWxkLCBCWVRFU19QRVJfU0VHTUVOVCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcGFnZSA9IHRoaXMucGFnZXNbaV0KICAgICAgaWYgKCFwYWdlKSBjb250aW51ZQoKICAgICAgY29uc3Qgc3RhcnQgPSBpICogV09SRFNfUEVSX1BBR0UKICAgICAgY29uc3QgZW5kID0gc3RhcnQgKyBXT1JEU19QRVJfUEFHRQoKICAgICAgcGFnZS5iaXRmaWVsZCA9IGJpdGZpZWxkLnN1YmFycmF5KHN0YXJ0LCBlbmQpCiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgcG9zaXRpb24gPSB0aGlzLnRyZWUuc2tpcEZpcnN0KCF2YWwsIHBvc2l0aW9uKQoKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGlmIChpID49IFBBR0VTX1BFUl9TRUdNRU5UKSByZXR1cm4gLTEKCiAgICB3aGlsZSAoaSA8IHRoaXMucGFnZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLnBhZ2VzW2ldCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHApIGluZGV4ID0gcC5maW5kRmlyc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfUEFHRSArIGluZGV4CgogICAgICBqID0gMAogICAgICBpKysKICAgIH0KCiAgICByZXR1cm4gLTEKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIHBvc2l0aW9uID0gdGhpcy50cmVlLnNraXBMYXN0KCF2YWwsIHBvc2l0aW9uKQoKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGlmIChpID49IFBBR0VTX1BFUl9TRUdNRU5UKSByZXR1cm4gLTEKCiAgICB3aGlsZSAoaSA+PSAwKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLnBhZ2VzW2ldCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHApIGluZGV4ID0gcC5maW5kTGFzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9QQUdFICsgaW5kZXgKCiAgICAgIGogPSBCSVRTX1BFUl9QQUdFIC0gMQogICAgICBpLS0KICAgIH0KCiAgICByZXR1cm4gLTEKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQml0ZmllbGQgewogIHN0YXRpYyBCSVRTX1BFUl9QQUdFID0gQklUU19QRVJfUEFHRQogIHN0YXRpYyBCWVRFU19QRVJfUEFHRSA9IEJZVEVTX1BFUl9QQUdFCgogIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgdGhpcy5yZXN1bWVkID0gISEoYnVmZmVyICYmIGJ1ZmZlci5ieXRlTGVuZ3RoID49IDApCgogICAgdGhpcy5fcGFnZXMgPSBuZXcgQmlnU3BhcnNlQXJyYXkoKQogICAgdGhpcy5fc2VnbWVudHMgPSBuZXcgQmlnU3BhcnNlQXJyYXkoKQoKICAgIGNvbnN0IHZpZXcgPSB0aGlzLnJlc3VtZWQKICAgICAgPyBuZXcgVWludDMyQXJyYXkoYnVmZmVyLmJ1ZmZlciwgYnVmZmVyLmJ5dGVPZmZzZXQsIE1hdGguZmxvb3IoYnVmZmVyLmJ5dGVMZW5ndGggLyA0KSkKICAgICAgOiBuZXcgVWludDMyQXJyYXkoSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCkKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZpZXcubGVuZ3RoOyBpICs9IFdPUkRTX1BFUl9TRUdNRU5UKSB7CiAgICAgIGxldCBiaXRmaWVsZCA9IHZpZXcuc3ViYXJyYXkoaSwgaSArIFdPUkRTX1BFUl9TRUdNRU5UKQogICAgICBsZXQgbGVuZ3RoID0gV09SRFNfUEVSX1NFR01FTlQKCiAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgbGVuZ3RoID0gSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVAogICAgICAgIHdoaWxlIChsZW5ndGggPCBiaXRmaWVsZC5sZW5ndGgpIGxlbmd0aCAqPSBTRUdNRU5UX0dST1dUSF9GQUNUT1IKICAgICAgfQoKICAgICAgaWYgKGJpdGZpZWxkLmxlbmd0aCAhPT0gbGVuZ3RoKSB7CiAgICAgICAgY29uc3QgY29weSA9IG5ldyBVaW50MzJBcnJheShsZW5ndGgpCiAgICAgICAgY29weS5zZXQoYml0ZmllbGQsIDApCiAgICAgICAgYml0ZmllbGQgPSBjb3B5CiAgICAgIH0KCiAgICAgIGNvbnN0IHNlZ21lbnQgPSBuZXcgQml0ZmllbGRTZWdtZW50KGkgLyBXT1JEU19QRVJfU0VHTUVOVCwgYml0ZmllbGQpCiAgICAgIHRoaXMuX3NlZ21lbnRzLnNldChzZWdtZW50LmluZGV4LCBzZWdtZW50KQoKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBiaXRmaWVsZC5sZW5ndGg7IGogKz0gV09SRFNfUEVSX1BBR0UpIHsKICAgICAgICBjb25zdCBwYWdlID0gbmV3IEJpdGZpZWxkUGFnZSgoaSArIGopIC8gV09SRFNfUEVSX1BBR0UsIHNlZ21lbnQpCiAgICAgICAgdGhpcy5fcGFnZXMuc2V0KHBhZ2UuaW5kZXgsIHBhZ2UpCiAgICAgIH0KICAgIH0KICB9CgogIHN0YXRpYyBmcm9tKGJpdGZpZWxkKSB7CiAgICByZXR1cm4gbmV3IEJpdGZpZWxkKGJpdGZpZWxkLnRvQnVmZmVyKGJpdGZpZWxkLl9wYWdlcy5tYXhMZW5ndGggKiBCSVRTX1BFUl9QQUdFKSkKICB9CgogIHRvQnVmZmVyKGxlbmd0aCkgewogICAgY29uc3QgcGFnZXMgPSBNYXRoLmNlaWwobGVuZ3RoIC8gQklUU19QRVJfUEFHRSkKICAgIGNvbnN0IGJ1ZmZlciA9IGI0YS5hbGxvY1Vuc2FmZShwYWdlcyAqIEJZVEVTX1BFUl9QQUdFKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFnZXM7IGkrKykgewogICAgICBjb25zdCBwYWdlID0gdGhpcy5fcGFnZXMuZ2V0KGkpCiAgICAgIGNvbnN0IG9mZnNldCA9IGkgKiBCWVRFU19QRVJfUEFHRQoKICAgICAgaWYgKHBhZ2UpIHsKICAgICAgICBjb25zdCBidWYgPSBiNGEuZnJvbSgKICAgICAgICAgIHBhZ2UuYml0ZmllbGQuYnVmZmVyLAogICAgICAgICAgcGFnZS5iaXRmaWVsZC5ieXRlT2Zmc2V0LAogICAgICAgICAgcGFnZS5iaXRmaWVsZC5ieXRlTGVuZ3RoCiAgICAgICAgKQoKICAgICAgICBidWZmZXIuc2V0KGJ1Ziwgb2Zmc2V0KQogICAgICB9IGVsc2UgewogICAgICAgIGJ1ZmZlci5maWxsKDAsIG9mZnNldCwgb2Zmc2V0ICsgQllURVNfUEVSX1BBR0UpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmZmVyCiAgfQoKICBnZXRCaXRmaWVsZChpbmRleCkgewogICAgY29uc3QgaSA9IHRoaXMuZ2V0UGFnZUluZGV4KGluZGV4KQoKICAgIGNvbnN0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKICAgIHJldHVybiBwIHx8IG51bGwKICB9CgogIG1lcmdlKGJpdGZpZWxkLCBsZW5ndGgpIHsKICAgIGxldCBpID0gMAoKICAgIHdoaWxlIChpIDwgbGVuZ3RoKSB7CiAgICAgIGNvbnN0IHN0YXJ0ID0gYml0ZmllbGQuZmlyc3RTZXQoaSkKICAgICAgaWYgKHN0YXJ0ID09PSAtMSkgYnJlYWsKCiAgICAgIGkgPSBiaXRmaWVsZC5maXJzdFVuc2V0KHN0YXJ0KQoKICAgICAgaWYgKGkgPT09IC0xIHx8IGkgPiBsZW5ndGgpIGkgPSBsZW5ndGgKCiAgICAgIHRoaXMuc2V0UmFuZ2Uoc3RhcnQsIGksIHRydWUpCgogICAgICBpZiAoaSA+PSBsZW5ndGgpIGJyZWFrCiAgICB9CiAgfQoKICBnZXQoaW5kZXgpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGNvbnN0IGkgPSAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBjb25zdCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgcmV0dXJuIHAgPyBwLmdldChqKSA6IGZhbHNlCiAgfQoKICBnZXRQYWdlQnl0ZUxlbmd0aCgpIHsKICAgIHJldHVybiBCWVRFU19QRVJfUEFHRQogIH0KCiAgZ2V0UGFnZUluZGV4KGluZGV4KSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICByZXR1cm4gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCiAgfQoKICBnZXRQYWdlKGluZGV4LCBjcmVhdGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdldFBhZ2VJbmRleChpbmRleCkKCiAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIGlmIChwKSByZXR1cm4gcAoKICAgIGlmICghY3JlYXRlKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgIGNvbnN0IHMgPQogICAgICB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwKICAgICAgdGhpcy5fc2VnbWVudHMuc2V0KAogICAgICAgIGssCiAgICAgICAgbmV3IEJpdGZpZWxkU2VnbWVudCgKICAgICAgICAgIGssCiAgICAgICAgICBuZXcgVWludDMyQXJyYXkoayA9PT0gMCA/IElOSVRJQUxfV09SRFNfUEVSX1NFR01FTlQgOiBXT1JEU19QRVJfU0VHTUVOVCkKICAgICAgICApCiAgICAgICkKCiAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBCaXRmaWVsZFBhZ2UoaSwgcykpCgogICAgcmV0dXJuIHAKICB9CgogIHNldChpbmRleCwgdmFsKSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICBpZiAoIXAgJiYgdmFsKSB7CiAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgY29uc3QgcyA9CiAgICAgICAgdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8CiAgICAgICAgdGhpcy5fc2VnbWVudHMuc2V0KAogICAgICAgICAgaywKICAgICAgICAgIG5ldyBCaXRmaWVsZFNlZ21lbnQoCiAgICAgICAgICAgIGssCiAgICAgICAgICAgIG5ldyBVaW50MzJBcnJheShrID09PSAwID8gSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCA6IFdPUkRTX1BFUl9TRUdNRU5UKQogICAgICAgICAgKQogICAgICAgICkKCiAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IEJpdGZpZWxkUGFnZShpLCBzKSkKICAgIH0KCiAgICBpZiAocCkgcC5zZXQoaiwgdmFsKQogIH0KCiAgc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsKSB7CiAgICBsZXQgaiA9IHN0YXJ0ICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAoc3RhcnQgLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgbGV0IHAgPSB0aGlzLl9wYWdlcy5nZXQoaSkKCiAgICAgIGlmICghcCAmJiB2YWwpIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgICAgY29uc3QgcyA9CiAgICAgICAgICB0aGlzLl9zZWdtZW50cy5nZXQoaykgfHwKICAgICAgICAgIHRoaXMuX3NlZ21lbnRzLnNldCgKICAgICAgICAgICAgaywKICAgICAgICAgICAgbmV3IEJpdGZpZWxkU2VnbWVudCgKICAgICAgICAgICAgICBrLAogICAgICAgICAgICAgIG5ldyBVaW50MzJBcnJheShrID09PSAwID8gSU5JVElBTF9XT1JEU19QRVJfU0VHTUVOVCA6IFdPUkRTX1BFUl9TRUdNRU5UKQogICAgICAgICAgICApCiAgICAgICAgICApCgogICAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IEJpdGZpZWxkUGFnZShpLCBzKSkKICAgICAgfQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gaSAqIEJJVFNfUEVSX1BBR0UKICAgICAgY29uc3QgbGFzdCA9IE1hdGgubWluKGVuZCAtIG9mZnNldCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBsYXN0IC0gagoKICAgICAgaWYgKHApIHAuc2V0UmFuZ2UoaiwgbGFzdCwgdmFsKQoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICAgIHN0YXJ0ICs9IHJhbmdlCiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGkgPCB0aGlzLl9zZWdtZW50cy5tYXhMZW5ndGgpIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChzKSBpbmRleCA9IHMuZmluZEZpcnN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1NFR01FTlQgKyBpbmRleAoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICB9CgogICAgcmV0dXJuIHZhbCA/IC0xIDogdGhpcy5fc2VnbWVudHMubWF4TGVuZ3RoICogQklUU19QRVJfU0VHTUVOVAogIH0KCiAgZmlyc3RTZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRGaXJzdCh0cnVlLCBwb3NpdGlvbikKICB9CgogIGZpcnN0VW5zZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRGaXJzdChmYWxzZSwgcG9zaXRpb24pCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1NFR01FTlQgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1NFR01FTlQKCiAgICB3aGlsZSAoaSA+PSAwKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocykgaW5kZXggPSBzLmZpbmRMYXN0KHZhbCwgaikKICAgICAgZWxzZSBpZiAoIXZhbCkgaW5kZXggPSBqCgogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gaSAqIEJJVFNfUEVSX1NFR01FTlQgKyBpbmRleAoKICAgICAgaiA9IEJJVFNfUEVSX1NFR01FTlQgLSAxCiAgICAgIGktLQogICAgfQoKICAgIHJldHVybiAtMQogIH0KCiAgbGFzdFNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZExhc3QodHJ1ZSwgcG9zaXRpb24pCiAgfQoKICBsYXN0VW5zZXQocG9zaXRpb24pIHsKICAgIHJldHVybiB0aGlzLmZpbmRMYXN0KGZhbHNlLCBwb3NpdGlvbikKICB9CgogIGhhc1NldChzdGFydCwgbGVuZ3RoKSB7CiAgICBjb25zdCBlbmQgPSBzdGFydCArIGxlbmd0aAoKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChpIDwgdGhpcy5fc2VnbWVudHMubWF4TGVuZ3RoKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocykgaW5kZXggPSBzLmZpbmRGaXJzdCh0cnVlLCBqKQoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9TRUdNRU5UICsgaW5kZXggPCBlbmQKCiAgICAgIGogPSAwCiAgICAgIGkrKwoKICAgICAgaWYgKGkgKiBCSVRTX1BFUl9TRUdNRU5UID49IGVuZCkgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBjb3VudChzdGFydCwgbGVuZ3RoLCB2YWwpIHsKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQogICAgbGV0IGMgPSAwCgogICAgd2hpbGUgKGxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgICAgY29uc3QgZW5kID0gTWF0aC5taW4oaiArIGxlbmd0aCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBlbmQgLSBqCgogICAgICBpZiAocCkgYyArPSBwLmNvdW50KGosIHJhbmdlLCB2YWwpCiAgICAgIGVsc2UgaWYgKCF2YWwpIGMgKz0gcmFuZ2UKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgICBsZW5ndGggLT0gcmFuZ2UKICAgIH0KCiAgICByZXR1cm4gYwogIH0KCiAgY291bnRTZXQoc3RhcnQsIGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuY291bnQoc3RhcnQsIGxlbmd0aCwgdHJ1ZSkKICB9CgogIGNvdW50VW5zZXQoc3RhcnQsIGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMuY291bnQoc3RhcnQsIGxlbmd0aCwgZmFsc2UpCiAgfQoKICAqd2FudChzdGFydCwgbGVuZ3RoKSB7CiAgICBjb25zdCBqID0gc3RhcnQgJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLl9zZWdtZW50cy5nZXQoaSkKCiAgICAgIGlmIChzKSB7CiAgICAgICAgLy8gV2UgYWx3YXlzIHNlbmQgYXQgbGVhc3QgNCBLaUIgd29ydGggb2YgYml0ZmllbGQgaW4gYSB3YW50LCByb3VuZGluZwogICAgICAgIC8vIHRvIHRoZSBuZWFyZXN0IDQgS2lCLgogICAgICAgIGNvbnN0IGVuZCA9IGNlaWxUbyhjbGFtcChsZW5ndGggLyA4LCA0MDk2LCBCWVRFU19QRVJfU0VHTUVOVCksIDQwOTYpCgogICAgICAgIHlpZWxkIHsKICAgICAgICAgIHN0YXJ0OiBpICogQklUU19QRVJfU0VHTUVOVCwKICAgICAgICAgIGJpdGZpZWxkOiBzLmJpdGZpZWxkLnN1YmFycmF5KDAsIGVuZCAvIDQpCiAgICAgICAgfQogICAgICB9CgogICAgICBpKysKICAgICAgbGVuZ3RoIC09IEJJVFNfUEVSX1NFR01FTlQKICAgIH0KICB9CgogIGNsZWFyKHR4KSB7CiAgICByZXR1cm4gdHguZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2UoMCwgLTEpCiAgfQoKICBvbnVwZGF0ZShyYW5nZXMpIHsKICAgIGZvciAoY29uc3QgeyBzdGFydCwgZW5kLCB2YWx1ZSB9IG9mIHJhbmdlcykgewogICAgICB0aGlzLnNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbHVlKQogICAgfQogIH0KCiAgc3RhdGljIGFzeW5jIG9wZW4oc3RvcmFnZSwgbGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IEJpdGZpZWxkKHN0b3JhZ2UsIG51bGwpCgogICAgY29uc3QgcGFnZXMgPSBNYXRoLmNlaWwobGVuZ3RoIC8gQklUU19QRVJfUEFHRSkKICAgIGNvbnN0IGJ1ZmZlciA9IGI0YS5hbGxvYyhwYWdlcyAqIEJZVEVTX1BFUl9QQUdFKQogICAgY29uc3Qgc3RyZWFtID0gc3RvcmFnZS5jcmVhdGVCaXRmaWVsZFN0cmVhbSh7IGx0OiBwYWdlcyB9KQoKICAgIGZvciBhd2FpdCAoY29uc3QgeyBpbmRleCwgcGFnZSB9IG9mIHN0cmVhbSkgewogICAgICBidWZmZXIuc2V0KHBhZ2UsIGluZGV4ICogQllURVNfUEVSX1BBR0UpCiAgICB9CgogICAgcmV0dXJuIG5ldyBCaXRmaWVsZChidWZmZXIpCiAgfQp9CgpmdW5jdGlvbiBjbGFtcChuLCBtaW4sIG1heCkgewogIHJldHVybiBNYXRoLm1pbihNYXRoLm1heChuLCBtaW4pLCBtYXgpCn0KCmZ1bmN0aW9uIGNlaWxUbyhuLCBtdWx0aXBsZSA9IDEpIHsKICBjb25zdCByZW1haW5kZXIgPSBuICUgbXVsdGlwbGUKICBpZiAocmVtYWluZGVyID09PSAwKSByZXR1cm4gbgogIHJldHVybiBuICsgbXVsdGlwbGUgLSByZW1haW5kZXIKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKCi8vIFRPRE86IHJlbmFtZSB0aGlzIHRvICJjcnlwdG8iIGFuZCBtb3ZlIGV2ZXJ5dGhpbmcgaGFzaGluZyByZWxhdGVkIGV0YyBpbiBoZXJlCi8vIEFsc28gbGV0cyBtb3ZlIHRoZSB0cmVlIHN0dWZmIGZyb20gaHlwZXJjb3JlLWNyeXB0byBoZXJlCgpjb25zdCBbCiAgVFJFRSwKICBSRVBMSUNBVEVfSU5JVElBVE9SLAogIFJFUExJQ0FURV9SRVNQT05ERVIsCiAgTUFOSUZFU1QsCiAgREVGQVVMVF9OQU1FU1BBQ0UsCiAgREVGQVVMVF9FTkNSWVBUSU9OCl0gPSBjcnlwdG8ubmFtZXNwYWNlKCdoeXBlcmNvcmUnLCA2KQoKZXhwb3J0cy5NQU5JRkVTVCA9IE1BTklGRVNUCmV4cG9ydHMuREVGQVVMVF9OQU1FU1BBQ0UgPSBERUZBVUxUX05BTUVTUEFDRQpleHBvcnRzLkRFRkFVTFRfRU5DUllQVElPTiA9IERFRkFVTFRfRU5DUllQVElPTgoKZXhwb3J0cy5yZXBsaWNhdGUgPSBmdW5jdGlvbiAoaXNJbml0aWF0b3IsIGtleSwgaGFuZHNoYWtlSGFzaCkgewogIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKAogICAgb3V0LAogICAgW2lzSW5pdGlhdG9yID8gUkVQTElDQVRFX0lOSVRJQVRPUiA6IFJFUExJQ0FURV9SRVNQT05ERVIsIGtleV0sCiAgICBoYW5kc2hha2VIYXNoCiAgKQogIHJldHVybiBvdXQKfQoKZXhwb3J0cy50cmVlU2lnbmFibGUgPSBmdW5jdGlvbiAobWFuaWZlc3RIYXNoLCB0cmVlSGFzaCwgbGVuZ3RoLCBmb3JrKSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDExMiwgYnVmZmVyOiBiNGEuYWxsb2NVbnNhZmUoMTEyKSB9CiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgVFJFRSkKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtYW5pZmVzdEhhc2gpCiAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgdHJlZUhhc2gpCiAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBsZW5ndGgpCiAgYy51aW50NjQuZW5jb2RlKHN0YXRlLCBmb3JrKQogIHJldHVybiBzdGF0ZS5idWZmZXIKfQoKZXhwb3J0cy50cmVlU2lnbmFibGVDb21wYXQgPSBmdW5jdGlvbiAoaGFzaCwgbGVuZ3RoLCBmb3JrLCBub0hlYWRlcikgewogIGNvbnN0IGVuZCA9IG5vSGVhZGVyID8gNDggOiA4MAogIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kLCBidWZmZXI6IGI0YS5hbGxvY1Vuc2FmZShlbmQpIH0KICBpZiAoIW5vSGVhZGVyKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBUUkVFKSAvLyB1bHRyYSBsZWdhY3kgbW9kZSwga2lsbCBpbiBmdXR1cmUgbWFqb3IKICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBoYXNoKQogIGMudWludDY0LmVuY29kZShzdGF0ZSwgbGVuZ3RoKQogIGMudWludDY0LmVuY29kZShzdGF0ZSwgZm9yaykKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KLy8gRXhwb3J0IHRoZSBhcHByb3ByaWF0ZSB2ZXJzaW9uIG9mIGBxdWlja2JpdC11bml2ZXJzYWxgIGFzIHRoZSBwbGFpbiBpbXBvcnQKLy8gbWF5IHJlc29sdmUgdG8gYW4gb2xkZXIgdmVyc2lvbiBpbiBzb21lIGVudmlyb25tZW50cwpsZXQgcXVpY2tiaXQgPSByZXF1aXJlKCdxdWlja2JpdC11bml2ZXJzYWwnKQppZiAoCiAgdHlwZW9mIHF1aWNrYml0LmZpbmRGaXJzdCAhPT0gJ2Z1bmN0aW9uJyB8fAogIHR5cGVvZiBxdWlja2JpdC5maW5kTGFzdCAhPT0gJ2Z1bmN0aW9uJyB8fAogIHR5cGVvZiBxdWlja2JpdC5jbGVhciAhPT0gJ2Z1bmN0aW9uJwopIHsKICAvLyBUaGlzIHNob3VsZCBhbHdheXMgbG9hZCB0aGUgZmFsbGJhY2sgZnJvbSB0aGUgbG9jYWxseSBpbnN0YWxsZWQgdmVyc2lvbgogIHF1aWNrYml0ID0gcmVxdWlyZSgncXVpY2tiaXQtdW5pdmVyc2FsL2ZhbGxiYWNrJykKfQpleHBvcnRzLnF1aWNrYml0ID0gcXVpY2tiaXQKY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJ3F1aWNrYml0LXVuaXZlcnNhbCcpCmNvbnN0IEJpdGZpZWxkID0gcmVxdWlyZSgnLi9iaXRmaWVsZCcpCgpjb25zdCBNQVhfQkFUQ0hfVVNFRCA9IDQgKiAxMDI0ICogMTAyNApjb25zdCBNSU5fQkFUQ0hfVVNFRCA9IDUxMiAqIDEwMjQKCi8vIGp1c3QgaW4gaXRzIG93biBmaWxlIGFzIGl0cyBhIGJpdCBpbnZvbHZlZAoKbW9kdWxlLmV4cG9ydHMgPSBjb3B5UHJvbG9ndWUKCmFzeW5jIGZ1bmN0aW9uIGNvcHlQcm9sb2d1ZShzcmMsIGRzdCkgewogIGNvbnN0IHByb2xvZ3VlID0gZHN0LmhlYWRlci5tYW5pZmVzdC5wcm9sb2d1ZQoKICBpZiAoc3JjLmxlbmd0aCA8IHByb2xvZ3VlLmxlbmd0aCB8fCBwcm9sb2d1ZS5sZW5ndGggPT09IDApIHJldHVybgoKICBjb25zdCBzdGFjayA9IFtdCiAgY29uc3Qgcm9vdHMgPSBmbGF0LmZ1bGxSb290cyhwcm9sb2d1ZS5sZW5ndGggKiAyKQogIGNvbnN0IGJhdGNoID0geyByb290cywgZmlyc3Q6IHRydWUsIGxhc3Q6IGZhbHNlLCBjb250aWc6IDAsIHVzZWQ6IDAsIHRyZWU6IFtdLCBibG9ja3M6IFtdIH0KCiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewogICAgY29uc3Qgbm9kZSA9IHJvb3RzW2ldCiAgICBiYXRjaC50cmVlLnB1c2gobm9kZSkKICAgIHN0YWNrLnB1c2gobm9kZSkKICB9CgogIGxldCBsYXN0UGFnZSA9IC0xCiAgbGV0IGxhc3RCbG9jayA9IC0xCgogIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzcmMuc3RvcmFnZS5jcmVhdGVCbG9ja1N0cmVhbSh7CiAgICBndGU6IDAsCiAgICBsdDogcHJvbG9ndWUubGVuZ3RoLAogICAgcmV2ZXJzZTogdHJ1ZQogIH0pKSB7CiAgICBpZiAod2Fsa1RyZWUoc3RhY2ssIGRhdGEuaW5kZXggKiAyLCBiYXRjaCkgPT09IGZhbHNlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBibG9jayBvciB0cmVlIG5vZGUgZm9yICcgKyBkYXRhLmluZGV4KQogICAgfQoKICAgIGJhdGNoLmNvbnRpZyA9IGRhdGEuaW5kZXggKyAxID09PSBsYXN0QmxvY2sgPyBiYXRjaC5jb250aWcgKyAxIDogMQogICAgbGFzdEJsb2NrID0gZGF0YS5pbmRleAoKICAgIGNvbnN0IHBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UoZGF0YS5pbmRleCkKICAgIGJhdGNoLmJsb2Nrcy5wdXNoKGRhdGEpCgogICAgaWYgKGxhc3RQYWdlICE9PSBwYWdlKSBiYXRjaC51c2VkICs9IDQwOTYKICAgIGJhdGNoLnVzZWQgKz0gTWF0aC5tYXgoZGF0YS52YWx1ZS5ieXRlTGVuZ3RoLCAxMjgpIC8vIDEyOCBpcyBqdXN0IGEgc2FuaXR5IG51bWJlciB0byBhdm9pZCBtZWdhIGJhdGNoZXMKCiAgICAvLyBhbHdheXMgc2FmZSB0byBwYXJ0aWFsbHkgZmx1c2ggc28gd2UgZG8gdGhhdCBvbmRlbWFuZCB0byByZWR1Y2UgbWVtb3J5IHVzYWdlLi4uCiAgICBpZiAoKGJhdGNoLnVzZWQgPj0gTUlOX0JBVENIX1VTRUQgJiYgcGFnZSAhPT0gbGFzdFBhZ2UpIHx8IGJhdGNoLnVzZWQgPj0gTUFYX0JBVENIX1VTRUQpIHsKICAgICAgYXdhaXQgZmx1c2hCYXRjaChwcm9sb2d1ZSwgc3JjLCBkc3QsIGJhdGNoKQogICAgfQoKICAgIGxhc3RQYWdlID0gcGFnZQogIH0KCiAgaWYgKGxhc3RCbG9jayAhPT0gMCkgYmF0Y2guY29udGlnID0gMAoKICBiYXRjaC5sYXN0ID0gdHJ1ZQogIGF3YWl0IGZsdXNoQmF0Y2gocHJvbG9ndWUsIHNyYywgZHN0LCBiYXRjaCkKfQoKYXN5bmMgZnVuY3Rpb24gZmx1c2hCYXRjaChwcm9sb2d1ZSwgc3JjLCBkc3QsIGJhdGNoKSB7CiAgY29uc3Qgbm9kZVByb21pc2VzID0gW10KCiAgY29uc3Qgc3JjUmVhZGVyID0gc3JjLnN0b3JhZ2UucmVhZCgpCiAgZm9yIChjb25zdCBpbmRleCBvZiBiYXRjaC50cmVlKSB7CiAgICBub2RlUHJvbWlzZXMucHVzaChzcmNSZWFkZXIuZ2V0VHJlZU5vZGUoaW5kZXgpKQogIH0KICBzcmNSZWFkZXIudHJ5Rmx1c2goKQoKICBjb25zdCBub2RlcyA9IGF3YWl0IFByb21pc2UuYWxsKG5vZGVQcm9taXNlcykKCiAgY29uc3QgcGFnZVByb21pc2VzID0gW10KICBjb25zdCBkc3RSZWFkZXIgPSBkc3Quc3RvcmFnZS5yZWFkKCkKCiAgY29uc3QgaGVhZFByb21pc2UgPSBiYXRjaC5maXJzdCA/IGRzdFJlYWRlci5nZXRIZWFkKCkgOiBudWxsCiAgaWYgKGhlYWRQcm9taXNlKSBoZWFkUHJvbWlzZS5jYXRjaChub29wKQoKICBsZXQgbGFzdFBhZ2UgPSAtMQogIGZvciAoY29uc3QgeyBpbmRleCB9IG9mIGJhdGNoLmJsb2NrcykgewogICAgY29uc3QgcGFnZSA9IGdldEJpdGZpZWxkUGFnZShpbmRleCkKICAgIGlmIChwYWdlID09PSBsYXN0UGFnZSkgY29udGludWUKICAgIGxhc3RQYWdlID0gcGFnZQogICAgcGFnZVByb21pc2VzLnB1c2goZHN0UmVhZGVyLmdldEJpdGZpZWxkUGFnZShwYWdlKSkKICB9CgogIGRzdFJlYWRlci50cnlGbHVzaCgpCgogIGNvbnN0IHBhZ2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocGFnZVByb21pc2VzKQogIGNvbnN0IGhlYWQgPSBoZWFkUHJvbWlzZSA9PT0gbnVsbCA/IG51bGwgOiBhd2FpdCBoZWFkUHJvbWlzZQogIGNvbnN0IHVzZXJEYXRhID0gW10KCiAgLy8gcmVhZHMgZG9uZSEKCiAgaWYgKGJhdGNoLmZpcnN0KSB7CiAgICBjb25zdCByb290cyA9IG5vZGVzLnNsaWNlKDAsIGJhdGNoLnJvb3RzLmxlbmd0aCkKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsKICAgICAgaWYgKCFub2RlKSB0aHJvdyBuZXcgRXJyb3IoJ01pc3Npbmcgbm9kZXMgZm9yIHByb2xvZ3VlIGhhc2gnKQogICAgfQoKICAgIGNvbnN0IHRyZWVIYXNoID0gY3J5cHRvLnRyZWUocm9vdHMpCiAgICBpZiAoIWI0YS5lcXVhbHModHJlZUhhc2gsIHByb2xvZ3VlLmhhc2gpKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb2xvZ3VlIGRvZXMgbm90IG1hdGNoIHNvdXJjZScpCiAgfQoKICBpZiAoYmF0Y2guZmlyc3QpIHsKICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBzcmMuc3RvcmFnZS5jcmVhdGVVc2VyRGF0YVN0cmVhbSgpKSB1c2VyRGF0YS5wdXNoKGRhdGEpCiAgfQoKICBmb3IgKGxldCBpID0gMDsgaSA8IHBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIXBhZ2VzW2ldKSBwYWdlc1tpXSA9IGI0YS5hbGxvYyg0MDk2KQogIH0KCiAgY29uc3QgdHggPSBkc3Quc3RvcmFnZS53cml0ZSgpCgogIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgdHgucHV0VHJlZU5vZGUobm9kZSkKCiAgbGFzdFBhZ2UgPSAtMQogIGxldCBwYWdlSW5kZXggPSAtMQoKICBmb3IgKGNvbnN0IHsgaW5kZXgsIHZhbHVlIH0gb2YgYmF0Y2guYmxvY2tzKSB7CiAgICBjb25zdCBwYWdlID0gZ2V0Qml0ZmllbGRQYWdlKGluZGV4KQoKICAgIGlmIChwYWdlICE9PSBsYXN0UGFnZSkgewogICAgICBsYXN0UGFnZSA9IHBhZ2UKICAgICAgcGFnZUluZGV4KysKICAgICAgLy8gcXVldWUgdGhlIHBhZ2Ugbm93LCB3ZSBtdXRhdGUgaXQgYmVsb3cgYnV0IGl0cyB0aGUgc2FtZSByZWYKICAgICAgdHgucHV0Qml0ZmllbGRQYWdlKHBhZ2VJbmRleCwgcGFnZXNbcGFnZUluZGV4XSkKICAgIH0KCiAgICBjb25zdCBwYWdlQnVmZmVyID0gcGFnZXNbcGFnZUluZGV4XQogICAgcXVpY2tiaXQuc2V0KHBhZ2VCdWZmZXIsIGdldEJpdGZpZWxkT2Zmc2V0KGluZGV4KSwgdHJ1ZSkKICAgIHR4LnB1dEJsb2NrKGluZGV4LCB2YWx1ZSkKICB9CgogIGZvciAoY29uc3QgeyBrZXksIHZhbHVlIH0gb2YgdXNlckRhdGEpIHsKICAgIHR4LnB1dFVzZXJEYXRhKGtleSwgdmFsdWUpCiAgfQoKICBsZXQgdXBncmFkZWQgPSBiYXRjaC5maXJzdCAmJiAhaGVhZAogIGlmICh1cGdyYWRlZCkgewogICAgdHguc2V0SGVhZChwcm9sb2d1ZVRvVHJlZShwcm9sb2d1ZSkpCiAgfQoKICBhd2FpdCB0eC5mbHVzaCgpCgogIGlmICh1cGdyYWRlZCkgewogICAgY29uc3Qgcm9vdHMgPSBub2Rlcy5zbGljZSgwLCBiYXRjaC5yb290cy5sZW5ndGgpCiAgICBkc3Quc3RhdGUuc2V0Um9vdHMocm9vdHMpCiAgICBkc3QuaGVhZGVyLnRyZWUgPSBwcm9sb2d1ZVRvVHJlZShwcm9sb2d1ZSkKICB9CgogIGlmICh1c2VyRGF0YS5sZW5ndGggPiAwKSB7CiAgICBkc3QuaGVhZGVyLnVzZXJEYXRhID0gdXNlckRhdGEuY29uY2F0KGRzdC5oZWFkZXIudXNlckRhdGEpCiAgfQoKICBpZiAoYmF0Y2guY29udGlnKSB7CiAgICAvLyBUT0RPOiB3ZSBuZWVkIHRvIHBlcnNpc3QgdGhpcyBzb21laG93CiAgICBkc3QuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggPSBiYXRjaC5jb250aWcKICB9CgogIGxldCBzdGFydCA9IDAKICBsZXQgbGVuZ3RoID0gMAoKICAvLyB1cGRhdGUgaW4gbWVtb3J5IGJpdGZpZWxkCiAgZm9yIChjb25zdCB7IGluZGV4IH0gb2YgYmF0Y2guYmxvY2tzKSB7CiAgICBpZiAoc3RhcnQgPT09IDAgfHwgc3RhcnQgLSAxID09PSBpbmRleCkgewogICAgICBsZW5ndGgrKwogICAgfSBlbHNlIHsKICAgICAgaWYgKGxlbmd0aCA+IDApIHNpZ25hbFJlcGxpY2F0b3IoZHN0LCB1cGdyYWRlZCwgc3RhcnQsIGxlbmd0aCkKICAgICAgdXBncmFkZWQgPSBmYWxzZQogICAgICBsZW5ndGggPSAxCiAgICB9CgogICAgc3RhcnQgPSBpbmRleAogICAgZHN0LmJpdGZpZWxkLnNldChpbmRleCwgdHJ1ZSkKICB9CgogIGlmIChsZW5ndGggPiAwKSBzaWduYWxSZXBsaWNhdG9yKGRzdCwgdXBncmFkZWQsIHN0YXJ0LCBsZW5ndGgpCgogIC8vIHVubGluawogIGJhdGNoLnRyZWUgPSBbXQogIGJhdGNoLmJsb2NrcyA9IFtdCiAgYmF0Y2guZmlyc3QgPSBmYWxzZQogIGJhdGNoLnVzZWQgPSAwCn0KCmZ1bmN0aW9uIHNpZ25hbFJlcGxpY2F0b3IoY29yZSwgdXBncmFkZWQsIHN0YXJ0LCBsZW5ndGgpIHsKICBpZiAodXBncmFkZWQpIHsKICAgIGNvcmUucmVwbGljYXRvci5jb3JrKCkKICAgIGNvcmUucmVwbGljYXRvci5vbmhhdmUoc3RhcnQsIGxlbmd0aCwgZmFsc2UpCiAgICBjb3JlLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIGNvcmUucmVwbGljYXRvci51bmNvcmsoKQogIH0gZWxzZSB7CiAgICBjb3JlLnJlcGxpY2F0b3Iub25oYXZlKHN0YXJ0LCBsZW5ndGgsIGZhbHNlKQogIH0KfQoKZnVuY3Rpb24gcHJvbG9ndWVUb1RyZWUocHJvbG9ndWUpIHsKICByZXR1cm4gewogICAgZm9yazogMCwKICAgIGxlbmd0aDogcHJvbG9ndWUubGVuZ3RoLAogICAgcm9vdEhhc2g6IHByb2xvZ3VlLmhhc2gsCiAgICBzaWduYXR1cmU6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGdldEJpdGZpZWxkUGFnZShpbmRleCkgewogIHJldHVybiBNYXRoLmZsb29yKGluZGV4IC8gQml0ZmllbGQuQklUU19QRVJfUEFHRSkKfQoKZnVuY3Rpb24gZ2V0Qml0ZmllbGRPZmZzZXQoaW5kZXgpIHsKICByZXR1cm4gaW5kZXggJiAoQml0ZmllbGQuQklUU19QRVJfUEFHRSAtIDEpCn0KCmZ1bmN0aW9uIHdhbGtUcmVlKHN0YWNrLCB0YXJnZXQsIGJhdGNoKSB7CiAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKQoKICAgIGlmICgobm9kZSAmIDEpID09PSAwKSB7CiAgICAgIGlmIChub2RlID09PSB0YXJnZXQpIHJldHVybiB0cnVlCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihub2RlKQogICAgaWYgKCFpdGUuY29udGFpbnModGFyZ2V0KSkgY29udGludWUKCiAgICB3aGlsZSAoKGl0ZS5pbmRleCAmIDEpICE9PSAwKSB7CiAgICAgIGNvbnN0IGxlZnQgPSBpdGUubGVmdENoaWxkKCkKICAgICAgY29uc3QgcmlnaHQgPSBpdGUuc2libGluZygpIC8vIGlzIHJpZ2h0IGNoaWxkCgogICAgICBiYXRjaC50cmVlLnB1c2gobGVmdCwgcmlnaHQpCgogICAgICBpZiAoaXRlLmNvbnRhaW5zKHRhcmdldCkpIHN0YWNrLnB1c2gobGVmdCkKICAgICAgZWxzZSBpdGUuc2libGluZygpCiAgICB9CgogICAgaWYgKGl0ZS5pbmRleCA9PT0gdGFyZ2V0KSByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKY29uc3QgejMyID0gcmVxdWlyZSgnejMyJykKY29uc3QgTXV0ZXggPSByZXF1aXJlKCcuL211dGV4JykKY29uc3QgeyBNZXJrbGVUcmVlLCBSZW9yZ0JhdGNoIH0gPSByZXF1aXJlKCcuL21lcmtsZS10cmVlJykKY29uc3QgQml0SW50ZXJsdWRlID0gcmVxdWlyZSgnLi9iaXQtaW50ZXJsdWRlJykKY29uc3QgQml0ZmllbGQgPSByZXF1aXJlKCcuL2JpdGZpZWxkJykKY29uc3QgUmVtb3RlQml0ZmllbGQgPSByZXF1aXJlKCcuL3JlbW90ZS1iaXRmaWVsZCcpCmNvbnN0IHsKICBCQURfQVJHVU1FTlQsCiAgU1RPUkFHRV9FTVBUWSwKICBTVE9SQUdFX0NPTkZMSUNULAogIElOVkFMSURfU0lHTkFUVVJFLAogIElOVkFMSURfQ0hFQ0tTVU0KfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQpjb25zdCBWZXJpZmllciA9IHJlcXVpcmUoJy4vdmVyaWZpZXInKQpjb25zdCBhdWRpdCA9IHJlcXVpcmUoJy4vYXVkaXQnKQpjb25zdCBjb3B5UHJvbG9ndWUgPSByZXF1aXJlKCcuL2NvcHktcHJvbG9ndWUnKQpjb25zdCBTZXNzaW9uU3RhdGUgPSByZXF1aXJlKCcuL3Nlc3Npb24tc3RhdGUnKQpjb25zdCBSZXBsaWNhdG9yID0gcmVxdWlyZSgnLi9yZXBsaWNhdG9yJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ29yZSB7CiAgY29uc3RydWN0b3IoZGIsIG9wdHMgPSB7fSkgewogICAgdGhpcy5kYiA9IGRiCiAgICB0aGlzLnN0b3JhZ2UgPSBudWxsCiAgICB0aGlzLnJlcGxpY2F0b3IgPSBuZXcgUmVwbGljYXRvcih0aGlzLCBvcHRzKQogICAgdGhpcy5zZXNzaW9uU3RhdGVzID0gW10KICAgIHRoaXMubW9uaXRvcnMgPSBbXQogICAgdGhpcy5hY3RpdmVTZXNzaW9ucyA9IDAKICAgIHRoaXMuZ2MgPSAwIC8vIGNvcmVzdG9yZSB1c2VzIHRoaXMgdG8gbWFpbiBhIGdjIHN0cmlrZSBwb29sCgogICAgdGhpcy5pZCA9IG9wdHMua2V5ID8gejMyLmVuY29kZShvcHRzLmtleSkgOiBudWxsCiAgICB0aGlzLmtleSA9IG9wdHMua2V5IHx8IG51bGwKICAgIHRoaXMuZGlzY292ZXJ5S2V5ID0gb3B0cy5kaXNjb3ZlcnlLZXkgfHwgKG9wdHMua2V5ICYmIGNyeXB0by5kaXNjb3ZlcnlLZXkob3B0cy5rZXkpKSB8fCBudWxsCiAgICB0aGlzLm1hbmlmZXN0ID0gbnVsbAogICAgdGhpcy5vcGVuaW5nID0gbnVsbAogICAgdGhpcy5jbG9zaW5nID0gbnVsbAogICAgdGhpcy5leGNsdXNpdmUgPSBudWxsCgogICAgdGhpcy5wcmV1cGRhdGUgPSBudWxsCiAgICB0aGlzLmhlYWRlciA9IG51bGwKICAgIHRoaXMuY29tcGF0ID0gZmFsc2UKICAgIHRoaXMuYml0ZmllbGQgPSBudWxsCiAgICB0aGlzLnZlcmlmaWVyID0gbnVsbAogICAgdGhpcy50cnVuY2F0aW5nID0gMAogICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCiAgICB0aGlzLnNraXBCaXRmaWVsZCA9IG51bGwKICAgIHRoaXMuZ2xvYmFsQ2FjaGUgPSBvcHRzLmdsb2JhbENhY2hlIHx8IG51bGwKICAgIHRoaXMuYXV0b0Nsb3NlID0gb3B0cy5hdXRvQ2xvc2UgIT09IGZhbHNlCiAgICB0aGlzLm9uaWRsZSA9IG5vb3AKCiAgICB0aGlzLnN0YXRlID0gbnVsbAogICAgdGhpcy5vcGVuZWQgPSBmYWxzZQogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQoKICAgIHRoaXMuaGludHNDaGFuZ2VkID0gZmFsc2UKCiAgICB0aGlzLl9iaXRmaWVsZCA9IG51bGwKICAgIHRoaXMuX3ZlcmlmaWVzID0gbnVsbAogICAgdGhpcy5fdmVyaWZpZXNGbHVzaGVkID0gbnVsbAogICAgdGhpcy5fbGVnYWN5ID0gISFvcHRzLmxlZ2FjeQoKICAgIHRoaXMub3BlbmluZyA9IHRoaXMuX29wZW4ob3B0cykKICAgIHRoaXMub3BlbmluZy5jYXRjaChub29wKQogIH0KCiAgcmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5vcGVuaW5nCiAgfQoKICBhZGRNb25pdG9yKHMpIHsKICAgIGlmIChzLl9tb25pdG9ySW5kZXggPj0gMCkgcmV0dXJuCiAgICBzLl9tb25pdG9ySW5kZXggPSB0aGlzLm1vbml0b3JzLnB1c2gocykgLSAxCiAgfQoKICByZW1vdmVNb25pdG9yKHMpIHsKICAgIGlmIChzLl9tb25pdG9ySW5kZXggPCAwKSByZXR1cm4KICAgIGNvbnN0IGhlYWQgPSB0aGlzLm1vbml0b3JzLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gcykgdGhpcy5tb25pdG9yc1soaGVhZC5fbW9uaXRvckluZGV4ID0gcy5fbW9uaXRvckluZGV4KV0gPSBoZWFkCiAgICBzLl9tb25pdG9ySW5kZXggPSAtMQogIH0KCiAgZW1pdE1hbmlmZXN0KCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMubW9uaXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5tb25pdG9yc1tpXS5lbWl0KCdtYW5pZmVzdCcpCiAgICB9CiAgfQoKICBjcmVhdGVVc2VyRGF0YVN0cmVhbShvcHRzLCBzZXNzaW9uID0gdGhpcy5zdGF0ZSkgewogICAgcmV0dXJuIHNlc3Npb24uc3RvcmFnZS5jcmVhdGVVc2VyRGF0YVN0cmVhbShvcHRzKQogIH0KCiAgYWxsU2Vzc2lvbnMoKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IFtdCiAgICBmb3IgKGNvbnN0IHN0YXRlIG9mIHRoaXMuc2Vzc2lvblN0YXRlcykgewogICAgICBpZiAoc3RhdGUuc2Vzc2lvbnMubGVuZ3RoKSBzZXNzaW9ucy5wdXNoKC4uLnN0YXRlLnNlc3Npb25zKQogICAgfQogICAgcmV0dXJuIHNlc3Npb25zCiAgfQoKICBoYXNTZXNzaW9uKCkgewogICAgcmV0dXJuIHRoaXMuYWN0aXZlU2Vzc2lvbnMgIT09IDAKICB9CgogIGNvbXBhY3QoKSB7CiAgICBjb25zdCBjb21wYWN0aW5nID0gW10KICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnNlc3Npb25TdGF0ZXMpIHsKICAgICAgY29tcGFjdGluZy5wdXNoKHMuc3RvcmFnZS5jb21wYWN0KCkpCiAgICB9CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoY29tcGFjdGluZykKICB9CgogIGNoZWNrSWZJZGxlKCkgewogICAgaWYgKCF0aGlzLm9wZW5lZCB8fCB0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSB8fCB0aGlzLmhhc1Nlc3Npb24oKSA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBpZiAodGhpcy5yZXBsaWNhdG9yLmlkbGUoKSA9PT0gZmFsc2UpIHJldHVybgogICAgaWYgKHRoaXMuc3RhdGUgPT09IG51bGwgfHwgdGhpcy5zdGF0ZS5tdXRleC5pZGxlKCkgPT09IGZhbHNlKSByZXR1cm4KICAgIHRoaXMub25pZGxlKCkKICB9CgogIGFzeW5jIGxvY2tFeGNsdXNpdmUoKSB7CiAgICBpZiAodGhpcy5leGNsdXNpdmUgPT09IG51bGwpIHRoaXMuZXhjbHVzaXZlID0gbmV3IE11dGV4KCkKICAgIGF3YWl0IHRoaXMuZXhjbHVzaXZlLmxvY2soKQogIH0KCiAgdW5sb2NrRXhjbHVzaXZlKCkgewogICAgaWYgKHRoaXMuZXhjbHVzaXZlICE9PSBudWxsKSB0aGlzLmV4Y2x1c2l2ZS51bmxvY2soKQogIH0KCiAgYXN5bmMgX29wZW4ob3B0cykgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fdHJ5T3BlbihvcHRzKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMub25pZGxlKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgfQoKICBhc3luYyBfdHJ5T3BlbihvcHRzKSB7CiAgICBpZiAob3B0cy5wcmVvcGVuKSBhd2FpdCBvcHRzLnByZW9wZW4gLy8ganVzdCBhIGhvb2sgdG8gYWxsb3cgZXhjbHVzaXZlIGFjY2VzcyBoZXJlLi4uCgogICAgbGV0IHN0b3JhZ2UgPSBhd2FpdCB0aGlzLmRiLnJlc3VtZUNvcmUodGhpcy5kaXNjb3ZlcnlLZXkpCgogICAgbGV0IG92ZXJ3cml0ZSA9IG9wdHMub3ZlcndyaXRlID09PSB0cnVlCgogICAgY29uc3QgZm9yY2UgPSBvcHRzLmZvcmNlID09PSB0cnVlCiAgICBjb25zdCBjcmVhdGVJZk1pc3NpbmcgPSBvcHRzLmNyZWF0ZUlmTWlzc2luZyAhPT0gZmFsc2UKICAgIC8vIGtpbGwgdGhpcyBmbGFnIHNvb24KICAgIGNvbnN0IGxlZ2FjeSA9ICEhb3B0cy5sZWdhY3kKCiAgICAvLyBkZWZhdWx0IHRvIHRydWUgZm9yIG5vdyBpZiBubyBtYW5pZmVzdCBpcyBwcm92aWRlZAogICAgbGV0IGNvbXBhdCA9IG9wdHMuY29tcGF0ID09PSB0cnVlIHx8IChvcHRzLmNvbXBhdCAhPT0gZmFsc2UgJiYgIW9wdHMubWFuaWZlc3QpCgogICAgbGV0IGhlYWRlciA9IHN0b3JhZ2UgPyBwYXJzZUhlYWRlcihhd2FpdCBnZXRDb3JlSW5mbyhzdG9yYWdlKSkgOiBudWxsCgogICAgY29uc3QgaGFkTWFuaWZlc3QgPSAhIWhlYWRlciAmJiAhIWhlYWRlci5tYW5pZmVzdCAmJiAhIWhlYWRlci5rZXkKICAgIGNvbnN0IGhhZEtleVBhaXIgPSAhIWhlYWRlciAmJiAhIWhlYWRlci5rZXlQYWlyCgogICAgaWYgKGZvcmNlICYmIG9wdHMua2V5ICYmIGhlYWRlciAmJiAhYjRhLmVxdWFscyhoZWFkZXIua2V5LCBvcHRzLmtleSkpIHsKICAgICAgb3ZlcndyaXRlID0gdHJ1ZQogICAgfQoKICAgIGlmICghaGVhZGVyICYmIG9wdHMuZGlzY292ZXJ5S2V5ICYmICEob3B0cy5rZXkgfHwgb3B0cy5tYW5pZmVzdCkpIHsKICAgICAgdGhyb3cgU1RPUkFHRV9FTVBUWSgnTm8gSHlwZXJjb3JlIGlzIHN0b3JlZCBoZXJlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgaWYgKCFoZWFkZXIgfHwgb3ZlcndyaXRlKSB7CiAgICAgIGlmICghY3JlYXRlSWZNaXNzaW5nKSB7CiAgICAgICAgdGhyb3cgU1RPUkFHRV9FTVBUWSgnTm8gSHlwZXJjb3JlIGlzIHN0b3JlZCBoZXJlJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIGlmIChjb21wYXQpIHsKICAgICAgICBpZiAob3B0cy5rZXkgJiYgb3B0cy5rZXlQYWlyICYmICFiNGEuZXF1YWxzKG9wdHMua2V5LCBvcHRzLmtleVBhaXIucHVibGljS2V5KSkgewogICAgICAgICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdLZXkgbXVzdCBtYXRjaCBwdWJsaWNLZXkgd2hlbiBpbiBjb21wYXQgbW9kZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3Qga2V5UGFpciA9IG9wdHMua2V5UGFpciB8fCAob3B0cy5rZXkgPyBudWxsIDogY3J5cHRvLmtleVBhaXIoKSkKCiAgICAgIGNvbnN0IGRlZmF1bHRNYW5pZmVzdCA9CiAgICAgICAgIW9wdHMubWFuaWZlc3QgJiYKICAgICAgICAoISFvcHRzLmNvbXBhdCB8fCAhb3B0cy5rZXkgfHwgISEoa2V5UGFpciAmJiBiNGEuZXF1YWxzKG9wdHMua2V5LCBrZXlQYWlyLnB1YmxpY0tleSkpKQogICAgICBjb25zdCBtYW5pZmVzdCA9IGRlZmF1bHRNYW5pZmVzdAogICAgICAgID8gVmVyaWZpZXIuZGVmYXVsdFNpZ25lck1hbmlmZXN0KG9wdHMua2V5IHx8IGtleVBhaXIucHVibGljS2V5KQogICAgICAgIDogVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3Qob3B0cy5tYW5pZmVzdCkKCiAgICAgIGhlYWRlciA9IHsKICAgICAgICBrZXk6IG9wdHMua2V5IHx8IChjb21wYXQgPyBtYW5pZmVzdC5zaWduZXJzWzBdLnB1YmxpY0tleSA6IFZlcmlmaWVyLm1hbmlmZXN0SGFzaChtYW5pZmVzdCkpLAogICAgICAgIG1hbmlmZXN0LAogICAgICAgIGtleVBhaXI6IGtleVBhaXIKICAgICAgICAgID8geyBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LCBzZWNyZXRLZXk6IGtleVBhaXIuc2VjcmV0S2V5IHx8IG51bGwgfQogICAgICAgICAgOiBudWxsLAogICAgICAgIGZyb3plbjogZmFsc2UsCiAgICAgICAgdHJlZTogewogICAgICAgICAgZm9yazogMCwKICAgICAgICAgIGxlbmd0aDogMCwKICAgICAgICAgIHJvb3RIYXNoOiBudWxsLAogICAgICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICAgICAgfSwKICAgICAgICBoaW50czogewogICAgICAgICAgcmVvcmdzOiBbXSwKICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IDAsCiAgICAgICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiAwCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBkaXNjb3ZlcnlLZXkgPSBvcHRzLmRpc2NvdmVyeUtleSB8fCBjcnlwdG8uZGlzY292ZXJ5S2V5KGhlYWRlci5rZXkpCgogICAgICBzdG9yYWdlID0gYXdhaXQgdGhpcy5kYi5jcmVhdGVDb3JlKHsKICAgICAgICBrZXk6IGhlYWRlci5rZXksCiAgICAgICAgbWFuaWZlc3QsCiAgICAgICAga2V5UGFpciwKICAgICAgICBmcm96ZW46IGZhbHNlLAogICAgICAgIGRpc2NvdmVyeUtleSwKICAgICAgICB1c2VyRGF0YTogb3B0cy51c2VyRGF0YSB8fCBbXSwKICAgICAgICBhbGlhczogb3B0cy5hbGlhcyB8fCBudWxsCiAgICAgIH0pCiAgICB9CgogICAgLy8gdW5zbGFiIHRoZSBsb25nIGxpdmVkIGJ1ZmZlcnMgdG8gYXZvaWQga2VlcGluZyB0aGUgc2xhYiBhbGl2ZQogICAgaGVhZGVyLmtleSA9IHVuc2xhYihoZWFkZXIua2V5KQoKICAgIGlmIChoZWFkZXIudHJlZSkgewogICAgICBoZWFkZXIudHJlZS5yb290SGFzaCA9IHVuc2xhYihoZWFkZXIudHJlZS5yb290SGFzaCkKICAgICAgaGVhZGVyLnRyZWUuc2lnbmF0dXJlID0gdW5zbGFiKGhlYWRlci50cmVlLnNpZ25hdHVyZSkKICAgIH0KCiAgICBpZiAoaGVhZGVyLmtleVBhaXIpIHsKICAgICAgaGVhZGVyLmtleVBhaXIucHVibGljS2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnB1YmxpY0tleSkKICAgICAgaGVhZGVyLmtleVBhaXIuc2VjcmV0S2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnNlY3JldEtleSkKICAgIH0KCiAgICBpZiAoaGVhZGVyLmtleVBhaXIpIHsKICAgICAgaGVhZGVyLmtleVBhaXIucHVibGljS2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnB1YmxpY0tleSkKICAgICAgaGVhZGVyLmtleVBhaXIuc2VjcmV0S2V5ID0gdW5zbGFiKGhlYWRlci5rZXlQYWlyLnNlY3JldEtleSkKICAgIH0KCiAgICBpZiAob3B0cy5tYW5pZmVzdCkgewogICAgICAvLyBpZiB3ZSBwcm92aWRlIGEgbWFuaWZlc3QgYW5kIG5vIGtleSwgdmVyaWZ5IHRoYXQgdGhlIHN0b3JlZCBrZXkgaXMgdGhlIHNhbWUKICAgICAgaWYgKAogICAgICAgICFvcHRzLmtleSAmJgogICAgICAgICFWZXJpZmllci5pc1ZhbGlkTWFuaWZlc3QoaGVhZGVyLmtleSwgVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3Qob3B0cy5tYW5pZmVzdCkpCiAgICAgICkgewogICAgICAgIHRocm93IFNUT1JBR0VfQ09ORkxJQ1QoJ01hbmlmZXN0IGRvZXMgbm90IGhhc2ggdG8gcHJvdmlkZWQga2V5JywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIGlmICghaGVhZGVyLm1hbmlmZXN0KSBoZWFkZXIubWFuaWZlc3QgPSBvcHRzLm1hbmlmZXN0CiAgICB9CgogICAgaWYgKG9wdHMua2V5ICYmICFiNGEuZXF1YWxzKGhlYWRlci5rZXksIG9wdHMua2V5KSkgewogICAgICB0aHJvdyBTVE9SQUdFX0NPTkZMSUNUKCdBbm90aGVyIEh5cGVyY29yZSBpcyBzdG9yZWQgaGVyZScsIHRoaXMuZGlzY292ZXJ5S2V5KQogICAgfQoKICAgIC8vIGlmIHdlIHNpZ25hbGxlZCBjb21wYXQsIGJ1dCBhbHJlYWR5IG5vdyB0aGlzIGNvcmUgaXNuJ3QgZGlzYWJsZSBpdAogICAgaWYgKGNvbXBhdCAmJiBoZWFkZXIubWFuaWZlc3QgJiYgIVZlcmlmaWVyLmlzQ29tcGF0KGhlYWRlci5rZXksIGhlYWRlci5tYW5pZmVzdCkpIHsKICAgICAgY29tcGF0ID0gZmFsc2UKICAgIH0gZWxzZSBpZiAoIWNvbXBhdCAmJiBoZWFkZXIubWFuaWZlc3QgJiYgVmVyaWZpZXIuaXNDb21wYXQoaGVhZGVyLmtleSwgaGVhZGVyLm1hbmlmZXN0KSkgewogICAgICBjb21wYXQgPSB0cnVlCiAgICB9CgogICAgY29uc3QgcHJvbG9ndWUgPSBoZWFkZXIubWFuaWZlc3QgPyBoZWFkZXIubWFuaWZlc3QucHJvbG9ndWUgOiBudWxsCgogICAgY29uc3QgYml0ZmllbGQgPSBhd2FpdCBCaXRmaWVsZC5vcGVuKHN0b3JhZ2UsIGhlYWRlci50cmVlLmxlbmd0aCkKCiAgICBjb25zdCB0cmVlSW5mbyA9IHsKICAgICAgZm9yazogaGVhZGVyLnRyZWUuZm9yaywKICAgICAgbGVuZ3RoOiBoZWFkZXIudHJlZS5sZW5ndGgsCiAgICAgIHNpZ25hdHVyZTogaGVhZGVyLnRyZWUuc2lnbmF0dXJlLAogICAgICByb290czogaGVhZGVyLnRyZWUubGVuZ3RoCiAgICAgICAgPyBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgaGVhZGVyLnRyZWUubGVuZ3RoKQogICAgICAgIDogW10sCiAgICAgIHByb2xvZ3VlCiAgICB9CgogICAgaWYgKG92ZXJ3cml0ZSkgewogICAgICBjb25zdCB0eCA9IHN0b3JhZ2Uud3JpdGUoKQogICAgICB0eC5kZWxldGVUcmVlTm9kZVJhbmdlKDAsIC0xKQogICAgICB0eC5kZWxldGVCbG9ja1JhbmdlKDAsIC0xKQogICAgICBiaXRmaWVsZC5jbGVhcih0eCkKICAgICAgYXdhaXQgdHguZmx1c2goKQogICAgfQoKICAgIGNvbnN0IGxlbiA9IGJpdGZpZWxkLmZpbmRGaXJzdChmYWxzZSwgaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpCiAgICBpZiAoaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGggIT09IGxlbiAmJiAhc3RvcmFnZS5yZWFkT25seSkgewogICAgICBoZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCA9IGxlbgogICAgICBjb25zdCB0eCA9IHN0b3JhZ2Uud3JpdGUoKQogICAgICB0eC5zZXRIaW50cyhoZWFkZXIuaGludHMpCiAgICAgIGF3YWl0IHR4LmZsdXNoKCkKICAgIH0KCiAgICAvLyB0byB1bnNsYWIKICAgIGlmIChoZWFkZXIubWFuaWZlc3QpIHsKICAgICAgaGVhZGVyLm1hbmlmZXN0ID0gVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3QoaGVhZGVyLm1hbmlmZXN0KQogICAgICBpZiAoIWhhZE1hbmlmZXN0IHx8IChoZWFkZXIua2V5UGFpciAmJiAhaGFkS2V5UGFpcikpIHsKICAgICAgICBjb25zdCB0eCA9IHN0b3JhZ2Uud3JpdGUoKQogICAgICAgIHR4LnNldEF1dGgoewogICAgICAgICAga2V5OiBoZWFkZXIua2V5LAogICAgICAgICAgZGlzY292ZXJ5S2V5OiBjcnlwdG8uZGlzY292ZXJ5S2V5KGhlYWRlci5rZXkpLAogICAgICAgICAgbWFuaWZlc3Q6IGhlYWRlci5tYW5pZmVzdCwKICAgICAgICAgIGtleVBhaXI6IGhlYWRlci5rZXlQYWlyCiAgICAgICAgfSkKICAgICAgICBhd2FpdCB0eC5mbHVzaCgpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCB2ZXJpZmllciA9IGhlYWRlci5tYW5pZmVzdAogICAgICA/IG5ldyBWZXJpZmllcihoZWFkZXIua2V5LCBoZWFkZXIubWFuaWZlc3QsIHsgY3J5cHRvLCBsZWdhY3kgfSkKICAgICAgOiBudWxsCgogICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZQogICAgdGhpcy5oZWFkZXIgPSBoZWFkZXIKICAgIHRoaXMuY29tcGF0ID0gY29tcGF0CiAgICB0aGlzLmJpdGZpZWxkID0gYml0ZmllbGQKICAgIHRoaXMudmVyaWZpZXIgPSB2ZXJpZmllcgogICAgdGhpcy5zdGF0ZSA9IG5ldyBTZXNzaW9uU3RhdGUodGhpcywgbnVsbCwgc3RvcmFnZSwgdHJlZUluZm8sIG51bGwpCgogICAgaWYgKHRoaXMua2V5ID09PSBudWxsKSB0aGlzLmtleSA9IHRoaXMuaGVhZGVyLmtleQogICAgaWYgKHRoaXMuZGlzY292ZXJ5S2V5ID09PSBudWxsKSB0aGlzLmRpc2NvdmVyeUtleSA9IGNyeXB0by5kaXNjb3ZlcnlLZXkodGhpcy5rZXkpCiAgICBpZiAodGhpcy5pZCA9PT0gbnVsbCkgdGhpcy5pZCA9IHozMi5lbmNvZGUodGhpcy5rZXkpCiAgICBpZiAodGhpcy5tYW5pZmVzdCA9PT0gbnVsbCkgdGhpcy5tYW5pZmVzdCA9IHRoaXMuaGVhZGVyLm1hbmlmZXN0CiAgfQoKICBhc3luYyBhdWRpdChvcHRzKSB7CiAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBhdWRpdCh0aGlzLCBvcHRzKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5zdGF0ZS5fdW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIHNldE1hbmlmZXN0KG1hbmlmZXN0KSB7CiAgICBhd2FpdCB0aGlzLnN0YXRlLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGlmIChtYW5pZmVzdCAmJiB0aGlzLmhlYWRlci5tYW5pZmVzdCA9PT0gbnVsbCkgewogICAgICAgIGlmICghVmVyaWZpZXIuaXNWYWxpZE1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QpKSB7CiAgICAgICAgICB0aHJvdyBJTlZBTElEX0NIRUNLU1VNKCdNYW5pZmVzdCBoYXNoIGRvZXMgbm90IG1hdGNoJywgdGhpcy5kaXNjb3ZlcnlLZXkpCiAgICAgICAgfQoKICAgICAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCiAgICAgICAgdGhpcy5fc2V0TWFuaWZlc3QodHgsIFZlcmlmaWVyLmNyZWF0ZU1hbmlmZXN0KG1hbmlmZXN0KSwgbnVsbCkKICAgICAgICBhd2FpdCB0aGlzLnN0YXRlLmZsdXNoKCkKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5zdGF0ZS5fdW5sb2NrKCkKICAgIH0KICB9CgogIF9zZXRNYW5pZmVzdCh0eCwgbWFuaWZlc3QsIGtleVBhaXIpIHsKICAgIGlmICghbWFuaWZlc3QgJiYgYjRhLmVxdWFscyhrZXlQYWlyLnB1YmxpY0tleSwgdGhpcy5oZWFkZXIua2V5KSkgewogICAgICBtYW5pZmVzdCA9IFZlcmlmaWVyLmRlZmF1bHRTaWduZXJNYW5pZmVzdCh0aGlzLmhlYWRlci5rZXkpCiAgICB9CiAgICBpZiAoIW1hbmlmZXN0KSByZXR1cm4KCiAgICBjb25zdCB2ZXJpZmllciA9IG5ldyBWZXJpZmllcih0aGlzLmhlYWRlci5rZXksIG1hbmlmZXN0LCB7IGxlZ2FjeTogdGhpcy5fbGVnYWN5IH0pCgogICAgaWYgKHZlcmlmaWVyLnByb2xvZ3VlKSB0aGlzLnN0YXRlLnByb2xvZ3VlID0gT2JqZWN0LmFzc2lnbih7fSwgdmVyaWZpZXIucHJvbG9ndWUpCgogICAgdGhpcy5tYW5pZmVzdCA9IHRoaXMuaGVhZGVyLm1hbmlmZXN0ID0gbWFuaWZlc3QKCiAgICB0eC5zZXRBdXRoKHsKICAgICAga2V5OiB0aGlzLmhlYWRlci5rZXksCiAgICAgIGRpc2NvdmVyeUtleTogdGhpcy5kaXNjb3ZlcnlLZXksCiAgICAgIG1hbmlmZXN0LAogICAgICBrZXlQYWlyOiB0aGlzLmhlYWRlci5rZXlQYWlyCiAgICAgIC8vIFRPRE86IGVuY3J5cHRpb25LZXk/CiAgICB9KQoKICAgIHRoaXMuY29tcGF0ID0gdmVyaWZpZXIuY29tcGF0CiAgICB0aGlzLnZlcmlmaWVyID0gdmVyaWZpZXIKCiAgICB0aGlzLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIHRoaXMuZW1pdE1hbmlmZXN0KCkKICB9CgogIGFzeW5jIGNvcHlQcm9sb2d1ZShzcmMpIHsKICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgc3JjLm11dGV4LmxvY2soKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuc3RhdGUubXV0ZXgudW5sb2NrKCkKICAgICAgdGhyb3cgZXJyCiAgICB9CgogICAgdHJ5IHsKICAgICAgYXdhaXQgY29weVByb2xvZ3VlKHNyYywgdGhpcykKICAgIH0gZmluYWxseSB7CiAgICAgIHNyYy5tdXRleC51bmxvY2soKQogICAgICB0aGlzLnN0YXRlLm11dGV4LnVubG9jaygpCiAgICAgIHRoaXMuY2hlY2tJZklkbGUoKQogICAgfQogIH0KCiAgZmx1c2hlZCgpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlLmZsdXNoZWQoKQogIH0KCiAgYXN5bmMgX3ZhbGlkYXRlQ29tbWl0KHN0YXRlLCB0cmVlTGVuZ3RoKSB7CiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPiBzdGF0ZS5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlIC8vIFRPRE86IHBhcnRpYWwgY29tbWl0IGFuZCB0cnVuY2F0aW9uIHBvc3NpYmxlIGluIHRoZSBmdXR1cmUKICAgIH0KCiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPiB0cmVlTGVuZ3RoKSB7CiAgICAgIGZvciAoY29uc3Qgcm9vdCBvZiB0aGlzLnN0YXRlLnJvb3RzKSB7CiAgICAgICAgY29uc3QgYmF0Y2hSb290ID0gYXdhaXQgTWVya2xlVHJlZS5nZXQoc3RhdGUsIHJvb3QuaW5kZXgpCiAgICAgICAgaWYgKGJhdGNoUm9vdC5zaXplICE9PSByb290LnNpemUgfHwgIWI0YS5lcXVhbHMoYmF0Y2hSb290Lmhhc2gsIHJvb3QuaGFzaCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLnZlcmlmaWVyID09PSBudWxsKSB7CiAgICAgIHJldHVybiBmYWxzZSAvLyBlYXNpZXIgdG8gYXNzZXJ0IHRoYW4gdXBzZXJ0CiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIF92ZXJpZnlCYXRjaFVwZ3JhZGUoYmF0Y2gsIG1hbmlmZXN0KSB7CiAgICBpZiAoIXRoaXMuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIC8vIGNvbXBhdCwgZHJvcCBhdCBzb21lIHBvaW50CiAgICAgIGlmICghbWFuaWZlc3QpIG1hbmlmZXN0ID0gVmVyaWZpZXIuZGVmYXVsdFNpZ25lck1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSkKCiAgICAgIGlmICgKICAgICAgICAhbWFuaWZlc3QgfHwKICAgICAgICAhKAogICAgICAgICAgVmVyaWZpZXIuaXNWYWxpZE1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QpIHx8CiAgICAgICAgICBWZXJpZmllci5pc0NvbXBhdCh0aGlzLmhlYWRlci5rZXksIG1hbmlmZXN0KQogICAgICAgICkKICAgICAgKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9TSUdOQVRVUkUoJ1Byb29mIGNvbnRhaW5zIGFuIGludmFsaWQgbWFuaWZlc3QnLCB0aGlzLmRpc2NvdmVyeUtleSkgLy8gVE9ETzogcHJvcGVyIGVycm9yIHR5cGUKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHZlcmlmaWVyID0KICAgICAgdGhpcy52ZXJpZmllciB8fAogICAgICBuZXcgVmVyaWZpZXIodGhpcy5oZWFkZXIua2V5LCBWZXJpZmllci5jcmVhdGVNYW5pZmVzdChtYW5pZmVzdCksIHsgbGVnYWN5OiB0aGlzLl9sZWdhY3kgfSkKCiAgICBpZiAoIXZlcmlmaWVyLnZlcmlmeShiYXRjaCwgYmF0Y2guc2lnbmF0dXJlKSkgewogICAgICB0aHJvdyBJTlZBTElEX1NJR05BVFVSRSgnUHJvb2YgY29udGFpbnMgYW4gaW52YWxpZCBzaWduYXR1cmUnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgIH0KCiAgICByZXR1cm4gbWFuaWZlc3QKICB9CgogIGFzeW5jIF92ZXJpZnlFeGNsdXNpdmUoeyBiYXRjaCwgYml0ZmllbGQsIHZhbHVlLCBtYW5pZmVzdCB9KSB7CiAgICBtYW5pZmVzdCA9IHRoaXMuX3ZlcmlmeUJhdGNoVXBncmFkZShiYXRjaCwgbWFuaWZlc3QpCgogICAgaWYgKAogICAgICAhKGF3YWl0IHRoaXMuc3RhdGUuX3ZlcmlmeUJsb2NrKAogICAgICAgIGJhdGNoLAogICAgICAgIGJpdGZpZWxkLAogICAgICAgIHZhbHVlLAogICAgICAgIHRoaXMuaGVhZGVyLm1hbmlmZXN0ID8gbnVsbCA6IG1hbmlmZXN0CiAgICAgICkpCiAgICApIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKCFiYXRjaC51cGdyYWRlZCAmJiBiaXRmaWVsZCkgewogICAgICB0aGlzLnJlcGxpY2F0b3Iub25oYXZlKGJpdGZpZWxkLnN0YXJ0LCBiaXRmaWVsZC5sZW5ndGgsIGJpdGZpZWxkLmRyb3ApCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF92ZXJpZnlTaGFyZWQoKSB7CiAgICBpZiAoIXRoaXMuX3ZlcmlmaWVzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKCiAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgY29uc3QgdmVyaWZpZXMgPSB0aGlzLl92ZXJpZmllcwogICAgdGhpcy5fdmVyaWZpZXMgPSBudWxsCiAgICB0aGlzLl92ZXJpZmllZCA9IG51bGwKCiAgICB0cnkgewogICAgICBmb3IgKGNvbnN0IHsgYmF0Y2gsIGJpdGZpZWxkLCB2YWx1ZSB9IG9mIHZlcmlmaWVzKSB7CiAgICAgICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIGNvbnRpbnVlCgogICAgICAgIGlmIChiaXRmaWVsZCkgewogICAgICAgICAgdHgucHV0QmxvY2soYml0ZmllbGQuc3RhcnQsIHZhbHVlKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgYml0cyA9IG5ldyBCaXRJbnRlcmx1ZGUoKQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJpZmllcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHsgYmF0Y2gsIGJpdGZpZWxkLCBtYW5pZmVzdCB9ID0gdmVyaWZpZXNbaV0KCiAgICAgICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHsKICAgICAgICAgIHZlcmlmaWVzW2ldID0gbnVsbCAvLyBzaWduYWwgdGhhdCB3ZSBjYW5ub3QgY29tbWl0IHRoaXMgb25lCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKGJpdGZpZWxkKSB7CiAgICAgICAgICBiaXRzLnNldFJhbmdlKGJpdGZpZWxkLnN0YXJ0LCBiaXRmaWVsZC5zdGFydCArIDEsIHRydWUpCiAgICAgICAgfQoKICAgICAgICAvLyBpZiB3ZSBnb3QgYSBtYW5pZmVzdCBBTkQgaXRzIHN0cmljdGx5IGEgbm9uIGNvbXBhdCBvbmUsIGxldHMgc3RvcmUgaXQKICAgICAgICBpZiAobWFuaWZlc3QgJiYgdGhpcy5oZWFkZXIubWFuaWZlc3QgPT09IG51bGwpIHsKICAgICAgICAgIGlmICghVmVyaWZpZXIuaXNWYWxpZE1hbmlmZXN0KHRoaXMuaGVhZGVyLmtleSwgbWFuaWZlc3QpKSB7CiAgICAgICAgICAgIHRocm93IElOVkFMSURfQ0hFQ0tTVU0oJ01hbmlmZXN0IGhhc2ggZG9lcyBub3QgbWF0Y2gnLCB0aGlzLmRpc2NvdmVyeUtleSkKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3NldE1hbmlmZXN0KHR4LCBtYW5pZmVzdCwgbnVsbCkKICAgICAgICB9CgogICAgICAgIGlmIChiYXRjaC5jb21taXRhYmxlKCkpIGJhdGNoLmNvbW1pdCh0eCkKICAgICAgfQoKICAgICAgY29uc3QgcmFuZ2VzID0gYml0cy5mbHVzaCh0eCwgdGhpcy5iaXRmaWVsZCkKCiAgICAgIGF3YWl0IHRoaXMuc3RhdGUuZmx1c2goKQoKICAgICAgZm9yIChjb25zdCB7IHN0YXJ0LCBlbmQsIHZhbHVlIH0gb2YgcmFuZ2VzKSB7CiAgICAgICAgdGhpcy5fc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIGVuZCwgdmFsdWUpCiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVyaWZpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBiaXRmaWVsZCA9IHZlcmlmaWVzW2ldICYmIHZlcmlmaWVzW2ldLmJpdGZpZWxkCiAgICAgICAgaWYgKGJpdGZpZWxkKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZUNvbnRpZ3VvdXNMZW5ndGgoYml0ZmllbGQpCiAgICAgICAgICB0aGlzLnJlcGxpY2F0b3Iub25oYXZlKGJpdGZpZWxkLnN0YXJ0LCBiaXRmaWVsZC5sZW5ndGgsIGJpdGZpZWxkLmRyb3ApCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5oaW50c0NoYW5nZWQpIGF3YWl0IHRoaXMuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnN0YXRlLl9jbGVhckFjdGl2ZUJhdGNoKCkKICAgICAgdGhpcy5zdGF0ZS5tdXRleC51bmxvY2soKQogICAgfQoKICAgIHJldHVybiB2ZXJpZmllc1swXSAhPT0gbnVsbAogIH0KCiAgYXN5bmMgZmx1c2hIaW50cygpIHsKICAgIGlmICghdGhpcy5oaW50c0NoYW5nZWQpIHJldHVybgogICAgdGhpcy5oaW50c0NoYW5nZWQgPSBmYWxzZSAvLyB3ZSB1bnNldCB0aGlzIGltbWVkaWF0ZWx5IGFzIGEgImRlYm91bmNlIgoKICAgIGNvbnN0IHR4ID0gdGhpcy5zdGF0ZS5zdG9yYWdlLndyaXRlKCkKCiAgICB0eC5zZXRIaW50cyh7CiAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgsCiAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgIH0pCgogICAgYXdhaXQgdHguZmx1c2goKQogIH0KCiAgYXN5bmMgY2hlY2tDb25mbGljdChwcm9vZiwgZnJvbSkgewogICAgaWYgKHRoaXMuc3RhdGUubGVuZ3RoIDwgcHJvb2YudXBncmFkZS5sZW5ndGggfHwgcHJvb2YuZm9yayAhPT0gdGhpcy5zdGF0ZS5mb3JrKSB7CiAgICAgIC8vIG91dCBvZiBkYXRlIHRoaXMgcHJvb2YgLSBpZ25vcmUgZm9yIG5vdwogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICAvLyBzYW5pdHkgY2hlY2sgLT4gbm8gbWFuaWZlc3QsIG5vIHdheSB0byB2ZXJpZnkKICAgIGlmICghdGhpcy5oZWFkZXIubWFuaWZlc3QpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgYmF0Y2ggPSBNZXJrbGVUcmVlLnZlcmlmeUZ1bGx5UmVtb3RlKHRoaXMuc3RhdGUsIHByb29mKQoKICAgIHRyeSB7CiAgICAgIHRoaXMuX3ZlcmlmeUJhdGNoVXBncmFkZShiYXRjaCwgcHJvb2YubWFuaWZlc3QpCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZSh0aGlzLnN0b3JhZ2UsIHByb29mLnVwZ3JhZGUubGVuZ3RoKQogICAgY29uc3QgcmVtb3RlVHJlZUhhc2ggPSBjcnlwdG8udHJlZShwcm9vZi51cGdyYWRlLm5vZGVzKQogICAgY29uc3QgbG9jYWxUcmVlSGFzaCA9IGNyeXB0by50cmVlKHJvb3RzKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJ4ID0gdGhpcy5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCB0cmVlUHJvb2ZQcm9taXNlID0gTWVya2xlVHJlZS5wcm9vZih0aGlzLnN0YXRlLCByeCwgewogICAgICAgIGJsb2NrOiBudWxsLAogICAgICAgIGhhc2g6IG51bGwsCiAgICAgICAgc2VlazogbnVsbCwKICAgICAgICB1cGdyYWRlOiB7CiAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgIGxlbmd0aDogcHJvb2YudXBncmFkZS5sZW5ndGgKICAgICAgICB9CiAgICAgIH0pCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCB0cmVlUHJvb2YgPSBhd2FpdCB0cmVlUHJvb2ZQcm9taXNlCgogICAgICBjb25zdCB2ZXJpZnlCYXRjaCA9IE1lcmtsZVRyZWUudmVyaWZ5RnVsbHlSZW1vdGUodGhpcy5zdGF0ZSwgYXdhaXQgdHJlZVByb29mLnNldHRsZSgpKQogICAgICB0aGlzLl92ZXJpZnlCYXRjaFVwZ3JhZGUodmVyaWZ5QmF0Y2gsIHRoaXMuaGVhZGVyLm1hbmlmZXN0KQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgLy8gYm90aCBwcm9vZnMgYXJlIHZhbGlkLCBub3cgY2hlY2sgaWYgdGhleSBmb3JrZWQKICAgIGlmIChiNGEuZXF1YWxzKGxvY2FsVHJlZUhhc2gsIHJlbW90ZVRyZWVIYXNoKSkgcmV0dXJuIGZhbHNlCgogICAgYXdhaXQgdGhpcy5zdGF0ZS5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgICB0aGlzLmhlYWRlci5mcm96ZW4gPSB0cnVlCgogICAgICB0eC5zZXRBdXRoKHsKICAgICAgICBrZXk6IHRoaXMuaGVhZGVyLmtleSwKICAgICAgICBkaXNjb3ZlcnlLZXk6IHRoaXMuZGlzY292ZXJ5S2V5LAogICAgICAgIG1hbmlmZXN0OiB0aGlzLmhlYWRlci5tYW5pZmVzdCwKICAgICAgICBrZXlQYWlyOiB0aGlzLmhlYWRlci5rZXlQYWlyLAogICAgICAgIGZyb3plbjogdHJ1ZQogICAgICB9KQoKICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5mbHVzaCgpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnN0YXRlLm11dGV4LnVubG9jaygpCiAgICB9CgogICAgLy8gdG1wIGxvZyBzbyB3ZSBjYW4gc2VlIHRoZXNlCiAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyh0aGlzLmRpc2NvdmVyeUtleSwgJ2hleCcpCiAgICBjb25zb2xlLmxvZygKICAgICAgJ1toeXBlcmNvcmVdIGNvbmZsaWN0IGRldGVjdGVkIGluICcgKwogICAgICAgIGlkICsKICAgICAgICAnICh3cml0YWJsZT0nICsKICAgICAgICAhIXRoaXMuaGVhZGVyLmtleVBhaXIgKwogICAgICAgICcscXVvcnVtPScgKwogICAgICAgIHRoaXMuaGVhZGVyLm1hbmlmZXN0LnF1b3J1bSArCiAgICAgICAgJyknCiAgICApCiAgICBhd2FpdCB0aGlzLl9vbmNvbmZsaWN0KHByb29mKQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHZlcmlmeVJlb3JnKHByb29mKSB7CiAgICBjb25zdCBiYXRjaCA9IG5ldyBSZW9yZ0JhdGNoKHRoaXMuc3RhdGUpCiAgICBhd2FpdCBNZXJrbGVUcmVlLnJlb3JnKHRoaXMuc3RhdGUsIHByb29mLCBiYXRjaCkKICAgIGNvbnN0IG1hbmlmZXN0ID0gdGhpcy5fdmVyaWZ5QmF0Y2hVcGdyYWRlKGJhdGNoLCBwcm9vZi5tYW5pZmVzdCkKCiAgICBpZiAobWFuaWZlc3QgJiYgIXRoaXMuaGVhZGVyLm1hbmlmZXN0KSB7CiAgICAgIGF3YWl0IHRoaXMuc3RhdGUubXV0ZXgubG9jaygpCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKG1hbmlmZXN0ICYmIHRoaXMuaGVhZGVyLm1hbmlmZXN0ID09PSBudWxsKSB7CiAgICAgICAgICBjb25zdCB0eCA9IHRoaXMuc3RhdGUuY3JlYXRlV3JpdGVCYXRjaCgpCiAgICAgICAgICB0aGlzLl9zZXRNYW5pZmVzdCh0eCwgVmVyaWZpZXIuY3JlYXRlTWFuaWZlc3QobWFuaWZlc3QpLCBudWxsKQogICAgICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5mbHVzaCgpCiAgICAgICAgfQogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuc3RhdGUuX3VubG9jaygpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIGFzeW5jIHZlcmlmeShwcm9vZiwgZnJvbSkgewogICAgLy8gV2UgY2Fubm90IGFwcGx5ICJvdGhlciBmb3JrcyIgYXRtLgogICAgLy8gV2Ugc2hvdWxkIHByb2JhYmx5IHN0aWxsIHRyeSBhbmQgdGhleSBhcmUgbGlrZWx5IHN1cGVyIHNpbWlsYXIgZm9yIG5vbiB1cGdyYWRlcwogICAgLy8gYnV0IHRoaXMgaXMgZWFzeSBhdG0gKGFuZCB0aGUgYWJvdmUgbGF5ZXIgd2lsbCBqdXN0IHJldHJ5KQogICAgaWYgKHByb29mLmZvcmsgIT09IHRoaXMuc3RhdGUuZm9yaykgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgYmF0Y2ggPSBhd2FpdCBNZXJrbGVUcmVlLnZlcmlmeSh0aGlzLnN0YXRlLCBwcm9vZikKCiAgICBpZiAoYmF0Y2gudXBncmFkZWQgJiYgYmF0Y2gubGVuZ3RoIDw9IHRoaXMuc3RhdGUubGVuZ3RoKSB7CiAgICAgIGF3YWl0IGJhdGNoLmRvd25ncmFkZSgpCiAgICB9CgogICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgdmFsdWUgPSAocHJvb2YuYmxvY2sgJiYgcHJvb2YuYmxvY2sudmFsdWUpIHx8IG51bGwKICAgIGNvbnN0IG9wID0gewogICAgICBiYXRjaCwKICAgICAgYml0ZmllbGQ6IHZhbHVlICYmIHsgZHJvcDogZmFsc2UsIHN0YXJ0OiBwcm9vZi5ibG9jay5pbmRleCwgbGVuZ3RoOiAxIH0sCiAgICAgIHZhbHVlLAogICAgICBtYW5pZmVzdDogcHJvb2YubWFuaWZlc3QsCiAgICAgIGZyb20KICAgIH0KCiAgICBpZiAoYmF0Y2gudXBncmFkZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcmlmeUV4Y2x1c2l2ZShvcCkKICAgIH0KCiAgICBpZiAodGhpcy5fdmVyaWZpZXMgIT09IG51bGwpIHsKICAgICAgY29uc3QgdmVyaWZpZXMgPSB0aGlzLl92ZXJpZmllcwogICAgICBjb25zdCBpID0gdmVyaWZpZXMucHVzaChvcCkKICAgICAgYXdhaXQgdGhpcy5fdmVyaWZpZWQKICAgICAgcmV0dXJuIHZlcmlmaWVzW2ldICE9PSBudWxsCiAgICB9CgogICAgdGhpcy5fdmVyaWZpZXMgPSBbb3BdCiAgICB0aGlzLl92ZXJpZmllZCA9IHRoaXMuX3ZlcmlmeVNoYXJlZCgpCgogICAgcmV0dXJuIHRoaXMuX3ZlcmlmaWVkCiAgfQoKICBhc3luYyByZW9yZyhiYXRjaCkgewogICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHJldHVybiBmYWxzZQoKICAgIHRoaXMudHJ1bmNhdGluZysrCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5zdGF0ZS5yZW9yZyhiYXRjaCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMudHJ1bmNhdGluZy0tCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIG9wZW5Ta2lwQml0ZmllbGQoKSB7CiAgICBpZiAodGhpcy5za2lwQml0ZmllbGQgIT09IG51bGwpIHJldHVybiB0aGlzLnNraXBCaXRmaWVsZAogICAgdGhpcy5za2lwQml0ZmllbGQgPSBuZXcgUmVtb3RlQml0ZmllbGQoKQogICAgY29uc3QgYnVmID0gdGhpcy5iaXRmaWVsZC50b0J1ZmZlcih0aGlzLnN0YXRlLmxlbmd0aCkKICAgIGNvbnN0IGJpdGZpZWxkID0gbmV3IFVpbnQzMkFycmF5KGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCAvIDQpCiAgICB0aGlzLnNraXBCaXRmaWVsZC5pbnNlcnQoMCwgYml0ZmllbGQpCiAgICByZXR1cm4gdGhpcy5za2lwQml0ZmllbGQKICB9CgogIF9zZXRCaXRmaWVsZFJhbmdlcyhzdGFydCwgZW5kLCB2YWx1ZSkgewogICAgdGhpcy5iaXRmaWVsZC5zZXRSYW5nZShzdGFydCwgZW5kLCB2YWx1ZSkKICAgIGlmICh0aGlzLnNraXBCaXRmaWVsZCAhPT0gbnVsbCkgdGhpcy5za2lwQml0ZmllbGQuc2V0UmFuZ2Uoc3RhcnQsIGVuZCwgdmFsdWUpCiAgfQoKICBjbG9zZSgpIHsKICAgIGlmICghdGhpcy5jbG9zaW5nKSB0aGlzLmNsb3NpbmcgPSB0aGlzLl9jbG9zZSgpCiAgICByZXR1cm4gdGhpcy5jbG9zaW5nCiAgfQoKICB1cGRhdGVDb250aWd1b3VzTGVuZ3RoKGJpdGZpZWxkKSB7CiAgICBjb25zdCBjb250aWcgPSB1cGRhdGVDb250aWdCYXRjaCh0aGlzLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoLCBiaXRmaWVsZCwgdGhpcy5iaXRmaWVsZCkKCiAgICBpZiAoY29udGlnLmxlbmd0aCAhPT0gLTEgJiYgY29udGlnLmxlbmd0aCAhPT0gdGhpcy5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCkgewogICAgICB0aGlzLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoID0gY29udGlnLmxlbmd0aAogICAgICB0aGlzLmhpbnRzQ2hhbmdlZCA9IHRydWUKICAgIH0KICB9CgogIHVwZGF0ZVJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgobGVuZ3RoKSB7CiAgICB0aGlzLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmhpbnRzQ2hhbmdlZCA9IHRydWUKCiAgICBmb3IgKGxldCBpID0gdGhpcy5tb25pdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLm1vbml0b3JzW2ldLmVtaXQoJ3JlbW90ZS1jb250aWd1b3VzLWxlbmd0aCcsIGxlbmd0aCkKICAgIH0KICB9CgogIG9uYXBwZW5kKHRyZWUsIGJpdGZpZWxkKSB7CiAgICB0aGlzLmhlYWRlci50cmVlID0gdHJlZQoKICAgIGlmICghYml0ZmllbGQpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLm9udXBncmFkZSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMucmVwbGljYXRvci5jb3JrKCkKCiAgICBjb25zdCB7IHN0YXJ0LCBsZW5ndGgsIGRyb3AgfSA9IGJpdGZpZWxkCgogICAgdGhpcy5fc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIHN0YXJ0ICsgbGVuZ3RoLCB0cnVlKQogICAgdGhpcy51cGRhdGVDb250aWd1b3VzTGVuZ3RoKHsgc3RhcnQsIGxlbmd0aCwgZHJvcDogZmFsc2UgfSkKCiAgICB0aGlzLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIHRoaXMucmVwbGljYXRvci5vbmhhdmUoc3RhcnQsIGxlbmd0aCwgZHJvcCkKICAgIHRoaXMucmVwbGljYXRvci51bmNvcmsoKQogIH0KCiAgb250cnVuY2F0ZSh0cmVlLCB7IHN0YXJ0LCBsZW5ndGggfSkgewogICAgaWYgKHRyZWUpIHRoaXMuaGVhZGVyLnRyZWUgPSB0cmVlCgogICAgdGhpcy5yZXBsaWNhdG9yLmNvcmsoKQoKICAgIHRoaXMucmVwbGljYXRvci5vbnRydW5jYXRlKHN0YXJ0LCBsZW5ndGgpCiAgICB0aGlzLnJlcGxpY2F0b3Iub25oYXZlKHN0YXJ0LCBsZW5ndGgsIHRydWUpCiAgICB0aGlzLnJlcGxpY2F0b3Iub251cGdyYWRlKCkKICAgIHRoaXMucmVwbGljYXRvci51bmNvcmsoKQoKICAgIGZvciAoY29uc3Qgc2Vzc2lvblN0YXRlIG9mIHRoaXMuc2Vzc2lvblN0YXRlcykgewogICAgICBpZiAoc3RhcnQgPCBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGgpIHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aCA9IHN0YXJ0CiAgICB9CgogICAgdGhpcy5fc2V0Qml0ZmllbGRSYW5nZXMoc3RhcnQsIHN0YXJ0ICsgbGVuZ3RoLCBmYWxzZSkKICAgIHRoaXMudXBkYXRlQ29udGlndW91c0xlbmd0aCh7IHN0YXJ0LCBsZW5ndGgsIGRyb3A6IHRydWUgfSkKICB9CgogIGFzeW5jIF9vbmNvbmZsaWN0KHByb29mKSB7CiAgICBhd2FpdCB0aGlzLnJlcGxpY2F0b3Iub25jb25mbGljdCgpCgogICAgZm9yIChsZXQgaSA9IHRoaXMubW9uaXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcyA9IHRoaXMubW9uaXRvcnNbaV0KICAgICAgcy5lbWl0KCdjb25mbGljdCcsIHByb29mLnVwZ3JhZGUubGVuZ3RoLCBwcm9vZi5mb3JrLCBwcm9vZikKICAgIH0KCiAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoJ1R3byBjb25mbGljdGluZyBzaWduYXR1cmVzIGV4aXN0IGZvciBsZW5ndGggJyArIHByb29mLnVwZ3JhZGUubGVuZ3RoKQogICAgYXdhaXQgdGhpcy5jbG9zZUFsbFNlc3Npb25zKGVycikKICB9CgogIGFzeW5jIGNsb3NlQWxsU2Vzc2lvbnMoZXJyKSB7CiAgICAvLyB0aGlzLnNlc3Npb25zIG1vZGlmaWVzIGl0c2VsZiB3aGVuIGEgc2Vzc2lvbiBjbG9zZXMKICAgIC8vIFRoaXMgd2F5IHdlIGVuc3VyZSB3ZSBpbmRlZWQgaXRlcmF0ZSBvdmVyIGFsbCBzZXNzaW9ucwogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmFsbFNlc3Npb25zKCkKCiAgICBjb25zdCBhbGwgPSBbXQogICAgZm9yIChjb25zdCBzIG9mIHNlc3Npb25zKSBhbGwucHVzaChzLmNsb3NlKHsgZXJyb3I6IGVyciwgZm9yY2U6IGZhbHNlIH0pKSAvLyBmb3JjZSBmYWxzZSBvciBlbHNlIGluZmluaXRlIHJlY3Vyc2lvbgogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKGFsbCkKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgPT09IHRydWUpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuaGFzU2Vzc2lvbigpID09PSB0cnVlKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBkZXN0cm95IHdoaWxlIHNlc3Npb25zIGFyZSBvcGVuJykKCiAgICBjb25zdCB3ZWFrU2Vzc2lvbnMgPSB0aGlzLmFsbFNlc3Npb25zKCkKCiAgICBpZiAodGhpcy5yZXBsaWNhdG9yKSB0aGlzLnJlcGxpY2F0b3IuZGVzdHJveSgpCiAgICBpZiAodGhpcy5zdGF0ZSkgYXdhaXQgdGhpcy5zdGF0ZS5jbG9zZSgpCgogICAgLy8gY2xvc2UgYWxsIHBlbmRpbmcgd2VhayBzZXNzaW9ucy4uLgogICAgZm9yIChjb25zdCBzIG9mIHdlYWtTZXNzaW9ucykgcy5jbG9zZSgpLmNhdGNoKG5vb3ApCiAgfQoKICBhc3luYyBfY2xvc2UoKSB7CiAgICBpZiAodGhpcy5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLm9wZW5pbmcKICAgIGlmICh0aGlzLmhhc1Nlc3Npb24oKSA9PT0gdHJ1ZSkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY2xvc2Ugd2hpbGUgc2Vzc2lvbnMgYXJlIG9wZW4nKQoKICAgIGlmICh0aGlzLnJlcGxpY2F0b3IpIGF3YWl0IHRoaXMucmVwbGljYXRvci5jbG9zZSgpCgogICAgYXdhaXQgdGhpcy5kZXN0cm95KCkKICAgIGlmICh0aGlzLmF1dG9DbG9zZSkgYXdhaXQgdGhpcy5zdG9yYWdlLnN0b3JlLmNsb3NlKCkKCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNvbnRpZ0JhdGNoKHN0YXJ0LCB1cGQsIGJpdGZpZWxkKSB7CiAgY29uc3QgZW5kID0gdXBkLnN0YXJ0ICsgdXBkLmxlbmd0aAoKICBsZXQgYyA9IHN0YXJ0CgogIGlmICh1cGQuZHJvcCkgewogICAgLy8gSWYgd2UgZHJvcHBlZCBhIGJsb2NrIGluIHRoZSBjdXJyZW50IGNvbnRpZyByYW5nZSwgImRvd25ncmFkZSIgaXQKICAgIGlmIChjID4gdXBkLnN0YXJ0KSB7CiAgICAgIGMgPSB1cGQuc3RhcnQKICAgIH0KICB9IGVsc2UgewogICAgaWYgKGMgPD0gZW5kICYmIGMgPj0gdXBkLnN0YXJ0KSB7CiAgICAgIGMgPSBlbmQKICAgICAgd2hpbGUgKGJpdGZpZWxkLmdldChjKSkgYysrCiAgICB9CiAgfQoKICBpZiAoYyA9PT0gc3RhcnQpIHsKICAgIHJldHVybiB7CiAgICAgIGxlbmd0aDogLTEKICAgIH0KICB9CgogIGlmIChjID4gc3RhcnQpIHsKICAgIHJldHVybiB7CiAgICAgIGxlbmd0aDogYwogICAgfQogIH0KCiAgcmV0dXJuIHsKICAgIGxlbmd0aDogYwogIH0KfQoKZnVuY3Rpb24gZ2V0RGVmYXVsdFRyZWUoKSB7CiAgcmV0dXJuIHsKICAgIGZvcms6IDAsCiAgICBsZW5ndGg6IDAsCiAgICByb290SGFzaDogbnVsbCwKICAgIHNpZ25hdHVyZTogbnVsbAogIH0KfQoKZnVuY3Rpb24gcGFyc2VIZWFkZXIoaW5mbykgewogIGlmICghaW5mbykgcmV0dXJuIG51bGwKCiAgcmV0dXJuIHsKICAgIGtleTogaW5mby5rZXksCiAgICBtYW5pZmVzdDogaW5mby5tYW5pZmVzdCwKICAgIGV4dGVybmFsOiBudWxsLAogICAga2V5UGFpcjogaW5mby5rZXlQYWlyLAogICAgdHJlZTogaW5mby5oZWFkIHx8IGdldERlZmF1bHRUcmVlKCksCiAgICBoaW50czogewogICAgICByZW9yZ3M6IFtdLAogICAgICBjb250aWd1b3VzTGVuZ3RoOiBpbmZvLmhpbnRzID8gaW5mby5oaW50cy5jb250aWd1b3VzTGVuZ3RoIDogMCwKICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogaW5mby5oaW50cyA/IGluZm8uaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aCA6IDAKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKYXN5bmMgZnVuY3Rpb24gZ2V0Q29yZUluZm8oc3RvcmFnZSkgewogIGNvbnN0IHIgPSBzdG9yYWdlLnJlYWQoKQoKICBjb25zdCBhdXRoID0gci5nZXRBdXRoKCkKICBjb25zdCBoZWFkID0gci5nZXRIZWFkKCkKICBjb25zdCBoaW50cyA9IHIuZ2V0SGludHMoKQoKICByLnRyeUZsdXNoKCkKCiAgY29uc3QgW2F1dGhJbmZvLCBoZWFkSW5mbywgaGludHNJbmZvXSA9IGF3YWl0IFByb21pc2UuYWxsKFthdXRoLCBoZWFkLCBoaW50c10pCiAgcmV0dXJuIHsKICAgIC4uLmF1dGhJbmZvLAogICAgaGVhZDogaGVhZEluZm8sCiAgICBoaW50czogaGludHNJbmZvCiAgfQp9CmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgREVGQVVMVF9FTkNSWVBUSU9OIH0gPSByZXF1aXJlKCcuL2NhcHMnKQoKY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19zdHJlYW1fTk9OQ0VCWVRFUykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRGVmYXVsdEVuY3J5cHRpb24gewogIHN0YXRpYyBQQURESU5HID0gOAoKICBjb25zdHJ1Y3RvcihlbmNyeXB0aW9uS2V5LCBoeXBlcmNvcmVLZXksIG9wdHMgPSB7fSkgewogICAgdGhpcy5rZXkgPSBlbmNyeXB0aW9uS2V5CiAgICB0aGlzLmNvbXBhdCA9IG9wdHMuY29tcGF0ID09PSB0cnVlCgogICAgY29uc3Qga2V5cyA9IERlZmF1bHRFbmNyeXB0aW9uLmRlcml2ZUtleXMoZW5jcnlwdGlvbktleSwgaHlwZXJjb3JlS2V5LCBvcHRzKQoKICAgIHRoaXMuYmxvY2tLZXkgPSBrZXlzLmJsb2NrCiAgICB0aGlzLmJsaW5kaW5nS2V5ID0ga2V5cy5ibGluZGluZwogIH0KCiAgc3RhdGljIGRlcml2ZUtleXMoZW5jcnlwdGlvbktleSwgaHlwZXJjb3JlS2V5LCB7IGJsb2NrID0gZmFsc2UsIGNvbXBhdCA9IGZhbHNlIH0gPSB7fSkgewogICAgY29uc3Qgc3ViS2V5cyA9IGI0YS5hbGxvYygyICogc29kaXVtLmNyeXB0b19zdHJlYW1fS0VZQllURVMpCgogICAgY29uc3QgYmxvY2tLZXkgPSBibG9jayA/IGVuY3J5cHRpb25LZXkgOiBzdWJLZXlzLnN1YmFycmF5KDAsIHNvZGl1bS5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKQogICAgY29uc3QgYmxpbmRpbmdLZXkgPSBzdWJLZXlzLnN1YmFycmF5KHNvZGl1bS5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKQoKICAgIGlmICghYmxvY2spIHsKICAgICAgaWYgKGNvbXBhdCkgewogICAgICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goYmxvY2tLZXksIFtlbmNyeXB0aW9uS2V5XSwgaHlwZXJjb3JlS2V5KQogICAgICB9IGVsc2UgewogICAgICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goYmxvY2tLZXksIFtERUZBVUxUX0VOQ1JZUFRJT04sIGh5cGVyY29yZUtleSwgZW5jcnlwdGlvbktleV0pCiAgICAgIH0KICAgIH0KCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGJsaW5kaW5nS2V5LCBibG9ja0tleSkKCiAgICByZXR1cm4gewogICAgICBibGluZGluZzogYmxpbmRpbmdLZXksCiAgICAgIGJsb2NrOiBibG9ja0tleQogICAgfQogIH0KCiAgc3RhdGljIGJsb2NrRW5jcnlwdGlvbktleShoeXBlcmNvcmVLZXksIGVuY3J5cHRpb25LZXkpIHsKICAgIGNvbnN0IGJsb2NrS2V5ID0gYjRhLmFsbG9jKHNvZGl1bS5jcnlwdG9fc3RyZWFtX0tFWUJZVEVTKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaF9iYXRjaChibG9ja0tleSwgW0RFRkFVTFRfRU5DUllQVElPTiwgaHlwZXJjb3JlS2V5LCBlbmNyeXB0aW9uS2V5XSkKICAgIHJldHVybiBibG9ja0tleQogIH0KCiAgc3RhdGljIGVuY3J5cHQoaW5kZXgsIGJsb2NrLCBmb3JrLCBibG9ja0tleSwgYmxpbmRpbmdLZXkpIHsKICAgIGNvbnN0IHBhZGRpbmcgPSBibG9jay5zdWJhcnJheSgwLCBEZWZhdWx0RW5jcnlwdGlvbi5QQURESU5HKQogICAgYmxvY2sgPSBibG9jay5zdWJhcnJheShEZWZhdWx0RW5jcnlwdGlvbi5QQURESU5HKQoKICAgIGMudWludDY0LmVuY29kZSh7IHN0YXJ0OiAwLCBlbmQ6IDgsIGJ1ZmZlcjogcGFkZGluZyB9LCBmb3JrKQogICAgYy51aW50NjQuZW5jb2RlKHsgc3RhcnQ6IDAsIGVuZDogOCwgYnVmZmVyOiBub25jZSB9LCBpbmRleCkKCiAgICAvLyBaZXJvIG91dCBhbnkgcHJldmlvdXMgcGFkZGluZy4KICAgIG5vbmNlLmZpbGwoMCwgOCwgOCArIHBhZGRpbmcuYnl0ZUxlbmd0aCkKCiAgICAvLyBCbGluZCB0aGUgZm9yayBJRCwgcG9zc2libHkgcmlza2luZyByZXVzaW5nIHRoZSBub25jZSBvbiBhIHJlb3JnIG9mIHRoZQogICAgLy8gSHlwZXJjb3JlLiBUaGlzIGlzIGZpbmUgYXMgdGhlIGJsaW5kaW5nIGlzIGJlc3QtZWZmb3J0IGFuZCB0aGUgbGF0ZXN0CiAgICAvLyBmb3JrIElEIHNoYXJlZCBvbiByZXBsaWNhdGlvbiBhbnl3YXkuCiAgICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IocGFkZGluZywgcGFkZGluZywgbm9uY2UsIGJsaW5kaW5nS2V5KQoKICAgIG5vbmNlLnNldChwYWRkaW5nLCA4KQoKICAgIC8vIFRoZSBjb21iaW5hdGlvbiBvZiBhIChibGluZGVkKSBmb3JrIElEIGFuZCBhIGJsb2NrIGluZGV4IGlzIHVuaXF1ZSBmb3IgYQogICAgLy8gZ2l2ZW4gSHlwZXJjb3JlIGFuZCBpcyB0aGVyZWZvcmUgYSB2YWxpZCBub25jZSBmb3IgZW5jcnlwdGluZyB0aGUgYmxvY2suCiAgICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IoYmxvY2ssIGJsb2NrLCBub25jZSwgYmxvY2tLZXkpCiAgfQoKICBzdGF0aWMgZGVjcnlwdChpbmRleCwgYmxvY2ssIGJsb2NrS2V5KSB7CiAgICBjb25zdCBwYWRkaW5nID0gYmxvY2suc3ViYXJyYXkoMCwgRGVmYXVsdEVuY3J5cHRpb24uUEFERElORykKICAgIGJsb2NrID0gYmxvY2suc3ViYXJyYXkoRGVmYXVsdEVuY3J5cHRpb24uUEFERElORykKCiAgICBjLnVpbnQ2NC5lbmNvZGUoeyBzdGFydDogMCwgZW5kOiA4LCBidWZmZXI6IG5vbmNlIH0sIGluZGV4KQoKICAgIG5vbmNlLnNldChwYWRkaW5nLCA4KQoKICAgIC8vIERlY3J5cHQgdGhlIGJsb2NrIHVzaW5nIHRoZSBibGluZGVkIGZvcmsgSUQuCiAgICBzb2RpdW0uY3J5cHRvX3N0cmVhbV94b3IoYmxvY2ssIGJsb2NrLCBub25jZSwgYmxvY2tLZXkpCiAgfQoKICBlbmNyeXB0KGluZGV4LCBibG9jaywgZm9yaywgY29yZSkgewogICAgaWYgKGNvcmUuY29tcGF0ICE9PSB0aGlzLmNvbXBhdCkgdGhpcy5fcmVsb2FkKGNvcmUpCiAgICByZXR1cm4gRGVmYXVsdEVuY3J5cHRpb24uZW5jcnlwdChpbmRleCwgYmxvY2ssIGZvcmssIHRoaXMuYmxvY2tLZXksIHRoaXMuYmxpbmRpbmdLZXkpCiAgfQoKICBkZWNyeXB0KGluZGV4LCBibG9jaywgY29yZSkgewogICAgaWYgKGNvcmUuY29tcGF0ICE9PSB0aGlzLmNvbXBhdCkgdGhpcy5fcmVsb2FkKGNvcmUpCiAgICByZXR1cm4gRGVmYXVsdEVuY3J5cHRpb24uZGVjcnlwdChpbmRleCwgYmxvY2ssIHRoaXMuYmxvY2tLZXkpCiAgfQoKICBwYWRkaW5nKCkgewogICAgcmV0dXJuIERlZmF1bHRFbmNyeXB0aW9uLlBBRERJTkcKICB9CgogIF9yZWxvYWQoY29yZSkgewogICAgY29uc3QgYmxvY2sgPSBiNGEuZXF1YWxzKHRoaXMua2V5LCB0aGlzLmJsb2NrS2V5KQogICAgY29uc3Qga2V5cyA9IERlZmF1bHRFbmNyeXB0aW9uLmRlcml2ZUtleXModGhpcy5rZXksIGNvcmUua2V5LCB7IGJsb2NrLCBjb21wYXQ6IGNvcmUuY29tcGF0IH0pCgogICAgdGhpcy5ibG9ja0tleSA9IGtleXMuYmxvY2tLZXkKICAgIHRoaXMuYmxpbmRpbmdLZXkgPSBrZXlzLmJsaW5kaW5nS2V5CiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgRG93bmxvYWQgewogIGNvbnN0cnVjdG9yKHNlc3Npb24sIHJhbmdlKSB7CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLnJhbmdlID0gcmFuZ2UKICAgIHRoaXMucmVxdWVzdCA9IG51bGwKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMub3BlbmluZyA9IHRoaXMuX29wZW4oKQogICAgdGhpcy5vcGVuaW5nLmNhdGNoKG5vb3ApCiAgfQoKICByZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLm9wZW5pbmcKICB9CgogIGFzeW5jIF9vcGVuKCkgewogICAgaWYgKHRoaXMuc2Vzc2lvbi5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLnNlc3Npb24ub3BlbmluZwogICAgdGhpcy5fZG93bmxvYWQoKQogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgfQoKICBhc3luYyBkb25lKCkgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVxdWVzdC5wcm9taXNlCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGlzU2Vzc2lvbk1vdmVkKGVycikpIHJldHVybiB0aGlzLl9kb3dubG9hZCgpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgX2Rvd25sb2FkKCkgewogICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSAodGhpcy5yYW5nZSAmJiB0aGlzLnJhbmdlLmFjdGl2ZVJlcXVlc3RzKSB8fCB0aGlzLnNlc3Npb24uYWN0aXZlUmVxdWVzdHMKICAgIHRoaXMucmVxdWVzdCA9IHRoaXMuc2Vzc2lvbi5jb3JlLnJlcGxpY2F0b3IuYWRkUmFuZ2UoYWN0aXZlUmVxdWVzdHMsIHRoaXMucmFuZ2UpCiAgICB0aGlzLnJlcXVlc3QucHJvbWlzZS5jYXRjaChub29wKQogICAgcmV0dXJuIHRoaXMucmVxdWVzdC5wcm9taXNlCiAgfQoKICAvKioKICAgKiBEZXByZWNhdGVkLiBVc2UgYHJhbmdlLmRvbmUoKWAuCiAgICovCiAgZG93bmxvYWRlZCgpIHsKICAgIHJldHVybiB0aGlzLmRvbmUoKQogIH0KCiAgZGVzdHJveSgpIHsKICAgIHRoaXMuX2Rlc3Ryb3lCYWNrZ3JvdW5kKCkuY2F0Y2gobm9vcCkKICB9CgogIGFzeW5jIF9kZXN0cm95QmFja2dyb3VuZCgpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQogICAgaWYgKHRoaXMucmVxdWVzdC5jb250ZXh0KSB0aGlzLnJlcXVlc3QuY29udGV4dC5kZXRhY2godGhpcy5yZXF1ZXN0KQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CgpmdW5jdGlvbiBpc1Nlc3Npb25Nb3ZlZChlcnIpIHsKICByZXR1cm4gZXJyLmNvZGUgPT09ICdTRVNTSU9OX01PVkVEJwp9CmNvbnN0IFRJQ0tTID0gMTYKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSG90c3dhcFF1ZXVlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMucHJpb3JpdGllcyA9IFtbXSwgW10sIFtdXQogIH0KCiAgKnBpY2socGVlcikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnByaW9yaXRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgLy8gdHJ5IGZpcnN0IG9uZSBtb3JlIHRoYW4gc2Vjb25kIG9uZSBldGMgZXRjCiAgICAgIGxldCB0aWNrcyA9ICh0aGlzLnByaW9yaXRpZXMubGVuZ3RoIC0gaSkgKiBUSUNLUwogICAgICBjb25zdCBxdWV1ZSA9IHRoaXMucHJpb3JpdGllc1tpXQoKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBxdWV1ZS5sZW5ndGg7IGorKykgewogICAgICAgIGNvbnN0IHIgPSBqICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcXVldWUubGVuZ3RoIC0gaikKICAgICAgICBjb25zdCBhID0gcXVldWVbal0KICAgICAgICBjb25zdCBiID0gcXVldWVbcl0KCiAgICAgICAgaWYgKHIgIT09IGopIHsKICAgICAgICAgIHF1ZXVlWyhiLmhvdHN3YXAuaW5kZXggPSBqKV0gPSBiCiAgICAgICAgICBxdWV1ZVsoYS5ob3Rzd2FwLmluZGV4ID0gcildID0gYQogICAgICAgIH0KCiAgICAgICAgaWYgKGhhc0luZmxpZ2h0KGIsIHBlZXIpKSBjb250aW51ZQoKICAgICAgICB5aWVsZCBiCgogICAgICAgIGlmICgtLXRpY2tzIDw9IDApIGJyZWFrCiAgICAgIH0KICAgIH0KICB9CgogIGFkZChibG9jaykgewogICAgaWYgKGJsb2NrLmhvdHN3YXAgIT09IG51bGwpIHRoaXMucmVtb3ZlKGJsb2NrKQogICAgaWYgKGJsb2NrLmluZmxpZ2h0Lmxlbmd0aCA9PT0gMCB8fCBibG9jay5pbmZsaWdodC5sZW5ndGggPj0gMykgcmV0dXJuCgogICAgLy8gVE9ETzogYWxzbyB1c2Ugb3RoZXIgc3R1ZmYgdG8gZGV0ZXJtaW5lIHF1ZXVlIHByaW8KICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5wcmlvcml0aWVzW2Jsb2NrLmluZmxpZ2h0Lmxlbmd0aCAtIDFdCgogICAgY29uc3QgaW5kZXggPSBxdWV1ZS5wdXNoKGJsb2NrKSAtIDEKICAgIGJsb2NrLmhvdHN3YXAgPSB7IHJlZjogdGhpcywgcXVldWUsIGluZGV4IH0KICB9CgogIHJlbW92ZShibG9jaykgewogICAgY29uc3QgaG90c3dhcCA9IGJsb2NrLmhvdHN3YXAKICAgIGlmIChob3Rzd2FwID09PSBudWxsKSByZXR1cm4KCiAgICBibG9jay5ob3Rzd2FwID0gbnVsbAogICAgY29uc3QgaGVhZCA9IGhvdHN3YXAucXVldWUucG9wKCkKICAgIGlmIChoZWFkID09PSBibG9jaykgcmV0dXJuCiAgICBob3Rzd2FwLnF1ZXVlWyhoZWFkLmhvdHN3YXAuaW5kZXggPSBob3Rzd2FwLmluZGV4KV0gPSBoZWFkCiAgfQp9CgpmdW5jdGlvbiBoYXNJbmZsaWdodChibG9jaywgcGVlcikgewogIGZvciAobGV0IGogPSAwOyBqIDwgYmxvY2suaW5mbGlnaHQubGVuZ3RoOyBqKyspIHsKICAgIGlmIChibG9jay5pbmZsaWdodFtqXS5wZWVyID09PSBwZWVyKSByZXR1cm4gdHJ1ZQogIH0KICByZXR1cm4gZmFsc2UKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEluZm8gewogIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSkgewogICAgdGhpcy5rZXkgPSBvcHRzLmtleQogICAgdGhpcy5kaXNjb3ZlcnlLZXkgPSBvcHRzLmRpc2NvdmVyeUtleQogICAgdGhpcy5sZW5ndGggPSBvcHRzLmxlbmd0aCB8fCAwCiAgICB0aGlzLmNvbnRpZ3VvdXNMZW5ndGggPSBvcHRzLmNvbnRpZ3VvdXNMZW5ndGggfHwgMAogICAgdGhpcy5ieXRlTGVuZ3RoID0gb3B0cy5ieXRlTGVuZ3RoIHx8IDAKICAgIHRoaXMuZm9yayA9IG9wdHMuZm9yayB8fCAwCiAgICB0aGlzLnBhZGRpbmcgPSBvcHRzLnBhZGRpbmcgfHwgMAogICAgdGhpcy5zdG9yYWdlID0gb3B0cy5zdG9yYWdlIHx8IG51bGwKICB9CgogIHN0YXRpYyBhc3luYyBmcm9tKHNlc3Npb24sIG9wdHMgPSB7fSkgewogICAgcmV0dXJuIG5ldyBJbmZvKHsKICAgICAga2V5OiBzZXNzaW9uLmtleSwKICAgICAgZGlzY292ZXJ5S2V5OiBzZXNzaW9uLmRpc2NvdmVyeUtleSwKICAgICAgbGVuZ3RoOiBzZXNzaW9uLmxlbmd0aCwKICAgICAgY29udGlndW91c0xlbmd0aDogc2Vzc2lvbi5jb250aWd1b3VzTGVuZ3RoLAogICAgICBieXRlTGVuZ3RoOiBzZXNzaW9uLmJ5dGVMZW5ndGgsCiAgICAgIGZvcms6IHNlc3Npb24uZm9yaywKICAgICAgcGFkZGluZzogc2Vzc2lvbi5wYWRkaW5nLAogICAgICBzdG9yYWdlOiBvcHRzLnN0b3JhZ2UgPyBhd2FpdCB0aGlzLnN0b3JhZ2Uoc2Vzc2lvbikgOiBudWxsCiAgICB9KQogIH0KCiAgc3RhdGljIGFzeW5jIHN0b3JhZ2Uoc2Vzc2lvbikgewogICAgY29uc3QgeyBvcGxvZywgdHJlZSwgYmxvY2tzLCBiaXRmaWVsZCB9ID0gc2Vzc2lvbi5jb3JlCiAgICB0cnkgewogICAgICByZXR1cm4gewogICAgICAgIG9wbG9nOiBhd2FpdCBJbmZvLmJ5dGVzVXNlZChvcGxvZy5zdG9yYWdlKSwKICAgICAgICB0cmVlOiBhd2FpdCBJbmZvLmJ5dGVzVXNlZCh0cmVlLnN0b3JhZ2UpLAogICAgICAgIGJsb2NrczogYXdhaXQgSW5mby5ieXRlc1VzZWQoYmxvY2tzLnN0b3JhZ2UpLAogICAgICAgIGJpdGZpZWxkOiBhd2FpdCBJbmZvLmJ5dGVzVXNlZChiaXRmaWVsZC5zdG9yYWdlKQogICAgICB9CiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9CgogIHN0YXRpYyBieXRlc1VzZWQoZmlsZSkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgZmlsZS5zdGF0KChlcnIsIHN0KSA9PiB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcmVzb2x2ZSgwKSAvLyBwcm9iIGp1c3QgZmlsZSBub3QgZm91bmQgKFRPRE8sIGltcHJvdmUpCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3QuYmxvY2tzICE9PSAnbnVtYmVyJykgewogICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignY2Fubm90IGRldGVybWluZSBieXRlcyB1c2VkJykpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc29sdmUoc3QuYmxvY2tzICogNTEyKQogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChjb3JlLCBkZXB0aCwgb3B0cykgewogIGxldCBpbmRlbnQgPSAnJwogIGlmICh0eXBlb2Ygb3B0cy5pbmRlbnRhdGlvbkx2bCA9PT0gJ251bWJlcicpIHsKICAgIHdoaWxlIChpbmRlbnQubGVuZ3RoIDwgb3B0cy5pbmRlbnRhdGlvbkx2bCkgaW5kZW50ICs9ICcgJwogIH0KCiAgbGV0IHBlZXJzID0gJycKICBjb25zdCBtaW4gPSBNYXRoLm1pbihjb3JlLnBlZXJzLmxlbmd0aCwgNSkKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBtaW47IGkrKykgewogICAgY29uc3QgcGVlciA9IGNvcmUucGVlcnNbaV0KCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgIFBlZXIoXG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgICAgcmVtb3RlUHVibGljS2V5OiAke29wdHMuc3R5bGl6ZSh0b0hleChwZWVyLnJlbW90ZVB1YmxpY0tleSksICdzdHJpbmcnKX1cbmAKICAgIHBlZXJzICs9IGAke2luZGVudH0gICAgICByZW1vdGVMZW5ndGg6ICR7b3B0cy5zdHlsaXplKHBlZXIucmVtb3RlTGVuZ3RoLCAnbnVtYmVyJyl9XG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgICAgcmVtb3RlRm9yazogJHtvcHRzLnN0eWxpemUocGVlci5yZW1vdGVGb3JrLCAnbnVtYmVyJyl9XG5gCiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAgICAgcmVtb3RlQ2FuVXBncmFkZTogJHtvcHRzLnN0eWxpemUocGVlci5yZW1vdGVDYW5VcGdyYWRlLCAnYm9vbGVhbicpfVxuYAogICAgcGVlcnMgKz0gYCR7aW5kZW50fSAgICApXG5gCiAgfQoKICBpZiAoY29yZS5wZWVycy5sZW5ndGggPiA1KSB7CiAgICBwZWVycyArPSBgJHtpbmRlbnR9ICAuLi4gYW5kICR7Y29yZS5wZWVycy5sZW5ndGggLSA1fSBtb3JlXG5gCiAgfQoKICBpZiAocGVlcnMpIHBlZXJzID0gYFtcbiR7cGVlcnN9JHtpbmRlbnR9ICBdYAogIGVsc2UgcGVlcnMgPSBgWyAke29wdHMuc3R5bGl6ZSgwLCAnbnVtYmVyJyl9IF1gCgogIHJldHVybiAoCiAgICBgJHtjb3JlLmNvbnN0cnVjdG9yLm5hbWV9KFxuYCArCiAgICBgJHtpbmRlbnR9ICBpZDogJHtvcHRzLnN0eWxpemUoY29yZS5pZCwgJ3N0cmluZycpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBrZXk6ICR7b3B0cy5zdHlsaXplKHRvSGV4KGNvcmUua2V5KSwgJ3N0cmluZycpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBkaXNjb3ZlcnlLZXk6ICR7b3B0cy5zdHlsaXplKHRvSGV4KGNvcmUuZGlzY292ZXJ5S2V5KSwgJ3N0cmluZycpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBvcGVuZWQ6ICR7b3B0cy5zdHlsaXplKGNvcmUub3BlbmVkLCAnYm9vbGVhbicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBjbG9zZWQ6ICR7b3B0cy5zdHlsaXplKGNvcmUuY2xvc2VkLCAnYm9vbGVhbicpfVxuYCArCiAgICBgJHtpbmRlbnR9ICBzbmFwc2hvdHRlZDogJHtvcHRzLnN0eWxpemUoY29yZS5zbmFwc2hvdHRlZCwgJ2Jvb2xlYW4nKX1cbmAgKwogICAgYCR7aW5kZW50fSAgd3JpdGFibGU6ICR7b3B0cy5zdHlsaXplKGNvcmUud3JpdGFibGUsICdib29sZWFuJyl9XG5gICsKICAgIGAke2luZGVudH0gIGxlbmd0aDogJHtvcHRzLnN0eWxpemUoY29yZS5sZW5ndGgsICdudW1iZXInKX1cbmAgKwogICAgYCR7aW5kZW50fSAgZm9yazogJHtvcHRzLnN0eWxpemUoY29yZS5mb3JrLCAnbnVtYmVyJyl9XG5gICsKICAgIGAke2luZGVudH0gIHNlc3Npb25zOiBbICR7b3B0cy5zdHlsaXplKGNvcmUuc2Vzc2lvbnMubGVuZ3RoLCAnbnVtYmVyJyl9IF1cbmAgKwogICAgYCR7aW5kZW50fSAgYWN0aXZlUmVxdWVzdHM6IFsgJHtvcHRzLnN0eWxpemUoY29yZS5hY3RpdmVSZXF1ZXN0cy5sZW5ndGgsICdudW1iZXInKX0gXVxuYCArCiAgICBgJHtpbmRlbnR9ICBwZWVyczogJHtwZWVyc31cbmAgKwogICAgYCR7aW5kZW50fSlgCiAgKQp9CgpmdW5jdGlvbiB0b0hleChidWYpIHsKICByZXR1cm4gYnVmICYmIGI0YS50b1N0cmluZyhidWYsICdoZXgnKQp9CmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKY29uc3QgY2FwcyA9IHJlcXVpcmUoJy4vY2FwcycpCmNvbnN0IHsKICBJTlZBTElEX1BST09GLAogIElOVkFMSURfQ0hFQ0tTVU0sCiAgSU5WQUxJRF9PUEVSQVRJT04sCiAgQkFEX0FSR1VNRU5ULAogIEFTU0VSVElPTgp9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCgpjbGFzcyBOb2RlUXVldWUgewogIGNvbnN0cnVjdG9yKG5vZGVzLCBleHRyYSA9IG51bGwpIHsKICAgIHRoaXMuaSA9IDAKICAgIHRoaXMubm9kZXMgPSBub2RlcwogICAgdGhpcy5leHRyYSA9IGV4dHJhCiAgICB0aGlzLmxlbmd0aCA9IG5vZGVzLmxlbmd0aCArICh0aGlzLmV4dHJhID09PSBudWxsID8gMCA6IDEpCiAgfQoKICBzaGlmdChpbmRleCkgewogICAgaWYgKHRoaXMuZXh0cmEgIT09IG51bGwgJiYgdGhpcy5leHRyYS5pbmRleCA9PT0gaW5kZXgpIHsKICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuZXh0cmEKICAgICAgdGhpcy5leHRyYSA9IG51bGwKICAgICAgdGhpcy5sZW5ndGgtLQogICAgICByZXR1cm4gbm9kZQogICAgfQoKICAgIGlmICh0aGlzLmkgPj0gdGhpcy5ub2Rlcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0V4cGVjdGVkIG5vZGUgJyArIGluZGV4ICsgJywgZ290IChuaWwpJykKICAgIH0KCiAgICBjb25zdCBub2RlID0gdGhpcy5ub2Rlc1t0aGlzLmkrK10KICAgIGlmIChub2RlLmluZGV4ICE9PSBpbmRleCkgewogICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignRXhwZWN0ZWQgbm9kZSAnICsgaW5kZXggKyAnLCBnb3Qgbm9kZSAnICsgbm9kZS5pbmRleCkKICAgIH0KCiAgICB0aGlzLmxlbmd0aC0tCiAgICByZXR1cm4gbm9kZQogIH0KfQoKY2xhc3MgTWVya2xlVHJlZUJhdGNoIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uKSB7CiAgICB0aGlzLmZvcmsgPSBzZXNzaW9uLmZvcmsKICAgIHRoaXMucm9vdHMgPSBbLi4uc2Vzc2lvbi5yb290c10KICAgIHRoaXMubGVuZ3RoID0gc2Vzc2lvbi5sZW5ndGgKICAgIHRoaXMuc2lnbmF0dXJlID0gc2Vzc2lvbi5zaWduYXR1cmUKICAgIHRoaXMuYW5jZXN0b3JzID0gc2Vzc2lvbi5sZW5ndGgKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IHNlc3Npb24uYnl0ZUxlbmd0aAogICAgdGhpcy5wcm9sb2d1ZSA9IHNlc3Npb24ucHJvbG9ndWUKICAgIHRoaXMuaGFzaENhY2hlZCA9IG51bGwKCiAgICB0aGlzLmNvbW1pdHRlZCA9IGZhbHNlCiAgICB0aGlzLnRydW5jYXRlZCA9IGZhbHNlCiAgICB0aGlzLnRyZWVMZW5ndGggPSBzZXNzaW9uLmxlbmd0aAogICAgdGhpcy50cmVlRm9yayA9IHNlc3Npb24uZm9yawogICAgdGhpcy5zdG9yYWdlID0gc2Vzc2lvbi5zdG9yYWdlCiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCiAgICB0aGlzLm5vZGVzID0gW10KICAgIHRoaXMudXBncmFkZWQgPSBmYWxzZQogIH0KCiAgY2hlY2tvdXQobGVuZ3RoLCBhZGRpdGlvbmFsUm9vdHMpIHsKICAgIGNvbnN0IHJvb3RzID0gW10KICAgIGxldCByID0gMAoKICAgIGNvbnN0IGhlYWQgPSAyICogbGVuZ3RoIC0gMgogICAgY29uc3QgZ2FwcyA9IG5ldyBTZXQoKQogICAgY29uc3QgYWxsID0gbmV3IE1hcCgpCgogICAgLy8gYWRkaXRpb25hbCByb290cyBpcyBzbyB0aGUgb3JpZ2luYWwgcm9vdHMgY2FuIGJlIHBhc3NlZCAod2UgbXV0YXRlIHRoZSBhcnJheSBpbiBhcHBlbmRSb290KQogICAgaWYgKGFkZGl0aW9uYWxSb290cykgewogICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgYWRkaXRpb25hbFJvb3RzKSBhbGwuc2V0KG5vZGUuaW5kZXgsIG5vZGUpCiAgICB9CgogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMubm9kZXMpIGFsbC5zZXQobm9kZS5pbmRleCwgbm9kZSkKCiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGZsYXQuZnVsbFJvb3RzKGhlYWQgKyAyKSkgewogICAgICBjb25zdCBsZWZ0ID0gZmxhdC5sZWZ0U3BhbihpbmRleCkKICAgICAgaWYgKGxlZnQgIT09IDApIGdhcHMuYWRkKGxlZnQgLSAxKQoKICAgICAgaWYgKHIgPCB0aGlzLnJvb3RzLmxlbmd0aCAmJiB0aGlzLnJvb3RzW3JdLmluZGV4ID09PSBpbmRleCkgewogICAgICAgIHJvb3RzLnB1c2godGhpcy5yb290c1tyKytdKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KICAgICAgY29uc3Qgbm9kZSA9IGFsbC5nZXQoaW5kZXgpCiAgICAgIGlmICghbm9kZSkgdGhyb3cgbmV3IEJBRF9BUkdVTUVOVCgncm9vdCBtaXNzaW5nIGZvciBnaXZlbiBsZW5ndGgnKQogICAgICByb290cy5wdXNoKG5vZGUpCiAgICB9CgogICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5ieXRlTGVuZ3RoID0gdG90YWxTaXplKHJvb3RzKQogICAgdGhpcy5oYXNoQ2FjaGVkID0gbnVsbAogICAgdGhpcy5zaWduYXR1cmUgPSBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ub2Rlc1tpXS5pbmRleAogICAgICBpZiAoaW5kZXggPD0gaGVhZCAmJiAhZ2Fwcy5oYXMoaW5kZXgpKSBjb250aW51ZQogICAgICBjb25zdCBsYXN0ID0gdGhpcy5ub2Rlcy5wb3AoKQogICAgICBpZiAoaSA8IHRoaXMubm9kZXMubGVuZ3RoKSB0aGlzLm5vZGVzW2ktLV0gPSBsYXN0CiAgICB9CiAgfQoKICBwcnVuZShsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPT09IDApIHJldHVybgoKICAgIGNvbnN0IGhlYWQgPSAyICogbGVuZ3RoIC0gMgogICAgY29uc3QgZ2FwcyA9IG5ldyBTZXQoKQoKICAgIC8vIFRPRE86IG1ha2UgYSBmdW5jdGlvbiBmb3IgdGhpcyBpbiBmbGF0LXRyZWUKICAgIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5mdWxsUm9vdHMoaGVhZCArIDIpKSB7CiAgICAgIGNvbnN0IGxlZnQgPSBmbGF0LmxlZnRTcGFuKGluZGV4KQogICAgICBpZiAobGVmdCAhPT0gMCkgZ2Fwcy5hZGQobGVmdCAtIDEpCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ub2Rlc1tpXS5pbmRleAogICAgICBpZiAoaW5kZXggPiBoZWFkIHx8IGdhcHMuaGFzKGluZGV4KSkgY29udGludWUKICAgICAgY29uc3QgbGFzdCA9IHRoaXMubm9kZXMucG9wKCkKICAgICAgaWYgKGkgPCB0aGlzLm5vZGVzLmxlbmd0aCkgdGhpcy5ub2Rlc1tpLS1dID0gbGFzdAogICAgfQogIH0KCiAgY2xvbmUoKSB7CiAgICBjb25zdCBiID0gbmV3IE1lcmtsZVRyZWVCYXRjaCh0aGlzLnNlc3Npb24pCgogICAgYi5mb3JrID0gdGhpcy5mb3JrCiAgICBiLnJvb3RzID0gWy4uLnRoaXMucm9vdHNdCiAgICBiLmxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICBiLmJ5dGVMZW5ndGggPSB0aGlzLmJ5dGVMZW5ndGgKICAgIGIuc2lnbmF0dXJlID0gdGhpcy5zaWduYXR1cmUKICAgIGIudHJlZUxlbmd0aCA9IHRoaXMudHJlZUxlbmd0aAogICAgYi50cmVlRm9yayA9IHRoaXMudHJlZUZvcmsKICAgIGIudHJlZSA9IHRoaXMudHJlZQogICAgYi5ub2RlcyA9IFsuLi50aGlzLm5vZGVzXQogICAgYi51cGdyYWRlZCA9IHRoaXMudXBncmFkZWQKCiAgICByZXR1cm4gYgogIH0KCiAgaGFzaCgpIHsKICAgIGlmICh0aGlzLmhhc2hDYWNoZWQgPT09IG51bGwpIHRoaXMuaGFzaENhY2hlZCA9IHVuc2xhYihjcnlwdG8udHJlZSh0aGlzLnJvb3RzKSkKICAgIHJldHVybiB0aGlzLmhhc2hDYWNoZWQKICB9CgogIHNpZ25hYmxlKG1hbmlmZXN0SGFzaCkgewogICAgcmV0dXJuIGNhcHMudHJlZVNpZ25hYmxlKG1hbmlmZXN0SGFzaCwgdGhpcy5oYXNoKCksIHRoaXMubGVuZ3RoLCB0aGlzLmZvcmspCiAgfQoKICBzaWduYWJsZUNvbXBhdChub0hlYWRlcikgewogICAgcmV0dXJuIGNhcHMudHJlZVNpZ25hYmxlQ29tcGF0KHRoaXMuaGFzaCgpLCB0aGlzLmxlbmd0aCwgdGhpcy5mb3JrLCBub0hlYWRlcikKICB9CgogIGdldChpbmRleCkgewogICAgaWYgKGluZGV4ID49IHRoaXMubGVuZ3RoICogMikgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGZvciAoY29uc3QgbiBvZiB0aGlzLm5vZGVzKSB7CiAgICAgIGlmIChuLmluZGV4ID09PSBpbmRleCkgcmV0dXJuIG4KICAgIH0KCiAgICByZXR1cm4gZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZSh0aGlzLnNlc3Npb24uc3RvcmFnZSwgaW5kZXgpCiAgfQoKICAvLyBkZXByZWNhdGVkLCB1c2Ugc3NzaW9uIHByb29mIGluc3RlYWQKICBwcm9vZihiYXRjaCwgeyBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSB9KSB7CiAgICByZXR1cm4gZ2VuZXJhdGVQcm9vZih0aGlzLnNlc3Npb24sIGJhdGNoLCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkKICB9CgogIHZlcmlmeVVwZ3JhZGUocHJvb2YpIHsKICAgIGNvbnN0IHVudmVyaWZpZWQgPSB2ZXJpZnlUcmVlKHByb29mLCB0aGlzLm5vZGVzKQoKICAgIGlmICghcHJvb2YudXBncmFkZSkgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0V4cGVjdGVkIHVwZ3JhZGUgcHJvb2YnKQoKICAgIHJldHVybiB2ZXJpZnlVcGdyYWRlKHByb29mLCB1bnZlcmlmaWVkLCB0aGlzKQogIH0KCiAgYWRkTm9kZXNVbnNhZmUobm9kZXMpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGVzW2ldKQogICAgfQogIH0KCiAgYXBwZW5kKGJ1ZikgewogICAgY29uc3QgaGVhZCA9IHRoaXMubGVuZ3RoICogMgogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihoZWFkKQogICAgY29uc3Qgbm9kZSA9IGJsb2NrTm9kZShoZWFkLCBidWYpCgogICAgdGhpcy5hcHBlbmRSb290KG5vZGUsIGl0ZSkKICB9CgogIGFwcGVuZFJvb3Qobm9kZSwgaXRlKSB7CiAgICBub2RlID0gdW5zbGFiTm9kZShub2RlKQogICAgdGhpcy5oYXNoQ2FjaGVkID0gbnVsbAogICAgdGhpcy51cGdyYWRlZCA9IHRydWUKICAgIHRoaXMubGVuZ3RoICs9IGl0ZS5mYWN0b3IgLyAyCiAgICB0aGlzLmJ5dGVMZW5ndGggKz0gbm9kZS5zaXplCiAgICB0aGlzLnJvb3RzLnB1c2gobm9kZSkKICAgIHRoaXMubm9kZXMucHVzaChub2RlKQoKICAgIHdoaWxlICh0aGlzLnJvb3RzLmxlbmd0aCA+IDEpIHsKICAgICAgY29uc3QgYSA9IHRoaXMucm9vdHNbdGhpcy5yb290cy5sZW5ndGggLSAxXQogICAgICBjb25zdCBiID0gdGhpcy5yb290c1t0aGlzLnJvb3RzLmxlbmd0aCAtIDJdCgogICAgICAvLyBUT0RPOiBqdXN0IGhhdmUgYSBwZWVrIHNpYmxpbmcgaW5zdGVhZD8gKHByZXR0eSBzdXJlIGl0J3MgYWx3YXlzIHRoZSBsZWZ0IHNpYiBhcyB3ZWxsKQogICAgICBpZiAoaXRlLnNpYmxpbmcoKSAhPT0gYi5pbmRleCkgewogICAgICAgIGl0ZS5zaWJsaW5nKCkgLy8gdW5zZXQgc28gaXQgYWx3YXlzIHBvaW50cyB0byBsYXN0IHJvb3QKICAgICAgICBicmVhawogICAgICB9CgogICAgICBjb25zdCBub2RlID0gdW5zbGFiTm9kZShwYXJlbnROb2RlKGl0ZS5wYXJlbnQoKSwgYSwgYikpCiAgICAgIHRoaXMubm9kZXMucHVzaChub2RlKQogICAgICB0aGlzLnJvb3RzLnBvcCgpCiAgICAgIHRoaXMucm9vdHMucG9wKCkKICAgICAgdGhpcy5yb290cy5wdXNoKG5vZGUpCiAgICB9CiAgfQoKICBjb21taXRhYmxlKCkgewogICAgcmV0dXJuICgKICAgICAgdGhpcy50cmVlRm9yayA9PT0gdGhpcy5zZXNzaW9uLmZvcmsgJiYKICAgICAgKHRoaXMudXBncmFkZWQKICAgICAgICA/IHRoaXMudHJlZUxlbmd0aCA9PT0gdGhpcy5zZXNzaW9uLmxlbmd0aAogICAgICAgIDogdGhpcy50cmVlTGVuZ3RoIDw9IHRoaXMuc2Vzc2lvbi5sZW5ndGgpCiAgICApCiAgfQoKICBjb21taXQodHgpIHsKICAgIGlmICh0eCA9PT0gdW5kZWZpbmVkKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignTm8gZGF0YWJhc2UgYmF0Y2ggd2FzIHBhc3NlZCcpCiAgICBpZiAoIXRoaXMuY29tbWl0YWJsZSgpKSB7CiAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdUcmVlIHdhcyBtb2RpZmllZCBkdXJpbmcgYmF0Y2gsIHJlZnVzaW5nIHRvIGNvbW1pdCcpCiAgICB9CgogICAgaWYgKHRoaXMudXBncmFkZWQpIHRoaXMuX2NvbW1pdFVwZ3JhZGUodHgpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzW2ldCiAgICAgIHR4LnB1dFRyZWVOb2RlKG5vZGUpCiAgICB9CgogICAgdGhpcy5jb21taXR0ZWQgPSB0cnVlCgogICAgcmV0dXJuIHRoaXMKICB9CgogIF9jb21taXRVcGdyYWRlKHR4KSB7CiAgICAvLyBUT0RPOiBJZiBlYXN5IHRvIGRldGVjdCwgd2Ugc2hvdWxkIHJlZnVzZSBhbiB0cnVuYythcHBlbmQgaGVyZSB3aXRob3V0IGEgZm9yayBpZAogICAgLy8gY2hhbmdlLiBXaWxsIG9ubHkgaGFwcGVuIG9uIHVzZXIgZXJyb3Igc28gbW9zdGx5IHRvIHByZXZlbnQgdGhhdC4KCiAgICBpZiAodGhpcy5hbmNlc3RvcnMgPCB0aGlzLnRyZWVMZW5ndGgpIHsKICAgICAgdHguZGVsZXRlVHJlZU5vZGVSYW5nZSh0aGlzLmFuY2VzdG9ycyAqIDIsIHRoaXMudHJlZUxlbmd0aCAqIDIpCgogICAgICBpZiAodGhpcy5hbmNlc3RvcnMgPiAwKSB7CiAgICAgICAgY29uc3QgaGVhZCA9IHRoaXMuYW5jZXN0b3JzICogMgogICAgICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaGVhZCAtIDIpCgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBpZiAoaXRlLmNvbnRhaW5zKGhlYWQpICYmIGl0ZS5pbmRleCA8IGhlYWQpIHsKICAgICAgICAgICAgdHguZGVsZXRlVHJlZU5vZGUoaXRlLmluZGV4KQogICAgICAgICAgfQogICAgICAgICAgaWYgKGl0ZS5vZmZzZXQgPT09IDApIGJyZWFrCiAgICAgICAgICBpdGUucGFyZW50KCkKICAgICAgICB9CgogICAgICAgIHRoaXMudHJ1bmNhdGVkID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQoKICBzZWVrKGJ5dGVzLCBwYWRkaW5nKSB7CiAgICByZXR1cm4gbmV3IEJ5dGVTZWVrZXIodGhpcywgdGhpcywgYnl0ZXMsIHBhZGRpbmcpCiAgfQoKICBieXRlUmFuZ2UoaW5kZXgpIHsKICAgIGNvbnN0IHJ4ID0gdGhpcy5zdG9yYWdlLnJlYWQoKQogICAgY29uc3QgcmFuZ2UgPSBnZXRCeXRlUmFuZ2UodGhpcywgaW5kZXgsIHJ4KQogICAgcngudHJ5Rmx1c2goKQoKICAgIHJldHVybiByYW5nZQogIH0KCiAgYnl0ZU9mZnNldChpbmRleCkgewogICAgaWYgKGluZGV4ID09PSAyICogdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzLmJ5dGVMZW5ndGgKCiAgICBjb25zdCByeCA9IHRoaXMuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IG9mZnNldCA9IGdldEJ5dGVPZmZzZXQodGhpcywgaW5kZXgsIHJ4KQogICAgcngudHJ5Rmx1c2goKQoKICAgIHJldHVybiBvZmZzZXQKICB9CgogIGFzeW5jIGRvd25ncmFkZSgpIHsKICAgIGlmICghdGhpcy51cGdyYWRlZCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCByeCA9IHRoaXMuc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IG5vZGVQcm9taXNlcyA9IFtdCgogICAgZm9yIChjb25zdCByIG9mIHRoaXMucm9vdHMpIHsKICAgICAgbm9kZVByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUoci5pbmRleCkpCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IG5vZGVzID0gYXdhaXQgUHJvbWlzZS5hbGwobm9kZVByb21pc2VzKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yb290cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByb290ID0gdGhpcy5yb290c1tpXQogICAgICBjb25zdCBub2RlID0gbm9kZXNbaV0KCiAgICAgIGlmICghbm9kZSkgcmV0dXJuIGZhbHNlCiAgICAgIGlmICghYjRhLmVxdWFscyhub2RlLmhhc2gsIHJvb3QuaGFzaCkpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMudXBncmFkZWQgPSBmYWxzZQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIHJlc3RvcmUobGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSB0aGlzLmxlbmd0aCkgcmV0dXJuIHRoaXMKCiAgICBjb25zdCByb290cyA9IHVuc2xhYk5vZGVzKGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZSh0aGlzLnN0b3JhZ2UsIGxlbmd0aCkpCgogICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5ieXRlTGVuZ3RoID0gdG90YWxTaXplKHJvb3RzKQogICAgdGhpcy5hbmNlc3RvcnMgPSBsZW5ndGgKCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHRoaXMuYnl0ZUxlbmd0aCArPSBub2RlLnNpemUKCiAgICByZXR1cm4gdGhpcwogIH0KfQoKY2xhc3MgUmVvcmdCYXRjaCBleHRlbmRzIE1lcmtsZVRyZWVCYXRjaCB7CiAgY29uc3RydWN0b3Ioc2Vzc2lvbikgewogICAgc3VwZXIoc2Vzc2lvbikKCiAgICB0aGlzLnJvb3RzID0gW10KICAgIHRoaXMubGVuZ3RoID0gMAogICAgdGhpcy5ieXRlTGVuZ3RoID0gMAogICAgdGhpcy5kaWZmID0gbnVsbAogICAgdGhpcy5hbmNlc3RvcnMgPSAwCiAgICAvLyBXZSBzZXQgdXBncmFkZWQgYmVjYXVzZSByZW9yZ3MgYXJlIHNpZ25lZCBzbyBoaXQgd2lsbAogICAgLy8gaGl0IHRoZSBzYW1lIGNvZGUgcGF0aHMgKGxpa2UgdGhlIHRyZWVMZW5ndGggY2hlY2sgaW4gY29tbWl0KQogICAgdGhpcy51cGdyYWRlZCA9IHRydWUKICAgIHRoaXMud2FudCA9IHsKICAgICAgbm9kZXM6IDAsCiAgICAgIHN0YXJ0OiAwLAogICAgICBlbmQ6IDAKICAgIH0KICB9CgogIGdldCBmaW5pc2hlZCgpIHsKICAgIHJldHVybiB0aGlzLndhbnQgPT09IG51bGwKICB9CgogIHVwZGF0ZShwcm9vZikgewogICAgaWYgKHRoaXMud2FudCA9PT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBub2RlcyA9IFtdCiAgICBjb25zdCByb290ID0gdmVyaWZ5VHJlZShwcm9vZiwgbm9kZXMpCgogICAgaWYgKHJvb3QgPT09IG51bGwgfHwgIWI0YS5lcXVhbHMocm9vdC5oYXNoLCB0aGlzLmRpZmYuaGFzaCkpIHJldHVybiBmYWxzZQoKICAgIHRoaXMubm9kZXMucHVzaCguLi5ub2RlcykKICAgIHJldHVybiB0aGlzLl91cGRhdGUobm9kZXMpCiAgfQoKICBhc3luYyBfdXBkYXRlKG5vZGVzKSB7CiAgICBjb25zdCBuID0gbmV3IE1hcCgpCiAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIG4uc2V0KG5vZGUuaW5kZXgsIG5vZGUpCgogICAgbGV0IGRpZmYgPSBudWxsCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHRoaXMuZGlmZi5pbmRleCkKICAgIGNvbnN0IHN0YXJ0aW5nRGlmZiA9IHRoaXMuZGlmZgoKICAgIHdoaWxlICgoaXRlLmluZGV4ICYgMSkgIT09IDApIHsKICAgICAgY29uc3QgbGVmdCA9IG4uZ2V0KGl0ZS5sZWZ0Q2hpbGQoKSkKICAgICAgaWYgKCFsZWZ0KSBicmVhawoKICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBnZXRUcmVlTm9kZUZyb21TdG9yYWdlKHRoaXMuc2Vzc2lvbi5zdG9yYWdlLCBsZWZ0LmluZGV4KQogICAgICBpZiAoIWV4aXN0aW5nIHx8ICFiNGEuZXF1YWxzKGV4aXN0aW5nLmhhc2gsIGxlZnQuaGFzaCkpIHsKICAgICAgICBkaWZmID0gbGVmdAogICAgICB9IGVsc2UgewogICAgICAgIGRpZmYgPSBuLmdldChpdGUuc2libGluZygpKQogICAgICB9CiAgICB9CgogICAgaWYgKCh0aGlzLmRpZmYuaW5kZXggJiAxKSA9PT0gMCkgcmV0dXJuIHRydWUKICAgIGlmIChkaWZmID09PSBudWxsKSByZXR1cm4gZmFsc2UKICAgIGlmIChzdGFydGluZ0RpZmYgIT09IHRoaXMuZGlmZikgcmV0dXJuIGZhbHNlCgogICAgcmV0dXJuIHRoaXMuX3VwZGF0ZURpZmZSb290KGRpZmYpCiAgfQoKICBfdXBkYXRlRGlmZlJvb3QoZGlmZikgewogICAgaWYgKHRoaXMud2FudCA9PT0gbnVsbCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBzcGFucyA9IGZsYXQuc3BhbnMoZGlmZi5pbmRleCkKICAgIGNvbnN0IHN0YXJ0ID0gc3BhbnNbMF0gLyAyCiAgICBjb25zdCBlbmQgPSBNYXRoLm1pbih0aGlzLnRyZWVMZW5ndGgsIHNwYW5zWzFdIC8gMiArIDEpCiAgICBjb25zdCBsZW4gPSBlbmQgLSBzdGFydAoKICAgIHRoaXMuYW5jZXN0b3JzID0gc3RhcnQKICAgIHRoaXMuZGlmZiA9IGRpZmYKCiAgICBpZiAoKGRpZmYuaW5kZXggJiAxKSA9PT0gMCB8fCB0aGlzLndhbnQuc3RhcnQgPj0gdGhpcy50cmVlTGVuZ3RoIHx8IGxlbiA8PSAwKSB7CiAgICAgIHRoaXMud2FudCA9IG51bGwKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0aGlzLndhbnQuc3RhcnQgPSBzdGFydAogICAgdGhpcy53YW50LmVuZCA9IGVuZAogICAgdGhpcy53YW50Lm5vZGVzID0gbG9nMihzcGFuc1sxXSAtIHNwYW5zWzBdICsgMikgLSAxCgogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpjbGFzcyBCeXRlU2Vla2VyIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uLCBieXRlcywgcGFkZGluZyA9IDApIHsKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMuYnl0ZXMgPSBieXRlcwogICAgdGhpcy5wYWRkaW5nID0gcGFkZGluZwoKICAgIGNvbnN0IHNpemUgPSBzZXNzaW9uLmJ5dGVMZW5ndGggLSBzZXNzaW9uLmxlbmd0aCAqIHBhZGRpbmcKCiAgICB0aGlzLnN0YXJ0ID0gYnl0ZXMgPj0gc2l6ZSA/IHNlc3Npb24ubGVuZ3RoIDogMAogICAgdGhpcy5lbmQgPSBieXRlcyA8IHNpemUgPyBzZXNzaW9uLmxlbmd0aCA6IDAKICB9CgogIGFzeW5jIF9zZWVrKGJ5dGVzKSB7CiAgICBpZiAoIWJ5dGVzKSByZXR1cm4gWzAsIDBdCgogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuc2Vzc2lvbi5yb290cykgewogICAgICAvLyBhbGwgYXN5bmMgdGlja3MgaGFwcGVuIG9uY2Ugd2UgZmluZCB0aGUgcm9vdCBzbyBzYWZlCiAgICAgIGNvbnN0IHNpemUgPSBnZXRVbnBhZGRlZFNpemUobm9kZSwgdGhpcy5wYWRkaW5nLCBudWxsKQoKICAgICAgaWYgKGJ5dGVzID09PSBzaXplKSByZXR1cm4gW2ZsYXQucmlnaHRTcGFuKG5vZGUuaW5kZXgpICsgMiwgMF0KICAgICAgaWYgKGJ5dGVzID4gc2l6ZSkgewogICAgICAgIGJ5dGVzIC09IHNpemUKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUuaW5kZXgpCgogICAgICB3aGlsZSAoKGl0ZS5pbmRleCAmIDEpICE9PSAwKSB7CiAgICAgICAgY29uc3QgbCA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2UodGhpcy5zZXNzaW9uLnN0b3JhZ2UsIGl0ZS5sZWZ0Q2hpbGQoKSkKCiAgICAgICAgaWYgKGwpIHsKICAgICAgICAgIGNvbnN0IHNpemUgPSBnZXRVbnBhZGRlZFNpemUobCwgdGhpcy5wYWRkaW5nLCBpdGUpCgogICAgICAgICAgaWYgKHNpemUgPT09IGJ5dGVzKSByZXR1cm4gW2l0ZS5yaWdodFNwYW4oKSArIDIsIDBdCiAgICAgICAgICBpZiAoc2l6ZSA+IGJ5dGVzKSBjb250aW51ZQogICAgICAgICAgYnl0ZXMgLT0gc2l6ZQogICAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGUucGFyZW50KCkKICAgICAgICAgIHJldHVybiBbaXRlLmluZGV4LCBieXRlc10KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBbaXRlLmluZGV4LCBieXRlc10KICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgYXN5bmMgdXBkYXRlKCkgewogICAgLy8gVE9ETzogY29tYmluZSBfc2VlayBhbmQgdGhpcywgbXVjaCBzaW1wbGVyCiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLl9zZWVrKHRoaXMuYnl0ZXMpCiAgICBpZiAoIXJlcykgcmV0dXJuIG51bGwKICAgIGlmICgocmVzWzBdICYgMSkgPT09IDApIHJldHVybiBbcmVzWzBdIC8gMiwgcmVzWzFdXQoKICAgIGNvbnN0IHNwYW4gPSBmbGF0LnNwYW5zKHJlc1swXSkKICAgIHRoaXMuc3RhcnQgPSBzcGFuWzBdIC8gMgogICAgdGhpcy5lbmQgPSBzcGFuWzFdIC8gMiArIDEKCiAgICByZXR1cm4gbnVsbAogIH0KfQoKY2xhc3MgVHJlZVByb29mIHsKICBjb25zdHJ1Y3RvcihzZXNzaW9uLCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkgewogICAgdGhpcy5mb3JrID0gc2Vzc2lvbi5mb3JrCiAgICB0aGlzLnNpZ25hdHVyZSA9IHNlc3Npb24uc2lnbmF0dXJlCgogICAgdGhpcy5ibG9jayA9IGJsb2NrCiAgICB0aGlzLmhhc2ggPSBoYXNoCiAgICB0aGlzLnNlZWsgPSBzZWVrCiAgICB0aGlzLnVwZ3JhZGUgPSB1cGdyYWRlCgogICAgdGhpcy5wZW5kaW5nID0gewogICAgICBub2RlOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOiBudWxsLAogICAgICBhZGRpdGlvbmFsVXBncmFkZTogbnVsbAogICAgfQogIH0KCiAgYXN5bmMgc2V0dGxlKCkgewogICAgY29uc3QgcmVzdWx0ID0gewogICAgICBmb3JrOiB0aGlzLmZvcmssCiAgICAgIGJsb2NrOiBudWxsLAogICAgICBoYXNoOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOiBudWxsLAogICAgICBtYW5pZmVzdDogbnVsbAogICAgfQoKICAgIGNvbnN0IFtwTm9kZSwgcFNlZWssIHBVcGdyYWRlLCBwQWRkaXRpb25hbF0gPSBhd2FpdCBzZXR0bGVQcm9vZih0aGlzLnBlbmRpbmcpCgogICAgaWYgKHRoaXMuYmxvY2spIHsKICAgICAgaWYgKHBOb2RlID09PSBudWxsKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCBibG9jayByZXF1ZXN0JykKICAgICAgcmVzdWx0LmJsb2NrID0gewogICAgICAgIGluZGV4OiB0aGlzLmJsb2NrLmluZGV4LAogICAgICAgIHZhbHVlOiBudWxsLCAvLyBwb3B1bGF0ZWQgdXBzdHJlYW0sIGFsbG9jIGl0IGhlcmUgZm9yIHNpbXBsaWNpdHkKICAgICAgICBub2RlczogcE5vZGUKICAgICAgfQogICAgfSBlbHNlIGlmICh0aGlzLmhhc2gpIHsKICAgICAgaWYgKHBOb2RlID09PSBudWxsKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCBibG9jayByZXF1ZXN0JykKICAgICAgcmVzdWx0Lmhhc2ggPSB7CiAgICAgICAgaW5kZXg6IHRoaXMuaGFzaC5pbmRleCwKICAgICAgICBub2RlczogcE5vZGUKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLnNlZWsgJiYgcFNlZWsgIT09IG51bGwpIHsKICAgICAgcmVzdWx0LnNlZWsgPSB7CiAgICAgICAgYnl0ZXM6IHRoaXMuc2Vlay5ieXRlcywKICAgICAgICBub2RlczogcFNlZWsKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLnVwZ3JhZGUpIHsKICAgICAgcmVzdWx0LnVwZ3JhZGUgPSB7CiAgICAgICAgc3RhcnQ6IHRoaXMudXBncmFkZS5zdGFydCwKICAgICAgICBsZW5ndGg6IHRoaXMudXBncmFkZS5sZW5ndGgsCiAgICAgICAgbm9kZXM6IHBVcGdyYWRlLAogICAgICAgIGFkZGl0aW9uYWxOb2RlczogcEFkZGl0aW9uYWwgfHwgW10sCiAgICAgICAgc2lnbmF0dXJlOiB0aGlzLnNpZ25hdHVyZQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdAogIH0KfQoKY2xhc3MgTWVya2xlVHJlZSB7CiAgc3RhdGljIGhhc2gocykgewogICAgcmV0dXJuIHVuc2xhYihjcnlwdG8udHJlZShzLnJvb3RzKSkKICB9CgogIHN0YXRpYyBzaWduYWJsZShzLCBuYW1lc3BhY2UpIHsKICAgIHJldHVybiBjYXBzLnRyZWVTaWduYWJsZShuYW1lc3BhY2UsIE1lcmtsZVRyZWUuaGFzaChzKSwgcy5sZW5ndGgsIHMuZm9yaykKICB9CgogIHN0YXRpYyBzaXplKHJvb3RzKSB7CiAgICByZXR1cm4gdG90YWxTaXplKHJvb3RzKQogIH0KCiAgc3RhdGljIHNwYW4ocm9vdHMpIHsKICAgIHJldHVybiB0b3RhbFNwYW4ocm9vdHMpCiAgfQoKICBzdGF0aWMgZ2V0Um9vdHMoc2Vzc2lvbiwgbGVuZ3RoKSB7CiAgICByZXR1cm4gTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHNlc3Npb24uc3RvcmFnZSwgbGVuZ3RoKQogIH0KCiAgc3RhdGljIGdldFJvb3RzRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgbGVuZ3RoKSB7CiAgICBjb25zdCBpbmRleGVzID0gZmxhdC5mdWxsUm9vdHMoMiAqIGxlbmd0aCkKICAgIGNvbnN0IHJvb3RzID0gbmV3IEFycmF5KGluZGV4ZXMubGVuZ3RoKQogICAgY29uc3QgcnggPSBzdG9yYWdlLnJlYWQoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkrKykgewogICAgICByb290c1tpXSA9IGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaW5kZXhlc1tpXSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgcmV0dXJuIFByb21pc2UuYWxsKHJvb3RzKQogIH0KCiAgc3RhdGljIGFzeW5jIHVwZ3JhZGVhYmxlKHNlc3Npb24sIGxlbmd0aCkgewogICAgY29uc3QgaW5kZXhlcyA9IGZsYXQuZnVsbFJvb3RzKDIgKiBsZW5ndGgpCiAgICBjb25zdCByb290cyA9IG5ldyBBcnJheShpbmRleGVzLmxlbmd0aCkKICAgIGNvbnN0IHJ4ID0gc2Vzc2lvbi5zdG9yYWdlLnJlYWQoKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkrKykgewogICAgICByb290c1tpXSA9IHJ4LmdldFRyZWVOb2RlKGluZGV4ZXNbaV0pCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBhd2FpdCBQcm9taXNlLmFsbChyb290cykpIHsKICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHJldHVybiBmYWxzZQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBzdGF0aWMgc2VlayhzZXNzaW9uLCBieXRlcywgcGFkZGluZykgewogICAgcmV0dXJuIG5ldyBCeXRlU2Vla2VyKHNlc3Npb24sIGJ5dGVzLCBwYWRkaW5nKQogIH0KCiAgc3RhdGljIGdldChzZXNzaW9uLCBpbmRleCkgewogICAgcmV0dXJuIGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCBpbmRleCkKICB9CgogIHN0YXRpYyBhc3luYyB0cnVuY2F0ZShzZXNzaW9uLCBsZW5ndGgsIGJhdGNoLCBmb3JrID0gYmF0Y2guZm9yaykgewogICAgY29uc3QgaGVhZCA9IGxlbmd0aCAqIDIKICAgIGNvbnN0IGZ1bGxSb290cyA9IGZsYXQuZnVsbFJvb3RzKGhlYWQpCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmdWxsUm9vdHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgcm9vdCA9IGZ1bGxSb290c1tpXQogICAgICBpZiAoaSA8IGJhdGNoLnJvb3RzLmxlbmd0aCAmJiBiYXRjaC5yb290c1tpXS5pbmRleCA9PT0gcm9vdCkgY29udGludWUKCiAgICAgIHdoaWxlIChiYXRjaC5yb290cy5sZW5ndGggPiBpKSBiYXRjaC5yb290cy5wb3AoKQogICAgICBiYXRjaC5yb290cy5wdXNoKHVuc2xhYk5vZGUoYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc2Vzc2lvbi5zdG9yYWdlLCByb290KSkpCiAgICB9CgogICAgd2hpbGUgKGJhdGNoLnJvb3RzLmxlbmd0aCA+IGZ1bGxSb290cy5sZW5ndGgpIHsKICAgICAgYmF0Y2gucm9vdHMucG9wKCkKICAgIH0KCiAgICBiYXRjaC5mb3JrID0gZm9yawogICAgYmF0Y2gubGVuZ3RoID0gbGVuZ3RoCiAgICBiYXRjaC5hbmNlc3RvcnMgPSBsZW5ndGgKICAgIGJhdGNoLmJ5dGVMZW5ndGggPSB0b3RhbFNpemUoYmF0Y2gucm9vdHMpCiAgICBiYXRjaC51cGdyYWRlZCA9IHRydWUKCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIHN0YXRpYyBhc3luYyByZW9yZyhzZXNzaW9uLCBwcm9vZiwgYmF0Y2gpIHsKICAgIGxldCB1bnZlcmlmaWVkID0gbnVsbAoKICAgIGlmIChwcm9vZi5ibG9jayB8fCBwcm9vZi5oYXNoIHx8IHByb29mLnNlZWspIHsKICAgICAgdW52ZXJpZmllZCA9IHZlcmlmeVRyZWUocHJvb2YsIGJhdGNoLm5vZGVzKQogICAgfQoKICAgIGlmICghdmVyaWZ5VXBncmFkZShwcm9vZiwgdW52ZXJpZmllZCwgYmF0Y2gpKSB7CiAgICAgIHRocm93IElOVkFMSURfUFJPT0YoJ0ZvcmsgcHJvb2Ygbm90IHZlcmlmaWFibGUnKQogICAgfQoKICAgIGZvciAoY29uc3Qgcm9vdCBvZiBiYXRjaC5yb290cykgewogICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCByb290LmluZGV4KQogICAgICBpZiAoZXhpc3RpbmcgJiYgYjRhLmVxdWFscyhleGlzdGluZy5oYXNoLCByb290Lmhhc2gpKSBjb250aW51ZQogICAgICBiYXRjaC5fdXBkYXRlRGlmZlJvb3Qocm9vdCkKICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAoYmF0Y2guZGlmZiAhPT0gbnVsbCkgewogICAgICBhd2FpdCBiYXRjaC5fdXBkYXRlKGJhdGNoLm5vZGVzKQogICAgfSBlbHNlIHsKICAgICAgYmF0Y2gud2FudCA9IG51bGwKICAgICAgYmF0Y2guYW5jZXN0b3JzID0gYmF0Y2gubGVuZ3RoCiAgICB9CgogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBzdGF0aWMgdmVyaWZ5RnVsbHlSZW1vdGUoc2Vzc2lvbiwgcHJvb2YpIHsKICAgIC8vIFRPRE86IGltcGwgdGhpcyBsZXNzIGhhY2tpc2hseQogICAgY29uc3QgYmF0Y2ggPSBuZXcgTWVya2xlVHJlZUJhdGNoKHNlc3Npb24pCgogICAgYmF0Y2guZm9yayA9IHByb29mLmZvcmsKICAgIGJhdGNoLnJvb3RzID0gW10KICAgIGJhdGNoLmxlbmd0aCA9IDAKICAgIGJhdGNoLmFuY2VzdG9ycyA9IDAKICAgIGJhdGNoLmJ5dGVMZW5ndGggPSAwCgogICAgbGV0IHVudmVyaWZpZWQgPSB2ZXJpZnlUcmVlKHByb29mLCBiYXRjaC5ub2RlcykKCiAgICBpZiAocHJvb2YudXBncmFkZSkgewogICAgICBpZiAodmVyaWZ5VXBncmFkZShwcm9vZiwgdW52ZXJpZmllZCwgYmF0Y2gpKSB7CiAgICAgICAgdW52ZXJpZmllZCA9IG51bGwKICAgICAgfQogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KCiAgc3RhdGljIGFzeW5jIHZlcmlmeShzZXNzaW9uLCBwcm9vZikgewogICAgY29uc3QgYmF0Y2ggPSBuZXcgTWVya2xlVHJlZUJhdGNoKHNlc3Npb24pCgogICAgbGV0IHVudmVyaWZpZWQgPSB2ZXJpZnlUcmVlKHByb29mLCBiYXRjaC5ub2RlcykKCiAgICBpZiAocHJvb2YudXBncmFkZSkgewogICAgICBpZiAodmVyaWZ5VXBncmFkZShwcm9vZiwgdW52ZXJpZmllZCwgYmF0Y2gpKSB7CiAgICAgICAgdW52ZXJpZmllZCA9IG51bGwKICAgICAgfQogICAgfQoKICAgIGlmICh1bnZlcmlmaWVkKSB7CiAgICAgIGNvbnN0IHZlcmlmaWVkID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc2Vzc2lvbi5zdG9yYWdlLCB1bnZlcmlmaWVkLmluZGV4KQogICAgICBpZiAoIWI0YS5lcXVhbHModmVyaWZpZWQuaGFzaCwgdW52ZXJpZmllZC5oYXNoKSkgewogICAgICAgIHRocm93IElOVkFMSURfQ0hFQ0tTVU0oJ0ludmFsaWQgY2hlY2tzdW0gYXQgbm9kZSAnICsgdW52ZXJpZmllZC5pbmRleCkKICAgICAgfQogICAgfQoKICAgIHJldHVybiBiYXRjaAogIH0KCiAgc3RhdGljIHByb29mKHNlc3Npb24sIHJ4LCB7IGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlIH0pIHsKICAgIHJldHVybiBnZW5lcmF0ZVByb29mKHNlc3Npb24sIHJ4LCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkKICB9CgogIHN0YXRpYyBtYXhNaXNzaW5nTm9kZXMoaW5kZXgsIGxlbmd0aCkgewogICAgY29uc3QgaGVhZCA9IDIgKiBsZW5ndGgKICAgIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaW5kZXgpCgogICAgLy8gU2VlIGl0ZXJhdG9yLnJpZ2h0U3BhbigpCiAgICBjb25zdCBpdGVSaWdodFNwYW4gPSBpdGUuaW5kZXggKyBpdGUuZmFjdG9yIC8gMiAtIDEKICAgIC8vIElmIHRoZSBpbmRleCBpcyBub3QgaW4gdGhlIGN1cnJlbnQgdHJlZSwgd2UgZG8gbm90IGtub3cgaG93IG1hbnkgbWlzc2luZyBub2RlcyB0aGVyZSBhcmUuLi4KICAgIGlmIChpdGVSaWdodFNwYW4gPj0gaGVhZCkgcmV0dXJuIDAKCiAgICBmb3IgKGNvbnN0IHIgb2YgZmxhdC5mdWxsUm9vdHMoaGVhZCkpIHsKICAgICAgaWYgKHIgPT09IGluZGV4KSByZXR1cm4gMAogICAgfQoKICAgIGxldCBjbnQgPSAwCiAgICB3aGlsZSAoIWl0ZS5jb250YWlucyhoZWFkKSkgewogICAgICBjbnQrKwogICAgICBpdGUucGFyZW50KCkKICAgIH0KCiAgICByZXR1cm4gY250CiAgfQoKICBzdGF0aWMgYXN5bmMgbWlzc2luZ05vZGVzKHNlc3Npb24sIGluZGV4LCBsZW5ndGgpIHsKICAgIGNvbnN0IGhlYWQgPSAyICogbGVuZ3RoCiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKGluZGV4KQoKICAgIC8vIFNlZSBpdGVyYXRvci5yaWdodFNwYW4oKQogICAgY29uc3QgaXRlUmlnaHRTcGFuID0gaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgLSAxCiAgICAvLyBJZiB0aGUgaW5kZXggaXMgbm90IGluIHRoZSBjdXJyZW50IHRyZWUsIHdlIGRvIG5vdCBrbm93IGhvdyBtYW55IG1pc3Npbmcgbm9kZXMgdGhlcmUgYXJlLi4uCiAgICBpZiAoaXRlUmlnaHRTcGFuID49IGhlYWQpIHJldHVybiAwCgogICAgbGV0IGNudCA9IDAKICAgIC8vIFRPRE86IHdlIGNvdWxkIHByb3AgdXNlIGEgcmVhZCBiYXRjaCBoZXJlIGFuZCBkbyB0aGlzIGluIGJsb2NrcyBvZiBYIGZvciBwZXJmCiAgICB3aGlsZSAoIWl0ZS5jb250YWlucyhoZWFkKSAmJiAhKGF3YWl0IGhhc1RyZWVOb2RlKHNlc3Npb24uc3RvcmFnZSwgaXRlLmluZGV4KSkpIHsKICAgICAgY250KysKICAgICAgaWYgKGNudCA+PSAxMDI0KSB7CiAgICAgICAgdGhyb3cgQVNTRVJUSU9OKCdCYWQgYXJndW1lbnRzIHRvIG1pc3NpbmdOb2RlcyBpbmRleD0nICsgaW5kZXggKyAnIGF0IGxlbmd0aD0nICsgbGVuZ3RoKQogICAgICB9CiAgICAgIGl0ZS5wYXJlbnQoKQogICAgfQoKICAgIHJldHVybiBjbnQKICB9CgogIHN0YXRpYyBieXRlT2Zmc2V0KHNlc3Npb24sIGluZGV4KSB7CiAgICByZXR1cm4gZ2V0Qnl0ZU9mZnNldFNlc3Npb24oc2Vzc2lvbiwgaW5kZXgsIG51bGwpCiAgfQoKICBzdGF0aWMgYnl0ZVJhbmdlKHNlc3Npb24sIGluZGV4KSB7CiAgICBjb25zdCByeCA9IHNlc3Npb24uc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IG9mZnNldCA9IGdldEJ5dGVPZmZzZXRTZXNzaW9uKHNlc3Npb24sIGluZGV4LCByeCkKICAgIGNvbnN0IHNpemUgPSBnZXROb2RlU2l6ZShpbmRleCwgcngpCiAgICByeC50cnlGbHVzaCgpCiAgICByZXR1cm4gUHJvbWlzZS5hbGwoW29mZnNldCwgc2l6ZV0pCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBNZXJrbGVUcmVlQmF0Y2gsCiAgUmVvcmdCYXRjaCwKICBNZXJrbGVUcmVlCn0KCmFzeW5jIGZ1bmN0aW9uIGdldE5vZGVTaXplKGluZGV4LCByeCkgewogIHJldHVybiAoYXdhaXQgZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpbmRleCkpLnNpemUKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldFNlc3Npb24oc2Vzc2lvbiwgaW5kZXgsIHJ4KSB7CiAgaWYgKGluZGV4ID09PSAyICogc2Vzc2lvbi5sZW5ndGgpIHJldHVybiBzZXNzaW9uLmJ5dGVMZW5ndGgKCiAgY29uc3QgdHJlZU5vZGVzID0KICAgIHJ4ID09PSBudWxsCiAgICAgID8gYXdhaXQgZ2V0Qnl0ZU9mZnNldEJhdGNoRmx1c2goc2Vzc2lvbi5yb290cywgaW5kZXgsIHNlc3Npb24uc3RvcmFnZS5yZWFkKCkpCiAgICAgIDogYXdhaXQgZ2V0Qnl0ZU9mZnNldEJhdGNoKHNlc3Npb24ucm9vdHMsIGluZGV4LCByeCkKCiAgbGV0IG9mZnNldCA9IDAKICBmb3IgKGNvbnN0IG5vZGUgb2YgdHJlZU5vZGVzKSBvZmZzZXQgKz0gbm9kZS5zaXplCgogIHJldHVybiBvZmZzZXQKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldCh0cmVlLCBpbmRleCwgcngpIHsKICBpZiAoaW5kZXggPT09IDIgKiB0cmVlLmxlbmd0aCkgcmV0dXJuIHRyZWUuYnl0ZUxlbmd0aAoKICBjb25zdCB0cmVlTm9kZXMgPSBhd2FpdCBnZXRCeXRlT2Zmc2V0QmF0Y2godHJlZS5yb290cywgaW5kZXgsIHJ4KQoKICBsZXQgb2Zmc2V0ID0gMAogIGZvciAoY29uc3Qgbm9kZSBvZiB0cmVlTm9kZXMpIG9mZnNldCArPSBub2RlLnNpemUKCiAgcmV0dXJuIG9mZnNldAp9CgpmdW5jdGlvbiBnZXRCeXRlT2Zmc2V0QmF0Y2hGbHVzaChyb290cywgaW5kZXgsIHJ4KSB7CiAgY29uc3QgdHJlZU5vZGVzID0gZ2V0Qnl0ZU9mZnNldEJhdGNoKHJvb3RzLCBpbmRleCwgcngpCiAgcngudHJ5Rmx1c2goKQogIHJldHVybiB0cmVlTm9kZXMKfQoKZnVuY3Rpb24gZ2V0Qnl0ZU9mZnNldEJhdGNoKHJvb3RzLCBpbmRleCwgcngpIHsKICBpZiAoKGluZGV4ICYgMSkgPT09IDEpIGluZGV4ID0gZmxhdC5sZWZ0U3BhbihpbmRleCkKCiAgbGV0IGhlYWQgPSAwCiAgbGV0IGNudCA9IDAKCiAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsKICAgIC8vIGFsbCBhc3luYyB0aWNrcyBoYXBwZW4gb25jZSB3ZSBmaW5kIHRoZSByb290IHNvIHNhZmUKICAgIGhlYWQgKz0gMiAqIChub2RlLmluZGV4IC0gaGVhZCArIDEpCgogICAgaWYgKGluZGV4ID49IGhlYWQpIHsKICAgICAgcHJvbWlzZXMucHVzaChub2RlLnNpemUpCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihub2RlLmluZGV4KQoKICAgIHdoaWxlIChpdGUuaW5kZXggIT09IGluZGV4KSB7CiAgICAgIGlmICgrK2NudCA+PSAxMDI0KSB0aHJvdyBBU1NFUlRJT04oJ0JhZCBnZXRCeXRlT2Zmc2V0U2Vzc2lvbiBpbmRleD0nICsgaW5kZXgpCgogICAgICBpZiAoaW5kZXggPCBpdGUuaW5kZXgpIHsKICAgICAgICBpdGUubGVmdENoaWxkKCkKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9taXNlcy5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmxlZnRDaGlsZCgpKSkKICAgICAgICBpdGUuc2libGluZygpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpCiAgfQoKICB0aHJvdyBBU1NFUlRJT04oJ0ZhaWxlZCB0byBmaW5kIG9mZnNldCcpCn0KCmZ1bmN0aW9uIGdldEJ5dGVSYW5nZSh0cmVlLCBpbmRleCwgcngpIHsKICBjb25zdCBoZWFkID0gMiAqIHRyZWUubGVuZ3RoCiAgaWYgKCgoaW5kZXggJiAxKSA9PT0gMCA/IGluZGV4IDogZmxhdC5yaWdodFNwYW4oaW5kZXgpKSA+PSBoZWFkKSB7CiAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0luZGV4IGlzIG91dCBvZiBib3VuZHMnKQogIH0KCiAgY29uc3Qgb2Zmc2V0ID0gZ2V0Qnl0ZU9mZnNldCh0cmVlLCBpbmRleCwgcngpCiAgY29uc3Qgc2l6ZSA9IGdldE5vZGVTaXplKGluZGV4LCByeCkKCiAgcmV0dXJuIFByb21pc2UuYWxsKFtvZmZzZXQsIHNpemVdKQp9CgovLyBBbGwgdGhlIG1ldGhvZHMgbmVlZGVkIGZvciBwcm9vZiB2ZXJpZmljYXRpb24KCmZ1bmN0aW9uIHZlcmlmeVRyZWUoeyBibG9jaywgaGFzaCwgc2VlayB9LCBub2RlcykgewogIGNvbnN0IHVudHJ1c3RlZE5vZGUgPSBibG9jawogICAgPyB7IGluZGV4OiAyICogYmxvY2suaW5kZXgsIHZhbHVlOiBibG9jay52YWx1ZSwgbm9kZXM6IGJsb2NrLm5vZGVzIH0KICAgIDogaGFzaAogICAgICA/IHsgaW5kZXg6IGhhc2guaW5kZXgsIHZhbHVlOiBudWxsLCBub2RlczogaGFzaC5ub2RlcyB9CiAgICAgIDogbnVsbAoKICBpZiAodW50cnVzdGVkTm9kZSA9PT0gbnVsbCAmJiAoIXNlZWsgfHwgIXNlZWsubm9kZXMubGVuZ3RoKSkgcmV0dXJuIG51bGwKCiAgbGV0IHJvb3QgPSBudWxsCgogIGlmIChzZWVrICYmIHNlZWsubm9kZXMubGVuZ3RoKSB7CiAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHNlZWsubm9kZXNbMF0uaW5kZXgpCiAgICBjb25zdCBxID0gbmV3IE5vZGVRdWV1ZShzZWVrLm5vZGVzKQoKICAgIHJvb3QgPSBxLnNoaWZ0KGl0ZS5pbmRleCkKICAgIG5vZGVzLnB1c2gocm9vdCkKCiAgICB3aGlsZSAocS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBxLnNoaWZ0KGl0ZS5zaWJsaW5nKCkpCgogICAgICByb290ID0gcGFyZW50Tm9kZShpdGUucGFyZW50KCksIHJvb3QsIG5vZGUpCiAgICAgIG5vZGVzLnB1c2gobm9kZSkKICAgICAgbm9kZXMucHVzaChyb290KQogICAgfQogIH0KCiAgaWYgKHVudHJ1c3RlZE5vZGUgPT09IG51bGwpIHJldHVybiByb290CgogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IodW50cnVzdGVkTm9kZS5pbmRleCkKICBjb25zdCBibG9ja0hhc2ggPSB1bnRydXN0ZWROb2RlLnZhbHVlICYmIGJsb2NrTm9kZShpdGUuaW5kZXgsIHVudHJ1c3RlZE5vZGUudmFsdWUpCgogIGNvbnN0IHEgPSBuZXcgTm9kZVF1ZXVlKHVudHJ1c3RlZE5vZGUubm9kZXMsIHJvb3QpCgogIHJvb3QgPSBibG9ja0hhc2ggfHwgcS5zaGlmdChpdGUuaW5kZXgpCiAgbm9kZXMucHVzaChyb290KQoKICB3aGlsZSAocS5sZW5ndGggPiAwKSB7CiAgICBjb25zdCBub2RlID0gcS5zaGlmdChpdGUuc2libGluZygpKQoKICAgIHJvb3QgPSBwYXJlbnROb2RlKGl0ZS5wYXJlbnQoKSwgcm9vdCwgbm9kZSkKICAgIG5vZGVzLnB1c2gobm9kZSkKICAgIG5vZGVzLnB1c2gocm9vdCkKICB9CgogIHJldHVybiByb290Cn0KCmZ1bmN0aW9uIHZlcmlmeVVwZ3JhZGUoeyBmb3JrLCB1cGdyYWRlIH0sIGJsb2NrUm9vdCwgYmF0Y2gpIHsKICBjb25zdCBwcm9sb2d1ZSA9IGJhdGNoLnByb2xvZ3VlCgogIGlmIChwcm9sb2d1ZSkgewogICAgY29uc3QgeyBzdGFydCwgbGVuZ3RoIH0gPSB1cGdyYWRlCiAgICBpZiAoc3RhcnQgPCBwcm9sb2d1ZS5sZW5ndGggJiYgKHN0YXJ0ICE9PSAwIHx8IGxlbmd0aCA8IHByb2xvZ3VlLmxlbmd0aCkpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9QUk9PRignVXBncmFkZSBkb2VzIG5vdCBzYXRpc2Z5IHByb2xvZ3VlJykKICAgIH0KICB9CgogIGNvbnN0IHEgPSBuZXcgTm9kZVF1ZXVlKHVwZ3JhZGUubm9kZXMsIGJsb2NrUm9vdCkKCiAgbGV0IGdyb3cgPSBiYXRjaC5yb290cy5sZW5ndGggPiAwCiAgbGV0IGkgPSAwCgogIGNvbnN0IHRvID0gMiAqICh1cGdyYWRlLnN0YXJ0ICsgdXBncmFkZS5sZW5ndGgpCiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcigwKQoKICBmb3IgKDsgaXRlLmZ1bGxSb290KHRvKTsgaXRlLm5leHRUcmVlKCkpIHsKICAgIGlmIChpIDwgYmF0Y2gucm9vdHMubGVuZ3RoICYmIGJhdGNoLnJvb3RzW2ldLmluZGV4ID09PSBpdGUuaW5kZXgpIHsKICAgICAgaSsrCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgaWYgKGdyb3cpIHsKICAgICAgZ3JvdyA9IGZhbHNlCiAgICAgIGNvbnN0IHJvb3QgPSBpdGUuaW5kZXgKICAgICAgaWYgKGkgPCBiYXRjaC5yb290cy5sZW5ndGgpIHsKICAgICAgICBpdGUuc2VlayhiYXRjaC5yb290c1tiYXRjaC5yb290cy5sZW5ndGggLSAxXS5pbmRleCkKICAgICAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICAgICAgICBiYXRjaC5hcHBlbmRSb290KHEuc2hpZnQoaXRlLnNpYmxpbmcoKSksIGl0ZSkKICAgICAgICB9CiAgICAgICAgY29udGludWUKICAgICAgfQogICAgfQoKICAgIGJhdGNoLmFwcGVuZFJvb3QocS5zaGlmdChpdGUuaW5kZXgpLCBpdGUpCiAgfQoKICBpZiAocHJvbG9ndWUgJiYgYmF0Y2gubGVuZ3RoID09PSBwcm9sb2d1ZS5sZW5ndGgpIHsKICAgIGlmICghYjRhLmVxdWFscyhwcm9sb2d1ZS5oYXNoLCBiYXRjaC5oYXNoKCkpKSB7CiAgICAgIHRocm93IElOVkFMSURfUFJPT0YoJ0ludmFsaWQgaGFzaCcpCiAgICB9CiAgfQoKICBjb25zdCBleHRyYSA9IHVwZ3JhZGUuYWRkaXRpb25hbE5vZGVzCgogIGl0ZS5zZWVrKGJhdGNoLnJvb3RzW2JhdGNoLnJvb3RzLmxlbmd0aCAtIDFdLmluZGV4KQogIGkgPSAwCgogIHdoaWxlIChpIDwgZXh0cmEubGVuZ3RoICYmIGV4dHJhW2ldLmluZGV4ID09PSBpdGUuc2libGluZygpKSB7CiAgICBiYXRjaC5hcHBlbmRSb290KGV4dHJhW2krK10sIGl0ZSkKICB9CgogIHdoaWxlIChpIDwgZXh0cmEubGVuZ3RoKSB7CiAgICBjb25zdCBub2RlID0gZXh0cmFbaSsrXQoKICAgIHdoaWxlIChub2RlLmluZGV4ICE9PSBpdGUuaW5kZXgpIHsKICAgICAgaWYgKGl0ZS5mYWN0b3IgPT09IDIpIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdVbmV4cGVjdGVkIG5vZGU6ICcgKyBub2RlLmluZGV4KQogICAgICBpdGUubGVmdENoaWxkKCkKICAgIH0KCiAgICBiYXRjaC5hcHBlbmRSb290KG5vZGUsIGl0ZSkKICAgIGl0ZS5zaWJsaW5nKCkKICB9CgogIGJhdGNoLnNpZ25hdHVyZSA9IHVuc2xhYih1cGdyYWRlLnNpZ25hdHVyZSkKICBiYXRjaC5mb3JrID0gZm9yawoKICByZXR1cm4gcS5leHRyYSA9PT0gbnVsbAp9Cgphc3luYyBmdW5jdGlvbiBzZWVrRnJvbUhlYWQoc2Vzc2lvbiwgaGVhZCwgYnl0ZXMsIHBhZGRpbmcpIHsKICBjb25zdCByb290cyA9IGZsYXQuZnVsbFJvb3RzKGhlYWQpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHJvb3QgPSByb290c1tpXQogICAgY29uc3Qgbm9kZSA9IGF3YWl0IGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc2Vzc2lvbi5zdG9yYWdlLCByb290KQogICAgY29uc3Qgc2l6ZSA9IGdldFVucGFkZGVkU2l6ZShub2RlLCBwYWRkaW5nLCBudWxsKQoKICAgIGlmIChieXRlcyA9PT0gc2l6ZSkgcmV0dXJuIHJvb3QKICAgIGlmIChieXRlcyA+IHNpemUpIHsKICAgICAgYnl0ZXMgLT0gc2l6ZQogICAgICBjb250aW51ZQogICAgfQoKICAgIHJldHVybiBzZWVrVHJ1c3RlZFRyZWUoc2Vzc2lvbiwgcm9vdCwgYnl0ZXMsIHBhZGRpbmcpCiAgfQoKICByZXR1cm4gaGVhZAp9CgovLyB0cnVzdCB0aGF0IGJ5dGVzIGFyZSB3aXRoaW4gdGhlIHJvb3QgdHJlZSBhbmQgZmluZCB0aGUgYmxvY2sgYXQgYnl0ZXMKCmFzeW5jIGZ1bmN0aW9uIHNlZWtUcnVzdGVkVHJlZShzZXNzaW9uLCByb290LCBieXRlcywgcGFkZGluZykgewogIGlmICghYnl0ZXMpIHJldHVybiByb290CgogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3Iocm9vdCkKICBsZXQgY250ID0gMAoKICB3aGlsZSAoKGl0ZS5pbmRleCAmIDEpICE9PSAwKSB7CiAgICBpZiAoKytjbnQgPj0gMTAyNCkgdGhyb3cgQVNTRVJUSU9OKCdCYWQgc2Vla1RydXN0ZWQgYnl0ZXM9JyArIGJ5dGVzICsgJywgcGFkZGRpbmc9JyArIHBhZGRpbmcpCiAgICBjb25zdCBsID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZShzZXNzaW9uLnN0b3JhZ2UsIGl0ZS5sZWZ0Q2hpbGQoKSkKCiAgICBpZiAobCkgewogICAgICBjb25zdCBzaXplID0gZ2V0VW5wYWRkZWRTaXplKGwsIHBhZGRpbmcsIGl0ZSkKICAgICAgaWYgKHNpemUgPT09IGJ5dGVzKSByZXR1cm4gaXRlLmluZGV4CiAgICAgIGlmIChzaXplID4gYnl0ZXMpIGNvbnRpbnVlCiAgICAgIGJ5dGVzIC09IHNpemUKICAgICAgaXRlLnNpYmxpbmcoKQogICAgfSBlbHNlIHsKICAgICAgaXRlLnBhcmVudCgpCiAgICAgIHJldHVybiBpdGUuaW5kZXgKICAgIH0KICB9CgogIHJldHVybiBpdGUuaW5kZXgKfQoKLy8gdHJ5IHRvIGZpbmQgdGhlIGJsb2NrIGF0IGJ5dGVzIHdpdGhvdXQgdHJ1c3RpbmcgdGhhdCBpcyAqaXMqIHdpdGhpbiB0aGUgcm9vdCBwYXNzZWQKCmFzeW5jIGZ1bmN0aW9uIHNlZWtVbnRydXN0ZWRUcmVlKHNlc3Npb24sIHJvb3QsIGJ5dGVzLCBwYWRkaW5nKSB7CiAgY29uc3Qgb2Zmc2V0ID0KICAgIChhd2FpdCBnZXRCeXRlT2Zmc2V0U2Vzc2lvbihzZXNzaW9uLCByb290LCBudWxsKSkgLQogICAgKHBhZGRpbmcgPyAocGFkZGluZyAqIGZsYXQubGVmdFNwYW4ocm9vdCkpIC8gMiA6IDApCgogIGlmIChvZmZzZXQgPiBieXRlcykgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0ludmFsaWQgc2VlaycpCiAgaWYgKG9mZnNldCA9PT0gYnl0ZXMpIHJldHVybiByb290CgogIGJ5dGVzIC09IG9mZnNldAoKICBjb25zdCBub2RlID0gYXdhaXQgZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc2Vzc2lvbi5zdG9yYWdlLCByb290KQoKICBpZiAoZ2V0VW5wYWRkZWRTaXplKG5vZGUsIHBhZGRpbmcsIG51bGwpIDw9IGJ5dGVzKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignSW52YWxpZCBzZWVrJykKCiAgcmV0dXJuIHNlZWtUcnVzdGVkVHJlZShzZXNzaW9uLCByb290LCBieXRlcywgcGFkZGluZykKfQoKLy8gQmVsb3cgaXMgcHJvb2YgcHJvZHVjdGlvbiwgaWUsIGNvbnN0cnVjdCBwcm9vZnMgdG8gdmVyaWZ5IGEgcmVxdWVzdAovLyBOb3RlLCB0aGF0IGFsbCB0aGVzZSBtZXRob2RzIGFyZSBzeW5jIGFzIHdlIGNhbiBzdGF0aWNhbGx5IGluZmVyIHdoaWNoIG5vZGVzCi8vIGFyZSBuZWVkZWQgZm9yIHRoZSByZW1vdGUgdG8gdmVyaWZ5IGdpdmVuIHRoZXkgYXJndW1lbnRzIHRoZXkgcGFzc2VkIHVzCgpmdW5jdGlvbiBzZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIHNlZWtSb290LCByb290LCBwKSB7CiAgY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcihzZWVrUm9vdCkKICBsZXQgY250ID0gMAoKICBwLnNlZWsgPSBbXQogIHAuc2Vlay5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKCiAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgaWYgKCsrY250ID49IDEwMjQpIHRocm93IEFTU0VSVElPTignQmFkIHNlZWtQcm9vZiBzZWVrUm9vdD0nICsgc2Vla1Jvb3QgKyAnLCByb290PScgKyByb290KQogICAgaXRlLnNpYmxpbmcoKQogICAgcC5zZWVrLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogICAgaXRlLnBhcmVudCgpCiAgfQp9CgpmdW5jdGlvbiBibG9ja0FuZFNlZWtQcm9vZihzZXNzaW9uLCByeCwgbm9kZSwgc2Vlaywgc2Vla1Jvb3QsIHJvb3QsIHApIHsKICBpZiAoIW5vZGUpIHJldHVybiBzZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIHNlZWtSb290LCByb290LCBwKQoKICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKG5vZGUuaW5kZXgpCiAgbGV0IGNudCA9IDAKCiAgcC5ub2RlID0gW10KICBpZiAoIW5vZGUudmFsdWUpIHAubm9kZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKCiAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgaWYgKCsrY250ID49IDEwMjQpIHsKICAgICAgdGhyb3cgQVNTRVJUSU9OKCdCYWQgYmxvY2tBbmRTZWVrUHJvb2Ygc2Vla1Jvb3Q9JyArIHNlZWtSb290ICsgJywgcm9vdD0nICsgcm9vdCkKICAgIH0KICAgIGl0ZS5zaWJsaW5nKCkKCiAgICBpZiAoc2VlayAmJiBpdGUuY29udGFpbnMoc2Vla1Jvb3QpICYmIGl0ZS5pbmRleCAhPT0gc2Vla1Jvb3QpIHsKICAgICAgc2Vla1Byb29mKHNlc3Npb24sIHJ4LCBzZWVrUm9vdCwgaXRlLmluZGV4LCBwKQogICAgfSBlbHNlIHsKICAgICAgcC5ub2RlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogICAgfQoKICAgIGl0ZS5wYXJlbnQoKQogIH0KfQoKZnVuY3Rpb24gdXBncmFkZVByb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBmcm9tLCB0bywgc3ViVHJlZSwgcCkgewogIGlmIChmcm9tID09PSAwKSBwLnVwZ3JhZGUgPSBbXQoKICBmb3IgKGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoMCk7IGl0ZS5mdWxsUm9vdCh0byk7IGl0ZS5uZXh0VHJlZSgpKSB7CiAgICAvLyBjaGVjayBpZiB0aGV5IGFscmVhZHkgaGF2ZSB0aGUgbm9kZQogICAgaWYgKGl0ZS5pbmRleCArIGl0ZS5mYWN0b3IgLyAyIDwgZnJvbSkgY29udGludWUKCiAgICAvLyBjb25uZWN0IGV4aXN0aW5nIHRyZWUKICAgIGlmIChwLnVwZ3JhZGUgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKGZyb20gLSAyKSkgewogICAgICBwLnVwZ3JhZGUgPSBbXQoKICAgICAgY29uc3Qgcm9vdCA9IGl0ZS5pbmRleAogICAgICBjb25zdCB0YXJnZXQgPSBmcm9tIC0gMgogICAgICBsZXQgY250ID0gMAoKICAgICAgaXRlLnNlZWsodGFyZ2V0KQoKICAgICAgd2hpbGUgKGl0ZS5pbmRleCAhPT0gcm9vdCkgewogICAgICAgIGlmICgrK2NudCA+PSAxMDI0KSB0aHJvdyBBU1NFUlRJT04oJ0JhZCB1cGdyYWRlUHJvb2YgdGFyZ2V0PScgKyB0YXJnZXQgKyAnLCByb290PScgKyByb290KQoKICAgICAgICBpdGUuc2libGluZygpCiAgICAgICAgaWYgKGl0ZS5pbmRleCA+IHRhcmdldCkgewogICAgICAgICAgaWYgKHAubm9kZSA9PT0gbnVsbCAmJiBwLnNlZWsgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKHN1YlRyZWUpKSB7CiAgICAgICAgICAgIGJsb2NrQW5kU2Vla1Byb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBzdWJUcmVlLCBpdGUuaW5kZXgsIHApCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwLnVwZ3JhZGUucHVzaChnZXRUcmVlTm9kZU9yRXJyb3IocngsIGl0ZS5pbmRleCkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGl0ZS5wYXJlbnQoKQogICAgICB9CgogICAgICBjb250aW51ZQogICAgfQoKICAgIGlmIChwLnVwZ3JhZGUgPT09IG51bGwpIHsKICAgICAgcC51cGdyYWRlID0gW10KICAgIH0KCiAgICAvLyBpZiB0aGUgc3VidHJlZSBpbmNsdWRlZCBpcyBhIGNoaWxkIG9mIHRoaXMgdHJlZSwgaW5jbHVkZSB0aGF0IG9uZQogICAgLy8gaW5zdGVhZCBvZiBhIGR1cCBub2RlCiAgICBpZiAocC5ub2RlID09PSBudWxsICYmIHAuc2VlayA9PT0gbnVsbCAmJiBpdGUuY29udGFpbnMoc3ViVHJlZSkpIHsKICAgICAgYmxvY2tBbmRTZWVrUHJvb2Yoc2Vzc2lvbiwgcngsIG5vZGUsIHNlZWssIHN1YlRyZWUsIGl0ZS5pbmRleCwgcCkKICAgICAgY29udGludWUKICAgIH0KCiAgICAvLyBhZGQgcm9vdCAoY2FuIGJlIG9wdGltaXNlZCBzaW5jZSB0aGUgcm9vdCBtaWdodCBiZSBpbiB0cmVlLnJvb3RzKQogICAgcC51cGdyYWRlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogIH0KfQoKZnVuY3Rpb24gYWRkaXRpb25hbFVwZ3JhZGVQcm9vZihzZXNzaW9uLCByeCwgZnJvbSwgdG8sIHApIHsKICBpZiAoZnJvbSA9PT0gMCkgcC5hZGRpdGlvbmFsVXBncmFkZSA9IFtdCgogIGZvciAoY29uc3QgaXRlID0gZmxhdC5pdGVyYXRvcigwKTsgaXRlLmZ1bGxSb290KHRvKTsgaXRlLm5leHRUcmVlKCkpIHsKICAgIC8vIGNoZWNrIGlmIHRoZXkgYWxyZWFkeSBoYXZlIHRoZSBub2RlCiAgICBpZiAoaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgPCBmcm9tKSBjb250aW51ZQoKICAgIC8vIGNvbm5lY3QgZXhpc3RpbmcgdHJlZQogICAgaWYgKHAuYWRkaXRpb25hbFVwZ3JhZGUgPT09IG51bGwgJiYgaXRlLmNvbnRhaW5zKGZyb20gLSAyKSkgewogICAgICBwLmFkZGl0aW9uYWxVcGdyYWRlID0gW10KCiAgICAgIGNvbnN0IHJvb3QgPSBpdGUuaW5kZXgKICAgICAgY29uc3QgdGFyZ2V0ID0gZnJvbSAtIDIKICAgICAgbGV0IGNudCA9IDAKCiAgICAgIGl0ZS5zZWVrKHRhcmdldCkKCiAgICAgIHdoaWxlIChpdGUuaW5kZXggIT09IHJvb3QpIHsKICAgICAgICBpZiAoKytjbnQgPj0gMTAyNCkgewogICAgICAgICAgdGhyb3cgQVNTRVJUSU9OKAogICAgICAgICAgICAnQmFkIGFyZ3VtZW50cyB0byBhZGRpdGlvbmFsVXBncmFkZVByb29mIHJvb3Q9JyArIHJvb3QgKyAnIHRhcmdldD0nICsgdGFyZ2V0CiAgICAgICAgICApCiAgICAgICAgfQogICAgICAgIGl0ZS5zaWJsaW5nKCkKICAgICAgICBpZiAoaXRlLmluZGV4ID4gdGFyZ2V0KSB7CiAgICAgICAgICBwLmFkZGl0aW9uYWxVcGdyYWRlLnB1c2goZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpdGUuaW5kZXgpKQogICAgICAgIH0KICAgICAgICBpdGUucGFyZW50KCkKICAgICAgfQoKICAgICAgY29udGludWUKICAgIH0KCiAgICBpZiAocC5hZGRpdGlvbmFsVXBncmFkZSA9PT0gbnVsbCkgewogICAgICBwLmFkZGl0aW9uYWxVcGdyYWRlID0gW10KICAgIH0KCiAgICAvLyBhZGQgcm9vdCAoY2FuIGJlIG9wdGltaXNlZCBzaW5jZSB0aGUgcm9vdCBpcyBpbiB0cmVlLnJvb3RzKQogICAgcC5hZGRpdGlvbmFsVXBncmFkZS5wdXNoKGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaXRlLmluZGV4KSkKICB9Cn0KCmZ1bmN0aW9uIG5vZGVzVG9Sb290KGluZGV4LCBub2RlcywgaGVhZCkgewogIGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoaW5kZXgpCgogIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXM7IGkrKykgewogICAgaXRlLnBhcmVudCgpCiAgICBpZiAoaXRlLmNvbnRhaW5zKGhlYWQpKSB0aHJvdyBJTlZBTElEX09QRVJBVElPTignTm9kZXMgaXMgb3V0IG9mIGJvdW5kcycpCiAgfQoKICByZXR1cm4gaXRlLmluZGV4Cn0KCmZ1bmN0aW9uIHRvdGFsU2l6ZShub2RlcykgewogIGxldCBzID0gMAogIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgcyArPSBub2RlLnNpemUKICByZXR1cm4gcwp9CgpmdW5jdGlvbiB0b3RhbFNwYW4obm9kZXMpIHsKICBsZXQgcyA9IDAKICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHMgKz0gMiAqIChub2RlLmluZGV4IC0gcyArIDEpCiAgcmV0dXJuIHMKfQoKZnVuY3Rpb24gYmxvY2tOb2RlKGluZGV4LCB2YWx1ZSkgewogIHJldHVybiB7IGluZGV4LCBzaXplOiB2YWx1ZS5ieXRlTGVuZ3RoLCBoYXNoOiBjcnlwdG8uZGF0YSh2YWx1ZSkgfQp9CgpmdW5jdGlvbiBwYXJlbnROb2RlKGluZGV4LCBhLCBiKSB7CiAgcmV0dXJuIHsgaW5kZXgsIHNpemU6IGEuc2l6ZSArIGIuc2l6ZSwgaGFzaDogY3J5cHRvLnBhcmVudChhLCBiKSB9Cn0KCmZ1bmN0aW9uIGxvZzIobikgewogIGxldCByZXMgPSAxCgogIHdoaWxlIChuID4gMikgewogICAgbiAvPSAyCiAgICByZXMrKwogIH0KCiAgcmV0dXJuIHJlcwp9CgpmdW5jdGlvbiBub3JtYWxpemVJbmRleGVkKGJsb2NrLCBoYXNoKSB7CiAgaWYgKGJsb2NrKSB7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogdHJ1ZSwKICAgICAgaW5kZXg6IGJsb2NrLmluZGV4ICogMiwKICAgICAgbm9kZXM6IGJsb2NrLm5vZGVzLAogICAgICBsYXN0SW5kZXg6IGJsb2NrLmluZGV4CiAgICB9CiAgfQogIGlmIChoYXNoKSB7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogZmFsc2UsCiAgICAgIGluZGV4OiBoYXNoLmluZGV4LAogICAgICBub2RlczogaGFzaC5ub2RlcywKICAgICAgbGFzdEluZGV4OiBmbGF0LnJpZ2h0U3BhbihoYXNoLmluZGV4KSAvIDIKICAgIH0KICB9CiAgcmV0dXJuIG51bGwKfQoKYXN5bmMgZnVuY3Rpb24gZ2V0VHJlZU5vZGVPckVycm9yKHJ4LCBpbmRleCkgewogIGNvbnN0IG5vZGUgPSBhd2FpdCByeC5nZXRUcmVlTm9kZShpbmRleCkKICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0V4cGVjdGVkIHRyZWUgbm9kZSAnICsgaW5kZXggKyAnIGZyb20gc3RvcmFnZSwgZ290IChuaWwpJykKICB9CiAgcmV0dXJuIG5vZGUKfQoKZnVuY3Rpb24gZ2V0VHJlZU5vZGVGcm9tU3RvcmFnZU9yRXJyb3Ioc3RvcmFnZSwgaW5kZXgpIHsKICBjb25zdCByeCA9IHN0b3JhZ2UucmVhZCgpCiAgY29uc3QgcCA9IGdldFRyZWVOb2RlT3JFcnJvcihyeCwgaW5kZXgpCiAgcngudHJ5Rmx1c2goKQogIHJldHVybiBwCn0KCmZ1bmN0aW9uIGdldFRyZWVOb2RlRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgaW5kZXgpIHsKICBjb25zdCByeCA9IHN0b3JhZ2UucmVhZCgpCiAgY29uc3Qgbm9kZSA9IHJ4LmdldFRyZWVOb2RlKGluZGV4KQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gbm9kZQp9CgpmdW5jdGlvbiBoYXNUcmVlTm9kZShzdG9yYWdlLCBpbmRleCkgewogIGNvbnN0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKICBjb25zdCBoYXMgPSByeC5oYXNUcmVlTm9kZShpbmRleCkKICByeC50cnlGbHVzaCgpCiAgcmV0dXJuIGhhcwp9Cgphc3luYyBmdW5jdGlvbiBzZXR0bGVQcm9vZihwKSB7CiAgY29uc3QgcmVzdWx0ID0gWwogICAgcC5ub2RlICYmIFByb21pc2UuYWxsKHAubm9kZSksCiAgICBwLnNlZWsgJiYgUHJvbWlzZS5hbGwocC5zZWVrKSwKICAgIHAudXBncmFkZSAmJiBQcm9taXNlLmFsbChwLnVwZ3JhZGUpLAogICAgcC5hZGRpdGlvbmFsVXBncmFkZSAmJiBQcm9taXNlLmFsbChwLmFkZGl0aW9uYWxVcGdyYWRlKQogIF0KCiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChyZXN1bHQpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBpZiAocC5ub2RlKSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocC5ub2RlKQogICAgaWYgKHAuc2VlaykgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHAuc2VlaykKICAgIGlmIChwLnVwZ3JhZGUpIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwLnVwZ3JhZGUpCiAgICBpZiAocC5hZGRpdGlvbmFsVXBncmFkZSkgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHAuYWRkaXRpb25hbFVwZ3JhZGUpCiAgICB0aHJvdyBlcnIKICB9Cn0KCi8vIHRyZWUgY2FuIGJlIGVpdGhlciB0aGUgbWVya2xlIHRyZWUgb3IgYSBtZXJrbGUgdHJlZSBiYXRjaAphc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVByb29mKHNlc3Npb24sIHJ4LCBibG9jaywgaGFzaCwgc2VlaywgdXBncmFkZSkgewogIC8vIEltcG9ydGFudCB0aGF0IHRoaXMgZG9lcyBub3QgdGhyb3cgaW5iZXR3ZWVuIG1ha2luZyB0aGUgcHJvbWlzZSBhcnJheXMKICAvLyBhbmQgZmluYWxpc2UgYmVpbmcgY2FsbGVkLCBvdGhlcndpc2UgdGhlcmUgd2lsbCBiZSBsaW5nZXJpbmcgcHJvbWlzZXMgaW4gdGhlIGJhY2tncm91bmQKCiAgaWYgKHNlc3Npb24ucHJvbG9ndWUgJiYgdXBncmFkZSkgewogICAgdXBncmFkZS5zdGFydCA9IHVwZ3JhZGUuc3RhcnQgPCBzZXNzaW9uLnByb2xvZ3VlLmxlbmd0aCA/IDAgOiB1cGdyYWRlLnN0YXJ0CiAgICB1cGdyYWRlLmxlbmd0aCA9CiAgICAgIHVwZ3JhZGUuc3RhcnQgPCBzZXNzaW9uLnByb2xvZ3VlLmxlbmd0aCA/IHNlc3Npb24ucHJvbG9ndWUubGVuZ3RoIDogdXBncmFkZS5sZW5ndGgKICB9CgogIGNvbnN0IGhlYWQgPSAyICogc2Vzc2lvbi5sZW5ndGgKICBjb25zdCBmcm9tID0gdXBncmFkZSA/IHVwZ3JhZGUuc3RhcnQgKiAyIDogMAogIGNvbnN0IHRvID0gdXBncmFkZSA/IGZyb20gKyB1cGdyYWRlLmxlbmd0aCAqIDIgOiBoZWFkCiAgY29uc3Qgbm9kZSA9IG5vcm1hbGl6ZUluZGV4ZWQoYmxvY2ssIGhhc2gpCgogIC8vIGNhbid0IGRvIGFueXRoaW5nIGFzIHdlIGhhdmUgbm8gZGF0YS4uLgogIGlmIChoZWFkID09PSAwKSByZXR1cm4gbmV3IFRyZWVQcm9vZihzZXNzaW9uLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQoKICBpZiAoZnJvbSA+PSB0byB8fCB0byA+IGhlYWQpIHsKICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdJbnZhbGlkIHVwZ3JhZGUnKQogIH0KICBpZiAoc2VlayAmJiB1cGdyYWRlICYmIG5vZGUgIT09IG51bGwgJiYgbm9kZS5pbmRleCA+PSBmcm9tKSB7CiAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignQ2Fubm90IGJvdGggZG8gYSBzZWVrIGFuZCBibG9jay9oYXNoIHJlcXVlc3Qgd2hlbiB1cGdyYWRpbmcnKQogIH0KCiAgbGV0IHN1YlRyZWUgPSBoZWFkCgogIGNvbnN0IHAgPSBuZXcgVHJlZVByb29mKHNlc3Npb24sIGJsb2NrLCBoYXNoLCBzZWVrLCB1cGdyYWRlKQoKICBpZiAobm9kZSAhPT0gbnVsbCAmJiAoIXVwZ3JhZGUgfHwgbm9kZS5sYXN0SW5kZXggPCB1cGdyYWRlLnN0YXJ0KSkgewogICAgc3ViVHJlZSA9IG5vZGVzVG9Sb290KG5vZGUuaW5kZXgsIG5vZGUubm9kZXMsIHRvKQogICAgY29uc3Qgc2Vla1Jvb3QgPSBzZWVrCiAgICAgID8gYXdhaXQgc2Vla1VudHJ1c3RlZFRyZWUoc2Vzc2lvbiwgc3ViVHJlZSwgc2Vlay5ieXRlcywgc2Vlay5wYWRkaW5nKQogICAgICA6IGhlYWQKICAgIGJsb2NrQW5kU2Vla1Byb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBzZWVrUm9vdCwgc3ViVHJlZSwgcC5wZW5kaW5nKQogIH0gZWxzZSBpZiAoKG5vZGUgfHwgc2VlaykgJiYgdXBncmFkZSkgewogICAgc3ViVHJlZSA9IHNlZWsgPyBhd2FpdCBzZWVrRnJvbUhlYWQoc2Vzc2lvbiwgdG8sIHNlZWsuYnl0ZXMsIHNlZWsucGFkZGluZykgOiBub2RlLmluZGV4CiAgfQoKICBpZiAodXBncmFkZSkgewogICAgdXBncmFkZVByb29mKHNlc3Npb24sIHJ4LCBub2RlLCBzZWVrLCBmcm9tLCB0bywgc3ViVHJlZSwgcC5wZW5kaW5nKQogICAgaWYgKGhlYWQgPiB0bykgYWRkaXRpb25hbFVwZ3JhZGVQcm9vZihzZXNzaW9uLCByeCwgdG8sIGhlYWQsIHAucGVuZGluZykKICB9CgogIHJldHVybiBwCn0KCmZ1bmN0aW9uIGdldFVucGFkZGVkU2l6ZShub2RlLCBwYWRkaW5nLCBpdGUpIHsKICByZXR1cm4gcGFkZGluZyA9PT0gMAogICAgPyBub2RlLnNpemUKICAgIDogbm9kZS5zaXplIC0gcGFkZGluZyAqIChpdGUgPyBpdGUuY291bnRMZWF2ZXMoKSA6IGZsYXQuY291bnRMZWF2ZXMobm9kZS5pbmRleCkpCn0KCmZ1bmN0aW9uIHVuc2xhYk5vZGVzKG5vZGVzKSB7CiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB1bnNsYWJOb2RlKG5vZGUpCiAgcmV0dXJuIG5vZGVzCn0KCmZ1bmN0aW9uIHVuc2xhYk5vZGUobm9kZSkgewogIGlmIChub2RlID09PSBudWxsKSByZXR1cm4gbm9kZQogIG5vZGUuaGFzaCA9IHVuc2xhYihub2RlLmhhc2gpCiAgcmV0dXJuIG5vZGUKfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgREVGQVVMVF9OQU1FU1BBQ0UgfSA9IHJlcXVpcmUoJy4vY2FwcycpCmNvbnN0IHsgSU5WQUxJRF9PUExPR19WRVJTSU9OIH0gPSByZXF1aXJlKCdoeXBlcmNvcmUtZXJyb3JzJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCgpjb25zdCBNQU5JRkVTVF9QQVRDSCA9IDBiMDAwMDAwMDEKY29uc3QgTUFOSUZFU1RfUFJPTE9HVUUgPSAwYjAwMDAwMDEwCmNvbnN0IE1BTklGRVNUX0xJTktFRCA9IDBiMDAwMDAxMDAKY29uc3QgTUFOSUZFU1RfVVNFUl9EQVRBID0gMGIwMDAwMTAwMAoKY29uc3QgaGFzaGVzID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gc21hbGwgdWludAogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpZiAobSA9PT0gJ2JsYWtlMmInKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIHJldHVybgogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBoYXNoOiAnICsgbSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdibGFrZTJiJwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGhhc2ggaWQ6ICcgKyBuKQogIH0KfQoKY29uc3Qgc2lnbmF0dXJlcyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIHNtYWxsIHVpbnQKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgaWYgKG0gPT09ICdlZDI1NTE5JykgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAwKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmF0dXJlOiAnICsgbSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBpZiAobiA9PT0gMCkgcmV0dXJuICdlZDI1NTE5JwogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25hdHVyZSBpZDogJyArIG4pCiAgfQp9Cgpjb25zdCBzaWduZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzaWduYXR1cmVzLnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzaWduYXR1cmVzLmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLm5hbWVzcGFjZSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzaWduYXR1cmU6IHNpZ25hdHVyZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgbmFtZXNwYWNlOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgcHVibGljS2V5OiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgc2lnbmVyQXJyYXkgPSBjLmFycmF5KHNpZ25lcikKCmNvbnN0IHByb2xvZ3VlID0gewogIHByZWVuY29kZShzdGF0ZSwgcCkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgcC5oYXNoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcC5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHApIHsKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIHAuaGFzaCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHAubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgbWFuaWZlc3R2MCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGhhc2hlcy5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIHN0YXRlLmVuZCsrIC8vIHR5cGUKCiAgICBpZiAobS5wcm9sb2d1ZSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUuaGFzaCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG0ucXVvcnVtID09PSAxICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDEgJiYgIW0uYWxsb3dQYXRjaCkgewogICAgICBzaWduZXIucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnNbMF0pCiAgICB9IGVsc2UgewogICAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgICAgc2lnbmVyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnMpCiAgICB9CiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGhhc2hlcy5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBpZiAobS5wcm9sb2d1ZSAmJiBtLnNpZ25lcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUuaGFzaCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKG0ucXVvcnVtID09PSAxICYmIG0uc2lnbmVycy5sZW5ndGggPT09IDEgJiYgIW0uYWxsb3dQYXRjaCkgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgICBzaWduZXIuZW5jb2RlKHN0YXRlLCBtLnNpZ25lcnNbMF0pCiAgICB9IGVsc2UgewogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAyKQogICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmFsbG93UGF0Y2ggPyAxIDogMCkKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICAgIHNpZ25lckFycmF5LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQogICAgfQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBoYXNoID0gaGFzaGVzLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHR5cGUgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh0eXBlID4gMikgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHR5cGU6ICcgKyB0eXBlKQoKICAgIGlmICh0eXBlID09PSAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbjogMCwKICAgICAgICBoYXNoLAogICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgIHF1b3J1bTogMCwKICAgICAgICBzaWduZXJzOiBbXSwKICAgICAgICBwcm9sb2d1ZTogewogICAgICAgICAgaGFzaDogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgICAgICBsZW5ndGg6IDAKICAgICAgICB9LAogICAgICAgIGxpbmtlZDogbnVsbCwKICAgICAgICB1c2VyRGF0YTogbnVsbAogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGUgPT09IDEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiAwLAogICAgICAgIGhhc2gsCiAgICAgICAgYWxsb3dQYXRjaDogZmFsc2UsCiAgICAgICAgcXVvcnVtOiAxLAogICAgICAgIHNpZ25lcnM6IFtzaWduZXIuZGVjb2RlKHN0YXRlKV0sCiAgICAgICAgcHJvbG9ndWU6IG51bGwsCiAgICAgICAgbGlua2VkOiBudWxsLAogICAgICAgIHVzZXJEYXRhOiBudWxsCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMCwKICAgICAgaGFzaCwKICAgICAgYWxsb3dQYXRjaDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHF1b3J1bTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25lcnM6IHNpZ25lckFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHByb2xvZ3VlOiBudWxsLAogICAgICBsaW5rZWQ6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBmaXhlZDMyQXJyYXkgPSBjLmFycmF5KGMuZml4ZWQzMikKCmNvbnN0IG1hbmlmZXN0ID0gKGV4cG9ydHMubWFuaWZlc3QgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyB2ZXJzaW9uCgogICAgaWYgKG0udmVyc2lvbiA9PT0gMCkgcmV0dXJuIG1hbmlmZXN0djAucHJlZW5jb2RlKHN0YXRlLCBtKQoKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBoYXNoZXMucHJlZW5jb2RlKHN0YXRlLCBtLmhhc2gpCgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5xdW9ydW0pCiAgICBzaWduZXJBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmVycykKCiAgICBpZiAobS5wcm9sb2d1ZSkgcHJvbG9ndWUucHJlZW5jb2RlKHN0YXRlLCBtLnByb2xvZ3VlKQogICAgaWYgKG0ubGlua2VkKSBmaXhlZDMyQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmxpbmtlZCkKICAgIGlmIChtLnVzZXJEYXRhKSBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIG0udXNlckRhdGEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0udmVyc2lvbikKCiAgICBpZiAobS52ZXJzaW9uID09PSAwKSByZXR1cm4gbWFuaWZlc3R2MC5lbmNvZGUoc3RhdGUsIG0pCgogICAgbGV0IGZsYWdzID0gMAogICAgaWYgKG0uYWxsb3dQYXRjaCkgZmxhZ3MgfD0gTUFOSUZFU1RfUEFUQ0gKICAgIGlmIChtLnByb2xvZ3VlKSBmbGFncyB8PSBNQU5JRkVTVF9QUk9MT0dVRQogICAgaWYgKG0ubGlua2VkKSBmbGFncyB8PSBNQU5JRkVTVF9MSU5LRUQKICAgIGlmIChtLnVzZXJEYXRhKSBmbGFncyB8PSBNQU5JRkVTVF9VU0VSX0RBVEEKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICAgIGhhc2hlcy5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnF1b3J1bSkKICAgIHNpZ25lckFycmF5LmVuY29kZShzdGF0ZSwgbS5zaWduZXJzKQoKICAgIGlmIChtLnByb2xvZ3VlKSBwcm9sb2d1ZS5lbmNvZGUoc3RhdGUsIG0ucHJvbG9ndWUpCiAgICBpZiAobS5saW5rZWQpIGZpeGVkMzJBcnJheS5lbmNvZGUoc3RhdGUsIG0ubGlua2VkKQogICAgaWYgKG0udXNlckRhdGEpIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHZlcnNpb24gPT09IDApIHJldHVybiBtYW5pZmVzdHYwLmRlY29kZShzdGF0ZSkKICAgIGlmICh2ZXJzaW9uID4gMikgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHZlcnNpb246ICcgKyB2ZXJzaW9uKQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGhhc2ggPSBoYXNoZXMuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcXVvcnVtID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IHNpZ25lcnMgPSBzaWduZXJBcnJheS5kZWNvZGUoc3RhdGUpCgogICAgY29uc3QgaGFzUGF0Y2ggPSAoZmxhZ3MgJiBNQU5JRkVTVF9QQVRDSCkgIT09IDAKICAgIGNvbnN0IGhhc1Byb2xvZ3VlID0gKGZsYWdzICYgTUFOSUZFU1RfUFJPTE9HVUUpICE9PSAwCiAgICBjb25zdCBoYXNMaW5rZWQgPSAoZmxhZ3MgJiBNQU5JRkVTVF9MSU5LRUQpICE9PSAwCiAgICBjb25zdCBoYXNVc2VyRGF0YSA9IChmbGFncyAmIE1BTklGRVNUX1VTRVJfREFUQSkgIT09IDAKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBoYXNoLAogICAgICBhbGxvd1BhdGNoOiBoYXNQYXRjaCwKICAgICAgcXVvcnVtLAogICAgICBzaWduZXJzLAogICAgICBwcm9sb2d1ZTogaGFzUHJvbG9ndWUgPyBwcm9sb2d1ZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgbGlua2VkOiBoYXNMaW5rZWQgPyBmaXhlZDMyQXJyYXkuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBoYXNVc2VyRGF0YSA/IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9KQoKY29uc3Qgbm9kZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLnNpemUpCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBuLmhhc2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2l6ZTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGhhc2g6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBub2RlQXJyYXkgPSBjLmFycmF5KG5vZGUpCgpjb25zdCB3aXJlID0gKGV4cG9ydHMud2lyZSA9IHt9KQoKd2lyZS5oYW5kc2hha2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCAxKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5jYXBhYmlsaXR5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnNlZWtzID8gMSA6IDApCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIHNlZWtzOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgY2FwYWJpbGl0eTogdW5zbGFiKGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdEJsb2NrID0gewogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgYi5pbmRleCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIubm9kZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVxdWVzdFNlZWsgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcy5wYWRkaW5nKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgcy5wYWRkaW5nKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBieXRlczogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHBhZGRpbmc6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZXF1ZXN0VXBncmFkZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHUpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUucmVxdWVzdCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSByZXF1ZXN0QmxvY2sucHJlZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgcmVxdWVzdEJsb2NrLnByZWVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgcmVxdWVzdFNlZWsucHJlZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSByZXF1ZXN0VXBncmFkZS5wcmVlbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLnByaW9yaXR5KSBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnByaW9yaXR5KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmJsb2NrID8gMSA6IDApIHwKICAgICAgKG0uaGFzaCA/IDIgOiAwKSB8CiAgICAgIChtLnNlZWsgPyA0IDogMCkgfAogICAgICAobS51cGdyYWRlID8gOCA6IDApIHwKICAgICAgKG0ubWFuaWZlc3QgPyAxNiA6IDApIHwKICAgICAgKG0ucHJpb3JpdHkgPyAzMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQoKICAgIGlmIChtLmJsb2NrKSByZXF1ZXN0QmxvY2suZW5jb2RlKHN0YXRlLCBtLmJsb2NrKQogICAgaWYgKG0uaGFzaCkgcmVxdWVzdEJsb2NrLmVuY29kZShzdGF0ZSwgbS5oYXNoKQogICAgaWYgKG0uc2VlaykgcmVxdWVzdFNlZWsuZW5jb2RlKHN0YXRlLCBtLnNlZWspCiAgICBpZiAobS51cGdyYWRlKSByZXF1ZXN0VXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udXBncmFkZSkKICAgIGlmIChtLnByaW9yaXR5KSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnByaW9yaXR5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgaWQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmb3JrOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYmxvY2s6IGZsYWdzICYgMSA/IHJlcXVlc3RCbG9jay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgaGFzaDogZmxhZ3MgJiAyID8gcmVxdWVzdEJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWVrOiBmbGFncyAmIDQgPyByZXF1ZXN0U2Vlay5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdXBncmFkZTogZmxhZ3MgJiA4ID8gcmVxdWVzdFVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIG1hbmlmZXN0OiAoZmxhZ3MgJiAxNikgIT09IDAsCiAgICAgIHByaW9yaXR5OiBmbGFncyAmIDMyID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICB9CiAgfQp9Cgp3aXJlLmNhbmNlbCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXF1ZXN0KQogIH0sCiAgZGVjb2RlKHN0YXRlLCBtKSB7CiAgICByZXR1cm4gewogICAgICByZXF1ZXN0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgZGF0YVVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCB1Lm5vZGVzKQogICAgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgdS5hZGRpdGlvbmFsTm9kZXMpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1LnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5sZW5ndGgpCiAgICBub2RlQXJyYXkuZW5jb2RlKHN0YXRlLCB1Lm5vZGVzKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgdS5hZGRpdGlvbmFsTm9kZXMpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIHUuc2lnbmF0dXJlKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIG5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgYWRkaXRpb25hbE5vZGVzOiBub2RlQXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhU2VlayA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIHMpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHMuYnl0ZXMpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBzLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBzLmJ5dGVzKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgYnl0ZXM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGRhdGFCbG9jayA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBjLmJ1ZmZlci5wcmVlbmNvZGUoc3RhdGUsIGIudmFsdWUpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBiLnZhbHVlKQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKSB8fCBFTVBUWSwKICAgICAgbm9kZXM6IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCBkYXRhSGFzaCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGIpIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuaW5kZXgpCiAgICBub2RlQXJyYXkucHJlZW5jb2RlKHN0YXRlLCBiLm5vZGVzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBiKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmluZGV4KQogICAgbm9kZUFycmF5LmVuY29kZShzdGF0ZSwgYi5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgaW5kZXg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2Rlczogbm9kZUFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCndpcmUuZGF0YSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCsrIC8vIGZsYWdzCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIGRhdGFCbG9jay5wcmVlbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSBkYXRhSGFzaC5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIGRhdGFTZWVrLnByZWVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgZGF0YVVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5tYW5pZmVzdCkgbWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9CiAgICAgIChtLmJsb2NrID8gMSA6IDApIHwKICAgICAgKG0uaGFzaCA/IDIgOiAwKSB8CiAgICAgIChtLnNlZWsgPyA0IDogMCkgfAogICAgICAobS51cGdyYWRlID8gOCA6IDApIHwKICAgICAgKG0ubWFuaWZlc3QgPyAxNiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmZvcmspCgogICAgaWYgKG0uYmxvY2spIGRhdGFCbG9jay5lbmNvZGUoc3RhdGUsIG0uYmxvY2spCiAgICBpZiAobS5oYXNoKSBkYXRhSGFzaC5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICAgIGlmIChtLnNlZWspIGRhdGFTZWVrLmVuY29kZShzdGF0ZSwgbS5zZWVrKQogICAgaWYgKG0udXBncmFkZSkgZGF0YVVwZ3JhZGUuZW5jb2RlKHN0YXRlLCBtLnVwZ3JhZGUpCiAgICBpZiAobS5tYW5pZmVzdCkgbWFuaWZlc3QuZW5jb2RlKHN0YXRlLCBtLm1hbmlmZXN0KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgcmVxdWVzdDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBibG9jazogZmxhZ3MgJiAxID8gZGF0YUJsb2NrLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBoYXNoOiBmbGFncyAmIDIgPyBkYXRhSGFzaC5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgc2VlazogZmxhZ3MgJiA0ID8gZGF0YVNlZWsuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVwZ3JhZGU6IGZsYWdzICYgOCA/IGRhdGFVcGdyYWRlLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBtYW5pZmVzdDogZmxhZ3MgJiAxNiA/IG1hbmlmZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgp3aXJlLm5vRGF0YSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVxdWVzdCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVhc29uID8gMSA6IDApCiAgICBpZiAobS5yZWFzb24pIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ucmVhc29uKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlcXVlc3QpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlYXNvbiA/IDEgOiAwKQogICAgaWYgKG0ucmVhc29uKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlYXNvbikKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgcmVxdWVzdCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBmbGFncyA9IHN0YXRlLnN0YXJ0IDwgc3RhdGUuZW5kID8gYy51aW50LmRlY29kZShzdGF0ZSkgOiAwCiAgICByZXR1cm4gewogICAgICByZXF1ZXN0LAogICAgICByZWFzb246IGZsYWdzICYgMSA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKd2lyZS53YW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS51bndhbnQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSwgbSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLnJhbmdlID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc3RhcnQpCiAgICBpZiAobS5sZW5ndGggIT09IDEpIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAobS5kcm9wID8gMSA6IDApIHwgKG0ubGVuZ3RoID09PSAxID8gMiA6IDApKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGlmIChtLmxlbmd0aCAhPT0gMSkgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBkcm9wOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IChmbGFncyAmIDIpICE9PSAwID8gMSA6IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmJpdGZpZWxkID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludDMyYXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmJpdGZpZWxkKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50MzJhcnJheS5lbmNvZGUoc3RhdGUsIG0uYml0ZmllbGQpCiAgfSwKICBkZWNvZGUoc3RhdGUsIG0pIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgYml0ZmllbGQ6IGMudWludDMyYXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKd2lyZS5zeW5jID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZm9yaykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5yZW1vdGVMZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoCiAgICAgIHN0YXRlLAogICAgICAobS5jYW5VcGdyYWRlID8gMSA6IDApIHwKICAgICAgICAobS51cGxvYWRpbmcgPyAyIDogMCkgfAogICAgICAgIChtLmRvd25sb2FkaW5nID8gNCA6IDApIHwKICAgICAgICAobS5oYXNNYW5pZmVzdCA/IDggOiAwKSB8CiAgICAgICAgKG0uYWxsb3dQdXNoID8gMTYgOiAwKQogICAgKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICByZW1vdGVMZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBjYW5VcGdyYWRlOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgdXBsb2FkaW5nOiAoZmxhZ3MgJiAyKSAhPT0gMCwKICAgICAgZG93bmxvYWRpbmc6IChmbGFncyAmIDQpICE9PSAwLAogICAgICBoYXNNYW5pZmVzdDogKGZsYWdzICYgOCkgIT09IDAsCiAgICAgIGFsbG93UHVzaDogKGZsYWdzICYgMTYpICE9PSAwCiAgICB9CiAgfQp9Cgp3aXJlLnJlb3JnSGludCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uZnJvbSkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0udG8pCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmFuY2VzdG9ycykKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5mcm9tKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS50bykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uYW5jZXN0b3JzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBmcm9tOiBjLnVpbnQuZW5jb2RlKHN0YXRlKSwKICAgICAgdG86IGMudWludC5lbmNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5lbmNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgp3aXJlLmV4dGVuc2lvbiA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5yYXcucHJlZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgbS5uYW1lKQogICAgYy5yYXcuZW5jb2RlKHN0YXRlLCBtLm1lc3NhZ2UpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIG1lc3NhZ2U6IGMucmF3LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGtleVZhbHVlID0gewogIHByZWVuY29kZShzdGF0ZSwgcCkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCBwLmtleSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgcC52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgcCkgewogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCBwLmtleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgcC52YWx1ZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAga2V5OiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICB2YWx1ZTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdHJlZVVwZ3JhZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB1KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB1LmFuY2VzdG9ycykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHUubGVuZ3RoKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCB1LnNpZ25hdHVyZSkKICB9LAogIGVuY29kZShzdGF0ZSwgdSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5mb3JrKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgdS5hbmNlc3RvcnMpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB1Lmxlbmd0aCkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgdS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZvcms6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBhbmNlc3RvcnM6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGJpdGZpZWxkVXBkYXRlID0gewogIC8vIFRPRE86IGNhbiBtYXliZSBiZSBmb2xkZWQgaW50byBhIEhBVkUgbGF0ZXIgb24gd2l0aCB0aGUgbW9zdCByZWNlbnQgc3BlYwogIHByZWVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuZW5kKysgLy8gZmxhZ3MKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIGIuc3RhcnQpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgYikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gYi5kcm9wID8gMSA6IDAKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGIuc3RhcnQpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBiLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgZHJvcDogKGZsYWdzICYgMSkgIT09IDAsCiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgb3Bsb2cgPSAoZXhwb3J0cy5vcGxvZyA9IHt9KQoKb3Bsb2cuZW50cnkgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaWYgKG0udXNlckRhdGEpIGtleVZhbHVlLnByZWVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICAgIGlmIChtLnRyZWVOb2Rlcykgbm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgbS50cmVlTm9kZXMpCiAgICBpZiAobS50cmVlVXBncmFkZSkgdHJlZVVwZ3JhZGUucHJlZW5jb2RlKHN0YXRlLCBtLnRyZWVVcGdyYWRlKQogICAgaWYgKG0uYml0ZmllbGQpIGJpdGZpZWxkVXBkYXRlLnByZWVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgcyA9IHN0YXRlLnN0YXJ0KysKICAgIGxldCBmbGFncyA9IDAKCiAgICBpZiAobS51c2VyRGF0YSkgewogICAgICBmbGFncyB8PSAxCiAgICAgIGtleVZhbHVlLmVuY29kZShzdGF0ZSwgbS51c2VyRGF0YSkKICAgIH0KICAgIGlmIChtLnRyZWVOb2RlcykgewogICAgICBmbGFncyB8PSAyCiAgICAgIG5vZGVBcnJheS5lbmNvZGUoc3RhdGUsIG0udHJlZU5vZGVzKQogICAgfQogICAgaWYgKG0udHJlZVVwZ3JhZGUpIHsKICAgICAgZmxhZ3MgfD0gNAogICAgICB0cmVlVXBncmFkZS5lbmNvZGUoc3RhdGUsIG0udHJlZVVwZ3JhZGUpCiAgICB9CiAgICBpZiAobS5iaXRmaWVsZCkgewogICAgICBmbGFncyB8PSA4CiAgICAgIGJpdGZpZWxkVXBkYXRlLmVuY29kZShzdGF0ZSwgbS5iaXRmaWVsZCkKICAgIH0KCiAgICBzdGF0ZS5idWZmZXJbc10gPSBmbGFncwogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICByZXR1cm4gewogICAgICB1c2VyRGF0YTogKGZsYWdzICYgMSkgIT09IDAgPyBrZXlWYWx1ZS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZU5vZGVzOiAoZmxhZ3MgJiAyKSAhPT0gMCA/IG5vZGVBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgdHJlZVVwZ3JhZGU6IChmbGFncyAmIDQpICE9PSAwID8gdHJlZVVwZ3JhZGUuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIGJpdGZpZWxkOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGJpdGZpZWxkVXBkYXRlLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9Cgpjb25zdCBrZXlQYWlyID0gewogIHByZWVuY29kZShzdGF0ZSwga3ApIHsKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwga3AucHVibGljS2V5KQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBrcC5zZWNyZXRLZXkpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGtwKSB7CiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIGtwLnB1YmxpY0tleSkKICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwga3Auc2VjcmV0S2V5KQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwdWJsaWNLZXk6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHNlY3JldEtleTogYy5idWZmZXIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVvcmdIaW50ID0gewogIHByZWVuY29kZShzdGF0ZSwgcikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci5mcm9tKQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgci50bykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIHIuYW5jZXN0b3JzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCByKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLmZyb20pCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCByLnRvKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgci5hbmNlc3RvcnMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGZyb206IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICB0bzogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGFuY2VzdG9yczogYy51aW50LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlb3JnSGludEFycmF5ID0gYy5hcnJheShyZW9yZ0hpbnQpCgpjb25zdCBoaW50cyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGgpIHsKICAgIHJlb3JnSGludEFycmF5LnByZWVuY29kZShzdGF0ZSwgaC5yZW9yZ3MpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBoLmNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGgpIHsKICAgIHJlb3JnSGludEFycmF5LmVuY29kZShzdGF0ZSwgaC5yZW9yZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBoLmNvbnRpZ3VvdXNMZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlb3JnczogcmVvcmdIaW50QXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgY29udGlndW91c0xlbmd0aDogc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmNvbnN0IHRyZWVIZWFkZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCB0KSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0LmZvcmspCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0Lmxlbmd0aCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdC5yb290SGFzaCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdC5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHQpIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHQuZm9yaykKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHQubGVuZ3RoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0LnJvb3RIYXNoKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0LnNpZ25hdHVyZSkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgZm9yazogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIGxlbmd0aDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJvb3RIYXNoOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHR5cGVzID0gewogIHByZWVuY29kZShzdGF0ZSwgdCkgewogICAgYy5zdHJpbmcucHJlZW5jb2RlKHN0YXRlLCB0LnRyZWUpCiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQuYml0ZmllbGQpCiAgICBjLnN0cmluZy5wcmVlbmNvZGUoc3RhdGUsIHQuc2lnbmVyKQogIH0sCiAgZW5jb2RlKHN0YXRlLCB0KSB7CiAgICBjLnN0cmluZy5lbmNvZGUoc3RhdGUsIHQudHJlZSkKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC5iaXRmaWVsZCkKICAgIGMuc3RyaW5nLmVuY29kZShzdGF0ZSwgdC5zaWduZXIpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHRyZWU6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSksCiAgICAgIGJpdGZpZWxkOiBjLnN0cmluZy5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduZXI6IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IGV4dGVybmFsSGVhZGVyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0ubGVuZ3RoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnN0YXJ0KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5sZW5ndGgpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbGVuZ3RoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qga2V5VmFsdWVBcnJheSA9IGMuYXJyYXkoa2V5VmFsdWUpCgpvcGxvZy5oZWFkZXIgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBoKSB7CiAgICBzdGF0ZS5lbmQgKz0gMiAvLyB2ZXJzaW9uICsgZmxhZ3MKICAgIGlmIChoLmV4dGVybmFsKSB7CiAgICAgIGV4dGVybmFsSGVhZGVyLnByZWVuY29kZShzdGF0ZSwgaC5leHRlcm5hbCkKICAgICAgcmV0dXJuCiAgICB9CiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBoLmtleSkKICAgIGlmIChoLm1hbmlmZXN0KSBtYW5pZmVzdC5wcmVlbmNvZGUoc3RhdGUsIGgubWFuaWZlc3QpCiAgICBpZiAoaC5rZXlQYWlyKSBrZXlQYWlyLnByZWVuY29kZShzdGF0ZSwgaC5rZXlQYWlyKQogICAga2V5VmFsdWVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIGgudXNlckRhdGEpCiAgICB0cmVlSGVhZGVyLnByZWVuY29kZShzdGF0ZSwgaC50cmVlKQogICAgaGludHMucHJlZW5jb2RlKHN0YXRlLCBoLmhpbnRzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBoKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgaWYgKGguZXh0ZXJuYWwpIHsKICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkgLy8gT05MWSBzZXQgdGhlIGZpcnN0IGJpZyBmb3IgY2xhcml0eQogICAgICBleHRlcm5hbEhlYWRlci5lbmNvZGUoc3RhdGUsIGguZXh0ZXJuYWwpCiAgICAgIHJldHVybgogICAgfQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgKGgubWFuaWZlc3QgPyAyIDogMCkgfCAoaC5rZXlQYWlyID8gNCA6IDApKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgaC5rZXkpCiAgICBpZiAoaC5tYW5pZmVzdCkgbWFuaWZlc3QuZW5jb2RlKHN0YXRlLCBoLm1hbmlmZXN0KQogICAgaWYgKGgua2V5UGFpcikga2V5UGFpci5lbmNvZGUoc3RhdGUsIGgua2V5UGFpcikKICAgIGtleVZhbHVlQXJyYXkuZW5jb2RlKHN0YXRlLCBoLnVzZXJEYXRhKQogICAgdHJlZUhlYWRlci5lbmNvZGUoc3RhdGUsIGgudHJlZSkKICAgIGhpbnRzLmVuY29kZShzdGF0ZSwgaC5oaW50cykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgdmVyc2lvbiA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgaWYgKHZlcnNpb24gPiAxKSB7CiAgICAgIHRocm93IElOVkFMSURfT1BMT0dfVkVSU0lPTignSW52YWxpZCBoZWFkZXIgdmVyc2lvbi4gRXhwZWN0ZWQgPD0gMSwgZ290ICcgKyB2ZXJzaW9uKQogICAgfQoKICAgIGlmICh2ZXJzaW9uID09PSAwKSB7CiAgICAgIGNvbnN0IG9sZCA9IHsKICAgICAgICB0eXBlczogdHlwZXMuZGVjb2RlKHN0YXRlKSwKICAgICAgICB1c2VyRGF0YToga2V5VmFsdWVBcnJheS5kZWNvZGUoc3RhdGUpLAogICAgICAgIHRyZWU6IHRyZWVIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBzaWduZXI6IGtleVBhaXIuZGVjb2RlKHN0YXRlKSwKICAgICAgICBoaW50czogaGludHMuZGVjb2RlKHN0YXRlKQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGV4dGVybmFsOiBudWxsLAogICAgICAgIGtleTogb2xkLnNpZ25lci5wdWJsaWNLZXksCiAgICAgICAgbWFuaWZlc3Q6IHsKICAgICAgICAgIHZlcnNpb246IDAsCiAgICAgICAgICBoYXNoOiBvbGQudHlwZXMudHJlZSwKICAgICAgICAgIGFsbG93UGF0Y2g6IGZhbHNlLAogICAgICAgICAgcXVvcnVtOiAxLAogICAgICAgICAgc2lnbmVyczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2lnbmF0dXJlOiBvbGQudHlwZXMuc2lnbmVyLAogICAgICAgICAgICAgIG5hbWVzcGFjZTogREVGQVVMVF9OQU1FU1BBQ0UsCiAgICAgICAgICAgICAgcHVibGljS2V5OiBvbGQuc2lnbmVyLnB1YmxpY0tleQogICAgICAgICAgICB9CiAgICAgICAgICBdLAogICAgICAgICAgcHJvbG9ndWU6IG51bGwsCiAgICAgICAgICBsaW5rZWQ6IG51bGwsCiAgICAgICAgICB1c2VyRGF0YTogbnVsbAogICAgICAgIH0sCiAgICAgICAga2V5UGFpcjogb2xkLnNpZ25lci5zZWNyZXRLZXkgPyBvbGQuc2lnbmVyIDogbnVsbCwKICAgICAgICB1c2VyRGF0YTogb2xkLnVzZXJEYXRhLAogICAgICAgIHRyZWU6IG9sZC50cmVlLAogICAgICAgIGhpbnRzOiBvbGQuaGludHMKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAoZmxhZ3MgJiAxKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZXh0ZXJuYWw6IGV4dGVybmFsSGVhZGVyLmRlY29kZShzdGF0ZSksCiAgICAgICAga2V5OiBudWxsLAogICAgICAgIG1hbmlmZXN0OiBudWxsLAogICAgICAgIGtleVBhaXI6IG51bGwsCiAgICAgICAgdXNlckRhdGE6IG51bGwsCiAgICAgICAgdHJlZTogbnVsbCwKICAgICAgICBoaW50czogbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZXh0ZXJuYWw6IG51bGwsCiAgICAgIGtleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIG1hbmlmZXN0OiAoZmxhZ3MgJiAyKSAhPT0gMCA/IG1hbmlmZXN0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBrZXlQYWlyOiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGtleVBhaXIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBrZXlWYWx1ZUFycmF5LmRlY29kZShzdGF0ZSksCiAgICAgIHRyZWU6IHRyZWVIZWFkZXIuZGVjb2RlKHN0YXRlKSwKICAgICAgaGludHM6IGhpbnRzLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHVpbnRBcnJheSA9IGMuYXJyYXkoYy51aW50KQoKY29uc3QgbXVsdGlzaWdJbnB1dCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIGlucCkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgaW5wLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIGlucC5zaWduYXR1cmUpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBpbnAucGF0Y2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIGlucCkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgaW5wLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5lbmNvZGUoc3RhdGUsIGlucC5zaWduYXR1cmUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBpbnAucGF0Y2gpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNpZ25lcjogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpZ25hdHVyZTogYy5maXhlZDY0LmRlY29kZShzdGF0ZSksCiAgICAgIHBhdGNoOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcGF0Y2hFbmNvZGluZ3YwID0gewogIHByZWVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zdGFydCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG4ubGVuZ3RoKQogICAgdWludEFycmF5LnByZWVuY29kZShzdGF0ZSwgbi5ub2RlcykKICB9LAogIGVuY29kZShzdGF0ZSwgbikgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zdGFydCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4ubGVuZ3RoKQogICAgdWludEFycmF5LmVuY29kZShzdGF0ZSwgbi5ub2RlcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBsZW5ndGg6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBub2RlczogdWludEFycmF5LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IG11bHRpc2lnSW5wdXR2MCA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG4pIHsKICAgIHN0YXRlLmVuZCsrCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLnNpZ25lcikKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG4uc2lnbmF0dXJlKQogICAgaWYgKG4ucGF0Y2gpIHBhdGNoRW5jb2Rpbmd2MC5wcmVlbmNvZGUoc3RhdGUsIG4ucGF0Y2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG4pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4ucGF0Y2ggPyAxIDogMCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG4uc2lnbmVyKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbi5zaWduYXR1cmUpCiAgICBpZiAobi5wYXRjaCkgcGF0Y2hFbmNvZGluZ3YwLmVuY29kZShzdGF0ZSwgbi5wYXRjaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgc2lnbmVyOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2lnbmF0dXJlOiBjLmZpeGVkNjQuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGZsYWdzICYgMSA/IHBhdGNoRW5jb2Rpbmd2MC5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKY29uc3QgbXVsdGlzaWdJbnB1dEFycmF5djAgPSBjLmFycmF5KG11bHRpc2lnSW5wdXR2MCkKY29uc3QgbXVsdGlzaWdJbnB1dEFycmF5ID0gYy5hcnJheShtdWx0aXNpZ0lucHV0KQoKY29uc3QgY29tcGFjdE5vZGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBuKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBuLmluZGV4KQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbi5zaXplKQogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbi5oYXNoKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpbmRleDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHNpemU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBoYXNoOiBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgY29tcGFjdE5vZGVBcnJheSA9IGMuYXJyYXkoY29tcGFjdE5vZGUpCgpleHBvcnRzLm11bHRpU2lnbmF0dXJldjAgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBzKSB7CiAgICBtdWx0aXNpZ0lucHV0QXJyYXl2MC5wcmVlbmNvZGUoc3RhdGUsIHMucHJvb2ZzKQogICAgY29tcGFjdE5vZGVBcnJheS5wcmVlbmNvZGUoc3RhdGUsIHMucGF0Y2gpCiAgfSwKICBlbmNvZGUoc3RhdGUsIHMpIHsKICAgIG11bHRpc2lnSW5wdXRBcnJheXYwLmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHJvb2ZzOiBtdWx0aXNpZ0lucHV0QXJyYXl2MC5kZWNvZGUoc3RhdGUpLAogICAgICBwYXRjaDogY29tcGFjdE5vZGVBcnJheS5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm11bHRpU2lnbmF0dXJlID0gewogIHByZWVuY29kZShzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LnByZWVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGVuY29kZShzdGF0ZSwgcykgewogICAgbXVsdGlzaWdJbnB1dEFycmF5LmVuY29kZShzdGF0ZSwgcy5wcm9vZnMpCiAgICBjb21wYWN0Tm9kZUFycmF5LmVuY29kZShzdGF0ZSwgcy5wYXRjaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcHJvb2ZzOiBtdWx0aXNpZ0lucHV0QXJyYXkuZGVjb2RlKHN0YXRlKSwKICAgICAgcGF0Y2g6IGNvbXBhY3ROb2RlQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCB7IE1lcmtsZVRyZWUgfSA9IHJlcXVpcmUoJy4vbWVya2xlLXRyZWUnKQpjb25zdCB7IG11bHRpU2lnbmF0dXJlLCBtdWx0aVNpZ25hdHVyZXYwIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKCm1vZHVsZS5leHBvcnRzID0gewogIGFzc2VtYmxldjAsCiAgYXNzZW1ibGUsCiAgaW5mbGF0ZXYwLAogIGluZmxhdGUsCiAgcGFydGlhbFNpZ25hdHVyZSwKICBzaWduYWJsZUxlbmd0aAp9CgpmdW5jdGlvbiBpbmZsYXRldjAoZGF0YSkgewogIHJldHVybiBjLmRlY29kZShtdWx0aVNpZ25hdHVyZXYwLCBkYXRhKQp9CgpmdW5jdGlvbiBpbmZsYXRlKGRhdGEpIHsKICByZXR1cm4gYy5kZWNvZGUobXVsdGlTaWduYXR1cmUsIGRhdGEpCn0KCmFzeW5jIGZ1bmN0aW9uIHBhcnRpYWxTaWduYXR1cmUoCiAgY29yZSwKICBzaWduZXIsCiAgZnJvbSwKICB0byA9IGNvcmUuc3RhdGUubGVuZ3RoLAogIHNpZ25hdHVyZSA9IGNvcmUuc3RhdGUuc2lnbmF0dXJlCikgewogIGlmIChmcm9tID4gY29yZS5zdGF0ZS5sZW5ndGgpIHJldHVybiBudWxsCiAgY29uc3Qgbm9kZXMgPSB0byA8PSBmcm9tID8gbnVsbCA6IGF3YWl0IHVwZ3JhZGVOb2Rlcyhjb3JlLCBmcm9tLCB0bykKCiAgaWYgKHNpZ25hdHVyZS5ieXRlTGVuZ3RoICE9PSA2NCkgewogICAgc2lnbmF0dXJlID0gYy5kZWNvZGUobXVsdGlTaWduYXR1cmUsIHNpZ25hdHVyZSkucHJvb2ZzWzBdLnNpZ25hdHVyZQogIH0KCiAgcmV0dXJuIHsKICAgIHNpZ25lciwKICAgIHNpZ25hdHVyZSwKICAgIHBhdGNoOiBub2RlcyA/IHRvIC0gZnJvbSA6IDAsCiAgICBub2RlcwogIH0KfQoKYXN5bmMgZnVuY3Rpb24gdXBncmFkZU5vZGVzKGNvcmUsIGZyb20sIHRvKSB7CiAgY29uc3QgcnggPSBjb3JlLnN0YXRlLnN0b3JhZ2UucmVhZCgpCiAgbGV0IHAgPSBudWxsCiAgdHJ5IHsKICAgIHAgPSBhd2FpdCBNZXJrbGVUcmVlLnByb29mKGNvcmUuc3RhdGUsIHJ4LCB7IHVwZ3JhZGU6IHsgc3RhcnQ6IGZyb20sIGxlbmd0aDogdG8gLSBmcm9tIH0gfSkKICB9IGNhdGNoIChlcnIpIHsKICAgIHJ4LmRlc3Ryb3koKQogICAgdGhyb3cgZXJyCiAgfQogIHJ4LnRyeUZsdXNoKCkKICByZXR1cm4gKGF3YWl0IHAuc2V0dGxlKCkpLnVwZ3JhZGUubm9kZXMKfQoKZnVuY3Rpb24gc2lnbmFibGVMZW5ndGgobGVuZ3RocywgcXVvcnVtKSB7CiAgaWYgKHF1b3J1bSA8PSAwKSBxdW9ydW0gPSAxCiAgaWYgKHF1b3J1bSA+IGxlbmd0aHMubGVuZ3RoKSByZXR1cm4gMAoKICByZXR1cm4gbGVuZ3Rocy5zb3J0KGNtcClbcXVvcnVtIC0gMV0KfQoKZnVuY3Rpb24gY21wKGEsIGIpIHsKICByZXR1cm4gYiAtIGEKfQoKZnVuY3Rpb24gYXNzZW1ibGV2MChpbnB1dHMpIHsKICBjb25zdCBwcm9vZnMgPSBbXQogIGNvbnN0IHBhdGNoID0gW10KCiAgZm9yIChjb25zdCB1IG9mIGlucHV0cykgewogICAgcHJvb2ZzLnB1c2goY29tcHJlc3NQcm9vZih1LCBwYXRjaCkpCiAgfQoKICByZXR1cm4gYy5lbmNvZGUobXVsdGlTaWduYXR1cmV2MCwgeyBwcm9vZnMsIHBhdGNoIH0pCn0KCmZ1bmN0aW9uIGFzc2VtYmxlKGlucHV0cykgewogIGNvbnN0IHByb29mcyA9IFtdCiAgY29uc3QgcGF0Y2ggPSBbXQogIGNvbnN0IHNlZW4gPSBuZXcgU2V0KCkKCiAgZm9yIChjb25zdCB1IG9mIGlucHV0cykgewogICAgaWYgKHUubm9kZXMpIHsKICAgICAgZm9yIChjb25zdCBub2RlIG9mIHUubm9kZXMpIHsKICAgICAgICBpZiAoc2Vlbi5oYXMobm9kZS5pbmRleCkpIGNvbnRpbnVlCiAgICAgICAgc2Vlbi5hZGQobm9kZS5pbmRleCkKICAgICAgICBwYXRjaC5wdXNoKG5vZGUpCiAgICAgIH0KICAgIH0KCiAgICBwcm9vZnMucHVzaCh7CiAgICAgIHNpZ25lcjogdS5zaWduZXIsCiAgICAgIHNpZ25hdHVyZTogdS5zaWduYXR1cmUsCiAgICAgIHBhdGNoOiB1LnBhdGNoCiAgICB9KQogIH0KCiAgcmV0dXJuIGMuZW5jb2RlKG11bHRpU2lnbmF0dXJlLCB7IHByb29mcywgcGF0Y2ggfSkKfQoKZnVuY3Rpb24gY29tcGFyZU5vZGUoYSwgYikgewogIGlmIChhLmluZGV4ICE9PSBiLmluZGV4KSByZXR1cm4gZmFsc2UKICBpZiAoYS5zaXplICE9PSBiLnNpemUpIHJldHVybiBmYWxzZQogIHJldHVybiBiNGEuZXF1YWxzKGEuaGFzaCwgYi5oYXNoKQp9CgpmdW5jdGlvbiBjb21wcmVzc1Byb29mKHByb29mLCBub2RlcykgewogIHJldHVybiB7CiAgICBzaWduZXI6IHByb29mLnNpZ25lciwKICAgIHNpZ25hdHVyZTogcHJvb2Yuc2lnbmF0dXJlLAogICAgcGF0Y2g6IHByb29mLnBhdGNoID8gY29tcHJlc3NVcGdyYWRlKHByb29mLCBub2RlcykgOiBudWxsCiAgfQp9CgpmdW5jdGlvbiBjb21wcmVzc1VwZ3JhZGUocCwgbm9kZXMpIHsKICBjb25zdCB1ID0gewogICAgc3RhcnQ6IGZsYXQucmlnaHRTcGFuKHAubm9kZXNbcC5ub2Rlcy5sZW5ndGggLSAxXS5pbmRleCkgLyAyICsgMSwKICAgIGxlbmd0aDogcC5wYXRjaCwKICAgIG5vZGVzOiBbXQogIH0KCiAgZm9yIChjb25zdCBub2RlIG9mIHAubm9kZXMpIHsKICAgIGxldCBwcmVzZW50ID0gZmFsc2UKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFjb21wYXJlTm9kZShub2Rlc1tpXSwgbm9kZSkpIGNvbnRpbnVlCgogICAgICB1Lm5vZGVzLnB1c2goaSkKICAgICAgcHJlc2VudCA9IHRydWUKICAgICAgYnJlYWsKICAgIH0KCiAgICBpZiAocHJlc2VudCkgY29udGludWUKICAgIHUubm9kZXMucHVzaChub2Rlcy5wdXNoKG5vZGUpIC0gMSkKICB9CgogIHJldHVybiB1Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBNdXRleCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmxvY2tlZCA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5fZGVzdHJveWluZyA9IG51bGwKICAgIHRoaXMuX2Rlc3Ryb3lFcnJvciA9IG51bGwKICAgIHRoaXMuX3F1ZXVlID0gW10KICAgIHRoaXMuX2VucXVldWUgPSAocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLl9xdWV1ZS5wdXNoKFtyZXNvbHZlLCByZWplY3RdKQogIH0KCiAgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9xdWV1ZS5sZW5ndGggPT09IDAgJiYgdGhpcy5sb2NrZWQgPT09IGZhbHNlCiAgfQoKICBsb2NrKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh0aGlzLl9kZXN0cm95RXJyb3IgfHwgbmV3IEVycm9yKCdNdXRleCBoYXMgYmVlbiBkZXN0cm95ZWQnKSkKICAgIH0KICAgIGlmICh0aGlzLmxvY2tlZCkgcmV0dXJuIG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWUpCiAgICB0aGlzLmxvY2tlZCA9IHRydWUKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogIH0KCiAgdW5sb2NrKCkgewogICAgaWYgKCF0aGlzLl9xdWV1ZS5sZW5ndGgpIHsKICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZQogICAgICByZXR1cm4KICAgIH0KICAgIHRoaXMuX3F1ZXVlLnNoaWZ0KClbMF0oKQogIH0KCiAgZGVzdHJveShlcnIpIHsKICAgIGlmICghdGhpcy5fZGVzdHJveWluZykgewogICAgICB0aGlzLl9kZXN0cm95aW5nID0gdGhpcy5sb2NrZWQgPyB0aGlzLmxvY2soKS5jYXRjaCgoKSA9PiB7fSkgOiBQcm9taXNlLnJlc29sdmUoKQogICAgfQoKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgaWYgKGVycikgdGhpcy5fZGVzdHJveUVycm9yID0gZXJyCgogICAgaWYgKGVycikgewogICAgICB3aGlsZSAodGhpcy5fcXVldWUubGVuZ3RoKSB0aGlzLl9xdWV1ZS5zaGlmdCgpWzFdKGVycikKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogIH0KfQpjb25zdCBGSUZPID0gcmVxdWlyZSgnZmFzdC1maWZvJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmVjZWl2ZXJRdWV1ZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnF1ZXVlID0gbmV3IEZJRk8oKQogICAgdGhpcy5wcmlvcml0eSA9IFtdCiAgICB0aGlzLnJlcXVlc3RzID0gbmV3IE1hcCgpCiAgICB0aGlzLmxlbmd0aCA9IDAKICB9CgogIHB1c2gocmVxKSB7CiAgICAvLyBUT0RPOiB1c2UgYSBoZWFwIGF0IHNvbWUgcG9pbnQgaWYgd2Ugd2FubmEgc3VwcG9ydCBtdWx0aXBsZSBwcmlvcwogICAgaWYgKHJlcS5wcmlvcml0eSA+IDApIHRoaXMucHJpb3JpdHkucHVzaChyZXEpCiAgICBlbHNlIHRoaXMucXVldWUucHVzaChyZXEpCgogICAgdGhpcy5yZXF1ZXN0cy5zZXQocmVxLmlkLCByZXEpCiAgICB0aGlzLmxlbmd0aCsrCiAgfQoKICBzaGlmdCgpIHsKICAgIHdoaWxlICh0aGlzLnByaW9yaXR5Lmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbXNnID0gdGhpcy5wcmlvcml0eS5wb3AoKQogICAgICBjb25zdCByZXEgPSB0aGlzLl9wcm9jZXNzUmVxdWVzdChtc2cpCiAgICAgIGlmIChyZXEgIT09IG51bGwpIHJldHVybiByZXEKICAgIH0KCiAgICB3aGlsZSAodGhpcy5xdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG1zZyA9IHRoaXMucXVldWUuc2hpZnQoKQogICAgICBjb25zdCByZXEgPSB0aGlzLl9wcm9jZXNzUmVxdWVzdChtc2cpCiAgICAgIGlmIChyZXEgIT09IG51bGwpIHJldHVybiByZXEKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgX3Byb2Nlc3NSZXF1ZXN0KHJlcSkgewogICAgaWYgKHJlcS5ibG9jayB8fCByZXEuaGFzaCB8fCByZXEuc2VlayB8fCByZXEudXBncmFkZSB8fCByZXEubWFuaWZlc3QpIHsKICAgICAgdGhpcy5yZXF1ZXN0cy5kZWxldGUocmVxLmlkKQogICAgICB0aGlzLmxlbmd0aC0tCiAgICAgIHJldHVybiByZXEKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgY2xlYXIoKSB7CiAgICB0aGlzLnF1ZXVlLmNsZWFyKCkKICAgIHRoaXMucHJpb3JpdHkgPSBbXQogICAgdGhpcy5sZW5ndGggPSAwCiAgICB0aGlzLnJlcXVlc3RzLmNsZWFyKCkKICB9CgogIGRlbGV0ZShpZCkgewogICAgY29uc3QgcmVxID0gdGhpcy5yZXF1ZXN0cy5nZXQoaWQpCiAgICBpZiAoIXJlcSkgcmV0dXJuCgogICAgcmVxLmJsb2NrID0gbnVsbAogICAgcmVxLmhhc2ggPSBudWxsCiAgICByZXEuc2VlayA9IG51bGwKICAgIHJlcS51cGdyYWRlID0gbnVsbAogICAgcmVxLm1hbmlmZXN0ID0gZmFsc2UKCiAgICB0aGlzLnJlcXVlc3RzLmRlbGV0ZShpZCkKICAgIHRoaXMubGVuZ3RoLS0KCiAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5xdWV1ZS5jbGVhcigpCiAgICAgIHRoaXMucHJpb3JpdHkgPSBbXQogICAgfQogIH0KfQpjb25zdCBCaWdTcGFyc2VBcnJheSA9IHJlcXVpcmUoJ2JpZy1zcGFyc2UtYXJyYXknKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJy4vY29tcGF0JykucXVpY2tiaXQKCmNvbnN0IEJJVFNfUEVSX1BBR0UgPSAzMjc2OApjb25zdCBCWVRFU19QRVJfUEFHRSA9IEJJVFNfUEVSX1BBR0UgLyA4CmNvbnN0IFdPUkRTX1BFUl9QQUdFID0gQllURVNfUEVSX1BBR0UgLyA0CmNvbnN0IEJJVFNfUEVSX1NFR01FTlQgPSAyMDk3MTUyCmNvbnN0IEJZVEVTX1BFUl9TRUdNRU5UID0gQklUU19QRVJfU0VHTUVOVCAvIDgKY29uc3QgUEFHRVNfUEVSX1NFR01FTlQgPSBCSVRTX1BFUl9TRUdNRU5UIC8gQklUU19QRVJfUEFHRQoKY2xhc3MgUmVtb3RlQml0ZmllbGRQYWdlIHsKICBjb25zdHJ1Y3RvcihpbmRleCwgYml0ZmllbGQsIHNlZ21lbnQpIHsKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5vZmZzZXQgPSBpbmRleCAqIEJZVEVTX1BFUl9QQUdFIC0gc2VnbWVudC5vZmZzZXQKICAgIHRoaXMuYml0ZmllbGQgPSBiaXRmaWVsZAogICAgdGhpcy5zZWdtZW50ID0gc2VnbWVudAoKICAgIHNlZ21lbnQuYWRkKHRoaXMpCiAgfQoKICBnZXQgdHJlZSgpIHsKICAgIHJldHVybiB0aGlzLnNlZ21lbnQudHJlZQogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZ2V0KHRoaXMuYml0ZmllbGQsIGluZGV4KQogIH0KCiAgc2V0KGluZGV4LCB2YWwpIHsKICAgIGlmIChxdWlja2JpdC5zZXQodGhpcy5iaXRmaWVsZCwgaW5kZXgsIHZhbCkpIHsKICAgICAgdGhpcy50cmVlLnVwZGF0ZSh0aGlzLm9mZnNldCAqIDggKyBpbmRleCkKICAgIH0KICB9CgogIHNldFJhbmdlKHN0YXJ0LCBlbmQsIHZhbCkgewogICAgcXVpY2tiaXQuZmlsbCh0aGlzLmJpdGZpZWxkLCB2YWwsIHN0YXJ0LCBlbmQpCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gMTI4KQogICAgY29uc3QgbiA9IGkgKyBNYXRoLmNlaWwoKGVuZCAtIHN0YXJ0KSAvIDEyOCkKCiAgICB3aGlsZSAoaSA8PSBuKSB0aGlzLnRyZWUudXBkYXRlKHRoaXMub2Zmc2V0ICogOCArIGkrKyAqIDEyOCkKICB9CgogIGZpbmRGaXJzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZEZpcnN0KHRoaXMuYml0ZmllbGQsIHZhbCwgcG9zaXRpb24pCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gcXVpY2tiaXQuZmluZExhc3QodGhpcy5iaXRmaWVsZCwgdmFsLCBwb3NpdGlvbikKICB9CgogIGluc2VydChzdGFydCwgYml0ZmllbGQpIHsKICAgIHRoaXMuYml0ZmllbGQuc2V0KGJpdGZpZWxkLCBzdGFydCAvIDMyKQogICAgdGhpcy5zZWdtZW50LnJlZnJlc2goKQogIH0KCiAgY2xlYXIoc3RhcnQsIGJpdGZpZWxkKSB7CiAgICBxdWlja2JpdC5jbGVhcih0aGlzLmJpdGZpZWxkLCB7IGZpZWxkOiBiaXRmaWVsZCwgb2Zmc2V0OiBzdGFydCB9KQogIH0KfQoKY2xhc3MgUmVtb3RlQml0ZmllbGRTZWdtZW50IHsKICBjb25zdHJ1Y3RvcihpbmRleCkgewogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLm9mZnNldCA9IGluZGV4ICogQllURVNfUEVSX1NFR01FTlQKICAgIHRoaXMudHJlZSA9IHF1aWNrYml0LkluZGV4LmZyb20oW10sIEJZVEVTX1BFUl9TRUdNRU5UKQogICAgdGhpcy5wYWdlcyA9IG5ldyBBcnJheShQQUdFU19QRVJfU0VHTUVOVCkKICAgIHRoaXMucGFnZXNMZW5ndGggPSAwCiAgfQoKICBnZXQgY2h1bmtzKCkgewogICAgcmV0dXJuIHRoaXMudHJlZS5jaHVua3MKICB9CgogIHJlZnJlc2goKSB7CiAgICB0aGlzLnRyZWUgPSBxdWlja2JpdC5JbmRleC5mcm9tKHRoaXMudHJlZS5jaHVua3MsIEJZVEVTX1BFUl9TRUdNRU5UKQogIH0KCiAgYWRkKHBhZ2UpIHsKICAgIGNvbnN0IHBhZ2VJbmRleCA9IHBhZ2UuaW5kZXggLSB0aGlzLmluZGV4ICogUEFHRVNfUEVSX1NFR01FTlQKICAgIGlmIChwYWdlSW5kZXggPj0gdGhpcy5wYWdlc0xlbmd0aCkgdGhpcy5wYWdlc0xlbmd0aCA9IHBhZ2VJbmRleCArIDEKCiAgICB0aGlzLnBhZ2VzW3BhZ2VJbmRleF0gPSBwYWdlCgogICAgY29uc3QgY2h1bmsgPSB7IGZpZWxkOiBwYWdlLmJpdGZpZWxkLCBvZmZzZXQ6IHBhZ2Uub2Zmc2V0IH0KCiAgICB0aGlzLmNodW5rcy5wdXNoKGNodW5rKQoKICAgIGZvciAobGV0IGkgPSB0aGlzLmNodW5rcy5sZW5ndGggLSAyOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwcmV2ID0gdGhpcy5jaHVua3NbaV0KICAgICAgaWYgKHByZXYub2Zmc2V0IDw9IGNodW5rLm9mZnNldCkgYnJlYWsKICAgICAgdGhpcy5jaHVua3NbaV0gPSBjaHVuawogICAgICB0aGlzLmNodW5rc1tpICsgMV0gPSBwcmV2CiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgcG9zaXRpb24gPSB0aGlzLnRyZWUuc2tpcEZpcnN0KCF2YWwsIHBvc2l0aW9uKQoKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIGlmIChpID49IFBBR0VTX1BFUl9TRUdNRU5UKSByZXR1cm4gLTEKCiAgICB3aGlsZSAoaSA8IHRoaXMucGFnZXNMZW5ndGgpIHsKICAgICAgY29uc3QgcCA9IHRoaXMucGFnZXNbaV0KCiAgICAgIGxldCBpbmRleCA9IC0xCgogICAgICBpZiAocCkgaW5kZXggPSBwLmZpbmRGaXJzdCh2YWwsIGopCiAgICAgIGVsc2UgaWYgKCF2YWwpIGluZGV4ID0gagoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIGkgKiBCSVRTX1BFUl9QQUdFICsgaW5kZXgKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgfQoKICAgIHJldHVybiB2YWwgfHwgdGhpcy5wYWdlc0xlbmd0aCA9PT0gUEFHRVNfUEVSX1NFR01FTlQgPyAtMSA6IHRoaXMucGFnZXNMZW5ndGggKiBCSVRTX1BFUl9QQUdFCiAgfQoKICBmaW5kTGFzdCh2YWwsIHBvc2l0aW9uKSB7CiAgICBwb3NpdGlvbiA9IHRoaXMudHJlZS5za2lwTGFzdCghdmFsLCBwb3NpdGlvbikKCiAgICBsZXQgaiA9IHBvc2l0aW9uICYgKEJJVFNfUEVSX1BBR0UgLSAxKQogICAgbGV0IGkgPSAocG9zaXRpb24gLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBpZiAoaSA+PSBQQUdFU19QRVJfU0VHTUVOVCkgcmV0dXJuIC0xCgogICAgd2hpbGUgKGkgPj0gMCkgewogICAgICBjb25zdCBwID0gdGhpcy5wYWdlc1tpXQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChwKSBpbmRleCA9IHAuZmluZExhc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfUEFHRSArIGluZGV4CgogICAgICBqID0gQklUU19QRVJfUEFHRSAtIDEKICAgICAgaS0tCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJlbW90ZUJpdGZpZWxkIHsKICBzdGF0aWMgQklUU19QRVJfUEFHRSA9IEJJVFNfUEVSX1BBR0UKCiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9wYWdlcyA9IG5ldyBCaWdTcGFyc2VBcnJheSgpCiAgICB0aGlzLl9zZWdtZW50cyA9IG5ldyBCaWdTcGFyc2VBcnJheSgpCiAgICB0aGlzLl9tYXhTZWdtZW50cyA9IDAKICB9CgogIGdldEJpdGZpZWxkKGluZGV4KSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQogICAgcmV0dXJuIHAgfHwgbnVsbAogIH0KCiAgZ2V0KGluZGV4KSB7CiAgICBjb25zdCBqID0gaW5kZXggJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBjb25zdCBpID0gKGluZGV4IC0gaikgLyBCSVRTX1BFUl9QQUdFCgogICAgY29uc3QgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIHJldHVybiBwID8gcC5nZXQoaikgOiBmYWxzZQogIH0KCiAgc2V0KGluZGV4LCB2YWwpIHsKICAgIGNvbnN0IGogPSBpbmRleCAmIChCSVRTX1BFUl9QQUdFIC0gMSkKICAgIGNvbnN0IGkgPSAoaW5kZXggLSBqKSAvIEJJVFNfUEVSX1BBR0UKCiAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgIGlmICghcCAmJiB2YWwpIHsKICAgICAgY29uc3QgayA9IE1hdGguZmxvb3IoaSAvIFBBR0VTX1BFUl9TRUdNRU5UKQogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8IHRoaXMuX3NlZ21lbnRzLnNldChrLCBuZXcgUmVtb3RlQml0ZmllbGRTZWdtZW50KGspKQogICAgICBpZiAodGhpcy5fbWF4U2VnbWVudHMgPD0gaykgdGhpcy5fbWF4U2VnbWVudHMgPSBrICsgMQoKICAgICAgcCA9IHRoaXMuX3BhZ2VzLnNldChpLCBuZXcgUmVtb3RlQml0ZmllbGRQYWdlKGksIG5ldyBVaW50MzJBcnJheShXT1JEU19QRVJfUEFHRSksIHMpKQogICAgfQoKICAgIGlmIChwKSBwLnNldChqLCB2YWwpCiAgfQoKICBzZXRSYW5nZShzdGFydCwgZW5kLCB2YWwpIHsKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICBsZXQgcCA9IHRoaXMuX3BhZ2VzLmdldChpKQoKICAgICAgaWYgKCFwICYmIHZhbCkgewogICAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKGkgLyBQQUdFU19QRVJfU0VHTUVOVCkKICAgICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGspIHx8IHRoaXMuX3NlZ21lbnRzLnNldChrLCBuZXcgUmVtb3RlQml0ZmllbGRTZWdtZW50KGspKQogICAgICAgIGlmICh0aGlzLl9tYXhTZWdtZW50cyA8PSBrKSB0aGlzLl9tYXhTZWdtZW50cyA9IGsgKyAxCgogICAgICAgIHAgPSB0aGlzLl9wYWdlcy5zZXQoaSwgbmV3IFJlbW90ZUJpdGZpZWxkUGFnZShpLCBuZXcgVWludDMyQXJyYXkoV09SRFNfUEVSX1BBR0UpLCBzKSkKICAgICAgfQoKICAgICAgY29uc3Qgb2Zmc2V0ID0gaSAqIEJJVFNfUEVSX1BBR0UKICAgICAgY29uc3QgbGFzdCA9IE1hdGgubWluKGVuZCAtIG9mZnNldCwgQklUU19QRVJfUEFHRSkKICAgICAgY29uc3QgcmFuZ2UgPSBsYXN0IC0gagoKICAgICAgaWYgKHApIHAuc2V0UmFuZ2UoaiwgbGFzdCwgdmFsKQoKICAgICAgaiA9IDAKICAgICAgaSsrCiAgICAgIHN0YXJ0ICs9IHJhbmdlCiAgICB9CiAgfQoKICBmaW5kRmlyc3QodmFsLCBwb3NpdGlvbikgewogICAgbGV0IGogPSBwb3NpdGlvbiAmIChCSVRTX1BFUl9TRUdNRU5UIC0gMSkKICAgIGxldCBpID0gKHBvc2l0aW9uIC0gaikgLyBCSVRTX1BFUl9TRUdNRU5UCgogICAgd2hpbGUgKGkgPCB0aGlzLl9tYXhTZWdtZW50cykgewogICAgICBjb25zdCBzID0gdGhpcy5fc2VnbWVudHMuZ2V0KGkpCgogICAgICBsZXQgaW5kZXggPSAtMQoKICAgICAgaWYgKHMpIGluZGV4ID0gcy5maW5kRmlyc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfU0VHTUVOVCArIGluZGV4CgogICAgICBqID0gMAogICAgICBpKysKICAgIH0KCiAgICAvLyBGb3IgdGhlIHZhbCA9PT0gZmFsc2UgY2FzZSwgd2UgYWx3YXlzIHJldHVybiBhdCBsZWFzdAogICAgLy8gdGhlICdwb3NpdGlvbicsIGFsc28gaWYgbm90aGluZyB3YXMgZm91bmQKICAgIHJldHVybiB2YWwgPyAtMSA6IE1hdGgubWF4KHBvc2l0aW9uLCB0aGlzLl9tYXhTZWdtZW50cyAqIEJJVFNfUEVSX1NFR01FTlQpCiAgfQoKICBmaXJzdFNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZEZpcnN0KHRydWUsIHBvc2l0aW9uKQogIH0KCiAgZmlyc3RVbnNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZEZpcnN0KGZhbHNlLCBwb3NpdGlvbikKICB9CgogIGZpbmRMYXN0KHZhbCwgcG9zaXRpb24pIHsKICAgIGxldCBqID0gcG9zaXRpb24gJiAoQklUU19QRVJfU0VHTUVOVCAtIDEpCiAgICBsZXQgaSA9IChwb3NpdGlvbiAtIGopIC8gQklUU19QRVJfU0VHTUVOVAoKICAgIHdoaWxlIChpID49IDApIHsKICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChpKQoKICAgICAgbGV0IGluZGV4ID0gLTEKCiAgICAgIGlmIChzKSBpbmRleCA9IHMuZmluZExhc3QodmFsLCBqKQogICAgICBlbHNlIGlmICghdmFsKSBpbmRleCA9IGoKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBpICogQklUU19QRVJfU0VHTUVOVCArIGluZGV4CgogICAgICBqID0gQklUU19QRVJfU0VHTUVOVCAtIDEKICAgICAgaS0tCiAgICB9CgogICAgcmV0dXJuIC0xCiAgfQoKICBsYXN0U2V0KHBvc2l0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5maW5kTGFzdCh0cnVlLCBwb3NpdGlvbikKICB9CgogIGxhc3RVbnNldChwb3NpdGlvbikgewogICAgcmV0dXJuIHRoaXMuZmluZExhc3QoZmFsc2UsIHBvc2l0aW9uKQogIH0KCiAgaW5zZXJ0KHN0YXJ0LCBiaXRmaWVsZCkgewogICAgaWYgKHN0YXJ0ICUgMzIgIT09IDApIHJldHVybiBmYWxzZQoKICAgIGxldCBsZW5ndGggPSBiaXRmaWVsZC5ieXRlTGVuZ3RoICogOAoKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgICBpZiAoIXApIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fCB0aGlzLl9zZWdtZW50cy5zZXQoaywgbmV3IFJlbW90ZUJpdGZpZWxkU2VnbWVudChrKSkKICAgICAgICBpZiAodGhpcy5fbWF4U2VnbWVudHMgPD0gaykgdGhpcy5fbWF4U2VnbWVudHMgPSBrICsgMQoKICAgICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBSZW1vdGVCaXRmaWVsZFBhZ2UoaSwgbmV3IFVpbnQzMkFycmF5KFdPUkRTX1BFUl9QQUdFKSwgcykpCiAgICAgIH0KCiAgICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKGogKyBsZW5ndGgsIEJJVFNfUEVSX1BBR0UpCiAgICAgIGNvbnN0IHJhbmdlID0gZW5kIC0gagoKICAgICAgcC5pbnNlcnQoaiwgYml0ZmllbGQuc3ViYXJyYXkoMCwgcmFuZ2UgLyAzMikpCgogICAgICBiaXRmaWVsZCA9IGJpdGZpZWxkLnN1YmFycmF5KHJhbmdlIC8gMzIpCgogICAgICBqID0gMAogICAgICBpKysKICAgICAgbGVuZ3RoIC09IHJhbmdlCiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGNsZWFyKHN0YXJ0LCBiaXRmaWVsZCkgewogICAgaWYgKHN0YXJ0ICUgMzIgIT09IDApIHJldHVybiBmYWxzZQoKICAgIGxldCBsZW5ndGggPSBiaXRmaWVsZC5ieXRlTGVuZ3RoICogOAoKICAgIGxldCBqID0gc3RhcnQgJiAoQklUU19QRVJfUEFHRSAtIDEpCiAgICBsZXQgaSA9IChzdGFydCAtIGopIC8gQklUU19QRVJfUEFHRQoKICAgIHdoaWxlIChsZW5ndGggPiAwKSB7CiAgICAgIGxldCBwID0gdGhpcy5fcGFnZXMuZ2V0KGkpCgogICAgICBpZiAoIXApIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihpIC8gUEFHRVNfUEVSX1NFR01FTlQpCiAgICAgICAgY29uc3QgcyA9IHRoaXMuX3NlZ21lbnRzLmdldChrKSB8fCB0aGlzLl9zZWdtZW50cy5zZXQoaywgbmV3IFJlbW90ZUJpdGZpZWxkU2VnbWVudChrKSkKICAgICAgICBpZiAodGhpcy5fbWF4U2VnbWVudHMgPD0gaykgdGhpcy5fbWF4U2VnbWVudHMgPSBrICsgMQoKICAgICAgICBwID0gdGhpcy5fcGFnZXMuc2V0KGksIG5ldyBSZW1vdGVCaXRmaWVsZFBhZ2UoaSwgbmV3IFVpbnQzMkFycmF5KFdPUkRTX1BFUl9QQUdFKSwgcykpCiAgICAgIH0KCiAgICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKGogKyBsZW5ndGgsIEJJVFNfUEVSX1BBR0UpCiAgICAgIGNvbnN0IHJhbmdlID0gZW5kIC0gagoKICAgICAgcC5jbGVhcihqLCBiaXRmaWVsZC5zdWJhcnJheSgwLCByYW5nZSAvIDMyKSkKCiAgICAgIGJpdGZpZWxkID0gYml0ZmllbGQuc3ViYXJyYXkocmFuZ2UgLyAzMikKCiAgICAgIGogPSAwCiAgICAgIGkrKwogICAgICBsZW5ndGggLT0gcmFuZ2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KfQovKiBERVYgRE9DUwogIEV2ZXJ5IGh5cGVyY29yZSBoYXMgb25lIFJlcGxpY2F0b3Igb2JqZWN0IG1hbmFnaW5nIGl0cyBjb25uZWN0aW9ucyB0byBvdGhlciBwZWVycy4KICBUaGVyZSBpcyBvbmUgUGVlciBvYmplY3QgcGVyIHBlZXIgY29ubmVjdGVkIHRvIHRoZSBIeXBlcmNvcmUuCiAgSHlwZXJjb3JlcyBkbyBub3Qga25vdyBhYm91dCBvdGhlciBoeXBlcmNvcmVzLCBzbyB3aGVuIGEgcGVlciBpcyBjb25uZWN0ZWQgdG8gbXVsdGlwbGUgY29yZXMsIHRoZXJlIGV4aXN0cyBvbmUgUGVlciBvYmplY3QgcGVyIGNvcmUuCgogIEh5cGVyY29yZSBpbmRpY2F0ZXMgYmxvY2sgc2hvdWxkIGJlIGRvd25sb2FkZWQgdGhyb3VnaCBtZXRob2RzIGxpa2UgUmVwbGljYXRvci5hZGRSYW5nZSBvciBSZXBsaWNhdG9yLmFkZEJsb2NrCiAgSHlwZXJjb3JlIGNhbGxzIFJlcGxpY2F0b3IudXBkYXRlQWN0aXZpdHkgZXZlcnkgdGltZSBhIGh5cGVyY29yZSBzZXNzaW9uIG9wZW5zL2Nsb3NlcwogIFJlcGxpY2F0b3IudXBkYXRlQWN0aXZpdHkgZW5zdXJlcyB0aGUgSHlwZXJjb3JlIGlzIGRvd25sb2FkaW5nIGJsb2NrcyBhcyBleHBlY3RlZAogIFJlcGxpY2F0b3Iga2VlcHMgdHJhY2sgb2Y6CiAgICAtIFdoaWNoIGJsb2NrcyBuZWVkIHRvIGJlIGRvd25sb2FkZWQgKFJlcGxpY2F0b3IuX2Jsb2NrcykKICAgIC0gV2hpY2ggYmxvY2tzIGN1cnJlbnRseSBoYXZlIGluZmxpZ2h0IHJlcXVlc3RzIChSZXBsaWNhdG9yLl9pbmZsaWdodCkKCiAgQmxvY2tzIGFyZSByZXF1ZXN0ZWQgZnJvbSByZW1vdGUgcGVlcnMgYnkgUGVlciBvYmplY3RzLiBUaGUgZmxvdyBpczoKICAgIC0gVGhlIHJlcGxpY2F0b3IncyB1cGRhdGVQZWVyIG1ldGhvZCBnZXRzIGNhbGxlZAogICAgLSBUaGUgcmVwbGljYXRvciBkZXRlY3RzIHdoZXRoZXIgdGhlIFBlZXIgY2FuIGFjY2VwdCBtb3JlIHJlcXVlc3RzIChmb3IgZXhhbXBsZSBieSBjaGVja2luZyBpZiBpdCdzIG1heGVkIG91dCBvbiBpbmZsaWdodCBibG9ja3MpCiAgICAtIFRoZSByZXBsaWNhdG9yIHRoZW4gdGVsbHMgdGhlIFBlZXIgd2hhdCB0byByZXF1ZXN0IChlLmcuIFBlZXJfcmVxdWVzdFJhbmdlIG9yIFBlZXIuX3JlcXVlc3RCbG9jayBtZXRob2RzKQoKICBUaGUgUGVlciBvYmplY3QgaXMgcmVzcG9uc2libGUgZm9yIHRyYWNraW5nCiAgICAtIFdoaWNoIGJsb2NrcyBkb2VzIHRoZSBQZWVyIGhhdmUgYXZhaWxhYmxlICh0cmFja2VkIGluIHJlbW90ZUJpdGZpZWxkKQogICAgLSBXaGljaCBibG9ja3MgYXJlIHlvdSBhY3RpdmVseSBsb29raW5nIGZvciBmcm9tIHRoaXMgcGVlciAodHJhY2tlZCBpbiBtaXNzaW5nQmxvY2tzKQogICAgLSBIb3cgbWFueSBibG9ja3MgYXJlIGN1cnJlbnRseSBpbmZsaWdodCAodHJhY2tlZCBpbiBpbmZsaWdodCkKICBUaGUgUGVlciB1c2VzIHRoaXMgaW5mb3JtYXRpb24gdG8gZGVjaWRlIHdoaWNoIGJsb2NrcyB0byByZXF1ZXN0IGZyb20gdGhlIHBlZXIgaW4gcmVzcG9uc2UgdG8gX3JlcXVlc3RSYW5nZSByZXF1ZXN0cyBhbmQgdGhlIGxpa2UuCiovCgpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IFJhbmRvbUl0ZXJhdG9yID0gcmVxdWlyZSgncmFuZG9tLWFycmF5LWl0ZXJhdG9yJykKY29uc3QgZmxhdFRyZWUgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBNdXRleCA9IHJlcXVpcmUoJy4vbXV0ZXgnKQpjb25zdCBSZWNlaXZlclF1ZXVlID0gcmVxdWlyZSgnLi9yZWNlaXZlci1xdWV1ZScpCmNvbnN0IEhvdHN3YXBRdWV1ZSA9IHJlcXVpcmUoJy4vaG90c3dhcC1xdWV1ZScpCmNvbnN0IFJlbW90ZUJpdGZpZWxkID0gcmVxdWlyZSgnLi9yZW1vdGUtYml0ZmllbGQnKQpjb25zdCB7IE1lcmtsZVRyZWUgfSA9IHJlcXVpcmUoJy4vbWVya2xlLXRyZWUnKQpjb25zdCB7CiAgUkVRVUVTVF9DQU5DRUxMRUQsCiAgUkVRVUVTVF9USU1FT1VULAogIElOVkFMSURfQ0FQQUJJTElUWSwKICBTTkFQU0hPVF9OT1RfQVZBSUxBQkxFLAogIEFTU0VSVElPTgp9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgY2FwcyA9IHJlcXVpcmUoJy4vY2FwcycpCgpjb25zdCBERUZBVUxUX01BWF9JTkZMSUdIVCA9IFsxNiwgNTEyXQpjb25zdCBTQ0FMRV9MQVRFTkNZID0gNTAKY29uc3QgREVGQVVMVF9TRUdNRU5UX1NJWkUgPSAyNTYgKiAxMDI0ICogOCAvLyAyNTYgS2lCIGluIGJpdHMKY29uc3QgTk9UX0RPV05MT0FESU5HX1NMQUNLID0gKDIwMDAwICsgTWF0aC5yYW5kb20oKSAqIDIwMDAwKSB8IDAKY29uc3QgTUFYX1BFRVJTX1VQR1JBREUgPSAzCmNvbnN0IExBU1RfQkxPQ0tTID0gMjU2CmNvbnN0IE1BWF9SRU1PVEVfU0VHTUVOVFMgPSAyMDQ4Cgpjb25zdCBNQVhfUkFOR0VTID0gNjQKCmNvbnN0IE5PVF9BVkFJTEFCTEUgPSAxCmNvbnN0IElOVkFMSURfUkVRVUVTVCA9IDIKY29uc3QgTUFYX0lOVkFMSURfUkVRVUVTVFMgPSA2NApjb25zdCBNQVhfQkFDS09GRlMgPSBNQVhfSU5WQUxJRF9SRVFVRVNUUyAvIDIKCmNvbnN0IFBSSU9SSVRZID0gewogIE5PUk1BTDogMCwKICBISUdIOiAxLAogIFZFUllfSElHSDogMiwKICBDQU5DRUxMRUQ6IDI1NSAvLyByZXNlcnZlZCB0byBtYXJrIGNhbmNlbGxhdGlvbgp9CgpjbGFzcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yKSB7CiAgICB0aGlzLnJlcGxpY2F0b3IgPSByZXBsaWNhdG9yCiAgICB0aGlzLnJlc29sdmVkID0gZmFsc2UKICAgIHRoaXMucHJvY2Vzc2luZyA9IGZhbHNlCiAgICB0aGlzLnJlZnMgPSBbXQogIH0KCiAgYXR0YWNoKHNlc3Npb24pIHsKICAgIGNvbnN0IHIgPSB7CiAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgIHNlc3Npb24sCiAgICAgIHNpbmRleDogMCwKICAgICAgcmluZGV4OiAwLAogICAgICBzbmFwc2hvdDogdHJ1ZSwKICAgICAgcmVzb2x2ZTogbnVsbCwKICAgICAgcmVqZWN0OiBudWxsLAogICAgICBwcm9taXNlOiBudWxsLAogICAgICB0aW1lb3V0OiBudWxsCiAgICB9CgogICAgci5zaW5kZXggPSBzZXNzaW9uLnB1c2gocikgLSAxCiAgICByLnJpbmRleCA9IHRoaXMucmVmcy5wdXNoKHIpIC0gMQogICAgci5wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHIucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHJldHVybiByCiAgfQoKICBkZXRhY2gociwgZXJyID0gbnVsbCkgewogICAgaWYgKHIuY29udGV4dCAhPT0gdGhpcykgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5fZGV0YWNoKHIpCiAgICB0aGlzLl9jYW5jZWwociwgZXJyKQogICAgdGhpcy5nYygpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9kZXRhY2gocikgewogICAgY29uc3QgcmggPSB0aGlzLnJlZnMucG9wKCkKICAgIGNvbnN0IHNoID0gci5zZXNzaW9uLnBvcCgpCgogICAgaWYgKHIucmluZGV4IDwgdGhpcy5yZWZzLmxlbmd0aCkgdGhpcy5yZWZzWyhyaC5yaW5kZXggPSByLnJpbmRleCldID0gcmgKICAgIGlmIChyLnNpbmRleCA8IHIuc2Vzc2lvbi5sZW5ndGgpIHIuc2Vzc2lvblsoc2guc2luZGV4ID0gci5zaW5kZXgpXSA9IHNoCgogICAgZGVzdHJveVJlcXVlc3RUaW1lb3V0KHIpCiAgICByLmNvbnRleHQgPSBudWxsCgogICAgcmV0dXJuIHIKICB9CgogIGdjKCkgewogICAgaWYgKHRoaXMucmVmcy5sZW5ndGggPT09IDAgJiYgIXRoaXMucHJvY2Vzc2luZykgdGhpcy5fdW5yZWYoKQogIH0KCiAgcHJvY2Vzc2VkKCkgewogICAgdGhpcy5wcm9jZXNzaW5nID0gZmFsc2UKICAgIHRoaXMuZ2MoKQogIH0KCiAgX2NhbmNlbChyLCBlcnIpIHsKICAgIHIucmVqZWN0KGVyciB8fCBSRVFVRVNUX0NBTkNFTExFRCgpKQogIH0KCiAgX3VucmVmKCkgewogICAgLy8gb3ZlcndyaXRlIG1lCiAgfQoKICByZXNvbHZlKHZhbCkgewogICAgdGhpcy5yZXNvbHZlZCA9IHRydWUKICAgIHdoaWxlICh0aGlzLnJlZnMubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9kZXRhY2godGhpcy5yZWZzW3RoaXMucmVmcy5sZW5ndGggLSAxXSkucmVzb2x2ZSh2YWwpCiAgICB9CiAgfQoKICByZWplY3QoZXJyKSB7CiAgICB0aGlzLnJlc29sdmVkID0gdHJ1ZQogICAgd2hpbGUgKHRoaXMucmVmcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2RldGFjaCh0aGlzLnJlZnNbdGhpcy5yZWZzLmxlbmd0aCAtIDFdKS5yZWplY3QoZXJyKQogICAgfQogIH0KCiAgc2V0VGltZW91dChyLCBtcykgewogICAgZGVzdHJveVJlcXVlc3RUaW1lb3V0KHIpCiAgICByLnRpbWVvdXQgPSBzZXRUaW1lb3V0KG9ucmVxdWVzdHRpbWVvdXQsIG1zLCByKQogIH0KfQoKY2xhc3MgQmxvY2tSZXF1ZXN0IGV4dGVuZHMgQXR0YWNoYWJsZSB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvciwgdHJhY2tlciwgaW5kZXgsIHByaW9yaXR5KSB7CiAgICBzdXBlcihyZXBsaWNhdG9yKQoKICAgIHRoaXMuaW5kZXggPSBpbmRleAogICAgdGhpcy5wcmlvcml0eSA9IHByaW9yaXR5CiAgICB0aGlzLmluZmxpZ2h0ID0gW10KICAgIHRoaXMucXVldWVkID0gZmFsc2UKICAgIHRoaXMuaG90c3dhcCA9IG51bGwKICAgIHRoaXMudHJhY2tlciA9IHRyYWNrZXIKICB9CgogIF91bnJlZigpIHsKICAgIHRoaXMucXVldWVkID0gZmFsc2UKCiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLmluZmxpZ2h0KSB7CiAgICAgIHJlcS5wZWVyLl9jYW5jZWxSZXF1ZXN0KHJlcSkKICAgIH0KCiAgICB0aGlzLnRyYWNrZXIucmVtb3ZlKHRoaXMuaW5kZXgpCiAgICByZW1vdmVIb3Rzd2FwKHRoaXMpCiAgfQp9CgpjbGFzcyBSYW5nZVJlcXVlc3QgZXh0ZW5kcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCByYW5nZXMsIHN0YXJ0LCBlbmQsIGxpbmVhciwgaWZBdmFpbGFibGUsIGJsb2NrcykgewogICAgc3VwZXIocmVwbGljYXRvcikKCiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQKICAgIHRoaXMuZW5kID0gZW5kCiAgICB0aGlzLmxpbmVhciA9IGxpbmVhcgogICAgdGhpcy5pZkF2YWlsYWJsZSA9IGlmQXZhaWxhYmxlCiAgICB0aGlzLmJsb2NrcyA9IGJsb2NrcwogICAgdGhpcy5yYW5nZXMgPSByYW5nZXMKICAgIHJhbmdlcy5wdXNoKHRoaXMpCgogICAgaWYgKHRoaXMuZW5kID09PSAtMSkgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX2Fsd2F5c0xhdGVzdEJsb2NrKysKICAgIH0KCiAgICAvLyBBcyBwYXNzZWQgYnkgdGhlIHVzZXIsIGltbXV0CiAgICB0aGlzLnVzZXJTdGFydCA9IHN0YXJ0CiAgICB0aGlzLnVzZXJFbmQgPSBlbmQKICB9CgogIF91bnJlZigpIHsKICAgIGNvbnN0IHJhbmdlSW5kZXggPSB0aGlzLnJhbmdlcy5pbmRleE9mKHRoaXMpCiAgICBpZiAocmFuZ2VJbmRleCA9PT0gLTEpIHJldHVybgoKICAgIGNvbnN0IGggPSB0aGlzLnJhbmdlcy5wb3AoKQogICAgaWYgKGggIT09IHRoaXMpIHsKICAgICAgdGhpcy5yYW5nZXNbcmFuZ2VJbmRleF0gPSBoCiAgICB9CgogICAgaWYgKHRoaXMuZW5kID09PSAtMSkgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX2Fsd2F5c0xhdGVzdEJsb2NrLS0KICAgIH0KICB9CgogIF9jYW5jZWwocikgewogICAgci5yZXNvbHZlKGZhbHNlKQogIH0KfQoKY2xhc3MgVXBncmFkZVJlcXVlc3QgZXh0ZW5kcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCBmb3JrLCBsZW5ndGgpIHsKICAgIHN1cGVyKHJlcGxpY2F0b3IpCgogICAgdGhpcy5mb3JrID0gZm9yawogICAgdGhpcy5sZW5ndGggPSBsZW5ndGgKICAgIHRoaXMuaW5mbGlnaHQgPSBbXQogIH0KCiAgX3VucmVmKCkgewogICAgaWYgKHRoaXMucmVwbGljYXRvci5lYWdlclVwZ3JhZGUgPT09IHRydWUgfHwgdGhpcy5pbmZsaWdodC5sZW5ndGggPiAwKSByZXR1cm4KICAgIHRoaXMucmVwbGljYXRvci5fdXBncmFkZSA9IG51bGwKICB9CgogIF9jYW5jZWwocikgewogICAgci5yZXNvbHZlKGZhbHNlKQogIH0KfQoKY2xhc3MgU2Vla1JlcXVlc3QgZXh0ZW5kcyBBdHRhY2hhYmxlIHsKICBjb25zdHJ1Y3RvcihyZXBsaWNhdG9yLCBzZWVrcywgc2Vla2VyKSB7CiAgICBzdXBlcihyZXBsaWNhdG9yKQoKICAgIHRoaXMuc2Vla2VyID0gc2Vla2VyCiAgICB0aGlzLmluZmxpZ2h0ID0gW10KICAgIHRoaXMuc2Vla3MgPSBzZWVrcwogIH0KCiAgX3VucmVmKCkgewogICAgaWYgKHRoaXMuaW5mbGlnaHQubGVuZ3RoID4gMCkgcmV0dXJuCiAgICBjb25zdCBpID0gdGhpcy5zZWVrcy5pbmRleE9mKHRoaXMpCiAgICBpZiAoaSA9PT0gLTEpIHJldHVybgogICAgY29uc3QgaCA9IHRoaXMuc2Vla3MucG9wKCkKICAgIGlmIChpIDwgdGhpcy5zZWVrcy5sZW5ndGgpIHRoaXMuc2Vla3NbaV0gPSBoCiAgfQp9CgpjbGFzcyBJbmZsaWdodFRyYWNrZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fcmVxdWVzdHMgPSBbXQogICAgdGhpcy5fZnJlZSA9IFtdCiAgICB0aGlzLl9hY3RpdmUgPSAwCiAgfQoKICBnZXQgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9hY3RpdmUgPT09IDAKICB9CgogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3QgcmVxIG9mIHRoaXMuX3JlcXVlc3RzKSB7CiAgICAgIGlmIChyZXEgIT09IG51bGwpIHlpZWxkIHJlcQogICAgfQogIH0KCiAgYWRkKHJlcSkgewogICAgY29uc3QgaWQgPSB0aGlzLl9mcmVlLmxlbmd0aCA/IHRoaXMuX2ZyZWUucG9wKCkgOiB0aGlzLl9yZXF1ZXN0cy5wdXNoKG51bGwpCiAgICByZXEuaWQgPSBpZAogICAgdGhpcy5fcmVxdWVzdHNbaWQgLSAxXSA9IHJlcQogICAgdGhpcy5fYWN0aXZlKysKICAgIHJldHVybiByZXEKICB9CgogIGdldChpZCkgewogICAgcmV0dXJuIGlkIDw9IHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA/IHRoaXMuX3JlcXVlc3RzW2lkIC0gMV0gOiBudWxsCiAgfQoKICByZW1vdmUoaWQsIHJvdW5kdHJpcCkgewogICAgaWYgKGlkID4gdGhpcy5fcmVxdWVzdHMubGVuZ3RoKSByZXR1cm4KICAgIGlmICh0aGlzLl9yZXF1ZXN0c1tpZCAtIDFdKSB0aGlzLl9hY3RpdmUtLQogICAgdGhpcy5fcmVxdWVzdHNbaWQgLSAxXSA9IG51bGwKICAgIGlmIChyb3VuZHRyaXAgPT09IHRydWUpIHRoaXMuX2ZyZWUucHVzaChpZCkKICB9CgogIHJldXNhYmxlKGlkKSB7CiAgICB0aGlzLl9mcmVlLnB1c2goaWQpCiAgfQp9CgpjbGFzcyBCbG9ja1RyYWNrZXIgewogIGNvbnN0cnVjdG9yKHJlcGxpY2F0b3IpIHsKICAgIHRoaXMuX3JlcGxpY2F0b3IgPSByZXBsaWNhdG9yCiAgICB0aGlzLl9tYXAgPSBuZXcgTWFwKCkKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC52YWx1ZXMoKQogIH0KCiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuc2l6ZSA9PT0gMAogIH0KCiAgaGFzKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLmhhcyhpbmRleCkKICB9CgogIGdldChpbmRleCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5nZXQoaW5kZXgpIHx8IG51bGwKICB9CgogIGFkZChpbmRleCwgcHJpb3JpdHkpIHsKICAgIGxldCBiID0gdGhpcy5fbWFwLmdldChpbmRleCkKICAgIGlmIChiKSByZXR1cm4gYgoKICAgIGIgPSBuZXcgQmxvY2tSZXF1ZXN0KHRoaXMuX3JlcGxpY2F0b3IsIHRoaXMsIGluZGV4LCBwcmlvcml0eSkKICAgIHRoaXMuX21hcC5zZXQoaW5kZXgsIGIpCgogICAgcmV0dXJuIGIKICB9CgogIHJlbW92ZShpbmRleCkgewogICAgY29uc3QgYiA9IHRoaXMuZ2V0KGluZGV4KQogICAgdGhpcy5fbWFwLmRlbGV0ZShpbmRleCkKICAgIHJldHVybiBiCiAgfQp9CgpjbGFzcyBSb3VuZHRyaXBRdWV1ZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnF1ZXVlID0gW10KICAgIHRoaXMudGljayA9IDAKICB9CgogIGNsZWFyKCkgewogICAgY29uc3QgaWRzID0gbmV3IEFycmF5KHRoaXMucXVldWUubGVuZ3RoKQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWRzW2ldID0gdGhpcy5xdWV1ZVtpXVsxXQogICAgfQoKICAgIHRoaXMucXVldWUgPSBbXQoKICAgIHJldHVybiBpZHMKICB9CgogIGFkZChpZCkgewogICAgdGhpcy5xdWV1ZS5wdXNoKFsrK3RoaXMudGljaywgaWRdKQogIH0KCiAgZmx1c2godGljaykgewogICAgbGV0IGZsdXNoZWQgPSBudWxsCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLnF1ZXVlW2ldWzBdID4gdGljaykgYnJlYWsKICAgICAgaWYgKGZsdXNoZWQgPT09IG51bGwpIGZsdXNoZWQgPSBbXQogICAgICBmbHVzaGVkLnB1c2godGhpcy5xdWV1ZVtpXVsxXSkKICAgIH0KCiAgICBpZiAoZmx1c2hlZCAhPT0gbnVsbCkgdGhpcy5xdWV1ZS5zcGxpY2UoMCwgZmx1c2hlZC5sZW5ndGgpCiAgICByZXR1cm4gZmx1c2hlZAogIH0KfQoKY2xhc3MgUHJvb2ZSZXF1ZXN0IHsKICBjb25zdHJ1Y3Rvcihtc2csIHByb29mLCBibG9jaywgbWFuaWZlc3QpIHsKICAgIHRoaXMubXNnID0gbXNnCiAgICB0aGlzLnByb29mID0gcHJvb2YKICAgIHRoaXMuYmxvY2sgPSBibG9jawogICAgdGhpcy5tYW5pZmVzdCA9IG1hbmlmZXN0CiAgfQoKICBhc3luYyBmdWxmaWxsKCkgewogICAgaWYgKHRoaXMucHJvb2YgPT09IG51bGwpIHJldHVybiBudWxsCgogICAgY29uc3QgW3Byb29mLCBibG9ja10gPSBhd2FpdCBQcm9taXNlLmFsbChbdGhpcy5wcm9vZi5zZXR0bGUoKSwgdGhpcy5ibG9ja10pCgogICAgaWYgKHRoaXMubWFuaWZlc3QpIHByb29mLm1hbmlmZXN0ID0gdGhpcy5tYW5pZmVzdAogICAgaWYgKCFibG9jayAmJiBwcm9vZi5ibG9jaykgcmV0dXJuIG51bGwKCiAgICBpZiAoYmxvY2spIHByb29mLmJsb2NrLnZhbHVlID0gYmxvY2sKICAgIHJldHVybiBwcm9vZgogIH0KfQoKY2xhc3MgUGVlciB7CiAgY29uc3RydWN0b3IocmVwbGljYXRvciwgcHJvdG9tdXgsIGNoYW5uZWwsIGluZmxpZ2h0UmFuZ2UpIHsKICAgIHRoaXMuY29yZSA9IHJlcGxpY2F0b3IuY29yZQogICAgdGhpcy5yZXBsaWNhdG9yID0gcmVwbGljYXRvcgogICAgdGhpcy5zdHJlYW0gPSBwcm90b211eC5zdHJlYW0KICAgIHRoaXMucHJvdG9tdXggPSBwcm90b211eAogICAgdGhpcy5yZW1vdGVQdWJsaWNLZXkgPSB0aGlzLnN0cmVhbS5yZW1vdGVQdWJsaWNLZXkKICAgIHRoaXMucmVtb3RlU3VwcG9ydHNTZWVrcyA9IGZhbHNlCiAgICB0aGlzLmluZmxpZ2h0UmFuZ2UgPSBpbmZsaWdodFJhbmdlCiAgICB0aGlzLnJlbW90ZVNlZ21lbnRzV2FudGVkID0gbmV3IFNldCgpCiAgICB0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkID0gZmFsc2UKCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlCiAgICB0aGlzLnJlbW92ZWQgPSBmYWxzZQoKICAgIHRoaXMuY2hhbm5lbCA9IGNoYW5uZWwKICAgIHRoaXMuY2hhbm5lbC51c2VyRGF0YSA9IHRoaXMKCiAgICB0aGlzLndpcmVTeW5jID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzBdCiAgICB0aGlzLndpcmVSZXF1ZXN0ID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzFdCiAgICB0aGlzLndpcmVDYW5jZWwgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbMl0KICAgIHRoaXMud2lyZURhdGEgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbM10KICAgIHRoaXMud2lyZU5vRGF0YSA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s0XQogICAgdGhpcy53aXJlV2FudCA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s1XQogICAgdGhpcy53aXJlVW53YW50ID0gdGhpcy5jaGFubmVsLm1lc3NhZ2VzWzZdCiAgICB0aGlzLndpcmVCaXRmaWVsZCA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s3XQogICAgdGhpcy53aXJlUmFuZ2UgPSB0aGlzLmNoYW5uZWwubWVzc2FnZXNbOF0KICAgIHRoaXMud2lyZUV4dGVuc2lvbiA9IHRoaXMuY2hhbm5lbC5tZXNzYWdlc1s5XQoKICAgIC8vIFNhbWUgc3RhdHMgYXMgcmVwbGljYXRvciwgYnV0IGZvciB0aGlzIHNwZWNpZmljIHBlZXIKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHdpcmVTeW5jOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlUmVxdWVzdDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUNhbmNlbDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZURhdGE6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVXYW50OiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlQml0ZmllbGQ6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVSYW5nZTogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUV4dGVuc2lvbjogeyB0eDogMCwgcng6IDAgfSwKICAgICAgaG90c3dhcHM6IDAsCiAgICAgIGludmFsaWREYXRhOiAwLAogICAgICBpbnZhbGlkUmVxdWVzdHM6IDAsCiAgICAgIGJhY2tvZmZzOiAwCiAgICB9CgogICAgdGhpcy5yZWNlaXZlclF1ZXVlID0gbmV3IFJlY2VpdmVyUXVldWUoKQogICAgdGhpcy5yZWNlaXZlckJ1c3kgPSBmYWxzZQoKICAgIC8vIG1vc3Qgb2Z0ZW4gbm90IHVzZWQsIHNvIG1hZGUgb24gZGVtYW5kCiAgICB0aGlzLnJvdW5kdHJpcFF1ZXVlID0gbnVsbAoKICAgIHRoaXMuaW5mbGlnaHQgPSAwCiAgICB0aGlzLmRhdGFQcm9jZXNzaW5nID0gMAoKICAgIHRoaXMuY2FuVXBncmFkZSA9IHRydWUKCiAgICB0aGlzLm5lZWRzU3luYyA9IGZhbHNlCiAgICB0aGlzLnN5bmNzUHJvY2Vzc2luZyA9IDAKICAgIHRoaXMubGFzdFVwZ3JhZGFibGVMZW5ndGggPSAwCiAgICB0aGlzLmxhc3RVcGdyYWRhYmxlRm9yayA9IDAKCiAgICB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoID0gMAoKICAgIC8vIFRPRE86IHR3ZWFrIHBpcGVsaW5pbmcgc28gdGhhdCBkYXRhIHNlbnQgQkVGT1JFIHJlbW90ZU9wZW5lZCBpcyBub3QgY2FwIHZlcmlmaWVkIQogICAgLy8gd2UgbWlnaHQgd2FubmEgdHdlYWsgdGhhdCB3aXRoIHNvbWUgY3J5cHRvLCBpZSB1c2UgdGhlIGNhcCB0byBlbmNyeXB0IGl0Li4uCiAgICAvLyBvciBqdXN0IGJlIGF3YXJlIG9mIHRoYXQsIHRvIG9ubHkgcHVzaCBub24gbGVha3kgZGF0YQoKICAgIHRoaXMucmVtb3RlT3BlbmVkID0gZmFsc2UKICAgIHRoaXMucmVtb3RlQml0ZmllbGQgPSBuZXcgUmVtb3RlQml0ZmllbGQoKQogICAgdGhpcy5taXNzaW5nQmxvY2tzID0gbmV3IFJlbW90ZUJpdGZpZWxkKCkKCiAgICB0aGlzLnB1c2hlZExlbmd0aCA9IDAKCiAgICB0aGlzLnJlbW90ZUZvcmsgPSAwCiAgICB0aGlzLnJlbW90ZUxlbmd0aCA9IDAKICAgIHRoaXMucmVtb3RlQ2FuVXBncmFkZSA9IGZhbHNlCiAgICB0aGlzLnJlbW90ZVVwbG9hZGluZyA9IHRydWUKICAgIHRoaXMucmVtb3RlRG93bmxvYWRpbmcgPSB0cnVlCiAgICB0aGlzLnJlbW90ZVN5bmNlZCA9IGZhbHNlCiAgICB0aGlzLnJlbW90ZUhhc01hbmlmZXN0ID0gZmFsc2UKICAgIHRoaXMucmVtb3RlQWxsb3dQdXNoID0gZmFsc2UKICAgIHRoaXMucmVtb3RlUmVxdWVzdHMgPSBuZXcgTWFwKCkKCiAgICB0aGlzLnNlZ21lbnRzV2FudGVkID0gbmV3IFNldCgpCiAgICB0aGlzLmJyb2FkY2FzdGVkTm9uU3BhcnNlID0gZmFsc2UKCiAgICB0aGlzLmxlbmd0aEFja2VkID0gMAoKICAgIHRoaXMuZXh0ZW5zaW9ucyA9IG5ldyBNYXAoKQogICAgdGhpcy5sYXN0RXh0ZW5zaW9uU2VudCA9ICcnCiAgICB0aGlzLmxhc3RFeHRlbnNpb25SZWN2ID0gJycKCiAgICByZXBsaWNhdG9yLl9pZkF2YWlsYWJsZSsrCiAgICByZXBsaWNhdG9yLl9hY3RpdmUrKwogIH0KCiAgZ2V0IHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5yZW1vdGVCaXRmaWVsZC5maW5kRmlyc3QoZmFsc2UsIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGgpCiAgfQoKICBnZXRNYXhJbmZsaWdodCgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtLnJhd1N0cmVhbQogICAgaWYgKCFzdHJlYW0udWR4KSByZXR1cm4gTWF0aC5taW4odGhpcy5pbmZsaWdodFJhbmdlWzFdLCB0aGlzLmluZmxpZ2h0UmFuZ2VbMF0gKiAzKQoKICAgIGNvbnN0IHNjYWxlID0KICAgICAgc3RyZWFtLnJ0dCA8PSBTQ0FMRV9MQVRFTkNZCiAgICAgICAgPyAxCiAgICAgICAgOiAoc3RyZWFtLnJ0dCAvIFNDQUxFX0xBVEVOQ1kpICogTWF0aC5taW4oMSwgMiAvIHRoaXMucmVwbGljYXRvci5wZWVycy5sZW5ndGgpCiAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgIHRoaXMuaW5mbGlnaHRSYW5nZVswXSwKICAgICAgTWF0aC5yb3VuZChNYXRoLm1pbih0aGlzLmluZmxpZ2h0UmFuZ2VbMV0sIHRoaXMuaW5mbGlnaHRSYW5nZVswXSAqIHNjYWxlKSkKICAgICkKICB9CgogIGdldE1heEhvdHN3YXBJbmZsaWdodCgpIHsKICAgIGNvbnN0IGluZiA9IHRoaXMuZ2V0TWF4SW5mbGlnaHQoKQogICAgcmV0dXJuIE1hdGgubWF4KDE2LCBpbmYgLyAyKQogIH0KCiAgc2lnbmFsVXBncmFkZSgpIHsKICAgIGlmICh0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkICYmICF0aGlzLnJlcGxpY2F0b3IuZnVsbHlEb3dubG9hZGVkKCkpIHsKICAgICAgdGhpcy5mdWxseURvd25sb2FkZWRTaWduYWxlZCA9IGZhbHNlCiAgICB9CiAgICBpZiAodGhpcy5fc2hvdWxkVXBkYXRlQ2FuVXBncmFkZSgpID09PSB0cnVlKSB0aGlzLl91cGRhdGVDYW5VcGdyYWRlQW5kU3luYygpCiAgICBlbHNlIHRoaXMuc2VuZFN5bmMoKQogIH0KCiAgX21hcmtJbmZsaWdodChpbmRleCkgewogICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChpbmRleCwgZmFsc2UpCiAgfQoKICBicm9hZGNhc3RSYW5nZShzdGFydCwgbGVuZ3RoLCBkcm9wKSB7CiAgICBpZiAoIXRoaXMuaXNBY3RpdmUoKSkgcmV0dXJuCgogICAgaWYgKGRyb3ApIHRoaXMuX3VuY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBsZW5ndGgpCiAgICBlbHNlIHRoaXMuX2NsZWFyTG9jYWxSYW5nZShzdGFydCwgbGVuZ3RoKQoKICAgIGNvbnN0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gREVGQVVMVF9TRUdNRU5UX1NJWkUpCiAgICBjb25zdCBmdWxseUNvbnRpZyA9IHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aCA9PT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAoKICAgIGlmICgKICAgICAgc3RhcnQgKyBMQVNUX0JMT0NLUyA8IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggJiYKICAgICAgIXRoaXMucmVtb3RlU2VnbWVudHNXYW50ZWQuaGFzKGkpICYmCiAgICAgICFkcm9wICYmCiAgICAgICFmdWxseUNvbnRpZwogICAgKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGxldCBmb3JjZSA9IGZhbHNlCiAgICBpZiAoZnVsbHlDb250aWcgJiYgIWRyb3ApIHsKICAgICAgc3RhcnQgPSAwCiAgICAgIGxlbmd0aCA9IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgKCiAgICAgIC8vIEFsd2F5cyBzZW5kIHRoZSBicm9hZGNhc3Qgd2hlbiB3ZSBzd2l0Y2ggZnJvbSBzcGFyc2UgdG8gZnVsbHkgY29udGlndW91cywgc28gcmVtb3RlIGtub3dzIHRvbwogICAgICBpZiAoIXRoaXMuZnVsbHlEb3dubG9hZGVkU2lnbmFsZWQpIHsKICAgICAgICB0aGlzLmZ1bGx5RG93bmxvYWRlZFNpZ25hbGVkID0gdHJ1ZQogICAgICAgIGZvcmNlID0gdHJ1ZQogICAgICB9CiAgICB9CgogICAgLy8gVE9ETzogY29uc2lkZXIgYWxzbyBhZGRpbmcgZWFybHktcmV0dXJucyBvbiB0aGUgZHJvcD09PXRydWUgY2FzZQogICAgaWYgKCFmb3JjZSAmJiAhZHJvcCkgewogICAgICAvLyBObyBuZWVkIHRvIGJyb2FkY2FzdCBpZiB0aGUgcmVtb3RlIGFscmVhZHkgaGFzIHRoaXMgcmFuZ2UKCiAgICAgIGlmICh0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoID49IHN0YXJ0ICsgbGVuZ3RoKSByZXR1cm4KCiAgICAgIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgICBpZiAodGhpcy5yZW1vdGVCaXRmaWVsZC5nZXQoc3RhcnQpKSByZXR1cm4KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5yZW1vdGVCaXRmaWVsZC5maXJzdFVuc2V0KHN0YXJ0KSA+PSBzdGFydCArIGxlbmd0aCkgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLndpcmVSYW5nZS5zZW5kKHsKICAgICAgZHJvcCwKICAgICAgc3RhcnQsCiAgICAgIGxlbmd0aAogICAgfSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZVJhbmdlLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVJhbmdlKQogIH0KCiAgZXh0ZW5zaW9uKG5hbWUsIG1lc3NhZ2UpIHsKICAgIHRoaXMud2lyZUV4dGVuc2lvbi5zZW5kKHsgbmFtZTogbmFtZSA9PT0gdGhpcy5sYXN0RXh0ZW5zaW9uU2VudCA/ICcnIDogbmFtZSwgbWVzc2FnZSB9KQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlRXh0ZW5zaW9uLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZUV4dGVuc2lvbikKICAgIHRoaXMubGFzdEV4dGVuc2lvblNlbnQgPSBuYW1lCiAgfQoKICBvbmV4dGVuc2lvbihtZXNzYWdlKSB7CiAgICBjb25zdCBuYW1lID0gbWVzc2FnZS5uYW1lIHx8IHRoaXMubGFzdEV4dGVuc2lvblJlY3YKICAgIHRoaXMubGFzdEV4dGVuc2lvblJlY3YgPSBuYW1lCiAgICBjb25zdCBleHQgPSB0aGlzLmV4dGVuc2lvbnMuZ2V0KG5hbWUpCiAgICBpZiAoZXh0KSB7CiAgICAgIGV4dC5fb25tZXNzYWdlKHsgc3RhcnQ6IDAsIGVuZDogbWVzc2FnZS5tZXNzYWdlLmJ5dGVMZW5ndGgsIGJ1ZmZlcjogbWVzc2FnZS5tZXNzYWdlIH0sIHRoaXMpCiAgICB9CiAgfQoKICBzZW5kU3luYygpIHsKICAgIGlmICh0aGlzLnN5bmNzUHJvY2Vzc2luZyAhPT0gMCkgewogICAgICB0aGlzLm5lZWRzU3luYyA9IHRydWUKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuY29yZS5zdGF0ZS5mb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHsKICAgICAgdGhpcy5jYW5VcGdyYWRlID0gZmFsc2UKICAgIH0KCiAgICB0aGlzLm5lZWRzU3luYyA9IGZhbHNlCgogICAgdGhpcy53aXJlU3luYy5zZW5kKHsKICAgICAgZm9yazogdGhpcy5jb3JlLnN0YXRlLmZvcmssCiAgICAgIGxlbmd0aDogdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwKICAgICAgcmVtb3RlTGVuZ3RoOiB0aGlzLmNvcmUuc3RhdGUuZm9yayA9PT0gdGhpcy5yZW1vdGVGb3JrID8gdGhpcy5yZW1vdGVMZW5ndGggOiAwLAogICAgICBjYW5VcGdyYWRlOiB0aGlzLmNhblVwZ3JhZGUsCiAgICAgIHVwbG9hZGluZzogdHJ1ZSwKICAgICAgZG93bmxvYWRpbmc6IHRoaXMucmVwbGljYXRvci5pc0Rvd25sb2FkaW5nKCksCiAgICAgIGhhc01hbmlmZXN0OiAhIXRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QgJiYgdGhpcy5jb3JlLmNvbXBhdCA9PT0gZmFsc2UsCiAgICAgIGFsbG93UHVzaDogdGhpcy5yZXBsaWNhdG9yLmFsbG93UHVzaAogICAgfSkKICAgIGluY3JlbWVudFR4KHRoaXMuc3RhdHMud2lyZVN5bmMsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlU3luYykKICB9CgogIG9ub3Blbih7IHNlZWtzLCBjYXBhYmlsaXR5IH0pIHsKICAgIGNvbnN0IGV4cGVjdGVkID0gY2Fwcy5yZXBsaWNhdGUoCiAgICAgIHRoaXMuc3RyZWFtLmlzSW5pdGlhdG9yID09PSBmYWxzZSwKICAgICAgdGhpcy5jb3JlLmtleSwKICAgICAgdGhpcy5zdHJlYW0uaGFuZHNoYWtlSGFzaAogICAgKQoKICAgIGlmIChiNGEuZXF1YWxzKGNhcGFiaWxpdHksIGV4cGVjdGVkKSAhPT0gdHJ1ZSkgewogICAgICAvLyBUT0RPOiBjaGFuZ2UgdGhpcyB0byBhIHJlamVjdGlvbiBpbnN0ZWFkLCBsZXNzIGxlYWthZ2UKICAgICAgdGhyb3cgSU5WQUxJRF9DQVBBQklMSVRZKCdSZW1vdGUgc2VudCBhbiBpbnZhbGlkIHJlcGxpY2F0aW9uIGNhcGFiaWxpdHknKQogICAgfQoKICAgIGlmICh0aGlzLnJlbW90ZU9wZW5lZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLnJlbW90ZU9wZW5lZCA9IHRydWUKICAgIHRoaXMucmVtb3RlU3VwcG9ydHNTZWVrcyA9IHNlZWtzCgogICAgdGhpcy5wcm90b211eC5jb3JrKCkKCiAgICB0aGlzLnNlbmRTeW5jKCkKCiAgICBjb25zdCBjb250aWcgPSBNYXRoLm1pbih0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpCiAgICBpZiAoY29udGlnID4gMCkgewogICAgICB0aGlzLmJyb2FkY2FzdFJhbmdlKDAsIGNvbnRpZywgZmFsc2UpCgogICAgICBpZiAoY29udGlnID09PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5icm9hZGNhc3RlZE5vblNwYXJzZSA9IHRydWUKICAgICAgfQogICAgfQoKICAgIHRoaXMucmVwbGljYXRvci5faWZBdmFpbGFibGUtLQogICAgdGhpcy5yZXBsaWNhdG9yLl9hZGRQZWVyKHRoaXMpCgogICAgdGhpcy5wcm90b211eC51bmNvcmsoKQoKICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgfQoKICBvbmNsb3NlKGlzUmVtb3RlKSB7CiAgICAvLyB3ZSBtaWdodCBoYXZlIHNpZ25hbGxlZCB0byB0aGUgcmVtb3RlIHRoYXQgd2UgYXJlIGRvbmUgKGllIG5vdCBkb3dubG9hZGluZykgYW5kIHRoZSByZW1vdGUgbWlnaHQgYWdyZWUgb24gdGhhdAogICAgLy8gaWYgdGhhdCBoYXBwZW5zLCB0aGUgY2hhbm5lbCBtaWdodCBiZSBjbG9zZWQgYnkgdGhlIHJlbW90ZS4gaWYgc28ganVzdCByZW5lZ290aWF0ZSBpdC4KICAgIC8vIFRPRE86IGFkZCBhIENMT1NFX1JFQVNPTiB0byBtdXggdG8gd2UgY2FuIG1ha2UgdGhpcyBjbGVhbmVyLi4uCiAgICBjb25zdCByZW9wZW4gPQogICAgICBpc1JlbW90ZSA9PT0gdHJ1ZSAmJgogICAgICB0aGlzLnJlbW90ZU9wZW5lZCA9PT0gdHJ1ZSAmJgogICAgICB0aGlzLnJlbW90ZURvd25sb2FkaW5nID09PSBmYWxzZSAmJgogICAgICB0aGlzLnJlbW90ZVVwbG9hZGluZyA9PT0gdHJ1ZSAmJgogICAgICB0aGlzLnJlcGxpY2F0b3IuZG93bmxvYWRpbmcgPT09IHRydWUKCiAgICBpZiAodGhpcy5yZW1vdGVPcGVuZWQgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMucmVwbGljYXRvci5faWZBdmFpbGFibGUtLQogICAgICB0aGlzLnJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5yZW1vdGVPcGVuZWQgPSBmYWxzZQogICAgdGhpcy5yZW1vdmVkID0gdHJ1ZQogICAgdGhpcy5yZW1vdGVSZXF1ZXN0cy5jbGVhcigpIC8vIGNhbmNlbCBhbGwKICAgIHRoaXMucmVjZWl2ZXJRdWV1ZS5jbGVhcigpCgogICAgaWYgKHRoaXMucm91bmR0cmlwUXVldWUgIT09IG51bGwpIHsKICAgICAgZm9yIChjb25zdCBpZCBvZiB0aGlzLnJvdW5kdHJpcFF1ZXVlLmNsZWFyKCkpIHRoaXMucmVwbGljYXRvci5faW5mbGlnaHQucmV1c2FibGUoaWQpCiAgICB9CgogICAgdGhpcy5yZXBsaWNhdG9yLl9yZW1vdmVQZWVyKHRoaXMpCgogICAgaWYgKHJlb3BlbikgewogICAgICB0aGlzLnJlcGxpY2F0b3IuX21ha2VQZWVyKHRoaXMucHJvdG9tdXgpCiAgICB9CiAgfQoKICBjbG9zZUlmSWRsZSgpIHsKICAgIGlmICh0aGlzLnJlbW90ZURvd25sb2FkaW5nID09PSBmYWxzZSAmJiB0aGlzLnJlcGxpY2F0b3IuaXNEb3dubG9hZGluZygpID09PSBmYWxzZSkgewogICAgICAvLyBpZGxpbmcsIHNodXQgaXQgZG93bi4uLgogICAgICB0aGlzLmNoYW5uZWwuY2xvc2UoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgYXN5bmMgb25zeW5jKG1zZykgewogICAgY29uc3QgewogICAgICBmb3JrLAogICAgICBsZW5ndGgsCiAgICAgIHJlbW90ZUxlbmd0aCwKICAgICAgY2FuVXBncmFkZSwKICAgICAgdXBsb2FkaW5nLAogICAgICBkb3dubG9hZGluZywKICAgICAgaGFzTWFuaWZlc3QsCiAgICAgIGFsbG93UHVzaAogICAgfSA9IG1zZwoKICAgIGNvbnN0IGxlbmd0aENoYW5nZWQgPSBsZW5ndGggIT09IHRoaXMucmVtb3RlTGVuZ3RoCiAgICBjb25zdCBzYW1lRm9yayA9IGZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrCgogICAgdGhpcy5yZW1vdGVTeW5jZWQgPSB0cnVlCiAgICB0aGlzLnJlbW90ZUZvcmsgPSBmb3JrCiAgICB0aGlzLnJlbW90ZUxlbmd0aCA9IGxlbmd0aAogICAgdGhpcy5yZW1vdGVDYW5VcGdyYWRlID0gY2FuVXBncmFkZQogICAgdGhpcy5yZW1vdGVVcGxvYWRpbmcgPSB1cGxvYWRpbmcKICAgIHRoaXMucmVtb3RlRG93bmxvYWRpbmcgPSBkb3dubG9hZGluZwogICAgdGhpcy5yZW1vdGVIYXNNYW5pZmVzdCA9IGhhc01hbmlmZXN0CiAgICB0aGlzLnJlbW90ZUFsbG93UHVzaCA9IGFsbG93UHVzaAoKICAgIGlmICh0aGlzLmNsb3NlSWZJZGxlKCkpIHJldHVybgoKICAgIHRoaXMubGVuZ3RoQWNrZWQgPSBzYW1lRm9yayA/IHJlbW90ZUxlbmd0aCA6IDAKICAgIHRoaXMuc3luY3NQcm9jZXNzaW5nKysKCiAgICB0aGlzLnJlcGxpY2F0b3IuX3VwZGF0ZUZvcmsodGhpcykKCiAgICBpZiAodGhpcy5yZW1vdGVMZW5ndGggPiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoICYmIHRoaXMubGVuZ3RoQWNrZWQgPT09IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHsKICAgICAgaWYgKHRoaXMucmVwbGljYXRvci5fYWRkVXBncmFkZU1heWJlKCkgIT09IG51bGwpIHRoaXMuX3VwZGF0ZSgpCiAgICB9CgogICAgY29uc3QgdXBncmFkZSA9CiAgICAgIGxlbmd0aENoYW5nZWQgPT09IGZhbHNlIHx8IHNhbWVGb3JrID09PSBmYWxzZQogICAgICAgID8gdGhpcy5jYW5VcGdyYWRlICYmIHNhbWVGb3JrCiAgICAgICAgOiBhd2FpdCB0aGlzLl9jYW5VcGdyYWRlKGxlbmd0aCwgZm9yaykKCiAgICBpZiAobGVuZ3RoID09PSB0aGlzLnJlbW90ZUxlbmd0aCAmJiBmb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgewogICAgICB0aGlzLmNhblVwZ3JhZGUgPSB1cGdyYWRlCiAgICAgIGlmICh1cGdyYWRlKSB7CiAgICAgICAgdGhpcy5sYXN0VXBncmFkYWJsZUZvcmsgPSBmb3JrCiAgICAgICAgdGhpcy5sYXN0VXBncmFkYWJsZUxlbmd0aCA9IGxlbmd0aAogICAgICB9CiAgICB9CgogICAgaWYgKC0tdGhpcy5zeW5jc1Byb2Nlc3NpbmcgIT09IDApIHJldHVybiAvLyBpZSBub3QgbGF0ZXN0CgogICAgaWYgKAogICAgICB0aGlzLm5lZWRzU3luYyA9PT0gdHJ1ZSB8fAogICAgICAodGhpcy5jb3JlLnN0YXRlLmZvcmsgPT09IHRoaXMucmVtb3RlRm9yayAmJiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID4gdGhpcy5yZW1vdGVMZW5ndGgpCiAgICApIHsKICAgICAgdGhpcy5zaWduYWxVcGdyYWRlKCkKICAgIH0KCiAgICB0aGlzLl91cGRhdGUoKQogIH0KCiAgX3Nob3VsZFVwZGF0ZUNhblVwZ3JhZGUoKSB7CiAgICByZXR1cm4gKAogICAgICB0aGlzLmNvcmUuc3RhdGUuZm9yayA9PT0gdGhpcy5yZW1vdGVGb3JrICYmCiAgICAgIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPiB0aGlzLnJlbW90ZUxlbmd0aCAmJgogICAgICB0aGlzLmNhblVwZ3JhZGUgPT09IGZhbHNlICYmCiAgICAgIHRoaXMuc3luY3NQcm9jZXNzaW5nID09PSAwCiAgICApCiAgfQoKICBhc3luYyBfdXBkYXRlQ2FuVXBncmFkZUFuZFN5bmMoKSB7CiAgICBjb25zdCB7IGxlbmd0aCwgZm9yayB9ID0gdGhpcy5jb3JlLnN0YXRlCgogICAgY29uc3QgcmVtb3RlTGVuZ3RoID0gdGhpcy5yZW1vdGVMZW5ndGgKICAgIGNvbnN0IHJlbW90ZUZvcmsgPSB0aGlzLnJlbW90ZUZvcmsKICAgIGNvbnN0IGNhblVwZ3JhZGUgPSBhd2FpdCB0aGlzLl9jYW5VcGdyYWRlKHRoaXMucmVtb3RlTGVuZ3RoLCB0aGlzLnJlbW90ZUZvcmspCgogICAgaWYgKAogICAgICB0aGlzLnN5bmNzUHJvY2Vzc2luZyA+IDAgfHwKICAgICAgbGVuZ3RoICE9PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoIHx8CiAgICAgIGZvcmsgIT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrCiAgICApIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAocmVtb3RlTGVuZ3RoICE9PSB0aGlzLnJlbW90ZUxlbmd0aCB8fCByZW1vdGVGb3JrICE9PSB0aGlzLnJlbW90ZUZvcmspIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAoY2FuVXBncmFkZSA9PT0gdGhpcy5jYW5VcGdyYWRlKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuY2FuVXBncmFkZSA9IGNhblVwZ3JhZGUKICAgIGlmIChjYW5VcGdyYWRlKSB7CiAgICAgIHRoaXMubGFzdFVwZ3JhZGFibGVMZW5ndGggPSB0aGlzLnJlbW90ZUxlbmd0aAogICAgICB0aGlzLmxhc3RVcGdyYWRhYmxlRm9yayA9IHRoaXMucmVtb3RlRm9yawogICAgfQoKICAgIHRoaXMuc2VuZFN5bmMoKQogIH0KCiAgLy8gU2FmZSB0byBjYWxsIGluIHRoZSBiYWNrZ3JvdW5kIC0gbmV2ZXIgZmFpbHMKICBhc3luYyBfY2FuVXBncmFkZShyZW1vdGVMZW5ndGgsIHJlbW90ZUZvcmspIHsKICAgIGlmIChyZW1vdGVGb3JrICE9PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHJlbW90ZUxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWUKICAgIGlmIChyZW1vdGVMZW5ndGggPj0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkgcmV0dXJuIGZhbHNlCgogICAgdHJ5IHsKICAgICAgLy8gUmVseSBvbiBjYWNoaW5nIHRvIG1ha2Ugc3VyZSB0aGlzIGlzIGNoZWFwLi4uCiAgICAgIGNvbnN0IGNhblVwZ3JhZGUgPSBhd2FpdCBNZXJrbGVUcmVlLnVwZ3JhZGVhYmxlKHRoaXMuY29yZS5zdGF0ZSwgcmVtb3RlTGVuZ3RoKQoKICAgICAgaWYgKHJlbW90ZUZvcmsgIT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrKSByZXR1cm4gZmFsc2UKCiAgICAgIHJldHVybiBjYW5VcGdyYWRlCiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyBfZ2V0UHJvb2YoYmF0Y2gsIG1zZywgcHVzaGluZykgewogICAgbGV0IGJsb2NrID0gbnVsbAoKICAgIGlmIChtc2cuYmxvY2spIHsKICAgICAgY29uc3QgaW5kZXggPSBtc2cuYmxvY2suaW5kZXgKCiAgICAgIGlmICghcHVzaGluZyAmJiAobXNnLmZvcmsgIT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrIHx8ICF0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSkpIHsKICAgICAgICByZXR1cm4gbmV3IFByb29mUmVxdWVzdChtc2csIG51bGwsIG51bGwsIG51bGwpCiAgICAgIH0KCiAgICAgIGJsb2NrID0gYmF0Y2guZ2V0QmxvY2soaW5kZXgpCiAgICAgIGJsb2NrLmNhdGNoKG5vb3ApCiAgICB9CgogICAgY29uc3QgbWFuaWZlc3QgPSBtc2cubWFuaWZlc3QgJiYgIXRoaXMuY29yZS5jb21wYXQgPyB0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0IDogbnVsbAoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHByb29mID0gYXdhaXQgTWVya2xlVHJlZS5wcm9vZih0aGlzLmNvcmUuc3RhdGUsIGJhdGNoLCBtc2cpCiAgICAgIHJldHVybiBuZXcgUHJvb2ZSZXF1ZXN0KG1zZywgcHJvb2YsIGJsb2NrLCBtYW5pZmVzdCkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBiYXRjaC5kZXN0cm95KCkKCiAgICAgIHRoaXMucmVwbGljYXRvci5fb25pbnZhbGlkcmVxdWVzdChlcnIsIG1zZywgdGhpcykKCiAgICAgIGlmICh0aGlzLnN0YXRzLmludmFsaWRSZXF1ZXN0cyA+PSBNQVhfSU5WQUxJRF9SRVFVRVNUUykgdGhyb3cgZXJyCgogICAgICBhd2FpdCBiYWNrb2ZmKHRoaXMuc3RhdHMuaW52YWxpZFJlcXVlc3RzKQogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgYXN5bmMgb25yZXF1ZXN0KG1zZykgewogICAgY29uc3Qgc2l6ZSA9IHRoaXMucmVtb3RlUmVxdWVzdHMuc2l6ZQogICAgdGhpcy5yZW1vdGVSZXF1ZXN0cy5zZXQobXNnLmlkLCBtc2cpCgogICAgLy8gaWYgc2l6ZSBkaWRudCBjaGFuZ2UgLT4gaWQgb3ZlcndyaXRlIC0+IG9sZCBvbmUgaXMgZGVsZXRlZCwgY2FuY2VsIGN1cnJlbnQgYW5kIHJlLWFkZAogICAgaWYgKHNpemUgPT09IHRoaXMucmVtb3RlUmVxdWVzdHMuc2l6ZSkgewogICAgICB0aGlzLl9jYW5jZWwobXNnLmlkKQogICAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLnNldChtc2cuaWQsIG1zZykKICAgIH0KCiAgICBpZiAoIXRoaXMucHJvdG9tdXguZHJhaW5lZCB8fCB0aGlzLnJlY2VpdmVyUXVldWUubGVuZ3RoKSB7CiAgICAgIHRoaXMucmVjZWl2ZXJRdWV1ZS5wdXNoKG1zZykKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMucmVwbGljYXRvci5kZXN0cm95ZWQpIHJldHVybgoKICAgIGF3YWl0IHRoaXMuX2hhbmRsZVJlcXVlc3QobXNnKQogIH0KCiAgb25jYW5jZWwobXNnKSB7CiAgICB0aGlzLl9jYW5jZWwobXNnLnJlcXVlc3QpCiAgfQoKICBfY2FuY2VsKGlkKSB7CiAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLmRlbGV0ZShpZCkKICAgIHRoaXMucmVjZWl2ZXJRdWV1ZS5kZWxldGUoaWQpCiAgfQoKICBvbmRyYWluKCkgewogICAgcmV0dXJuIHRoaXMuX2hhbmRsZVJlcXVlc3RzKCkKICB9CgogIGFzeW5jIF9oYW5kbGVSZXF1ZXN0cygpIHsKICAgIGlmICh0aGlzLnJlY2VpdmVyQnVzeSB8fCB0aGlzLnJlcGxpY2F0b3IuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMucmVjZWl2ZXJCdXN5ID0gdHJ1ZQogICAgdGhpcy5wcm90b211eC5jb3JrKCkKCiAgICB3aGlsZSAoCiAgICAgIHRoaXMucmVtb3RlT3BlbmVkICYmCiAgICAgIHRoaXMucHJvdG9tdXguZHJhaW5lZCAmJgogICAgICB0aGlzLnJlY2VpdmVyUXVldWUubGVuZ3RoID4gMCAmJgogICAgICAhdGhpcy5yZW1vdmVkCiAgICApIHsKICAgICAgY29uc3QgbXNnID0gdGhpcy5yZWNlaXZlclF1ZXVlLnNoaWZ0KCkKICAgICAgYXdhaXQgdGhpcy5faGFuZGxlUmVxdWVzdChtc2cpCiAgICB9CgogICAgdGhpcy5wcm90b211eC51bmNvcmsoKQogICAgdGhpcy5yZWNlaXZlckJ1c3kgPSBmYWxzZQogIH0KCiAgYXN5bmMgcHVzaChpbmRleCkgewogICAgaWYgKCF0aGlzLnJlbW90ZUFsbG93UHVzaCkgcmV0dXJuCiAgICBpZiAodGhpcy5jb3JlLnN0YXRlLmZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgcmV0dXJuCiAgICBpZiAodGhpcy5yZW1vdGVCaXRmaWVsZC5nZXQoaW5kZXgpKSByZXR1cm4KCiAgICBjb25zdCBtc2cgPSB7CiAgICAgIGlkOiAwLAogICAgICBmb3JrOiB0aGlzLmNvcmUuc3RhdGUuZm9yaywKICAgICAgYmxvY2s6IG51bGwsCiAgICAgIGhhc2g6IG51bGwsCiAgICAgIHNlZWs6IG51bGwsCiAgICAgIHVwZ3JhZGU6IG51bGwsCiAgICAgIG1hbmlmZXN0OiB0aGlzLnJlbW90ZUxlbmd0aCA9PT0gMCwKICAgICAgcHJpb3JpdHk6IDAKICAgIH0KCiAgICBjb25zdCByZW1vdGVMZW5ndGggPSBNYXRoLm1heCh0aGlzLnJlbW90ZUxlbmd0aCwgdGhpcy5wdXNoZWRMZW5ndGgpCgogICAgbXNnLmJsb2NrID0gewogICAgICBpbmRleCwKICAgICAgbm9kZXM6IE1lcmtsZVRyZWUubWF4TWlzc2luZ05vZGVzKDIgKiBpbmRleCwgcmVtb3RlTGVuZ3RoKQogICAgfQoKICAgIGlmIChpbmRleCA+PSB0aGlzLnJlbW90ZUxlbmd0aCkgewogICAgICBtc2cudXBncmFkZSA9IHsKICAgICAgICBzdGFydDogcmVtb3RlTGVuZ3RoLAogICAgICAgIGxlbmd0aDogdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCAtIHJlbW90ZUxlbmd0aAogICAgICB9CiAgICB9CgogICAgbGV0IHJlcSA9IG51bGwKICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jb3JlLnN0b3JhZ2UucmVhZCgpCiAgICB0cnkgewogICAgICByZXEgPSBhd2FpdCB0aGlzLl9nZXRQcm9vZihiYXRjaCwgbXNnLCB0cnVlKQogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybgogICAgYmF0Y2gudHJ5Rmx1c2goKQoKICAgIGF3YWl0IHRoaXMuX2Z1bGZpbGxSZXF1ZXN0KHJlcSwgdHJ1ZSkKICB9CgogIGFzeW5jIF9oYW5kbGVSZXF1ZXN0KG1zZykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLmNvcmUuc3RvcmFnZS5yZWFkKCkKCiAgICAvLyBUT0RPOiBjb3VsZCBzdGlsbCBiZSBhbnN3ZXJhYmxlIGlmIChpbmRleCwgZm9yaykgaXMgYW4gYW5jZXN0b3Igb2YgdGhlIGN1cnJlbnQgZm9yawogICAgY29uc3QgcmVxID0KICAgICAgbXNnLmZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrCiAgICAgICAgPyBhd2FpdCB0aGlzLl9nZXRQcm9vZihiYXRjaCwgbXNnLCBmYWxzZSkKICAgICAgICA6IG5ldyBQcm9vZlJlcXVlc3QobXNnLCBudWxsLCBudWxsLCBudWxsKQoKICAgIGlmIChyZXEgPT09IG51bGwpIHsKICAgICAgdGhpcy53aXJlTm9EYXRhLnNlbmQoeyByZXF1ZXN0OiBtc2cuaWQsIHJlYXNvbjogSU5WQUxJRF9SRVFVRVNUIH0pCiAgICAgIHJldHVybgogICAgfQoKICAgIGJhdGNoLnRyeUZsdXNoKCkKCiAgICBhd2FpdCB0aGlzLl9mdWxmaWxsUmVxdWVzdChyZXEsIGZhbHNlKQogIH0KCiAgYXN5bmMgX2Z1bGZpbGxSZXF1ZXN0KHJlcSwgcHVzaGluZykgewogICAgY29uc3QgcHJvb2YgPSBhd2FpdCByZXEuZnVsZmlsbCgpCgogICAgaWYgKCFwdXNoaW5nKSB7CiAgICAgIC8vIGlmIGNhbmNlbGxlZCBkbyBub3QgcmVwbHkKICAgICAgaWYgKHRoaXMucmVtb3RlUmVxdWVzdHMuZ2V0KHJlcS5tc2cuaWQpICE9PSByZXEubXNnKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIHN5bmMgZnJvbSBub3cgb24sIHNvIHNhZmUgdG8gZGVsZXRlIGZyb20gdGhlIG1hcAogICAgICB0aGlzLnJlbW90ZVJlcXVlc3RzLmRlbGV0ZShyZXEubXNnLmlkKQogICAgfSBlbHNlIGlmICghdGhpcy5yZW1vdGVBbGxvd1B1c2gpIHsKICAgICAgLy8gaWYgcHVzaGluZyBidXQgcmVtb3RlIGRpc2FibGVkIGl0LCBqdXN0IGRyb3AgaXQKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKCF0aGlzLmlzQWN0aXZlKCkgJiYgcHJvb2YuYmxvY2sgIT09IG51bGwpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHByb29mID09PSBudWxsKSB7CiAgICAgIGlmIChyZXEubXNnLm1hbmlmZXN0ICYmIHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QpIHsKICAgICAgICBjb25zdCBtYW5pZmVzdCA9IHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QKICAgICAgICB0aGlzLndpcmVEYXRhLnNlbmQoewogICAgICAgICAgcmVxdWVzdDogcmVxLm1zZy5pZCwKICAgICAgICAgIGZvcms6IHRoaXMuY29yZS5zdGF0ZS5mb3JrLAogICAgICAgICAgYmxvY2s6IG51bGwsCiAgICAgICAgICBoYXNoOiBudWxsLAogICAgICAgICAgc2VlazogbnVsbCwKICAgICAgICAgIHVwZ3JhZGU6IG51bGwsCiAgICAgICAgICBtYW5pZmVzdAogICAgICAgIH0pCiAgICAgICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlRGF0YSwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVEYXRhKQogICAgICAgIHJldHVybgogICAgICB9CgogICAgICB0aGlzLndpcmVOb0RhdGEuc2VuZCh7IHJlcXVlc3Q6IHJlcS5tc2cuaWQsIHJlYXNvbjogTk9UX0FWQUlMQUJMRSB9KQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocHJvb2YuYmxvY2sgIT09IG51bGwpIHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbnVwbG9hZChwcm9vZi5ibG9jay5pbmRleCwgcHJvb2YuYmxvY2sudmFsdWUuYnl0ZUxlbmd0aCwgdGhpcykKICAgIH0KCiAgICBpZiAocHJvb2YudXBncmFkZSkgewogICAgICBjb25zdCByZW1vdGVMZW5ndGggPSBwcm9vZi51cGdyYWRlLnN0YXJ0ICsgcHJvb2YudXBncmFkZS5sZW5ndGgKICAgICAgaWYgKHJlbW90ZUxlbmd0aCA+IHRoaXMucHVzaGVkTGVuZ3RoKSB0aGlzLnB1c2hlZExlbmd0aCA9IHJlbW90ZUxlbmd0aAogICAgfQoKICAgIHRoaXMud2lyZURhdGEuc2VuZCh7CiAgICAgIHJlcXVlc3Q6IHJlcS5tc2cuaWQsCiAgICAgIGZvcms6IHJlcS5tc2cuZm9yaywKICAgICAgYmxvY2s6IHByb29mLmJsb2NrLAogICAgICBoYXNoOiBwcm9vZi5oYXNoLAogICAgICBzZWVrOiBwcm9vZi5zZWVrLAogICAgICB1cGdyYWRlOiBwcm9vZi51cGdyYWRlLAogICAgICBtYW5pZmVzdDogcHJvb2YubWFuaWZlc3QKICAgIH0pCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVEYXRhLCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZURhdGEpCiAgfQoKICBfY2FuY2VsUmVxdWVzdChyZXEpIHsKICAgIGlmIChyZXEucHJpb3JpdHkgPT09IFBSSU9SSVRZLkNBTkNFTExFRCkgcmV0dXJuCiAgICAvLyBtYXJrIGFzIGNhbmNlbGxlZCBhbHNvIGFuZCBhdm9pZCByZS1lbnRyeQogICAgcmVxLnByaW9yaXR5ID0gUFJJT1JJVFkuQ0FOQ0VMTEVECgogICAgdGhpcy5pbmZsaWdodC0tCiAgICB0aGlzLnJlcGxpY2F0b3IuX3JlcXVlc3REb25lKHJlcS5pZCwgZmFsc2UpCgogICAgLy8gY2xlYXIgaW5mbGlnaHQgc3RhdGUKICAgIGlmIChpc0Jsb2NrUmVxdWVzdChyZXEpKSB0aGlzLnJlcGxpY2F0b3IuX3VubWFya0luZmxpZ2h0KHJlcS5ibG9jay5pbmRleCkKICAgIGlmIChpc1VwZ3JhZGVSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fY2xlYXJJbmZsaWdodFVwZ3JhZGUocmVxKQoKICAgIGlmICh0aGlzLnJvdW5kdHJpcFF1ZXVlID09PSBudWxsKSB0aGlzLnJvdW5kdHJpcFF1ZXVlID0gbmV3IFJvdW5kdHJpcFF1ZXVlKCkKICAgIHRoaXMucm91bmR0cmlwUXVldWUuYWRkKHJlcS5pZCkKICAgIHRoaXMud2lyZUNhbmNlbC5zZW5kKHsgcmVxdWVzdDogcmVxLmlkIH0pCiAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVDYW5jZWwsIHRoaXMucmVwbGljYXRvci5zdGF0cy53aXJlQ2FuY2VsKQogIH0KCiAgX2NoZWNrSWZDb25mbGljdCgpIHsKICAgIHRoaXMucGF1c2VkID0gdHJ1ZQoKICAgIGNvbnN0IGxlbmd0aCA9IE1hdGgubWluKHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgsIHRoaXMucmVtb3RlTGVuZ3RoKQogICAgaWYgKGxlbmd0aCA9PT0gMCkgcmV0dXJuIC8vIHBhdXNlIGFuZCBpZ25vcmUKCiAgICB0aGlzLndpcmVSZXF1ZXN0LnNlbmQoewogICAgICBpZDogMCwgLy8gVE9ETzogdXNlIGFuIG1vcmUgZXhwbGljaXQgaWQgZm9yIHRoaXMgZXZlbnR1YWxseS4uLgogICAgICBmb3JrOiB0aGlzLnJlbW90ZUZvcmssCiAgICAgIGJsb2NrOiBudWxsLAogICAgICBoYXNoOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOiB7CiAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgbGVuZ3RoCiAgICAgIH0KICAgIH0pCgogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlUmVxdWVzdCwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVSZXF1ZXN0KQogIH0KCiAgX3VubWFya0luZmxpZ2h0QmxvY2tSZXF1ZXN0KHJlcSwgZGF0YSkgewogICAgaWYgKGlzQmxvY2tSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fdW5tYXJrSW5mbGlnaHQocmVxLmJsb2NrLmluZGV4KQogICAgZWxzZSBpZiAoZGF0YS5ibG9jayAmJiAhcmVxKSB0aGlzLnJlcGxpY2F0b3IuX3VubWFya0luZmxpZ2h0KGRhdGEuYmxvY2suaW5kZXgpCiAgfQoKICBhc3luYyBvbmRhdGEoZGF0YSkgewogICAgaWYgKGRhdGEucmVxdWVzdCAhPT0gMCkgcmV0dXJuIHRoaXMuX2hhbmRsZURhdGEoZGF0YSkKCiAgICBhd2FpdCB0aGlzLnJlcGxpY2F0b3IuX3B1c2hMb2NrLmxvY2soKQogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5faGFuZGxlRGF0YShkYXRhKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5yZXBsaWNhdG9yLl9wdXNoTG9jay51bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX2hhbmRsZURhdGEoZGF0YSkgewogICAgLy8gYWx3YXlzIGFsbG93IGEgZm9yayBjb25mbGljdCBwcm9vZiB0byBiZSBzZW50CiAgICBpZiAoZGF0YS5yZXF1ZXN0ID09PSAwICYmIGRhdGEudXBncmFkZSAmJiBkYXRhLnVwZ3JhZGUuc3RhcnQgPT09IDApIHsKICAgICAgaWYgKGF3YWl0IHRoaXMuY29yZS5jaGVja0NvbmZsaWN0KGRhdGEsIHRoaXMpKSByZXR1cm4KICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZQogICAgfQoKICAgIGNvbnN0IHJlcSA9IGRhdGEucmVxdWVzdCA+IDAgPyB0aGlzLnJlcGxpY2F0b3IuX2luZmxpZ2h0LmdldChkYXRhLnJlcXVlc3QpIDogbnVsbAogICAgY29uc3QgcmVvcmcgPSBkYXRhLmZvcmsgPiB0aGlzLmNvcmUuc3RhdGUuZm9yawoKICAgIC8vIG5vIHB1c2ggYXRtLCBUT0RPOiBjaGVjayBpZiB0aGlzIHNhdGlzZmllcyBhbm90aGVyIHBlbmRpbmcgcmVxdWVzdAogICAgLy8gYWxsb3cgcmVvcmcgcHVzaGVzIHRobyBhcyB0aG9zZSBhcmUgbm90IHdyaXR0ZW4gdG8gc3RvcmFnZSBzbyB3ZSdsbCB0YWtlIGFsbCB0aGUgaGVscCB3ZSBjYW4gZ2V0CiAgICBpZiAocmVxID09PSBudWxsICYmIHJlb3JnID09PSBmYWxzZSAmJiAhdGhpcy5yZXBsaWNhdG9yLmFsbG93UHVzaCkgewogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAocmVxID09PSBudWxsICYmIHJlb3JnID09PSBmYWxzZSAmJiBkYXRhLmJsb2NrKSB7CiAgICAgIC8vIG1hcmsgdGhpcyBhcyBpbmZsaWdodCB0byBhdm9pZCBwYXJhbGxlbCByZXF1ZXN0cwogICAgICB0aGlzLnJlcGxpY2F0b3IuX21hcmtJbmZsaWdodChkYXRhLmJsb2NrLmluZGV4KQogICAgfQoKICAgIGlmIChyZXEgIT09IG51bGwpIHsKICAgICAgaWYgKHJlcS5wZWVyICE9PSB0aGlzKSByZXR1cm4KICAgICAgdGhpcy5fb25yZXF1ZXN0cm91bmR0cmlwKHJlcSkKICAgIH0KCiAgICB0cnkgewogICAgICBpZiAocmVvcmcgPT09IHRydWUpIHJldHVybiBhd2FpdCB0aGlzLnJlcGxpY2F0b3IuX29ucmVvcmdkYXRhKHRoaXMsIHJlcSwgZGF0YSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIHRoaXMuX3VubWFya0luZmxpZ2h0QmxvY2tSZXF1ZXN0KHJlcSwgZGF0YSkKCiAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZQogICAgICB0aGlzLnJlcGxpY2F0b3IuX29uaW52YWxpZGRhdGEoZXJyLCByZXEsIGRhdGEsIHRoaXMpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuZGF0YVByb2Nlc3NpbmcrKwogICAgaWYgKGlzQmxvY2tSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fbWFya1Byb2Nlc3NpbmcocmVxLmJsb2NrLmluZGV4KQoKICAgIHRyeSB7CiAgICAgIGlmICghdGhpcy5yZXBsaWNhdG9yLl9tYXRjaGluZ1JlcXVlc3QocmVxLCBkYXRhKSB8fCAhKGF3YWl0IHRoaXMuY29yZS52ZXJpZnkoZGF0YSwgdGhpcykpKSB7CiAgICAgICAgdGhpcy5yZXBsaWNhdG9yLl9vbm5vZGF0YSh0aGlzLCByZXEsIDApCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIHRoaXMuX3VubWFya0luZmxpZ2h0QmxvY2tSZXF1ZXN0KHJlcSwgZGF0YSkKCiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ1dSSVRFX0ZBSUxFRCcpIHsKICAgICAgICAvLyBGb3IgZXhhbXBsZSwgd2UgZG9uJ3Qgd2FudCB0byBrZWVwIHB1bGxpbmcgZGF0YSB3aGVuIHN0b3JhZ2UgaXMgZnVsbAogICAgICAgIC8vIFRPRE86IG5vdGlmeSB0aGUgdXNlciBzb21laG93CiAgICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNvcmUuY2xvc2VkICYmICFpc0NyaXRpY2FsRXJyb3IoZXJyKSkgcmV0dXJuCgogICAgICBpZiAoZXJyLmNvZGUgIT09ICdJTlZBTElEX09QRVJBVElPTicpIHsKICAgICAgICAvLyBtaWdodCBiZSBhIGZvcmssIHZlcmlmeQogICAgICAgIHRoaXMuX2NoZWNrSWZDb25mbGljdCgpCiAgICAgIH0KCiAgICAgIC8vIGlmIHB1c2ggbW9kZSwgd2UgTUlHSFQgZ2V0IGFuIG9jY2FzaW9uYWwgYmFkIG1lc3NhZ2UKICAgICAgLy8gbm8gbmVlZCB0byBtZWdhIGJhaWwgZm9yIHRoYXQuIFRPRE86IHJhdGUgbGltaXQgaW5zdGVhZCBhcyBhIGdlbmVyYWwgdGhpbmcKICAgICAgaWYgKCF0aGlzLnJlcGxpY2F0b3IuYWxsb3dQdXNoKSB7CiAgICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlCiAgICAgIH0KCiAgICAgIHRoaXMucmVwbGljYXRvci5fb25ub2RhdGEodGhpcywgcmVxLCAwKQogICAgICB0aGlzLnJlcGxpY2F0b3IuX29uaW52YWxpZGRhdGEoZXJyLCByZXEsIGRhdGEsIHRoaXMpCiAgICAgIHJldHVybgogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKGlzQmxvY2tSZXF1ZXN0KHJlcSkpIHRoaXMucmVwbGljYXRvci5fbWFya1Byb2Nlc3NlZChyZXEuYmxvY2suaW5kZXgpCiAgICAgIHRoaXMuZGF0YVByb2Nlc3NpbmctLQogICAgfQoKICAgIHRoaXMucmVwbGljYXRvci5fb25kYXRhKHRoaXMsIHJlcSwgZGF0YSkKCiAgICBpZiAodGhpcy5fc2hvdWxkVXBkYXRlQ2FuVXBncmFkZSgpID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX3VwZGF0ZUNhblVwZ3JhZGVBbmRTeW5jKCkKICAgIH0KICB9CgogIG9ubm9kYXRhKHsgcmVxdWVzdCwgcmVhc29uIH0pIHsKICAgIGNvbnN0IHJlcSA9IHJlcXVlc3QgPiAwID8gdGhpcy5yZXBsaWNhdG9yLl9pbmZsaWdodC5nZXQocmVxdWVzdCkgOiBudWxsCgogICAgaWYgKHJlcSA9PT0gbnVsbCB8fCByZXEucGVlciAhPT0gdGhpcykgewogICAgICB0aGlzLnJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5fb25yZXF1ZXN0cm91bmR0cmlwKHJlcSkKICAgIHRoaXMucmVwbGljYXRvci5fb25ub2RhdGEodGhpcywgcmVxLCByZWFzb24pCiAgfQoKICBfb25yZXF1ZXN0cm91bmR0cmlwKHJlcSkgewogICAgaWYgKHJlcS5wcmlvcml0eSA9PT0gUFJJT1JJVFkuQ0FOQ0VMTEVEKSByZXR1cm4KICAgIC8vIHRvIGF2b2lkIHJlLWVudHJ5IHdlIGFsc28ganVzdCBtYXJrIGl0IGFzIGNhbmNlbGxlZAogICAgcmVxLnByaW9yaXR5ID0gUFJJT1JJVFkuQ0FOQ0VMTEVECgogICAgdGhpcy5pbmZsaWdodC0tCiAgICB0aGlzLnJlcGxpY2F0b3IuX3JlcXVlc3REb25lKHJlcS5pZCwgdHJ1ZSkKICAgIGlmICh0aGlzLnJvdW5kdHJpcFF1ZXVlID09PSBudWxsKSByZXR1cm4KICAgIGNvbnN0IGZsdXNoZWQgPSB0aGlzLnJvdW5kdHJpcFF1ZXVlLmZsdXNoKHJlcS5ydCkKICAgIGlmIChmbHVzaGVkID09PSBudWxsKSByZXR1cm4KICAgIGZvciAoY29uc3QgaWQgb2YgZmx1c2hlZCkgdGhpcy5yZXBsaWNhdG9yLl9pbmZsaWdodC5yZXVzYWJsZShpZCkKICB9CgogIG9ud2FudCh7IHN0YXJ0LCBsZW5ndGggfSkgewogICAgY29uc3QgaSA9IE1hdGguZmxvb3Ioc3RhcnQgLyBERUZBVUxUX1NFR01FTlRfU0laRSkKICAgIGlmICh0aGlzLnJlbW90ZVNlZ21lbnRzV2FudGVkLnNpemUgPj0gTUFYX1JFTU9URV9TRUdNRU5UUykgdGhpcy5yZW1vdGVTZWdtZW50c1dhbnRlZC5jbGVhcigpIC8vIGp1c3QgaW4gY2FzZSBvZiBhYnVzZQogICAgdGhpcy5yZW1vdGVTZWdtZW50c1dhbnRlZC5hZGQoaSkKICAgIHRoaXMucmVwbGljYXRvci5fb253YW50KHRoaXMsIHN0YXJ0LCBsZW5ndGgpCiAgfQoKICBvbnVud2FudCgpIHsKICAgIC8vIFRPRE8KICB9CgogIG9uYml0ZmllbGQoeyBzdGFydCwgYml0ZmllbGQgfSkgewogICAgaWYgKHN0YXJ0IDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCA9IHN0YXJ0IC8vIGJpdGZpZWxkIGlzIGFsd2F5cyB0aGUgdHJ1dGgKICAgIHRoaXMucmVtb3RlQml0ZmllbGQuaW5zZXJ0KHN0YXJ0LCBiaXRmaWVsZCkKICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5pbnNlcnQoc3RhcnQsIGJpdGZpZWxkKQogICAgdGhpcy5fY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBiaXRmaWVsZC5ieXRlTGVuZ3RoICogOCkKICAgIHRoaXMuX3VwZGF0ZSgpCiAgfQoKICBfY2xlYXJMb2NhbFJhbmdlKHN0YXJ0LCBsZW5ndGgpIHsKICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCA/IHRoaXMuY29yZS5iaXRmaWVsZCA6IHRoaXMuY29yZS5za2lwQml0ZmllbGQKCiAgICBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXQoc3RhcnQsIHRoaXMuX3JlbW90ZUhhc0Jsb2NrKHN0YXJ0KSAmJiAhYml0ZmllbGQuZ2V0KHN0YXJ0KSkKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgY29udGlnID0gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQoKICAgIGlmIChzdGFydCArIGxlbmd0aCA8IGNvbnRpZykgewogICAgICB0aGlzLm1pc3NpbmdCbG9ja3Muc2V0UmFuZ2Uoc3RhcnQsIGNvbnRpZywgZmFsc2UpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IHJlbSA9IHN0YXJ0ICYgMzI3NjcKICAgIGlmIChyZW0gPiAwKSB7CiAgICAgIHN0YXJ0IC09IHJlbQogICAgICBsZW5ndGggKz0gcmVtCiAgICB9CgogICAgY29uc3QgZW5kID0gc3RhcnQgKyBNYXRoLm1pbihsZW5ndGgsIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCiAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgY29uc3QgbG9jYWwgPSBiaXRmaWVsZC5nZXRCaXRmaWVsZChzdGFydCkKCiAgICAgIGlmIChsb2NhbCAmJiBsb2NhbC5iaXRmaWVsZCkgewogICAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5jbGVhcihzdGFydCwgbG9jYWwuYml0ZmllbGQpCiAgICAgIH0KCiAgICAgIHN0YXJ0ICs9IDMyNzY4CiAgICB9CiAgfQoKICBfcmVzZXRNaXNzaW5nQmxvY2soaW5kZXgpIHsKICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCA/IHRoaXMuY29yZS5iaXRmaWVsZCA6IHRoaXMuY29yZS5za2lwQml0ZmllbGQKICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXQoaW5kZXgsIHRoaXMuX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSAmJiAhYml0ZmllbGQuZ2V0KGluZGV4KSkKICB9CgogIF91bmNsZWFyTG9jYWxSYW5nZShzdGFydCwgbGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgIHRoaXMuX3Jlc2V0TWlzc2luZ0Jsb2NrKHN0YXJ0KQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCByZW0gPSBzdGFydCAmIDIwOTcxNTEKICAgIGlmIChyZW0gPiAwKSB7CiAgICAgIHN0YXJ0IC09IHJlbQogICAgICBsZW5ndGggKz0gcmVtCiAgICB9CgogICAgY29uc3QgZml4ZWRTdGFydCA9IHN0YXJ0CgogICAgY29uc3QgZW5kID0gc3RhcnQgKyBNYXRoLm1pbihsZW5ndGgsIHRoaXMucmVtb3RlTGVuZ3RoKQogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgIGNvbnN0IHJlbW90ZSA9IHRoaXMucmVtb3RlQml0ZmllbGQuZ2V0Qml0ZmllbGQoc3RhcnQpCiAgICAgIGlmIChyZW1vdGUgJiYgcmVtb3RlLmJpdGZpZWxkKSB7CiAgICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLmluc2VydChzdGFydCwgcmVtb3RlLmJpdGZpZWxkKQogICAgICB9CgogICAgICBzdGFydCArPSAyMDk3MTUyCiAgICB9CgogICAgdGhpcy5fY2xlYXJMb2NhbFJhbmdlKGZpeGVkU3RhcnQsIGxlbmd0aCkKICB9CgogIGFzeW5jIG9ucmFuZ2UoeyBkcm9wLCBzdGFydCwgbGVuZ3RoIH0pIHsKICAgIGNvbnN0IGhhcyA9IGRyb3AgPT09IGZhbHNlCgogICAgaWYgKGRyb3AgPT09IHRydWUgJiYgc3RhcnQgPCB0aGlzLl9yZW1vdGVDb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBzdGFydAogICAgfQoKICAgIGlmIChzdGFydCA9PT0gMCAmJiBkcm9wID09PSBmYWxzZSkgewogICAgICBpZiAobGVuZ3RoID4gdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkgewogICAgICAgIHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBsZW5ndGgKICAgICAgICBpZiAoCiAgICAgICAgICB0aGlzLnJlbW90ZUZvcmsgPT09IHRoaXMuY29yZS5zdGF0ZS5mb3JrICYmCiAgICAgICAgICBsZW5ndGggPiB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgICAgICApIHsKICAgICAgICAgIHRoaXMuY29yZS51cGRhdGVSZW1vdGVDb250aWd1b3VzTGVuZ3RoKGxlbmd0aCkKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgIGNvbnN0IGJpdGZpZWxkID0gdGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCA/IHRoaXMuY29yZS5iaXRmaWVsZCA6IHRoaXMuY29yZS5za2lwQml0ZmllbGQKICAgICAgdGhpcy5yZW1vdGVCaXRmaWVsZC5zZXQoc3RhcnQsIGhhcykKICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChzdGFydCwgaGFzICYmICFiaXRmaWVsZC5nZXQoc3RhcnQpKQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcmFuZ2VTdGFydCA9IHRoaXMucmVtb3RlQml0ZmllbGQuZmluZEZpcnN0KCFoYXMsIHN0YXJ0KQogICAgICBjb25zdCByYW5nZUVuZCA9IGxlbmd0aCArIHN0YXJ0CgogICAgICBpZiAocmFuZ2VTdGFydCAhPT0gLTEgJiYgcmFuZ2VTdGFydCA8IHJhbmdlRW5kKSB7CiAgICAgICAgdGhpcy5yZW1vdGVCaXRmaWVsZC5zZXRSYW5nZShyYW5nZVN0YXJ0LCByYW5nZUVuZCwgaGFzKQogICAgICAgIHRoaXMubWlzc2luZ0Jsb2Nrcy5zZXRSYW5nZShyYW5nZVN0YXJ0LCByYW5nZUVuZCwgaGFzKQogICAgICAgIGlmIChoYXMpIHRoaXMuX2NsZWFyTG9jYWxSYW5nZShyYW5nZVN0YXJ0LCByYW5nZUVuZCAtIHJhbmdlU3RhcnQpCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgaWYgKGRyb3AgPT09IGZhbHNlKSB0aGlzLl91cGRhdGUoKQogIH0KCiAgb25yZW9yZ2hpbnQoKSB7CiAgICAvLyBUT0RPCiAgfQoKICBfdXBkYXRlKCkgewogICAgLy8gVE9ETzogaWYgdGhpcyBpcyBpbiBhIGJhdGNoIG9yIHNpbWlsYXIgaXQgd291bGQgYmUgYmV0dGVyIHRvIGRlZmVyIGl0CiAgICAvLyB3ZSBjb3VsZCBkbyB0aGF0IHdpdGggbmV4dFRpY2svbWljcm90aWNrIG1iPyAoY29tYmluZWQgd2l0aCBhIHByb3BlcnR5IG9uIHRoZSBzZXNzaW9uIHRvIHNpZ25hbCByZWFkIGJ1ZmZlciBtYikKICAgIHRoaXMucmVwbGljYXRvci51cGRhdGVQZWVyKHRoaXMpCiAgfQoKICBhc3luYyBfb25jb25mbGljdCgpIHsKICAgIHRoaXMucHJvdG9tdXguY29yaygpCiAgICBpZiAodGhpcy5yZW1vdGVMZW5ndGggPiAwICYmIHRoaXMuY29yZS5zdGF0ZS5mb3JrID09PSB0aGlzLnJlbW90ZUZvcmspIHsKICAgICAgYXdhaXQgdGhpcy5vbnJlcXVlc3QoewogICAgICAgIGlkOiAwLAogICAgICAgIGZvcms6IHRoaXMuY29yZS5zdGF0ZS5mb3JrLAogICAgICAgIGJsb2NrOiBudWxsLAogICAgICAgIGhhc2g6IG51bGwsCiAgICAgICAgc2VlazogbnVsbCwKICAgICAgICB1cGdyYWRlOiB7CiAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgIGxlbmd0aDogTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICAgICAgfQogICAgICB9KQogICAgfQogICAgdGhpcy5jaGFubmVsLmNsb3NlKCkKICAgIHRoaXMucHJvdG9tdXgudW5jb3JrKCkKICB9CgogIF9tYWtlUmVxdWVzdChuZWVkc1VwZ3JhZGUsIHByaW9yaXR5LCBtaW5MZW5ndGgpIHsKICAgIGlmIChuZWVkc1VwZ3JhZGUgPT09IHRydWUgJiYgdGhpcy5yZXBsaWNhdG9yLl9zaG91bGRVcGdyYWRlKHRoaXMpID09PSBmYWxzZSkgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIC8vIGVuc3VyZSB0aGF0IHRoZSByZW1vdGUgaGFzIHNpZ25hbGxlZCB0aGV5IGhhdmUgdGhlIGxlbmd0aCB3ZSByZXF1ZXN0CiAgICBpZiAodGhpcy5yZW1vdGVMZW5ndGggPCBtaW5MZW5ndGgpIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBpZiAobmVlZHNVcGdyYWRlID09PSBmYWxzZSAmJiB0aGlzLnJlcGxpY2F0b3IuX2F1dG9VcGdyYWRlKHRoaXMpID09PSB0cnVlKSB7CiAgICAgIG5lZWRzVXBncmFkZSA9IHRydWUKICAgIH0KCiAgICByZXR1cm4gewogICAgICBwZWVyOiB0aGlzLAogICAgICBydDogdGhpcy5yb3VuZHRyaXBRdWV1ZSA9PT0gbnVsbCA/IDAgOiB0aGlzLnJvdW5kdHJpcFF1ZXVlLnRpY2ssCiAgICAgIGlkOiAwLAogICAgICBmb3JrOiB0aGlzLnJlbW90ZUZvcmssCiAgICAgIGJsb2NrOiBudWxsLAogICAgICBoYXNoOiBudWxsLAogICAgICBzZWVrOiBudWxsLAogICAgICB1cGdyYWRlOgogICAgICAgIG5lZWRzVXBncmFkZSA9PT0gZmFsc2UKICAgICAgICAgID8gbnVsbAogICAgICAgICAgOiB7IHN0YXJ0OiB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoLCBsZW5ndGg6IHRoaXMucmVtb3RlTGVuZ3RoIC0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCB9LAogICAgICAvLyByZW1vdGUgbWFuaWZlc3QgY2hlY2sgY2FuIGJlIHJlbW92ZWQgZXZlbnR1YWxseS4uLgogICAgICBtYW5pZmVzdDogdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCA9PT0gbnVsbCAmJiB0aGlzLnJlbW90ZUhhc01hbmlmZXN0ID09PSB0cnVlLAogICAgICBwcmlvcml0eSwKICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICBlbGFwc2VkOiAwCiAgICB9CiAgfQoKICBfcmVxdWVzdE1hbmlmZXN0KCkgewogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoZmFsc2UsIDAsIDApCiAgICB0aGlzLl9zZW5kKHJlcSkKICB9CgogIF9pbmNsdWRlTGFzdEJsb2NrKCkgewogICAgaWYgKHRoaXMucmVwbGljYXRvci5fYWx3YXlzTGF0ZXN0QmxvY2sgPT09IDApIHJldHVybiBudWxsCgogICAgY29uc3QgaW5kZXggPSB0aGlzLnJlbW90ZUxlbmd0aCAtIDEKCiAgICAvLyBvbmx5IHZhbGlkIGlmIGl0cyBhbiBPT0IgZ2V0CiAgICBpZiAoaW5kZXggPCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoKSByZXR1cm4gbnVsbAoKICAgIC8vIGRvIHRoZSBub3JtYWwgY2hlY2tzCiAgICBpZiAoIXRoaXMuX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSkgcmV0dXJuIG51bGwKICAgIGlmICghdGhpcy5fY2FuUmVxdWVzdChpbmRleCkpIHJldHVybiBudWxsCgogICAgLy8gYXRtIHdlIG9ubHkgZXZlciBkbyBvbmUgdXBncmFkZSByZXF1ZXN0IGluIHBhcmFsbGVsLCBpZiB0aGF0IGNoYW5nZXMKICAgIC8vIHRoZW4gd2Ugc2hvdWxkIGFkZCBzb21lIGNoZWNrIGhlcmUgZm9yIGluZmxpZ2h0cyB0byBhdm9pZCBvdmVyIHJlcXVlc3RpbmcKICAgIGNvbnN0IGIgPSB0aGlzLnJlcGxpY2F0b3IuX2Jsb2Nrcy5hZGQoaW5kZXgsIFBSSU9SSVRZLk5PUk1BTCkKICAgIHJldHVybiBiCiAgfQoKICBfcmVxdWVzdFVwZ3JhZGUodSkgewogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QodHJ1ZSwgMCwgMCkKICAgIGlmIChyZXEgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGIgPSB0aGlzLl9pbmNsdWRlTGFzdEJsb2NrKCkKCiAgICBpZiAoYikgdGhpcy5fc2VuZEJsb2NrUmVxdWVzdChyZXEsIGIpCiAgICBlbHNlIHRoaXMuX3NlbmQocmVxKQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVxdWVzdFNlZWsocykgewogICAgLy8gaWYgcmVwbGljYXRvciBpcyB1cGRhdGluZyB0aGUgc2Vla3MgZXRjLCBiYWlsIGFuZCB3YWl0IGZvciBpdCB0byBkcmFpbgogICAgaWYgKHRoaXMucmVwbGljYXRvci5fdXBkYXRlc1BlbmRpbmcgPiAwKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB7IGxlbmd0aCwgZm9yayB9ID0gdGhpcy5jb3JlLnN0YXRlCgogICAgaWYgKGZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgcmV0dXJuIGZhbHNlCgogICAgaWYgKHMuc2Vla2VyLnN0YXJ0ID49IGxlbmd0aCkgewogICAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdCh0cnVlLCAwLCAwKQoKICAgICAgLy8gV2UgbmVlZCBhbiB1cGdyYWRlIGZvciB0aGUgc2VlaywgaWYgbm9uIGNhbiBiZSBwcm92aWRlZCwgc2tpcAogICAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICAgIHJlcS5zZWVrID0gdGhpcy5yZW1vdGVTdXBwb3J0c1NlZWtzCiAgICAgICAgPyB7IGJ5dGVzOiBzLnNlZWtlci5ieXRlcywgcGFkZGluZzogcy5zZWVrZXIucGFkZGluZyB9CiAgICAgICAgOiBudWxsCgogICAgICBzLmluZmxpZ2h0LnB1c2gocmVxKQogICAgICB0aGlzLl9zZW5kKHJlcSkKCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgY29uc3QgbGVuID0gcy5zZWVrZXIuZW5kIC0gcy5zZWVrZXIuc3RhcnQKICAgIGNvbnN0IG9mZiA9IHMuc2Vla2VyLnN0YXJ0ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbGVuKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgbGV0IGluZGV4ID0gb2ZmICsgaQogICAgICBpZiAoaW5kZXggPiBzLnNlZWtlci5lbmQpIGluZGV4IC09IGxlbgoKICAgICAgaWYgKHRoaXMuX3JlbW90ZUhhc0Jsb2NrKGluZGV4KSA9PT0gZmFsc2UpIGNvbnRpbnVlCiAgICAgIGlmICh0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSA9PT0gdHJ1ZSkgY29udGludWUKICAgICAgaWYgKCF0aGlzLl9jYW5SZXF1ZXN0KGluZGV4KSkgY29udGludWUKCiAgICAgIC8vIENoZWNrIGlmIHRoaXMgYmxvY2sgaXMgY3VycmVudGx5IGluZmxpZ2h0IC0gaWYgc28gcGljayBhbm90aGVyCiAgICAgIGNvbnN0IGIgPSB0aGlzLnJlcGxpY2F0b3IuX2Jsb2Nrcy5nZXQoaW5kZXgpCiAgICAgIGlmIChiICE9PSBudWxsICYmIGIuaW5mbGlnaHQubGVuZ3RoID4gMCkgY29udGludWUKCiAgICAgIC8vIEJsb2NrIGlzIG5vdCBpbmZsaWdodCwgYnV0IHdlIG9ubHkgd2FudCB0aGUgaGFzaCwgY2hlY2sgaWYgdGhhdCBpcyBpbmZsaWdodAogICAgICBjb25zdCBoID0gdGhpcy5yZXBsaWNhdG9yLl9oYXNoZXMuYWRkKGluZGV4LCBQUklPUklUWS5OT1JNQUwpCiAgICAgIGlmIChoLmluZmxpZ2h0Lmxlbmd0aCA+IDApIGNvbnRpbnVlCgogICAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChmYWxzZSwgaC5wcmlvcml0eSwgaW5kZXggKyAxKQogICAgICBpZiAocmVxID09PSBudWxsKSBjb250aW51ZQoKICAgICAgY29uc3Qgbm9kZXMgPSBmbGF0VHJlZS5kZXB0aChzLnNlZWtlci5zdGFydCArIHMuc2Vla2VyLmVuZCAtIDEpCgogICAgICByZXEuaGFzaCA9IHsgaW5kZXg6IDIgKiBpbmRleCwgbm9kZXMgfQogICAgICByZXEuc2VlayA9IHRoaXMucmVtb3RlU3VwcG9ydHNTZWVrcwogICAgICAgID8geyBieXRlczogcy5zZWVrZXIuYnl0ZXMsIHBhZGRpbmc6IHMuc2Vla2VyLnBhZGRpbmcgfQogICAgICAgIDogbnVsbAoKICAgICAgcy5pbmZsaWdodC5wdXNoKHJlcSkKICAgICAgaC5pbmZsaWdodC5wdXNoKHJlcSkKICAgICAgdGhpcy5fc2VuZChyZXEpCgogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMuX21heWJlV2FudChzLnNlZWtlci5zdGFydCwgbGVuKQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBfY2FuUmVxdWVzdChpbmRleCkgewogICAgaWYgKCEoaW5kZXggPj0gMCkpIHRocm93IEFTU0VSVElPTignYmFkIGluZGV4IHRvIF9jYW5SZXF1ZXN0OiAnICsgaW5kZXgpCgogICAgaWYgKHRoaXMucmVtb3RlTGVuZ3RoID49IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBpZiAoaW5kZXggPCB0aGlzLmxhc3RVcGdyYWRhYmxlTGVuZ3RoICYmIHRoaXMubGFzdFVwZ3JhZGFibGVGb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yaykgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmICh0aGlzLmNhblVwZ3JhZGUgJiYgdGhpcy5zeW5jc1Byb2Nlc3NpbmcgPT09IDApIHsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9yZW1vdGVIYXNCbG9jayhpbmRleCkgewogICAgcmV0dXJuIGluZGV4IDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCB8fCB0aGlzLnJlbW90ZUJpdGZpZWxkLmdldChpbmRleCkgPT09IHRydWUKICB9CgogIF9zZW5kQmxvY2tSZXF1ZXN0KHJlcSwgYikgewogICAgcmVxLmJsb2NrID0geyBpbmRleDogYi5pbmRleCwgbm9kZXM6IDAgfQogICAgdGhpcy5yZXBsaWNhdG9yLl9tYXJrSW5mbGlnaHQoYi5pbmRleCkKCiAgICBiLmluZmxpZ2h0LnB1c2gocmVxKQogICAgdGhpcy5yZXBsaWNhdG9yLmhvdHN3YXBzLmFkZChiKQogICAgdGhpcy5fc2VuZChyZXEpCiAgfQoKICBfcmVxdWVzdEJsb2NrKGIpIHsKICAgIGNvbnN0IHsgbGVuZ3RoLCBmb3JrIH0gPSB0aGlzLmNvcmUuc3RhdGUKCiAgICBpZiAodGhpcy5fcmVtb3RlSGFzQmxvY2soYi5pbmRleCkgPT09IGZhbHNlIHx8IGZvcmsgIT09IHRoaXMucmVtb3RlRm9yaykgewogICAgICB0aGlzLl9tYXliZVdhbnQoYi5pbmRleCkKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKCF0aGlzLl9jYW5SZXF1ZXN0KGIuaW5kZXgpKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChiLmluZGV4ID49IGxlbmd0aCwgYi5wcmlvcml0eSwgYi5pbmRleCArIDEpCiAgICBpZiAocmVxID09PSBudWxsKSByZXR1cm4gZmFsc2UKCiAgICB0aGlzLl9zZW5kQmxvY2tSZXF1ZXN0KHJlcSwgYikKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX3JlcXVlc3RSYW5nZUJsb2NrKGluZGV4LCBsZW5ndGgpIHsKICAgIGlmICh0aGlzLmNvcmUuYml0ZmllbGQuZ2V0KGluZGV4KSA9PT0gdHJ1ZSB8fCAhdGhpcy5fY2FuUmVxdWVzdChpbmRleCkpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGIgPSB0aGlzLnJlcGxpY2F0b3IuX2Jsb2Nrcy5hZGQoaW5kZXgsIFBSSU9SSVRZLk5PUk1BTCkKICAgIGlmIChiLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5taXNzaW5nQmxvY2tzLnNldChpbmRleCwgZmFsc2UpIC8vIGluIGNhc2Ugd2UgbWlzc2VkIHNvbWUgc3RhdGVzIGp1c3Qgc2V0IHRoZW0gb25kZW1hbmQsIG5iZAogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBjb25zdCByZXEgPSB0aGlzLl9tYWtlUmVxdWVzdChpbmRleCA+PSBsZW5ndGgsIGIucHJpb3JpdHksIGluZGV4ICsgMSkKCiAgICAvLyBJZiB0aGUgcmVxdWVzdCBjYW5ub3QgYmUgc2F0aXNmaWVkLCBkZWFsbG9jIHRoZSBibG9jayByZXF1ZXN0IGlmIG5vIG9uZSBpcyBzdWJzY3JpYmVkIHRvIGl0CiAgICBpZiAocmVxID09PSBudWxsKSB7CiAgICAgIGIuZ2MoKQogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB0aGlzLl9zZW5kQmxvY2tSZXF1ZXN0KHJlcSwgYikKCiAgICAvLyBEb24ndCB0aGluayB0aGlzIHdpbGwgZXZlciBoYXBwZW4sIGFzIHRoZSBwZW5kaW5nIHF1ZXVlIGlzIGRyYWluZWQgYmVmb3JlIHRoZSByYW5nZSBxdWV1ZQogICAgLy8gYnV0IGRvZXNuJ3QgaHVydCB0byBjaGVjayB0aGlzIGV4cGxpY2l0bHkgaGVyZSBhbHNvLgogICAgaWYgKGIucXVldWVkKSBiLnF1ZXVlZCA9IGZhbHNlCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgX2ZpbmROZXh0KGkpIHsKICAgIGlmIChpIDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCkgewogICAgICBpZiAodGhpcy5jb3JlLnNraXBCaXRmaWVsZCA9PT0gbnVsbCkgdGhpcy5yZXBsaWNhdG9yLl9vcGVuU2tpcEJpdGZpZWxkKCkKICAgICAgaSA9IHRoaXMuY29yZS5za2lwQml0ZmllbGQuZmluZEZpcnN0KGZhbHNlLCBpKQogICAgICBpZiAoaSA8IHRoaXMuX3JlbW90ZUNvbnRpZ3VvdXNMZW5ndGggJiYgaSA+IC0xKSByZXR1cm4gaQogICAgICBpID0gdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgfQoKICAgIHJldHVybiB0aGlzLm1pc3NpbmdCbG9ja3MuZmluZEZpcnN0KHRydWUsIGkpCiAgfQoKICBfcmVxdWVzdFJhbmdlKHIpIHsKICAgIGlmICh0aGlzLnN5bmNzUHJvY2Vzc2luZyA+IDApIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IHsgbGVuZ3RoLCBmb3JrIH0gPSB0aGlzLmNvcmUuc3RhdGUKCiAgICBpZiAoci5ibG9ja3MpIHsKICAgICAgbGV0IG1pbiA9IC0xCiAgICAgIGxldCBtYXggPSAtMQoKICAgICAgZm9yIChsZXQgaSA9IHIuc3RhcnQ7IGkgPCByLmVuZDsgaSsrKSB7CiAgICAgICAgY29uc3QgaW5kZXggPSByLmJsb2Nrc1tpXQogICAgICAgIGlmIChtaW4gPT09IC0xIHx8IGluZGV4IDwgbWluKSBtaW4gPSBpbmRleAogICAgICAgIGlmIChtYXggPT09IC0xIHx8IGluZGV4ID4gbWF4KSBtYXggPSBpbmRleAogICAgICAgIGNvbnN0IGhhcyA9IGluZGV4IDwgdGhpcy5fcmVtb3RlQ29udGlndW91c0xlbmd0aCB8fCB0aGlzLm1pc3NpbmdCbG9ja3MuZ2V0KGluZGV4KSA9PT0gdHJ1ZQogICAgICAgIGlmIChoYXMgPT09IHRydWUgJiYgdGhpcy5fcmVxdWVzdFJhbmdlQmxvY2soaW5kZXgsIGxlbmd0aCkpIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChtaW4gPiAtMSkgdGhpcy5fbWF5YmVXYW50KG1pbiwgbWF4IC0gbWluKQogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICAvLyBpZiB3ZSBjYW4gdXBncmFkZSB0aGUgcmVtb3RlLCBvciB0aGUgcmVtb3RlIGlzIGFoZWFkLCB0aGVuIGFsbCB0aGUgcmVtb3RlcyBibG9ja3MgYXJlIHZhbGlkCiAgICAvLyBvdGhlcndpc2UgdHJ1bmNhdGUgdG8gdGhlIGxhc3QgbGVuZ3RoIHRoZSByZW1vdGUgaGFzIGFja2VkIGZvciB1cwogICAgY29uc3QgbWF4TG9jYWxMZW5ndGggPQogICAgICB0aGlzLmNhblVwZ3JhZGUgfHwgdGhpcy5yZW1vdGVMZW5ndGggPj0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgICAgID8gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgICAgIDogZm9yayA9PT0gdGhpcy5sYXN0VXBncmFkYWJsZUZvcmsKICAgICAgICAgID8gTWF0aC5taW4odGhpcy5sYXN0VXBncmFkYWJsZUxlbmd0aCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICAgICAgICAgIDogMAoKICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKAogICAgICBtYXhMb2NhbExlbmd0aCwKICAgICAgTWF0aC5taW4oci5lbmQgPT09IC0xID8gdGhpcy5yZW1vdGVMZW5ndGggOiByLmVuZCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICApCiAgICBpZiAoZW5kIDw9IHIuc3RhcnQgfHwgZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBsZW4gPSBlbmQgLSByLnN0YXJ0CiAgICBjb25zdCBvZmYgPSByLnN0YXJ0ICsgKHIubGluZWFyID8gMCA6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxlbikpCgogICAgbGV0IGkgPSBvZmYKICAgIC8vIHNob3VsZCBiZSB3YXkgbGVzcyB0aGFuIHRoaXMsIGJ1dCB0aGlzIGlzIHdvcnN0IGNhc2UgdXBwZXIgYm91bmQgZm9yIHRoZSBza2lwbGlzdAogICAgbGV0IHRyaWVzID0gdGhpcy5pbmZsaWdodAoKICAgIGRvIHsKICAgICAgaSA9IHRoaXMuX2ZpbmROZXh0KGkpCiAgICAgIGlmIChpID09PSAtMSB8fCBpID49IGVuZCkgYnJlYWsKCiAgICAgIGlmICh0aGlzLl9yZXF1ZXN0UmFuZ2VCbG9jayhpLCBsZW5ndGgpKSByZXR1cm4gdHJ1ZQogICAgICBpKysKICAgIH0gd2hpbGUgKHRyaWVzLS0gPiAwKQoKICAgIGkgPSByLnN0YXJ0CgogICAgZG8gewogICAgICBpID0gdGhpcy5fZmluZE5leHQoaSkKICAgICAgaWYgKGkgPT09IC0xIHx8IGkgPj0gb2ZmKSBicmVhawoKICAgICAgaWYgKHRoaXMuX3JlcXVlc3RSYW5nZUJsb2NrKGksIGxlbmd0aCkpIHJldHVybiB0cnVlCiAgICAgIGkrKwogICAgfSB3aGlsZSAodHJpZXMtLSA+IDApCgogICAgdGhpcy5fbWF5YmVXYW50KHIuc3RhcnQsIGxlbikKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3JlcXVlc3RGb3JrUHJvb2YoZikgewogICAgaWYgKCF0aGlzLnJlbW90ZUxlbmd0aCkgcmV0dXJuCgogICAgY29uc3QgcmVxID0gdGhpcy5fbWFrZVJlcXVlc3QoZmFsc2UsIDAsIDApCgogICAgcmVxLnVwZ3JhZGUgPSB7IHN0YXJ0OiAwLCBsZW5ndGg6IHRoaXMucmVtb3RlTGVuZ3RoIH0KICAgIHJlcS5tYW5pZmVzdCA9ICF0aGlzLmNvcmUuaGVhZGVyLm1hbmlmZXN0CgogICAgZi5pbmZsaWdodC5wdXNoKHJlcSkKICAgIHRoaXMuX3NlbmQocmVxKQogIH0KCiAgX3JlcXVlc3RGb3JrUmFuZ2UoZikgewogICAgaWYgKGYuZm9yayAhPT0gdGhpcy5yZW1vdGVGb3JrIHx8IGYuYmF0Y2gud2FudCA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgZW5kID0gTWF0aC5taW4oZi5iYXRjaC53YW50LmVuZCwgdGhpcy5yZW1vdGVMZW5ndGgpCiAgICBpZiAoZW5kIDwgZi5iYXRjaC53YW50LnN0YXJ0KSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCBsZW4gPSBlbmQgLSBmLmJhdGNoLndhbnQuc3RhcnQKICAgIGNvbnN0IG9mZiA9IGYuYmF0Y2gud2FudC5zdGFydCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGxlbikKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGxldCBpbmRleCA9IG9mZiArIGkKICAgICAgaWYgKGluZGV4ID49IGVuZCkgaW5kZXggLT0gbGVuCgogICAgICBpZiAodGhpcy5fcmVtb3RlSGFzQmxvY2soaW5kZXgpID09PSBmYWxzZSkgY29udGludWUKCiAgICAgIGNvbnN0IHJlcSA9IHRoaXMuX21ha2VSZXF1ZXN0KGZhbHNlLCAwLCAwKQoKICAgICAgcmVxLmhhc2ggPSB7IGluZGV4OiAyICogaW5kZXgsIG5vZGVzOiBmLmJhdGNoLndhbnQubm9kZXMgfQoKICAgICAgZi5pbmZsaWdodC5wdXNoKHJlcSkKICAgICAgdGhpcy5fc2VuZChyZXEpCgogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHRoaXMuX21heWJlV2FudChmLmJhdGNoLndhbnQuc3RhcnQsIGxlbikKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX21heWJlV2FudChzdGFydCwgbGVuZ3RoID0gMSkgewogICAgaWYgKHN0YXJ0ICsgbGVuZ3RoIDw9IHRoaXMucmVtb3RlQ29udGlndW91c0xlbmd0aCkgcmV0dXJuCgogICAgbGV0IGkgPSBNYXRoLmZsb29yKHN0YXJ0IC8gREVGQVVMVF9TRUdNRU5UX1NJWkUpCiAgICBjb25zdCBuID0gTWF0aC5jZWlsKChzdGFydCArIGxlbmd0aCkgLyBERUZBVUxUX1NFR01FTlRfU0laRSkKCiAgICBmb3IgKDsgaSA8IG47IGkrKykgewogICAgICBpZiAodGhpcy5zZWdtZW50c1dhbnRlZC5oYXMoaSkpIGNvbnRpbnVlCiAgICAgIHRoaXMuc2VnbWVudHNXYW50ZWQuYWRkKGkpCgogICAgICB0aGlzLndpcmVXYW50LnNlbmQoewogICAgICAgIHN0YXJ0OiBpICogREVGQVVMVF9TRUdNRU5UX1NJWkUsCiAgICAgICAgbGVuZ3RoOiBERUZBVUxUX1NFR01FTlRfU0laRQogICAgICB9KQogICAgICBpbmNyZW1lbnRUeCh0aGlzLnN0YXRzLndpcmVXYW50LCB0aGlzLnJlcGxpY2F0b3Iuc3RhdHMud2lyZVdhbnQpCiAgICB9CiAgfQoKICBpc0FjdGl2ZSgpIHsKICAgIGlmICh0aGlzLnBhdXNlZCB8fCB0aGlzLnJlbW92ZWQgfHwgdGhpcy5jb3JlLmhlYWRlci5mcm96ZW4pIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIF9zZW5kKHJlcSkgewogICAgY29uc3QgZm9yayA9IHRoaXMuY29yZS5zdGF0ZS5mb3JrCgogICAgdGhpcy5pbmZsaWdodCsrCiAgICB0aGlzLnJlcGxpY2F0b3IuX2luZmxpZ2h0LmFkZChyZXEpCgogICAgaWYgKHJlcS51cGdyYWRlICE9PSBudWxsICYmIHJlcS5mb3JrID09PSBmb3JrKSB7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnJlcGxpY2F0b3IuX2FkZFVwZ3JhZGUoKQogICAgICB1LmluZmxpZ2h0LnB1c2gocmVxKQogICAgfQoKICAgIHRyeSB7CiAgICAgIGlmIChyZXEuYmxvY2sgIT09IG51bGwgJiYgcmVxLmZvcmsgPT09IGZvcmspIHsKICAgICAgICByZXEuYmxvY2subm9kZXMgPSBhd2FpdCBNZXJrbGVUcmVlLm1pc3NpbmdOb2RlcygKICAgICAgICAgIHRoaXMuY29yZS5zdGF0ZSwKICAgICAgICAgIDIgKiByZXEuYmxvY2suaW5kZXgsCiAgICAgICAgICB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoCiAgICAgICAgKQogICAgICAgIGlmIChyZXEucHJpb3JpdHkgPT09IFBSSU9SSVRZLkNBTkNFTExFRCkgcmV0dXJuCiAgICAgIH0KICAgICAgaWYgKHJlcS5oYXNoICE9PSBudWxsICYmIHJlcS5mb3JrID09PSBmb3JrICYmIHJlcS5oYXNoLm5vZGVzID09PSAwKSB7CiAgICAgICAgcmVxLmhhc2gubm9kZXMgPSBhd2FpdCBNZXJrbGVUcmVlLm1pc3NpbmdOb2RlcygKICAgICAgICAgIHRoaXMuY29yZS5zdGF0ZSwKICAgICAgICAgIHJlcS5oYXNoLmluZGV4LAogICAgICAgICAgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgICAgICkKICAgICAgICBpZiAocmVxLnByaW9yaXR5ID09PSBQUklPUklUWS5DQU5DRUxMRUQpIHJldHVybgoKICAgICAgICAvLyBub2RlcyA9PT0gMCwgd2UgYWxyZWFkeSBoYXZlIGl0LCBiYWlsCiAgICAgICAgaWYgKHJlcS5oYXNoLm5vZGVzID09PSAwICYmIChyZXEuaGFzaC5pbmRleCAmIDEpID09PSAwKSB7CiAgICAgICAgICB0aGlzLmluZmxpZ2h0LS0KICAgICAgICAgIHRoaXMucmVwbGljYXRvci5fcmVzb2x2ZUhhc2hMb2NhbGx5KHRoaXMsIHJlcSkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLndpcmVSZXF1ZXN0LnNlbmQocmVxKQogICAgaW5jcmVtZW50VHgodGhpcy5zdGF0cy53aXJlUmVxdWVzdCwgdGhpcy5yZXBsaWNhdG9yLnN0YXRzLndpcmVSZXF1ZXN0KQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZXBsaWNhdG9yIHsKICBzdGF0aWMgUGVlciA9IFBlZXIgLy8gaGFjayB0byBiZSBhYmxlIHRvIGFjY2VzcyBQZWVyIGZyb20gb3V0c2lkZSB0aGlzIG1vZHVsZQoKICBjb25zdHJ1Y3RvcigKICAgIGNvcmUsCiAgICB7CiAgICAgIG5vdERvd25sb2FkaW5nTGluZ2VyID0gTk9UX0RPV05MT0FESU5HX1NMQUNLLAogICAgICBlYWdlclVwZ3JhZGUgPSB0cnVlLAogICAgICBhbGxvd0ZvcmsgPSB0cnVlLAogICAgICBhbGxvd1B1c2ggPSBmYWxzZSwKICAgICAgYWx3YXlzTGF0ZXN0QmxvY2sgPSBmYWxzZSwKICAgICAgaW5mbGlnaHRSYW5nZSA9IG51bGwKICAgIH0gPSB7fQogICkgewogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5lYWdlclVwZ3JhZGUgPSBlYWdlclVwZ3JhZGUKICAgIHRoaXMuYWxsb3dGb3JrID0gYWxsb3dGb3JrCiAgICB0aGlzLmFsbG93UHVzaCA9IGFsbG93UHVzaAogICAgdGhpcy5vbmRvd25sb2FkaW5nID0gbnVsbCAvLyBvcHRpb25hbCBleHRlcm5hbCBob29rIGZvciBtb25pdG9yaW5nIGRvd25sb2FkaW5nIHN0YXR1cwogICAgdGhpcy5wZWVycyA9IFtdCiAgICB0aGlzLmZpbmRpbmdQZWVycyA9IDAgLy8gdXBkYXRhYmxlIGZyb20gdGhlIG91dHNpZGUKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuZG93bmxvYWRpbmcgPSBmYWxzZQogICAgdGhpcy5hY3RpdmVTZXNzaW9ucyA9IDAKCiAgICB0aGlzLmhvdHN3YXBzID0gbmV3IEhvdHN3YXBRdWV1ZSgpCiAgICB0aGlzLmluZmxpZ2h0UmFuZ2UgPSBpbmZsaWdodFJhbmdlIHx8IERFRkFVTFRfTUFYX0lORkxJR0hUCgogICAgLy8gTm90ZTogbm9kYXRhIGFuZCB1bndhbnQgbm90IGN1cnJlbnRseSB0cmFja2VkCiAgICAvLyB0eCA9IHRyYW5zbWl0dGVkLCByeCA9IHJlY2VpdmVkCiAgICB0aGlzLnN0YXRzID0gewogICAgICB3aXJlU3luYzogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZVJlcXVlc3Q6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVDYW5jZWw6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVEYXRhOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlV2FudDogeyB0eDogMCwgcng6IDAgfSwKICAgICAgd2lyZUJpdGZpZWxkOiB7IHR4OiAwLCByeDogMCB9LAogICAgICB3aXJlUmFuZ2U6IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIHdpcmVFeHRlbnNpb246IHsgdHg6IDAsIHJ4OiAwIH0sCiAgICAgIGhvdHN3YXBzOiAwLAogICAgICBpbnZhbGlkRGF0YTogMCwKICAgICAgaW52YWxpZFJlcXVlc3RzOiAwLAogICAgICBiYWNrb2ZmczogMAogICAgfQoKICAgIHRoaXMuX2F0dGFjaGVkID0gbmV3IFNldCgpCiAgICB0aGlzLl9pbmZsaWdodCA9IG5ldyBJbmZsaWdodFRyYWNrZXIoKQogICAgdGhpcy5fYmxvY2tzID0gbmV3IEJsb2NrVHJhY2tlcih0aGlzKQogICAgdGhpcy5faGFzaGVzID0gbmV3IEJsb2NrVHJhY2tlcih0aGlzKQoKICAgIHRoaXMuX2Fsd2F5c0xhdGVzdEJsb2NrID0gYWx3YXlzTGF0ZXN0QmxvY2sgPyAxIDogMAogICAgdGhpcy5fcXVldWVkID0gW10KCiAgICB0aGlzLl9zZWVrcyA9IFtdCiAgICB0aGlzLl91cGdyYWRlID0gbnVsbAogICAgdGhpcy5fcmVvcmdzID0gW10KICAgIHRoaXMuX3JhbmdlcyA9IFtdCgogICAgdGhpcy5fcHVzaExvY2sgPSBuZXcgTXV0ZXgoKQogICAgdGhpcy5faGFkUGVlcnMgPSBmYWxzZQogICAgdGhpcy5fYWN0aXZlID0gMAogICAgdGhpcy5faWZBdmFpbGFibGUgPSAwCiAgICB0aGlzLl91cGRhdGVzUGVuZGluZyA9IDAKICAgIHRoaXMuX2FwcGx5aW5nUmVvcmcgPSBudWxsCiAgICB0aGlzLl9tYW5pZmVzdFBlZXIgPSBudWxsCiAgICB0aGlzLl9ub3REb3dubG9hZGluZ0xpbmdlciA9IG5vdERvd25sb2FkaW5nTGluZ2VyCiAgICB0aGlzLl9kb3dubG9hZGluZ1RpbWVyID0gbnVsbAoKICAgIGNvbnN0IHNlbGYgPSB0aGlzCiAgICB0aGlzLl9vbnN0cmVhbWNsb3NlID0gb25zdHJlYW1jbG9zZQoKICAgIGZ1bmN0aW9uIG9uc3RyZWFtY2xvc2UoKSB7CiAgICAgIHNlbGYuZGV0YWNoRnJvbSh0aGlzLnVzZXJEYXRhKQogICAgfQogIH0KCiAgdXBkYXRlQWN0aXZpdHkoaW5jLCBzZXNzaW9uKSB7CiAgICB0aGlzLmFjdGl2ZVNlc3Npb25zICs9IGluYwogICAgdGhpcy5zZXREb3dubG9hZGluZyh0aGlzLmFjdGl2ZVNlc3Npb25zICE9PSAwLCBzZXNzaW9uKQogIH0KCiAgaXNEb3dubG9hZGluZygpIHsKICAgIHJldHVybiB0aGlzLmRvd25sb2FkaW5nIHx8ICF0aGlzLl9pbmZsaWdodC5pZGxlCiAgfQoKICBhc3luYyBwdXNoKGluZGV4KSB7CiAgICBjb25zdCBhbGwgPSBbXQogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHsKICAgICAgYWxsLnB1c2gocGVlci5wdXNoKGluZGV4KSkKICAgIH0KICAgIGF3YWl0IFByb21pc2UuYWxsKGFsbCkKICB9CgogIHNldEFsbG93UHVzaChhbGxvd1B1c2gpIHsKICAgIGlmIChhbGxvd1B1c2ggPT09IHRoaXMuYWxsb3dQdXNoKSByZXR1cm4KICAgIHRoaXMuYWxsb3dQdXNoID0gYWxsb3dQdXNoCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5zZW5kU3luYygpCiAgfQoKICBzZXREb3dubG9hZGluZyhkb3dubG9hZGluZykgewogICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Rvd25sb2FkaW5nVGltZXIpCgogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIGlmIChkb3dubG9hZGluZyB8fCB0aGlzLl9ub3REb3dubG9hZGluZ0xpbmdlciA9PT0gMCkgewogICAgICB0aGlzLnNldERvd25sb2FkaW5nTm93KGRvd25sb2FkaW5nKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLl9kb3dubG9hZGluZ1RpbWVyID0gc2V0VGltZW91dCgKICAgICAgc2V0RG93bmxvYWRpbmdMYXRlciwKICAgICAgdGhpcy5fbm90RG93bmxvYWRpbmdMaW5nZXIsCiAgICAgIHRoaXMsCiAgICAgIGRvd25sb2FkaW5nCiAgICApCiAgICBpZiAodGhpcy5fZG93bmxvYWRpbmdUaW1lci51bnJlZikgdGhpcy5fZG93bmxvYWRpbmdUaW1lci51bnJlZigpCiAgfQoKICBzZXREb3dubG9hZGluZ05vdyhkb3dubG9hZGluZykgewogICAgdGhpcy5fZG93bmxvYWRpbmdUaW1lciA9IG51bGwKICAgIGlmICh0aGlzLmRvd25sb2FkaW5nID09PSBkb3dubG9hZGluZykgcmV0dXJuCiAgICB0aGlzLmRvd25sb2FkaW5nID0gZG93bmxvYWRpbmcKICAgIGlmICghZG93bmxvYWRpbmcgJiYgdGhpcy5pc0Rvd25sb2FkaW5nKCkpIHJldHVybgoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnNpZ25hbFVwZ3JhZGUoKQoKICAgIGlmIChkb3dubG9hZGluZykgewogICAgICAvLyByZXN0YXJ0IGNoYW5uZWwgaWYgbmVlZGVkLi4uCiAgICAgIGZvciAoY29uc3QgcHJvdG9tdXggb2YgdGhpcy5fYXR0YWNoZWQpIHsKICAgICAgICBpZiAoIXByb3RvbXV4LnN0cmVhbS5oYW5kc2hha2VIYXNoKSBjb250aW51ZQogICAgICAgIGlmIChwcm90b211eC5vcGVuZWQoeyBwcm90b2NvbDogJ2h5cGVyY29yZS9hbHBoYScsIGlkOiB0aGlzLmNvcmUuZGlzY292ZXJ5S2V5IH0pKSBjb250aW51ZQogICAgICAgIHRoaXMuX21ha2VQZWVyKHByb3RvbXV4LCB0cnVlKQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5jbG9zZUlmSWRsZSgpCiAgICB9CgogICAgaWYgKHRoaXMub25kb3dubG9hZGluZyAhPT0gbnVsbCAmJiBkb3dubG9hZGluZykgdGhpcy5vbmRvd25sb2FkaW5nKCkKICB9CgogIGNvcmsoKSB7CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5wcm90b211eC5jb3JrKCkKICB9CgogIHVuY29yaygpIHsKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLnByb3RvbXV4LnVuY29yaygpCiAgfQoKICAvLyBDYWxsZWQgZXh0ZXJuYWxseSB3aGVuIGEgcmFuZ2Ugb2YgbmV3IGJsb2NrcyBoYXMgYmVlbiBwcm9jZXNzZWQvcmVtb3ZlZAogIG9uaGF2ZShzdGFydCwgbGVuZ3RoLCBkcm9wID0gZmFsc2UpIHsKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSBwZWVyLmJyb2FkY2FzdFJhbmdlKHN0YXJ0LCBsZW5ndGgsIGRyb3ApCiAgfQoKICAvLyBDYWxsZWQgZXh0ZXJuYWxseSB3aGVuIGEgdHJ1bmNhdGlvbiB1cGdyYWRlIGhhcyBiZWVuIHByb2Nlc3NlZAogIG9udHJ1bmNhdGUobmV3TGVuZ3RoLCB0cnVuY2F0ZWQpIHsKICAgIGNvbnN0IG5vdGlmeSA9IFtdCgogICAgZm9yIChjb25zdCBibGsgb2YgdGhpcy5fYmxvY2tzKSB7CiAgICAgIGlmIChibGsuaW5kZXggPCBuZXdMZW5ndGgpIGNvbnRpbnVlCiAgICAgIG5vdGlmeS5wdXNoKGJsaykKICAgIH0KCiAgICBmb3IgKGNvbnN0IGJsayBvZiBub3RpZnkpIHsKICAgICAgZm9yIChjb25zdCByIG9mIGJsay5yZWZzKSB7CiAgICAgICAgaWYgKHIuc25hcHNob3QgPT09IGZhbHNlKSBjb250aW51ZQogICAgICAgIGJsay5kZXRhY2gociwgU05BUFNIT1RfTk9UX0FWQUlMQUJMRSgpKQogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuX3VuY2xlYXJMb2NhbFJhbmdlKG5ld0xlbmd0aCwgdHJ1bmNhdGVkKQogIH0KCiAgLy8gQ2FsbGVkIGV4dGVybmFsbHkgd2hlbiBhIHVwZ3JhZGUgaGFzIGJlZW4gcHJvY2Vzc2VkCiAgb251cGdyYWRlKCkgewogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHBlZXIuc2lnbmFsVXBncmFkZSgpCiAgICBpZiAodGhpcy5fYmxvY2tzLmlzRW1wdHkoKSA9PT0gZmFsc2UpIHRoaXMuX3Jlc29sdmVCbG9ja3NMb2NhbGx5KCkKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsKSB0aGlzLl9yZXNvbHZlVXBncmFkZVJlcXVlc3QobnVsbCkKICAgIGlmICghdGhpcy5fYmxvY2tzLmlzRW1wdHkoKSB8fCB0aGlzLl9yYW5nZXMubGVuZ3RoICE9PSAwIHx8IHRoaXMuX3NlZWtzLmxlbmd0aCAhPT0gMCkgewogICAgICB0aGlzLl91cGRhdGVOb25QcmltYXJ5KHRydWUpCiAgICB9CiAgfQoKICAvLyBDYWxsZWQgZXh0ZXJuYWxseSB3aGVuIGEgY29uZmxpY3QgaGFzIGJlZW4gZGV0ZWN0ZWQgYW5kIHZlcmlmaWVkCiAgYXN5bmMgb25jb25mbGljdCgpIHsKICAgIGNvbnN0IGFsbCA9IFtdCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgewogICAgICBhbGwucHVzaChwZWVyLl9vbmNvbmZsaWN0KCkpCiAgICB9CiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoYWxsKQogIH0KCiAgYXN5bmMgYXBwbHlQZW5kaW5nUmVvcmcoKSB7CiAgICBpZiAodGhpcy5fYXBwbHlpbmdSZW9yZyAhPT0gbnVsbCkgewogICAgICBhd2FpdCB0aGlzLl9hcHBseWluZ1Jlb3JnCiAgICAgIHJldHVybiB0cnVlCiAgICB9CgogICAgZm9yIChsZXQgaSA9IHRoaXMuX3Jlb3Jncy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBmID0gdGhpcy5fcmVvcmdzW2ldCiAgICAgIGlmIChmLmJhdGNoICE9PSBudWxsICYmIGYuYmF0Y2guZmluaXNoZWQpIHsKICAgICAgICBhd2FpdCB0aGlzLl9hcHBseVJlb3JnKGYpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgYWRkVXBncmFkZShzZXNzaW9uKSB7CiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgewogICAgICBjb25zdCByZWYgPSB0aGlzLl91cGdyYWRlLmF0dGFjaChzZXNzaW9uKQogICAgICB0aGlzLl9jaGVja1VwZ3JhZGVJZkF2YWlsYWJsZSgpCiAgICAgIHJldHVybiByZWYKICAgIH0KCiAgICBjb25zdCByZWYgPSB0aGlzLl9hZGRVcGdyYWRlKCkuYXR0YWNoKHNlc3Npb24pCgogICAgdGhpcy51cGRhdGVBbGwoKQoKICAgIHJldHVybiByZWYKICB9CgogIGFkZEJsb2NrKHNlc3Npb24sIGluZGV4KSB7CiAgICBjb25zdCBiID0gdGhpcy5fYmxvY2tzLmFkZChpbmRleCwgUFJJT1JJVFkuSElHSCkKICAgIGNvbnN0IHJlZiA9IGIuYXR0YWNoKHNlc3Npb24pCgogICAgdGhpcy5fcXVldWVCbG9jayhiKQogICAgdGhpcy51cGRhdGVBbGwoKQoKICAgIHJldHVybiByZWYKICB9CgogIGFkZFNlZWsoc2Vzc2lvbiwgc2Vla2VyKSB7CiAgICBjb25zdCBzID0gbmV3IFNlZWtSZXF1ZXN0KHRoaXMsIHRoaXMuX3NlZWtzLCBzZWVrZXIpCiAgICBjb25zdCByZWYgPSBzLmF0dGFjaChzZXNzaW9uKQoKICAgIHRoaXMuX3NlZWtzLnB1c2gocykKICAgIHRoaXMudXBkYXRlQWxsKCkKCiAgICByZXR1cm4gcmVmCiAgfQoKICBhZGRSYW5nZSgKICAgIHNlc3Npb24sCiAgICB7CiAgICAgIHN0YXJ0ID0gMCwKICAgICAgZW5kID0gLTEsCiAgICAgIGxlbmd0aCA9IHRvTGVuZ3RoKHN0YXJ0LCBlbmQpLAogICAgICBibG9ja3MgPSBudWxsLAogICAgICBsaW5lYXIgPSBmYWxzZSwKICAgICAgaWZBdmFpbGFibGUgPSBmYWxzZQogICAgfSA9IHt9CiAgKSB7CiAgICBpZiAoYmxvY2tzICE9PSBudWxsKSB7CiAgICAgIC8vIGlmIHVzaW5nIGJsb2Nrcywgc3RhcnQsIGVuZCBqdXN0IGFjdHMgYXMgZnJhbWVzIGFyb3VuZCB0aGUgYmxvY2tzIGFycmF5CiAgICAgIHN0YXJ0ID0gMAogICAgICBlbmQgPSBsZW5ndGggPSBibG9ja3MubGVuZ3RoCiAgICB9CgogICAgY29uc3QgciA9IG5ldyBSYW5nZVJlcXVlc3QoCiAgICAgIHRoaXMsCiAgICAgIHRoaXMuX3JhbmdlcywKICAgICAgc3RhcnQsCiAgICAgIGxlbmd0aCA9PT0gLTEgPyAtMSA6IHN0YXJ0ICsgbGVuZ3RoLAogICAgICBsaW5lYXIsCiAgICAgIGlmQXZhaWxhYmxlLAogICAgICBibG9ja3MKICAgICkKCiAgICBjb25zdCByZWYgPSByLmF0dGFjaChzZXNzaW9uKQoKICAgIC8vIFRyaWdnZXIgdGhpcyB0byBzZWUgaWYgdGhpcyBpcyBhbHJlYWR5IHJlc29sdmVkLi4uCiAgICAvLyBBbHNvIGF1dG8gY29tcHJlc3NlcyB0aGUgcmFuZ2UgYmFzZWQgb24gbG9jYWwgYml0ZmllbGQKICAgIGNsYW1wUmFuZ2UodGhpcy5jb3JlLCByKQoKICAgIGlmIChyLmVuZCAhPT0gLTEgJiYgci5zdGFydCA+PSByLmVuZCkgewogICAgICB0aGlzLl9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHIpCiAgICAgIHJldHVybiByZWYKICAgIH0KCiAgICB0aGlzLnVwZGF0ZUFsbCgpCgogICAgcmV0dXJuIHJlZgogIH0KCiAgY2FuY2VsKHJlZikgewogICAgcmVmLmNvbnRleHQuZGV0YWNoKHJlZiwgbnVsbCkKICB9CgogIHN0YXRpYyBjbGVhclJlcXVlc3RzKHNlc3Npb24sIGVycikgewogICAgaWYgKHNlc3Npb24ubGVuZ3RoID09PSAwKSByZXR1cm4KCiAgICBjb25zdCB1cGRhdGVkID0gbmV3IFNldCgpCgogICAgd2hpbGUgKHNlc3Npb24ubGVuZ3RoID4gMCkgewogICAgICBjb25zdCByZWYgPSBzZXNzaW9uW3Nlc3Npb24ubGVuZ3RoIC0gMV0KICAgICAgdXBkYXRlZC5hZGQocmVmLmNvbnRleHQucmVwbGljYXRvcikKICAgICAgcmVmLmNvbnRleHQuZGV0YWNoKHJlZiwgZXJyKQogICAgfQoKICAgIGZvciAoY29uc3QgcmVwbGljYXRvciBvZiB1cGRhdGVkKSB7CiAgICAgIHJlcGxpY2F0b3IudXBkYXRlQWxsKCkKICAgIH0KICB9CgogIGNsZWFyUmVxdWVzdHMoc2Vzc2lvbiwgZXJyID0gbnVsbCkgewogICAgbGV0IGNsZWFyZWQgPSBmYWxzZQogICAgd2hpbGUgKHNlc3Npb24ubGVuZ3RoID4gMCkgewogICAgICBjb25zdCByZWYgPSBzZXNzaW9uW3Nlc3Npb24ubGVuZ3RoIC0gMV0KICAgICAgcmVmLmNvbnRleHQuZGV0YWNoKHJlZiwgZXJyKQogICAgICBjbGVhcmVkID0gdHJ1ZQogICAgfQoKICAgIGlmIChjbGVhcmVkKSB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICBfbWF0Y2hpbmdSZXF1ZXN0KHJlcSwgZGF0YSkgewogICAgaWYgKHRoaXMuYWxsb3dQdXNoKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CiAgICBpZiAoZGF0YS5ibG9jayAhPT0gbnVsbCAmJiAocmVxLmJsb2NrID09PSBudWxsIHx8IHJlcS5ibG9jay5pbmRleCAhPT0gZGF0YS5ibG9jay5pbmRleCkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICBpZiAoZGF0YS5oYXNoICE9PSBudWxsICYmIChyZXEuaGFzaCA9PT0gbnVsbCB8fCByZXEuaGFzaC5pbmRleCAhPT0gZGF0YS5oYXNoLmluZGV4KSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIGlmIChkYXRhLnNlZWsgIT09IG51bGwgJiYgKHJlcS5zZWVrID09PSBudWxsIHx8IHJlcS5zZWVrLmJ5dGVzICE9PSBkYXRhLnNlZWsuYnl0ZXMpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgaWYgKGRhdGEudXBncmFkZSAhPT0gbnVsbCAmJiByZXEudXBncmFkZSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIHJldHVybiByZXEuZm9yayA9PT0gZGF0YS5mb3JrCiAgfQoKICBfYWRkVXBncmFkZU1heWJlKCkgewogICAgcmV0dXJuIHRoaXMuZWFnZXJVcGdyYWRlID09PSB0cnVlID8gdGhpcy5fYWRkVXBncmFkZSgpIDogdGhpcy5fdXBncmFkZQogIH0KCiAgLy8gVE9ETzogdGhpcyBmdW5jdGlvbiBpcyBPVkVSIGNhbGxlZCBhdG0sIGF0IGVhY2ggdXBkYXRlUGVlci91cGRhdGVBbGwKICAvLyBpbnN0ZWFkIGl0cyBtb3JlIGVmZmljaWVudCB0byBvbmx5IGNhbGwgaXQgd2hlbiB0aGUgY29uZGl0aW9ucyBpbiBoZXJlIGNoYW5nZSAtIGllIG9uIHN5bmMvYWRkL3JlbW92ZSBwZWVyCiAgLy8gRG8gdGhpcyB3aGVuIHdlIGhhdmUgbW9yZSB0ZXN0cy4KICBfY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKSB7CiAgICBpZiAodGhpcy5faWZBdmFpbGFibGUgPiAwICYmIHRoaXMucGVlcnMubGVuZ3RoIDwgTUFYX1BFRVJTX1VQR1JBREUpIHJldHVybgogICAgaWYgKHRoaXMuX3VwZ3JhZGUgPT09IG51bGwgfHwgdGhpcy5fdXBncmFkZS5yZWZzLmxlbmd0aCA9PT0gMCkgcmV0dXJuCiAgICBpZiAodGhpcy5faGFkUGVlcnMgPT09IGZhbHNlICYmIHRoaXMuZmluZGluZ1BlZXJzID4gMCkgcmV0dXJuCgogICAgY29uc3QgbWF4UGVlcnMgPSBNYXRoLm1pbih0aGlzLnBlZXJzLmxlbmd0aCwgTUFYX1BFRVJTX1VQR1JBREUpCgogICAgLy8gY2hlY2sgaWYgYSBwZWVyIGNhbiB1cGdyYWRlIHVzCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhQZWVyczsgaSsrKSB7CiAgICAgIGNvbnN0IHBlZXIgPSB0aGlzLnBlZXJzW2ldCgogICAgICBpZiAocGVlci5yZW1vdGVTeW5jZWQgPT09IGZhbHNlKSByZXR1cm4KCiAgICAgIGlmICh0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID09PSAwICYmIHBlZXIucmVtb3RlTGVuZ3RoID4gMCkgcmV0dXJuCgogICAgICBpZiAocGVlci5yZW1vdGVMZW5ndGggPD0gdGhpcy5fdXBncmFkZS5sZW5ndGggfHwgcGVlci5yZW1vdGVGb3JrICE9PSB0aGlzLl91cGdyYWRlLmZvcmspIHsKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAocGVlci5zeW5jc1Byb2Nlc3NpbmcgPiAwKSByZXR1cm4KCiAgICAgIGlmIChwZWVyLmxlbmd0aEFja2VkICE9PSB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoICYmIHBlZXIucmVtb3RlRm9yayA9PT0gdGhpcy5jb3JlLnN0YXRlLmZvcmspIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgaWYgKHBlZXIucmVtb3RlQ2FuVXBncmFkZSA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB9CgogICAgLy8gY2hlY2sgaWYgcmVvcmdzIGluIHByb2dyZXNzLi4uCgogICAgaWYgKHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwpIHJldHVybgoKICAgIC8vIFRPRE86IHdlIHByb2Igc2hvdWxkIE5PVCB3YWl0IGZvciBpbmZsaWdodCByZW9yZ3MgaGVyZSwgc2VlbXMgYmV0dGVyIHRvIGp1c3QgcmVzb2x2ZSB0aGUgdXBncmFkZQogICAgLy8gYW5kIHRoZW4gYXBwbHkgdGhlIHJlb3JnIG9uIHRoZSBuZXh0IGNhbGwgaW4gY2FzZSBpdCdzIHNsb3cgLSBuZWVkcyBzb21lIHRlc3RpbmcgaW4gcHJhY3RpY2UKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3Jlb3Jncy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByID0gdGhpcy5fcmVvcmdzW2ldCiAgICAgIGlmIChyLmluZmxpZ2h0Lmxlbmd0aCA+IDApIHJldHVybgogICAgfQoKICAgIC8vIGlmIHNvbWV0aGluZyBpcyBpbmZsaWdodCwgd2FpdCBmb3IgdGhhdCBmaXJzdAogICAgaWYgKHRoaXMuX3VwZ3JhZGUuaW5mbGlnaHQubGVuZ3RoID4gMCkgcmV0dXJuCgogICAgLy8gbm90aGluZyB0byBkbywgaW5kaWNhdGUgbm8gdXBkYXRlIGF2YWlsCgogICAgY29uc3QgdSA9IHRoaXMuX3VwZ3JhZGUKICAgIHRoaXMuX3VwZ3JhZGUgPSBudWxsCiAgICB1LnJlc29sdmUoZmFsc2UpCiAgfQoKICBfYWRkVXBncmFkZSgpIHsKICAgIGlmICh0aGlzLl91cGdyYWRlICE9PSBudWxsKSByZXR1cm4gdGhpcy5fdXBncmFkZQoKICAgIC8vIFRPRE86IG5lZWRzIGEgcmVvcmc6IHRydWUvZmFsc2UgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGUgdXNlciByZXF1ZXN0ZWQgYSByZW9yZwogICAgdGhpcy5fdXBncmFkZSA9IG5ldyBVcGdyYWRlUmVxdWVzdCh0aGlzLCB0aGlzLmNvcmUuc3RhdGUuZm9yaywgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKCiAgICByZXR1cm4gdGhpcy5fdXBncmFkZQogIH0KCiAgX2FkZFJlb3JnKGZvcmssIHBlZXIpIHsKICAgIGlmICh0aGlzLmFsbG93Rm9yayA9PT0gZmFsc2UpIHJldHVybiBudWxsCgogICAgLy8gVE9ETzogZWFnZXIgZ2Mgb2xkIHJlb3JncyBmcm9tIHRoZSBzYW1lIHBlZXIKICAgIC8vIG5vdCBzdXBlciBpbXBvcnRhbnQgYmVjYXVzZSB0aGV5J2xsIGdldCBnYydlZCB3aGVuIHRoZSByZXF1ZXN0IGZpbmlzaGVzCiAgICAvLyBidXQganVzdCBzcGFtIHRoZSByZW1vdGUgY2FuIGRvIC4uLgoKICAgIGZvciAoY29uc3QgZiBvZiB0aGlzLl9yZW9yZ3MpIHsKICAgICAgaWYgKGYuZm9yayA+IGZvcmsgJiYgZi5iYXRjaCAhPT0gbnVsbCkgcmV0dXJuIG51bGwKICAgICAgaWYgKGYuZm9yayA9PT0gZm9yaykgcmV0dXJuIGYKICAgIH0KCiAgICBjb25zdCBmID0gewogICAgICBmb3JrLAogICAgICBpbmZsaWdodDogW10sCiAgICAgIGJhdGNoOiBudWxsCiAgICB9CgogICAgdGhpcy5fcmVvcmdzLnB1c2goZikKCiAgICAvLyBtYWludGFpbiBzb3J0ZWQgYnkgZm9yawogICAgbGV0IGkgPSB0aGlzLl9yZW9yZ3MubGVuZ3RoIC0gMQogICAgd2hpbGUgKGkgPiAwICYmIHRoaXMuX3Jlb3Jnc1tpIC0gMV0uZm9yayA+IGZvcmspIHsKICAgICAgdGhpcy5fcmVvcmdzW2ldID0gdGhpcy5fcmVvcmdzW2kgLSAxXQogICAgICB0aGlzLl9yZW9yZ3NbLS1pXSA9IGYKICAgIH0KCiAgICByZXR1cm4gZgogIH0KCiAgX3Nob3VsZFVwZ3JhZGUocGVlcikgewogICAgaWYgKHRoaXMuX3VwZ3JhZGUgIT09IG51bGwgJiYgdGhpcy5fdXBncmFkZS5pbmZsaWdodC5sZW5ndGggPiAwKSByZXR1cm4gZmFsc2UKICAgIHJldHVybiAoCiAgICAgIHBlZXIucmVtb3RlQ2FuVXBncmFkZSA9PT0gdHJ1ZSAmJgogICAgICBwZWVyLnJlbW90ZUxlbmd0aCA+IHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggJiYKICAgICAgcGVlci5sZW5ndGhBY2tlZCA9PT0gdGhpcy5jb3JlLnN0YXRlLmxlbmd0aAogICAgKQogIH0KCiAgX2F1dG9VcGdyYWRlKHBlZXIpIHsKICAgIHJldHVybiAoCiAgICAgIHRoaXMuX3VwZ3JhZGUgIT09IG51bGwgJiYKICAgICAgcGVlci5yZW1vdGVGb3JrID09PSB0aGlzLmNvcmUuc3RhdGUuZm9yayAmJgogICAgICB0aGlzLl9zaG91bGRVcGdyYWRlKHBlZXIpCiAgICApCiAgfQoKICBfYWRkUGVlcihwZWVyKSB7CiAgICB0aGlzLl9oYWRQZWVycyA9IHRydWUKICAgIHRoaXMucGVlcnMucHVzaChwZWVyKQogICAgdGhpcy51cGRhdGVQZWVyKHBlZXIpCiAgICB0aGlzLl9vbnBlZXJ1cGRhdGUodHJ1ZSwgcGVlcikKICB9CgogIF9yZXF1ZXN0RG9uZShpZCwgcm91bmR0cmlwKSB7CiAgICB0aGlzLl9pbmZsaWdodC5yZW1vdmUoaWQsIHJvdW5kdHJpcCkKICAgIGlmICh0aGlzLmlzRG93bmxvYWRpbmcoKSA9PT0gdHJ1ZSkgcmV0dXJuCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5zaWduYWxVcGdyYWRlKCkKICB9CgogIF9yZW1vdmVQZWVyKHBlZXIpIHsKICAgIHRoaXMucGVlcnMuc3BsaWNlKHRoaXMucGVlcnMuaW5kZXhPZihwZWVyKSwgMSkKCiAgICBpZiAodGhpcy5fbWFuaWZlc3RQZWVyID09PSBwZWVyKSB0aGlzLl9tYW5pZmVzdFBlZXIgPSBudWxsCgogICAgZm9yIChjb25zdCByZXEgb2YgdGhpcy5faW5mbGlnaHQpIHsKICAgICAgaWYgKHJlcS5wZWVyICE9PSBwZWVyKSBjb250aW51ZQogICAgICB0aGlzLl9pbmZsaWdodC5yZW1vdmUocmVxLmlkLCB0cnVlKQogICAgICB0aGlzLl9jbGVhclJlcXVlc3QocGVlciwgcmVxKQogICAgfQoKICAgIHRoaXMuX29ucGVlcnVwZGF0ZShmYWxzZSwgcGVlcikKICAgIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIF9xdWV1ZUJsb2NrKGIpIHsKICAgIGlmIChiLmluZmxpZ2h0Lmxlbmd0aCA+IDAgfHwgYi5xdWV1ZWQgPT09IHRydWUpIHJldHVybgogICAgYi5xdWV1ZWQgPSB0cnVlCiAgICB0aGlzLl9xdWV1ZWQucHVzaChiKQogIH0KCiAgX3Jlc29sdmVIYXNoTG9jYWxseShwZWVyLCByZXEpIHsKICAgIHRoaXMuX3JlcXVlc3REb25lKHJlcS5pZCwgZmFsc2UpCiAgICB0aGlzLl9yZXNvbHZlQmxvY2tSZXF1ZXN0KHRoaXMuX2hhc2hlcywgcmVxLmhhc2guaW5kZXggLyAyLCBudWxsLCByZXEpCiAgICB0aGlzLnVwZGF0ZVBlZXIocGVlcikKICB9CgogIC8vIFJ1bnMgaW4gdGhlIGJhY2tncm91bmQgLSBub3QgYWxsb3dlZCB0byB0aHJvdwogIGFzeW5jIF9yZXNvbHZlQmxvY2tzTG9jYWxseSgpIHsKICAgIC8vIFRPRE86IGNoZWNrIGlmIGZvcmsgY29tcGF0IGV0Yy4gUmVxdWlyZXMgdGhhdCB3ZSBwYXNzIGRvd24gdHJ1bmNhdGlvbiBpbmZvCgogICAgY29uc3QgY2xlYXIgPSBbXQogICAgY29uc3QgYmxvY2tzID0gW10KCiAgICBjb25zdCByZWFkZXIgPSB0aGlzLmNvcmUuc3RvcmFnZS5yZWFkKCkKICAgIGZvciAoY29uc3QgYiBvZiB0aGlzLl9ibG9ja3MpIHsKICAgICAgaWYgKHRoaXMuY29yZS5iaXRmaWVsZC5nZXQoYi5pbmRleCkgPT09IGZhbHNlKSBjb250aW51ZQogICAgICBibG9ja3MucHVzaCh0aGlzLl9yZXNvbHZlTG9jYWxCbG9jayhiLCByZWFkZXIsIGNsZWFyKSkKICAgIH0KICAgIHJlYWRlci50cnlGbHVzaCgpCgogICAgYXdhaXQgUHJvbWlzZS5hbGwoYmxvY2tzKQoKICAgIGlmICghY2xlYXIubGVuZ3RoKSByZXR1cm4KCiAgICAvLyBDdXJyZW50bHkgdGhlIGJsb2NrIHRyYWNrZXIgZG9lcyBub3Qgc3VwcG9ydCBkZWxldGVzIGR1cmluZyBpdGVyYXRpb24sIHNvIHdlIG1ha2UKICAgIC8vIHN1cmUgdG8gY2xlYXIgdGhlbSBhZnRlcndhcmRzLgogICAgZm9yIChjb25zdCBiIG9mIGNsZWFyKSB7CiAgICAgIHRoaXMuX2Jsb2Nrcy5yZW1vdmUoYi5pbmRleCkKICAgICAgcmVtb3ZlSG90c3dhcChiKQogICAgfQogIH0KCiAgYXN5bmMgX3Jlc29sdmVMb2NhbEJsb2NrKGIsIHJlYWRlciwgcmVzb2x2ZWQpIHsKICAgIHRyeSB7CiAgICAgIGIucmVzb2x2ZShhd2FpdCByZWFkZXIuZ2V0QmxvY2soYi5pbmRleCkpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgYi5yZWplY3QoZXJyKQogICAgICByZXR1cm4KICAgIH0KCiAgICByZXNvbHZlZC5wdXNoKGIpCiAgfQoKICBfcmVzb2x2ZUJsb2NrUmVxdWVzdCh0cmFja2VyLCBpbmRleCwgdmFsdWUsIHJlcSkgewogICAgY29uc3QgYiA9IHRyYWNrZXIucmVtb3ZlKGluZGV4KQogICAgaWYgKGIgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIHJlbW92ZUluZmxpZ2h0KGIuaW5mbGlnaHQsIHJlcSkKICAgIHJlbW92ZUhvdHN3YXAoYikKICAgIGIucXVldWVkID0gZmFsc2UKCiAgICBiLnJlc29sdmUodmFsdWUpCgogICAgaWYgKGIuaW5mbGlnaHQubGVuZ3RoID4gMCkgewogICAgICAvLyBpZiBhbnl0aGluZyBpcyBzdGlsbCBpbmZsaWdodCwgY2FuY2VsIGl0CiAgICAgIGZvciAobGV0IGkgPSBiLmluZmxpZ2h0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgcmVxID0gYi5pbmZsaWdodFtpXQogICAgICAgIHJlcS5wZWVyLl9jYW5jZWxSZXF1ZXN0KHJlcSkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVzb2x2ZVVwZ3JhZGVSZXF1ZXN0KHJlcSkgewogICAgaWYgKHJlcSAhPT0gbnVsbCkgcmVtb3ZlSW5mbGlnaHQodGhpcy5fdXBncmFkZS5pbmZsaWdodCwgcmVxKQoKICAgIGlmICgKICAgICAgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCA9PT0gdGhpcy5fdXBncmFkZS5sZW5ndGggJiYKICAgICAgdGhpcy5jb3JlLnN0YXRlLmZvcmsgPT09IHRoaXMuX3VwZ3JhZGUuZm9yawogICAgKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IHUgPSB0aGlzLl91cGdyYWRlCiAgICB0aGlzLl91cGdyYWRlID0gbnVsbAogICAgdS5yZXNvbHZlKHRydWUpCgogICAgcmV0dXJuIHRydWUKICB9CgogIF9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHJlcSkgewogICAgcmVxLnJlc29sdmUodHJ1ZSkKICAgIHJlcS5nYygpCiAgfQoKICBfY2xlYXJJbmZsaWdodEJsb2NrKHRyYWNrZXIsIHJlcSkgewogICAgY29uc3QgaXNCbG9jayA9IHRyYWNrZXIgPT09IHRoaXMuX2Jsb2NrcwogICAgY29uc3QgaW5kZXggPSBpc0Jsb2NrID09PSB0cnVlID8gcmVxLmJsb2NrLmluZGV4IDogcmVxLmhhc2guaW5kZXggLyAyCiAgICBjb25zdCBiID0gdHJhY2tlci5nZXQoaW5kZXgpCgogICAgaWYgKGIgPT09IG51bGwgfHwgcmVtb3ZlSW5mbGlnaHQoYi5pbmZsaWdodCwgcmVxKSA9PT0gZmFsc2UpIHJldHVybgoKICAgIGlmIChyZW1vdmVIb3Rzd2FwKGIpID09PSB0cnVlICYmIGIuaW5mbGlnaHQubGVuZ3RoID4gMCkgewogICAgICB0aGlzLmhvdHN3YXBzLmFkZChiKQogICAgfQoKICAgIGlmIChiLnJlZnMubGVuZ3RoID4gMCAmJiBpc0Jsb2NrID09PSB0cnVlKSB7CiAgICAgIHRoaXMuX3F1ZXVlQmxvY2soYikKICAgICAgcmV0dXJuCiAgICB9CgogICAgYi5nYygpCiAgfQoKICBfY2xlYXJJbmZsaWdodFVwZ3JhZGUocmVxKSB7CiAgICBpZiAodGhpcy5fdXBncmFkZSA9PT0gbnVsbCB8fCByZW1vdmVJbmZsaWdodCh0aGlzLl91cGdyYWRlLmluZmxpZ2h0LCByZXEpID09PSBmYWxzZSkgcmV0dXJuCiAgICB0aGlzLl91cGdyYWRlLmdjKCkKICB9CgogIF9jbGVhckluZmxpZ2h0U2Vla3MocmVxKSB7CiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fc2Vla3MpIHsKICAgICAgaWYgKHJlbW92ZUluZmxpZ2h0KHMuaW5mbGlnaHQsIHJlcSkgPT09IGZhbHNlKSBjb250aW51ZQogICAgICBzLmdjKCkKICAgIH0KICB9CgogIF9jbGVhckluZmxpZ2h0UmVvcmdzKHJlcSkgewogICAgZm9yIChjb25zdCByIG9mIHRoaXMuX3Jlb3JncykgewogICAgICByZW1vdmVJbmZsaWdodChyLmluZmxpZ2h0LCByZXEpCiAgICB9CiAgfQoKICBfY2xlYXJPbGRSZW9yZ3MoZm9yaykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9yZW9yZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgZiA9IHRoaXMuX3Jlb3Jnc1tpXQogICAgICBpZiAoZi5mb3JrID49IGZvcmspIGNvbnRpbnVlCiAgICAgIGlmIChpID09PSB0aGlzLl9yZW9yZ3MubGVuZ3RoIC0gMSkgdGhpcy5fcmVvcmdzLnBvcCgpCiAgICAgIGVsc2UgdGhpcy5fcmVvcmdzW2ldID0gdGhpcy5fcmVvcmdzLnBvcCgpCiAgICAgIGktLQogICAgfQogIH0KCiAgLy8gInNsb3ciIHVwZGF0ZXMgaGVyZSAtIGFzeW5jIGJ1dCBub3QgYWxsb3dlZCB0byBldmVyIHRocm93CiAgYXN5bmMgX3VwZGF0ZU5vblByaW1hcnkodXBkYXRlQWxsKSB7CiAgICAvLyBDaGVjayBpZiBydW5uaW5nLCBpZiBzbyBza2lwIGl0IGFuZCB0aGUgcnVubmluZyBvbmUgd2lsbCBpc3N1ZSBhbm90aGVyIHVwZGF0ZSBmb3IgdXMgKGRlYm91bmNlKQogICAgd2hpbGUgKCsrdGhpcy5fdXBkYXRlc1BlbmRpbmcgPT09IDEpIHsKICAgICAgbGV0IGxlbiA9IE1hdGgubWluKE1BWF9SQU5HRVMsIHRoaXMuX3Jhbmdlcy5sZW5ndGgpCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgY29uc3QgciA9IHRoaXMuX3Jhbmdlc1tpXQoKICAgICAgICBjbGFtcFJhbmdlKHRoaXMuY29yZSwgcikKCiAgICAgICAgaWYgKHIuZW5kICE9PSAtMSAmJiByLnN0YXJ0ID49IHIuZW5kKSB7CiAgICAgICAgICB0aGlzLl9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHIpCiAgICAgICAgICBpLS0KICAgICAgICAgIGlmIChsZW4gPiB0aGlzLl9yYW5nZXMubGVuZ3RoKSBsZW4tLQogICAgICAgICAgaWYgKHRoaXMuX3Jhbmdlcy5sZW5ndGggPT09IE1BWF9SQU5HRVMpIHVwZGF0ZUFsbCA9IHRydWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fc2Vla3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBzID0gdGhpcy5fc2Vla3NbaV0KCiAgICAgICAgbGV0IGVyciA9IG51bGwKICAgICAgICBsZXQgcmVzID0gbnVsbAoKICAgICAgICB0cnkgewogICAgICAgICAgcmVzID0gYXdhaXQgcy5zZWVrZXIudXBkYXRlKCkKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgZXJyID0gZXJyb3IKICAgICAgICB9CgogICAgICAgIGlmICghcmVzICYmICFlcnIpIGNvbnRpbnVlCgogICAgICAgIGlmIChpIDwgdGhpcy5fc2Vla3MubGVuZ3RoIC0gMSkgdGhpcy5fc2Vla3NbaV0gPSB0aGlzLl9zZWVrcy5wb3AoKQogICAgICAgIGVsc2UgdGhpcy5fc2Vla3MucG9wKCkKCiAgICAgICAgaS0tCgogICAgICAgIGlmIChlcnIpIHMucmVqZWN0KGVycikKICAgICAgICBlbHNlIHMucmVzb2x2ZShyZXMpCiAgICAgIH0KCiAgICAgIC8vIE5vIGFkZGl0aW9uYWwgdXBkYXRlcyBzY2hlZHVsZWQgLSBicmVhawogICAgICBpZiAoLS10aGlzLl91cGRhdGVzUGVuZGluZyA9PT0gMCkgYnJlYWsKICAgICAgLy8gRGVib3VuY2UgdGhlIGFkZGl0aW9uYWwgdXBkYXRlcyAtIGNvbnRpbnVlCiAgICAgIHRoaXMuX3VwZGF0ZXNQZW5kaW5nID0gMAogICAgfQoKICAgIGlmICh0aGlzLl9pbmZsaWdodC5pZGxlIHx8IHVwZGF0ZUFsbCkgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgX21heWJlUmVzb2x2ZUlmQXZhaWxhYmxlUmFuZ2VzKCkgewogICAgaWYgKHRoaXMuX2lmQXZhaWxhYmxlID4gMCB8fCAhdGhpcy5faW5mbGlnaHQuaWRsZSB8fCAhdGhpcy5fcmFuZ2VzLmxlbmd0aCkgcmV0dXJuCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBlZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLnBlZXJzW2ldLmRhdGFQcm9jZXNzaW5nID4gMCkgcmV0dXJuCiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9yYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgciA9IHRoaXMuX3Jhbmdlc1tpXQoKICAgICAgaWYgKHIuaWZBdmFpbGFibGUpIHsKICAgICAgICB0aGlzLl9yZXNvbHZlUmFuZ2VSZXF1ZXN0KHIpCiAgICAgICAgaS0tCiAgICAgIH0KICAgIH0KICB9CgogIF9jbGVhclJlcXVlc3QocGVlciwgcmVxKSB7CiAgICBpZiAocmVxLmJsb2NrICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRCbG9jayh0aGlzLl9ibG9ja3MsIHJlcSkKICAgICAgdGhpcy5fdW5tYXJrSW5mbGlnaHQocmVxLmJsb2NrLmluZGV4KQogICAgfQoKICAgIGlmIChyZXEuaGFzaCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9jbGVhckluZmxpZ2h0QmxvY2sodGhpcy5faGFzaGVzLCByZXEpCiAgICB9CgogICAgaWYgKHJlcS51cGdyYWRlICE9PSBudWxsICYmIHRoaXMuX3VwZ3JhZGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fY2xlYXJJbmZsaWdodFVwZ3JhZGUocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9zZWVrcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRTZWVrcyhyZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX3Jlb3Jncy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRSZW9yZ3MocmVxKQogICAgfQogIH0KCiAgX29ubm9kYXRhKHBlZXIsIHJlcSwgcmVhc29uKSB7CiAgICBpZiAocmVhc29uID09PSBJTlZBTElEX1JFUVVFU1QpIHsKICAgICAgcGVlci5zdGF0cy5iYWNrb2ZmcysrCiAgICAgIHRoaXMuc3RhdHMuYmFja29mZnMrKwoKICAgICAgaWYgKHBlZXIuc3RhdHMuYmFja29mZnMgPj0gTUFYX0JBQ0tPRkZTKSB7CiAgICAgICAgcGVlci5wYXVzZWQgPSB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBpZiAocmVxKSB7CiAgICAgIHRoaXMuX2NsZWFyUmVxdWVzdChwZWVyLCByZXEpCiAgICB9CgogICAgdGhpcy51cGRhdGVBbGwoKQogIH0KCiAgX29wZW5Ta2lwQml0ZmllbGQoKSB7CiAgICAvLyB0ZWNobmljYWxseSB0aGUgc2tpcCBiaXRmaWVsZCBnZXRzIGJpdHMgY2xlYXJlZCBpZiAuY2xlYXIoKSBpcyBjYWxsZWQKICAgIC8vIGFsc28gd2hpY2ggbWlnaHQgYmUgaW4gaW5mbGlnaHQgYWxzbywgYnV0IHRoYXQganVzdCByZXN1bHRzIGluIHRoYXQgc2VjdGlvbiBiZWluZyBvdmVyY2FsbGVkIHNob3J0bHkKICAgIC8vIHdvcnN0IGNhc2UsIHNvIG9rIGZvciBub3cKCiAgICBjb25zdCBiaXRmaWVsZCA9IHRoaXMuY29yZS5vcGVuU2tpcEJpdGZpZWxkKCkKCiAgICBmb3IgKGNvbnN0IHJlcSBvZiB0aGlzLl9pbmZsaWdodCkgewogICAgICBpZiAocmVxLmJsb2NrKSBiaXRmaWVsZC5zZXQocmVxLmJsb2NrLmluZGV4LCB0cnVlKSAvLyBza2lwCiAgICB9CiAgfQoKICBfbWFya1Byb2Nlc3NpbmcoaW5kZXgpIHsKICAgIGNvbnN0IGIgPSB0aGlzLl9ibG9ja3MuZ2V0KGluZGV4KQogICAgaWYgKGIpIHsKICAgICAgYi5wcm9jZXNzaW5nID0gdHJ1ZQogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBoID0gdGhpcy5faGFzaGVzLmdldChpbmRleCkKICAgIGlmIChoKSBoLnByb2Nlc3NpbmcgPSB0cnVlCiAgfQoKICBfbWFya1Byb2Nlc3NlZChpbmRleCkgewogICAgY29uc3QgYiA9IHRoaXMuX2Jsb2Nrcy5nZXQoaW5kZXgpCiAgICBpZiAoYikgcmV0dXJuIGIucHJvY2Vzc2VkKCkKCiAgICBjb25zdCBoID0gdGhpcy5faGFzaGVzLmdldChpbmRleCkKICAgIGlmIChoKSBoLnByb2Nlc3NlZCgpCiAgfQoKICBfbWFya0luZmxpZ2h0KGluZGV4KSB7CiAgICBpZiAodGhpcy5jb3JlLnNraXBCaXRmaWVsZCAhPT0gbnVsbCkgdGhpcy5jb3JlLnNraXBCaXRmaWVsZC5zZXQoaW5kZXgsIHRydWUpCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5fbWFya0luZmxpZ2h0KGluZGV4KQogIH0KCiAgX3VubWFya0luZmxpZ2h0KGluZGV4KSB7CiAgICBpZiAodGhpcy5jb3JlLnNraXBCaXRmaWVsZCAhPT0gbnVsbCkgewogICAgICB0aGlzLmNvcmUuc2tpcEJpdGZpZWxkLnNldChpbmRleCwgdGhpcy5jb3JlLmJpdGZpZWxkLmdldChpbmRleCkpCiAgICB9CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgcGVlci5fcmVzZXRNaXNzaW5nQmxvY2soaW5kZXgpCiAgfQoKICBmdWxseURvd25sb2FkZWQoKSB7CiAgICBpZiAoIXRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpIHJldHVybiBmYWxzZQogICAgcmV0dXJuIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggPT09IHRoaXMuY29yZS5oZWFkZXIuaGludHMuY29udGlndW91c0xlbmd0aAogIH0KCiAgX29uZGF0YShwZWVyLCByZXEsIGRhdGEpIHsKICAgIGlmIChyZXEpIHsKICAgICAgcmVxLmVsYXBzZWQgPSBEYXRlLm5vdygpIC0gcmVxLnRpbWVzdGFtcAogICAgfQoKICAgIGlmIChkYXRhLmJsb2NrICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVCbG9ja1JlcXVlc3QodGhpcy5fYmxvY2tzLCBkYXRhLmJsb2NrLmluZGV4LCBkYXRhLmJsb2NrLnZhbHVlLCByZXEpCiAgICAgIHRoaXMuX29uZG93bmxvYWQoZGF0YS5ibG9jay5pbmRleCwgZGF0YS5ibG9jay52YWx1ZS5ieXRlTGVuZ3RoLCBwZWVyLCByZXEpCiAgICB9CgogICAgaWYgKGRhdGEuaGFzaCAhPT0gbnVsbCAmJiAoZGF0YS5oYXNoLmluZGV4ICYgMSkgPT09IDApIHsKICAgICAgdGhpcy5fcmVzb2x2ZUJsb2NrUmVxdWVzdCh0aGlzLl9oYXNoZXMsIGRhdGEuaGFzaC5pbmRleCAvIDIsIG51bGwsIHJlcSkKICAgIH0KCiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9yZXNvbHZlVXBncmFkZVJlcXVlc3QocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9zZWVrcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRTZWVrcyhyZXEpCiAgICB9CgogICAgaWYgKHRoaXMuX3Jlb3Jncy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX2NsZWFySW5mbGlnaHRSZW9yZ3MocmVxKQogICAgfQoKICAgIGlmICh0aGlzLl9tYW5pZmVzdFBlZXIgPT09IHBlZXIgJiYgdGhpcy5jb3JlLmhlYWRlci5tYW5pZmVzdCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9tYW5pZmVzdFBlZXIgPSBudWxsCiAgICB9CgogICAgaWYgKHRoaXMuX3NlZWtzLmxlbmd0aCA+IDAgfHwgdGhpcy5fcmFuZ2VzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5fdXBkYXRlTm9uUHJpbWFyeSh0aGlzLl9zZWVrcy5sZW5ndGggPiAwKQogICAgfQoKICAgIHRoaXMudXBkYXRlUGVlcihwZWVyKQogIH0KCiAgX29ud2FudChwZWVyLCBzdGFydCwgbGVuZ3RoKSB7CiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSkgcmV0dXJuCgogICAgY29uc3QgY29udGlnID0gTWF0aC5taW4odGhpcy5jb3JlLnN0YXRlLmxlbmd0aCwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKQoKICAgIGlmIChzdGFydCArIGxlbmd0aCA8IGNvbnRpZyB8fCB0aGlzLmNvcmUuc3RhdGUubGVuZ3RoID09PSBjb250aWcpIHsKICAgICAgcGVlci53aXJlUmFuZ2Uuc2VuZCh7CiAgICAgICAgZHJvcDogZmFsc2UsCiAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgbGVuZ3RoOiBjb250aWcKICAgICAgfSkKICAgICAgaW5jcmVtZW50VHgocGVlci5zdGF0cy53aXJlUmFuZ2UsIHRoaXMuc3RhdHMud2lyZVJhbmdlKQogICAgICByZXR1cm4KICAgIH0KCiAgICBsZW5ndGggPSBNYXRoLm1pbihsZW5ndGgsIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGggLSBzdGFydCkKCiAgICBwZWVyLnByb3RvbXV4LmNvcmsoKQoKICAgIGZvciAoY29uc3QgbXNnIG9mIHRoaXMuY29yZS5iaXRmaWVsZC53YW50KHN0YXJ0LCBsZW5ndGgpKSB7CiAgICAgIHBlZXIud2lyZUJpdGZpZWxkLnNlbmQobXNnKQogICAgICBpbmNyZW1lbnRUeChwZWVyLnN0YXRzLndpcmVCaXRmaWVsZCwgdGhpcy5zdGF0cy53aXJlQml0ZmllbGQpCiAgICB9CgogICAgcGVlci5wcm90b211eC51bmNvcmsoKQogIH0KCiAgYXN5bmMgX29ucmVvcmdkYXRhKHBlZXIsIHJlcSwgZGF0YSkgewogICAgY29uc3QgbmV3QmF0Y2ggPSBkYXRhLnVwZ3JhZGUgJiYgKGF3YWl0IHRoaXMuY29yZS52ZXJpZnlSZW9yZyhkYXRhKSkKICAgIGNvbnN0IGYgPSB0aGlzLl9hZGRSZW9yZyhkYXRhLmZvcmssIHBlZXIpCgogICAgaWYgKGYgPT09IG51bGwpIHsKICAgICAgdGhpcy51cGRhdGVBbGwoKQogICAgICByZXR1cm4KICAgIH0KCiAgICByZW1vdmVJbmZsaWdodChmLmluZmxpZ2h0LCByZXEpCgogICAgaWYgKGYuYmF0Y2gpIHsKICAgICAgYXdhaXQgZi5iYXRjaC51cGRhdGUoZGF0YSkKICAgIH0gZWxzZSBpZiAoZGF0YS51cGdyYWRlKSB7CiAgICAgIGYuYmF0Y2ggPSBuZXdCYXRjaAoKICAgICAgLy8gUmVtb3ZlICJvbGRlciIgcmVvcmdzIGluIHByb2dyZXNzIGFzIHdlIGp1c3QgdmVyaWZpZWQgdGhpcyBvbmUuCiAgICAgIHRoaXMuX2NsZWFyT2xkUmVvcmdzKGYuZm9yaykKICAgIH0KCiAgICBpZiAoZi5iYXRjaCAmJiBmLmJhdGNoLmZpbmlzaGVkKSB7CiAgICAgIGlmICh0aGlzLl9hZGRVcGdyYWRlTWF5YmUoKSAhPT0gbnVsbCkgewogICAgICAgIGF3YWl0IHRoaXMuX2FwcGx5UmVvcmcoZikKICAgICAgfQogICAgfQoKICAgIHRoaXMudXBkYXRlQWxsKCkKICB9CgogIC8vIE5ldmVyIHRocm93cywgYWxsb3dlZCB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICBhc3luYyBfYXBwbHlSZW9yZyhmKSB7CiAgICAvLyBUT0RPOiBtb3JlIG9wdGltYWwgaGVyZSB0byBjaGVjayBpZiBwb3RlbnRpYWxseSBhIGJldHRlciByZW9yZwogICAgLy8gaXMgYXZhaWxhYmxlLCBpZSBoaWdoZXIgZm9yaywgYW5kIHJlcXVlc3QgdGhhdCBvbmUgZmlyc3QuCiAgICAvLyBUaGlzIHdpbGwgcmVxdWVzdCB0aGF0IG9uZSBhZnRlciB0aGlzIGZpbmlzaGVzLCB3aGljaCBpcyBmaW5lLCBidXQgd2UKICAgIC8vIHNob3VsZCBpbnZlc3RpZ2F0ZSB0aGUgY29tcGxleGl0eSBpbiBnb2luZyB0aGUgb3RoZXIgd2F5CgogICAgY29uc3QgdSA9IHRoaXMuX3VwZ3JhZGUKCiAgICB0aGlzLl9yZW9yZ3MgPSBbXSAvLyBjbGVhciBhbGwgYXMgdGhlIG5vZGVzIGFyZSBhZ2FpbnN0IHRoZSBvbGQgdHJlZSAtIGVhc2llcgogICAgdGhpcy5fYXBwbHlpbmdSZW9yZyA9IHRoaXMuY29yZS5yZW9yZyhmLmJhdGNoLCBudWxsKSAvLyBUT0RPOiBudWxsIHNob3VsZCBiZSB0aGUgZmlyc3QvbGFzdCBwZWVyPwoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2FwcGx5aW5nUmVvcmcKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl91cGdyYWRlID0gbnVsbAogICAgICB1LnJlamVjdChlcnIpCiAgICB9CgogICAgdGhpcy5fYXBwbHlpbmdSZW9yZyA9IG51bGwKCiAgICBpZiAodGhpcy5fdXBncmFkZSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9yZXNvbHZlVXBncmFkZVJlcXVlc3QobnVsbCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgdGhpcy5fdXBkYXRlRm9yayhwZWVyKQoKICAgIC8vIFRPRE86IGFsbCB0aGUgcmVtYWluaW5nIGlzIGEgdG1wIHdvcmthcm91bmQgdW50aWwgd2UgaGF2ZSBhIGZsYWcvd2F5IGZvciBBTllfRk9SSwogICAgZm9yIChjb25zdCByIG9mIHRoaXMuX3JhbmdlcykgewogICAgICByLnN0YXJ0ID0gci51c2VyU3RhcnQKICAgICAgci5lbmQgPSByLnVzZXJFbmQKICAgIH0KCiAgICB0aGlzLnVwZGF0ZUFsbCgpCiAgfQoKICBfbWF5YmVVcGRhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5fdXBncmFkZSAhPT0gbnVsbCAmJiB0aGlzLl91cGdyYWRlLmluZmxpZ2h0Lmxlbmd0aCA9PT0gMAogIH0KCiAgX21heWJlUmVxdWVzdE1hbmlmZXN0KCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5oZWFkZXIubWFuaWZlc3QgPT09IG51bGwgJiYgdGhpcy5fbWFuaWZlc3RQZWVyID09PSBudWxsCiAgfQoKICBfdXBkYXRlRm9yayhwZWVyKSB7CiAgICBpZiAoCiAgICAgIHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwgfHwKICAgICAgdGhpcy5hbGxvd0ZvcmsgPT09IGZhbHNlIHx8CiAgICAgIHBlZXIucmVtb3RlRm9yayA8PSB0aGlzLmNvcmUuc3RhdGUuZm9yawogICAgKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGNvbnN0IGYgPSB0aGlzLl9hZGRSZW9yZyhwZWVyLnJlbW90ZUZvcmssIHBlZXIpCgogICAgLy8gVE9ETzogb25lIHBlciBwZWVyIGlzIGJldHRlcgogICAgaWYgKGYgIT09IG51bGwgJiYgZi5iYXRjaCA9PT0gbnVsbCAmJiBmLmluZmxpZ2h0Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gcGVlci5fcmVxdWVzdEZvcmtQcm9vZihmKQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgX3VwZGF0ZUhvdHN3YXAocGVlcikgewogICAgY29uc3QgbWF4SG90c3dhcHMgPSBwZWVyLmdldE1heEhvdHN3YXBJbmZsaWdodCgpCiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSB8fCBwZWVyLmluZmxpZ2h0ID49IG1heEhvdHN3YXBzKSByZXR1cm4KCiAgICBmb3IgKGNvbnN0IGIgb2YgdGhpcy5ob3Rzd2Fwcy5waWNrKHBlZXIpKSB7CiAgICAgIGlmIChwZWVyLl9yZXF1ZXN0QmxvY2soYikgPT09IGZhbHNlKSBjb250aW51ZQogICAgICBwZWVyLnN0YXRzLmhvdHN3YXBzKysKICAgICAgcGVlci5yZXBsaWNhdG9yLnN0YXRzLmhvdHN3YXBzKysKICAgICAgaWYgKHBlZXIuaW5mbGlnaHQgPj0gbWF4SG90c3dhcHMpIGJyZWFrCiAgICB9CiAgfQoKICBfdXBkYXRlUGVlcihwZWVyKSB7CiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSB8fCBwZWVyLmluZmxpZ2h0ID49IHBlZXIuZ2V0TWF4SW5mbGlnaHQoKSB8fCAhcGVlci5yZW1vdGVVcGxvYWRpbmcpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgLy8gRWFnZXJseSByZXF1ZXN0IHRoZSBtYW5pZmVzdCBldmVuIGlmIHRoZSByZW1vdGUgbGVuZ3RoIGlzIDAuIElmIG5vdCAwIHdlJ2xsIGdldCBhcyBwYXJ0IG9mIHRoZSB1cGdyYWRlIHJlcXVlc3QuLi4KICAgIGlmICgKICAgICAgdGhpcy5fbWF5YmVSZXF1ZXN0TWFuaWZlc3QoKSA9PT0gdHJ1ZSAmJgogICAgICBwZWVyLnJlbW90ZUxlbmd0aCA9PT0gMCAmJgogICAgICBwZWVyLnJlbW90ZUhhc01hbmlmZXN0ID09PSB0cnVlCiAgICApIHsKICAgICAgdGhpcy5fbWFuaWZlc3RQZWVyID0gcGVlcgogICAgICBwZWVyLl9yZXF1ZXN0TWFuaWZlc3QoKQogICAgfQoKICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9zZWVrcykgewogICAgICBpZiAocy5pbmZsaWdodC5sZW5ndGggPiAwKSBjb250aW51ZSAvLyBUT0RPOiBvbmUgcGVyIHBlZXIgaXMgYmV0dGVyCiAgICAgIGlmIChwZWVyLl9yZXF1ZXN0U2VlayhzKSA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICAvLyBJbXBsaWVkIHRoYXQgYW55IGJsb2NrIGluIHRoZSBxdWV1ZSBzaG91bGQgYmUgcmVxdWVzdGVkLCBubyBtYXR0ZXIgaG93IG1hbnkgaW5mbGlnaHRzCiAgICBjb25zdCBibGtzID0gbmV3IFJhbmRvbUl0ZXJhdG9yKHRoaXMuX3F1ZXVlZCkKCiAgICBmb3IgKGNvbnN0IGIgb2YgYmxrcykgewogICAgICBpZiAoYi5xdWV1ZWQgPT09IGZhbHNlIHx8IHBlZXIuX3JlcXVlc3RCbG9jayhiKSA9PT0gdHJ1ZSkgewogICAgICAgIGIucXVldWVkID0gZmFsc2UKICAgICAgICBibGtzLmRlcXVldWUoKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIF91cGRhdGVQZWVyTm9uUHJpbWFyeShwZWVyKSB7CiAgICBpZiAoIXBlZXIuaXNBY3RpdmUoKSB8fCBwZWVyLmluZmxpZ2h0ID49IHBlZXIuZ2V0TWF4SW5mbGlnaHQoKSB8fCAhcGVlci5yZW1vdGVVcGxvYWRpbmcpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgY29uc3QgcmFuZ2VzID0gbmV3IFJhbmRvbUl0ZXJhdG9yKHRoaXMuX3JhbmdlcykKICAgIGxldCB0cmllZCA9IDAKCiAgICBmb3IgKGNvbnN0IHIgb2YgcmFuZ2VzKSB7CiAgICAgIGlmIChwZWVyLl9yZXF1ZXN0UmFuZ2UocikgPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGlmICgrK3RyaWVkID49IE1BWF9SQU5HRVMpIGJyZWFrCiAgICB9CgogICAgLy8gSXRlcmF0ZSBmcm9tIG5ld2VzdCBmb3JrIHRvIG9sZGVzdCBmb3JrLi4uCiAgICBmb3IgKGxldCBpID0gdGhpcy5fcmVvcmdzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLl9yZW9yZ3NbaV0KICAgICAgaWYgKGYuYmF0Y2ggIT09IG51bGwgJiYgZi5pbmZsaWdodC5sZW5ndGggPT09IDAgJiYgcGVlci5fcmVxdWVzdEZvcmtSYW5nZShmKSA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5fbWF5YmVVcGRhdGUoKSA9PT0gdHJ1ZSAmJiBwZWVyLl9yZXF1ZXN0VXBncmFkZSh0aGlzLl91cGdyYWRlKSA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIHJldHVybiBmYWxzZQogIH0KCiAgdXBkYXRlUGVlcihwZWVyKSB7CiAgICAvLyBRdWljayBzaG9ydGN1dCB0byB3YWl0IGZvciBmbHVzaGluZyByZW9yZ3MgLSBub3QgbmVlZGVkIGJ1dCBsZXNzIHdhaXN0ZWQgcmVxdWVzdHMKICAgIGlmICh0aGlzLl9hcHBseWluZ1Jlb3JnICE9PSBudWxsKSByZXR1cm4KCiAgICB3aGlsZSAodGhpcy5fdXBkYXRlUGVlcihwZWVyKSA9PT0gdHJ1ZSk7CiAgICB3aGlsZSAodGhpcy5fdXBkYXRlUGVlck5vblByaW1hcnkocGVlcikgPT09IHRydWUpOwoKICAgIGlmICh0aGlzLnBlZXJzLmxlbmd0aCA+IDEgJiYgdGhpcy5fYmxvY2tzLmlzRW1wdHkoKSA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5fdXBkYXRlSG90c3dhcChwZWVyKQogICAgfQoKICAgIHRoaXMuX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkKICAgIHRoaXMuX21heWJlUmVzb2x2ZUlmQXZhaWxhYmxlUmFuZ2VzKCkKICB9CgogIHVwZGF0ZUFsbCgpIHsKICAgIC8vIFF1aWNrIHNob3J0Y3V0IHRvIHdhaXQgZm9yIGZsdXNoaW5nIHJlb3JncyAtIG5vdCBuZWVkZWQgYnV0IGxlc3Mgd2Fpc3RlZCByZXF1ZXN0cwogICAgaWYgKHRoaXMuX2FwcGx5aW5nUmVvcmcgIT09IG51bGwpIHJldHVybgoKICAgIGNvbnN0IHBlZXJzID0gbmV3IFJhbmRvbUl0ZXJhdG9yKHRoaXMucGVlcnMpCgogICAgZm9yIChjb25zdCBwZWVyIG9mIHBlZXJzKSB7CiAgICAgIGlmICh0aGlzLl91cGRhdGVQZWVyKHBlZXIpID09PSB0cnVlKSB7CiAgICAgICAgcGVlcnMucmVxdWV1ZSgpCiAgICAgIH0KICAgIH0KCiAgICAvLyBDaGVjayBpZiB3ZSBjYW4gc2tpcCB0aGUgbm9uIHByaW1hcnkgY2hlY2sgZnVsbHkKICAgIGlmICh0aGlzLl9tYXliZVVwZGF0ZSgpID09PSBmYWxzZSAmJiB0aGlzLl9yYW5nZXMubGVuZ3RoID09PSAwICYmIHRoaXMuX3Jlb3Jncy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5fY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKQogICAgICByZXR1cm4KICAgIH0KCiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgcGVlcnMucmVzdGFydCgpKSB7CiAgICAgIGlmICh0aGlzLl91cGRhdGVQZWVyTm9uUHJpbWFyeShwZWVyKSA9PT0gdHJ1ZSkgewogICAgICAgIHBlZXJzLnJlcXVldWUoKQogICAgICB9CiAgICB9CgogICAgdGhpcy5fY2hlY2tVcGdyYWRlSWZBdmFpbGFibGUoKQogICAgdGhpcy5fbWF5YmVSZXNvbHZlSWZBdmFpbGFibGVSYW5nZXMoKQogIH0KCiAgb25wZWVyZGVzdHJveSgpIHsKICAgIGlmICgtLXRoaXMuX2FjdGl2ZSA9PT0gMCkgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIGF0dGFjaGVkKHByb3RvbXV4KSB7CiAgICByZXR1cm4gdGhpcy5fYXR0YWNoZWQuaGFzKHByb3RvbXV4KQogIH0KCiAgYXR0YWNoVG8ocHJvdG9tdXgpIHsKICAgIGlmICh0aGlzLmNvcmUuY2xvc2VkKSByZXR1cm4KCiAgICBjb25zdCBtYWtlUGVlciA9IHRoaXMuX21ha2VQZWVyLmJpbmQodGhpcywgcHJvdG9tdXgpCgogICAgdGhpcy5fYXR0YWNoZWQuYWRkKHByb3RvbXV4KQogICAgcHJvdG9tdXgucGFpcih7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkgfSwgbWFrZVBlZXIpCiAgICBwcm90b211eC5zdHJlYW0uc2V0TWF4TGlzdGVuZXJzKDApCiAgICBwcm90b211eC5zdHJlYW0ub24oJ2Nsb3NlJywgdGhpcy5fb25zdHJlYW1jbG9zZSkKCiAgICB0aGlzLl9pZkF2YWlsYWJsZSsrCiAgICB0aGlzLl9hY3RpdmUrKwoKICAgIHByb3RvbXV4LnN0cmVhbS5vcGVuZWQudGhlbigob3BlbmVkKSA9PiB7CiAgICAgIHRoaXMuX2lmQXZhaWxhYmxlLS0KICAgICAgdGhpcy5fYWN0aXZlLS0KCiAgICAgIGlmIChvcGVuZWQgJiYgIXRoaXMuZGVzdHJveWVkKSBtYWtlUGVlcigpCiAgICAgIHRoaXMuX2NoZWNrVXBncmFkZUlmQXZhaWxhYmxlKCkKCiAgICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgICB9KQogIH0KCiAgZGV0YWNoRnJvbShwcm90b211eCkgewogICAgaWYgKHRoaXMuX2F0dGFjaGVkLmRlbGV0ZShwcm90b211eCkpIHsKICAgICAgcHJvdG9tdXguc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIHRoaXMuX29uc3RyZWFtY2xvc2UpCiAgICAgIHByb3RvbXV4LnVucGFpcih7IHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkgfSkKICAgIH0KICB9CgogIGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5wZWVycy5sZW5ndGggPT09IDAgJiYgdGhpcy5fYWN0aXZlID09PSAwCiAgfQoKICBjbG9zZSgpIHsKICAgIGNvbnN0IHdhaXRpbmcgPSBbXQoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlZXJzKSB7CiAgICAgIHdhaXRpbmcucHVzaChwZWVyLmNoYW5uZWwuZnVsbHlDbG9zZWQoKSkKICAgIH0KCiAgICB0aGlzLmRlc3Ryb3koKQogICAgcmV0dXJuIFByb21pc2UuYWxsKHdhaXRpbmcpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIGlmICh0aGlzLl9kb3dubG9hZGluZ1RpbWVyKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9kb3dubG9hZGluZ1RpbWVyKQogICAgICB0aGlzLl9kb3dubG9hZGluZ1RpbWVyID0gbnVsbAogICAgfQoKICAgIHdoaWxlICh0aGlzLnBlZXJzLmxlbmd0aCkgewogICAgICBjb25zdCBwZWVyID0gdGhpcy5wZWVyc1t0aGlzLnBlZXJzLmxlbmd0aCAtIDFdCiAgICAgIHRoaXMuZGV0YWNoRnJvbShwZWVyLnByb3RvbXV4KQogICAgICBwZWVyLmNoYW5uZWwuY2xvc2UoKSAvLyBwZWVyIGlzIHJlbW92ZWQgZnJvbSBhcnJheSBpbiBvbmNsb3NlCiAgICB9CgogICAgZm9yIChjb25zdCBwcm90b211eCBvZiB0aGlzLl9hdHRhY2hlZCkgewogICAgICB0aGlzLmRldGFjaEZyb20ocHJvdG9tdXgpCiAgICB9CiAgfQoKICBfbWFrZVBlZXIocHJvdG9tdXgpIHsKICAgIGNvbnN0IHJlcGxpY2F0b3IgPSB0aGlzCiAgICBpZiAocHJvdG9tdXgub3BlbmVkKHsgcHJvdG9jb2w6ICdoeXBlcmNvcmUvYWxwaGEnLCBpZDogdGhpcy5jb3JlLmRpc2NvdmVyeUtleSB9KSkgewogICAgICByZXR1cm4gb25ub2NoYW5uZWwoKQogICAgfQoKICAgIGNvbnN0IGNoYW5uZWwgPSBwcm90b211eC5jcmVhdGVDaGFubmVsKHsKICAgICAgdXNlckRhdGE6IG51bGwsCiAgICAgIHByb3RvY29sOiAnaHlwZXJjb3JlL2FscGhhJywKICAgICAgYWxpYXNlczogWydoeXBlcmNvcmUnXSwKICAgICAgaWQ6IHRoaXMuY29yZS5kaXNjb3ZlcnlLZXksCiAgICAgIGhhbmRzaGFrZTogbS53aXJlLmhhbmRzaGFrZSwKICAgICAgbWVzc2FnZXM6IFsKICAgICAgICB7IGVuY29kaW5nOiBtLndpcmUuc3luYywgb25tZXNzYWdlOiBvbndpcmVzeW5jIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLnJlcXVlc3QsIG9ubWVzc2FnZTogb253aXJlcmVxdWVzdCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5jYW5jZWwsIG9ubWVzc2FnZTogb253aXJlY2FuY2VsIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLmRhdGEsIG9ubWVzc2FnZTogb253aXJlZGF0YSB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS5ub0RhdGEsIG9ubWVzc2FnZTogb253aXJlbm9kYXRhIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLndhbnQsIG9ubWVzc2FnZTogb253aXJld2FudCB9LAogICAgICAgIHsgZW5jb2Rpbmc6IG0ud2lyZS51bndhbnQsIG9ubWVzc2FnZTogb253aXJldW53YW50IH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLmJpdGZpZWxkLCBvbm1lc3NhZ2U6IG9ud2lyZWJpdGZpZWxkIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLnJhbmdlLCBvbm1lc3NhZ2U6IG9ud2lyZXJhbmdlIH0sCiAgICAgICAgeyBlbmNvZGluZzogbS53aXJlLmV4dGVuc2lvbiwgb25tZXNzYWdlOiBvbndpcmVleHRlbnNpb24gfQogICAgICBdLAogICAgICBvbm9wZW46IG9ud2lyZW9wZW4sCiAgICAgIG9uY2xvc2U6IG9ud2lyZWNsb3NlLAogICAgICBvbmRyYWluOiBvbndpcmVkcmFpbiwKICAgICAgb25kZXN0cm95OiBvbndpcmVkZXN0cm95CiAgICB9KQoKICAgIGlmIChjaGFubmVsID09PSBudWxsKSByZXR1cm4gb25ub2NoYW5uZWwoKQoKICAgIGNvbnN0IHBlZXIgPSBuZXcgUGVlcihyZXBsaWNhdG9yLCBwcm90b211eCwgY2hhbm5lbCwgdGhpcy5pbmZsaWdodFJhbmdlKQogICAgY29uc3Qgc3RyZWFtID0gcHJvdG9tdXguc3RyZWFtCgogICAgcGVlci5jaGFubmVsLm9wZW4oewogICAgICBzZWVrczogdHJ1ZSwKICAgICAgY2FwYWJpbGl0eTogY2Fwcy5yZXBsaWNhdGUoc3RyZWFtLmlzSW5pdGlhdG9yLCB0aGlzLmNvcmUua2V5LCBzdHJlYW0uaGFuZHNoYWtlSGFzaCkKICAgIH0pCgogICAgcmV0dXJuIHRydWUKCiAgICBmdW5jdGlvbiBvbm5vY2hhbm5lbCgpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBfb25wZWVydXBkYXRlKGFkZGVkLCBwZWVyKSB7CiAgICBjb25zdCBuYW1lID0gYWRkZWQgPyAncGVlci1hZGQnIDogJ3BlZXItcmVtb3ZlJwogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmNvcmUubW9uaXRvcnMKCiAgICBmb3IgKGxldCBpID0gc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgc2Vzc2lvbnNbaV0uZW1pdChuYW1lLCBwZWVyKQoKICAgICAgaWYgKGFkZGVkKSB7CiAgICAgICAgZm9yIChjb25zdCBleHQgb2Ygc2Vzc2lvbnNbaV0uZXh0ZW5zaW9ucy52YWx1ZXMoKSkgewogICAgICAgICAgcGVlci5leHRlbnNpb25zLnNldChleHQubmFtZSwgZXh0KQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgX29uZG93bmxvYWQoaW5kZXgsIGJ5dGVMZW5ndGgsIGZyb20sIHJlcSkgewogICAgY29uc3Qgc2Vzc2lvbnMgPSB0aGlzLmNvcmUubW9uaXRvcnMKCiAgICBmb3IgKGxldCBpID0gc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcyA9IHNlc3Npb25zW2ldCiAgICAgIHMuZW1pdCgnZG93bmxvYWQnLCBpbmRleCwgYnl0ZUxlbmd0aCAtIHMucGFkZGluZywgZnJvbSwgcmVxKQogICAgfQogIH0KCiAgX29udXBsb2FkKGluZGV4LCBieXRlTGVuZ3RoLCBmcm9tKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuY29yZS5tb25pdG9ycwoKICAgIGZvciAobGV0IGkgPSBzZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzID0gc2Vzc2lvbnNbaV0KICAgICAgcy5lbWl0KCd1cGxvYWQnLCBpbmRleCwgYnl0ZUxlbmd0aCAtIHMucGFkZGluZywgZnJvbSkKICAgIH0KICB9CgogIF9vbmludmFsaWRkYXRhKGVyciwgcmVxLCByZXMsIGZyb20pIHsKICAgIGNvbnN0IHNlc3Npb25zID0gdGhpcy5jb3JlLm1vbml0b3JzCgogICAgdGhpcy5zdGF0cy5pbnZhbGlkRGF0YSsrCiAgICBmcm9tLnN0YXRzLmludmFsaWREYXRhKysKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2Vzc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgc2Vzc2lvbnNbaV0uZW1pdCgndmVyaWZpY2F0aW9uLWVycm9yJywgZXJyLCByZXEsIHJlcywgZnJvbSkKICAgIH0KICB9CgogIF9vbmludmFsaWRyZXF1ZXN0KGVyciwgcmVxLCBmcm9tKSB7CiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuY29yZS5tb25pdG9ycwoKICAgIGZyb20uc3RhdHMuaW52YWxpZFJlcXVlc3RzKysKICAgIHRoaXMuc3RhdHMuaW52YWxpZFJlcXVlc3RzKysKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2Vzc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgc2Vzc2lvbnNbaV0uZW1pdCgnaW52YWxpZC1yZXF1ZXN0JywgZXJyLCByZXEsIGZyb20pCiAgICB9CiAgfQp9CgpmdW5jdGlvbiByZW1vdmVIb3Rzd2FwKGJsb2NrKSB7CiAgaWYgKGJsb2NrLmhvdHN3YXAgPT09IG51bGwpIHJldHVybiBmYWxzZQogIGJsb2NrLmhvdHN3YXAucmVmLnJlbW92ZShibG9jaykKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiByZW1vdmVJbmZsaWdodChpbmYsIHJlcSkgewogIGNvbnN0IGkgPSBpbmYuaW5kZXhPZihyZXEpCiAgaWYgKGkgPT09IC0xKSByZXR1cm4gZmFsc2UKICBpZiAoaSA8IGluZi5sZW5ndGggLSAxKSBpbmZbaV0gPSBpbmYucG9wKCkKICBlbHNlIGluZi5wb3AoKQogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIHRvTGVuZ3RoKHN0YXJ0LCBlbmQpIHsKICByZXR1cm4gZW5kID09PSAtMSA/IC0xIDogZW5kIDwgc3RhcnQgPyAwIDogZW5kIC0gc3RhcnQKfQoKZnVuY3Rpb24gY2xhbXBSYW5nZShjb3JlLCByKSB7CiAgaWYgKHIuYmxvY2tzID09PSBudWxsKSB7CiAgICBjb25zdCBzdGFydCA9IGNvcmUuYml0ZmllbGQuZmlyc3RVbnNldChyLnN0YXJ0KQoKICAgIGlmIChyLmVuZCA9PT0gLTEpIHIuc3RhcnQgPSBzdGFydCA9PT0gLTEgPyBjb3JlLnN0YXRlLmxlbmd0aCA6IHN0YXJ0CiAgICBlbHNlIGlmIChzdGFydCA9PT0gLTEgfHwgc3RhcnQgPj0gci5lbmQpIHIuc3RhcnQgPSByLmVuZAogICAgZWxzZSB7CiAgICAgIHIuc3RhcnQgPSBzdGFydAoKICAgICAgY29uc3QgZW5kID0gY29yZS5iaXRmaWVsZC5sYXN0VW5zZXQoci5lbmQgLSAxKQoKICAgICAgaWYgKGVuZCA9PT0gLTEgfHwgc3RhcnQgPj0gZW5kICsgMSkgci5lbmQgPSByLnN0YXJ0CiAgICAgIGVsc2Ugci5lbmQgPSBlbmQgKyAxCiAgICB9CiAgfSBlbHNlIHsKICAgIHdoaWxlIChyLnN0YXJ0IDwgci5lbmQgJiYgY29yZS5iaXRmaWVsZC5nZXQoci5ibG9ja3Nbci5zdGFydF0pKSByLnN0YXJ0KysKICAgIHdoaWxlIChyLnN0YXJ0IDwgci5lbmQgJiYgY29yZS5iaXRmaWVsZC5nZXQoci5ibG9ja3Nbci5lbmQgLSAxXSkpIHIuZW5kLS0KICB9Cn0KCmZ1bmN0aW9uIG9ucmVxdWVzdHRpbWVvdXQocmVxKSB7CiAgaWYgKHJlcS5jb250ZXh0KSByZXEuY29udGV4dC5kZXRhY2gocmVxLCBSRVFVRVNUX1RJTUVPVVQoKSkKfQoKZnVuY3Rpb24gZGVzdHJveVJlcXVlc3RUaW1lb3V0KHJlcSkgewogIGlmIChyZXEudGltZW91dCAhPT0gbnVsbCkgewogICAgY2xlYXJUaW1lb3V0KHJlcS50aW1lb3V0KQogICAgcmVxLnRpbWVvdXQgPSBudWxsCiAgfQp9CgpmdW5jdGlvbiBpc0NyaXRpY2FsRXJyb3IoZXJyKSB7CiAgLy8gVE9ETzogZXhwb3NlIC5jcml0aWNhbCBvciBzaW1pbGFyIG9uIHRoZSBoeXBlcmNvcmUgZXJyb3JzIHRoYXQgYXJlIGNyaXRpY2FsIChpZiBhbGwgbm90IGFyZSkKICByZXR1cm4gZXJyLm5hbWUgPT09ICdIeXBlcmNvcmVFcnJvcicKfQoKZnVuY3Rpb24gb253aXJlb3BlbihtLCBjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub25vcGVuKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZWNsb3NlKGlzUmVtb3RlLCBjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub25jbG9zZShpc1JlbW90ZSkKfQoKZnVuY3Rpb24gb253aXJlZGVzdHJveShjKSB7CiAgYy51c2VyRGF0YS5yZXBsaWNhdG9yLm9ucGVlcmRlc3Ryb3koKQp9CgpmdW5jdGlvbiBvbndpcmVkcmFpbihjKSB7CiAgcmV0dXJuIGMudXNlckRhdGEub25kcmFpbigpCn0KCmZ1bmN0aW9uIG9ud2lyZXN5bmMobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZVN5bmMsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlU3luYykKICByZXR1cm4gYy51c2VyRGF0YS5vbnN5bmMobSkKfQoKZnVuY3Rpb24gb253aXJlcmVxdWVzdChtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlUmVxdWVzdCwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVSZXF1ZXN0KQogIHJldHVybiBjLnVzZXJEYXRhLm9ucmVxdWVzdChtKQp9CgpmdW5jdGlvbiBvbndpcmVjYW5jZWwobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZUNhbmNlbCwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVDYW5jZWwpCiAgcmV0dXJuIGMudXNlckRhdGEub25jYW5jZWwobSkKfQoKZnVuY3Rpb24gb253aXJlZGF0YShtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlRGF0YSwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVEYXRhKQogIHJldHVybiBjLnVzZXJEYXRhLm9uZGF0YShtKQp9CgpmdW5jdGlvbiBvbndpcmVub2RhdGEobSwgYykgewogIHJldHVybiBjLnVzZXJEYXRhLm9ubm9kYXRhKG0pCn0KCmZ1bmN0aW9uIG9ud2lyZXdhbnQobSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZVdhbnQsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlV2FudCkKICByZXR1cm4gYy51c2VyRGF0YS5vbndhbnQobSkKfQoKZnVuY3Rpb24gb253aXJldW53YW50KG0sIGMpIHsKICByZXR1cm4gYy51c2VyRGF0YS5vbnVud2FudChtKQp9CgpmdW5jdGlvbiBvbndpcmViaXRmaWVsZChtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlQml0ZmllbGQsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlQml0ZmllbGQpCiAgcmV0dXJuIGMudXNlckRhdGEub25iaXRmaWVsZChtKQp9CgpmdW5jdGlvbiBvbndpcmVyYW5nZShtLCBjKSB7CiAgaW5jcmVtZW50UngoYy51c2VyRGF0YS5zdGF0cy53aXJlUmFuZ2UsIGMudXNlckRhdGEucmVwbGljYXRvci5zdGF0cy53aXJlUmFuZ2UpCiAgcmV0dXJuIGMudXNlckRhdGEub25yYW5nZShtKQp9CgpmdW5jdGlvbiBvbndpcmVleHRlbnNpb24obSwgYykgewogIGluY3JlbWVudFJ4KGMudXNlckRhdGEuc3RhdHMud2lyZUV4dGVuc2lvbiwgYy51c2VyRGF0YS5yZXBsaWNhdG9yLnN0YXRzLndpcmVFeHRlbnNpb24pCiAgcmV0dXJuIGMudXNlckRhdGEub25leHRlbnNpb24obSkKfQoKZnVuY3Rpb24gc2V0RG93bmxvYWRpbmdMYXRlcihyZXBsLCBkb3dubG9hZGluZywgc2Vzc2lvbikgewogIHJlcGwuc2V0RG93bmxvYWRpbmdOb3coZG93bmxvYWRpbmcsIHNlc3Npb24pCn0KCmZ1bmN0aW9uIGlzQmxvY2tSZXF1ZXN0KHJlcSkgewogIHJldHVybiByZXEgIT09IG51bGwgJiYgcmVxLmJsb2NrICE9PSBudWxsCn0KCmZ1bmN0aW9uIGlzVXBncmFkZVJlcXVlc3QocmVxKSB7CiAgcmV0dXJuIHJlcSAhPT0gbnVsbCAmJiByZXEudXBncmFkZSAhPT0gbnVsbAp9CgpmdW5jdGlvbiBpbmNyZW1lbnRUeChzdGF0czEsIHN0YXRzMikgewogIHN0YXRzMS50eCsrCiAgc3RhdHMyLnR4KysKfQoKZnVuY3Rpb24gaW5jcmVtZW50Ungoc3RhdHMxLCBzdGF0czIpIHsKICBzdGF0czEucngrKwogIHN0YXRzMi5yeCsrCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gYmFja29mZih0aW1lcykgewogIGNvbnN0IHNsZWVwID0gdGltZXMgPCAyID8gMjAwIDogdGltZXMgPCA1ID8gNTAwIDogdGltZXMgPCA0MCA/IDEwMDAgOiA1MDAwCiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHNsZWVwKSkKfQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnbmFub2Fzc2VydCcpCmNvbnN0IGZsYXQgPSByZXF1aXJlKCdmbGF0LXRyZWUnKQpjb25zdCBxdWlja2JpdCA9IHJlcXVpcmUoJ3F1aWNrYml0LXVuaXZlcnNhbCcpCgpjb25zdCB7IElOVkFMSURfT1BFUkFUSU9OLCBJTlZBTElEX1NJR05BVFVSRSB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWVycm9ycycpCgpjb25zdCBNdXRleCA9IHJlcXVpcmUoJy4vbXV0ZXgnKQpjb25zdCBCaXRmaWVsZCA9IHJlcXVpcmUoJy4vYml0ZmllbGQnKQpjb25zdCB7IE1lcmtsZVRyZWUsIE1lcmtsZVRyZWVCYXRjaCB9ID0gcmVxdWlyZSgnLi9tZXJrbGUtdHJlZScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNlc3Npb25TdGF0ZSB7CiAgY29uc3RydWN0b3IoY29yZSwgcGFyZW50LCBzdG9yYWdlLCB0cmVlSW5mbywgbmFtZSkgewogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5pbmRleCA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzLnB1c2godGhpcykgLSAxCgogICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZQogICAgdGhpcy5uYW1lID0gbmFtZQogICAgdGhpcy5zZXNzaW9ucyA9IFtdCgogICAgLy8gc21hbGwgaGFjayB0byBjbG9zZSBvbGQgc3RvcmFnZXMgYXMgbGF0ZSBhcyBwb3NzaWJsZS4KICAgIC8vIFRPRE86IGFkZCBhIHJlYWQgbG9jayBzbyB3ZSBjYW4gYXZvaWQgdGhhdAogICAgdGhpcy5saW5nZXJzID0gbnVsbAoKICAgIHRoaXMucGFyZW50ID0gcGFyZW50CiAgICB0aGlzLmF0b21pemVkID0gbnVsbAogICAgdGhpcy5tdXRleCA9IG5ldyBNdXRleCgpCgogICAgLy8gbWVya2xlIHN0YXRlCiAgICB0aGlzLnJvb3RzID0gdHJlZUluZm8ucm9vdHMubGVuZ3RoID8gdHJlZUluZm8ucm9vdHMgOiBbXQogICAgdGhpcy5mb3JrID0gdHJlZUluZm8uZm9yayB8fCAwCiAgICB0aGlzLmxlbmd0aCA9IE1lcmtsZVRyZWUuc3Bhbih0aGlzLnJvb3RzKSAvIDIKICAgIHRoaXMuYnl0ZUxlbmd0aCA9IE1lcmtsZVRyZWUuc2l6ZSh0aGlzLnJvb3RzKQogICAgdGhpcy5wcm9sb2d1ZSA9IHRyZWVJbmZvLnByb2xvZ3VlIHx8IG51bGwKICAgIHRoaXMuc2lnbmF0dXJlID0gdHJlZUluZm8uc2lnbmF0dXJlIHx8IG51bGwKCiAgICB0aGlzLnNuYXBzaG90Q29tcGF0TGVuZ3RoID0gdGhpcy5pc1NuYXBzaG90KCkKICAgICAgPyBNYXRoLm1pbih0aGlzLmxlbmd0aCwgdGhpcy5jb3JlLnN0YXRlLmxlbmd0aCkKICAgICAgOiAtMQogICAgdGhpcy5sYXN0VHJ1bmNhdGlvbiA9IG51bGwKCiAgICB0aGlzLmFjdGl2ZSA9IDAKCiAgICB0aGlzLl9hY3RpdmVUeCA9IG51bGwKICAgIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IG51bGwKCiAgICB0aGlzLnJlZigpCiAgfQoKICBpc1NuYXBzaG90KCkgewogICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5zbmFwc2hvdHRlZAogIH0KCiAgaXNEZWZhdWx0KCkgewogICAgcmV0dXJuIHRoaXMuY29yZS5zdGF0ZSA9PT0gdGhpcyB8fCB0aGlzLmlzQXRvbWljRGVmYXVsdCgpCiAgfQoKICBpc0F0b21pY0RlZmF1bHQoKSB7CiAgICByZXR1cm4gISF0aGlzLnN0b3JhZ2UuYXRvbSAmJiAhIXRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmlzRGVmYXVsdCgpCiAgfQoKICBjcmVhdGVUcmVlQmF0Y2goKSB7CiAgICByZXR1cm4gbmV3IE1lcmtsZVRyZWVCYXRjaCh0aGlzKQogIH0KCiAgYWRkU2Vzc2lvbihzKSB7CiAgICBpZiAocy5fc3RhdGVJbmRleCAhPT0gLTEpIHJldHVybgogICAgcy5fc3RhdGVJbmRleCA9IHRoaXMuc2Vzc2lvbnMucHVzaChzKSAtIDEKICAgIGlmIChzLndlYWsgPT09IGZhbHNlKSB0aGlzLmNvcmUuYWN0aXZlU2Vzc2lvbnMrKwogIH0KCiAgcmVtb3ZlU2Vzc2lvbihzKSB7CiAgICBpZiAocy5fc3RhdGVJbmRleCA9PT0gLTEpIHJldHVybgogICAgY29uc3QgaGVhZCA9IHRoaXMuc2Vzc2lvbnMucG9wKCkKICAgIGlmIChoZWFkICE9PSBzKSB0aGlzLnNlc3Npb25zWyhoZWFkLl9zdGF0ZUluZGV4ID0gcy5fc3RhdGVJbmRleCldID0gaGVhZAogICAgcy5fc3RhdGVJbmRleCA9IC0xCiAgICBpZiAocy53ZWFrID09PSBmYWxzZSkgdGhpcy5jb3JlLmFjdGl2ZVNlc3Npb25zLS0KICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgfQoKICBmbHVzaGVkTGVuZ3RoKCkgewogICAgaWYgKHRoaXMuaXNEZWZhdWx0KCkgfHwgdGhpcy5pc1NuYXBzaG90KCkpIHJldHVybiB0aGlzLmxlbmd0aAogICAgY29uc3QgZGVwcyA9IHRoaXMuc3RvcmFnZS5kZXBlbmRlbmNpZXMKICAgIGlmIChkZXBzLmxlbmd0aCkgcmV0dXJuIGRlcHNbZGVwcy5sZW5ndGggLSAxXS5sZW5ndGgKICAgIHJldHVybiAwCiAgfQoKICBzaWduZWRMZW5ndGgoKSB7CiAgICBjb25zdCBsID0gTWF0aC5taW4odGhpcy5mbHVzaGVkTGVuZ3RoKCksIHRoaXMuY29yZS5zdGF0ZS5sZW5ndGgpCiAgICByZXR1cm4gdGhpcy5pc1NuYXBzaG90KCkgJiYgbCA+IHRoaXMuc25hcHNob3RDb21wYXRMZW5ndGggPyB0aGlzLnNuYXBzaG90Q29tcGF0TGVuZ3RoIDogbAogIH0KCiAgdW5yZWYoKSB7CiAgICBpZiAoLS10aGlzLmFjdGl2ZSA+IDApIHJldHVybgogICAgdGhpcy5jbG9zZSgpLmNhdGNoKG5vb3ApIC8vIHRlY2huaWNhbGx5IGFzeW5jLCBidXQgb25seSBmb3IgdGhlIGxhc3QgZGIgc2Vzc2lvbgogIH0KCiAgcmVmKCkgewogICAgdGhpcy5hY3RpdmUrKwogICAgcmV0dXJuIHRoaXMKICB9CgogIGhhc2goKSB7CiAgICByZXR1cm4gTWVya2xlVHJlZS5oYXNoKHRoaXMpCiAgfQoKICBzZXRSb290cyhyb290cykgewogICAgdGhpcy5yb290cyA9IHJvb3RzCiAgICB0aGlzLmxlbmd0aCA9IE1lcmtsZVRyZWUuc3Bhbihyb290cykgLyAyCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCiAgfQoKICBnZXQgZW5jcnlwdGlvbkZvcmsoKSB7CiAgICByZXR1cm4gdGhpcy5jb3JlLmhlYWRlci50cmVlLmZvcmsKICB9CgogIGFzeW5jIHVwZGF0ZVNuYXBzaG90U3RvcmFnZShzdG9yYWdlKSB7CiAgICBpZiAoIXRoaXMuYXRvbWl6ZWQgfHwgIXRoaXMuYXRvbWl6ZWQuZmx1c2hpbmcpIHJldHVybiB0aGlzLnRyZWVJbmZvKCkKICAgIGF3YWl0IHRoaXMuYXRvbWl6ZWQuZmx1c2hlZCgpCgogICAgbGV0IHJ4ID0gc3RvcmFnZS5yZWFkKCkKICAgIGNvbnN0IGhlYWRQcm9taXNlID0gcnguZ2V0SGVhZCgpCiAgICBjb25zdCBhdXRoUHJvbWlzZSA9IHJ4LmdldEF1dGgoKQogICAgY29uc3QgZGVwUHJvbWlzZSA9IHJ4LmdldERlcGVuZGVuY3koKQoKICAgIHJ4LnRyeUZsdXNoKCkKICAgIGNvbnN0IFtoZWFkLCBhdXRoLCBkZXBdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2hlYWRQcm9taXNlLCBhdXRoUHJvbWlzZSwgZGVwUHJvbWlzZV0pCgogICAgc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXApCgogICAgY29uc3QgZm9yayA9IGhlYWQgPyBoZWFkLmZvcmsgOiAwCiAgICBjb25zdCBsZW5ndGggPSBoZWFkID8gaGVhZC5sZW5ndGggOiAwCgogICAgcnggPSBzdG9yYWdlLnJlYWQoKQogICAgY29uc3Qgcm9vdFByb21pc2VzID0gW10KICAgIGZvciAoY29uc3QgciBvZiBmbGF0LmZ1bGxSb290cyhsZW5ndGggKiAyKSkgewogICAgICByb290UHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShyKSkKICAgIH0KCiAgICByeC50cnlGbHVzaCgpCgogICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBQcm9taXNlLmFsbChyb290UHJvbWlzZXMpCgogICAgLy8gZGJsIGNoZWNrIGlmIHdlIGFyZSBoaXR0aW5nIGFuIHJlZ3Jlc3Npb24gZnJvbSBlYXJsZXIKICAgIGZvciAoY29uc3Qgcm9vdCBvZiByb290cykgewogICAgICBpZiAocm9vdCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICdCYWQgc25hcHNob3QgZnJvbSBhdG9taXplZCBzZXNzaW9uLCBpZCA9ICcgKwogICAgICAgICAgICB0aGlzLmNvcmUuaWQgKwogICAgICAgICAgICAnIGxlbmd0aCA9ICcgKwogICAgICAgICAgICBsZW5ndGggKwogICAgICAgICAgICAnIGZvcmsgPSAnICsKICAgICAgICAgICAgZm9yawogICAgICAgICkKICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGZvcmssCiAgICAgIHJvb3RzLAogICAgICBsZW5ndGgsCiAgICAgIHByb2xvZ3VlOiBhdXRoLm1hbmlmZXN0ICYmIGF1dGgubWFuaWZlc3QucHJvbG9ndWUsCiAgICAgIHNpZ25hdHVyZTogaGVhZCAmJiBoZWFkLnNpZ25hdHVyZQogICAgfQogIH0KCiAgdHJlZUluZm8oKSB7CiAgICByZXR1cm4gewogICAgICBmb3JrOiB0aGlzLmZvcmssCiAgICAgIHJvb3RzOiB0aGlzLnJvb3RzLnNsaWNlKCksCiAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsCiAgICAgIHByb2xvZ3VlOiB0aGlzLnByb2xvZ3VlLAogICAgICBzaWduYXR1cmU6IHRoaXMuc2lnbmF0dXJlCiAgICB9CiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmluZGV4ID09PSAtMSkgcmV0dXJuCgogICAgdGhpcy5hY3RpdmUgPSAwCiAgICB0aGlzLm11dGV4LmRlc3Ryb3kobmV3IEVycm9yKCdDbG9zZWQnKSkuY2F0Y2gobm9vcCkKICAgIGlmICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudC5hdG9taXplZCkgdGhpcy5wYXJlbnQuYXRvbWl6ZWQgPSBudWxsCgogICAgY29uc3QgY2xvc2luZyA9IHRoaXMuc3RvcmFnZS5jbG9zZSgpCgogICAgY29uc3QgaGVhZCA9IHRoaXMuY29yZS5zZXNzaW9uU3RhdGVzLnBvcCgpCiAgICBpZiAoaGVhZCAhPT0gdGhpcykgdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXNbKGhlYWQuaW5kZXggPSB0aGlzLmluZGV4KV0gPSBoZWFkCgogICAgdGhpcy5pbmRleCA9IC0xCiAgICB0aGlzLmNvcmUuY2hlY2tJZklkbGUoKQoKICAgIGlmICh0aGlzLmxpbmdlcnMgIT09IG51bGwpIHsKICAgICAgZm9yIChjb25zdCBzdG9yYWdlIG9mIHRoaXMubGluZ2VycykgYXdhaXQgc3RvcmFnZS5jbG9zZSgpCiAgICB9CgogICAgcmV0dXJuIGNsb3NpbmcKICB9CgogIGFzeW5jIHNuYXBzaG90KCkgewogICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuc3RvcmFnZS5zbmFwc2hvdCgpCiAgICBjb25zdCB0cmVlSW5mbyA9IGF3YWl0IHRoaXMudXBkYXRlU25hcHNob3RTdG9yYWdlKHN0b3JhZ2UpCgogICAgY29uc3QgcyA9IG5ldyBTZXNzaW9uU3RhdGUodGhpcy5jb3JlLCBudWxsLCBzdG9yYWdlLCB0cmVlSW5mbywgdGhpcy5uYW1lKQoKICAgIHJldHVybiBzCiAgfQoKICB1cGRhdGVEZXBlbmRlbmN5KHR4LCBsZW5ndGgpIHsKICAgIGNvbnN0IGRlcGVuZGVuY3kgPSB1cGRhdGVEZXBlbmRlbmN5KHRoaXMsIGxlbmd0aCwgZmFsc2UpCiAgICBpZiAoZGVwZW5kZW5jeSkgdHguc2V0RGVwZW5kZW5jeShkZXBlbmRlbmN5KQogICAgcmV0dXJuIGRlcGVuZGVuY3kKICB9CgogIF9jbGVhckFjdGl2ZUJhdGNoKCkgewogICAgdGhpcy5fYWN0aXZlVHggPSBudWxsCiAgfQoKICBjcmVhdGVXcml0ZUJhdGNoKCkgewogICAgYXNzZXJ0KCF0aGlzLl9hY3RpdmVUeCAmJiAhdGhpcy5zdG9yYWdlLnNuYXBzaG90dGVkKQoKICAgIHRoaXMuX2FjdGl2ZVR4ID0gdGhpcy5zdG9yYWdlLndyaXRlKCkKICAgIHJldHVybiB0aGlzLl9hY3RpdmVUeAogIH0KCiAgX3VubG9jaygpIHsKICAgIHRoaXMuX2NsZWFyQWN0aXZlQmF0Y2goKQogICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgY29uc3QgdHggPSB0aGlzLl9hY3RpdmVUeAogICAgdGhpcy5fYWN0aXZlVHggPSBudWxsCgogICAgdHJ5IHsKICAgICAgaWYgKCEoYXdhaXQgdHguZmx1c2goKSkpIHJldHVybiBmYWxzZQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fY2xlYXJBY3RpdmVCYXRjaCgpCiAgICB9CgogICAgdGhpcy5sYXN0VHJ1bmNhdGlvbiA9IG51bGwKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcHJlY29tbWl0KCkgewogICAgdGhpcy5jb21taXRpbmcgPSB0cnVlCiAgfQoKICBhc3luYyBfY29tbWl0KCkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCBiaXRmaWVsZCA9IHRoaXMuX3BlbmRpbmdCaXRmaWVsZAogICAgICB0aGlzLl9wZW5kaW5nQml0ZmllbGQgPSBudWxsCiAgICAgIHRoaXMubGFzdFRydW5jYXRpb24gPSBudWxsCiAgICAgIGF3YWl0IHRoaXMucGFyZW50Ll9vbmNvbW1pdCh0aGlzLCBiaXRmaWVsZCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuY29tbWl0aW5nID0gZmFsc2UKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX29uY29tbWl0KHNyYywgYml0ZmllbGQpIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3QgY3Vyckxlbmd0aCA9IHRoaXMubGVuZ3RoCgogICAgICAvLyBsb2FkIGRlcGVuZGVuY3kgaW50byBtZW1vcnkKICAgICAgY29uc3QgcnggPSB0aGlzLnN0b3JhZ2UucmVhZCgpCiAgICAgIGNvbnN0IGRlcGVuZGVuY3lQcm9taXNlID0gcnguZ2V0RGVwZW5kZW5jeSgpCgogICAgICByeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBkZXBlbmRlbmN5ID0gYXdhaXQgZGVwZW5kZW5jeVByb21pc2UKCiAgICAgIHRoaXMuZm9yayA9IHNyYy5mb3JrCiAgICAgIHRoaXMubGVuZ3RoID0gc3JjLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBzcmMuYnl0ZUxlbmd0aAogICAgICB0aGlzLnJvb3RzID0gc3JjLnJvb3RzLnNsaWNlKCkKICAgICAgdGhpcy5zaWduYXR1cmUgPSBzcmMuc2lnbmF0dXJlCgogICAgICBjb25zdCB0cmVlID0gewogICAgICAgIGZvcms6IHRoaXMuZm9yaywKICAgICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLAogICAgICAgIHJvb3RIYXNoOiB0aGlzLmhhc2goKSwKICAgICAgICBzaWduYXR1cmU6IHRoaXMuc2lnbmF0dXJlCiAgICAgIH0KCiAgICAgIGlmIChkZXBlbmRlbmN5KSB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKCiAgICAgIGNvbnN0IGIgPSBiaXRmaWVsZAoKICAgICAgaWYgKGIgJiYgYi50cnVuY2F0ZWQgJiYgYi5zdGFydCA8IGN1cnJMZW5ndGgpIHsKICAgICAgICB0aGlzLm9udHJ1bmNhdGUodHJlZSwgYi5zdGFydCwgY3Vyckxlbmd0aCwgdHJ1ZSkKICAgICAgICBpZiAoIWIgfHwgYi5hcHBlbmRzID09PSAwKSByZXR1cm4KICAgICAgfQoKICAgICAgY29uc3QgYXBwZW5kID0gYiA/IHsgc3RhcnQ6IGIuc3RhcnQsIGxlbmd0aDogYi5hcHBlbmRzLCBkcm9wOiBmYWxzZSB9IDogbnVsbAoKICAgICAgdGhpcy5vbmFwcGVuZCh0cmVlLCBhcHBlbmQsIHRydWUpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLm11dGV4LnVubG9jaygpCiAgICAgIHRoaXMuY29yZS5jaGVja0lmSWRsZSgpCiAgICB9CiAgfQoKICBhc3luYyBzZXRVc2VyRGF0YShrZXksIHZhbHVlKSB7CiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKICAgICAgdHgucHV0VXNlckRhdGEoa2V5LCB2YWx1ZSkKCiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZsdXNoKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX3VubG9jaygpCiAgICB9CiAgfQoKICBhc3luYyBfdmVyaWZ5QmxvY2soYmF0Y2gsIGJpdGZpZWxkLCB2YWx1ZSwgbWFuaWZlc3QsIGZyb20pIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgaWYgKGJhdGNoLnVwZ3JhZGVkICYmIGJhdGNoLmxlbmd0aCA8PSB0aGlzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IGJhdGNoLmRvd25ncmFkZSgpCiAgICAgIH0KCiAgICAgIGlmICghYmF0Y2guY29tbWl0YWJsZSgpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNvcmUucHJldXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgYXdhaXQgdGhpcy5jb3JlLnByZXVwZGF0ZShiYXRjaCwgdGhpcy5jb3JlLmhlYWRlci5rZXkpCiAgICAgIH0KCiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKICAgICAgdGhpcy51cGRhdGluZyA9IHRydWUKCiAgICAgIGlmIChiaXRmaWVsZCkgewogICAgICAgIHR4LnB1dEJsb2NrKGJpdGZpZWxkLnN0YXJ0LCB2YWx1ZSkKICAgICAgfQoKICAgICAgaWYgKGJpdGZpZWxkICYmIHRoaXMuaXNEZWZhdWx0KCkpIHsKICAgICAgICBhd2FpdCBzdG9yZUJpdGZpZWxkUmFuZ2UodGhpcy5zdG9yYWdlLCB0eCwgYml0ZmllbGQuc3RhcnQsIGJpdGZpZWxkLnN0YXJ0ICsgMSwgdHJ1ZSkKICAgICAgfQoKICAgICAgaWYgKG1hbmlmZXN0KSB0aGlzLmNvcmUuX3NldE1hbmlmZXN0KHR4LCBtYW5pZmVzdCwgbnVsbCkKCiAgICAgIGFzc2VydChiYXRjaC5jb21taXRhYmxlKCksICdTaG91bGQgc3RpbGwgYmUgY29tbWl0YWJsZScpCiAgICAgIGJhdGNoLmNvbW1pdCh0eCkKCiAgICAgIGNvbnN0IGhlYWQgPSB7CiAgICAgICAgZm9yazogYmF0Y2guZm9yaywKICAgICAgICBsZW5ndGg6IGJhdGNoLmxlbmd0aCwKICAgICAgICByb290SGFzaDogYmF0Y2guaGFzaCgpLAogICAgICAgIHNpZ25hdHVyZTogYmF0Y2guc2lnbmF0dXJlCiAgICAgIH0KCiAgICAgIGlmIChiYXRjaC51cGdyYWRlZCkgdHguc2V0SGVhZChoZWFkKQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgaWYgKGJhdGNoLnVwZ3JhZGVkKSB7CiAgICAgICAgdGhpcy5yb290cyA9IGJhdGNoLnJvb3RzCiAgICAgICAgdGhpcy5sZW5ndGggPSBiYXRjaC5sZW5ndGgKICAgICAgICB0aGlzLmJ5dGVMZW5ndGggPSBiYXRjaC5ieXRlTGVuZ3RoCiAgICAgICAgdGhpcy5mb3JrID0gYmF0Y2guZm9yawogICAgICAgIHRoaXMuc2lnbmF0dXJlID0gYmF0Y2guc2lnbmF0dXJlCgogICAgICAgIHRoaXMub25hcHBlbmQoaGVhZCwgYml0ZmllbGQsIGZsdXNoZWQpCiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2NsZWFyQWN0aXZlQmF0Y2goKQogICAgICB0aGlzLnVwZGF0aW5nID0gZmFsc2UKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBhc3luYyB0cnVuY2F0ZShsZW5ndGgsIGZvcmssIHsgc2lnbmF0dXJlLCBrZXlQYWlyIH0gPSB7fSkgewogICAgaWYgKCFrZXlQYWlyICYmIHRoaXMuaXNEZWZhdWx0KCkpIGtleVBhaXIgPSB0aGlzLmNvcmUuaGVhZGVyLmtleVBhaXIKCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLnByb2xvZ3VlICYmIGxlbmd0aCA8IHRoaXMucHJvbG9ndWUubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ1RydW5jYXRpb24gYnJlYWtzIHByb2xvZ3VlJywgdGhpcy5jb3JlLmRpc2NvdmVyeUtleSkKICAgICAgfQogICAgICBpZiAobGVuZ3RoID4gdGhpcy5sZW5ndGgpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTigKICAgICAgICAgICdOb3QgYSB0cnVuY2F0aW9uLCAnICsgbGVuZ3RoICsgJyBtdXN0IGJlIGxlc3Mgb3IgZXF1YWwgdG8gJyArIHRoaXMubGVuZ3RoLAogICAgICAgICAgdGhpcy5jb3JlLmRpc2NvdmVyeUtleQogICAgICAgICkKICAgICAgfQoKICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLmNyZWF0ZVRyZWVCYXRjaCgpCiAgICAgIGF3YWl0IE1lcmtsZVRyZWUudHJ1bmNhdGUodGhpcywgbGVuZ3RoLCBiYXRjaCwgZm9yaykKCiAgICAgIGlmICghc2lnbmF0dXJlICYmIGtleVBhaXIgJiYgbGVuZ3RoID4gMCkgc2lnbmF0dXJlID0gdGhpcy5jb3JlLnZlcmlmaWVyLnNpZ24oYmF0Y2gsIGtleVBhaXIpCiAgICAgIGlmIChzaWduYXR1cmUpIGJhdGNoLnNpZ25hdHVyZSA9IHNpZ25hdHVyZQoKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgICAgLy8gdXBzZXJ0IGNvbXBhdCBtYW5pZmVzdAogICAgICBpZiAodGhpcy5jb3JlLnZlcmlmaWVyID09PSBudWxsICYmIGtleVBhaXIpIHRoaXMuY29yZS5fc2V0TWFuaWZlc3QodHgsIG51bGwsIGtleVBhaXIpCgogICAgICBjb25zdCB7IGRlcGVuZGVuY3ksIHRyZWUsIHJvb3RzIH0gPSBhd2FpdCB0aGlzLl90cnVuY2F0ZSh0eCwgYmF0Y2gpCgogICAgICBmb3IgKGNvbnN0IHNlc3Npb25TdGF0ZSBvZiB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcykgewogICAgICAgIGlmICgKICAgICAgICAgIHNlc3Npb25TdGF0ZS5pc1NuYXBzaG90KCkgJiYKICAgICAgICAgIHNlc3Npb25TdGF0ZS5uYW1lID09PSB0aGlzLm5hbWUgJiYKICAgICAgICAgIGxlbmd0aCA8IHNlc3Npb25TdGF0ZS5zbmFwc2hvdENvbXBhdExlbmd0aAogICAgICAgICkgewogICAgICAgICAgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoID0gbGVuZ3RoCiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICB0aGlzLmZvcmsgPSB0cmVlLmZvcmsKICAgICAgdGhpcy5sZW5ndGggPSB0cmVlLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCiAgICAgIHRoaXMucm9vdHMgPSByb290cwogICAgICB0aGlzLnNpZ25hdHVyZSA9IHRyZWUuc2lnbmF0dXJlCgogICAgICBpZiAoZGVwZW5kZW5jeSkgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCgogICAgICB0aGlzLm9udHJ1bmNhdGUodHJlZSwgdHJlZS5sZW5ndGgsIGJhdGNoLnRyZWVMZW5ndGgsIGZsdXNoZWQpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgcmVvcmcoYmF0Y2gpIHsKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgdHJ5IHsKICAgICAgaWYgKCFiYXRjaC5jb21taXRhYmxlKCkpIHJldHVybiBmYWxzZQoKICAgICAgY29uc3QgeyBkZXBlbmRlbmN5LCB0cmVlIH0gPSBhd2FpdCB0aGlzLl90cnVuY2F0ZShzdG9yYWdlLCBiYXRjaCkKCiAgICAgIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCB0aGlzLmZsdXNoKCkKCiAgICAgIHRoaXMuZm9yayA9IGJhdGNoLmZvcmsKICAgICAgdGhpcy5sZW5ndGggPSBiYXRjaC5sZW5ndGgKICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gYmF0Y2guYnl0ZUxlbmd0aAogICAgICB0aGlzLnJvb3RzID0gYmF0Y2gucm9vdHMKICAgICAgdGhpcy5zaWduYXR1cmUgPSBiYXRjaC5zaWduYXR1cmUKCiAgICAgIGlmIChkZXBlbmRlbmN5KSB0aGlzLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKCiAgICAgIHRoaXMub250cnVuY2F0ZSh0cmVlLCBiYXRjaC5hbmNlc3RvcnMsIGJhdGNoLnRyZWVMZW5ndGgsIGZsdXNoZWQpCgogICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCAmJiB0aGlzLmlzRGVmYXVsdCgpKSBhd2FpdCB0aGlzLmNvcmUuZmx1c2hIaW50cygpCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX3RydW5jYXRlKHN0b3JhZ2UsIGJhdGNoKSB7CiAgICBzdG9yYWdlLmRlbGV0ZUJsb2NrUmFuZ2UoYmF0Y2guYW5jZXN0b3JzLCBiYXRjaC50cmVlTGVuZ3RoKQoKICAgIGFzc2VydChiYXRjaC5jb21taXRhYmxlKCksICdCYXRjaCBtdXN0IGJlIGNvbW1pdGFibGUnKQoKICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgIGZvcms6IGJhdGNoLmZvcmssCiAgICAgIGxlbmd0aDogYmF0Y2gubGVuZ3RoLAogICAgICByb290SGFzaDogYmF0Y2guaGFzaCgpLAogICAgICBzaWduYXR1cmU6IGJhdGNoLnNpZ25hdHVyZQogICAgfQoKICAgIHN0b3JhZ2Uuc2V0SGVhZCh0cmVlKQogICAgYmF0Y2guY29tbWl0KHN0b3JhZ2UpCgogICAgY29uc3QgdHJ1bmNhdGVkID0gYmF0Y2gubGVuZ3RoIDwgdGhpcy5mbHVzaGVkTGVuZ3RoKCkKICAgIGNvbnN0IGRlcGVuZGVuY3kgPSB0cnVuY2F0ZWQgPyB1cGRhdGVEZXBlbmRlbmN5KHRoaXMsIGJhdGNoLmxlbmd0aCwgdHJ1ZSkgOiBudWxsCgogICAgaWYgKGRlcGVuZGVuY3kpIHN0b3JhZ2Uuc2V0RGVwZW5kZW5jeShkZXBlbmRlbmN5KQoKICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB7CiAgICAgIGF3YWl0IHN0b3JlQml0ZmllbGRSYW5nZSh0aGlzLnN0b3JhZ2UsIHN0b3JhZ2UsIGJhdGNoLmFuY2VzdG9ycywgYmF0Y2gudHJlZUxlbmd0aCwgZmFsc2UpCiAgICAgIGlmIChiYXRjaC5hbmNlc3RvcnMgPCB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLmNvbnRpZ3VvdXNMZW5ndGgpIHsKICAgICAgICB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGggPSBNYXRoLm1pbigKICAgICAgICAgIGJhdGNoLmxlbmd0aCwKICAgICAgICAgIHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgICAgICkKICAgICAgICBzdG9yYWdlLnNldEhpbnRzKHsKICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IGJhdGNoLmFuY2VzdG9ycywKICAgICAgICAgIHJlbW90ZUNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMuY29yZS5oZWFkZXIuaGludHMucmVtb3RlQ29udGlndW91c0xlbmd0aAogICAgICAgIH0pCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4geyBkZXBlbmRlbmN5LCB0cmVlLCByb290czogYmF0Y2gucm9vdHMgfQogIH0KCiAgYXN5bmMgY2xlYXIoc3RhcnQsIGVuZCwgY2xlYXJlZCkgewogICAgYXdhaXQgdGhpcy5tdXRleC5sb2NrKCkKCiAgICB0cnkgewogICAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgICBjb25zdCBpdGUgPSBmbGF0Lml0ZXJhdG9yKHN0YXJ0ICogMikKICAgICAgd2hpbGUgKCFpc1Jvb3RJbmRleChpdGUuaW5kZXgsIHRoaXMucm9vdHMpKSB7CiAgICAgICAgY29uc3QgYSA9IGl0ZS5pbmRleAogICAgICAgIGNvbnN0IGIgPSBpdGUuc2libGluZygpCiAgICAgICAgaXRlLnBhcmVudCgpCgogICAgICAgIGNvbnN0IFtsZWZ0LCByaWdodF0gPSBmbGF0LnNwYW5zKGIpCiAgICAgICAgY29uc3QgcyA9IGxlZnQgLyAyCiAgICAgICAgY29uc3QgZSA9IHJpZ2h0IC8gMiArIDEKICAgICAgICBjb25zdCBoYXMgPSBzIDw9IHN0YXJ0ICYmIGUgPD0gZW5kID8gZmFsc2UgOiB0aGlzLmNvcmUuYml0ZmllbGQuaGFzU2V0KHMsIGUgLSBzKQogICAgICAgIGlmIChoYXMpIGJyZWFrCgogICAgICAgIHR4LmRlbGV0ZVRyZWVOb2RlKGEpCiAgICAgICAgdHguZGVsZXRlVHJlZU5vZGUoYikKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaXNEZWZhdWx0KCkpIHsKICAgICAgICBhd2FpdCBzdG9yZUJpdGZpZWxkUmFuZ2UodGhpcy5zdG9yYWdlLCB0eCwgc3RhcnQsIGVuZCwgZmFsc2UpCiAgICAgICAgaWYgKHN0YXJ0IDwgdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgICAgICB0eC5zZXRIaW50cyh7CiAgICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHN0YXJ0LAogICAgICAgICAgICByZW1vdGVDb250aWd1b3VzTGVuZ3RoOiB0aGlzLmNvcmUuaGVhZGVyLmhpbnRzLnJlbW90ZUNvbnRpZ3VvdXNMZW5ndGgKICAgICAgICAgIH0pCiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZW5kIC0gc3RhcnQgPT09IDEpIHR4LmRlbGV0ZUJsb2NrKHN0YXJ0KQogICAgICBlbHNlIHR4LmRlbGV0ZUJsb2NrUmFuZ2Uoc3RhcnQsIGVuZCkKCiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBzdGFydCA8IHRoaXMuZmx1c2hlZExlbmd0aCgpID8gdXBkYXRlRGVwZW5kZW5jeSh0aGlzLCBzdGFydCwgdHJ1ZSkgOiBudWxsCgogICAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgICBpZiAoZGVwZW5kZW5jeSkgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcGVuZGVuY3kpCgogICAgICAvLyB0b2RvOiBhdG9taWMgZXZlbnQgaGFuZGxlCiAgICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpICYmIGZsdXNoZWQpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBlbmQgLSBzdGFydAoKICAgICAgICB0aGlzLmNvcmUudXBkYXRlQ29udGlndW91c0xlbmd0aCh7IHN0YXJ0LCBsZW5ndGgsIGRyb3A6IHRydWUgfSkKICAgICAgICB0aGlzLmNvcmUuX3NldEJpdGZpZWxkUmFuZ2VzKHN0YXJ0LCBlbmQsIGZhbHNlKQogICAgICAgIHRoaXMuY29yZS5yZXBsaWNhdG9yLm9uaGF2ZShzdGFydCwgbGVuZ3RoLCB0cnVlKQoKICAgICAgICBpZiAodGhpcy5jb3JlLmhpbnRzQ2hhbmdlZCkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgYXBwZW5kKHZhbHVlcywgeyBzaWduYXR1cmUsIGtleVBhaXIsIHByZWFwcGVuZCwgcG9zdGFwcGVuZCwgbWF4TGVuZ3RoID0gLTEgfSA9IHt9KSB7CiAgICBpZiAoIWtleVBhaXIgJiYgdGhpcy5pc0RlZmF1bHQoKSkga2V5UGFpciA9IHRoaXMuY29yZS5oZWFkZXIua2V5UGFpcgoKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgaWYgKG1heExlbmd0aCA+PSAwICYmIHRoaXMubGVuZ3RoICsgdmFsdWVzLmxlbmd0aCA+IG1heExlbmd0aCkgewogICAgICAgIHJldHVybiB7IGxlbmd0aDogdGhpcy5sZW5ndGgsIGJ5dGVMZW5ndGg6IHRoaXMuYnl0ZUxlbmd0aCB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHR4ID0gdGhpcy5jcmVhdGVXcml0ZUJhdGNoKCkKCiAgICAgIC8vIHVwc2VydCBjb21wYXQgbWFuaWZlc3QKICAgICAgaWYgKHRoaXMuY29yZS52ZXJpZmllciA9PT0gbnVsbCAmJiBrZXlQYWlyKSB0aGlzLmNvcmUuX3NldE1hbmlmZXN0KHR4LCBudWxsLCBrZXlQYWlyKQoKICAgICAgaWYgKHByZWFwcGVuZCkgYXdhaXQgcHJlYXBwZW5kKHZhbHVlcykKCiAgICAgIGlmICghdmFsdWVzLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHRoaXMuZmx1c2goKQogICAgICAgIHJldHVybiB7IGxlbmd0aDogdGhpcy5sZW5ndGgsIGJ5dGVMZW5ndGg6IHRoaXMuYnl0ZUxlbmd0aCB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jcmVhdGVUcmVlQmF0Y2goKQogICAgICBmb3IgKGNvbnN0IHZhbCBvZiB2YWx1ZXMpIGJhdGNoLmFwcGVuZCh2YWwpCgogICAgICAvLyBvbmx5IG11bHRpc2lnIGNhbiBoYXZlIHByb2xvZ3VlIHNvIHNpZ25hdHVyZSBpcyBhbHdheXMgcHJlc2VudAogICAgICBpZiAodGhpcy5wcm9sb2d1ZSAmJiBiYXRjaC5sZW5ndGggPCB0aGlzLnByb2xvZ3VlLmxlbmd0aCkgewogICAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKCdBcHBlbmQgaXMgbm90IGNvbnNpc3RlbnQgd2l0aCBwcm9sb2d1ZScsIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIGlmICghc2lnbmF0dXJlICYmIGtleVBhaXIpIHNpZ25hdHVyZSA9IHRoaXMuY29yZS52ZXJpZmllci5zaWduKGJhdGNoLCBrZXlQYWlyKQogICAgICBpZiAoc2lnbmF0dXJlKSBiYXRjaC5zaWduYXR1cmUgPSBzaWduYXR1cmUKCiAgICAgIGJhdGNoLmNvbW1pdCh0eCkKCiAgICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgICAgZm9yazogYmF0Y2guZm9yaywKICAgICAgICBsZW5ndGg6IGJhdGNoLmxlbmd0aCwKICAgICAgICByb290SGFzaDogYmF0Y2guaGFzaCgpLAogICAgICAgIHNpZ25hdHVyZTogYmF0Y2guc2lnbmF0dXJlCiAgICAgIH0KCiAgICAgIHR4LnNldEhlYWQodHJlZSkKCiAgICAgIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB7CiAgICAgICAgYXdhaXQgc3RvcmVCaXRmaWVsZFJhbmdlKHRoaXMuc3RvcmFnZSwgdHgsIGJhdGNoLmFuY2VzdG9ycywgYmF0Y2gubGVuZ3RoLCB0cnVlKQogICAgICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gdGhpcy5jb3JlLmhlYWRlci5oaW50cy5jb250aWd1b3VzTGVuZ3RoKSB7CiAgICAgICAgICB0eC5zZXRIaW50cyh7CiAgICAgICAgICAgIGNvbnRpZ3VvdXNMZW5ndGg6IHRoaXMubGVuZ3RoICsgdmFsdWVzLmxlbmd0aCwKICAgICAgICAgICAgcmVtb3RlQ29udGlndW91c0xlbmd0aDogdGhpcy5jb3JlLmhlYWRlci5oaW50cy5yZW1vdGVDb250aWd1b3VzTGVuZ3RoCiAgICAgICAgICB9KQogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0eC5wdXRCbG9jayh0aGlzLmxlbmd0aCArIGksIHZhbHVlc1tpXSkKICAgICAgfQoKICAgICAgY29uc3QgYml0ZmllbGQgPSB7CiAgICAgICAgZHJvcDogZmFsc2UsCiAgICAgICAgc3RhcnQ6IGJhdGNoLmFuY2VzdG9ycywKICAgICAgICBsZW5ndGg6IHZhbHVlcy5sZW5ndGgKICAgICAgfQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgdGhpcy5mb3JrID0gYmF0Y2guZm9yawogICAgICB0aGlzLnJvb3RzID0gYmF0Y2gucm9vdHMKICAgICAgdGhpcy5sZW5ndGggPSBiYXRjaC5sZW5ndGgKICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gYmF0Y2guYnl0ZUxlbmd0aAogICAgICB0aGlzLnNpZ25hdHVyZSA9IGJhdGNoLnNpZ25hdHVyZQoKICAgICAgaWYgKHBvc3RhcHBlbmQpIGF3YWl0IHBvc3RhcHBlbmQodmFsdWVzKQoKICAgICAgdGhpcy5vbmFwcGVuZCh0cmVlLCBiaXRmaWVsZCwgZmx1c2hlZCkKCiAgICAgIGlmICh0aGlzLmNvcmUuaGludHNDaGFuZ2VkICYmIHRoaXMuaXNEZWZhdWx0KCkpIGF3YWl0IHRoaXMuY29yZS5mbHVzaEhpbnRzKCkKCiAgICAgIHJldHVybiB7IGxlbmd0aDogdGhpcy5sZW5ndGgsIGJ5dGVMZW5ndGg6IHRoaXMuYnl0ZUxlbmd0aCB9CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl91bmxvY2soKQogICAgfQogIH0KCiAgb25hcHBlbmQodHJlZSwgYml0ZmllbGQsIGZsdXNoZWQpIHsKICAgIGlmICghZmx1c2hlZCkgdGhpcy5fdXBkYXRlQml0ZmllbGQoYml0ZmllbGQpCiAgICBlbHNlIGlmICh0aGlzLmlzRGVmYXVsdCgpKSB0aGlzLmNvcmUub25hcHBlbmQodHJlZSwgYml0ZmllbGQpCgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgdGhpcy5zZXNzaW9uc1tpXS5lbWl0KCdhcHBlbmQnKQogICAgfQogIH0KCiAgb250cnVuY2F0ZSh0cmVlLCB0bywgZnJvbSwgZmx1c2hlZCkgewogICAgY29uc3QgYml0ZmllbGQgPSB7IHN0YXJ0OiB0bywgbGVuZ3RoOiBmcm9tIC0gdG8sIGRyb3A6IHRydWUgfQoKICAgIHRoaXMubGFzdFRydW5jYXRpb24gPSB7IGZyb20sIHRvIH0KCiAgICBpZiAoIWZsdXNoZWQpIHRoaXMuX3VwZGF0ZUJpdGZpZWxkKGJpdGZpZWxkKQogICAgZWxzZSBpZiAodGhpcy5pc0RlZmF1bHQoKSkgdGhpcy5jb3JlLm9udHJ1bmNhdGUodHJlZSwgYml0ZmllbGQpCgogICAgZm9yIChjb25zdCBzZXNzaW9uU3RhdGUgb2YgdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMpIHsKICAgICAgaWYgKAogICAgICAgIHNlc3Npb25TdGF0ZS5pc1NuYXBzaG90KCkgJiYKICAgICAgICBzZXNzaW9uU3RhdGUubmFtZSA9PT0gdGhpcy5uYW1lICYmCiAgICAgICAgdG8gPCBzZXNzaW9uU3RhdGUuc25hcHNob3RDb21wYXRMZW5ndGgKICAgICAgKSB7CiAgICAgICAgc2Vzc2lvblN0YXRlLnNuYXBzaG90Q29tcGF0TGVuZ3RoID0gdG8KICAgICAgfQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHRoaXMuc2Vzc2lvbnNbaV0uZW1pdCgndHJ1bmNhdGUnLCB0bywgdHJlZS5mb3JrKQogICAgfQogIH0KCiAgX3VwZGF0ZUJpdGZpZWxkKGJpdGZpZWxkLCBmbHVzaGVkKSB7CiAgICBpZiAoIWJpdGZpZWxkKSByZXR1cm4KCiAgICBjb25zdCBwID0gdGhpcy5fcGVuZGluZ0JpdGZpZWxkCiAgICBjb25zdCBiID0gYml0ZmllbGQKCiAgICBpZiAoYi5kcm9wKSB7CiAgICAgIC8vIHRydW5jYXRpb24gbXVzdCBiZSBmcm9tIGVuZAogICAgICBpZiAocCAmJiBiLnN0YXJ0ICsgYi5sZW5ndGggIT09IHAuc3RhcnQgKyBwLmFwcGVuZHMpIHsKICAgICAgICB0aHJvdyBJTlZBTElEX09QRVJBVElPTignQXRvbWljIHRydW5jYXRpb25zIG11c3QgYmUgY29udGlndW91cycsIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkpCiAgICAgIH0KCiAgICAgIC8vIGFjdHVhbCB0cnVuY2F0aW9uCiAgICAgIGlmIChwID09PSBudWxsIHx8IGIuc3RhcnQgPCBwLnN0YXJ0KSB7CiAgICAgICAgdGhpcy5fcGVuZGluZ0JpdGZpZWxkID0geyB0cnVuY2F0ZWQ6IHRydWUsIHN0YXJ0OiBiLnN0YXJ0LCBhcHBlbmRzOiAwIH0KICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8ganVzdCBjbGVhcmluZyBiYXRjaCBkYXRhCiAgICAgIHAuYXBwZW5kcyA9IGIuc3RhcnQgLSBwLnN0YXJ0CgogICAgICAvLyB3ZSBjbGVhcmVkIHRoZSBjdXJyZW50IGJhdGNoCiAgICAgIGlmIChwLmFwcGVuZHMgPT09IDApIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IG51bGwKCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChwID09PSBudWxsKSB7CiAgICAgIHRoaXMuX3BlbmRpbmdCaXRmaWVsZCA9IHsgdHJ1bmNhdGVkOiBmYWxzZSwgc3RhcnQ6IGIuc3RhcnQsIGFwcGVuZHM6IGIubGVuZ3RoIH0KICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKGIuc3RhcnQgIT09IHAuc3RhcnQgKyBwLmFwcGVuZHMpIHsKICAgICAgdGhyb3cgSU5WQUxJRF9PUEVSQVRJT04oJ0F0b21pYyBvcGVyYXRpb25zIG11c3QgYmUgY29udGlndW91cycsIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkpCiAgICB9CgogICAgcC5hcHBlbmRzICs9IGIubGVuZ3RoCiAgfQoKICBhc3luYyBjYXRjaHVwKGxlbmd0aCkgewogICAgYXNzZXJ0KCF0aGlzLmlzRGVmYXVsdCgpLCAnQ2Fubm90IGNhdGNodXAgc2lnbmVkIHN0YXRlJykgLy8gVE9ETzogbWFrZSB0aGlzIGNoZWNrIGJldHRlcgoKICAgIGF3YWl0IHRoaXMubXV0ZXgubG9jaygpCgogICAgdHJ5IHsKICAgICAgY29uc3Qgb3JpZ0xlbmd0aCA9IHRoaXMubGVuZ3RoCgogICAgICBsZXQgc2hhcmVkTGVuZ3RoID0gMAogICAgICBmb3IgKGxldCBpID0gdGhpcy5zdG9yYWdlLmRlcGVuZGVuY2llcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IGRlcCA9IHRoaXMuc3RvcmFnZS5kZXBlbmRlbmNpZXNbaV0KICAgICAgICBpZiAoZGVwLmRhdGFQb2ludGVyID09PSB0aGlzLmNvcmUuc3RhdGUuc3RvcmFnZS5jb3JlLmRhdGFQb2ludGVyKSB7CiAgICAgICAgICBzaGFyZWRMZW5ndGggPSBkZXAubGVuZ3RoCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdHggPSB0aGlzLmNyZWF0ZVdyaXRlQmF0Y2goKQogICAgICBjb25zdCByeCA9IHRoaXMuY29yZS5zdGF0ZS5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCByb290UHJvbWlzZXMgPSBbXQoKICAgICAgZm9yIChjb25zdCByb290IG9mIGZsYXQuZnVsbFJvb3RzKGxlbmd0aCAqIDIpKSB7CiAgICAgICAgcm9vdFByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUocm9vdCkpCiAgICAgIH0KCiAgICAgIHJ4LnRyeUZsdXNoKCkKCiAgICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgUHJvbWlzZS5hbGwocm9vdFByb21pc2VzKQogICAgICBjb25zdCB0cnVuY2F0aW5nID0gc2hhcmVkTGVuZ3RoIDwgb3JpZ0xlbmd0aAoKICAgICAgZm9yIChjb25zdCBub2RlIG9mIHJvb3RzKSB7CiAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IElOVkFMSURfT1BFUkFUSU9OKAogICAgICAgICAgICAnSW52YWxpZCBjYXRjaHVwIGxlbmd0aCwgdHJlZSBub2RlcyBub3QgYXZhaWxhYmxlJywKICAgICAgICAgICAgdGhpcy5jb3JlLmRpc2NvdmVyeUtleQogICAgICAgICAgKQogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgZm9yayA9IHRydW5jYXRpbmcgPyB0aGlzLmZvcmsgKyAxIDogdGhpcy5mb3JrCgogICAgICAvLyBvdmVyd3JpdGUgaXQgYXRtLCBUT0RPOiBrZWVwIHdoYXQgd2UgY2FuIGNvbm5lY3QgdG8gdGhlIHRyZWUKICAgICAgdHguZGVsZXRlQmxvY2tSYW5nZSgwLCAtMSkKICAgICAgdHguZGVsZXRlVHJlZU5vZGVSYW5nZSgwLCAtMSkKICAgICAgdHguZGVsZXRlQml0ZmllbGRQYWdlUmFuZ2UoMCwgLTEpCgogICAgICBjb25zdCB0cmVlID0gewogICAgICAgIGZvcmssCiAgICAgICAgbGVuZ3RoLAogICAgICAgIHJvb3RIYXNoOiBjcnlwdG8udHJlZShyb290cyksCiAgICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICAgIH0KCiAgICAgIHR4LnNldEhlYWQodHJlZSkKCiAgICAgIC8vIHByb3AgYSBiZXR0ZXIgd2F5IHRvIGRvIHRoaXMKICAgICAgY29uc3QgZGVwID0gdXBkYXRlRGVwZW5kZW5jeSh0aGlzLCBzaGFyZWRMZW5ndGgsIHRydWUpCiAgICAgIGRlcC5sZW5ndGggPSBsZW5ndGgKCiAgICAgIHR4LnNldERlcGVuZGVuY3koZGVwKQoKICAgICAgY29uc3QgZmx1c2hlZCA9IGF3YWl0IHRoaXMuZmx1c2goKQoKICAgICAgdGhpcy5zdG9yYWdlLnNldERlcGVuZGVuY3lIZWFkKGRlcCkKCiAgICAgIHRoaXMuZm9yayA9IHRyZWUuZm9yawogICAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgICAgdGhpcy5sZW5ndGggPSB0cmVlLmxlbmd0aAogICAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCgogICAgICBpZiAodHJ1bmNhdGluZykgdGhpcy5vbnRydW5jYXRlKHRyZWUsIHNoYXJlZExlbmd0aCwgb3JpZ0xlbmd0aCwgZmx1c2hlZCkKICAgICAgaWYgKHNoYXJlZExlbmd0aCA8IGxlbmd0aCkgdGhpcy5vbmFwcGVuZCh0cmVlLCBudWxsLCBmbHVzaGVkKQoKICAgICAgaWYgKHRoaXMuY29yZS5oaW50c0NoYW5nZWQgJiYgdGhpcy5pc0RlZmF1bHQoKSkgYXdhaXQgdGhpcy5jb3JlLmZsdXNoSGludHMoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5tdXRleC51bmxvY2soKQogICAgfQogIH0KCiAgYXN5bmMgX292ZXJ3cml0ZShzb3VyY2UsIGZvcmssIGxlbmd0aCwgdHJlZUxlbmd0aCwgc2lnbmF0dXJlKSB7CiAgICBjb25zdCBibG9ja1Byb21pc2VzID0gW10KICAgIGNvbnN0IHRyZWVQcm9taXNlcyA9IFtdCiAgICBjb25zdCByb290UHJvbWlzZXMgPSBbXQoKICAgIGNvbnN0IHJ4ID0gc291cmNlLnN0b3JhZ2UucmVhZCgpCgogICAgZm9yIChjb25zdCByb290IG9mIGZsYXQuZnVsbFJvb3RzKGxlbmd0aCAqIDIpKSB7CiAgICAgIHJvb3RQcm9taXNlcy5wdXNoKHJ4LmdldFRyZWVOb2RlKHJvb3QpKQogICAgfQoKICAgIGZvciAoY29uc3QgaW5kZXggb2YgZmxhdC5wYXRjaCh0cmVlTGVuZ3RoICogMiwgbGVuZ3RoICogMikpIHsKICAgICAgdHJlZVByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUoaW5kZXgpKQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0cmVlTGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgdHJlZVByb21pc2VzLnB1c2gocnguZ2V0VHJlZU5vZGUoaSAqIDIpKQogICAgICB0cmVlUHJvbWlzZXMucHVzaChyeC5nZXRUcmVlTm9kZShpICogMiArIDEpKQogICAgICBibG9ja1Byb21pc2VzLnB1c2gocnguZ2V0QmxvY2soaSkpCiAgICB9CgogICAgcngudHJ5Rmx1c2goKQoKICAgIGNvbnN0IGJsb2NrcyA9IGF3YWl0IFByb21pc2UuYWxsKGJsb2NrUHJvbWlzZXMpCiAgICBjb25zdCBub2RlcyA9IGF3YWl0IFByb21pc2UuYWxsKHRyZWVQcm9taXNlcykKICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgUHJvbWlzZS5hbGwocm9vdFByb21pc2VzKQoKICAgIGlmICh0aGlzLmNvcmUuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ0NvcmUgZGVzdHJveWVkJykKCiAgICBpZiAoc2lnbmF0dXJlKSB7CiAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5jcmVhdGVUcmVlQmF0Y2goKQogICAgICBiYXRjaC5yb290cyA9IHJvb3RzCiAgICAgIGJhdGNoLmxlbmd0aCA9IGxlbmd0aAoKICAgICAgaWYgKCF0aGlzLmNvcmUudmVyaWZpZXIudmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpKSB7CiAgICAgICAgdGhyb3cgSU5WQUxJRF9TSUdOQVRVUkUoCiAgICAgICAgICAnU2lnbmF0dXJlIGlzIG5vdCB2YWxpZCBvdmVyIGNvbW1pdHRlZCB0cmVlJywKICAgICAgICAgIHRoaXMuY29yZS5kaXNjb3ZlcnlLZXkKICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCB0eCA9IHRoaXMuY3JlYXRlV3JpdGVCYXRjaCgpCgogICAgLy8gdHJ1bmNhdGUgZXhpc3RpbmcgdHJlZQogICAgaWYgKHRyZWVMZW5ndGggPCB0aGlzLmxlbmd0aCkgewogICAgICB0eC5kZWxldGVCbG9ja1JhbmdlKHRyZWVMZW5ndGgsIHRoaXMubGVuZ3RoKQogICAgfQoKICAgIGZvciAoY29uc3Qgcm9vdCBvZiByb290cykgdHgucHV0VHJlZU5vZGUocm9vdCkKCiAgICAvLyBubyBub2RlcyB3aWxsIGJlIGNvcGllZCBpbiBzaGFsbG93IG1vZGUKICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2RlcykgewogICAgICBpZiAobm9kZSAhPT0gbnVsbCkgdHgucHV0VHJlZU5vZGUobm9kZSkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykgewogICAgICBhc3NlcnQoYmxvY2tzW2ldICE9PSBudWxsLCAnaGFzIGJsb2NrJykKICAgICAgdHgucHV0QmxvY2soaSArIHRyZWVMZW5ndGgsIGJsb2Nrc1tpXSkKICAgIH0KCiAgICBjb25zdCB0b3RhbExlbmd0aCA9IE1hdGgubWF4KGxlbmd0aCwgdGhpcy5sZW5ndGgpCgogICAgaWYgKHRvdGFsTGVuZ3RoID4gdHJlZUxlbmd0aCkgewogICAgICBjb25zdCBmaXJzdFBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UodHJlZUxlbmd0aCkKICAgICAgY29uc3QgbGFzdFBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UodG90YWxMZW5ndGggLSAxKQoKICAgICAgY29uc3Qgc3J4ID0gdGhpcy5zdG9yYWdlLnJlYWQoKQogICAgICBjb25zdCBiaXRmaWVsZFBhZ2VQcm9taXNlID0gc3J4LmdldEJpdGZpZWxkUGFnZShmaXJzdFBhZ2UpCiAgICAgIHNyeC50cnlGbHVzaCgpCgogICAgICBjb25zdCBiaXRmaWVsZFBhZ2UgPSBhd2FpdCBiaXRmaWVsZFBhZ2VQcm9taXNlCgogICAgICBsZXQgaW5kZXggPSB0cmVlTGVuZ3RoCgogICAgICBmb3IgKGxldCBpID0gZmlyc3RQYWdlOyBpIDw9IGxhc3RQYWdlOyBpKyspIHsKICAgICAgICBjb25zdCBwYWdlID0gYjRhLmFsbG9jKEJpdGZpZWxkLkJZVEVTX1BFUl9QQUdFKQogICAgICAgIHR4LnB1dEJpdGZpZWxkUGFnZShpLCBwYWdlKQoKICAgICAgICAvLyBjb3B5IGV4aXN0aW5nIGJpdHMgaW4KICAgICAgICBpZiAoaSA9PT0gZmlyc3RQYWdlICYmIGJpdGZpZWxkUGFnZSkgcGFnZS5zZXQoYml0ZmllbGRQYWdlKQoKICAgICAgICBpZiAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGluZGV4ID0gZmlsbEJpdGZpZWxkUGFnZShwYWdlLCBpbmRleCwgbGVuZ3RoLCBpLCB0cnVlKQogICAgICAgICAgaWYgKGluZGV4IDwgbGVuZ3RoKSBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgaWYgKGluZGV4IDwgdGhpcy5sZW5ndGgpIHsKICAgICAgICAgIGluZGV4ID0gZmlsbEJpdGZpZWxkUGFnZShwYWdlLCBpbmRleCwgdGhpcy5sZW5ndGgsIGksIGZhbHNlKQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbnN0IHRyZWUgPSB7CiAgICAgIGZvcmssCiAgICAgIGxlbmd0aCwKICAgICAgcm9vdEhhc2g6IGNyeXB0by50cmVlKHJvb3RzKSwKICAgICAgc2lnbmF0dXJlCiAgICB9CgogICAgY29uc3QgdXBncmFkZWQgPSB0cmVlTGVuZ3RoIDwgdGhpcy5sZW5ndGggfHwgdGhpcy5sZW5ndGggPCBsZW5ndGggfHwgdHJlZS5mb3JrICE9PSB0aGlzLmZvcmsKCiAgICBpZiAodXBncmFkZWQpIHR4LnNldEhlYWQodHJlZSkKCiAgICBjb25zdCBmbHVzaGVkID0gYXdhaXQgdGhpcy5mbHVzaCgpCgogICAgdGhpcy5mb3JrID0gdHJlZS5mb3JrCiAgICB0aGlzLnJvb3RzID0gcm9vdHMKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBNZXJrbGVUcmVlLnNpemUocm9vdHMpCiAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZQoKICAgIHJldHVybiB7IHRyZWUsIGZsdXNoZWQgfQogIH0KCiAgYXN5bmMgY29tbWl0KHN0YXRlLCB7IHNpZ25hdHVyZSwga2V5UGFpciwgbGVuZ3RoID0gc3RhdGUubGVuZ3RoLCB0cmVlTGVuZ3RoID0gLTEgfSA9IHt9KSB7CiAgICBhc3NlcnQoCiAgICAgIHRoaXMuaXNEZWZhdWx0KCkgfHwgKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmlzRGVmYXVsdCgpKSwKICAgICAgJ0NhbiBvbmx5IGNvbW1pdCBpbnRvIGRlZmF1bHQgc3RhdGUnCiAgICApCgogICAgbGV0IHNyY0xvY2tlZCA9IGZhbHNlCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHN0YXRlLm11dGV4LmxvY2soKQogICAgICBzcmNMb2NrZWQgPSB0cnVlCgogICAgICBpZiAodHJlZUxlbmd0aCA9PT0gLTEpIHRyZWVMZW5ndGggPSBzdGF0ZS5mbHVzaGVkTGVuZ3RoKCkKCiAgICAgIGlmICghKGF3YWl0IHRoaXMuY29yZS5fdmFsaWRhdGVDb21taXQoc3RhdGUsIHRyZWVMZW5ndGgpKSkgcmV0dXJuIG51bGwKICAgICAgaWYgKHRoaXMubGVuZ3RoID4gbGVuZ3RoKSByZXR1cm4gbnVsbAoKICAgICAgaWYgKHRoaXMubGVuZ3RoIDwgbGVuZ3RoICYmICFzaWduYXR1cmUpIHsKICAgICAgICBpZiAoIWtleVBhaXIpIGtleVBhaXIgPSB0aGlzLmNvcmUuaGVhZGVyLmtleVBhaXIKICAgICAgICBjb25zdCBiYXRjaCA9IHN0YXRlLmNyZWF0ZVRyZWVCYXRjaCgpCiAgICAgICAgaWYgKGxlbmd0aCAhPT0gYmF0Y2gubGVuZ3RoKSBhd2FpdCBiYXRjaC5yZXN0b3JlKGxlbmd0aCkKICAgICAgICBzaWduYXR1cmUgPSB0aGlzLmNvcmUudmVyaWZpZXIuc2lnbihiYXRjaCwga2V5UGFpcikKICAgICAgfQoKICAgICAgY29uc3QgeyB0cmVlLCBmbHVzaGVkIH0gPSBhd2FpdCB0aGlzLl9vdmVyd3JpdGUoCiAgICAgICAgc3RhdGUsCiAgICAgICAgdGhpcy5mb3JrLAogICAgICAgIGxlbmd0aCwKICAgICAgICB0cmVlTGVuZ3RoLAogICAgICAgIHNpZ25hdHVyZQogICAgICApCgogICAgICAvLyBnYyBibG9ja3MgZnJvbSBzb3VyY2UKICAgICAgaWYgKHRyZWVMZW5ndGggPCBsZW5ndGgpIHsKICAgICAgICBjb25zdCB0eCA9IHN0YXRlLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICAgICAgICB0eC5kZWxldGVCbG9ja1JhbmdlKHRyZWVMZW5ndGgsIGxlbmd0aCkKICAgICAgICBjb25zdCBkZXBlbmRlbmN5ID0gc3RhdGUudXBkYXRlRGVwZW5kZW5jeSh0eCwgbGVuZ3RoKQoKICAgICAgICBhd2FpdCBzdGF0ZS5mbHVzaCh0eCkKCiAgICAgICAgaWYgKGRlcGVuZGVuY3kpIHN0YXRlLnN0b3JhZ2Uuc2V0RGVwZW5kZW5jeUhlYWQoZGVwZW5kZW5jeSkKICAgICAgfQoKICAgICAgY29uc3QgYml0ZmllbGQgPSB7IHN0YXJ0OiB0cmVlTGVuZ3RoLCBsZW5ndGg6IGxlbmd0aCAtIHRyZWVMZW5ndGgsIGRyb3A6IGZhbHNlIH0KICAgICAgdGhpcy5vbmFwcGVuZCh0cmVlLCBiaXRmaWVsZCwgZmx1c2hlZCkKCiAgICAgIHJldHVybiB7CiAgICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCwKICAgICAgICBieXRlTGVuZ3RoOiB0aGlzLmJ5dGVMZW5ndGgKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy51cGRhdGluZyA9IGZhbHNlCiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKCiAgICAgIGlmIChzcmNMb2NrZWQpIHsKICAgICAgICBzdGF0ZS5tdXRleC51bmxvY2soKQogICAgICAgIHN0YXRlLl9jbGVhckFjdGl2ZUJhdGNoKCkKICAgICAgfQoKICAgICAgdGhpcy5jb3JlLmNoZWNrSWZJZGxlKCkKICAgIH0KICB9CgogIGFzeW5jIF9nZXRUcmVlSGVhZEF0KGxlbmd0aCkgewogICAgaWYgKGxlbmd0aCA9PT0gbnVsbCkgcmV0dXJuIHRoaXMudHJlZUluZm8oKQoKICAgIGNvbnN0IGhlYWQgPSBnZXREZWZhdWx0VHJlZSgpCgogICAgaGVhZC5sZW5ndGggPSBsZW5ndGgKCiAgICBjb25zdCByb290cyA9IGF3YWl0IE1lcmtsZVRyZWUuZ2V0Um9vdHNGcm9tU3RvcmFnZSh0aGlzLnN0b3JhZ2UsIGxlbmd0aCkKICAgIGNvbnN0IHJvb3RIYXNoID0gY3J5cHRvLnRyZWUocm9vdHMpCgogICAgaGVhZC5mb3JrID0gdGhpcy5mb3JrCiAgICBoZWFkLnJvb3RIYXNoID0gcm9vdEhhc2gKCiAgICBpZiAobGVuZ3RoID09PSB0aGlzLmxlbmd0aCkgaGVhZC5zaWduYXR1cmUgPSB0aGlzLnNpZ25hdHVyZQoKICAgIHJldHVybiBoZWFkCiAgfQoKICBfbW92ZVRvQ29yZShjb3JlLCB0cnVuY2F0ZWQsIGFwcGVuZGVkKSB7CiAgICBjb25zdCBoZWFkID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMucG9wKCkKICAgIGlmIChoZWFkICE9PSB0aGlzKSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlc1soaGVhZC5pbmRleCA9IHRoaXMuaW5kZXgpXSA9IGhlYWQKCiAgICB0aGlzLmNvcmUgPSBjb3JlCiAgICB0aGlzLmluZGV4ID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXMucHVzaCh0aGlzKSAtIDEKCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBjb25zdCBtYW5pZmVzdCA9IHMubWFuaWZlc3QKICAgICAgcy50cmFuc2ZlclNlc3Npb24odGhpcy5jb3JlKQogICAgICBpZiAoIW1hbmlmZXN0ICYmIHMubWFuaWZlc3QpIHMuZW1pdCgnbWFuaWZlc3QnKQogICAgICBpZiAodHJ1bmNhdGVkKSBzLmVtaXQoJ3RydW5jYXRlJywgdHJ1bmNhdGVkLnRvLCB0cnVuY2F0ZWQuZm9yaykKICAgICAgaWYgKGFwcGVuZGVkKSBzLmVtaXQoJ2FwcGVuZCcpCiAgICB9CiAgfQoKICBhc3luYyBtb3ZlVG8oY29yZSwgbGVuZ3RoKSB7CiAgICBjb25zdCBzdGF0ZSA9IGNvcmUuc3RhdGUKCiAgICBhd2FpdCB0aGlzLm11dGV4LmxvY2soKQoKICAgIHRyeSB7CiAgICAgIC8vIGlmIChzdGF0ZS5zdG9yYWdlICYmIChhd2FpdCBzdGF0ZS5zdG9yYWdlLnJlc3VtZVNlc3Npb24odGhpcy5uYW1lKSkgIT09IG51bGwpIHsKICAgICAgLy8gICB0aHJvdyBTVE9SQUdFX0NPTkZMSUNUKCdCYXRjaCBoYXMgYWxyZWFkeSBiZWVuIGNyZWF0ZWQnKQogICAgICAvLyB9CgogICAgICBjb25zdCB0cmVlTGVuZ3RoID0gdGhpcy5sZW5ndGgKCiAgICAgIGxldCB0cnVuY2F0ZWQgPSBudWxsCiAgICAgIGxldCBhcHBlbmRlZCA9IGZhbHNlCgogICAgICBpZiAoIXRoaXMuaXNTbmFwc2hvdCgpKSB7CiAgICAgICAgaWYgKHRoaXMubGluZ2VycyA9PT0gbnVsbCkgdGhpcy5saW5nZXJzID0gW10KICAgICAgICB0aGlzLmxpbmdlcnMucHVzaCh0aGlzLnN0b3JhZ2UpCgogICAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCBzdGF0ZS5zdG9yYWdlLnJlc3VtZVNlc3Npb24odGhpcy5uYW1lKQoKICAgICAgICBjb25zdCB0cnVuY2F0aW9uID0gbGVuZ3RoIDwgdGhpcy5sZW5ndGggPyBhd2FpdCB0cnVuY2F0ZUFuZEZsdXNoKHRoaXMsIGxlbmd0aCkgOiBudWxsCiAgICAgICAgY29uc3QgdHJlZUluZm8gPSB0cnVuY2F0aW9uCiAgICAgICAgICA/IHRydW5jYXRpb24udHJlZQogICAgICAgICAgOiByZXN1bWVkCiAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICA6IGF3YWl0IHN0YXRlLl9nZXRUcmVlSGVhZEF0KHRoaXMubGVuZ3RoKQoKICAgICAgICBjb25zdCBmb3JrID0gdHJ1bmNhdGlvbiA/IHRoaXMuZm9yayArIDEgOiB0aGlzLmZvcmsKCiAgICAgICAgLy8gdG9kbzogdmFsaWRhdGUgdHJlZUluZm8KCiAgICAgICAgbGV0IHN0b3JhZ2UgPSBudWxsCgogICAgICAgIGlmIChyZXN1bWVkKSB7CiAgICAgICAgICBzdG9yYWdlID0gcmVzdW1lZAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmVlSW5mby5mb3JrID0gZm9yawogICAgICAgICAgc3RvcmFnZSA9IGF3YWl0IHN0YXRlLnN0b3JhZ2UuY3JlYXRlU2Vzc2lvbih0aGlzLm5hbWUsIHRyZWVJbmZvKQogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm9vdHMgPSBhd2FpdCBNZXJrbGVUcmVlLmdldFJvb3RzRnJvbVN0b3JhZ2Uoc3RvcmFnZSwgbGVuZ3RoKQoKICAgICAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlCiAgICAgICAgdGhpcy5wcm9sb2d1ZSA9IHN0YXRlLnByb2xvZ3VlCiAgICAgICAgdGhpcy5mb3JrID0gZm9yawogICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoCiAgICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gTWVya2xlVHJlZS5zaXplKHJvb3RzKQogICAgICAgIHRoaXMucm9vdHMgPSByb290cwoKICAgICAgICBpZiAodHJ1bmNhdGlvbikgewogICAgICAgICAgY29uc3QgeyBkZXBlbmRlbmN5IH0gPSB0cnVuY2F0aW9uCgogICAgICAgICAgaWYgKGRlcGVuZGVuY3kpIHRoaXMuc3RvcmFnZS5zZXREZXBlbmRlbmN5SGVhZChkZXBlbmRlbmN5KQogICAgICAgICAgdHJ1bmNhdGVkID0geyB0bzogdHJlZUxlbmd0aCwgZm9yayB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5sZW5ndGggPiB0cmVlTGVuZ3RoKSB7CiAgICAgICAgICBhcHBlbmRlZCA9IHRydWUKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSB0aGlzLmNvcmUuc2Vzc2lvblN0YXRlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5jb3JlLnNlc3Npb25TdGF0ZXNbaV0KICAgICAgICBpZiAoc3RhdGUgPT09IHRoaXMpIGNvbnRpbnVlCiAgICAgICAgaWYgKHN0YXRlLm5hbWUgPT09IHRoaXMubmFtZSkgc3RhdGUuX21vdmVUb0NvcmUoY29yZS5jb3JlKQogICAgICB9CgogICAgICB0aGlzLl9tb3ZlVG9Db3JlKGNvcmUuY29yZSwgdHJ1bmNhdGVkLCBhcHBlbmRlZCkKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMubXV0ZXgudW5sb2NrKCkKICAgIH0KICB9CgogIGFzeW5jIGNyZWF0ZVNlc3Npb24obmFtZSwgb3ZlcndyaXRlLCBhdG9tKSB7CiAgICBsZXQgc3RvcmFnZSA9IG51bGwKICAgIGxldCB0cmVlSW5mbyA9IG51bGwKCiAgICBpZiAoIWF0b20gJiYgIW92ZXJ3cml0ZSAmJiB0aGlzLnN0b3JhZ2UpIHsKICAgICAgc3RvcmFnZSA9IGF3YWl0IHRoaXMuc3RvcmFnZS5yZXN1bWVTZXNzaW9uKG5hbWUpCgogICAgICBpZiAoc3RvcmFnZSAhPT0gbnVsbCkgdHJlZUluZm8gPSAoYXdhaXQgZ2V0Q29yZUhlYWQoc3RvcmFnZSkpIHx8IGdldERlZmF1bHRUcmVlKCkKICAgIH0KCiAgICBjb25zdCBsZW5ndGggPSB0cmVlSW5mbyA/IHRyZWVJbmZvLmxlbmd0aCA6IHRoaXMubGVuZ3RoCgogICAgaWYgKHN0b3JhZ2UgPT09IG51bGwpIHsKICAgICAgdHJlZUluZm8gPSBhd2FpdCB0aGlzLl9nZXRUcmVlSGVhZEF0KGxlbmd0aCkKCiAgICAgIGlmIChhdG9tKSB7CiAgICAgICAgc3RvcmFnZSA9IGF3YWl0IHRoaXMuc3RvcmFnZS5jcmVhdGVBdG9taWNTZXNzaW9uKGF0b20sIHRyZWVJbmZvKQogICAgICB9IGVsc2UgewogICAgICAgIHN0b3JhZ2UgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuY3JlYXRlU2Vzc2lvbihuYW1lLCB0cmVlSW5mbykKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmF0b21pemVkICYmIGF0b20pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZXNzaW9uIGFscmVhZHkgYXRvbWl6ZWQnKQogICAgfQoKICAgIGNvbnN0IGhlYWQgPSB7CiAgICAgIGZvcms6IHRoaXMuZm9yaywKICAgICAgcm9vdHM6CiAgICAgICAgbGVuZ3RoID09PSB0aGlzLmxlbmd0aAogICAgICAgICAgPyB0aGlzLnJvb3RzLnNsaWNlKCkKICAgICAgICAgIDogYXdhaXQgTWVya2xlVHJlZS5nZXRSb290c0Zyb21TdG9yYWdlKHN0b3JhZ2UsIGxlbmd0aCksCiAgICAgIGxlbmd0aCwKICAgICAgcHJvbG9ndWU6IHRoaXMucHJvbG9ndWUsCiAgICAgIHNpZ25hdHVyZTogbGVuZ3RoID09PSB0aGlzLmxlbmd0aCA/IHRoaXMuc2lnbmF0dXJlIDogbnVsbAogICAgfQoKICAgIGNvbnN0IHN0YXRlID0gbmV3IFNlc3Npb25TdGF0ZSgKICAgICAgdGhpcy5jb3JlLAogICAgICBhdG9tID8gdGhpcyA6IG51bGwsCiAgICAgIHN0b3JhZ2UsCiAgICAgIGhlYWQsCiAgICAgIGF0b20gPyB0aGlzLm5hbWUgOiBuYW1lCiAgICApCgogICAgaWYgKGF0b20pIHsKICAgICAgdGhpcy5hdG9taXplZCA9IGF0b20KICAgICAgYXRvbS5vbmZsdXNoKHN0YXRlLl9jb21taXQuYmluZChzdGF0ZSkpCiAgICB9CgogICAgcmV0dXJuIHN0YXRlCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGdldEJpdGZpZWxkUGFnZShpbmRleCkgewogIHJldHVybiBNYXRoLmZsb29yKGluZGV4IC8gQml0ZmllbGQuQklUU19QRVJfUEFHRSkKfQoKZnVuY3Rpb24gZmlsbEJpdGZpZWxkUGFnZShwYWdlLCBzdGFydCwgZW5kLCBwYWdlSW5kZXgsIHZhbHVlKSB7CiAgY29uc3Qgb2Zmc2V0ID0gcGFnZUluZGV4ICogQml0ZmllbGQuQklUU19QRVJfUEFHRQogIGNvbnN0IG1heCA9IG9mZnNldCArIEJpdGZpZWxkLkJJVFNfUEVSX1BBR0UKCiAgY29uc3QgaW5kZXggPSBtYXggPCBlbmQgPyBtYXggOiBlbmQKCiAgY29uc3QgZnJvbSA9IHN0YXJ0IC0gb2Zmc2V0CiAgY29uc3QgdG8gPSBpbmRleCAtIG9mZnNldAoKICBxdWlja2JpdC5maWxsKHBhZ2UsIHZhbHVlLCBmcm9tLCB0bykKCiAgcmV0dXJuIGluZGV4Cn0KCmFzeW5jIGZ1bmN0aW9uIHN0b3JlQml0ZmllbGRSYW5nZShzdG9yYWdlLCB0eCwgZnJvbSwgdG8sIHZhbHVlKSB7CiAgaWYgKGZyb20gPj0gdG8pIHJldHVybgoKICBjb25zdCBmaXJzdFBhZ2UgPSBnZXRCaXRmaWVsZFBhZ2UoZnJvbSkKICBjb25zdCBsYXN0UGFnZSA9IGdldEJpdGZpZWxkUGFnZSh0byAtIDEpCgogIGxldCBpbmRleCA9IGZyb20KCiAgY29uc3QgcnggPSBzdG9yYWdlLnJlYWQoKQoKICBjb25zdCBwcm9taXNlcyA9IFtdCiAgZm9yIChsZXQgaSA9IGZpcnN0UGFnZTsgaSA8PSBsYXN0UGFnZTsgaSsrKSB7CiAgICBwcm9taXNlcy5wdXNoKHJ4LmdldEJpdGZpZWxkUGFnZShpKSkKICB9CgogIHJ4LnRyeUZsdXNoKCkKCiAgY29uc3QgcGFnZXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykKICBjb25zdCBjbnQgPSBsYXN0UGFnZSAtIGZpcnN0UGFnZSArIDEKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjbnQ7IGkrKykgewogICAgY29uc3QgcGFnZUluZGV4ID0gaSArIGZpcnN0UGFnZQogICAgaWYgKCFwYWdlc1tpXSkgcGFnZXNbaV0gPSBiNGEuYWxsb2MoQml0ZmllbGQuQllURVNfUEVSX1BBR0UpCgogICAgaW5kZXggPSBmaWxsQml0ZmllbGRQYWdlKHBhZ2VzW2ldLCBpbmRleCwgdG8sIHBhZ2VJbmRleCwgdmFsdWUpCiAgICB0eC5wdXRCaXRmaWVsZFBhZ2UocGFnZUluZGV4LCBwYWdlc1tpXSkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHRydW5jYXRlQW5kRmx1c2gocywgbGVuZ3RoKSB7CiAgY29uc3QgYmF0Y2ggPSBzLmNyZWF0ZVRyZWVCYXRjaCgpCiAgYXdhaXQgTWVya2xlVHJlZS50cnVuY2F0ZShzLCBsZW5ndGgsIGJhdGNoLCBzLmZvcmspCiAgY29uc3QgdHggPSBzLmNyZWF0ZVdyaXRlQmF0Y2goKQoKICBjb25zdCBpbmZvID0gYXdhaXQgcy5fdHJ1bmNhdGUodHgsIGJhdGNoKQogIGNvbnN0IGZsdXNoZWQgPSBhd2FpdCBzLmZsdXNoKCkKCiAgcmV0dXJuIHsKICAgIHRyZWU6IGluZm8udHJlZSwKICAgIHJvb3RzOiBpbmZvLnJvb3RzLAogICAgZGVwZW5kZW5jeTogaW5mby5kZXBlbmRlbmN5LAogICAgZmx1c2hlZAogIH0KfQoKZnVuY3Rpb24gdXBkYXRlRGVwZW5kZW5jeShzdGF0ZSwgbGVuZ3RoLCB0cnVuY2F0ZWQpIHsKICBjb25zdCBpID0gc3RhdGUuc3RvcmFnZS5maW5kRGVwZW5kZW5jeUluZGV4KGxlbmd0aCwgdHJ1bmNhdGVkKQogIGlmIChpID09PSAtMSkgcmV0dXJuIG51bGwgLy8gc2tpcCBkZWZhdWx0IHN0YXRlIGFuZCBvdmVybGF5cyBvZiBkZWZhdWx0CgogIHJldHVybiB7CiAgICBkYXRhUG9pbnRlcjogc3RhdGUuc3RvcmFnZS5kZXBlbmRlbmNpZXNbaV0uZGF0YVBvaW50ZXIsCiAgICBsZW5ndGgKICB9Cn0KCmZ1bmN0aW9uIGdldERlZmF1bHRUcmVlKCkgewogIHJldHVybiB7CiAgICBmb3JrOiAwLAogICAgbGVuZ3RoOiAwLAogICAgcm9vdEhhc2g6IG51bGwsCiAgICBzaWduYXR1cmU6IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGdldENvcmVIZWFkKHN0b3JhZ2UpIHsKICBjb25zdCBiID0gc3RvcmFnZS5yZWFkKCkKICBjb25zdCBwID0gYi5nZXRIZWFkKCkKICBiLnRyeUZsdXNoKCkKICByZXR1cm4gcAp9CgpmdW5jdGlvbiBpc1Jvb3RJbmRleChpbmRleCwgcm9vdHMpIHsKICBmb3IgKGNvbnN0IG5vZGUgb2Ygcm9vdHMpIHsKICAgIGlmIChub2RlLmluZGV4ID09PSBpbmRleCkgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CmNvbnN0IHsgV3JpdGFibGUsIFJlYWRhYmxlIH0gPSByZXF1aXJlKCdzdHJlYW14JykKCmNsYXNzIFJlYWRTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoY29yZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5jb3JlID0gY29yZQogICAgdGhpcy5zdGFydCA9IG9wdHMuc3RhcnQgfHwgMAogICAgdGhpcy5lbmQgPSB0eXBlb2Ygb3B0cy5lbmQgPT09ICdudW1iZXInID8gb3B0cy5lbmQgOiAtMQogICAgdGhpcy5zbmFwc2hvdCA9ICFvcHRzLmxpdmUgJiYgb3B0cy5zbmFwc2hvdCAhPT0gZmFsc2UKICAgIHRoaXMubGl2ZSA9IHRoaXMuZW5kID09PSAtMSA/ICEhb3B0cy5saXZlIDogZmFsc2UKICAgIHRoaXMud2FpdCA9IHR5cGVvZiBvcHRzLndhaXQgPT09ICdib29sZWFuJyA/IG9wdHMud2FpdCA6IHRoaXMuY29yZS53YWl0CiAgICB0aGlzLnRpbWVvdXQgPSBvcHRzLnRpbWVvdXQgfHwgY29yZS50aW1lb3V0CiAgfQoKICBfb3BlbihjYikgewogICAgdGhpcy5fb3BlblAoKS50aGVuKGNiLCBjYikKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9yZWFkUCgpLnRoZW4oY2IsIGNiKQogIH0KCiAgYXN5bmMgX29wZW5QKCkgewogICAgaWYgKHRoaXMuZW5kID09PSAtMSkgYXdhaXQgdGhpcy5jb3JlLnVwZGF0ZSgpCiAgICBlbHNlIGF3YWl0IHRoaXMuY29yZS5yZWFkeSgpCiAgICBpZiAodGhpcy5zbmFwc2hvdCAmJiB0aGlzLmVuZCA9PT0gLTEpIHRoaXMuZW5kID0gdGhpcy5jb3JlLmxlbmd0aAogIH0KCiAgYXN5bmMgX3JlYWRQKCkgewogICAgY29uc3QgZW5kID0gdGhpcy5saXZlID8gLTEgOiB0aGlzLmVuZCA9PT0gLTEgPyB0aGlzLmNvcmUubGVuZ3RoIDogdGhpcy5lbmQKICAgIGlmIChlbmQgPj0gMCAmJiB0aGlzLnN0YXJ0ID49IGVuZCkgewogICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhpcy5wdXNoKGF3YWl0IHRoaXMuY29yZS5nZXQodGhpcy5zdGFydCsrLCB7IHdhaXQ6IHRoaXMud2FpdCwgdGltZW91dDogdGhpcy50aW1lb3V0IH0pKQogIH0KfQoKZXhwb3J0cy5SZWFkU3RyZWFtID0gUmVhZFN0cmVhbQoKY2xhc3MgV3JpdGVTdHJlYW0gZXh0ZW5kcyBXcml0YWJsZSB7CiAgY29uc3RydWN0b3IoY29yZSkgewogICAgc3VwZXIoKQogICAgdGhpcy5jb3JlID0gY29yZQogIH0KCiAgX3dyaXRldihiYXRjaCwgY2IpIHsKICAgIHRoaXMuX3dyaXRldlAoYmF0Y2gpLnRoZW4oY2IsIGNiKQogIH0KCiAgYXN5bmMgX3dyaXRldlAoYmF0Y2gpIHsKICAgIGF3YWl0IHRoaXMuY29yZS5hcHBlbmQoYmF0Y2gpCiAgfQp9CgpleHBvcnRzLldyaXRlU3RyZWFtID0gV3JpdGVTdHJlYW0KCmNsYXNzIEJ5dGVTdHJlYW0gZXh0ZW5kcyBSZWFkYWJsZSB7CiAgY29uc3RydWN0b3IoY29yZSwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5fY29yZSA9IGNvcmUKICAgIHRoaXMuX2luZGV4ID0gMAogICAgdGhpcy5fcmFuZ2UgPSBudWxsCgogICAgdGhpcy5fYnl0ZU9mZnNldCA9IG9wdHMuYnl0ZU9mZnNldCB8fCAwCiAgICB0aGlzLl9ieXRlTGVuZ3RoID0gdHlwZW9mIG9wdHMuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicgPyBvcHRzLmJ5dGVMZW5ndGggOiAtMQogICAgdGhpcy5fcHJlZmV0Y2ggPSB0eXBlb2Ygb3B0cy5wcmVmZXRjaCA9PT0gJ251bWJlcicgPyBvcHRzLnByZWZldGNoIDogMzIKCiAgICB0aGlzLl9hcHBseU9mZnNldCA9IHRoaXMuX2J5dGVPZmZzZXQgPiAwCiAgfQoKICBfb3BlbihjYikgewogICAgdGhpcy5fb3BlbnAoKS50aGVuKGNiLCBjYikKICB9CgogIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9yZWFkcCgpLnRoZW4oY2IsIGNiKQogIH0KCiAgYXN5bmMgX29wZW5wKCkgewogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggPT09IC0xKSB7CiAgICAgIGF3YWl0IHRoaXMuX2NvcmUudXBkYXRlKCkKICAgICAgdGhpcy5fYnl0ZUxlbmd0aCA9IE1hdGgubWF4KHRoaXMuX2NvcmUuYnl0ZUxlbmd0aCAtIHRoaXMuX2J5dGVPZmZzZXQsIDApCiAgICB9CiAgfQoKICBhc3luYyBfcmVhZHAoKSB7CiAgICBsZXQgZGF0YSA9IG51bGwKCiAgICBpZiAodGhpcy5fYnl0ZUxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLnB1c2gobnVsbCkKICAgICAgcmV0dXJuCiAgICB9CgogICAgbGV0IHJlbGF0aXZlT2Zmc2V0ID0gMAoKICAgIGlmICh0aGlzLl9hcHBseU9mZnNldCkgewogICAgICB0aGlzLl9hcHBseU9mZnNldCA9IGZhbHNlCgogICAgICBjb25zdCBbYmxvY2ssIGJ5dGVPZmZzZXRdID0gYXdhaXQgdGhpcy5fY29yZS5zZWVrKHRoaXMuX2J5dGVPZmZzZXQpCgogICAgICB0aGlzLl9pbmRleCA9IGJsb2NrCiAgICAgIHJlbGF0aXZlT2Zmc2V0ID0gYnl0ZU9mZnNldAogICAgfQoKICAgIHRoaXMuX3ByZWRvd25sb2FkKHRoaXMuX2luZGV4ICsgMSkKICAgIGRhdGEgPSBhd2FpdCB0aGlzLl9jb3JlLmdldCh0aGlzLl9pbmRleCsrLCB7IHZhbHVlRW5jb2Rpbmc6ICdiaW5hcnknIH0pCgogICAgaWYgKHJlbGF0aXZlT2Zmc2V0ID4gMCkgZGF0YSA9IGRhdGEuc3ViYXJyYXkocmVsYXRpdmVPZmZzZXQpCgogICAgaWYgKGRhdGEuYnl0ZUxlbmd0aCA+IHRoaXMuX2J5dGVMZW5ndGgpIGRhdGEgPSBkYXRhLnN1YmFycmF5KDAsIHRoaXMuX2J5dGVMZW5ndGgpCiAgICB0aGlzLl9ieXRlTGVuZ3RoIC09IGRhdGEuYnl0ZUxlbmd0aAoKICAgIHRoaXMucHVzaChkYXRhKQogICAgaWYgKHRoaXMuX2J5dGVMZW5ndGggPT09IDApIHRoaXMucHVzaChudWxsKQogIH0KCiAgX3ByZWRvd25sb2FkKGluZGV4KSB7CiAgICBpZiAodGhpcy5fcmFuZ2UpIHRoaXMuX3JhbmdlLmRlc3Ryb3koKQogICAgdGhpcy5fcmFuZ2UgPSB0aGlzLl9jb3JlLmRvd25sb2FkKHsgc3RhcnQ6IGluZGV4LCBlbmQ6IGluZGV4ICsgdGhpcy5fcHJlZmV0Y2gsIGxpbmVhcjogdHJ1ZSB9KQogIH0KCiAgX2Rlc3Ryb3koY2IpIHsKICAgIGlmICh0aGlzLl9yYW5nZSkgdGhpcy5fcmFuZ2UuZGVzdHJveSgpCiAgICBjYihudWxsKQogIH0KfQoKZXhwb3J0cy5CeXRlU3RyZWFtID0gQnl0ZVN0cmVhbQpjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdoeXBlcmNvcmUtY3J5cHRvJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBmbGF0ID0gcmVxdWlyZSgnZmxhdC10cmVlJykKY29uc3QgeyBCQURfQVJHVU1FTlQgfSA9IHJlcXVpcmUoJ2h5cGVyY29yZS1lcnJvcnMnKQpjb25zdCB1bnNsYWIgPSByZXF1aXJlKCd1bnNsYWInKQoKY29uc3QgbSA9IHJlcXVpcmUoJy4vbWVzc2FnZXMnKQpjb25zdCBtdWx0aXNpZyA9IHJlcXVpcmUoJy4vbXVsdGlzaWcnKQpjb25zdCBjYXBzID0gcmVxdWlyZSgnLi9jYXBzJykKCmNsYXNzIFNpZ25lciB7CiAgY29uc3RydWN0b3IoCiAgICBtYW5pZmVzdEhhc2gsCiAgICB2ZXJzaW9uLAogICAgaW5kZXgsCiAgICB7IHNpZ25hdHVyZSA9ICdlZDI1NTE5JywgcHVibGljS2V5LCBuYW1lc3BhY2UgPSBjYXBzLkRFRkFVTFRfTkFNRVNQQUNFIH0gPSB7fQogICkgewogICAgaWYgKCFwdWJsaWNLZXkpIHRocm93IEJBRF9BUkdVTUVOVCgncHVibGljIGtleSBpcyByZXF1aXJlZCBmb3IgYSBzaWduZXInKQogICAgaWYgKHNpZ25hdHVyZSAhPT0gJ2VkMjU1MTknKSB0aHJvdyBCQURfQVJHVU1FTlQoJ09ubHkgRWQyNTUxOSBzaWduYXR1cmVzIGFyZSBzdXBwb3J0ZWQnKQoKICAgIHRoaXMubWFuaWZlc3RIYXNoID0gbWFuaWZlc3RIYXNoCiAgICB0aGlzLnZlcnNpb24gPSB2ZXJzaW9uCiAgICB0aGlzLnNpZ25lciA9IGluZGV4CiAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZQogICAgdGhpcy5wdWJsaWNLZXkgPSBwdWJsaWNLZXkKICAgIHRoaXMubmFtZXNwYWNlID0gbmFtZXNwYWNlCiAgfQoKICBfY3R4KCkgewogICAgcmV0dXJuIHRoaXMudmVyc2lvbiA9PT0gMCA/IHRoaXMubmFtZXNwYWNlIDogdGhpcy5tYW5pZmVzdEhhc2gKICB9CgogIHZlcmlmeShiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICByZXR1cm4gY3J5cHRvLnZlcmlmeShiYXRjaC5zaWduYWJsZSh0aGlzLl9jdHgoKSksIHNpZ25hdHVyZSwgdGhpcy5wdWJsaWNLZXkpCiAgfQoKICBzaWduKGJhdGNoLCBrZXlQYWlyKSB7CiAgICByZXR1cm4gY3J5cHRvLnNpZ24oYmF0Y2guc2lnbmFibGUodGhpcy5fY3R4KCkpLCBrZXlQYWlyLnNlY3JldEtleSkKICB9Cn0KCmNsYXNzIENvbXBhdFNpZ25lciBleHRlbmRzIFNpZ25lciB7CiAgY29uc3RydWN0b3IoaW5kZXgsIHNpZ25lciwgbGVnYWN5KSB7CiAgICBzdXBlcihudWxsLCAwLCBpbmRleCwgc2lnbmVyKQogICAgdGhpcy5sZWdhY3kgPSBsZWdhY3kKICB9CgogIHZlcmlmeShiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICByZXR1cm4gY3J5cHRvLnZlcmlmeShiYXRjaC5zaWduYWJsZUNvbXBhdCh0aGlzLmxlZ2FjeSksIHNpZ25hdHVyZSwgdGhpcy5wdWJsaWNLZXkpCiAgfQoKICBzaWduKGJhdGNoLCBrZXlQYWlyKSB7CiAgICByZXR1cm4gY3J5cHRvLnNpZ24oYmF0Y2guc2lnbmFibGVDb21wYXQodGhpcy5sZWdhY3kpLCBrZXlQYWlyLnNlY3JldEtleSkKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVmVyaWZpZXIgewogIGNvbnN0cnVjdG9yKAogICAgbWFuaWZlc3RIYXNoLAogICAgbWFuaWZlc3QsCiAgICB7IGNvbXBhdCA9IGlzQ29tcGF0KG1hbmlmZXN0SGFzaCwgbWFuaWZlc3QpLCBsZWdhY3kgPSBmYWxzZSB9ID0ge30KICApIHsKICAgIGNvbnN0IHNlbGYgPSB0aGlzCgogICAgdGhpcy5tYW5pZmVzdEhhc2ggPSBtYW5pZmVzdEhhc2gKICAgIHRoaXMuY29tcGF0ID0gY29tcGF0IHx8IG1hbmlmZXN0ID09PSBudWxsCiAgICB0aGlzLnZlcnNpb24gPSB0aGlzLmNvbXBhdCA/IDAgOiB0eXBlb2YgbWFuaWZlc3QudmVyc2lvbiA9PT0gJ251bWJlcicgPyBtYW5pZmVzdC52ZXJzaW9uIDogMQogICAgdGhpcy5oYXNoID0gbWFuaWZlc3QuaGFzaCB8fCAnYmxha2UyYicKICAgIHRoaXMuYWxsb3dQYXRjaCA9ICF0aGlzLmNvbXBhdCAmJiAhIW1hbmlmZXN0LmFsbG93UGF0Y2gKICAgIHRoaXMucXVvcnVtID0gdGhpcy5jb21wYXQgPyAxIDogZGVmYXVsdFF1b3J1bShtYW5pZmVzdCkKCiAgICB0aGlzLnNpZ25lcnMgPSBtYW5pZmVzdC5zaWduZXJzID8gbWFuaWZlc3Quc2lnbmVycy5tYXAoY3JlYXRlU2lnbmVyKSA6IFtdCiAgICB0aGlzLnByb2xvZ3VlID0gdGhpcy5jb21wYXQgPyBudWxsIDogbWFuaWZlc3QucHJvbG9ndWUgfHwgbnVsbAoKICAgIGZ1bmN0aW9uIGNyZWF0ZVNpZ25lcihzaWduZXIsIGluZGV4KSB7CiAgICAgIHJldHVybiBzZWxmLmNvbXBhdAogICAgICAgID8gbmV3IENvbXBhdFNpZ25lcihpbmRleCwgc2lnbmVyLCBsZWdhY3kpCiAgICAgICAgOiBuZXcgU2lnbmVyKG1hbmlmZXN0SGFzaCwgc2VsZi52ZXJzaW9uLCBpbmRleCwgc2lnbmVyKQogICAgfQogIH0KCiAgX3ZlcmlmeUNvbXBhdChiYXRjaCwgc2lnbmF0dXJlKSB7CiAgICBpZiAoIXNpZ25hdHVyZSkgcmV0dXJuIGZhbHNlCgogICAgaWYgKHRoaXMuY29tcGF0IHx8ICghdGhpcy5hbGxvd1BhdGNoICYmIHRoaXMuc2lnbmVycy5sZW5ndGggPT09IDEpKSB7CiAgICAgIHJldHVybiAhIXNpZ25hdHVyZSAmJiB0aGlzLnNpZ25lcnNbMF0udmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3ZlcmlmeU11bHRpKGJhdGNoLCBzaWduYXR1cmUpCiAgfQoKICBfaW5mbGF0ZShzaWduYXR1cmUpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPj0gMSkgcmV0dXJuIG11bHRpc2lnLmluZmxhdGUoc2lnbmF0dXJlKQogICAgY29uc3QgeyBwcm9vZnMsIHBhdGNoIH0gPSBtdWx0aXNpZy5pbmZsYXRldjAoc2lnbmF0dXJlKQoKICAgIHJldHVybiB7CiAgICAgIHByb29mczogcHJvb2ZzLm1hcChwcm9vZlRvVmVyc2lvbjEpLAogICAgICBwYXRjaAogICAgfQogIH0KCiAgX3ZlcmlmeU11bHRpKGJhdGNoLCBzaWduYXR1cmUpIHsKICAgIGlmICghc2lnbmF0dXJlIHx8IHRoaXMucXVvcnVtID09PSAwKSByZXR1cm4gZmFsc2UKCiAgICBjb25zdCB7IHByb29mcywgcGF0Y2ggfSA9IHRoaXMuX2luZmxhdGUoc2lnbmF0dXJlKQogICAgaWYgKHByb29mcy5sZW5ndGggPCB0aGlzLnF1b3J1bSkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgdHJpZWQgPSBuZXcgVWludDhBcnJheSh0aGlzLnNpZ25lcnMubGVuZ3RoKQogICAgY29uc3Qgbm9kZXMgPSB0aGlzLmFsbG93UGF0Y2ggJiYgcGF0Y2gubGVuZ3RoID8gdG9NYXAocGF0Y2gpIDogbnVsbAoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5xdW9ydW07IGkrKykgewogICAgICBjb25zdCBpbnAgPSBwcm9vZnNbaV0KCiAgICAgIGxldCB0cmVlID0gYmF0Y2gKCiAgICAgIGlmIChpbnAucGF0Y2ggJiYgdGhpcy5hbGxvd1BhdGNoKSB7CiAgICAgICAgdHJlZSA9IGJhdGNoLmNsb25lKCkKCiAgICAgICAgY29uc3QgdXBncmFkZSA9IGdlbmVyYXRlVXBncmFkZShub2RlcywgYmF0Y2gubGVuZ3RoLCBpbnAucGF0Y2gpCiAgICAgICAgY29uc3QgcHJvb2YgPSB7CiAgICAgICAgICBmb3JrOiB0cmVlLmZvcmssCiAgICAgICAgICBibG9jazogbnVsbCwKICAgICAgICAgIGhhc2g6IG51bGwsCiAgICAgICAgICBzZWVrOiBudWxsLAogICAgICAgICAgdXBncmFkZSwKICAgICAgICAgIG1hbmlmZXN0OiBudWxsCiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKCF0cmVlLnZlcmlmeVVwZ3JhZGUocHJvb2YpKSByZXR1cm4gZmFsc2UKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlucC5zaWduZXIgPj0gdGhpcy5zaWduZXJzLmxlbmd0aCB8fCB0cmllZFtpbnAuc2lnbmVyXSkgcmV0dXJuIGZhbHNlCiAgICAgIHRyaWVkW2lucC5zaWduZXJdID0gMQoKICAgICAgY29uc3QgcyA9IHRoaXMuc2lnbmVyc1tpbnAuc2lnbmVyXQogICAgICBpZiAoIXMudmVyaWZ5KHRyZWUsIGlucC5zaWduYXR1cmUpKSByZXR1cm4gZmFsc2UKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgdmVyaWZ5KGJhdGNoLCBzaWduYXR1cmUpIHsKICAgIGlmICh0aGlzLnZlcnNpb24gPT09IDApIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcmlmeUNvbXBhdChiYXRjaCwgc2lnbmF0dXJlKQogICAgfQoKICAgIGlmICh0aGlzLnByb2xvZ3VlICE9PSBudWxsICYmIGJhdGNoLmxlbmd0aCA8PSB0aGlzLnByb2xvZ3VlLmxlbmd0aCkgewogICAgICByZXR1cm4gYmF0Y2gubGVuZ3RoID09PSB0aGlzLnByb2xvZ3VlLmxlbmd0aCAmJiBiNGEuZXF1YWxzKGJhdGNoLmhhc2goKSwgdGhpcy5wcm9sb2d1ZS5oYXNoKQogICAgfQoKICAgIHJldHVybiB0aGlzLl92ZXJpZnlNdWx0aShiYXRjaCwgc2lnbmF0dXJlKQogIH0KCiAgLy8gVE9ETzogYmV0dGVyIGFwaSBmb3IgdGhpcyB0aGF0IGlzIG1vcmUgLi4uIG11bHRpc2lnLWV5CiAgc2lnbihiYXRjaCwga2V5UGFpcikgewogICAgaWYgKCFrZXlQYWlyIHx8ICFrZXlQYWlyLnNlY3JldEtleSkgdGhyb3cgQkFEX0FSR1VNRU5UKCdObyBrZXkgcGFpciB3YXMgcGFzc2VkJykKCiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5zaWduZXJzKSB7CiAgICAgIGlmIChiNGEuZXF1YWxzKHMucHVibGljS2V5LCBrZXlQYWlyLnB1YmxpY0tleSkpIHsKICAgICAgICBjb25zdCBzaWduYXR1cmUgPSBzLnNpZ24oYmF0Y2gsIGtleVBhaXIpCiAgICAgICAgaWYgKHRoaXMuc2lnbmVycy5sZW5ndGggIT09IDEgfHwgdGhpcy52ZXJzaW9uID09PSAwKSByZXR1cm4gc2lnbmF0dXJlCiAgICAgICAgcmV0dXJuIHRoaXMuYXNzZW1ibGUoW3sgc2lnbmVyOiAwLCBzaWduYXR1cmUsIHBhdGNoOiAwLCBub2RlczogbnVsbCB9XSkKICAgICAgfQogICAgfQoKICAgIHRocm93IEJBRF9BUkdVTUVOVCgnUHVibGljIGtleSBpcyBub3QgYSBkZWNsYXJlZCBzaWduZXInKQogIH0KCiAgYXNzZW1ibGUoaW5wdXRzKSB7CiAgICByZXR1cm4gdGhpcy52ZXJzaW9uID09PSAwID8gbXVsdGlzaWcuYXNzZW1ibGV2MChpbnB1dHMpIDogbXVsdGlzaWcuYXNzZW1ibGUoaW5wdXRzKQogIH0KCiAgc3RhdGljIG1hbmlmZXN0SGFzaChtYW5pZmVzdCkgewogICAgcmV0dXJuIG1hbmlmZXN0SGFzaChtYW5pZmVzdCkKICB9CgogIHN0YXRpYyBlbmNvZGVNYW5pZmVzdChtYW5pZmVzdCkgewogICAgcmV0dXJuIGMuZW5jb2RlKG0ubWFuaWZlc3QsIG1hbmlmZXN0KQogIH0KCiAgc3RhdGljIGRlY29kZU1hbmlmZXN0KG1hbmlmZXN0KSB7CiAgICByZXR1cm4gYy5kZWNvZGUobS5tYW5pZmVzdCwgbWFuaWZlc3QpCiAgfQoKICBzdGF0aWMgZGVmYXVsdFNpZ25lck1hbmlmZXN0KHB1YmxpY0tleSkgewogICAgcmV0dXJuIHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgaGFzaDogJ2JsYWtlMmInLAogICAgICBhbGxvd1BhdGNoOiBmYWxzZSwKICAgICAgcXVvcnVtOiAxLAogICAgICBzaWduZXJzOiBbCiAgICAgICAgewogICAgICAgICAgc2lnbmF0dXJlOiAnZWQyNTUxOScsCiAgICAgICAgICBuYW1lc3BhY2U6IGNhcHMuREVGQVVMVF9OQU1FU1BBQ0UsCiAgICAgICAgICBwdWJsaWNLZXkKICAgICAgICB9CiAgICAgIF0sCiAgICAgIHByb2xvZ3VlOiBudWxsLAogICAgICBsaW5rZWQ6IG51bGwsCiAgICAgIHVzZXJEYXRhOiBudWxsCiAgICB9CiAgfQoKICBzdGF0aWMgZnJvbU1hbmlmZXN0KG1hbmlmZXN0LCBvcHRzKSB7CiAgICBjb25zdCBtID0gdGhpcy5jcmVhdGVNYW5pZmVzdChtYW5pZmVzdCkKICAgIHJldHVybiBuZXcgdGhpcyhtYW5pZmVzdEhhc2gobSksIG0sIG9wdHMpCiAgfQoKICBzdGF0aWMgY3JlYXRlTWFuaWZlc3QoaW5wKSB7CiAgICBpZiAoIWlucCkgcmV0dXJuIG51bGwKCiAgICBjb25zdCBtYW5pZmVzdCA9IHsKICAgICAgdmVyc2lvbjogZ2V0TWFuaWZlc3RWZXJzaW9uKGlucCksIC8vIGRlZmF1bHRzIHRvIHYxCiAgICAgIGhhc2g6ICdibGFrZTJiJywKICAgICAgYWxsb3dQYXRjaDogISFpbnAuYWxsb3dQYXRjaCwKICAgICAgcXVvcnVtOiBkZWZhdWx0UXVvcnVtKGlucCksCiAgICAgIHNpZ25lcnM6IGlucC5zaWduZXJzID8gaW5wLnNpZ25lcnMubWFwKHBhcnNlU2lnbmVyKSA6IFtdLAogICAgICBwcm9sb2d1ZTogbnVsbCwKICAgICAgbGlua2VkOiBudWxsLAogICAgICB1c2VyRGF0YTogaW5wLnVzZXJEYXRhIHx8IG51bGwKICAgIH0KCiAgICBpZiAoaW5wLmhhc2ggJiYgaW5wLmhhc2ggIT09ICdibGFrZTJiJykgdGhyb3cgQkFEX0FSR1VNRU5UKCdPbmx5IEJsYWtlMmIgaGFzaGVzIGFyZSBzdXBwb3J0ZWQnKQoKICAgIGlmIChpbnAucHJvbG9ndWUpIHsKICAgICAgaWYgKAogICAgICAgICEoYjRhLmlzQnVmZmVyKGlucC5wcm9sb2d1ZS5oYXNoKSAmJiBpbnAucHJvbG9ndWUuaGFzaC5ieXRlTGVuZ3RoID09PSAzMikgfHwKICAgICAgICAhKGlucC5wcm9sb2d1ZS5sZW5ndGggPj0gMCkKICAgICAgKSB7CiAgICAgICAgdGhyb3cgQkFEX0FSR1VNRU5UKCdJbnZhbGlkIHByb2xvZ3VlJykKICAgICAgfQoKICAgICAgbWFuaWZlc3QucHJvbG9ndWUgPSBpbnAucHJvbG9ndWUKICAgICAgbWFuaWZlc3QucHJvbG9ndWUuaGFzaCA9IHVuc2xhYihtYW5pZmVzdC5wcm9sb2d1ZS5oYXNoKQogICAgfQoKICAgIGlmIChtYW5pZmVzdC51c2VyRGF0YSAhPT0gbnVsbCAmJiBtYW5pZmVzdC52ZXJzaW9uIDwgMikgewogICAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0ludmFsaWQgZmllbGQ6IHVzZXJEYXRhJykKICAgIH0KCiAgICBpZiAoaW5wLmxpbmtlZCAmJiBpbnAubGlua2VkLmxlbmd0aCkgewogICAgICBpZiAobWFuaWZlc3QudmVyc2lvbiA8IDIpIHRocm93IEJBRF9BUkdVTUVOVCgnSW52YWxpZCBmaWVsZDogbGlua2VkJykKCiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGlucC5saW5rZWQpIHsKICAgICAgICBpZiAoIShiNGEuaXNCdWZmZXIoa2V5KSAmJiBrZXkuYnl0ZUxlbmd0aCA9PT0gMzIpKSB7CiAgICAgICAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ0ludmFsaWQga2V5JykKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1hbmlmZXN0LmxpbmtlZCA9IGlucC5saW5rZWQKICAgIH0KCiAgICByZXR1cm4gbWFuaWZlc3QKICB9CgogIHN0YXRpYyBpc1ZhbGlkTWFuaWZlc3Qoa2V5LCBtYW5pZmVzdCkgewogICAgcmV0dXJuIGI0YS5lcXVhbHMoa2V5LCBtYW5pZmVzdEhhc2gobWFuaWZlc3QpKQogIH0KCiAgc3RhdGljIGlzQ29tcGF0KGtleSwgbWFuaWZlc3QpIHsKICAgIHJldHVybiBpc0NvbXBhdChrZXksIG1hbmlmZXN0KQogIH0KCiAgc3RhdGljIHNpZ24obWFuaWZlc3QsIGJhdGNoLCBrZXlQYWlyLCBvcHRzKSB7CiAgICByZXR1cm4gVmVyaWZpZXIuZnJvbU1hbmlmZXN0KG1hbmlmZXN0LCBvcHRzKS5zaWduKGJhdGNoLCBrZXlQYWlyKQogIH0KfQoKZnVuY3Rpb24gdG9NYXAobm9kZXMpIHsKICBjb25zdCBtID0gbmV3IE1hcCgpCiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSBtLnNldChub2RlLmluZGV4LCBub2RlKQogIHJldHVybiBtCn0KCmZ1bmN0aW9uIGlzQ29tcGF0KGtleSwgbWFuaWZlc3QpIHsKICByZXR1cm4gISEoCiAgICBtYW5pZmVzdCAmJgogICAgbWFuaWZlc3Quc2lnbmVycy5sZW5ndGggPT09IDEgJiYKICAgIGI0YS5lcXVhbHMoa2V5LCBtYW5pZmVzdC5zaWduZXJzWzBdLnB1YmxpY0tleSkKICApCn0KCmZ1bmN0aW9uIGRlZmF1bHRRdW9ydW0obWFuKSB7CiAgaWYgKHR5cGVvZiBtYW4ucXVvcnVtID09PSAnbnVtYmVyJykgcmV0dXJuIG1hbi5xdW9ydW0KICBpZiAoIW1hbi5zaWduZXJzIHx8ICFtYW4uc2lnbmVycy5sZW5ndGgpIHJldHVybiAwCiAgcmV0dXJuIChtYW4uc2lnbmVycy5sZW5ndGggPj4gMSkgKyAxCn0KCmZ1bmN0aW9uIGdlbmVyYXRlVXBncmFkZShwYXRjaCwgc3RhcnQsIGxlbmd0aCkgewogIGNvbnN0IHVwZ3JhZGUgPSB7IHN0YXJ0LCBsZW5ndGgsIG5vZGVzOiBudWxsLCBhZGRpdGlvbmFsTm9kZXM6IFtdLCBzaWduYXR1cmU6IG51bGwgfQoKICBjb25zdCBmcm9tID0gc3RhcnQgKiAyCiAgY29uc3QgdG8gPSBmcm9tICsgbGVuZ3RoICogMgoKICBmb3IgKGNvbnN0IGl0ZSA9IGZsYXQuaXRlcmF0b3IoMCk7IGl0ZS5mdWxsUm9vdCh0byk7IGl0ZS5uZXh0VHJlZSgpKSB7CiAgICBpZiAoaXRlLmluZGV4ICsgaXRlLmZhY3RvciAvIDIgPCBmcm9tKSBjb250aW51ZQoKICAgIGlmICh1cGdyYWRlLm5vZGVzID09PSBudWxsICYmIGl0ZS5jb250YWlucyhmcm9tIC0gMikpIHsKICAgICAgdXBncmFkZS5ub2RlcyA9IFtdCgogICAgICBjb25zdCByb290ID0gaXRlLmluZGV4CiAgICAgIGNvbnN0IHRhcmdldCA9IGZyb20gLSAyCgogICAgICBpdGUuc2Vlayh0YXJnZXQpCgogICAgICB3aGlsZSAoaXRlLmluZGV4ICE9PSByb290KSB7CiAgICAgICAgaXRlLnNpYmxpbmcoKQogICAgICAgIGlmIChpdGUuaW5kZXggPiB0YXJnZXQpIHVwZ3JhZGUubm9kZXMucHVzaChwYXRjaC5nZXQoaXRlLmluZGV4KSkKICAgICAgICBpdGUucGFyZW50KCkKICAgICAgfQoKICAgICAgY29udGludWUKICAgIH0KCiAgICBpZiAodXBncmFkZS5ub2RlcyA9PT0gbnVsbCkgdXBncmFkZS5ub2RlcyA9IFtdCiAgICB1cGdyYWRlLm5vZGVzLnB1c2gocGF0Y2guZ2V0KGl0ZS5pbmRleCkpCiAgfQoKICBpZiAodXBncmFkZS5ub2RlcyA9PT0gbnVsbCkgdXBncmFkZS5ub2RlcyA9IFtdCiAgcmV0dXJuIHVwZ3JhZGUKfQoKZnVuY3Rpb24gcGFyc2VTaWduZXIoc2lnbmVyKSB7CiAgdmFsaWRhdGVTaWduZXIoc2lnbmVyKQogIHJldHVybiB7CiAgICBzaWduYXR1cmU6ICdlZDI1NTE5JywKICAgIG5hbWVzcGFjZTogdW5zbGFiKHNpZ25lci5uYW1lc3BhY2UgfHwgY2Fwcy5ERUZBVUxUX05BTUVTUEFDRSksCiAgICBwdWJsaWNLZXk6IHVuc2xhYihzaWduZXIucHVibGljS2V5KQogIH0KfQoKZnVuY3Rpb24gdmFsaWRhdGVTaWduZXIoc2lnbmVyKSB7CiAgaWYgKCFzaWduZXIgfHwgIXNpZ25lci5wdWJsaWNLZXkpIHRocm93IEJBRF9BUkdVTUVOVCgnU2lnbmVyIG1pc3NpbmcgcHVibGljIGtleScpCiAgaWYgKHNpZ25lci5zaWduYXR1cmUgJiYgc2lnbmVyLnNpZ25hdHVyZSAhPT0gJ2VkMjU1MTknKSB7CiAgICB0aHJvdyBCQURfQVJHVU1FTlQoJ09ubHkgRWQyNTUxOSBzaWduYXR1cmVzIGFyZSBzdXBwb3J0ZWQnKQogIH0KfQoKZnVuY3Rpb24gbWFuaWZlc3RIYXNoKG1hbmlmZXN0KSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDMyLCBidWZmZXI6IG51bGwgfQogIG0ubWFuaWZlc3QucHJlZW5jb2RlKHN0YXRlLCBtYW5pZmVzdCkKICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kKQogIGMucmF3LmVuY29kZShzdGF0ZSwgY2Fwcy5NQU5JRkVTVCkKICBtLm1hbmlmZXN0LmVuY29kZShzdGF0ZSwgbWFuaWZlc3QpCiAgcmV0dXJuIGNyeXB0by5oYXNoKHN0YXRlLmJ1ZmZlcikKfQoKZnVuY3Rpb24gcHJvb2ZUb1ZlcnNpb24xKHByb29mKSB7CiAgcmV0dXJuIHsKICAgIHNpZ25lcjogcHJvb2Yuc2lnbmVyLAogICAgc2lnbmF0dXJlOiBwcm9vZi5zaWduYXR1cmUsCiAgICBwYXRjaDogcHJvb2YucGF0Y2ggPyBwcm9vZi5wYXRjaC5sZW5ndGggOiAwCiAgfQp9CgpmdW5jdGlvbiBnZXRNYW5pZmVzdFZlcnNpb24oaW5wKSB7CiAgaWYgKHR5cGVvZiBpbnAudmVyc2lvbiA9PT0gJ251bWJlcicpIHJldHVybiBpbnAudmVyc2lvbgogIGlmIChpbnAubGlua2VkICYmIGlucC5saW5rZWQubGVuZ3RoKSByZXR1cm4gMgogIGlmIChpbnAudXNlckRhdGEpIHJldHVybiAyCiAgcmV0dXJuIDEKfQp7CiAgIm5hbWUiOiAiaHlwZXJjb3JlIiwKICAidmVyc2lvbiI6ICIxMS4yMS41IiwKICAiZGVzY3JpcHRpb24iOiAiSHlwZXJjb3JlIGlzIGEgc2VjdXJlLCBkaXN0cmlidXRlZCBhcHBlbmQtb25seSBsb2ciLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLS13cml0ZSAuIiwKICAgICJsaW50IjogInByZXR0aWVyIC0tY2hlY2sgLiAmJiBsdW50ZSIsCiAgICAidGVzdCI6ICJicml0dGxlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAiYmFyZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUuZ2l0IgogIH0sCiAgImNvbnRyaWJ1dG9ycyI6IFsKICAgIHsKICAgICAgIm5hbWUiOiAiTWF0aGlhcyBCdXVzIiwKICAgICAgImVtYWlsIjogIm1hdGhpYXNidXVzQGdtYWlsLmNvbSIsCiAgICAgICJ1cmwiOiAiaHR0cHM6Ly9tYWZpbnRvLnNoIgogICAgfSwKICAgIHsKICAgICAgIm5hbWUiOiAiQW5kcmV3IE9zaGVyb2ZmIiwKICAgICAgImVtYWlsIjogImFuZHJld29zaEBnbWFpbC5jb20iLAogICAgICAidXJsIjogImh0dHBzOi8vYW5kcmV3b3NoLmNvbSIKICAgIH0KICBdLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmNvcmUjcmVhZG1lIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImVycm9ycy5qcyIsCiAgICAibWVzc2FnZXMuanMiLAogICAgImxpYi8qKi5qcyIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuMC4wIiwKICAgICJiNGEiOiAiXjEuMS4wIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImJpZy1zcGFyc2UtYXJyYXkiOiAiXjEuMC4zIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjExLjAiLAogICAgImZhc3QtZmlmbyI6ICJeMS4zLjAiLAogICAgImZsYXQtdHJlZSI6ICJeMS45LjAiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuMi4xIiwKICAgICJoeXBlcmNvcmUtZXJyb3JzIjogIl4xLjUuMCIsCiAgICAiaHlwZXJjb3JlLWlkLWVuY29kaW5nIjogIl4xLjIuMCIsCiAgICAiaHlwZXJjb3JlLXN0b3JhZ2UiOiAiXjIuMC4wIiwKICAgICJpcy1vcHRpb25zIjogIl4xLjAuMSIsCiAgICAibmFub2Fzc2VydCI6ICJeMi4wLjAiLAogICAgInByb3RvbXV4IjogIl4zLjUuMCIsCiAgICAicXVpY2tiaXQtdW5pdmVyc2FsIjogIl4yLjIuMCIsCiAgICAicmFuZG9tLWFycmF5LWl0ZXJhdG9yIjogIl4xLjAuMCIsCiAgICAic2FmZXR5LWNhdGNoIjogIl4xLjAuMSIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjEiLAogICAgInN0cmVhbXgiOiAiXjIuMTIuNCIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIsCiAgICAiejMyIjogIl4xLjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjAiLAogICAgImRlYnVnZ2luZy1zdHJlYW0iOiAiXjMuMS4wIiwKICAgICJoeXBlcnN3YXJtIjogIl40LjMuNiIsCiAgICAibHVudGUiOiAiXjEuMy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJyYWNoZSI6ICJeMS4wLjAiLAogICAgInJhbmdlLXBhcnNlciI6ICJeMS4yLjEiLAogICAgInJlc29sdmUtcmVqZWN0LXByb21pc2UiOiAiXjEuMS4wIiwKICAgICJzcGVlZG9tZXRlciI6ICJeMS4xLjAiLAogICAgInRlc3QtdG1wIjogIl4xLjAuMiIsCiAgICAidGlueS1ieXRlLXNpemUiOiAiXjEuMS4wIiwKICAgICJ1ZHgtbmF0aXZlIjogIl4xLjYuMSIsCiAgICAidW5jYXVnaHRzIjogIl4xLjEuMCIKICB9Cn0KY29uc3QgREhUID0gcmVxdWlyZSgnZGh0LXJwYycpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgbSA9IHJlcXVpcmUoJy4vbGliL21lc3NhZ2VzJykKY29uc3QgU29ja2V0UG9vbCA9IHJlcXVpcmUoJy4vbGliL3NvY2tldC1wb29sJykKY29uc3QgUGVyc2lzdGVudCA9IHJlcXVpcmUoJy4vbGliL3BlcnNpc3RlbnQnKQpjb25zdCBSb3V0ZXIgPSByZXF1aXJlKCcuL2xpYi9yb3V0ZXInKQpjb25zdCBDYWNoZSA9IHJlcXVpcmUoJ3hhY2hlJykKY29uc3QgU2VydmVyID0gcmVxdWlyZSgnLi9saWIvc2VydmVyJykKY29uc3QgY29ubmVjdCA9IHJlcXVpcmUoJy4vbGliL2Nvbm5lY3QnKQpjb25zdCB7IEZJUkVXQUxMLCBCT09UU1RSQVBfTk9ERVMsIEtOT1dOX05PREVTLCBDT01NQU5EUyB9ID0gcmVxdWlyZSgnLi9saWIvY29uc3RhbnRzJykKY29uc3QgeyBoYXNoLCBjcmVhdGVLZXlQYWlyIH0gPSByZXF1aXJlKCcuL2xpYi9jcnlwdG8nKQpjb25zdCB7IGRlY29kZSB9ID0gcmVxdWlyZSgnaHlwZXJjb3JlLWlkLWVuY29kaW5nJykKY29uc3QgUmF3U3RyZWFtU2V0ID0gcmVxdWlyZSgnLi9saWIvcmF3LXN0cmVhbS1zZXQnKQpjb25zdCBDb25uZWN0aW9uUG9vbCA9IHJlcXVpcmUoJy4vbGliL2Nvbm5lY3Rpb24tcG9vbCcpCmNvbnN0IHsgU1RSRUFNX05PVF9DT05ORUNURUQgfSA9IHJlcXVpcmUoJy4vbGliL2Vycm9ycycpCgpjbGFzcyBIeXBlckRIVCBleHRlbmRzIERIVCB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBjb25zdCBwb3J0ID0gb3B0cy5wb3J0IHx8IDQ5NzM3CiAgICBjb25zdCBib290c3RyYXAgPSBvcHRzLmJvb3RzdHJhcCB8fCBCT09UU1RSQVBfTk9ERVMKICAgIGNvbnN0IG5vZGVzID0gb3B0cy5ub2RlcyB8fCBLTk9XTl9OT0RFUwoKICAgIHN1cGVyKHsgLi4ub3B0cywgcG9ydCwgYm9vdHN0cmFwLCBub2RlcywgZmlsdGVyTm9kZSB9KQoKICAgIGNvbnN0IHsgcm91dGVyLCByZWxheUFkZHJlc3NlcywgcGVyc2lzdGVudCB9ID0gZGVmYXVsdENhY2hlT3B0cyhvcHRzKQoKICAgIHRoaXMuZGVmYXVsdEtleVBhaXIgPSBvcHRzLmtleVBhaXIgfHwgY3JlYXRlS2V5UGFpcihvcHRzLnNlZWQpCiAgICB0aGlzLmxpc3RlbmluZyA9IG5ldyBTZXQoKQogICAgdGhpcy5jb25uZWN0aW9uS2VlcEFsaXZlID0KICAgICAgb3B0cy5jb25uZWN0aW9uS2VlcEFsaXZlID09PSBmYWxzZSA/IDAgOiBvcHRzLmNvbm5lY3Rpb25LZWVwQWxpdmUgfHwgNTAwMAoKICAgIC8vIHN0YXRzIGlzIGluaGVyaXRlZCBmcm9tIGRodC1ycGMgc28gZndkIHRoZSBvbmVzIGZyb20gdGhlcmUKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHB1bmNoZXM6IHsgY29uc2lzdGVudDogMCwgcmFuZG9tOiAwLCBvcGVuOiAwIH0sCiAgICAgIHJlbGF5aW5nOiB7IGF0dGVtcHRzOiAwLCBzdWNjZXNzZXM6IDAsIGFib3J0czogMCB9LAogICAgICAuLi50aGlzLnN0YXRzCiAgICB9CiAgICB0aGlzLnJhd1N0cmVhbXMgPSBuZXcgUmF3U3RyZWFtU2V0KHRoaXMpCgogICAgdGhpcy5fcm91dGVyID0gbmV3IFJvdXRlcih0aGlzLCByb3V0ZXIpCiAgICB0aGlzLl9zb2NrZXRQb29sID0gbmV3IFNvY2tldFBvb2wodGhpcywgb3B0cy5ob3N0IHx8ICcwLjAuMC4wJykKICAgIHRoaXMuX3BlcnNpc3RlbnQgPSBudWxsCiAgICB0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3NlcyA9IG5ldyBNYXAoKQogICAgdGhpcy5fcmVsYXlBZGRyZXNzZXNDYWNoZSA9IG5ldyBDYWNoZShyZWxheUFkZHJlc3NlcykKCiAgICB0aGlzLl9kZWZlclJhbmRvbVB1bmNoID0gISFvcHRzLmRlZmVyUmFuZG9tUHVuY2gKICAgIHRoaXMuX2xhc3RSYW5kb21QdW5jaCA9IHRoaXMuX2RlZmVyUmFuZG9tUHVuY2ggPyBEYXRlLm5vdygpIDogMAogICAgdGhpcy5fY29ubmVjdGFibGUgPSB0cnVlCiAgICB0aGlzLl9yYW5kb21QdW5jaEludGVydmFsID0gb3B0cy5yYW5kb21QdW5jaEludGVydmFsIHx8IDIwMDAwIC8vIG1pbiAyMHMgYmV0d2VlbiByYW5kb20gcHVuY2hlcy4uLgogICAgdGhpcy5fcmFuZG9tUHVuY2hlcyA9IDAKICAgIHRoaXMuX3JhbmRvbVB1bmNoTGltaXQgPSAxIC8vIHNldCB0byBvbmUgZm9yIGV4dHJhIHNhZmV0eSBmb3Igbm93CgogICAgdGhpcy5vbmNlKCdwZXJzaXN0ZW50JywgKCkgPT4gewogICAgICB0aGlzLl9wZXJzaXN0ZW50ID0gbmV3IFBlcnNpc3RlbnQodGhpcywgcGVyc2lzdGVudCkKICAgIH0pCgogICAgdGhpcy5vbignbmV0d29yay1jaGFuZ2UnLCAoKSA9PiB7CiAgICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSBzZXJ2ZXIucmVmcmVzaCgpCiAgICB9KQoKICAgIHRoaXMub24oJ25ldHdvcmstdXBkYXRlJywgKCkgPT4gewogICAgICBpZiAoIXRoaXMub25saW5lKSByZXR1cm4KICAgICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgdGhpcy5saXN0ZW5pbmcpIHNlcnZlci5ub3RpZnlPbmxpbmUoKQogICAgfSkKICB9CgogIGNvbm5lY3QocmVtb3RlUHVibGljS2V5LCBvcHRzKSB7CiAgICByZXR1cm4gY29ubmVjdCh0aGlzLCBkZWNvZGUocmVtb3RlUHVibGljS2V5KSwgb3B0cykKICB9CgogIGNyZWF0ZVNlcnZlcihvcHRzLCBvbmNvbm5lY3Rpb24pIHsKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHRoaXMuY3JlYXRlU2VydmVyKHt9LCBvcHRzKQogICAgaWYgKG9wdHMgJiYgb3B0cy5vbmNvbm5lY3Rpb24pIG9uY29ubmVjdGlvbiA9IG9wdHMub25jb25uZWN0aW9uCiAgICBjb25zdCBzID0gbmV3IFNlcnZlcih0aGlzLCBvcHRzKQogICAgaWYgKG9uY29ubmVjdGlvbikgcy5vbignY29ubmVjdGlvbicsIG9uY29ubmVjdGlvbikKICAgIHJldHVybiBzCiAgfQoKICBwb29sKCkgewogICAgcmV0dXJuIG5ldyBDb25uZWN0aW9uUG9vbCh0aGlzKQogIH0KCiAgYXN5bmMgcmVzdW1lKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICh0aGlzLl9kZWZlclJhbmRvbVB1bmNoKSB0aGlzLl9sYXN0UmFuZG9tUHVuY2ggPSBEYXRlLm5vdygpCiAgICBhd2FpdCBzdXBlci5yZXN1bWUoeyBsb2cgfSkKICAgIGNvbnN0IHJlc3VtaW5nID0gW10KICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSByZXN1bWluZy5wdXNoKHNlcnZlci5yZXN1bWUoKSkKICAgIGxvZygnUmVzdW1pbmcgaHlwZXJkaHQgc2VydmVycycpCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocmVzdW1pbmcpCiAgICBsb2coJ0RvbmUsIGh5cGVyZGh0IGZ1bGx5IHJlc3VtZWQnKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICB0aGlzLl9jb25uZWN0YWJsZSA9IGZhbHNlIC8vIGp1c3Qgc28gbm90aGluZyBnZXRzIGNvbm5lY3RlZCBkdXJpbmcgc3VzcGVuc2lvbgogICAgY29uc3Qgc3VzcGVuZGluZyA9IFtdCiAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiB0aGlzLmxpc3RlbmluZykgc3VzcGVuZGluZy5wdXNoKHNlcnZlci5zdXNwZW5kKCkpCiAgICBsb2coJ1N1c3BlbmRpbmcgYWxsIGh5cGVyZGh0IHNlcnZlcnMnKQogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHN1c3BlbmRpbmcpCiAgICBsb2coJ0RvbmUsIGNsZWFyaW5nIGFsbCByYXcgc3RyZWFtcycpCiAgICBhd2FpdCB0aGlzLnJhd1N0cmVhbXMuY2xlYXIoKQogICAgbG9nKCdEb25lLCBzdXNwZW5kaW5nIGRodC1ycGMnKQogICAgYXdhaXQgc3VwZXIuc3VzcGVuZCh7IGxvZyB9KQogICAgbG9nKCdEb25lLCBjbGVhcmluZyByYXcgc3RyZWFtcyBhZ2FpbicpCiAgICBhd2FpdCB0aGlzLnJhd1N0cmVhbXMuY2xlYXIoKQogICAgbG9nKCdEb25lLCBoeXBlcmRodCBmdWxseSBzdXNwZW5kZWQnKQogICAgdGhpcy5fY29ubmVjdGFibGUgPSB0cnVlCiAgfQoKICBhc3luYyBkZXN0cm95KHsgZm9yY2UgPSBmYWxzZSB9ID0ge30pIHsKICAgIGlmICghZm9yY2UpIHsKICAgICAgY29uc3QgY2xvc2luZyA9IFtdCiAgICAgIGZvciAoY29uc3Qgc2VydmVyIG9mIHRoaXMubGlzdGVuaW5nKSBjbG9zaW5nLnB1c2goc2VydmVyLmNsb3NlKCkpCiAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChjbG9zaW5nKQogICAgfQogICAgdGhpcy5fcm91dGVyLmRlc3Ryb3koKQogICAgaWYgKHRoaXMuX3BlcnNpc3RlbnQpIHRoaXMuX3BlcnNpc3RlbnQuZGVzdHJveSgpCiAgICBhd2FpdCB0aGlzLnJhd1N0cmVhbXMuY2xlYXIoKQogICAgYXdhaXQgdGhpcy5fc29ja2V0UG9vbC5kZXN0cm95KCkKICAgIGF3YWl0IHN1cGVyLmRlc3Ryb3koKQogIH0KCiAgYXN5bmMgdmFsaWRhdGVMb2NhbEFkZHJlc3NlcyhhZGRyZXNzZXMpIHsKICAgIGNvbnN0IGxpc3QgPSBbXQogICAgY29uc3Qgc29ja3MgPSBbXQogICAgY29uc3Qgd2FpdGluZyA9IFtdCgogICAgZm9yIChjb25zdCBhZGRyIG9mIGFkZHJlc3NlcykgewogICAgICBjb25zdCB7IGhvc3QgfSA9IGFkZHIKCiAgICAgIGlmICh0aGlzLl92YWxpZGF0ZWRMb2NhbEFkZHJlc3Nlcy5oYXMoaG9zdCkpIHsKICAgICAgICBpZiAoYXdhaXQgdGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuZ2V0KGhvc3QpKSB7CiAgICAgICAgICBsaXN0LnB1c2goYWRkcikKICAgICAgICB9CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgY29uc3Qgc29jayA9IHRoaXMudWR4LmNyZWF0ZVNvY2tldCgpCiAgICAgIHRyeSB7CiAgICAgICAgc29jay5iaW5kKDAsIGhvc3QpCiAgICAgIH0gY2F0Y2ggewogICAgICAgIHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLnNldChob3N0LCBQcm9taXNlLnJlc29sdmUoZmFsc2UpKQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIHNvY2tzLnB1c2goc29jaykKCiAgICAgIC8vIHNlbWkgdGVycmlibGUgaGV1cmlzdGljIHVudGlsIHdlIHByb3BlciBmaXggbG9jYWwgY29ubmVjdGlvbnMgYnkgcmFjaW5nIHRoZW0gdG8gdGhlIHJlbW90ZS4uLgogICAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBzb2NrLm9uKCdtZXNzYWdlJywgKCkgPT4gcmVzb2x2ZSh0cnVlKSkKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlc29sdmUoZmFsc2UpLCA1MDApCiAgICAgICAgc29jay50cnlTZW5kKGI0YS5hbGxvYygxKSwgc29jay5hZGRyZXNzKCkucG9ydCwgYWRkci5ob3N0KQogICAgICB9KQoKICAgICAgdGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuc2V0KGhvc3QsIHByb21pc2UpCiAgICAgIHdhaXRpbmcucHVzaChhZGRyKQogICAgfQoKICAgIGZvciAoY29uc3QgYWRkciBvZiB3YWl0aW5nKSB7CiAgICAgIGNvbnN0IHsgaG9zdCB9ID0gYWRkcgogICAgICBpZiAodGhpcy5fdmFsaWRhdGVkTG9jYWxBZGRyZXNzZXMuaGFzKGhvc3QpKSB7CiAgICAgICAgaWYgKGF3YWl0IHRoaXMuX3ZhbGlkYXRlZExvY2FsQWRkcmVzc2VzLmdldChob3N0KSkgewogICAgICAgICAgbGlzdC5wdXNoKGFkZHIpCiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IHNvY2sgb2Ygc29ja3MpIGF3YWl0IHNvY2suY2xvc2UoKQoKICAgIHJldHVybiBsaXN0CiAgfQoKICBmaW5kUGVlcihwdWJsaWNLZXksIG9wdHMgPSB7fSkgewogICAgY29uc3QgdGFyZ2V0ID0gb3B0cy5oYXNoID09PSBmYWxzZSA/IHB1YmxpY0tleSA6IGhhc2gocHVibGljS2V5KQogICAgb3B0cyA9IHsgLi4ub3B0cywgbWFwOiBtYXBGaW5kUGVlciB9CiAgICByZXR1cm4gdGhpcy5xdWVyeSh7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuRklORF9QRUVSLCB2YWx1ZTogbnVsbCB9LCBvcHRzKQogIH0KCiAgbG9va3VwKHRhcmdldCwgb3B0cyA9IHt9KSB7CiAgICBvcHRzID0geyAuLi5vcHRzLCBtYXA6IG1hcExvb2t1cCB9CiAgICByZXR1cm4gdGhpcy5xdWVyeSh7IHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTE9PS1VQLCB2YWx1ZTogbnVsbCB9LCBvcHRzKQogIH0KCiAgbG9va3VwQW5kVW5hbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIsIG9wdHMgPSB7fSkgewogICAgY29uc3QgdW5hbm5vdW5jZXMgPSBbXQogICAgY29uc3QgZGh0ID0gdGhpcwogICAgY29uc3QgdXNlckNvbW1pdCA9IG9wdHMuY29tbWl0IHx8IG5vb3AKICAgIGNvbnN0IHNpZ25VbmFubm91bmNlID0gb3B0cy5zaWduVW5hbm5vdW5jZSB8fCBQZXJzaXN0ZW50LnNpZ25VbmFubm91bmNlCgogICAgaWYgKHRoaXMuX3BlcnNpc3RlbnQgIT09IG51bGwpIHsKICAgICAgLy8gdW5saW5rIHNlbGYKICAgICAgdGhpcy5fcGVyc2lzdGVudC51bmFubm91bmNlKHRhcmdldCwga2V5UGFpci5wdWJsaWNLZXkpCiAgICB9CgogICAgb3B0cyA9IHsgLi4ub3B0cywgbWFwLCBjb21taXQgfQogICAgcmV0dXJuIHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLkxPT0tVUCwgdmFsdWU6IG51bGwgfSwgb3B0cykKCiAgICBhc3luYyBmdW5jdGlvbiBjb21taXQocmVwbHksIGRodCwgcXVlcnkpIHsKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodW5hbm5vdW5jZXMpIC8vIGNhbiBuZXZlciBmYWlsLCBjYXVnaHQgYmVsb3cKICAgICAgcmV0dXJuIHVzZXJDb21taXQocmVwbHksIGRodCwgcXVlcnkpCiAgICB9CgogICAgZnVuY3Rpb24gbWFwKHJlcGx5KSB7CiAgICAgIGNvbnN0IGRhdGEgPSBtYXBMb29rdXAocmVwbHkpCgogICAgICBpZiAoIWRhdGEgfHwgIWRhdGEudG9rZW4pIHJldHVybiBkYXRhCgogICAgICBsZXQgZm91bmQgPSBkYXRhLnBlZXJzLmxlbmd0aCA+PSAyMAogICAgICBmb3IgKGxldCBpID0gMDsgIWZvdW5kICYmIGkgPCBkYXRhLnBlZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm91bmQgPSBiNGEuZXF1YWxzKGRhdGEucGVlcnNbaV0ucHVibGljS2V5LCBrZXlQYWlyLnB1YmxpY0tleSkKICAgICAgfQoKICAgICAgaWYgKCFmb3VuZCkgcmV0dXJuIGRhdGEKCiAgICAgIGlmICghZGF0YS5mcm9tLmlkKSByZXR1cm4gZGF0YQoKICAgICAgdW5hbm5vdW5jZXMucHVzaCgKICAgICAgICBkaHQKICAgICAgICAgIC5fcmVxdWVzdFVuYW5ub3VuY2Uoa2V5UGFpciwgZGh0LCB0YXJnZXQsIGRhdGEudG9rZW4sIGRhdGEuZnJvbSwgc2lnblVuYW5ub3VuY2UpCiAgICAgICAgICAuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICAgICkKCiAgICAgIHJldHVybiBkYXRhCiAgICB9CiAgfQoKICB1bmFubm91bmNlKHRhcmdldCwga2V5UGFpciwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5sb29rdXBBbmRVbmFubm91bmNlKHRhcmdldCwga2V5UGFpciwgb3B0cykuZmluaXNoZWQoKQogIH0KCiAgYW5ub3VuY2UodGFyZ2V0LCBrZXlQYWlyLCByZWxheUFkZHJlc3Nlcywgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBzaWduQW5ub3VuY2UgPSBvcHRzLnNpZ25Bbm5vdW5jZSB8fCBQZXJzaXN0ZW50LnNpZ25Bbm5vdW5jZQogICAgY29uc3QgYnVtcCA9IG9wdHMuYnVtcCB8fCAwCgogICAgb3B0cyA9IHsgLi4ub3B0cywgY29tbWl0IH0KCiAgICByZXR1cm4gb3B0cy5jbGVhciA/IHRoaXMubG9va3VwQW5kVW5hbm5vdW5jZSh0YXJnZXQsIGtleVBhaXIsIG9wdHMpIDogdGhpcy5sb29rdXAodGFyZ2V0LCBvcHRzKQoKICAgIGZ1bmN0aW9uIGNvbW1pdChyZXBseSwgZGh0KSB7CiAgICAgIHJldHVybiBkaHQuX3JlcXVlc3RBbm5vdW5jZSgKICAgICAgICBrZXlQYWlyLAogICAgICAgIGRodCwKICAgICAgICB0YXJnZXQsCiAgICAgICAgcmVwbHkudG9rZW4sCiAgICAgICAgcmVwbHkuZnJvbSwKICAgICAgICByZWxheUFkZHJlc3NlcywKICAgICAgICBzaWduQW5ub3VuY2UsCiAgICAgICAgYnVtcAogICAgICApCiAgICB9CiAgfQoKICBhc3luYyBpbW11dGFibGVHZXQodGFyZ2V0LCBvcHRzID0ge30pIHsKICAgIG9wdHMgPSB7IC4uLm9wdHMsIG1hcDogbWFwSW1tdXRhYmxlIH0KCiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLklNTVVUQUJMRV9HRVQsIHZhbHVlOiBudWxsIH0sIG9wdHMpCiAgICBjb25zdCBjaGVjayA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgICBmb3IgYXdhaXQgKGNvbnN0IG5vZGUgb2YgcXVlcnkpIHsKICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gbm9kZQogICAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGNoZWNrLCB2YWx1ZSkKICAgICAgaWYgKGI0YS5lcXVhbHMoY2hlY2ssIHRhcmdldCkpIHJldHVybiBub2RlCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGFzeW5jIGltbXV0YWJsZVB1dCh2YWx1ZSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB0YXJnZXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKHRhcmdldCwgdmFsdWUpCgogICAgb3B0cyA9IHsKICAgICAgLi4ub3B0cywKICAgICAgbWFwOiBtYXBJbW11dGFibGUsCiAgICAgIGNvbW1pdChyZXBseSwgZGh0KSB7CiAgICAgICAgcmV0dXJuIGRodC5yZXF1ZXN0KAogICAgICAgICAgeyB0b2tlbjogcmVwbHkudG9rZW4sIHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuSU1NVVRBQkxFX1BVVCwgdmFsdWUgfSwKICAgICAgICAgIHJlcGx5LmZyb20KICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnkoeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLklNTVVUQUJMRV9HRVQsIHZhbHVlOiBudWxsIH0sIG9wdHMpCiAgICBhd2FpdCBxdWVyeS5maW5pc2hlZCgpCgogICAgcmV0dXJuIHsgaGFzaDogdGFyZ2V0LCBjbG9zZXN0Tm9kZXM6IHF1ZXJ5LmNsb3Nlc3ROb2RlcyB9CiAgfQoKICBhc3luYyBtdXRhYmxlR2V0KHB1YmxpY0tleSwgb3B0cyA9IHt9KSB7CiAgICBsZXQgcmVmcmVzaCA9IG9wdHMucmVmcmVzaCB8fCBudWxsCiAgICBsZXQgc2lnbmVkID0gbnVsbAogICAgbGV0IHJlc3VsdCA9IG51bGwKCiAgICBvcHRzID0geyAuLi5vcHRzLCBtYXA6IG1hcE11dGFibGUsIGNvbW1pdDogcmVmcmVzaCA/IGNvbW1pdCA6IG51bGwgfQoKICAgIGNvbnN0IHRhcmdldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2godGFyZ2V0LCBwdWJsaWNLZXkpCgogICAgY29uc3QgdXNlclNlcSA9IG9wdHMuc2VxIHx8IDAKICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyeSgKICAgICAgeyB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLk1VVEFCTEVfR0VULCB2YWx1ZTogYy5lbmNvZGUoYy51aW50LCB1c2VyU2VxKSB9LAogICAgICBvcHRzCiAgICApCiAgICBjb25zdCBsYXRlc3QgPSBvcHRzLmxhdGVzdCAhPT0gZmFsc2UKCiAgICBmb3IgYXdhaXQgKGNvbnN0IG5vZGUgb2YgcXVlcnkpIHsKICAgICAgaWYgKHJlc3VsdCAmJiBub2RlLnNlcSA8PSByZXN1bHQuc2VxKSBjb250aW51ZQogICAgICBpZiAoCiAgICAgICAgbm9kZS5zZXEgPCB1c2VyU2VxIHx8CiAgICAgICAgIVBlcnNpc3RlbnQudmVyaWZ5TXV0YWJsZShub2RlLnNpZ25hdHVyZSwgbm9kZS5zZXEsIG5vZGUudmFsdWUsIHB1YmxpY0tleSkKICAgICAgKQogICAgICAgIGNvbnRpbnVlCiAgICAgIGlmICghbGF0ZXN0KSByZXR1cm4gbm9kZQogICAgICBpZiAoIXJlc3VsdCB8fCBub2RlLnNlcSA+IHJlc3VsdC5zZXEpIHJlc3VsdCA9IG5vZGUKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0CgogICAgZnVuY3Rpb24gY29tbWl0KHJlcGx5LCBkaHQpIHsKICAgICAgaWYgKCFzaWduZWQgJiYgcmVzdWx0ICYmIHJlZnJlc2gpIHsKICAgICAgICBpZiAocmVmcmVzaChyZXN1bHQpKSB7CiAgICAgICAgICBzaWduZWQgPSBjLmVuY29kZShtLm11dGFibGVQdXRSZXF1ZXN0LCB7CiAgICAgICAgICAgIHB1YmxpY0tleSwKICAgICAgICAgICAgc2VxOiByZXN1bHQuc2VxLAogICAgICAgICAgICB2YWx1ZTogcmVzdWx0LnZhbHVlLAogICAgICAgICAgICBzaWduYXR1cmU6IHJlc3VsdC5zaWduYXR1cmUKICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlZnJlc2ggPSBudWxsCiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc2lnbmVkCiAgICAgICAgPyBkaHQucmVxdWVzdCgKICAgICAgICAgICAgeyB0b2tlbjogcmVwbHkudG9rZW4sIHRhcmdldCwgY29tbWFuZDogQ09NTUFORFMuTVVUQUJMRV9QVVQsIHZhbHVlOiBzaWduZWQgfSwKICAgICAgICAgICAgcmVwbHkuZnJvbQogICAgICAgICAgKQogICAgICAgIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpCiAgICB9CiAgfQoKICBhc3luYyBtdXRhYmxlUHV0KGtleVBhaXIsIHZhbHVlLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHNpZ25NdXRhYmxlID0gb3B0cy5zaWduTXV0YWJsZSB8fCBQZXJzaXN0ZW50LnNpZ25NdXRhYmxlCgogICAgY29uc3QgdGFyZ2V0ID0gYjRhLmFsbG9jVW5zYWZlKDMyKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaCh0YXJnZXQsIGtleVBhaXIucHVibGljS2V5KQoKICAgIGNvbnN0IHNlcSA9IG9wdHMuc2VxIHx8IDAKICAgIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IHNpZ25NdXRhYmxlKHNlcSwgdmFsdWUsIGtleVBhaXIpCgogICAgY29uc3Qgc2lnbmVkID0gYy5lbmNvZGUobS5tdXRhYmxlUHV0UmVxdWVzdCwgewogICAgICBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LAogICAgICBzZXEsCiAgICAgIHZhbHVlLAogICAgICBzaWduYXR1cmUKICAgIH0pCgogICAgb3B0cyA9IHsKICAgICAgLi4ub3B0cywKICAgICAgbWFwOiBtYXBNdXRhYmxlLAogICAgICBjb21taXQocmVwbHksIGRodCkgewogICAgICAgIHJldHVybiBkaHQucmVxdWVzdCgKICAgICAgICAgIHsgdG9rZW46IHJlcGx5LnRva2VuLCB0YXJnZXQsIGNvbW1hbmQ6IENPTU1BTkRTLk1VVEFCTEVfUFVULCB2YWx1ZTogc2lnbmVkIH0sCiAgICAgICAgICByZXBseS5mcm9tCiAgICAgICAgKQogICAgICB9CiAgICB9CgogICAgLy8gdXNlIHNlcSA9IDAsIGZvciB0aGUgcXVlcnkgcGFydCBoZXJlLCBhcyB3ZSBkb24ndCBjYXJlIGFib3V0IHRoZSBhY3R1YWwgdmFsdWVzCiAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnkoCiAgICAgIHsgdGFyZ2V0LCBjb21tYW5kOiBDT01NQU5EUy5NVVRBQkxFX0dFVCwgdmFsdWU6IGMuZW5jb2RlKGMudWludCwgMCkgfSwKICAgICAgb3B0cwogICAgKQogICAgYXdhaXQgcXVlcnkuZmluaXNoZWQoKQoKICAgIHJldHVybiB7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksIGNsb3Nlc3ROb2RlczogcXVlcnkuY2xvc2VzdE5vZGVzLCBzZXEsIHNpZ25hdHVyZSB9CiAgfQoKICBvbnJlcXVlc3QocmVxKSB7CiAgICBzd2l0Y2ggKHJlcS5jb21tYW5kKSB7CiAgICAgIGNhc2UgQ09NTUFORFMuUEVFUl9IQU5EU0hBS0U6IHsKICAgICAgICB0aGlzLl9yb3V0ZXIub25wZWVyaGFuZHNoYWtlKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuUEVFUl9IT0xFUFVOQ0g6IHsKICAgICAgICB0aGlzLl9yb3V0ZXIub25wZWVyaG9sZXB1bmNoKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuX3BlcnNpc3RlbnQgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIHN3aXRjaCAocmVxLmNvbW1hbmQpIHsKICAgICAgY2FzZSBDT01NQU5EUy5GSU5EX1BFRVI6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9uZmluZHBlZXIocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5MT09LVVA6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9ubG9va3VwKHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuQU5OT1VOQ0U6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9uYW5ub3VuY2UocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5VTkFOTk9VTkNFOiB7CiAgICAgICAgdGhpcy5fcGVyc2lzdGVudC5vbnVuYW5ub3VuY2UocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgY2FzZSBDT01NQU5EUy5NVVRBQkxFX1BVVDogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25tdXRhYmxlcHV0KHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuTVVUQUJMRV9HRVQ6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9ubXV0YWJsZWdldChyZXEpCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBjYXNlIENPTU1BTkRTLklNTVVUQUJMRV9QVVQ6IHsKICAgICAgICB0aGlzLl9wZXJzaXN0ZW50Lm9uaW1tdXRhYmxlcHV0KHJlcSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIGNhc2UgQ09NTUFORFMuSU1NVVRBQkxFX0dFVDogewogICAgICAgIHRoaXMuX3BlcnNpc3RlbnQub25pbW11dGFibGVnZXQocmVxKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIHN0YXRpYyBrZXlQYWlyKHNlZWQpIHsKICAgIHJldHVybiBjcmVhdGVLZXlQYWlyKHNlZWQpCiAgfQoKICBzdGF0aWMgaGFzaChkYXRhKSB7CiAgICByZXR1cm4gaGFzaChkYXRhKQogIH0KCiAgc3RhdGljIGNvbm5lY3RSYXdTdHJlYW0oZW5jcnlwdGVkU3RyZWFtLCByYXdTdHJlYW0sIHJlbW90ZUlkKSB7CiAgICBjb25zdCBzdHJlYW0gPSBlbmNyeXB0ZWRTdHJlYW0ucmF3U3RyZWFtCgogICAgaWYgKCFzdHJlYW0uY29ubmVjdGVkKSB0aHJvdyBTVFJFQU1fTk9UX0NPTk5FQ1RFRCgpCgogICAgcmF3U3RyZWFtLmNvbm5lY3Qoc3RyZWFtLnNvY2tldCwgcmVtb3RlSWQsIHN0cmVhbS5yZW1vdGVQb3J0LCBzdHJlYW0ucmVtb3RlSG9zdCkKICB9CgogIGNyZWF0ZVJhd1N0cmVhbShvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5yYXdTdHJlYW1zLmFkZChvcHRzKQogIH0KCiAgYXN5bmMgX3JlcXVlc3RBbm5vdW5jZShrZXlQYWlyLCBkaHQsIHRhcmdldCwgdG9rZW4sIGZyb20sIHJlbGF5QWRkcmVzc2VzLCBzaWduLCBidW1wKSB7CiAgICBjb25zdCBhbm4gPSB7CiAgICAgIHBlZXI6IHsKICAgICAgICBwdWJsaWNLZXk6IGtleVBhaXIucHVibGljS2V5LAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiByZWxheUFkZHJlc3NlcyB8fCBbXQogICAgICB9LAogICAgICByZWZyZXNoOiBudWxsLAogICAgICBzaWduYXR1cmU6IG51bGwsCiAgICAgIGJ1bXAKICAgIH0KCiAgICBhbm4uc2lnbmF0dXJlID0gYXdhaXQgc2lnbih0YXJnZXQsIHRva2VuLCBmcm9tLmlkLCBhbm4sIGtleVBhaXIpCgogICAgY29uc3QgdmFsdWUgPSBjLmVuY29kZShtLmFubm91bmNlLCBhbm4pCgogICAgcmV0dXJuIGRodC5yZXF1ZXN0KAogICAgICB7CiAgICAgICAgdG9rZW4sCiAgICAgICAgdGFyZ2V0LAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLkFOTk9VTkNFLAogICAgICAgIHZhbHVlCiAgICAgIH0sCiAgICAgIGZyb20KICAgICkKICB9CgogIGFzeW5jIF9yZXF1ZXN0VW5hbm5vdW5jZShrZXlQYWlyLCBkaHQsIHRhcmdldCwgdG9rZW4sIGZyb20sIHNpZ24pIHsKICAgIGNvbnN0IHVuYW5uID0gewogICAgICBwZWVyOiB7CiAgICAgICAgcHVibGljS2V5OiBrZXlQYWlyLnB1YmxpY0tleSwKICAgICAgICByZWxheUFkZHJlc3NlczogW10KICAgICAgfSwKICAgICAgc2lnbmF0dXJlOiBudWxsCiAgICB9CgogICAgdW5hbm4uc2lnbmF0dXJlID0gYXdhaXQgc2lnbih0YXJnZXQsIHRva2VuLCBmcm9tLmlkLCB1bmFubiwga2V5UGFpcikKCiAgICBjb25zdCB2YWx1ZSA9IGMuZW5jb2RlKG0uYW5ub3VuY2UsIHVuYW5uKQoKICAgIHJldHVybiBkaHQucmVxdWVzdCgKICAgICAgewogICAgICAgIHRva2VuLAogICAgICAgIHRhcmdldCwKICAgICAgICBjb21tYW5kOiBDT01NQU5EUy5VTkFOTk9VTkNFLAogICAgICAgIHZhbHVlCiAgICAgIH0sCiAgICAgIGZyb20KICAgICkKICB9Cn0KCkh5cGVyREhULkJPT1RTVFJBUCA9IEJPT1RTVFJBUF9OT0RFUwpIeXBlckRIVC5GSVJFV0FMTCA9IEZJUkVXQUxMCgptb2R1bGUuZXhwb3J0cyA9IEh5cGVyREhUCgpmdW5jdGlvbiBtYXBMb29rdXAobm9kZSkgewogIGlmICghbm9kZS52YWx1ZSkgcmV0dXJuIG51bGwKCiAgY29uc3QgbCA9IGMuZGVjb2RlKG0ubG9va3VwUmF3UmVwbHksIG5vZGUudmFsdWUpCgogIHRyeSB7CiAgICByZXR1cm4gewogICAgICB0b2tlbjogbm9kZS50b2tlbiwKICAgICAgZnJvbTogbm9kZS5mcm9tLAogICAgICB0bzogbm9kZS50bywKICAgICAgcGVlcnM6IGwucGVlcnMsCiAgICAgIGJ1bXA6IGwuYnVtcAogICAgfQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIG1hcEZpbmRQZWVyKG5vZGUpIHsKICBpZiAoIW5vZGUudmFsdWUpIHJldHVybiBudWxsCgogIHRyeSB7CiAgICByZXR1cm4gewogICAgICB0b2tlbjogbm9kZS50b2tlbiwKICAgICAgZnJvbTogbm9kZS5mcm9tLAogICAgICB0bzogbm9kZS50bywKICAgICAgcGVlcjogYy5kZWNvZGUobS5wZWVyLCBub2RlLnZhbHVlKQogICAgfQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIG1hcEltbXV0YWJsZShub2RlKSB7CiAgaWYgKCFub2RlLnZhbHVlKSByZXR1cm4gbnVsbAoKICByZXR1cm4gewogICAgdG9rZW46IG5vZGUudG9rZW4sCiAgICBmcm9tOiBub2RlLmZyb20sCiAgICB0bzogbm9kZS50bywKICAgIHZhbHVlOiBub2RlLnZhbHVlCiAgfQp9CgpmdW5jdGlvbiBtYXBNdXRhYmxlKG5vZGUpIHsKICBpZiAoIW5vZGUudmFsdWUpIHJldHVybiBudWxsCgogIHRyeSB7CiAgICBjb25zdCB7IHNlcSwgdmFsdWUsIHNpZ25hdHVyZSB9ID0gYy5kZWNvZGUobS5tdXRhYmxlR2V0UmVzcG9uc2UsIG5vZGUudmFsdWUpCgogICAgcmV0dXJuIHsKICAgICAgdG9rZW46IG5vZGUudG9rZW4sCiAgICAgIGZyb206IG5vZGUuZnJvbSwKICAgICAgdG86IG5vZGUudG8sCiAgICAgIHNlcSwKICAgICAgdmFsdWUsCiAgICAgIHNpZ25hdHVyZQogICAgfQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQoKZnVuY3Rpb24gZmlsdGVyTm9kZShub2RlKSB7CiAgLy8gYWx3YXlzIHNraXAgdGhlc2UgdGVzdG5ldCBub2RlcyB0aGF0IGdvdCBtaXhlZCBpbiBieSBhY2NpZGVudCwgdW50aWwgdGhleSBnZXQgdXBkYXRlZAogIHJldHVybiAoCiAgICAhKG5vZGUucG9ydCA9PT0gNDk3MzggJiYgKG5vZGUuaG9zdCA9PT0gJzEzNC4yMDkuMjguOTgnIHx8IG5vZGUuaG9zdCA9PT0gJzE2Ny45OS4xNDIuMTg1JykpICYmCiAgICAhKG5vZGUucG9ydCA9PT0gOTQwMCAmJiBub2RlLmhvc3QgPT09ICczNS4yMzMuNDcuMjUyJykgJiYKICAgICEobm9kZS5ob3N0ID09PSAnMTUwLjEzNi4xNDIuMTE2JykKICApCn0KCmNvbnN0IGRlZmF1bHRNYXhTaXplID0gNjU1MzYKY29uc3QgZGVmYXVsdE1heEFnZSA9IDIwICogNjAgKiAxMDAwIC8vIDIwIG1pbnV0ZXMKCmZ1bmN0aW9uIGRlZmF1bHRDYWNoZU9wdHMob3B0cykgewogIGNvbnN0IG1heFNpemUgPSBvcHRzLm1heFNpemUgfHwgZGVmYXVsdE1heFNpemUKICBjb25zdCBtYXhBZ2UgPSBvcHRzLm1heEFnZSB8fCBkZWZhdWx0TWF4QWdlCgogIHJldHVybiB7CiAgICByb3V0ZXI6IHsKICAgICAgZm9yd2FyZHM6IHsgbWF4U2l6ZSwgbWF4QWdlIH0KICAgIH0sCiAgICByZWxheUFkZHJlc3NlczogeyBtYXhTaXplOiBNYXRoLm1pbihtYXhTaXplLCA1MTIpLCBtYXhBZ2U6IDAgfSwKICAgIHBlcnNpc3RlbnQ6IHsKICAgICAgcmVjb3JkczogeyBtYXhTaXplLCBtYXhBZ2UgfSwKICAgICAgcmVmcmVzaGVzOiB7IG1heFNpemUsIG1heEFnZSB9LAogICAgICBtdXRhYmxlczogewogICAgICAgIG1heFNpemU6IChtYXhTaXplIC8gMikgfCAwLAogICAgICAgIG1heEFnZTogb3B0cy5tYXhBZ2UgfHwgNDggKiA2MCAqIDYwICogMTAwMCAvLyA0OCBob3VycwogICAgICB9LAogICAgICBpbW11dGFibGVzOiB7CiAgICAgICAgbWF4U2l6ZTogKG1heFNpemUgLyAyKSB8IDAsCiAgICAgICAgbWF4QWdlOiBvcHRzLm1heEFnZSB8fCA0OCAqIDYwICogNjAgKiAxMDAwIC8vIDQ4IGhvdXJzCiAgICAgIH0sCiAgICAgIGJ1bXBzOiB7IG1heFNpemUsIG1heEFnZSB9CiAgICB9CiAgfQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBTaWduYWwgPSByZXF1aXJlKCdzaWduYWwtcHJvbWlzZScpCmNvbnN0IHsgZW5jb2RlVW5zbGFiIH0gPSByZXF1aXJlKCcuL2VuY29kZScpCmNvbnN0IFNsZWVwZXIgPSByZXF1aXJlKCcuL3NsZWVwZXInKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IFBlcnNpc3RlbnQgPSByZXF1aXJlKCcuL3BlcnNpc3RlbnQnKQpjb25zdCB7IENPTU1BTkRTIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCBNSU5fQUNUSVZFID0gMwoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBBbm5vdW5jZXIgewogIGNvbnN0cnVjdG9yKGRodCwga2V5UGFpciwgdGFyZ2V0LCBvcHRzID0ge30pIHsKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLmtleVBhaXIgPSBrZXlQYWlyCiAgICB0aGlzLnRhcmdldCA9IHRhcmdldAogICAgdGhpcy5yZWxheXMgPSBbXQogICAgdGhpcy5yZWxheUFkZHJlc3NlcyA9IFtdCiAgICB0aGlzLnN0b3BwZWQgPSBmYWxzZQogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5yZWNvcmQgPSBlbmNvZGVVbnNsYWIobS5wZWVyLCB7IHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksIHJlbGF5QWRkcmVzc2VzOiBbXSB9KQogICAgdGhpcy5vbmxpbmUgPSBuZXcgU2lnbmFsKCkKCiAgICB0aGlzLl9yZWZyZXNoaW5nID0gZmFsc2UKICAgIHRoaXMuX2Nsb3Nlc3ROb2RlcyA9IG51bGwKICAgIHRoaXMuX2FjdGl2ZSA9IG51bGwKICAgIHRoaXMuX3NsZWVwZXIgPSBuZXcgU2xlZXBlcigpCiAgICB0aGlzLl9yZXN1bWVkID0gbmV3IFNpZ25hbCgpCiAgICB0aGlzLl9zaWduQW5ub3VuY2UgPSBvcHRzLnNpZ25Bbm5vdW5jZSB8fCBQZXJzaXN0ZW50LnNpZ25Bbm5vdW5jZQogICAgdGhpcy5fc2lnblVuYW5ub3VuY2UgPSBvcHRzLnNpZ25VbmFubm91bmNlIHx8IFBlcnNpc3RlbnQuc2lnblVuYW5ub3VuY2UKICAgIHRoaXMuX3VwZGF0aW5nID0gbnVsbAogICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCiAgICB0aGlzLl91bmFubm91bmNpbmcgPSBudWxsCgogICAgdGhpcy5fc2VydmVyUmVsYXlzID0gW25ldyBNYXAoKSwgbmV3IE1hcCgpLCBuZXcgTWFwKCldCiAgfQoKICBpc1JlbGF5KGFkZHIpIHsKICAgIGNvbnN0IGlkID0gYWRkci5ob3N0ICsgJzonICsgYWRkci5wb3J0CiAgICBjb25zdCBbYSwgYiwgY10gPSB0aGlzLl9zZXJ2ZXJSZWxheXMKICAgIHJldHVybiBhLmhhcyhpZCkgfHwgYi5oYXMoaWQpIHx8IGMuaGFzKGlkKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCgogICAgbG9nKCdTdXNwZW5kaW5nIGFubm91bmNlcicpCgogICAgLy8gU3VzcGVuZCBoYXMgaXRzIG93biBzbGVlcCBsb2dpYwogICAgLy8gc28gd2UgZG9uJ3Qgd2FudCB0byBoYW5nIG9uIHRoaXMgb25lCiAgICB0aGlzLm9ubGluZS5ub3RpZnkoKQoKICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSkgdGhpcy5fYWN0aXZlUXVlcnkuZGVzdHJveSgpCgogICAgdGhpcy5fc2xlZXBlci5yZXN1bWUoKQogICAgaWYgKHRoaXMuX3VwZGF0aW5nKSBhd2FpdCB0aGlzLl91cGRhdGluZwogICAgbG9nKCdTdXNwZW5kaW5nIGFubm91bmNlciAocG9zdCB1cGRhdGUpJykKCiAgICBpZiAodGhpcy5zdXNwZW5kZWQgPT09IGZhbHNlIHx8IHRoaXMuc3RvcHBlZCkgcmV0dXJuCgogICAgbG9nKCdTdXNwZW5kaW5nIGFubm91bmNlciAocHJlIHVuYW5ub3VuY2UpJykKICAgIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2VDdXJyZW50KCkKICAgIGxvZygnU3VzcGVuZGluZyBhbm5vdW5jZXIgKHBvc3QgdW5hbm5vdW5jZSknKQogIH0KCiAgcmVzdW1lKCkgewogICAgaWYgKCF0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCgogICAgdGhpcy5yZWZyZXNoKCkKICAgIHRoaXMuX3NsZWVwZXIucmVzdW1lKCkKICAgIHRoaXMuX3Jlc3VtZWQubm90aWZ5KCkKICB9CgogIHJlZnJlc2goKSB7CiAgICBpZiAodGhpcy5zdG9wcGVkKSByZXR1cm4KICAgIHRoaXMuX3JlZnJlc2hpbmcgPSB0cnVlCiAgfQoKICBhc3luYyBzdGFydCgpIHsKICAgIGlmICh0aGlzLnN0b3BwZWQpIHJldHVybgogICAgdGhpcy5fYWN0aXZlID0gdGhpcy5fcnVuVXBkYXRlKCkKICAgIGF3YWl0IHRoaXMuX2FjdGl2ZQogICAgaWYgKHRoaXMuc3RvcHBlZCkgcmV0dXJuCiAgICB0aGlzLl9hY3RpdmUgPSB0aGlzLl9iYWNrZ3JvdW5kKCkKICB9CgogIGFzeW5jIHN0b3AoKSB7CiAgICB0aGlzLnN0b3BwZWQgPSB0cnVlCiAgICB0aGlzLm9ubGluZS5ub3RpZnkoKSAvLyBCcmVhayBvdXQgb2YgdGhlIF9iYWNrZ3JvdW5kIGxvb3AgaWYgd2UncmUgb2ZmbGluZQogICAgdGhpcy5fc2xlZXBlci5yZXN1bWUoKQogICAgdGhpcy5fcmVzdW1lZC5ub3RpZnkoKQogICAgYXdhaXQgdGhpcy5fYWN0aXZlCiAgICBhd2FpdCB0aGlzLl91bmFubm91bmNlQ3VycmVudCgpCiAgfQoKICBhc3luYyBfdW5hbm5vdW5jZUN1cnJlbnQoKSB7CiAgICB3aGlsZSAodGhpcy5fdW5hbm5vdW5jaW5nICE9PSBudWxsKSBhd2FpdCB0aGlzLl91bmFubm91bmNpbmcKICAgIGNvbnN0IHVuID0gKHRoaXMuX3VuYW5ub3VuY2luZyA9IHRoaXMuX3VuYW5ub3VuY2VBbGwodGhpcy5fc2VydmVyUmVsYXlzWzJdLnZhbHVlcygpKSkKICAgIGF3YWl0IHRoaXMuX3VuYW5ub3VuY2luZwogICAgaWYgKHVuID09PSB0aGlzLl91bmFubm91bmNpbmcpIHRoaXMuX3VuYW5ub3VuY2luZyA9IG51bGwKICB9CgogIGFzeW5jIF9iYWNrZ3JvdW5kKCkgewogICAgd2hpbGUgKCF0aGlzLmRodC5kZXN0cm95ZWQgJiYgIXRoaXMuc3RvcHBlZCkgewogICAgICB0cnkgewogICAgICAgIHRoaXMuX3JlZnJlc2hpbmcgPSBmYWxzZQoKICAgICAgICAvLyB+NW1pbiArLQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTAwICYmICF0aGlzLnN0b3BwZWQgJiYgIXRoaXMuX3JlZnJlc2hpbmcgJiYgIXRoaXMuc3VzcGVuZGVkOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHBpbmdzID0gW10KCiAgICAgICAgICBmb3IgKGNvbnN0IG5vZGUgb2YgdGhpcy5fc2VydmVyUmVsYXlzWzJdLnZhbHVlcygpKSB7CiAgICAgICAgICAgIHBpbmdzLnB1c2godGhpcy5kaHQucGluZyhub2RlKSkKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCBhY3RpdmUgPSBhd2FpdCByZXNvbHZlZChwaW5ncykKICAgICAgICAgIGlmIChhY3RpdmUgPCBNYXRoLm1pbihwaW5ncy5sZW5ndGgsIE1JTl9BQ1RJVkUpKSB7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpIC8vIHdlIGxvc3QgdG9vIG1hbnkgcmVsYXkgbm9kZXMsIHJldHJ5IGFsbAogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0aGlzLnN0b3BwZWQpIHJldHVybgoKICAgICAgICAgIGlmICghdGhpcy5zdXNwZW5kZWQgJiYgIXRoaXMuX3JlZnJlc2hpbmcpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMzAwMCkKICAgICAgICB9CgogICAgICAgIHdoaWxlICghdGhpcy5zdG9wcGVkICYmIHRoaXMuc3VzcGVuZGVkKSBhd2FpdCB0aGlzLl9yZXN1bWVkLndhaXQoKQoKICAgICAgICBpZiAoIXRoaXMuc3RvcHBlZCkgYXdhaXQgdGhpcy5fcnVuVXBkYXRlKCkKCiAgICAgICAgd2hpbGUgKCF0aGlzLmRodC5vbmxpbmUgJiYgIXRoaXMuc3RvcHBlZCAmJiAhdGhpcy5zdXNwZW5kZWQpIHsKICAgICAgICAgIC8vIEJlaW5nIG9mZmxpbmUgY2FuIG1ha2UgX2JhY2tncm91bmQgcmVwZWF0IHZlcnkgcXVpY2tseQogICAgICAgICAgLy8gU28gd2FpdCB1bnRpbCB3ZSdyZSBiYWNrIG9ubGluZQogICAgICAgICAgYXdhaXQgdGhpcy5vbmxpbmUud2FpdCgpCiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIF9ydW5VcGRhdGUoKSB7CiAgICB0aGlzLl91cGRhdGluZyA9IHRoaXMuX3VwZGF0ZSgpCiAgICBhd2FpdCB0aGlzLl91cGRhdGluZwogICAgdGhpcy5fdXBkYXRpbmcgPSBudWxsCiAgfQoKICBhc3luYyBfdXBkYXRlKCkgewogICAgd2hpbGUgKHRoaXMuX3VuYW5ub3VuY2luZykgYXdhaXQgdGhpcy5fdW5hbm5vdW5jaW5nCgogICAgdGhpcy5fY3ljbGUoKQoKICAgIGNvbnN0IHEgPSAodGhpcy5fYWN0aXZlUXVlcnkgPSB0aGlzLmRodC5maW5kUGVlcih0aGlzLnRhcmdldCwgewogICAgICBoYXNoOiBmYWxzZSwKICAgICAgbm9kZXM6IHRoaXMuX2Nsb3Nlc3ROb2RlcwogICAgfSkpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgcS5maW5pc2hlZCgpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlIGZhaWx1cmVzLi4uCiAgICB9CgogICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCgogICAgaWYgKHRoaXMuc3RvcHBlZCB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgY29uc3QgYW5uID0gW10KICAgIGNvbnN0IHJlcGxpZXMgPSBwaWNrQmVzdChxLmNsb3Nlc3RSZXBsaWVzKQoKICAgIGNvbnN0IHJlbGF5cyA9IFtdCiAgICBjb25zdCByZWxheUFkZHJlc3NlcyA9IFtdCgogICAgaWYgKCF0aGlzLmRodC5maXJld2FsbGVkKSB7CiAgICAgIGNvbnN0IGFkZHIgPSB0aGlzLmRodC5yZW1vdGVBZGRyZXNzKCkKICAgICAgaWYgKGFkZHIpIHJlbGF5QWRkcmVzc2VzLnB1c2goYWRkcikKICAgIH0KCiAgICBmb3IgKGNvbnN0IG1zZyBvZiByZXBsaWVzKSB7CiAgICAgIGFubi5wdXNoKHRoaXMuX2NvbW1pdChtc2csIHJlbGF5cywgcmVsYXlBZGRyZXNzZXMpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChhbm4pCiAgICBpZiAodGhpcy5zdG9wcGVkIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4KCiAgICB0aGlzLl9jbG9zZXN0Tm9kZXMgPSBxLmNsb3Nlc3ROb2RlcwogICAgdGhpcy5yZWxheXMgPSByZWxheXMKICAgIHRoaXMucmVsYXlBZGRyZXNzZXMgPSByZWxheUFkZHJlc3NlcwoKICAgIGNvbnN0IHJlbW92ZWQgPSBbXQogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5fc2VydmVyUmVsYXlzWzFdKSB7CiAgICAgIGlmICghdGhpcy5fc2VydmVyUmVsYXlzWzJdLmhhcyhrZXkpKSByZW1vdmVkLnB1c2godmFsdWUpCiAgICB9CgogICAgYXdhaXQgdGhpcy5fdW5hbm5vdW5jZUFsbChyZW1vdmVkKQogIH0KCiAgX3VuYW5ub3VuY2VBbGwocmVsYXlzKSB7CiAgICBjb25zdCB1bmFubiA9IFtdCiAgICBmb3IgKGNvbnN0IHIgb2YgcmVsYXlzKSB1bmFubi5wdXNoKHRoaXMuX3VuYW5ub3VuY2UocikpCiAgICByZXR1cm4gUHJvbWlzZS5hbGxTZXR0bGVkKHVuYW5uKQogIH0KCiAgYXN5bmMgX3VuYW5ub3VuY2UodG8pIHsKICAgIGNvbnN0IHVuYW5uID0gewogICAgICBwZWVyOiB7CiAgICAgICAgcHVibGljS2V5OiB0aGlzLmtleVBhaXIucHVibGljS2V5LAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiBbXQogICAgICB9LAogICAgICByZWZyZXNoOiBudWxsLAogICAgICBzaWduYXR1cmU6IG51bGwKICAgIH0KCiAgICBjb25zdCB7IGZyb20sIHRva2VuLCB2YWx1ZSB9ID0gYXdhaXQgdGhpcy5kaHQucmVxdWVzdCgKICAgICAgewogICAgICAgIHRva2VuOiBudWxsLAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLkZJTkRfUEVFUiwKICAgICAgICB0YXJnZXQ6IHRoaXMudGFyZ2V0LAogICAgICAgIHZhbHVlOiBudWxsCiAgICAgIH0sCiAgICAgIHRvCiAgICApCgogICAgaWYgKCF0b2tlbiB8fCAhZnJvbS5pZCB8fCAhdmFsdWUpIHJldHVybgoKICAgIHVuYW5uLnNpZ25hdHVyZSA9IGF3YWl0IHRoaXMuX3NpZ25VbmFubm91bmNlKHRoaXMudGFyZ2V0LCB0b2tlbiwgZnJvbS5pZCwgdW5hbm4sIHRoaXMua2V5UGFpcikKCiAgICBhd2FpdCB0aGlzLmRodC5yZXF1ZXN0KAogICAgICB7CiAgICAgICAgdG9rZW4sCiAgICAgICAgY29tbWFuZDogQ09NTUFORFMuVU5BTk5PVU5DRSwKICAgICAgICB0YXJnZXQ6IHRoaXMudGFyZ2V0LAogICAgICAgIHZhbHVlOiBjLmVuY29kZShtLmFubm91bmNlLCB1bmFubikKICAgICAgfSwKICAgICAgdG8KICAgICkKICB9CgogIGFzeW5jIF9jb21taXQobXNnLCByZWxheXMsIHJlbGF5QWRkcmVzc2VzKSB7CiAgICBjb25zdCBhbm4gPSB7CiAgICAgIHBlZXI6IHsKICAgICAgICBwdWJsaWNLZXk6IHRoaXMua2V5UGFpci5wdWJsaWNLZXksCiAgICAgICAgcmVsYXlBZGRyZXNzZXM6IFtdCiAgICAgIH0sCiAgICAgIHJlZnJlc2g6IG51bGwsCiAgICAgIHNpZ25hdHVyZTogbnVsbAogICAgfQoKICAgIGFubi5zaWduYXR1cmUgPSBhd2FpdCB0aGlzLl9zaWduQW5ub3VuY2UodGhpcy50YXJnZXQsIG1zZy50b2tlbiwgbXNnLmZyb20uaWQsIGFubiwgdGhpcy5rZXlQYWlyKQoKICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZGh0LnJlcXVlc3QoCiAgICAgIHsKICAgICAgICB0b2tlbjogbXNnLnRva2VuLAogICAgICAgIGNvbW1hbmQ6IENPTU1BTkRTLkFOTk9VTkNFLAogICAgICAgIHRhcmdldDogdGhpcy50YXJnZXQsCiAgICAgICAgdmFsdWU6IGMuZW5jb2RlKG0uYW5ub3VuY2UsIGFubikKICAgICAgfSwKICAgICAgbXNnLmZyb20KICAgICkKCiAgICBpZiAocmVzLmVycm9yICE9PSAwKSByZXR1cm4KCiAgICBpZiAocmVsYXlBZGRyZXNzZXMubGVuZ3RoIDwgMykgcmVsYXlBZGRyZXNzZXMucHVzaCh7IGhvc3Q6IG1zZy5mcm9tLmhvc3QsIHBvcnQ6IG1zZy5mcm9tLnBvcnQgfSkKICAgIHJlbGF5cy5wdXNoKHsgcmVsYXlBZGRyZXNzOiBtc2cuZnJvbSwgcGVlckFkZHJlc3M6IG1zZy50byB9KQoKICAgIHRoaXMuX3NlcnZlclJlbGF5c1syXS5zZXQobXNnLmZyb20uaG9zdCArICc6JyArIG1zZy5mcm9tLnBvcnQsIG1zZy5mcm9tKQogIH0KCiAgX2N5Y2xlKCkgewogICAgY29uc3QgdG1wID0gdGhpcy5fc2VydmVyUmVsYXlzWzBdCiAgICB0aGlzLl9zZXJ2ZXJSZWxheXNbMF0gPSB0aGlzLl9zZXJ2ZXJSZWxheXNbMV0KICAgIHRoaXMuX3NlcnZlclJlbGF5c1sxXSA9IHRoaXMuX3NlcnZlclJlbGF5c1syXQogICAgdGhpcy5fc2VydmVyUmVsYXlzWzJdID0gdG1wCiAgICB0bXAuY2xlYXIoKQogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZWQocHMpIHsKICBsZXQgcmVwbGllZCA9IDAKICBsZXQgdGlja3MgPSBwcy5sZW5ndGggKyAxCgogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgZm9yIChjb25zdCBwIG9mIHBzKSBwLnRoZW4ocHVzaCwgdGljaykKICAgIHRpY2soKQoKICAgIGZ1bmN0aW9uIHB1c2godikgewogICAgICByZXBsaWVkKysKICAgICAgdGljaygpCiAgICB9CgogICAgZnVuY3Rpb24gdGljaygpIHsKICAgICAgaWYgKC0tdGlja3MgPT09IDApIHJlc29sdmUocmVwbGllZCkKICAgIH0KICB9KQp9CgpmdW5jdGlvbiBwaWNrQmVzdChyZXBsaWVzKSB7CiAgLy8gVE9ETzogcGljayB0aGUgb25lcyBjbG9zZXN0IHRvIHVzIFJUVCB3aXNlCiAgcmV0dXJuIHJlcGxpZXMuc2xpY2UoMCwgMykKfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IE5vaXNlU2VjcmV0U3RyZWFtID0gcmVxdWlyZSgnQGh5cGVyc3dhcm0vc2VjcmV0LXN0cmVhbScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHJlbGF5ID0gcmVxdWlyZSgnYmxpbmQtcmVsYXknKQpjb25zdCB7IGlzUHJpdmF0ZSwgaXNCb2dvbiB9ID0gcmVxdWlyZSgnYm9nb24nKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCmNvbnN0IFNlbWFwaG9yZSA9IHJlcXVpcmUoJy4vc2VtYXBob3JlJykKY29uc3QgTm9pc2VXcmFwID0gcmVxdWlyZSgnLi9ub2lzZS13cmFwJykKY29uc3QgU2VjdXJlUGF5bG9hZCA9IHJlcXVpcmUoJy4vc2VjdXJlLXBheWxvYWQnKQpjb25zdCBIb2xlcHVuY2hlciA9IHJlcXVpcmUoJy4vaG9sZXB1bmNoZXInKQpjb25zdCBTbGVlcGVyID0gcmVxdWlyZSgnLi9zbGVlcGVyJykKY29uc3QgeyBGSVJFV0FMTCwgRVJST1IgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyB1bnNsYWJiZWRIYXNoIH0gPSByZXF1aXJlKCcuL2NyeXB0bycpCmNvbnN0IHsKICBDQU5OT1RfSE9MRVBVTkNILAogIEhBTkRTSEFLRV9JTlZBTElELAogIEhPTEVQVU5DSF9BQk9SVEVELAogIEhPTEVQVU5DSF9JTlZBTElELAogIEhPTEVQVU5DSF9QUk9CRV9USU1FT1VULAogIEhPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTLAogIFBFRVJfQ09OTkVDVElPTl9GQUlMRUQsCiAgUEVFUl9OT1RfRk9VTkQsCiAgUkVNT1RFX0FCT1JURUQsCiAgUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFLAogIFJFTU9URV9OT1RfSE9MRVBVTkNISU5HLAogIFNFUlZFUl9FUlJPUiwKICBTRVJWRVJfSU5DT01QQVRJQkxFLAogIFJFTEFZX0FCT1JURUQsCiAgU1VTUEVOREVECn0gPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGNvbm5lY3QoZGh0LCBwdWJsaWNLZXksIG9wdHMgPSB7fSkgewogIGNvbnN0IHBvb2wgPSBvcHRzLnBvb2wgfHwgbnVsbAoKICBpZiAocG9vbCAmJiBwb29sLmhhcyhwdWJsaWNLZXkpKSByZXR1cm4gcG9vbC5nZXQocHVibGljS2V5KQoKICBwdWJsaWNLZXkgPSB1bnNsYWIocHVibGljS2V5KQoKICBjb25zdCBrZXlQYWlyID0gb3B0cy5rZXlQYWlyIHx8IGRodC5kZWZhdWx0S2V5UGFpcgogIGNvbnN0IHJlbGF5VGhyb3VnaCA9IHNlbGVjdFJlbGF5KG9wdHMucmVsYXlUaHJvdWdoIHx8IG51bGwpCiAgY29uc3QgZW5jcnlwdGVkU29ja2V0ID0gKG9wdHMuY3JlYXRlU2VjcmV0U3RyZWFtIHx8IGRlZmF1bHRDcmVhdGVTZWNyZXRTdHJlYW0pKHRydWUsIG51bGwsIHsKICAgIHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksCiAgICByZW1vdGVQdWJsaWNLZXk6IHB1YmxpY0tleSwKICAgIGF1dG9TdGFydDogZmFsc2UsCiAgICBrZWVwQWxpdmU6IGRodC5jb25uZWN0aW9uS2VlcEFsaXZlCiAgfSkKCiAgLy8gaW4gY2FzZSBhIHNvY2tldCBpcyBtYWRlIGR1cmluZyBzdXNwZW5kZWQgc3RhdGUsIGRlc3Ryb3kgaXQgaW1tZWRpYXRlbHkKICBpZiAoZGh0LnN1c3BlbmRlZCB8fCAhZGh0Ll9jb25uZWN0YWJsZSkgewogICAgZW5jcnlwdGVkU29ja2V0LmRlc3Ryb3koU1VTUEVOREVEKCkpCiAgICByZXR1cm4gZW5jcnlwdGVkU29ja2V0CiAgfQoKICBpZiAocG9vbCkgcG9vbC5fYXR0YWNoU3RyZWFtKGVuY3J5cHRlZFNvY2tldCwgZmFsc2UpCgogIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgY29uc3QgYyA9IHsKICAgIGlkLAogICAgZGh0LAogICAgc2Vzc2lvbjogZGh0LnNlc3Npb24oKSwKICAgIHJlbGF5QWRkcmVzc2VzOiBvcHRzLnJlbGF5QWRkcmVzc2VzIHx8IFtdLAogICAgcmVtb3RlUmVsYXlBZGRyZXNzZXM6IFtdLAogICAgcG9vbCwKICAgIHJvdW5kOiAwLAogICAgdGFyZ2V0OiB1bnNsYWJiZWRIYXNoKHB1YmxpY0tleSksCiAgICByZW1vdGVQdWJsaWNLZXk6IHB1YmxpY0tleSwKICAgIHJldXNhYmxlU29ja2V0OiAhIW9wdHMucmV1c2FibGVTb2NrZXQsCiAgICBoYW5kc2hha2U6IChvcHRzLmNyZWF0ZUhhbmRzaGFrZSB8fCBkZWZhdWx0Q3JlYXRlSGFuZHNoYWtlKShrZXlQYWlyLCBwdWJsaWNLZXkpLAogICAgcmVxdWVzdDogbnVsbCwKICAgIHJlcXVlc3Rpbmc6IGZhbHNlLAogICAgbGFuOiBvcHRzLmxvY2FsQ29ubmVjdGlvbiAhPT0gZmFsc2UsCiAgICBmaXJld2FsbDogRklSRVdBTEwuVU5LTk9XTiwKICAgIHJhd1N0cmVhbTogZGh0LmNyZWF0ZVJhd1N0cmVhbSh7IGZyYW1lZDogdHJ1ZSwgZmlyZXdhbGwgfSksCiAgICBjb25uZWN0OiBudWxsLAogICAgcXVlcnk6IG51bGwsCiAgICBwdW5jaGVyOiBudWxsLAogICAgcGF5bG9hZDogbnVsbCwKICAgIHBhc3NpdmVDb25uZWN0VGltZW91dDogbnVsbCwKICAgIHNlcnZlclNvY2tldDogbnVsbCwKICAgIHNlcnZlckFkZHJlc3M6IG51bGwsCiAgICBvbnNvY2tldDogbnVsbCwKICAgIHNsZWVwZXI6IG5ldyBTbGVlcGVyKCksCiAgICBlbmNyeXB0ZWRTb2NrZXQsCgogICAgLy8gUmVsYXkgc3RhdGUKICAgIHJlbGF5VGltZW91dDogbnVsbCwKICAgIHJlbGF5VGhyb3VnaCwKICAgIHJlbGF5VG9rZW46IHJlbGF5VGhyb3VnaCA/IHJlbGF5LnRva2VuKCkgOiBudWxsLAogICAgcmVsYXlTb2NrZXQ6IG51bGwsCiAgICByZWxheUNsaWVudDogbnVsbCwKICAgIHJlbGF5UGFpcmVkOiBmYWxzZSwKICAgIHJlbGF5S2VlcEFsaXZlOiBvcHRzLnJlbGF5S2VlcEFsaXZlIHx8IDUwMDAKICB9CgogIC8vIElmIHRoZSByYXcgc3RyZWFtIHJlY2VpdmVzIGFuIGVycm9yIHNpZ25hbCBwcmUgY29ubmVjdCAoaWUgZnJvbSB0aGUgZmlyZXdhbGwgaG9vayksIG1ha2Ugc3VyZQogIC8vIHRvIGZvcndhcmQgdGhhdCB0byB0aGUgZW5jcnlwdGVkIHNvY2tldCBmb3IgcHJvcGVyIHRlYXJkb3duCiAgYy5yYXdTdHJlYW0ub24oJ2Vycm9yJywgYXV0b0Rlc3Ryb3kpCiAgYy5yYXdTdHJlYW0ub25jZSgnY29ubmVjdCcsICgpID0+IHsKICAgIGMucmF3U3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIGF1dG9EZXN0cm95KQogIH0pCgogIGVuY3J5cHRlZFNvY2tldC5vbignY2xvc2UnLCBmdW5jdGlvbiAoKSB7CiAgICBpZiAoYy5wYXNzaXZlQ29ubmVjdFRpbWVvdXQpIGNsZWFyUGFzc2l2ZUNvbm5lY3RUaW1lb3V0KGMpCiAgICBpZiAoYy5xdWVyeSkgYy5xdWVyeS5kZXN0cm95KCkKICAgIGlmIChjLnB1bmNoZXIpIGMucHVuY2hlci5kZXN0cm95KCkKICAgIGlmIChjLnJhd1N0cmVhbSkgYy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICBjLnNlc3Npb24uZGVzdHJveSgpCiAgICBjLnNsZWVwZXIucmVzdW1lKCkKICB9KQoKICAvLyBTYWZlIHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZCAtIG5ldmVyIHRocm93cwogIGlmIChkaHQuc3VzcGVuZGVkKSBlbmNyeXB0ZWRTb2NrZXQuZGVzdHJveShTVVNQRU5ERUQoKSkKICBlbHNlIGNvbm5lY3RBbmRIb2xlcHVuY2goYywgb3B0cykKCiAgcmV0dXJuIGVuY3J5cHRlZFNvY2tldAoKICBmdW5jdGlvbiBhdXRvRGVzdHJveShlcnIpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIpCiAgfQoKICBmdW5jdGlvbiBmaXJld2FsbChzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICAgIC8vIENoZWNrIGlmIHRoZSB0cmFmZmljIG9yaWdpbmF0ZWQgZnJvbSB0aGUgc29ja2V0IG9uIHdoaWNoIHdlJ3JlIGV4cGVjdGluZyByZWxheSB0cmFmZmljLiBJZiBzbywKICAgIC8vIHdlIGhhdmVuJ3QgaG9sZSBwdW5jaGVkIHlldCBhbmQgdGhlIG90aGVyIHNpZGUgaXMganVzdCBzZW5kaW5nIHVzIHRyYWZmaWMgdGhyb3VnaCB0aGUgcmVsYXkuCiAgICBpZiAoYy5yZWxheVNvY2tldCAmJiBpc1JlbGF5KGMucmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKGMub25zb2NrZXQpIHsKICAgICAgYy5vbnNvY2tldChzb2NrZXQsIHBvcnQsIGhvc3QpCiAgICB9IGVsc2UgewogICAgICBjLnNlcnZlclNvY2tldCA9IHNvY2tldAogICAgICBjLnNlcnZlckFkZHJlc3MgPSB7IHBvcnQsIGhvc3QgfQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpmdW5jdGlvbiBpc0RvbmUoYykgewogIC8vIHdlIGFyZSBkZXN0cm95aW5nIG9yIHRoZSBwdW5jaGVyIGlzIGNvbm5lY3RlZCAtIGRvbmUKICBpZiAoYy5lbmNyeXB0ZWRTb2NrZXQuZGVzdHJveWluZyB8fCAhIShjLnB1bmNoZXIgJiYgYy5wdW5jaGVyLmNvbm5lY3RlZCkpIHsKICAgIHJldHVybiB0cnVlCiAgfQogIC8vIG5vdCBkZXN0cm95aW5nLCBidXQgbm8gcmF3IHN0cmVhbSAtIGRlZiBub3QgZG9uZQogIGlmIChjLmVuY3J5cHRlZFNvY2tldC5yYXdTdHJlYW0gPT09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZQogIH0KICAvLyB3ZSBhcmUgcmVsYXllZCwgYnV0IHRoZSBwdW5jaGVyIGlzIG5vdCBkb25lIHlldAogIGlmIChjLnJlbGF5U29ja2V0ICYmICEhKGMucHVuY2hlciAmJiAhYy5wdW5jaGVyLmNvbm5lY3RlZCAmJiAhYy5wdW5jaGVyLmRlc3Ryb3llZCkpIHsKICAgIHJldHVybiBmYWxzZQogIH0KICAvLyB3ZSBhcmUgZG9uZQogIHJldHVybiB0cnVlCn0KCmFzeW5jIGZ1bmN0aW9uIHJldHJ5Um91dGUoYywgcm91dGUpIHsKICBjb25zdCByZWYgPSBjLmRodC5fc29ja2V0UG9vbC5sb29rdXAocm91dGUuc29ja2V0KQoKICBpZiAoIXJlZikgewogICAgaWYgKHJvdXRlLnNvY2tldCA9PT0gYy5kaHQuc29ja2V0KSB7CiAgICAgIGF3YWl0IGNvbm5lY3RUaHJvdWdoTm9kZShjLCByb3V0ZS5hZGRyZXNzLCBjLmRodC5zb2NrZXQpCiAgICB9CiAgICByZXR1cm4KICB9CgogIHJlZi5hY3RpdmUoKQoKICB0cnkgewogICAgYXdhaXQgY29ubmVjdFRocm91Z2hOb2RlKGMsIHJvdXRlLmFkZHJlc3MsIHJvdXRlLnNvY2tldCkKICB9IGNhdGNoIHsKICAgIC8vIGlmIGVycm9yLCBqdXN0IGlnbm9yZSwgYW5kIGNvbnRpbnVlIHRocm91Z2ggdGhlIGV4aXN0aW5nIHN0cmF0CiAgfQoKICByZWYuaW5hY3RpdmUoKQp9Cgphc3luYyBmdW5jdGlvbiBjb25uZWN0QW5kSG9sZXB1bmNoKGMsIG9wdHMpIHsKICBjb25zdCByb3V0ZSA9IGMucmV1c2FibGVTb2NrZXQgPyBjLmRodC5fc29ja2V0UG9vbC5yb3V0ZXMuZ2V0KGMucmVtb3RlUHVibGljS2V5KSA6IG51bGwKCiAgaWYgKHJvdXRlKSB7CiAgICBhd2FpdCByZXRyeVJvdXRlKGMsIHJvdXRlKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgfQoKICBhd2FpdCBmaW5kQW5kQ29ubmVjdChjLCBvcHRzKQogIGlmIChpc0RvbmUoYykpIHJldHVybgoKICBpZiAoIWMuY29ubmVjdCkgewogICAgLy8gVE9ETzoganVzdCBhIHF1aWNrIGZpeCBmb3Igbm93LCBzaG91bGQgcmV0cnkgcHJvYgogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIEhBTkRTSEFLRV9JTlZBTElEKCkpCiAgICByZXR1cm4KICB9CgogIGF3YWl0IGhvbGVwdW5jaChjLCBvcHRzKQp9CgpmdW5jdGlvbiBnZXRGaXJzdFJlbW90ZUFkZHJlc3MoYWRkcnMsIHNlcnZlckFkZHJlc3MpIHsKICBmb3IgKGNvbnN0IGFkZHIgb2YgYWRkcnMpIHsKICAgIGlmIChpc0JvZ29uKGFkZHIuaG9zdCkpIGNvbnRpbnVlCiAgICByZXR1cm4gYWRkcgogIH0KCiAgcmV0dXJuIHNlcnZlckFkZHJlc3MKfQoKYXN5bmMgZnVuY3Rpb24gaG9sZXB1bmNoKGMsIG9wdHMpIHsKICBsZXQgeyByZWxheUFkZHJlc3MsIHNlcnZlckFkZHJlc3MsIGNsaWVudEFkZHJlc3MsIHBheWxvYWQgfSA9IGMuY29ubmVjdAoKICBjb25zdCByZW1vdGVIb2xlcHVuY2hhYmxlID0gISEocGF5bG9hZC5ob2xlcHVuY2ggJiYgcGF5bG9hZC5ob2xlcHVuY2gucmVsYXlzLmxlbmd0aCkKCiAgY29uc3QgcmVsYXllZCA9IGRpZmZBZGRyZXNzKHNlcnZlckFkZHJlc3MsIHJlbGF5QWRkcmVzcykKCiAgaWYgKHBheWxvYWQuZmlyZXdhbGwgPT09IEZJUkVXQUxMLk9QRU4gfHwgKHJlbGF5ZWQgJiYgIXJlbW90ZUhvbGVwdW5jaGFibGUpKSB7CiAgICBjb25zdCBhZGRyID0gZ2V0Rmlyc3RSZW1vdGVBZGRyZXNzKHBheWxvYWQuYWRkcmVzc2VzNCwgc2VydmVyQWRkcmVzcykKICAgIGlmIChhZGRyKSB7CiAgICAgIGNvbnN0IHNvY2tldCA9IGMuZGh0LnNvY2tldAogICAgICBjLmRodC5zdGF0cy5wdW5jaGVzLm9wZW4rKwogICAgICBjLm9uc29ja2V0KHNvY2tldCwgYWRkci5wb3J0LCBhZGRyLmhvc3QpCiAgICAgIHJldHVybgogICAgfQogICAgLy8gVE9ETzogY2hlY2sgYWxsIGFkZHJlc3NlcyBhbHNvIG9idnMKICB9CgogIGNvbnN0IG9uYWJvcnQgPSAoKSA9PiB7CiAgICBjLnNlc3Npb24uZGVzdHJveSgpCiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgSE9MRVBVTkNIX0FCT1JURUQoKSkKICB9CgogIGlmIChjLmZpcmV3YWxsID09PSBGSVJFV0FMTC5PUEVOKSB7CiAgICBjLnBhc3NpdmVDb25uZWN0VGltZW91dCA9IHNldFRpbWVvdXQob25hYm9ydCwgMTAwMDApCiAgICByZXR1cm4KICB9CgogIC8vIFRPRE86IHdvdWxkIGJlIGJldHRlciB0byBqdXN0IHRyeSBsb2NhbCBhZGRycyBpbiB0aGUgYmFja2dyb3VuZCB3aGlsc3QgY29udGludWluZyB3aXRoIG90aGVyIHN0cmF0ZWdpZXMuLi4KICBpZiAoYy5sYW4gJiYgcmVsYXllZCAmJiBjbGllbnRBZGRyZXNzLmhvc3QgPT09IHNlcnZlckFkZHJlc3MuaG9zdCkgewogICAgY29uc3Qgc2VydmVyQWRkcmVzc2VzID0gcGF5bG9hZC5hZGRyZXNzZXM0LmZpbHRlcihvbmx5UHJpdmF0ZUhvc3RzKQoKICAgIGlmIChzZXJ2ZXJBZGRyZXNzZXMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBteUFkZHJlc3NlcyA9IEhvbGVwdW5jaGVyLmxvY2FsQWRkcmVzc2VzKGMuZGh0LmlvLnNlcnZlclNvY2tldCkKICAgICAgY29uc3QgYWRkciA9IEhvbGVwdW5jaGVyLm1hdGNoQWRkcmVzcyhteUFkZHJlc3Nlcywgc2VydmVyQWRkcmVzc2VzKSB8fCBzZXJ2ZXJBZGRyZXNzZXNbMF0KCiAgICAgIGNvbnN0IHNvY2tldCA9IGMuZGh0LmlvLnNlcnZlclNvY2tldAogICAgICB0cnkgewogICAgICAgIGF3YWl0IGMuZGh0LnBpbmcoYWRkcikKICAgICAgfSBjYXRjaCB7CiAgICAgICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIEhPTEVQVU5DSF9BQk9SVEVEKCkpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgYy5vbnNvY2tldChzb2NrZXQsIGFkZHIucG9ydCwgYWRkci5ob3N0KQogICAgICByZXR1cm4KICAgIH0KICB9CgogIGlmICghcmVtb3RlSG9sZXB1bmNoYWJsZSkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIENBTk5PVF9IT0xFUFVOQ0goKSkKICAgIHJldHVybgogIH0KCiAgYy5wdW5jaGVyID0gbmV3IEhvbGVwdW5jaGVyKGMuZGh0LCBjLnNlc3Npb24sIHRydWUsIHBheWxvYWQuZmlyZXdhbGwpCgogIGMucHVuY2hlci5vbmNvbm5lY3QgPSBjLm9uc29ja2V0CiAgYy5wdW5jaGVyLm9uYWJvcnQgPSBvbmFib3J0CgogIGNvbnN0IHNlcnZlclJlbGF5ID0gcGlja1NlcnZlclJlbGF5KHBheWxvYWQuaG9sZXB1bmNoLnJlbGF5cywgcmVsYXlBZGRyZXNzKQoKICAvLyBCZWdpbiBob2xlcHVuY2hpbmchCgogIGxldCBwcm9iZQogIHRyeSB7CiAgICBwcm9iZSA9IGF3YWl0IHByb2JlUm91bmQoYywgb3B0cy5mYXN0T3BlbiA9PT0gZmFsc2UgPyBudWxsIDogc2VydmVyQWRkcmVzcywgc2VydmVyUmVsYXksIHRydWUpCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBkZXN0cm95UHVuY2hlcihjKQogICAgLy8gVE9ETzogd2Ugc2hvdWxkIHJldHJ5IGhlcmUgd2l0aCBzb21lIG9mIHRoZSBvdGhlciByZWxheXMsIGJhaWwgZm9yIG5vdwogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKICAgIHJldHVybgogIH0KCiAgaWYgKGlzRG9uZShjKSB8fCAhcHJvYmUpIHJldHVybgogIGNvbnN0IHsgdG9rZW4sIHBlZXJBZGRyZXNzIH0gPSBwcm9iZQoKICAvLyBJZiB0aGUgcmVsYXkgdGhlIHNlcnZlciBwaWNrZWQgaXMgdGhlIHNhbWUgYXMgdGhlIHJlbGF5IHRoZSBjbGllbnQgcGlja2VkLAogIC8vIHRoZW4gd2UgY2FuIHVzZSB0aGUgcGVlckFkZHJlc3MgdGhhdCByb3VuZCBvbmUgaW5kaWNhdGVzIHRoZSBzZXJ2ZXIgd2FudHMgdG8gdXNlLgogIC8vIFRoaXMgc2hhdmVzIG9mZiBhIHJvdW5kdHJpcCBpZiB0aGUgc2VydmVyIGNob3NlIHRvIHJlcm9sbCBpdHMgc29ja2V0IGR1ZSB0byBzb21lIE5BVAogIC8vIGlzc3VlIHdpdGggdGhlIGZpcnN0IG9uZSBpdCBwaWNrZWQgKGllIG1vYmlsZSBuYXQgaW5jb25zaXN0ZW5jaWVzLi4uKS4KICAvLyBJZiB0aGUgcmVsYXlzIHdlcmUgZGlmZmVyZW50LCB0aGVuIHRoZSBzZXJ2ZXIgd291bGQgbm90IGhhdmUgYSBVRFAgc2Vzc2lvbiBvcGVuIG9uIHRoaXMgYWRkcmVzcwogIC8vIHRvIHRoZSBjbGllbnQgcmVsYXksIHdoaWNoIHJvdW5kMiB1c2VzLgogIGlmICgKICAgICFkaWZmQWRkcmVzcyhzZXJ2ZXJSZWxheS5yZWxheUFkZHJlc3MsIHJlbGF5QWRkcmVzcykgJiYKICAgIGRpZmZBZGRyZXNzKHNlcnZlckFkZHJlc3MsIHBlZXJBZGRyZXNzKQogICkgewogICAgc2VydmVyQWRkcmVzcyA9IHBlZXJBZGRyZXNzCiAgICBhd2FpdCBjLnB1bmNoZXIub3BlblNlc3Npb24oc2VydmVyQWRkcmVzcykKICAgIGlmIChpc0RvbmUoYykpIHJldHVybgogIH0KCiAgLy8gVE9ETzogc3RpbGwgY29udGludWUgaGVyZSBpZiBhIGxvY2FsIGNvbm5lY3Rpb24gbWlnaHQgd29yaywgYnV0IHRoZW4gZG8gbm90IGhvbGVwdW5jaC4uLgogIGlmICgKICAgIG9wdHMuaG9sZXB1bmNoICYmCiAgICAhb3B0cy5ob2xlcHVuY2goCiAgICAgIGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCwKICAgICAgYy5wdW5jaGVyLm5hdC5maXJld2FsbCwKICAgICAgYy5wdW5jaGVyLnJlbW90ZUFkZHJlc3NlcywKICAgICAgYy5wdW5jaGVyLm5hdC5hZGRyZXNzZXMKICAgICkKICApIHsKICAgIGF3YWl0IGFib3J0KGMsIHNlcnZlclJlbGF5LCBIT0xFUFVOQ0hfQUJPUlRFRCgnQ2xpZW50IGFib3J0ZWQgaG9sZXB1bmNoJykpCiAgICByZXR1cm4KICB9CgogIHRyeSB7CiAgICBhd2FpdCByb3VuZFB1bmNoKGMsIHNlcnZlckFkZHJlc3MsIHRva2VuLCByZWxheUFkZHJlc3MsIHNlcnZlclJlbGF5LCBmYWxzZSkKICB9IGNhdGNoIChlcnIpIHsKICAgIGRlc3Ryb3lQdW5jaGVyKGMpCiAgICAvLyBUT0RPOiByZXRyeSB3aXRoIGFub3RoZXIgcmVsYXk/CiAgICBtYXliZURlc3Ryb3lFbmNyeXB0ZWRTb2NrZXQoYywgZXJyKQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZmluZEFuZENvbm5lY3QoYywgb3B0cykgewogIGxldCBhdHRlbXB0cyA9IDAKICBsZXQgY2xvc2VzdE5vZGVzID0gb3B0cy5yZWxheUFkZHJlc3NlcyAmJiBvcHRzLnJlbGF5QWRkcmVzc2VzLmxlbmd0aCA/IG9wdHMucmVsYXlBZGRyZXNzZXMgOiBudWxsCgogIGlmICghY2xvc2VzdE5vZGVzKSB7CiAgICBjb25zdCBjYWNoZWRSZWxheUFkZHJlc3NlcyA9IGMuZGh0Ll9yZWxheUFkZHJlc3Nlc0NhY2hlLmdldChjLmlkKQogICAgaWYgKGNhY2hlZFJlbGF5QWRkcmVzc2VzKSBjbG9zZXN0Tm9kZXMgPSBjYWNoZWRSZWxheUFkZHJlc3NlcwogIH0KCiAgaWYgKGMuZGh0Ll9wZXJzaXN0ZW50KSB7CiAgICAvLyBjaGVjayBpZiB3ZSBrbm93IHRoZSByb3V0ZSBvdXJzZWxmLi4uCiAgICBjb25zdCByb3V0ZSA9IGMuZGh0Ll9yb3V0ZXIuZ2V0KGMudGFyZ2V0KQogICAgaWYgKHJvdXRlICYmIHJvdXRlLnJlbGF5ICE9PSBudWxsKSB7CiAgICAgIGNsb3Nlc3ROb2RlcyA9IFt7IGhvc3Q6IHJvdXRlLnJlbGF5Lmhvc3QsIHBvcnQ6IHJvdXRlLnJlbGF5LnBvcnQgfV0KICAgIH0KICB9CgogIC8vIDIgaXMgaG93IG1hbnkgcGFyYWxsZWwgY29ubmVjdCBhdHRlbXB0cyB3ZSB3YW50IHRvIGRvLCB3ZSBjYW4gbWFrZSB0aGlzIGNvbmZpZ3VyYWJsZQogIGNvbnN0IHNlbSA9IG5ldyBTZW1hcGhvcmUoMikKICBjb25zdCBzaWduYWwgPSBzZW0uc2lnbmFsLmJpbmQoc2VtKQogIGNvbnN0IHRyaWVzID0gY2xvc2VzdE5vZGVzICE9PSBudWxsID8gMiA6IDEKCiAgdHJ5IHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHJpZXMgJiYgIWlzRG9uZShjKSAmJiAhYy5jb25uZWN0OyBpKyspIHsKICAgICAgYy5xdWVyeSA9IGMuZGh0LmZpbmRQZWVyKGMudGFyZ2V0LCB7CiAgICAgICAgaGFzaDogZmFsc2UsCiAgICAgICAgc2Vzc2lvbjogYy5zZXNzaW9uLAogICAgICAgIGNsb3Nlc3ROb2RlcywKICAgICAgICBvbmx5Q2xvc2VzdE5vZGVzOiBjbG9zZXN0Tm9kZXMgIT09IG51bGwsCiAgICAgICAgcmV0cmllczogY2xvc2VzdE5vZGVzID8gMSA6IDMKICAgICAgfSkKCiAgICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YSBvZiBjLnF1ZXJ5KSB7CiAgICAgICAgYXdhaXQgc2VtLndhaXQoKQogICAgICAgIGlmIChpc0RvbmUoYykpIHJldHVybgoKICAgICAgICBpZiAoYy5jb25uZWN0KSB7CiAgICAgICAgICBzZW0uc2lnbmFsKCkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBjLnJlbW90ZVJlbGF5QWRkcmVzc2VzLnB1c2goZGF0YS5mcm9tKQogICAgICAgIGF0dGVtcHRzKysKICAgICAgICBjb25uZWN0VGhyb3VnaE5vZGUoYywgZGF0YS5mcm9tLCBudWxsKS50aGVuKHNpZ25hbCwgc2lnbmFsKQogICAgICB9CgogICAgICBjbG9zZXN0Tm9kZXMgPSBudWxsCgogICAgICBpZiAoYXR0ZW1wdHMgPiAwKSBhd2FpdCBzZW0uZmx1c2goKQogICAgfQoKICAgIGMucXVlcnkgPSBudWxsCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KCiAgICAvLyBmbHVzaCB0aGUgc2VtYXBob3JlCiAgICBhd2FpdCBzZW0uZmx1c2goKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBjLnF1ZXJ5ID0gbnVsbAogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKICAgIHJldHVybgogIH0KCiAgaWYgKCFjLmNvbm5lY3QpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBhdHRlbXB0cyA/IFBFRVJfQ09OTkVDVElPTl9GQUlMRUQoKSA6IFBFRVJfTk9UX0ZPVU5EKCkpCiAgfQp9Cgphc3luYyBmdW5jdGlvbiBjb25uZWN0VGhyb3VnaE5vZGUoYywgYWRkcmVzcywgc29ja2V0KSB7CiAgaWYgKCFjLnJlcXVlc3RpbmcpIHsKICAgIC8vIElmIHdlIGhhdmUgYSBzdGFibGUgc2VydmVyIGFkZHJlc3MsIHNlbmQgaXQgb3ZlciBub3cKICAgIGNvbnN0IGFkZHIgPSBjLmRodC5yZW1vdGVBZGRyZXNzKCkKICAgIGNvbnN0IGxvY2FsQWRkcnMgPSBjLmxhbiA/IEhvbGVwdW5jaGVyLmxvY2FsQWRkcmVzc2VzKGMuZGh0LmlvLnNlcnZlclNvY2tldCkgOiBudWxsCiAgICBjb25zdCBhZGRyZXNzZXM0ID0gW10KCiAgICBpZiAoYWRkcikgYWRkcmVzc2VzNC5wdXNoKGFkZHIpCiAgICBpZiAobG9jYWxBZGRycykgYWRkcmVzc2VzNC5wdXNoKC4uLmxvY2FsQWRkcnMpCgogICAgYy5maXJld2FsbCA9IGFkZHIgPyBGSVJFV0FMTC5PUEVOIDogRklSRVdBTEwuVU5LTk9XTgogICAgYy5yZXF1ZXN0aW5nID0gdHJ1ZQogICAgYy5yZXF1ZXN0ID0gYXdhaXQgYy5oYW5kc2hha2Uuc2VuZCh7CiAgICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgICBmaXJld2FsbDogYy5maXJld2FsbCwKICAgICAgaG9sZXB1bmNoOiBudWxsLAogICAgICBhZGRyZXNzZXM0LAogICAgICBhZGRyZXNzZXM2OiBbXSwKICAgICAgdWR4OiB7CiAgICAgICAgcmV1c2FibGVTb2NrZXQ6IGMucmV1c2FibGVTb2NrZXQsCiAgICAgICAgaWQ6IGMucmF3U3RyZWFtLmlkLAogICAgICAgIHNlcTogMAogICAgICB9LAogICAgICBzZWNyZXRTdHJlYW06IHt9LAogICAgICByZWxheVRocm91Z2g6IGMucmVsYXlUaHJvdWdoID8geyBwdWJsaWNLZXk6IGMucmVsYXlUaHJvdWdoLCB0b2tlbjogYy5yZWxheVRva2VuIH0gOiBudWxsCiAgICB9KQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgfQoKICBjb25zdCB7IHNlcnZlckFkZHJlc3MsIGNsaWVudEFkZHJlc3MsIHJlbGF5ZWQsIG5vaXNlIH0gPSBhd2FpdCBjLmRodC5fcm91dGVyLnBlZXJIYW5kc2hha2UoCiAgICBjLnRhcmdldCwKICAgIHsgbm9pc2U6IGMucmVxdWVzdCwgc29ja2V0LCBzZXNzaW9uOiBjLnNlc3Npb24gfSwKICAgIGFkZHJlc3MKICApCiAgaWYgKGlzRG9uZShjKSB8fCBjLmNvbm5lY3QpIHJldHVybgoKICBjb25zdCBwYXlsb2FkID0gYXdhaXQgYy5oYW5kc2hha2UucmVjdihub2lzZSkKICBpZiAoaXNEb25lKGMpIHx8ICFwYXlsb2FkKSByZXR1cm4KCiAgaWYgKHBheWxvYWQudmVyc2lvbiAhPT0gMSkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIFNFUlZFUl9JTkNPTVBBVElCTEUoKSkKICAgIHJldHVybgogIH0KICBpZiAocGF5bG9hZC5lcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIFNFUlZFUl9FUlJPUigpKQogICAgcmV0dXJuCiAgfQogIGlmICghcGF5bG9hZC51ZHgpIHsKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBTRVJWRVJfRVJST1IoJ1NlcnZlciBkaWQgbm90IHNlbmQgVURYIGRhdGEnKSkKICAgIHJldHVybgogIH0KCiAgY29uc3QgaHMgPSBjLmhhbmRzaGFrZS5maW5hbCgpCgogIGMuaGFuZHNoYWtlID0gbnVsbAogIGMucmVxdWVzdCA9IG51bGwKICBjLnJlcXVlc3RpbmcgPSBmYWxzZQogIGMuY29ubmVjdCA9IHsKICAgIHJlbGF5ZWQsCiAgICByZWxheUFkZHJlc3M6IGFkZHJlc3MsCiAgICBjbGllbnRBZGRyZXNzLAogICAgc2VydmVyQWRkcmVzcywKICAgIHBheWxvYWQKICB9CgogIGMucGF5bG9hZCA9IG5ldyBTZWN1cmVQYXlsb2FkKGhzLmhvbGVwdW5jaFNlY3JldCkKCiAgYy5vbnNvY2tldCA9IGZ1bmN0aW9uIChzb2NrZXQsIHBvcnQsIGhvc3QpIHsKICAgIGlmIChjLnJhd1N0cmVhbSA9PT0gbnVsbCkgcmV0dXJuIC8vIEFscmVhZHkgaG9sZSBwdW5jaGVkCgogICAgaWYgKGMucmF3U3RyZWFtLmNvbm5lY3RlZCkgewogICAgICBjb25zdCByZW1vdGVDaGFuZ2luZyA9IGMucmF3U3RyZWFtLmNoYW5nZVJlbW90ZShzb2NrZXQsIGMuY29ubmVjdC5wYXlsb2FkLnVkeC5pZCwgcG9ydCwgaG9zdCkKCiAgICAgIGlmIChyZW1vdGVDaGFuZ2luZykgcmVtb3RlQ2hhbmdpbmcuY2F0Y2goc2FmZXR5Q2F0Y2gpCiAgICB9IGVsc2UgewogICAgICAvLyBjYWNoZSB0aGUgcmVsYXkgYWRkcnMgZm9yIGEgZnV0dXJlIHJlY29ubmVjdCwgd2UgcHJlZmVyIHRoZSByZW1vdGUgb25lIHNvIHRoZXkKICAgICAgLy8gY2FuIGdpdmUgdXMgdGhlIGNvcnJlY3Qgb25lcyBmcm9tIHRoZWlyIHBvdgogICAgICBpZiAocGF5bG9hZC5yZWxheUFkZHJlc3NlcyAmJiBwYXlsb2FkLnJlbGF5QWRkcmVzc2VzLmxlbmd0aCkgewogICAgICAgIGMuZGh0Ll9yZWxheUFkZHJlc3Nlc0NhY2hlLnNldChjLmlkLCBwYXlsb2FkLnJlbGF5QWRkcmVzc2VzKQogICAgICB9IGVsc2UgaWYgKGMucmVtb3RlUmVsYXlBZGRyZXNzZXMubGVuZ3RoKSB7CiAgICAgICAgYy5kaHQuX3JlbGF5QWRkcmVzc2VzQ2FjaGUuc2V0KGMuaWQsIGMucmVtb3RlUmVsYXlBZGRyZXNzZXMpCiAgICAgIH0KCiAgICAgIGMucmF3U3RyZWFtLmNvbm5lY3Qoc29ja2V0LCBjLmNvbm5lY3QucGF5bG9hZC51ZHguaWQsIHBvcnQsIGhvc3QpCiAgICAgIGMuZW5jcnlwdGVkU29ja2V0LnN0YXJ0KGMucmF3U3RyZWFtLCB7IGhhbmRzaGFrZTogaHMgfSkKICAgIH0KCiAgICBpZiAoYy5yZXVzYWJsZVNvY2tldCAmJiBwYXlsb2FkLnVkeC5yZXVzYWJsZVNvY2tldCkgewogICAgICBjLmRodC5fc29ja2V0UG9vbC5yb3V0ZXMuYWRkKGMucmVtb3RlUHVibGljS2V5LCBjLnJhd1N0cmVhbSkKICAgIH0KCiAgICBpZiAoYy5wdW5jaGVyKSB7CiAgICAgIGMucHVuY2hlci5vbmFib3J0ID0gbm9vcAogICAgICBjLnB1bmNoZXIuZGVzdHJveSgpCiAgICB9CgogICAgaWYgKGMucGFzc2l2ZUNvbm5lY3RUaW1lb3V0KSB7CiAgICAgIGNsZWFyUGFzc2l2ZUNvbm5lY3RUaW1lb3V0KGMpCiAgICB9CgogICAgYy5yYXdTdHJlYW0gPSBudWxsCiAgfQoKICBpZiAocGF5bG9hZC5yZWxheVRocm91Z2ggfHwgYy5yZWxheVRocm91Z2gpIHsKICAgIHJlbGF5Q29ubmVjdGlvbihjLCBjLnJlbGF5VGhyb3VnaCwgcGF5bG9hZCwgaHMpCiAgfQoKICBpZiAoYy5zZXJ2ZXJTb2NrZXQpIHsKICAgIGMub25zb2NrZXQoYy5zZXJ2ZXJTb2NrZXQsIGMuc2VydmVyQWRkcmVzcy5wb3J0LCBjLnNlcnZlckFkZHJlc3MuaG9zdCkKICAgIHJldHVybgogIH0KCiAgaWYgKCFyZWxheWVkKSB7CiAgICBjLm9uc29ja2V0KHNvY2tldCB8fCBjLmRodC5zb2NrZXQsIGFkZHJlc3MucG9ydCwgYWRkcmVzcy5ob3N0KQogIH0KCiAgYy5zZXNzaW9uLmRlc3Ryb3koKQp9Cgphc3luYyBmdW5jdGlvbiB1cGRhdGVIb2xlcHVuY2goYywgcGVlckFkZHJlc3MsIHJlbGF5QWRkciwgcGF5bG9hZCkgewogIGNvbnN0IGhvbGVwdW5jaCA9IGF3YWl0IGMuZGh0Ll9yb3V0ZXIucGVlckhvbGVwdW5jaCgKICAgIGMudGFyZ2V0LAogICAgewogICAgICBpZDogYy5jb25uZWN0LnBheWxvYWQuaG9sZXB1bmNoLmlkLAogICAgICBwYXlsb2FkOiBjLnBheWxvYWQuZW5jcnlwdChwYXlsb2FkKSwKICAgICAgcGVlckFkZHJlc3MsCiAgICAgIHNvY2tldDogYy5wdW5jaGVyLnNvY2tldCwKICAgICAgc2Vzc2lvbjogYy5zZXNzaW9uCiAgICB9LAogICAgcmVsYXlBZGRyCiAgKQoKICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAoKICBjb25zdCByZW1vdGVQYXlsb2FkID0gYy5wYXlsb2FkLmRlY3J5cHQoaG9sZXB1bmNoLnBheWxvYWQpCiAgaWYgKCFyZW1vdGVQYXlsb2FkKSB7CiAgICB0aHJvdyBIT0xFUFVOQ0hfSU5WQUxJRCgpCiAgfQoKICBjb25zdCB7IGVycm9yLCBmaXJld2FsbCwgcHVuY2hpbmcsIGFkZHJlc3NlcywgcmVtb3RlVG9rZW4gfSA9IHJlbW90ZVBheWxvYWQKCiAgaWYgKGVycm9yID09PSBFUlJPUi5UUllfTEFURVIgJiYgYy5yZWxheVRva2VuICYmIHBheWxvYWQucHVuY2hpbmcpIHsKICAgIHJldHVybiB7CiAgICAgIHRyeUxhdGVyOiB0cnVlLAogICAgICAuLi5ob2xlcHVuY2gsCiAgICAgIHBheWxvYWQ6IHJlbW90ZVBheWxvYWQKICAgIH0KICB9CgogIGlmIChlcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgdGhyb3cgUkVNT1RFX0FCT1JURUQoJ1JlbW90ZSBhYm9ydGVkIHdpdGggZXJyb3IgY29kZSAnICsgZXJyb3IpCiAgfQoKICBjb25zdCBlY2hvZWQgPSAhIShyZW1vdGVUb2tlbiAmJiBwYXlsb2FkLnRva2VuICYmIGI0YS5lcXVhbHMocmVtb3RlVG9rZW4sIHBheWxvYWQudG9rZW4pKQoKICBjLnB1bmNoZXIudXBkYXRlUmVtb3RlKHsKICAgIHB1bmNoaW5nLAogICAgZmlyZXdhbGwsCiAgICBhZGRyZXNzZXMsCiAgICB2ZXJpZmllZDogZWNob2VkID8gcGVlckFkZHJlc3MuaG9zdCA6IG51bGwKICB9KQoKICByZXR1cm4gewogICAgdHJ5TGF0ZXI6IGZhbHNlLAogICAgLi4uaG9sZXB1bmNoLAogICAgcGF5bG9hZDogcmVtb3RlUGF5bG9hZAogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcHJvYmVSb3VuZChjLCBzZXJ2ZXJBZGRyZXNzLCBzZXJ2ZXJSZWxheSwgcmV0cnkpIHsKICAvLyBPcGVuIGEgcXVpY2sgbG93IHR0bCBzZXNzaW9uIGFnYWluc3Qgd2hhdCB3ZSB0aGluayBpcyB0aGUgc2VydmVyCiAgaWYgKHNlcnZlckFkZHJlc3MpIGF3YWl0IGMucHVuY2hlci5vcGVuU2Vzc2lvbihzZXJ2ZXJBZGRyZXNzKQoKICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAoKICBjb25zdCByZXBseSA9IGF3YWl0IHVwZGF0ZUhvbGVwdW5jaChjLCBzZXJ2ZXJSZWxheS5wZWVyQWRkcmVzcywgc2VydmVyUmVsYXkucmVsYXlBZGRyZXNzLCB7CiAgICBlcnJvcjogRVJST1IuTk9ORSwKICAgIGZpcmV3YWxsOiBjLnB1bmNoZXIubmF0LmZpcmV3YWxsLAogICAgcm91bmQ6IGMucm91bmQrKywKICAgIGNvbm5lY3RlZDogZmFsc2UsCiAgICBwdW5jaGluZzogZmFsc2UsCiAgICBhZGRyZXNzZXM6IGMucHVuY2hlci5uYXQuYWRkcmVzc2VzLAogICAgcmVtb3RlQWRkcmVzczogc2VydmVyQWRkcmVzcywKICAgIHRva2VuOiBudWxsLAogICAgcmVtb3RlVG9rZW46IG51bGwKICB9KQoKICBpZiAoaXNEb25lKGMpIHx8ICFyZXBseSkgcmV0dXJuIG51bGwKCiAgY29uc3QgeyBwZWVyQWRkcmVzcyB9ID0gcmVwbHkKICBjb25zdCB7IGFkZHJlc3MsIHRva2VuIH0gPSByZXBseS5wYXlsb2FkCgogIGMucHVuY2hlci5uYXQuYWRkKHJlcGx5LnRvLCByZXBseS5mcm9tKQoKICAvLyBPcGVuIGFub3RoZXIgcXVpY2sgbG93IHR0bCBzZXNzaW9uIGFnYWluc3Qgd2hhdCB0aGUgc2VydmVyIHNheXMgdGhlaXIgYWRkcmVzcyBpcywKICAvLyBpZiB0aGV5IGhhdmVuJ3Qgc2FpZCB0aGV5IGFyZSByYW5kb20geWV0CiAgaWYgKAogICAgYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsIDwgRklSRVdBTEwuUkFORE9NICYmCiAgICBhZGRyZXNzICYmCiAgICBhZGRyZXNzLmhvc3QgJiYKICAgIGFkZHJlc3MucG9ydCAmJgogICAgZGlmZkFkZHJlc3MoYWRkcmVzcywgc2VydmVyQWRkcmVzcykKICApIHsKICAgIGF3YWl0IGMucHVuY2hlci5vcGVuU2Vzc2lvbihhZGRyZXNzKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKICB9CgogIC8vIElmIHRoZSByZW1vdGUgdG9sZCB1cyB0aGV5IGRpZG4ndCBrbm93IHRoZWlyIG5hdCBmaXJld2FsbCB5ZXQsIGdpdmUgdGhlbSBhIGNoYW5jZSB0byBmaWd1cmUgaXQgb3V0CiAgLy8gVGhleSBtaWdodCBzYXkgdGhpcyB0byBzZWUgaWYgdGhlICJmYXN0IG1vZGUiIHB1bmNoIGNvbWVzIHRocm91Z2ggZmlyc3QuCiAgaWYgKGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTikgewogICAgYXdhaXQgYy5zbGVlcGVyLnBhdXNlKDEwMDApCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4gbnVsbAogIH0KCiAgbGV0IHN0YWJsZSA9IGF3YWl0IGMucHVuY2hlci5hbmFseXplKGZhbHNlKQogIGlmIChpc0RvbmUoYykpIHJldHVybiBudWxsCgogIC8vIElmIHRoZSBzb2NrZXQgc2VlbXMgdW5zdGFibGUsIHRyeSB0byBtYWtlIGl0IHN0YWJsZSBieSBzZXR0aW5nIHRoZSAiYWxsb3dSZW9wZW4iIGZsYWcKICAvLyBNb3N0bHkgcmVsZXZhbnQgZm9yIG1vYmlsZSBuZXR3b3JrcwogIGlmICghc3RhYmxlKSB7CiAgICBzdGFibGUgPSBhd2FpdCBjLnB1bmNoZXIuYW5hbHl6ZSh0cnVlKQogICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuIG51bGwKICAgIGlmIChzdGFibGUpIHJldHVybiBwcm9iZVJvdW5kKGMsIHNlcnZlckFkZHJlc3MsIHNlcnZlclJlbGF5LCBmYWxzZSkKICB9CgogIGlmICgoYy5wdW5jaGVyLnJlbW90ZUZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOIHx8ICF0b2tlbikgJiYgcmV0cnkpIHsKICAgIHJldHVybiBwcm9iZVJvdW5kKGMsIHNlcnZlckFkZHJlc3MsIHNlcnZlclJlbGF5LCBmYWxzZSkKICB9CgogIGlmICgKICAgIGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTiB8fAogICAgYy5wdW5jaGVyLm5hdC5maXJld2FsbCA9PT0gRklSRVdBTEwuVU5LTk9XTgogICkgewogICAgYXdhaXQgYWJvcnQoYywgc2VydmVyUmVsYXksIEhPTEVQVU5DSF9QUk9CRV9USU1FT1VUKCkpCiAgICByZXR1cm4gbnVsbAogIH0KCiAgaWYgKGMucHVuY2hlci5yZW1vdGVGaXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00gJiYgYy5wdW5jaGVyLm5hdC5maXJld2FsbCA+PSBGSVJFV0FMTC5SQU5ET00pIHsKICAgIGF3YWl0IGFib3J0KGMsIHNlcnZlclJlbGF5LCBIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUygpKQogICAgcmV0dXJuIG51bGwKICB9CgogIHJldHVybiB7IHRva2VuLCBwZWVyQWRkcmVzcyB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJvdW5kUHVuY2goYywgc2VydmVyQWRkcmVzcywgcmVtb3RlVG9rZW4sIGNsaWVudFJlbGF5LCBzZXJ2ZXJSZWxheSwgZGVsYXllZCkgewogIC8vIFdlIGFyZSBnb3NzaXBpbmcgb3VyIGZpbmFsIE5BVCBzdGF0dXMgdG8gdGhlIG90aGVyIHBlZXIgbm93CiAgLy8gc28gbWFrZSBzdXJlIHdlIGRvbid0IHVwZGF0ZSBvdXIgbG9jYWwgdmlldyBmb3Igbm93IGFzIHRoYXQgY2FuIG1ha2UgdGhpbmdzIHdlaXJkCiAgYy5wdW5jaGVyLm5hdC5mcmVlemUoKQoKICBjb25zdCBpc1JhbmRvbSA9CiAgICBjLnB1bmNoZXIucmVtb3RlRmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NIHx8IGMucHVuY2hlci5uYXQuZmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NCiAgaWYgKGlzUmFuZG9tKSB7CiAgICB3aGlsZSAoCiAgICAgIGMuZGh0Ll9yYW5kb21QdW5jaGVzID49IGMuZGh0Ll9yYW5kb21QdW5jaExpbWl0IHx8CiAgICAgIERhdGUubm93KCkgLSBjLmRodC5fbGFzdFJhbmRvbVB1bmNoIDwgYy5kaHQuX3JhbmRvbVB1bmNoSW50ZXJ2YWwKICAgICkgewogICAgICAvLyBpZiBubyByZWxheSBjYW4gaGVscCwgYmFpbAogICAgICBpZiAoIWMucmVsYXlUb2tlbikgdGhyb3cgSE9MRVBVTkNIX0FCT1JURUQoKQoKICAgICAgaWYgKCFkZWxheWVkKSB7CiAgICAgICAgZGVsYXllZCA9IHRydWUKICAgICAgICBhd2FpdCB1cGRhdGVIb2xlcHVuY2goYywgc2VydmVyQWRkcmVzcywgY2xpZW50UmVsYXksIHsKICAgICAgICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgICAgICAgZmlyZXdhbGw6IGMucHVuY2hlci5uYXQuZmlyZXdhbGwsCiAgICAgICAgICByb3VuZDogYy5yb3VuZCsrLAogICAgICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgICAgIHB1bmNoaW5nOiBmYWxzZSwKICAgICAgICAgIGFkZHJlc3NlczogYy5wdW5jaGVyLm5hdC5hZGRyZXNzZXMsCiAgICAgICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICAgICAgdG9rZW46IGMucGF5bG9hZC50b2tlbihzZXJ2ZXJBZGRyZXNzKSwKICAgICAgICAgIHJlbW90ZVRva2VuCiAgICAgICAgfSkKICAgICAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICAgICAgfQoKICAgICAgYXdhaXQgdHJ5TGF0ZXIoYykKICAgICAgaWYgKGlzRG9uZShjKSkgcmV0dXJuCiAgICB9CiAgfQoKICAvLyBpbmNyZW1lbnQgbm93LCBzbyB3ZSBjYW4gY29tbWl0IHRvIHB1bmNoaW5nCiAgaWYgKGlzUmFuZG9tKSBjLmRodC5fcmFuZG9tUHVuY2hlcysrCgogIGxldCByZXBseQoKICB0cnkgewogICAgLy8gaWYgZGVsYXllZCBzd2l0Y2ggdG8gdGhlIHNlcnZlcnMgY2hvc2VuIHJlbGF5IC0gd2UgdmFsaWRhdGVkIGFueXdheQogICAgcmVwbHkgPSBhd2FpdCB1cGRhdGVIb2xlcHVuY2goCiAgICAgIGMsCiAgICAgIGRlbGF5ZWQgPyBzZXJ2ZXJSZWxheS5wZWVyQWRkcmVzcyA6IHNlcnZlckFkZHJlc3MsCiAgICAgIGRlbGF5ZWQgPyBzZXJ2ZXJSZWxheS5yZWxheUFkZHJlc3MgOiBjbGllbnRSZWxheSwKICAgICAgewogICAgICAgIGVycm9yOiBFUlJPUi5OT05FLAogICAgICAgIGZpcmV3YWxsOiBjLnB1bmNoZXIubmF0LmZpcmV3YWxsLAogICAgICAgIHJvdW5kOiBjLnJvdW5kKyssCiAgICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgICBwdW5jaGluZzogdHJ1ZSwKICAgICAgICBhZGRyZXNzZXM6IGMucHVuY2hlci5uYXQuYWRkcmVzc2VzLAogICAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgICAgdG9rZW46IGRlbGF5ZWQgPyBudWxsIDogYy5wYXlsb2FkLnRva2VuKHNlcnZlckFkZHJlc3MpLAogICAgICAgIHJlbW90ZVRva2VuCiAgICAgIH0KICAgICkKICB9IGZpbmFsbHkgewogICAgLy8gZGVjcmVtZW50IGFzIHB1bmNoIGluY3JlbWVudHMgZm9yIHVzCiAgICBpZiAoaXNSYW5kb20pIGMuZGh0Ll9yYW5kb21QdW5jaGVzLS0KICB9CgogIGlmIChpc0RvbmUoYykpIHJldHVybgogIGlmICghcmVwbHkpIHJldHVybgoKICBpZiAocmVwbHkudHJ5TGF0ZXIpIHsKICAgIGF3YWl0IHRyeUxhdGVyKGMpCiAgICBpZiAoaXNEb25lKGMpKSByZXR1cm4KICAgIHJldHVybiByb3VuZFB1bmNoKGMsIHNlcnZlckFkZHJlc3MsIHJlbW90ZVRva2VuLCBjbGllbnRSZWxheSwgc2VydmVyUmVsYXksIHRydWUpCiAgfQoKICBpZiAoIWMucHVuY2hlci5yZW1vdGVIb2xlcHVuY2hpbmcpIHsKICAgIHRocm93IFJFTU9URV9OT1RfSE9MRVBVTkNISU5HKCkKICB9CgogIGlmICghKGF3YWl0IGMucHVuY2hlci5wdW5jaCgpKSkgewogICAgdGhyb3cgUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFKCkKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHRyeUxhdGVyKGMpIHsKICBpZiAoIWMucmVsYXlUb2tlbikgdGhyb3cgSE9MRVBVTkNIX0FCT1JURUQoKQogIGF3YWl0IGMuc2xlZXBlci5wYXVzZSgxMDAwMCArIE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIDEwMDAwKSkKfQoKZnVuY3Rpb24gbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikgewogIGlmIChpc0RvbmUoYykpIHJldHVybgogIGlmIChjLmVuY3J5cHRlZFNvY2tldC5yYXdTdHJlYW0pIHJldHVybgogIGlmIChjLnJlbGF5U29ja2V0KSByZXR1cm4gLy8gd2FpdGluZyBmb3IgdGhlIHJlbGF5CiAgaWYgKGMucHVuY2hlciAmJiAhYy5wdW5jaGVyLmRlc3Ryb3llZCkgcmV0dXJuIC8vIHdhaXRpbmcgZm9yIHRoZSBwdW5jaGVyCiAgYy5zZXNzaW9uLmRlc3Ryb3koKQogIGMuZW5jcnlwdGVkU29ja2V0LmRlc3Ryb3koZXJyKQp9Cgphc3luYyBmdW5jdGlvbiBhYm9ydChjLCB7IHBlZXJBZGRyZXNzLCByZWxheUFkZHJlc3MgfSwgZXJyKSB7CiAgdHJ5IHsKICAgIGF3YWl0IHVwZGF0ZUhvbGVwdW5jaChwZWVyQWRkcmVzcywgcmVsYXlBZGRyZXNzLCB7CiAgICAgIGVycm9yOiBFUlJPUi5BQk9SVEVELAogICAgICBmaXJld2FsbDogRklSRVdBTEwuVU5LTk9XTiwKICAgICAgcm91bmQ6IGMucm91bmQrKywKICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgcHVuY2hpbmc6IGZhbHNlLAogICAgICBhZGRyZXNzZXM6IG51bGwsCiAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgIHRva2VuOiBudWxsLAogICAgICByZW1vdGVUb2tlbjogbnVsbAogICAgfSkKICB9IGNhdGNoIHt9CgogIGRlc3Ryb3lQdW5jaGVyKGMpCiAgbWF5YmVEZXN0cm95RW5jcnlwdGVkU29ja2V0KGMsIGVycikKfQoKZnVuY3Rpb24gcmVsYXlDb25uZWN0aW9uKGMsIHJlbGF5VGhyb3VnaCwgcGF5bG9hZCwgaHMpIHsKICBsZXQgaXNJbml0aWF0b3IKICBsZXQgcHVibGljS2V5CiAgbGV0IHRva2VuCgogIGlmIChwYXlsb2FkLnJlbGF5VGhyb3VnaCkgewogICAgaXNJbml0aWF0b3IgPSBmYWxzZQogICAgcHVibGljS2V5ID0gcGF5bG9hZC5yZWxheVRocm91Z2gucHVibGljS2V5CiAgICB0b2tlbiA9IHBheWxvYWQucmVsYXlUaHJvdWdoLnRva2VuCiAgfSBlbHNlIHsKICAgIGlzSW5pdGlhdG9yID0gdHJ1ZQogICAgcHVibGljS2V5ID0gcmVsYXlUaHJvdWdoCiAgICB0b2tlbiA9IGMucmVsYXlUb2tlbgogIH0KCiAgYy5yZWxheVRva2VuID0gdG9rZW4KICBjLnJlbGF5U29ja2V0ID0gYy5kaHQuY29ubmVjdChwdWJsaWNLZXkpCiAgYy5yZWxheVNvY2tldC5zZXRLZWVwQWxpdmUoYy5yZWxheUtlZXBBbGl2ZSkKICBjLnJlbGF5Q2xpZW50ID0gcmVsYXkuQ2xpZW50LmZyb20oYy5yZWxheVNvY2tldCwgeyBpZDogYy5yZWxheVNvY2tldC5wdWJsaWNLZXkgfSkKICBjLnJlbGF5VGltZW91dCA9IHNldFRpbWVvdXQob25hYm9ydCwgMTUwMDAsIG51bGwpCgogIGMucmVsYXlDbGllbnQucGFpcihpc0luaXRpYXRvciwgdG9rZW4sIGMucmF3U3RyZWFtKS5vbignZXJyb3InLCBvbmFib3J0KS5vbignZGF0YScsIG9uZGF0YSkKCiAgZnVuY3Rpb24gb25kYXRhKHJlbW90ZUlkKSB7CiAgICBpZiAoYy5yZWxheVRpbWVvdXQpIGNsZWFyUmVsYXlUaW1lb3V0KGMpCiAgICBpZiAoYy5yYXdTdHJlYW0gPT09IG51bGwpIHsKICAgICAgb25hYm9ydChudWxsKQogICAgICByZXR1cm4KICAgIH0KCiAgICBjLnJlbGF5UGFpcmVkID0gdHJ1ZQoKICAgIGNvbnN0IHsgcmVtb3RlUG9ydCwgcmVtb3RlSG9zdCwgc29ja2V0IH0gPSBjLnJlbGF5U29ja2V0LnJhd1N0cmVhbQoKICAgIGMucmF3U3RyZWFtCiAgICAgIC5vbignY2xvc2UnLCAoKSA9PiBjLnJlbGF5U29ja2V0LmRlc3Ryb3koKSkKICAgICAgLmNvbm5lY3Qoc29ja2V0LCByZW1vdGVJZCwgcmVtb3RlUG9ydCwgcmVtb3RlSG9zdCkKCiAgICBjLmVuY3J5cHRlZFNvY2tldC5zdGFydChjLnJhd1N0cmVhbSwgeyBoYW5kc2hha2U6IGhzIH0pCiAgfQoKICBmdW5jdGlvbiBvbmFib3J0KGVycikgewogICAgaWYgKGMucmVsYXlUaW1lb3V0KSBjbGVhclJlbGF5VGltZW91dChjKQogICAgY29uc3Qgc29ja2V0ID0gYy5yZWxheVNvY2tldAogICAgYy5yZWxheVRva2VuID0gbnVsbAogICAgYy5yZWxheVNvY2tldCA9IG51bGwKICAgIGlmIChzb2NrZXQpIHNvY2tldC5kZXN0cm95KCkKICAgIG1heWJlRGVzdHJveUVuY3J5cHRlZFNvY2tldChjLCBlcnIgfHwgUkVMQVlfQUJPUlRFRCgpKQogIH0KfQoKZnVuY3Rpb24gY2xlYXJQYXNzaXZlQ29ubmVjdFRpbWVvdXQoYykgewogIGNsZWFyVGltZW91dChjLnBhc3NpdmVDb25uZWN0VGltZW91dCkKICBjLnBhc3NpdmVDb25uZWN0VGltZW91dCA9IG51bGwKfQoKZnVuY3Rpb24gY2xlYXJSZWxheVRpbWVvdXQoYykgewogIGNsZWFyVGltZW91dChjLnJlbGF5VGltZW91dCkKICBjLnJlbGF5VGltZW91dCA9IG51bGwKfQoKZnVuY3Rpb24gZGVzdHJveVB1bmNoZXIoYykgewogIGlmIChjLnB1bmNoZXIpIGMucHVuY2hlci5kZXN0cm95KCkKICBjLnNlc3Npb24uZGVzdHJveSgpCn0KCmZ1bmN0aW9uIHBpY2tTZXJ2ZXJSZWxheShyZWxheXMsIGNsaWVudFJlbGF5KSB7CiAgZm9yIChjb25zdCByIG9mIHJlbGF5cykgewogICAgaWYgKCFkaWZmQWRkcmVzcyhyLnJlbGF5QWRkcmVzcywgY2xpZW50UmVsYXkpKSByZXR1cm4gcgogIH0KICByZXR1cm4gcmVsYXlzWzBdCn0KCmZ1bmN0aW9uIGRpZmZBZGRyZXNzKGEsIGIpIHsKICByZXR1cm4gYS5ob3N0ICE9PSBiLmhvc3QgfHwgYS5wb3J0ICE9PSBiLnBvcnQKfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZUhhbmRzaGFrZShrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpIHsKICByZXR1cm4gbmV3IE5vaXNlV3JhcChrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpCn0KCmZ1bmN0aW9uIGRlZmF1bHRDcmVhdGVTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykgewogIHJldHVybiBuZXcgTm9pc2VTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykKfQoKZnVuY3Rpb24gb25seVByaXZhdGVIb3N0cyhhZGRyKSB7CiAgcmV0dXJuIGlzUHJpdmF0ZShhZGRyLmhvc3QpCn0KCmZ1bmN0aW9uIGlzUmVsYXkocmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkgewogIGNvbnN0IHN0cmVhbSA9IHJlbGF5U29ja2V0LnJhd1N0cmVhbQogIGlmICghc3RyZWFtKSByZXR1cm4gZmFsc2UKICBpZiAoc3RyZWFtLnNvY2tldCAhPT0gc29ja2V0KSByZXR1cm4gZmFsc2UKICByZXR1cm4gcG9ydCA9PT0gc3RyZWFtLnJlbW90ZVBvcnQgJiYgaG9zdCA9PT0gc3RyZWFtLnJlbW90ZUhvc3QKfQoKZnVuY3Rpb24gc2VsZWN0UmVsYXkocmVsYXlUaHJvdWdoKSB7CiAgaWYgKHR5cGVvZiByZWxheVRocm91Z2ggPT09ICdmdW5jdGlvbicpIHJlbGF5VGhyb3VnaCA9IHJlbGF5VGhyb3VnaCgpCiAgaWYgKHJlbGF5VGhyb3VnaCA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICBpZiAoQXJyYXkuaXNBcnJheShyZWxheVRocm91Z2gpKQogICAgcmV0dXJuIHJlbGF5VGhyb3VnaFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiByZWxheVRocm91Z2gubGVuZ3RoKV0KICByZXR1cm4gcmVsYXlUaHJvdWdoCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBlcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIENvbm5lY3Rpb25Qb29sIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvcihkaHQpIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLl9kaHQgPSBkaHQKICAgIHRoaXMuX3NlcnZlcnMgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2Nvbm5lY3RpbmcgPSBuZXcgTWFwKCkKICAgIHRoaXMuX2Nvbm5lY3Rpb25zID0gbmV3IE1hcCgpCiAgfQoKICBfYXR0YWNoU2VydmVyKHNlcnZlcikgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHNlcnZlci5wdWJsaWNLZXksICdoZXgnKQoKICAgIHRoaXMuX3NlcnZlcnMuc2V0KGtleVN0cmluZywgc2VydmVyKQoKICAgIHNlcnZlcgogICAgICAub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgIHRoaXMuX3NlcnZlcnMuZGVsZXRlKGtleVN0cmluZykKICAgICAgfSkKICAgICAgLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldCkgPT4gewogICAgICAgIHRoaXMuX2F0dGFjaFN0cmVhbShzb2NrZXQsIHRydWUpCiAgICAgIH0pCiAgfQoKICBfYXR0YWNoU3RyZWFtKHN0cmVhbSwgb3BlbmVkKSB7CiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuZ2V0KHN0cmVhbS5yZW1vdGVQdWJsaWNLZXkpCgogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIGNvbnN0IGtlZXBOZXcgPQogICAgICAgIHN0cmVhbS5pc0luaXRpYXRvciA9PT0gZXhpc3RpbmcuaXNJbml0aWF0b3IgfHwKICAgICAgICBiNGEuY29tcGFyZShzdHJlYW0ucHVibGljS2V5LCBzdHJlYW0ucmVtb3RlUHVibGljS2V5KSA+IDAKCiAgICAgIGlmIChrZWVwTmV3KSB7CiAgICAgICAgbGV0IGNsb3NlZCA9IGZhbHNlCgogICAgICAgIGNvbnN0IG9uY2xvc2UgPSAoKSA9PiB7CiAgICAgICAgICBjbG9zZWQgPSB0cnVlCiAgICAgICAgfQoKICAgICAgICBleGlzdGluZwogICAgICAgICAgLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgICAgICBpZiAoY2xvc2VkKSByZXR1cm4KCiAgICAgICAgICAgIHN0cmVhbS5vZmYoJ2Vycm9yJywgbm9vcCkub2ZmKCdjbG9zZScsIG9uY2xvc2UpCgogICAgICAgICAgICB0aGlzLl9hdHRhY2hTdHJlYW0oc3RyZWFtLCBvcGVuZWQpCiAgICAgICAgICB9KQogICAgICAgICAgLmRlc3Ryb3koZXJyb3JzLkRVUExJQ0FURV9DT05ORUNUSU9OKCkpCgogICAgICAgIHN0cmVhbS5vbignZXJyb3InLCBub29wKS5vbignY2xvc2UnLCBvbmNsb3NlKQogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbS5vbignZXJyb3InLCBub29wKS5kZXN0cm95KGVycm9ycy5EVVBMSUNBVEVfQ09OTkVDVElPTigpKQogICAgICB9CgogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBzZXNzaW9uID0gbmV3IENvbm5lY3Rpb25SZWYodGhpcywgc3RyZWFtKQoKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhzdHJlYW0ucmVtb3RlUHVibGljS2V5LCAnaGV4JykKCiAgICBpZiAob3BlbmVkKSB7CiAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zLnNldChrZXlTdHJpbmcsIHNlc3Npb24pCgogICAgICBzdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zLmRlbGV0ZShrZXlTdHJpbmcpCiAgICAgIH0pCgogICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3Rpb24nLCBzdHJlYW0sIHNlc3Npb24pCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9jb25uZWN0aW5nLnNldChrZXlTdHJpbmcsIHNlc3Npb24pCgogICAgICBzdHJlYW0KICAgICAgICAub24oJ2Vycm9yJywgbm9vcCkKICAgICAgICAub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgICAgaWYgKG9wZW5lZCkgdGhpcy5fY29ubmVjdGlvbnMuZGVsZXRlKGtleVN0cmluZykKICAgICAgICAgIGVsc2UgdGhpcy5fY29ubmVjdGluZy5kZWxldGUoa2V5U3RyaW5nKQogICAgICAgIH0pCiAgICAgICAgLm9uKCdvcGVuJywgKCkgPT4gewogICAgICAgICAgb3BlbmVkID0gdHJ1ZQoKICAgICAgICAgIHRoaXMuX2Nvbm5lY3RpbmcuZGVsZXRlKGtleVN0cmluZykKICAgICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zLnNldChrZXlTdHJpbmcsIHNlc3Npb24pCgogICAgICAgICAgc3RyZWFtLm9mZignZXJyb3InLCBub29wKQoKICAgICAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbicsIHN0cmVhbSwgc2Vzc2lvbikKICAgICAgICB9KQogICAgfQoKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICBnZXQgY29ubmVjdGluZygpIHsKICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW5nLnNpemUKICB9CgogIGdldCBjb25uZWN0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9ucy52YWx1ZXMoKQogIH0KCiAgaGFzKHB1YmxpY0tleSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCgogICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb25zLmhhcyhrZXlTdHJpbmcpIHx8IHRoaXMuX2Nvbm5lY3RpbmcuaGFzKGtleVN0cmluZykKICB9CgogIGdldChwdWJsaWNLZXkpIHsKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQoKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fY29ubmVjdGlvbnMuZ2V0KGtleVN0cmluZykgfHwgdGhpcy5fY29ubmVjdGluZy5nZXQoa2V5U3RyaW5nKQoKICAgIHJldHVybiBleGlzdGluZz8uX3N0cmVhbSB8fCBudWxsCiAgfQp9CgpjbGFzcyBDb25uZWN0aW9uUmVmIHsKICBjb25zdHJ1Y3Rvcihwb29sLCBzdHJlYW0pIHsKICAgIHRoaXMuX3Bvb2wgPSBwb29sCiAgICB0aGlzLl9zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMuX3JlZnMgPSAwCiAgfQoKICBhY3RpdmUoKSB7CiAgICB0aGlzLl9yZWZzKysKICB9CgogIGluYWN0aXZlKCkgewogICAgdGhpcy5fcmVmcy0tCiAgfQoKICByZWxlYXNlKCkgewogICAgdGhpcy5fc3RyZWFtLmRlc3Ryb3koKQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CmNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2h5cGVyY29yZS1jcnlwdG8nKQoKY29uc3QgQ09NTUFORFMgPSAoZXhwb3J0cy5DT01NQU5EUyA9IHsKICBQRUVSX0hBTkRTSEFLRTogMCwKICBQRUVSX0hPTEVQVU5DSDogMSwKICBGSU5EX1BFRVI6IDIsCiAgTE9PS1VQOiAzLAogIEFOTk9VTkNFOiA0LAogIFVOQU5OT1VOQ0U6IDUsCiAgTVVUQUJMRV9QVVQ6IDYsCiAgTVVUQUJMRV9HRVQ6IDcsCiAgSU1NVVRBQkxFX1BVVDogOCwKICBJTU1VVEFCTEVfR0VUOiA5Cn0pCgpleHBvcnRzLkJPT1RTVFJBUF9OT0RFUyA9IGdsb2JhbC5QZWFyPy5jb25maWcuZGh0Py5ib290c3RyYXAgfHwgWwogICc4OC45OS4zLjg2QG5vZGUxLmh5cGVyZGh0Lm9yZzo0OTczNycsCiAgJzE0Mi45My45MC4xMTNAbm9kZTIuaHlwZXJkaHQub3JnOjQ5NzM3JywKICAnMTM4LjY4LjE0Ny44QG5vZGUzLmh5cGVyZGh0Lm9yZzo0OTczNycKXQoKZXhwb3J0cy5LTk9XTl9OT0RFUyA9IGdsb2JhbC5QZWFyPy5jb25maWcuZGh0Py5ub2RlcyB8fCBbXQoKZXhwb3J0cy5GSVJFV0FMTCA9IHsKICBVTktOT1dOOiAwLAogIE9QRU46IDEsCiAgQ09OU0lTVEVOVDogMiwKICBSQU5ET006IDMKfQoKZXhwb3J0cy5FUlJPUiA9IHsKICAvLyBub2lzZSAvIGNvbm5lY3Rpb24gcmVsYXRlZAogIE5PTkU6IDAsCiAgQUJPUlRFRDogMSwKICBWRVJTSU9OX01JU01BVENIOiAyLAogIFRSWV9MQVRFUjogMywKICAvLyBkaHQgcmVsYXRlZAogIFNFUV9SRVVTRUQ6IDE2LAogIFNFUV9UT09fTE9XOiAxNwp9Cgpjb25zdCBbTlNfQU5OT1VOQ0UsIE5TX1VOQU5OT1VOQ0UsIE5TX01VVEFCTEVfUFVULCBOU19QRUVSX0hBTkRTSEFLRSwgTlNfUEVFUl9IT0xFUFVOQ0hdID0KICBjcnlwdG8ubmFtZXNwYWNlKCdoeXBlcnN3YXJtL2RodCcsIFsKICAgIENPTU1BTkRTLkFOTk9VTkNFLAogICAgQ09NTUFORFMuVU5BTk5PVU5DRSwKICAgIENPTU1BTkRTLk1VVEFCTEVfUFVULAogICAgQ09NTUFORFMuUEVFUl9IQU5EU0hBS0UsCiAgICBDT01NQU5EUy5QRUVSX0hPTEVQVU5DSAogIF0pCgpleHBvcnRzLk5TID0gewogIEFOTk9VTkNFOiBOU19BTk5PVU5DRSwKICBVTkFOTk9VTkNFOiBOU19VTkFOTk9VTkNFLAogIE1VVEFCTEVfUFVUOiBOU19NVVRBQkxFX1BVVCwKICBQRUVSX0hBTkRTSEFLRTogTlNfUEVFUl9IQU5EU0hBS0UsCiAgUEVFUl9IT0xFUFVOQ0g6IE5TX1BFRVJfSE9MRVBVTkNICn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpmdW5jdGlvbiBoYXNoKGRhdGEpIHsKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmUoMzIpCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChvdXQsIGRhdGEpCiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiB1bnNsYWJiZWRIYXNoKGRhdGEpIHsKICBjb25zdCBvdXQgPSBiNGEuYWxsb2NVbnNhZmVTbG93KDMyKQogIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBkYXRhKQogIHJldHVybiBvdXQKfQoKZnVuY3Rpb24gY3JlYXRlS2V5UGFpcihzZWVkKSB7CiAgY29uc3QgcHVibGljS2V5ID0gYjRhLmFsbG9jKDMyKQogIGNvbnN0IHNlY3JldEtleSA9IGI0YS5hbGxvYyg2NCkKICBpZiAoc2VlZCkgc29kaXVtLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihwdWJsaWNLZXksIHNlY3JldEtleSwgc2VlZCkKICBlbHNlIHNvZGl1bS5jcnlwdG9fc2lnbl9rZXlwYWlyKHB1YmxpY0tleSwgc2VjcmV0S2V5KQogIHJldHVybiB7IHB1YmxpY0tleSwgc2VjcmV0S2V5IH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaGFzaCwKICB1bnNsYWJiZWRIYXNoLAogIGNyZWF0ZUtleVBhaXIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjZW5jID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCgpmdW5jdGlvbiBlbmNvZGVVbnNsYWIoZW5jLCBtKSB7CiAgLy8gRmFzdGVyIHRoYW4gdW5zbGFiKGMuZW5jb2RlKGVuYywgZGF0YSkpIGJlY2F1c2UgaXQgYXZvaWRzIHRoZSBtZW0gY29weS4KICAvLyBNYWtlcyBzZW5zZSB0byBwdXQgaW4gY29tcGFjdC1lbmNvZGluZyB3aGVuIHdlIG5lZWQgaXQgaW4gb3RoZXIgbW9kdWxlcyB0b28KICBjb25zdCBzdGF0ZSA9IGNlbmMuc3RhdGUoKQogIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhzdGF0ZS5lbmQpCiAgZW5jLmVuY29kZShzdGF0ZSwgbSkKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KCm1vZHVsZS5leHBvcnRzID0gewogIGVuY29kZVVuc2xhYgp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgREhURXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlLCBmbiA9IERIVEVycm9yKSB7CiAgICBzdXBlcihgJHtjb2RlfTogJHttc2d9YCkKICAgIHRoaXMuY29kZSA9IGNvZGUKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgZm4pCiAgICB9CiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiAnREhURXJyb3InCiAgfQoKICBzdGF0aWMgQkFEX0hBTkRTSEFLRV9SRVBMWShtc2cgPSAnQmFkIGhhbmRzaGFrZSByZXBseScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnQkFEX0hBTkRTSEFLRV9SRVBMWScsIERIVEVycm9yLkJBRF9IQU5EU0hBS0VfUkVQTFkpCiAgfQoKICBzdGF0aWMgQkFEX0hPTEVQVU5DSF9SRVBMWShtc2cgPSAnQmFkIGhvbGVwdW5jaCByZXBseScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnQkFEX0hPTEVQVU5DSF9SRVBMWScsIERIVEVycm9yLkJBRF9IT0xFUFVOQ0hfUkVQTFkpCiAgfQoKICBzdGF0aWMgSE9MRVBVTkNIX0FCT1JURUQobXNnID0gJ0hvbGVwdW5jaCBhYm9ydGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIT0xFUFVOQ0hfQUJPUlRFRCcsIERIVEVycm9yLkhPTEVQVU5DSF9BQk9SVEVEKQogIH0KCiAgc3RhdGljIEhPTEVQVU5DSF9JTlZBTElEKG1zZyA9ICdJbnZhbGlkIGhvbGVwdW5jaCBwYXlsb2FkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIT0xFUFVOQ0hfSU5WQUxJRCcsIERIVEVycm9yLkhPTEVQVU5DSF9JTlZBTElEKQogIH0KCiAgc3RhdGljIEhPTEVQVU5DSF9QUk9CRV9USU1FT1VUKG1zZyA9ICdIb2xlcHVuY2hpbmcgcHJvYmUgZGlkIG5vdCBmaW5pc2ggaW4gdGltZScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSE9MRVBVTkNIX1BST0JFX1RJTUVPVVQnLCBESFRFcnJvci5IT0xFUFVOQ0hfUFJPQkVfVElNRU9VVCkKICB9CgogIHN0YXRpYyBIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUyhtc2cgPSAnQm90aCByZW1vdGUgYW5kIGxvY2FsIE5BVHMgYXJlIHJhbmRvbWl6ZWQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKAogICAgICBtc2csCiAgICAgICdIT0xFUFVOQ0hfRE9VQkxFX1JBTkRPTUlaRURfTkFUUycsCiAgICAgIERIVEVycm9yLkhPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTCiAgICApCiAgfQoKICBzdGF0aWMgQ0FOTk9UX0hPTEVQVU5DSChtc2cgPSAnQ2Fubm90IGhvbGVwdW5jaCB0byByZW1vdGUnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0NBTk5PVF9IT0xFUFVOQ0gnLCBESFRFcnJvci5DQU5OT1RfSE9MRVBVTkNIKQogIH0KCiAgc3RhdGljIFJFTU9URV9OT1RfSE9MRVBVTkNISU5HKG1zZyA9ICdSZW1vdGUgaXMgbm90IGhvbGVwdW5jaGluZycpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVNT1RFX05PVF9IT0xFUFVOQ0hJTkcnLCBESFRFcnJvci5SRU1PVEVfTk9UX0hPTEVQVU5DSElORykKICB9CgogIHN0YXRpYyBSRU1PVEVfTk9UX0hPTEVQVU5DSEFCTEUobXNnID0gJ1JlbW90ZSBpcyBub3QgaG9sZXB1bmNoYWJsZScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFJywgREhURXJyb3IuUkVNT1RFX05PVF9IT0xFUFVOQ0hBQkxFKQogIH0KCiAgc3RhdGljIFJFTU9URV9BQk9SVEVEKG1zZyA9ICdSZW1vdGUgYWJvcnRlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnUkVNT1RFX0FCT1JURUQnLCBESFRFcnJvci5SRU1PVEVfQUJPUlRFRCkKICB9CgogIHN0YXRpYyBIQU5EU0hBS0VfVU5GSU5JU0hFRChtc2cgPSAnSGFuZHNoYWtlIGRpZCBub3QgZmluaXNoJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdIQU5EU0hBS0VfVU5GSU5JU0hFRCcsIERIVEVycm9yLkhBTkRTSEFLRV9VTkZJTklTSEVEKQogIH0KCiAgc3RhdGljIEhBTkRTSEFLRV9JTlZBTElEKG1zZyA9ICdSZWNlaXZlZCBpbnZhbGlkIGhhbmRzaGFrZScpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnSEFORFNIQUtFX0lOVkFMSUQnLCBESFRFcnJvci5IQU5EU0hBS0VfSU5WQUxJRCkKICB9CgogIHN0YXRpYyBBTFJFQURZX0xJU1RFTklORyhtc2cgPSAnQWxyZWFkeSBsaXN0ZW5pbmcnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ0FMUkVBRFlfTElTVEVOSU5HJywgREhURXJyb3IuQUxSRUFEWV9MSVNURU5JTkcpCiAgfQoKICBzdGF0aWMgS0VZUEFJUl9BTFJFQURZX1VTRUQobXNnID0gJ0tleXBhaXIgYWxyZWFkeSB1c2VkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdLRVlQQUlSX0FMUkVBRFlfVVNFRCcsIERIVEVycm9yLktFWVBBSVJfQUxSRUFEWV9VU0VEKQogIH0KCiAgc3RhdGljIE5PREVfREVTVFJPWUVEKG1zZyA9ICdOb2RlIGRlc3Ryb3llZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnTk9ERV9ERVNUUk9ZRUQnLCBESFRFcnJvci5OT0RFX0RFU1RST1lFRCkKICB9CgogIHN0YXRpYyBQRUVSX0NPTk5FQ1RJT05fRkFJTEVEKG1zZyA9ICdDb3VsZCBub3QgY29ubmVjdCB0byBwZWVyJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdQRUVSX0NPTk5FQ1RJT05fRkFJTEVEJywgREhURXJyb3IuUEVFUl9DT05ORUNUSU9OX0ZBSUxFRCkKICB9CgogIHN0YXRpYyBQRUVSX05PVF9GT1VORChtc2cgPSAnUGVlciBub3QgZm91bmQnKSB7CiAgICByZXR1cm4gbmV3IERIVEVycm9yKG1zZywgJ1BFRVJfTk9UX0ZPVU5EJywgREhURXJyb3IuUEVFUl9OT1RfRk9VTkQpCiAgfQoKICBzdGF0aWMgU1RSRUFNX05PVF9DT05ORUNURUQobXNnID0gJ1N0cmVhbSBpcyBub3QgY29ubmVjdGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdTVFJFQU1fTk9UX0NPTk5FQ1RFRCcsIERIVEVycm9yLlNUUkVBTV9ESVNDT05ORUNURUQpCiAgfQoKICBzdGF0aWMgU0VSVkVSX0lOQ09NUEFUSUJMRShtc2cgPSAnU2VydmVyIGlzIHVzaW5nIGFuIGluY29tcGF0aWJsZSB2ZXJzaW9uJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdTRVJWRVJfSU5DT01QQVRJQkxFJywgREhURXJyb3IuU0VSVkVSX0lOQ09NUEFUSUJMRSkKICB9CgogIHN0YXRpYyBTRVJWRVJfRVJST1IobXNnID0gJ1NlcnZlciByZXR1cm5lZCBhbiBlcnJvcicpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnU0VSVkVSX0VSUk9SJywgREhURXJyb3IuU0VSVkVSX0VSUk9SKQogIH0KCiAgc3RhdGljIERVUExJQ0FURV9DT05ORUNUSU9OKG1zZyA9ICdEdXBsaWNhdGUgY29ubmVjdGlvbicpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnRFVQTElDQVRFX0NPTk5FQ1RJT04nLCBESFRFcnJvci5EVVBMSUNBVEVfQ09OTkVDVElPTikKICB9CgogIHN0YXRpYyBSRUxBWV9BQk9SVEVEKG1zZyA9ICdSZWxheSBhYm9ydGVkJykgewogICAgcmV0dXJuIG5ldyBESFRFcnJvcihtc2csICdSRUxBWV9BQk9SVEVEJywgREhURXJyb3IuUkVMQVlfQUJPUlRFRCkKICB9CgogIHN0YXRpYyBTVVNQRU5ERUQobXNnID0gJ1N1c3BlbmRlZCcpIHsKICAgIHJldHVybiBuZXcgREhURXJyb3IobXNnLCAnU1VTUEVOREVEJywgREhURXJyb3IuU1VTUEVOREVEKQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBOYXQgPSByZXF1aXJlKCcuL25hdCcpCmNvbnN0IFNsZWVwZXIgPSByZXF1aXJlKCcuL3NsZWVwZXInKQpjb25zdCB7IEZJUkVXQUxMIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpCgpjb25zdCBCSVJUSERBWV9TT0NLRVRTID0gMjU2CmNvbnN0IEhPTEVQVU5DSCA9IGI0YS5mcm9tKFswXSkKY29uc3QgSE9MRVBVTkNIX1RUTCA9IDUKY29uc3QgREVGQVVMVF9UVEwgPSA2NApjb25zdCBNQVhfUkVPUEVOUyA9IDMKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSG9sZXB1bmNoZXIgewogIGNvbnN0cnVjdG9yKGRodCwgc2Vzc2lvbiwgaXNJbml0aWF0b3IsIHJlbW90ZUZpcmV3YWxsID0gRklSRVdBTEwuVU5LTk9XTikgewogICAgY29uc3QgaG9sZGVyID0gZGh0Ll9zb2NrZXRQb29sLmFjcXVpcmUoKQoKICAgIHRoaXMuZGh0ID0gZGh0CiAgICB0aGlzLnNlc3Npb24gPSBzZXNzaW9uCgogICAgdGhpcy5uYXQgPSBuZXcgTmF0KGRodCwgc2Vzc2lvbiwgaG9sZGVyLnNvY2tldCkKICAgIHRoaXMubmF0LmF1dG9TYW1wbGUoKQoKICAgIHRoaXMuaXNJbml0aWF0b3IgPSBpc0luaXRpYXRvcgoKICAgIC8vIGV2ZW50cwogICAgdGhpcy5vbmNvbm5lY3QgPSBub29wCiAgICB0aGlzLm9uYWJvcnQgPSBub29wCgogICAgdGhpcy5wdW5jaGluZyA9IGZhbHNlCiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLnJhbmRvbWl6ZWQgPSBmYWxzZQoKICAgIC8vIHRyYWNrIHJlbW90ZSBzdGF0ZQogICAgdGhpcy5yZW1vdGVGaXJld2FsbCA9IHJlbW90ZUZpcmV3YWxsCiAgICB0aGlzLnJlbW90ZUFkZHJlc3NlcyA9IFtdCiAgICB0aGlzLnJlbW90ZUhvbGVwdW5jaGluZyA9IGZhbHNlCgogICAgdGhpcy5fc2xlZXBlciA9IG5ldyBTbGVlcGVyKCkKICAgIHRoaXMuX3Jlb3BlbmluZyA9IG51bGwKICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB0aGlzLl9wdW5jaGluZyA9IG51bGwKICAgIHRoaXMuX2FsbEhvbGRlcnMgPSBbXQogICAgdGhpcy5faG9sZGVyID0gdGhpcy5fYWRkUmVmKGhvbGRlcikKICB9CgogIGdldCBzb2NrZXQoKSB7CiAgICByZXR1cm4gdGhpcy5faG9sZGVyLnNvY2tldAogIH0KCiAgdXBkYXRlUmVtb3RlKHsgcHVuY2hpbmcsIGZpcmV3YWxsLCBhZGRyZXNzZXMsIHZlcmlmaWVkIH0pIHsKICAgIGNvbnN0IHJlbW90ZUFkZHJlc3NlcyA9IFtdCgogICAgaWYgKGFkZHJlc3NlcykgewogICAgICBmb3IgKGNvbnN0IGFkZHIgb2YgYWRkcmVzc2VzKSB7CiAgICAgICAgcmVtb3RlQWRkcmVzc2VzLnB1c2goewogICAgICAgICAgaG9zdDogYWRkci5ob3N0LAogICAgICAgICAgcG9ydDogYWRkci5wb3J0LAogICAgICAgICAgdmVyaWZpZWQ6IHZlcmlmaWVkID09PSBhZGRyLmhvc3QgfHwgdGhpcy5faXNWZXJpZmllZChhZGRyLmhvc3QpCiAgICAgICAgfSkKICAgICAgfQogICAgfQoKICAgIHRoaXMucmVtb3RlRmlyZXdhbGwgPSBmaXJld2FsbAogICAgdGhpcy5yZW1vdGVBZGRyZXNzZXMgPSByZW1vdGVBZGRyZXNzZXMKICAgIHRoaXMucmVtb3RlSG9sZXB1bmNoaW5nID0gcHVuY2hpbmcKICB9CgogIF9pc1ZlcmlmaWVkKGhvc3QpIHsKICAgIGZvciAoY29uc3QgYWRkciBvZiB0aGlzLnJlbW90ZUFkZHJlc3NlcykgewogICAgICBpZiAoYWRkci52ZXJpZmllZCAmJiBhZGRyLmhvc3QgPT09IGhvc3QpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIHBpbmcoYWRkciwgc29ja2V0ID0gdGhpcy5faG9sZGVyLnNvY2tldCkgewogICAgcmV0dXJuIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIGZhbHNlKQogIH0KCiAgb3BlblNlc3Npb24oYWRkciwgc29ja2V0ID0gdGhpcy5faG9sZGVyLnNvY2tldCkgewogICAgcmV0dXJuIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIHRydWUpCiAgfQoKICBhc3luYyBhbmFseXplKGFsbG93UmVvcGVuKSB7CiAgICBhd2FpdCB0aGlzLm5hdC5hbmFseXppbmcKICAgIGlmICh0aGlzLl91bnN0YWJsZSgpKSB7CiAgICAgIGlmICghYWxsb3dSZW9wZW4pIHJldHVybiBmYWxzZQogICAgICBpZiAoIXRoaXMuX3Jlb3BlbmluZykgdGhpcy5fcmVvcGVuaW5nID0gdGhpcy5fcmVvcGVuKCkKICAgICAgcmV0dXJuIHRoaXMuX3Jlb3BlbmluZwogICAgfQogICAgcmV0dXJuIHRydWUKICB9CgogIF91bnN0YWJsZSgpIHsKICAgIC8vIFRPRE8hITogV2UgbmVlZCBhbiBhZGRpdGlvbmFsIGhldXJpc3RpYyBoZXJlLi4uIElmIHdlIHdlcmUgTk9UIHJhbmRvbSBpbiB0aGUgcGFzdCB3ZSBzaG91bGQgYWxzbyBkbyB0aGlzLgogICAgY29uc3QgZmlyZXdhbGwgPSB0aGlzLm5hdC5maXJld2FsbAogICAgcmV0dXJuICgKICAgICAgKHRoaXMucmVtb3RlRmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NICYmIGZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSkgfHwKICAgICAgZmlyZXdhbGwgPT09IEZJUkVXQUxMLlVOS05PV04KICAgICkKICB9CgogIF9yZXNldCgpIHsKICAgIGNvbnN0IHByZXYgPSB0aGlzLl9ob2xkZXIKCiAgICB0aGlzLl9hbGxIb2xkZXJzLnBvcCgpCiAgICB0aGlzLl9ob2xkZXIgPSB0aGlzLl9hZGRSZWYodGhpcy5kaHQuX3NvY2tldFBvb2wuYWNxdWlyZSgpKQoKICAgIHByZXYucmVsZWFzZSgpCiAgICB0aGlzLm5hdC5kZXN0cm95KCkKCiAgICB0aGlzLm5hdCA9IG5ldyBOYXQodGhpcy5kaHQsIHRoaXMuc2Vzc2lvbiwgdGhpcy5faG9sZGVyLnNvY2tldCkKICAgIC8vIFRPRE86IG1heWJlIG1ha2UgYXV0byBzYW1wbGluZyBjb25maWd1cmFibGUgc29tZWhvdz8KICAgIHRoaXMubmF0LmF1dG9TYW1wbGUoKQogIH0KCiAgX2FkZFJlZihyZWYpIHsKICAgIHRoaXMuX2FsbEhvbGRlcnMucHVzaChyZWYpCiAgICByZWYub25ob2xlcHVuY2htZXNzYWdlID0gKG1zZywgcmluZm8pID0+IHRoaXMuX29uaG9sZXB1bmNobWVzc2FnZShtc2csIHJpbmZvLCByZWYpCiAgICByZXR1cm4gcmVmCiAgfQoKICBfb25ob2xlcHVuY2htZXNzYWdlKF8sIGFkZHIsIHJlZikgewogICAgaWYgKCF0aGlzLmlzSW5pdGlhdG9yKSB7CiAgICAgIC8vIFRPRE86IHdlIGRvbid0IG5lZWQgdGhpcyBpZiB3ZSBoYWQgYSB3YXkgdG8gY29ubmVjdCBhIHNvY2tldCB0byBtYW55IGhvc3RzCiAgICAgIGhvbGVwdW5jaChyZWYuc29ja2V0LCBhZGRyLCBmYWxzZSkgLy8gbmV2ZXIgZmFpbHMKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuY29ubmVjdGVkKSByZXR1cm4KCiAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWUKICAgIHRoaXMucHVuY2hpbmcgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgciBvZiB0aGlzLl9hbGxIb2xkZXJzKSB7CiAgICAgIGlmIChyID09PSByZWYpIGNvbnRpbnVlCiAgICAgIHIucmVsZWFzZSgpCiAgICB9CgogICAgdGhpcy5fYWxsSG9sZGVyc1swXSA9IHJlZgogICAgd2hpbGUgKHRoaXMuX2FsbEhvbGRlcnMubGVuZ3RoID4gMSkgdGhpcy5fYWxsSG9sZGVycy5wb3AoKQoKICAgIHRoaXMuX2RlY3JlbWVudFJhbmRvbWl6ZWQoKQogICAgdGhpcy5vbmNvbm5lY3QocmVmLnNvY2tldCwgYWRkci5wb3J0LCBhZGRyLmhvc3QpCiAgfQoKICBfZG9uZSgpIHsKICAgIHJldHVybiB0aGlzLmRlc3Ryb3llZCB8fCB0aGlzLmNvbm5lY3RlZAogIH0KCiAgYXN5bmMgX3Jlb3BlbigpIHsKICAgIGZvciAobGV0IGkgPSAwOyB0aGlzLl91bnN0YWJsZSgpICYmIGkgPCBNQVhfUkVPUEVOUyAmJiAhdGhpcy5fZG9uZSgpICYmICF0aGlzLnB1bmNoaW5nOyBpKyspIHsKICAgICAgdGhpcy5fcmVzZXQoKQogICAgICBhd2FpdCB0aGlzLm5hdC5hbmFseXppbmcKICAgIH0KCiAgICByZXR1cm4gY29lcmNlRmlyZXdhbGwodGhpcy5uYXQuZmlyZXdhbGwpID09PSBGSVJFV0FMTC5DT05TSVNURU5UCiAgfQoKICBwdW5jaCgpIHsKICAgIGlmICghdGhpcy5fcHVuY2hpbmcpIHRoaXMuX3B1bmNoaW5nID0gdGhpcy5fcHVuY2goKQogICAgcmV0dXJuIHRoaXMuX3B1bmNoaW5nCiAgfQoKICBhc3luYyBfcHVuY2goKSB7CiAgICBpZiAodGhpcy5fZG9uZSgpIHx8ICF0aGlzLnJlbW90ZUFkZHJlc3Nlcy5sZW5ndGgpIHJldHVybiBmYWxzZQoKICAgIHRoaXMucHVuY2hpbmcgPSB0cnVlCgogICAgLy8gQ29lcmNlIGludG8gY29uc2lzdGVuY3kgZm9yIG5vdy4gT2J2cyB3ZSBjb3VsZCBtYWtlIHRoaXMgdGhpcyBtb3JlIGVmZmljaWVudCBpZiB3ZSB1c2UgdGhhdCBpbmZvCiAgICAvLyBidXQgdGhhdCdzIHNlbGRvbWx5IHVzZWQgc2luY2UgdGhvc2Ugd2lsbCBqdXN0IHVzZSB0Y3AgbW9zdCBvZiB0aGUgdGltZS4KCiAgICBjb25zdCBsb2NhbCA9IGNvZXJjZUZpcmV3YWxsKHRoaXMubmF0LmZpcmV3YWxsKQogICAgY29uc3QgcmVtb3RlID0gY29lcmNlRmlyZXdhbGwodGhpcy5yZW1vdGVGaXJld2FsbCkKCiAgICAvLyBOb3RlIHRoYXQgbW9zdCBvZiB0aGVzZSBhc3luYyBmdW5jdGlvbnMgYXJlIG1lYW50IHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZAogICAgLy8gd2hpY2ggaXMgd2h5IHdlIGRvbid0IGF3YWl0IHRoZW0gaGVyZSBhbmQgd2h5IHRoZXkgYXJlIG5vdCBhbGxvd2VkIHRvIHRocm93CgogICAgbGV0IHJlbW90ZVZlcmlmaWVkQWRkcmVzcyA9IG51bGwKICAgIGZvciAoY29uc3QgYWRkciBvZiB0aGlzLnJlbW90ZUFkZHJlc3NlcykgewogICAgICBpZiAoYWRkci52ZXJpZmllZCkgewogICAgICAgIHJlbW90ZVZlcmlmaWVkQWRkcmVzcyA9IGFkZHIKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKGxvY2FsID09PSBGSVJFV0FMTC5DT05TSVNURU5UICYmIHJlbW90ZSA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCkgewogICAgICB0aGlzLmRodC5zdGF0cy5wdW5jaGVzLmNvbnNpc3RlbnQrKwogICAgICB0aGlzLl9jb25zaXN0ZW50UHJvYmUoKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmICghcmVtb3RlVmVyaWZpZWRBZGRyZXNzKSByZXR1cm4gZmFsc2UKCiAgICBpZiAobG9jYWwgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQgJiYgcmVtb3RlID49IEZJUkVXQUxMLlJBTkRPTSkgewogICAgICB0aGlzLmRodC5zdGF0cy5wdW5jaGVzLnJhbmRvbSsrCiAgICAgIHRoaXMuX2luY3JlbWVudFJhbmRvbWl6ZWQoKQogICAgICB0aGlzLl9yYW5kb21Qcm9iZXMocmVtb3RlVmVyaWZpZWRBZGRyZXNzKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmIChsb2NhbCA+PSBGSVJFV0FMTC5SQU5ET00gJiYgcmVtb3RlID09PSBGSVJFV0FMTC5DT05TSVNURU5UKSB7CiAgICAgIHRoaXMuZGh0LnN0YXRzLnB1bmNoZXMucmFuZG9tKysKICAgICAgdGhpcy5faW5jcmVtZW50UmFuZG9taXplZCgpCiAgICAgIGF3YWl0IHRoaXMuX29wZW5CaXJ0aGRheVNvY2tldHMocmVtb3RlVmVyaWZpZWRBZGRyZXNzKQogICAgICBpZiAodGhpcy5wdW5jaGluZykgdGhpcy5fa2VlcEFsaXZlUmFuZG9tTmF0KHJlbW90ZVZlcmlmaWVkQWRkcmVzcykKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8vIE5vdGUgdGhhdCB0aGlzIG5ldmVyIHRocm93cyBzbyBpdCBpcyBzYWZlIHRvIHJ1biBpbiB0aGUgYmFja2dyb3VuZAogIGFzeW5jIF9jb25zaXN0ZW50UHJvYmUoKSB7CiAgICAvLyBIZXJlIHdlIGRvIHRoZSBzbGVlcCBmaXJzdCBiZWNhdXNlIHRoZSAiZmFzdCBvcGVuIiBtb2RlIGluIHRoZSBzZXJ2ZXIganVzdCBmaXJlZCBhIHBpbmcKICAgIGlmICghdGhpcy5pc0luaXRpYXRvcikgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgxMDAwKQoKICAgIGxldCB0cmllcyA9IDAKCiAgICB3aGlsZSAodGhpcy5wdW5jaGluZyAmJiB0cmllcysrIDwgMTApIHsKICAgICAgZm9yIChjb25zdCBhZGRyIG9mIHRoaXMucmVtb3RlQWRkcmVzc2VzKSB7CiAgICAgICAgLy8gb25seSB0cnkgdW52ZXJpZmllZCBhZGRyZXNzZXMgZXZlcnkgNCB0aWNrcwogICAgICAgIGlmICghYWRkci52ZXJpZmllZCAmJiAodHJpZXMgJiAzKSAhPT0gMCkgY29udGludWUKICAgICAgICBhd2FpdCBob2xlcHVuY2godGhpcy5faG9sZGVyLnNvY2tldCwgYWRkciwgZmFsc2UpCiAgICAgIH0KICAgICAgaWYgKHRoaXMucHVuY2hpbmcpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMTAwMCkKICAgIH0KCiAgICB0aGlzLl9hdXRvRGVzdHJveSgpCiAgfQoKICAvLyBOb3RlIHRoYXQgdGhpcyBuZXZlciB0aHJvd3Mgc28gaXQgaXMgc2FmZSB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICBhc3luYyBfcmFuZG9tUHJvYmVzKHJlbW90ZUFkZHIpIHsKICAgIGxldCB0cmllcyA9IDE3NTAgLy8gfjM1cwoKICAgIHdoaWxlICh0aGlzLnB1bmNoaW5nICYmIHRyaWVzLS0gPiAwKSB7CiAgICAgIGNvbnN0IGFkZHIgPSB7IGhvc3Q6IHJlbW90ZUFkZHIuaG9zdCwgcG9ydDogcmFuZG9tUG9ydCgpIH0KICAgICAgYXdhaXQgaG9sZXB1bmNoKHRoaXMuX2hvbGRlci5zb2NrZXQsIGFkZHIsIGZhbHNlKQogICAgICBpZiAodGhpcy5wdW5jaGluZykgYXdhaXQgdGhpcy5fc2xlZXBlci5wYXVzZSgyMCkKICAgIH0KCiAgICB0aGlzLl9hdXRvRGVzdHJveSgpCiAgfQoKICAvLyBOb3RlIHRoYXQgdGhpcyBuZXZlciB0aHJvd3Mgc28gaXQgaXMgc2FmZSB0byBydW4gaW4gdGhlIGJhY2tncm91bmQKICBhc3luYyBfa2VlcEFsaXZlUmFuZG9tTmF0KHJlbW90ZUFkZHIpIHsKICAgIGxldCBpID0gMAogICAgbGV0IGxvd1RUTFJvdW5kcyA9IDEKCiAgICAvLyBUT0RPOiBleHBlcmltZW50IHdpdGggdGhpcyBoZXJlLiBXZSBqdXN0IGJ1cnN0ZWQgYWxsIHRoZSBtZXNzYWdlcyBpbgogICAgLy8gb3Blbk90aGVyU29ja2V0cyB0byBlbnN1cmUgdGhlIHNvY2tldHMgYXJlIG9wZW4sIHNvIGl0J3MgcG90ZW50aWFsbHkKICAgIC8vIGEgZ29vZCBpZGVhIHRvIHNsb3cgZG93biBmb3IgYSBiaXQuCiAgICBhd2FpdCB0aGlzLl9zbGVlcGVyLnBhdXNlKDEwMCkKCiAgICBsZXQgdHJpZXMgPSAxNzUwIC8vIH4zNXMKCiAgICB3aGlsZSAodGhpcy5wdW5jaGluZyAmJiB0cmllcy0tID4gMCkgewogICAgICBpZiAoaSA9PT0gdGhpcy5fYWxsSG9sZGVycy5sZW5ndGgpIHsKICAgICAgICBpID0gMAogICAgICAgIGlmIChsb3dUVExSb3VuZHMgPiAwKSBsb3dUVExSb3VuZHMtLQogICAgICB9CgogICAgICBhd2FpdCBob2xlcHVuY2godGhpcy5fYWxsSG9sZGVyc1tpKytdLnNvY2tldCwgcmVtb3RlQWRkciwgbG93VFRMUm91bmRzID4gMCkKICAgICAgaWYgKHRoaXMucHVuY2hpbmcpIGF3YWl0IHRoaXMuX3NsZWVwZXIucGF1c2UoMjApCiAgICB9CgogICAgdGhpcy5fYXV0b0Rlc3Ryb3koKQogIH0KCiAgYXN5bmMgX29wZW5CaXJ0aGRheVNvY2tldHMocmVtb3RlQWRkcikgewogICAgd2hpbGUgKHRoaXMucHVuY2hpbmcgJiYgdGhpcy5fYWxsSG9sZGVycy5sZW5ndGggPCBCSVJUSERBWV9TT0NLRVRTKSB7CiAgICAgIGNvbnN0IHJlZiA9IHRoaXMuX2FkZFJlZih0aGlzLmRodC5fc29ja2V0UG9vbC5hY3F1aXJlKCkpCiAgICAgIGF3YWl0IGhvbGVwdW5jaChyZWYuc29ja2V0LCByZW1vdGVBZGRyLCBIT0xFUFVOQ0hfVFRMKQogICAgfQogIH0KCiAgX2F1dG9EZXN0cm95KCkgewogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCkgdGhpcy5kZXN0cm95KCkKICB9CgogIF9pbmNyZW1lbnRSYW5kb21pemVkKCkgewogICAgaWYgKCF0aGlzLnJhbmRvbWl6ZWQpIHsKICAgICAgdGhpcy5yYW5kb21pemVkID0gdHJ1ZQogICAgICB0aGlzLmRodC5fcmFuZG9tUHVuY2hlcysrCiAgICB9CiAgfQoKICBfZGVjcmVtZW50UmFuZG9taXplZCgpIHsKICAgIGlmICh0aGlzLnJhbmRvbWl6ZWQpIHsKICAgICAgdGhpcy5kaHQuX2xhc3RSYW5kb21QdW5jaCA9IERhdGUubm93KCkKICAgICAgdGhpcy5yYW5kb21pemVkID0gZmFsc2UKICAgICAgdGhpcy5kaHQuX3JhbmRvbVB1bmNoZXMtLQogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMucHVuY2hpbmcgPSBmYWxzZQoKICAgIGZvciAoY29uc3QgcmVmIG9mIHRoaXMuX2FsbEhvbGRlcnMpIHJlZi5yZWxlYXNlKCkKICAgIHRoaXMuX2FsbEhvbGRlcnMgPSBbXQogICAgdGhpcy5uYXQuZGVzdHJveSgpCgogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCkgewogICAgICB0aGlzLl9kZWNyZW1lbnRSYW5kb21pemVkKCkKICAgICAgdGhpcy5vbmFib3J0KCkKICAgIH0KICB9CgogIHN0YXRpYyBwaW5nKHNvY2tldCwgYWRkcikgewogICAgcmV0dXJuIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIGZhbHNlKQogIH0KCiAgc3RhdGljIGxvY2FsQWRkcmVzc2VzKHNvY2tldCkgewogICAgcmV0dXJuIGxvY2FsQWRkcmVzc2VzKHNvY2tldCkKICB9CgogIHN0YXRpYyBtYXRjaEFkZHJlc3MobXlBZGRyZXNzZXMsIGV4dGVybmFsQWRkcmVzc2VzKSB7CiAgICByZXR1cm4gbWF0Y2hBZGRyZXNzKG15QWRkcmVzc2VzLCBleHRlcm5hbEFkZHJlc3NlcykKICB9Cn0KCmZ1bmN0aW9uIGhvbGVwdW5jaChzb2NrZXQsIGFkZHIsIGxvd1RUTCkgewogIHJldHVybiBzb2NrZXQuc2VuZChIT0xFUFVOQ0gsIGFkZHIucG9ydCwgYWRkci5ob3N0LCBsb3dUVEwgPyBIT0xFUFVOQ0hfVFRMIDogREVGQVVMVF9UVEwpCn0KCmZ1bmN0aW9uIHJhbmRvbVBvcnQoKSB7CiAgcmV0dXJuICgxMDAwICsgTWF0aC5yYW5kb20oKSAqIDY0NTM2KSB8IDAKfQoKZnVuY3Rpb24gY29lcmNlRmlyZXdhbGwoZncpIHsKICByZXR1cm4gZncgPT09IEZJUkVXQUxMLk9QRU4gPyBGSVJFV0FMTC5DT05TSVNURU5UIDogZncKfQoKZnVuY3Rpb24gbG9jYWxBZGRyZXNzZXMoc29ja2V0KSB7CiAgY29uc3QgYWRkcnMgPSBbXQogIGNvbnN0IHsgaG9zdCwgcG9ydCB9ID0gc29ja2V0LmFkZHJlc3MoKQoKICBpZiAoaG9zdCA9PT0gJzEyNy4wLjAuMScpIHJldHVybiBbeyBob3N0LCBwb3J0IH1dCgogIGZvciAoY29uc3QgbiBvZiBzb2NrZXQudWR4Lm5ldHdvcmtJbnRlcmZhY2VzKCkpIHsKICAgIGlmIChuLmZhbWlseSAhPT0gNCB8fCBuLmludGVybmFsKSBjb250aW51ZQoKICAgIGFkZHJzLnB1c2goeyBob3N0OiBuLmhvc3QsIHBvcnQgfSkKICB9CgogIGlmIChhZGRycy5sZW5ndGggPT09IDApIHsKICAgIGFkZHJzLnB1c2goeyBob3N0OiAnMTI3LjAuMC4xJywgcG9ydCB9KQogIH0KCiAgcmV0dXJuIGFkZHJzCn0KCmZ1bmN0aW9uIG1hdGNoQWRkcmVzcyhsb2NhbEFkZHJlc3NlcywgcmVtb3RlTG9jYWxBZGRyZXNzZXMpIHsKICBpZiAocmVtb3RlTG9jYWxBZGRyZXNzZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbAoKICBsZXQgYmVzdCA9IHsgc2VnbWVudDogMSwgYWRkcjogbnVsbCB9CgogIGZvciAoY29uc3QgbG9jYWxBZGRyZXNzIG9mIGxvY2FsQWRkcmVzc2VzKSB7CiAgICAvLyA9PiAxOTIuMTY4LjEyMi4yMzgKICAgIGNvbnN0IGEgPSBsb2NhbEFkZHJlc3MuaG9zdC5zcGxpdCgnLicpCgogICAgZm9yIChjb25zdCByZW1vdGVBZGRyZXNzIG9mIHJlbW90ZUxvY2FsQWRkcmVzc2VzKSB7CiAgICAgIC8vID0+IDE5Mi4xNjguMC4yMwogICAgICAvLyA9PiAxOTIuMTY4LjEyMi4xCiAgICAgIGNvbnN0IGIgPSByZW1vdGVBZGRyZXNzLmhvc3Quc3BsaXQoJy4nKQoKICAgICAgLy8gTWF0Y2hlcyAxOTIuKi4qLioKICAgICAgaWYgKGFbMF0gPT09IGJbMF0pIHsKICAgICAgICBpZiAoYmVzdC5zZWdtZW50ID09PSAxKSBiZXN0ID0geyBzZWdtZW50OiAyLCBhZGRyOiByZW1vdGVBZGRyZXNzIH0KCiAgICAgICAgLy8gTWF0Y2hlcyAxOTIuMTY4LiouKgogICAgICAgIGlmIChhWzFdID09PSBiWzFdKSB7CiAgICAgICAgICBpZiAoYmVzdC5zZWdtZW50ID09PSAyKSBiZXN0ID0geyBzZWdtZW50OiAzLCBhZGRyOiByZW1vdGVBZGRyZXNzIH0KCiAgICAgICAgICAvLyBNYXRjaGVzIDE5Mi4xNjguMTIyLioKICAgICAgICAgIGlmIChhWzJdID09PSBiWzJdKSByZXR1cm4gcmVtb3RlQWRkcmVzcwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIGJlc3QuYWRkcgp9CgpmdW5jdGlvbiBub29wKCkge30KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBuZXQgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nLW5ldCcpCgpjb25zdCBpcHY0ID0gewogIC4uLm5ldC5pcHY0QWRkcmVzcywKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGlwID0gbmV0LmlwdjRBZGRyZXNzLmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIGhvc3Q6IGlwLmhvc3QsCiAgICAgIHBvcnQ6IGlwLnBvcnQKICAgIH0KICB9Cn0KCmNvbnN0IGlwdjRBcnJheSA9IGMuYXJyYXkoaXB2NCkKCmNvbnN0IGlwdjYgPSB7CiAgLi4ubmV0LmlwdjZBZGRyZXNzLAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgaXAgPSBuZXQuaXB2NkFkZHJlc3MuZGVjb2RlKHN0YXRlKQogICAgcmV0dXJuIHsKICAgICAgaG9zdDogaXAuaG9zdCwKICAgICAgcG9ydDogaXAucG9ydAogICAgfQogIH0KfQoKY29uc3QgaXB2NkFycmF5ID0gYy5hcnJheShpcHY2KQoKZXhwb3J0cy5oYW5kc2hha2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gMSArIDEgKyAobS5wZWVyQWRkcmVzcyA/IDYgOiAwKSArIChtLnJlbGF5QWRkcmVzcyA/IDYgOiAwKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLm5vaXNlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IChtLnBlZXJBZGRyZXNzID8gMSA6IDApIHwgKG0ucmVsYXlBZGRyZXNzID8gMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLm1vZGUpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0ubm9pc2UpCgogICAgaWYgKG0ucGVlckFkZHJlc3MpIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnBlZXJBZGRyZXNzKQogICAgaWYgKG0ucmVsYXlBZGRyZXNzKSBpcHY0LmVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBtb2RlOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgbm9pc2U6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHBlZXJBZGRyZXNzOiBmbGFncyAmIDEgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZWxheUFkZHJlc3M6IGZsYWdzICYgMiA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IHJlbGF5SW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSAxMgogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBpcHY0LmVuY29kZShzdGF0ZSwgbS5yZWxheUFkZHJlc3MpCiAgICBpcHY0LmVuY29kZShzdGF0ZSwgbS5wZWVyQWRkcmVzcykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVsYXlBZGRyZXNzOiBpcHY0LmRlY29kZShzdGF0ZSksCiAgICAgIHBlZXJBZGRyZXNzOiBpcHY0LmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmNvbnN0IHJlbGF5SW5mb0FycmF5ID0gYy5hcnJheShyZWxheUluZm8pCgpjb25zdCBob2xlcHVuY2hJbmZvID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIHJlbGF5SW5mb0FycmF5LnByZWVuY29kZShzdGF0ZSwgbS5yZWxheXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uaWQpCiAgICByZWxheUluZm9BcnJheS5lbmNvZGUoc3RhdGUsIG0ucmVsYXlzKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJlbGF5czogcmVsYXlJbmZvQXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgdWR4SW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHN0YXRlLmVuZCArPSAyIC8vIHZlcnNpb24gKyBmZWF0dXJlcwogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCAxKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5yZXVzYWJsZVNvY2tldCA/IDEgOiAwKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGZlYXR1cmVzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICByZXVzYWJsZVNvY2tldDogKGZlYXR1cmVzICYgMSkgIT09IDAsCiAgICAgIGlkOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgc2VxOiBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3Qgc2VjcmV0U3RyZWFtSW5mbyA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIDEpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9Cgpjb25zdCByZWxheVRocm91Z2hJbmZvID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMSkgLy8gdmVyc2lvbgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgMCkgLy8gZmxhZ3MKICAgIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0ucHVibGljS2V5KQogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS50b2tlbikKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgMSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDApCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0udG9rZW4pCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICB2ZXJzaW9uLAogICAgICBwdWJsaWNLZXk6IGMuZml4ZWQzMi5kZWNvZGUoc3RhdGUpLAogICAgICB0b2tlbjogYy5maXhlZDMyLmRlY29kZShzdGF0ZSkKICAgIH0KICB9Cn0KCmV4cG9ydHMubm9pc2VQYXlsb2FkID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDQgLy8gdmVyc2lvbiArIGZsYWdzICsgZXJyb3IgKyBmaXJld2FsbAogICAgaWYgKG0uaG9sZXB1bmNoKSBob2xlcHVuY2hJbmZvLnByZWVuY29kZShzdGF0ZSwgbS5ob2xlcHVuY2gpCiAgICBpZiAobS5hZGRyZXNzZXM0ICYmIG0uYWRkcmVzc2VzNC5sZW5ndGgpIGlwdjRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzNCkKICAgIGlmIChtLmFkZHJlc3NlczYgJiYgbS5hZGRyZXNzZXM2Lmxlbmd0aCkgaXB2NkFycmF5LnByZWVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXM2KQogICAgaWYgKG0udWR4KSB1ZHhJbmZvLnByZWVuY29kZShzdGF0ZSwgbS51ZHgpCiAgICBpZiAobS5zZWNyZXRTdHJlYW0pIHNlY3JldFN0cmVhbUluZm8ucHJlZW5jb2RlKHN0YXRlLCBtLnNlY3JldFN0cmVhbSkKICAgIGlmIChtLnJlbGF5VGhyb3VnaCkgcmVsYXlUaHJvdWdoSW5mby5wcmVlbmNvZGUoc3RhdGUsIG0ucmVsYXlUaHJvdWdoKQogICAgaWYgKG0ucmVsYXlBZGRyZXNzZXMpIGlwdjRBcnJheS5wcmVlbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzZXMpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGxldCBmbGFncyA9IDAKCiAgICBpZiAobS5ob2xlcHVuY2gpIGZsYWdzIHw9IDEKICAgIGlmIChtLmFkZHJlc3NlczQgJiYgbS5hZGRyZXNzZXM0Lmxlbmd0aCkgZmxhZ3MgfD0gMgogICAgaWYgKG0uYWRkcmVzc2VzNiAmJiBtLmFkZHJlc3NlczYubGVuZ3RoKSBmbGFncyB8PSA0CiAgICBpZiAobS51ZHgpIGZsYWdzIHw9IDgKICAgIGlmIChtLnNlY3JldFN0cmVhbSkgZmxhZ3MgfD0gMTYKICAgIGlmIChtLnJlbGF5VGhyb3VnaCkgZmxhZ3MgfD0gMzIKICAgIGlmIChtLnJlbGF5QWRkcmVzc2VzKSBmbGFncyB8PSA2NAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIDEpIC8vIHZlcnNpb24KICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5lcnJvcikKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uZmlyZXdhbGwpCgogICAgaWYgKG0uaG9sZXB1bmNoKSBob2xlcHVuY2hJbmZvLmVuY29kZShzdGF0ZSwgbS5ob2xlcHVuY2gpCiAgICBpZiAobS5hZGRyZXNzZXM0ICYmIG0uYWRkcmVzc2VzNC5sZW5ndGgpIGlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIG0uYWRkcmVzc2VzNCkKICAgIGlmIChtLmFkZHJlc3NlczYgJiYgbS5hZGRyZXNzZXM2Lmxlbmd0aCkgaXB2NkFycmF5LmVuY29kZShzdGF0ZSwgbS5hZGRyZXNzZXM2KQogICAgaWYgKG0udWR4KSB1ZHhJbmZvLmVuY29kZShzdGF0ZSwgbS51ZHgpCiAgICBpZiAobS5zZWNyZXRTdHJlYW0pIHNlY3JldFN0cmVhbUluZm8uZW5jb2RlKHN0YXRlLCBtLnNlY3JldFN0cmVhbSkKICAgIGlmIChtLnJlbGF5VGhyb3VnaCkgcmVsYXlUaHJvdWdoSW5mby5lbmNvZGUoc3RhdGUsIG0ucmVsYXlUaHJvdWdoKQogICAgaWYgKG0ucmVsYXlBZGRyZXNzZXMpIGlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IHZlcnNpb24gPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIGlmICh2ZXJzaW9uICE9PSAxKSB7CiAgICAgIC8vIERvIG5vdCBhdHRlbXB0IHRvIGRlY29kZSBidXQgcmV0dXJuIHRoaXMgYmFjayB0byB0aGUgdXNlciBzbyB0aGV5IGNhbgogICAgICAvLyBhY3R1YWxseSBoYW5kbGUgaXQKICAgICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGVycm9yOiAwLAogICAgICAgIGZpcmV3YWxsOiAwLAogICAgICAgIGhvbGVwdW5jaDogbnVsbCwKICAgICAgICBhZGRyZXNzZXM0OiBbXSwKICAgICAgICBhZGRyZXNzZXM2OiBbXSwKICAgICAgICB1ZHg6IG51bGwsCiAgICAgICAgc2VjcmV0U3RyZWFtOiBudWxsLAogICAgICAgIHJlbGF5VGhyb3VnaDogbnVsbCwKICAgICAgICByZWxheUFkZHJlc3NlczogbnVsbAogICAgICB9CiAgICB9CgogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb24sCiAgICAgIGVycm9yOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgZmlyZXdhbGw6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBob2xlcHVuY2g6IChmbGFncyAmIDEpICE9PSAwID8gaG9sZXB1bmNoSW5mby5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgYWRkcmVzc2VzNDogKGZsYWdzICYgMikgIT09IDAgPyBpcHY0QXJyYXkuZGVjb2RlKHN0YXRlKSA6IFtdLAogICAgICBhZGRyZXNzZXM2OiAoZmxhZ3MgJiA0KSAhPT0gMCA/IGlwdjZBcnJheS5kZWNvZGUoc3RhdGUpIDogW10sCiAgICAgIHVkeDogKGZsYWdzICYgOCkgIT09IDAgPyB1ZHhJbmZvLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzZWNyZXRTdHJlYW06IChmbGFncyAmIDE2KSAhPT0gMCA/IHNlY3JldFN0cmVhbUluZm8uZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlbGF5VGhyb3VnaDogKGZsYWdzICYgMzIpICE9PSAwID8gcmVsYXlUaHJvdWdoSW5mby5kZWNvZGUoc3RhdGUpIDogbnVsbCwKICAgICAgcmVsYXlBZGRyZXNzZXM6IChmbGFncyAmIDY0KSAhPT0gMCA/IGlwdjRBcnJheS5kZWNvZGUoc3RhdGUpIDogbnVsbAogICAgfQogIH0KfQoKZXhwb3J0cy5ob2xlcHVuY2ggPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gMgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgbS5pZCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS5wYXlsb2FkKQogICAgaWYgKG0ucGVlckFkZHJlc3MpIGlwdjQucHJlZW5jb2RlKHN0YXRlLCBtLnBlZXJBZGRyZXNzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0ucGVlckFkZHJlc3MgPyAxIDogMAogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLm1vZGUpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmlkKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnBheWxvYWQpCiAgICBpZiAobS5wZWVyQWRkcmVzcykgaXB2NC5lbmNvZGUoc3RhdGUsIG0ucGVlckFkZHJlc3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgIHJldHVybiB7CiAgICAgIG1vZGU6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBpZDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHBheWxvYWQ6IGMuYnVmZmVyLmRlY29kZShzdGF0ZSksCiAgICAgIHBlZXJBZGRyZXNzOiBmbGFncyAmIDEgPyBpcHY0LmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgpleHBvcnRzLmhvbGVwdW5jaFBheWxvYWQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQgKz0gNCAvLyBmbGFncyArIGVycm9yICsgZmlyZXdhbGwgKyByb3VuZAogICAgaWYgKG0uYWRkcmVzc2VzKSBpcHY0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlcykKICAgIGlmIChtLnJlbW90ZUFkZHJlc3MpIHN0YXRlLmVuZCArPSA2CiAgICBpZiAobS50b2tlbikgc3RhdGUuZW5kICs9IDMyCiAgICBpZiAobS5yZW1vdGVUb2tlbikgc3RhdGUuZW5kICs9IDMyCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGNvbnN0IGZsYWdzID0KICAgICAgKG0uY29ubmVjdGVkID8gMSA6IDApIHwKICAgICAgKG0ucHVuY2hpbmcgPyAyIDogMCkgfAogICAgICAobS5hZGRyZXNzZXMgPyA0IDogMCkgfAogICAgICAobS5yZW1vdGVBZGRyZXNzID8gOCA6IDApIHwKICAgICAgKG0udG9rZW4gPyAxNiA6IDApIHwKICAgICAgKG0ucmVtb3RlVG9rZW4gPyAzMiA6IDApCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmVycm9yKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5maXJld2FsbCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0ucm91bmQpCgogICAgaWYgKG0uYWRkcmVzc2VzKSBpcHY0QXJyYXkuZW5jb2RlKHN0YXRlLCBtLmFkZHJlc3NlcykKICAgIGlmIChtLnJlbW90ZUFkZHJlc3MpIGlwdjQuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZUFkZHJlc3MpCiAgICBpZiAobS50b2tlbikgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS50b2tlbikKICAgIGlmIChtLnJlbW90ZVRva2VuKSBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnJlbW90ZVRva2VuKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICBjb25zdCBmbGFncyA9IGMudWludC5kZWNvZGUoc3RhdGUpCgogICAgcmV0dXJuIHsKICAgICAgZXJyb3I6IGMudWludC5kZWNvZGUoc3RhdGUpLAogICAgICBmaXJld2FsbDogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHJvdW5kOiBjLnVpbnQuZGVjb2RlKHN0YXRlKSwKICAgICAgY29ubmVjdGVkOiAoZmxhZ3MgJiAxKSAhPT0gMCwKICAgICAgcHVuY2hpbmc6IChmbGFncyAmIDIpICE9PSAwLAogICAgICBhZGRyZXNzZXM6IChmbGFncyAmIDQpICE9PSAwID8gaXB2NEFycmF5LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICByZW1vdGVBZGRyZXNzOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGlwdjQuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHRva2VuOiAoZmxhZ3MgJiAxNikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlbW90ZVRva2VuOiAoZmxhZ3MgJiAzMikgIT09IDAgPyBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKSA6IG51bGwKICAgIH0KICB9Cn0KCmNvbnN0IHBlZXIgPSAoZXhwb3J0cy5wZWVyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kICs9IDMyCiAgICBpcHY0QXJyYXkucHJlZW5jb2RlKHN0YXRlLCBtLnJlbGF5QWRkcmVzc2VzKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGlwdjRBcnJheS5lbmNvZGUoc3RhdGUsIG0ucmVsYXlBZGRyZXNzZXMpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHJlbGF5QWRkcmVzc2VzOiBpcHY0QXJyYXkuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfSkKCmNvbnN0IHBlZXJzID0gKGV4cG9ydHMucGVlcnMgPSBjLmFycmF5KHBlZXIpKQoKY29uc3QgcmF3UGVlcnMgPSBjLmFycmF5KGMucmF3KQoKZXhwb3J0cy5sb29rdXBSYXdSZXBseSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIHJhd1BlZXJzLnByZWVuY29kZShzdGF0ZSwgbS5wZWVycykKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYnVtcCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgcmF3UGVlcnMuZW5jb2RlKHN0YXRlLCBtLnBlZXJzKQogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5idW1wKQogIH0sCiAgZGVjb2RlKHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICBwZWVyczogcGVlcnMuZGVjb2RlKHN0YXRlKSwKICAgICAgYnVtcDogc3RhdGUuc3RhcnQgPCBzdGF0ZS5lbmQgPyBjLnVpbnQuZGVjb2RlKHN0YXRlKSA6IDAKICAgIH0KICB9Cn0KCmV4cG9ydHMuYW5ub3VuY2UgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBmbGFncwogICAgaWYgKG0ucGVlcikgcGVlci5wcmVlbmNvZGUoc3RhdGUsIG0ucGVlcikKICAgIGlmIChtLnJlZnJlc2gpIHN0YXRlLmVuZCArPSAzMgogICAgaWYgKG0uc2lnbmF0dXJlKSBzdGF0ZS5lbmQgKz0gNjQKICAgIGlmIChtLmJ1bXApIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uYnVtcCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSAobS5wZWVyID8gMSA6IDApIHwgKG0ucmVmcmVzaCA/IDIgOiAwKSB8IChtLnNpZ25hdHVyZSA/IDQgOiAwKSB8IChtLmJ1bXAgPyA4IDogMCkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQogICAgaWYgKG0ucGVlcikgcGVlci5lbmNvZGUoc3RhdGUsIG0ucGVlcikKICAgIGlmIChtLnJlZnJlc2gpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0ucmVmcmVzaCkKICAgIGlmIChtLnNpZ25hdHVyZSkgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgICBpZiAobS5idW1wKSBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmJ1bXApCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBwZWVyOiAoZmxhZ3MgJiAxKSAhPT0gMCA/IHBlZXIuZGVjb2RlKHN0YXRlKSA6IG51bGwsCiAgICAgIHJlZnJlc2g6IChmbGFncyAmIDIpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBzaWduYXR1cmU6IChmbGFncyAmIDQpICE9PSAwID8gYy5maXhlZDY0LmRlY29kZShzdGF0ZSkgOiBudWxsLAogICAgICBidW1wOiAoZmxhZ3MgJiA4KSAhPT0gMCA/IGMudWludC5kZWNvZGUoc3RhdGUpIDogMAogICAgfQogIH0KfQoKZXhwb3J0cy5tdXRhYmxlU2lnbmFibGUgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy51aW50LmVuY29kZShzdGF0ZSwgbS5zZXEpCiAgICBjLmJ1ZmZlci5lbmNvZGUoc3RhdGUsIG0udmFsdWUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm11dGFibGVQdXRSZXF1ZXN0ID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5wdWJsaWNLZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnNlcSkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgbS52YWx1ZSkKICAgIGMuZml4ZWQ2NC5wcmVlbmNvZGUoc3RhdGUsIG0uc2lnbmF0dXJlKQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLnB1YmxpY0tleSkKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogYy5maXhlZDMyLmRlY29kZShzdGF0ZSksCiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CgpleHBvcnRzLm11dGFibGVHZXRSZXNwb25zZSA9IHsKICBwcmVlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5wcmVlbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIucHJlZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogICAgYy5maXhlZDY0LnByZWVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBlbmNvZGUoc3RhdGUsIG0pIHsKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIG0uc2VxKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCBtLnZhbHVlKQogICAgYy5maXhlZDY0LmVuY29kZShzdGF0ZSwgbS5zaWduYXR1cmUpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNlcTogYy51aW50LmRlY29kZShzdGF0ZSksCiAgICAgIHZhbHVlOiBjLmJ1ZmZlci5kZWNvZGUoc3RhdGUpLAogICAgICBzaWduYXR1cmU6IGMuZml4ZWQ2NC5kZWNvZGUoc3RhdGUpCiAgICB9CiAgfQp9CmNvbnN0IHsgRklSRVdBTEwgfSA9IHJlcXVpcmUoJy4uL2xpYi9jb25zdGFudHMnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOYXQgewogIGNvbnN0cnVjdG9yKGRodCwgc2Vzc2lvbiwgc29ja2V0KSB7CiAgICB0aGlzLl9zYW1wbGVzSG9zdCA9IFtdCiAgICB0aGlzLl9zYW1wbGVzRnVsbCA9IFtdCiAgICB0aGlzLl92aXNpdGVkID0gbmV3IE1hcCgpCiAgICB0aGlzLl9yZXNvbHZlID0gbnVsbAogICAgdGhpcy5fbWluU2FtcGxlcyA9IDQKICAgIHRoaXMuX2F1dG9TYW1wbGluZyA9IGZhbHNlCgogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb24KICAgIHRoaXMuc29ja2V0ID0gc29ja2V0CgogICAgdGhpcy5zYW1wbGVkID0gMAogICAgdGhpcy5maXJld2FsbCA9IGRodC5maXJld2FsbGVkID8gRklSRVdBTEwuVU5LTk9XTiA6IEZJUkVXQUxMLk9QRU4KICAgIHRoaXMuYWRkcmVzc2VzID0gbnVsbAoKICAgIHRoaXMuYW5hbHl6aW5nID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICAgIH0pCiAgfQoKICBhdXRvU2FtcGxlKHJldHJ5ID0gdHJ1ZSkgewogICAgaWYgKHRoaXMuX2F1dG9TYW1wbGluZykgcmV0dXJuCiAgICB0aGlzLl9hdXRvU2FtcGxpbmcgPSB0cnVlCgogICAgY29uc3Qgc2VsZiA9IHRoaXMKICAgIGNvbnN0IHNvY2tldCA9IHRoaXMuc29ja2V0CiAgICBjb25zdCBtYXhQaW5ncyA9IHRoaXMuX21pblNhbXBsZXMKCiAgICBsZXQgc2tpcCA9IHRoaXMuZGh0Lm5vZGVzLmxlbmd0aCA+PSA4ID8gNSA6IDAKICAgIGxldCBwZW5kaW5nID0gMAoKICAgIC8vIFRPRE86IGl0IHdvdWxkIGJlIGJlc3QgdG8gcGljayB0aGUgbm9kZXMgdG8gaGVscCB1cyBiYXNlZCBvbiBsYXRlbmN5IHRvIHVzCiAgICAvLyBUaGF0IHNob3VsZCByZWR1Y2UgY29ubmVjdCBsYXRlbmN5IGluIGdlbmVyYWwuIFdlIHNob3VsZCBpbnZlc3RpZ2F0ZSB0cmFja2luZyB0aGF0IGxhdGVyIG9uLgoKICAgIC8vIFRPRE8gMjogdHJ5IHRvIHBpY2sgbm9kZXMgd2l0aCBkaWZmZXJlbnQgSVBzIGFzIHdlbGwsIGFzIHRoYXQnbGwgaGVscCBtdWx0aSBJUCBjZWxsIGNvbm5lY3Rpb25zLi4uCiAgICAvLyBJZiB3ZSBleHBvc2UgdGhpcyBmcm9tIHRoZSBuYXQgc2FtcGxlciB0aGVuIHRoZSBESFQgc2hvdWxkIGJlIGFibGUgdG8gaGVscCB1cyBmaWx0ZXIgb3V0IHNjYW1zIGFzIHdlbGwuLi4KCiAgICBmb3IgKAogICAgICBsZXQgbm9kZSA9IHRoaXMuZGh0Lm5vZGVzLmxhdGVzdDsKICAgICAgbm9kZSAmJiB0aGlzLnNhbXBsZWQgKyBwZW5kaW5nIDwgbWF4UGluZ3M7CiAgICAgIG5vZGUgPSBub2RlLnByZXYKICAgICkgewogICAgICBpZiAoc2tpcCA+IDApIHsKICAgICAgICBza2lwLS0KICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBjb25zdCByZWYgPSBub2RlLmhvc3QgKyAnOicgKyBub2RlLnBvcnQKCiAgICAgIGlmICh0aGlzLl92aXNpdGVkLmhhcyhyZWYpKSBjb250aW51ZQogICAgICB0aGlzLl92aXNpdGVkLnNldChyZWYsIDEpCgogICAgICBwZW5kaW5nKysKICAgICAgdGhpcy5zZXNzaW9uLnBpbmcobm9kZSwgeyBzb2NrZXQsIHJldHJ5OiBmYWxzZSB9KS50aGVuKG9ucG9uZywgb25za2lwKQogICAgfQoKICAgIHBlbmRpbmcrKwogICAgb25za2lwKCkKCiAgICBmdW5jdGlvbiBvbnBvbmcocmVzKSB7CiAgICAgIHNlbGYuYWRkKHJlcy50bywgcmVzLmZyb20pCiAgICAgIG9uc2tpcCgpCiAgICB9CgogICAgZnVuY3Rpb24gb25za2lwKCkgewogICAgICBpZiAoLS1wZW5kaW5nID09PSAwICYmIHNlbGYuc2FtcGxlZCA8IHNlbGYuX21pblNhbXBsZXMpIHsKICAgICAgICBpZiAocmV0cnkpIHsKICAgICAgICAgIHNlbGYuX2F1dG9TYW1wbGluZyA9IGZhbHNlCiAgICAgICAgICBzZWxmLmF1dG9TYW1wbGUoZmFsc2UpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgc2VsZi5fcmVzb2x2ZSgpCiAgICAgIH0KICAgIH0KICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLl9hdXRvU2FtcGxpbmcgPSB0cnVlCiAgICB0aGlzLl9taW5TYW1wbGVzID0gMAogICAgdGhpcy5fcmVzb2x2ZSgpCiAgfQoKICB1bmZyZWV6ZSgpIHsKICAgIHRoaXMuZnJvemVuID0gZmFsc2UKICAgIHRoaXMuX3VwZGF0ZUZpcmV3YWxsKCkKICAgIHRoaXMuX3VwZGF0ZUFkZHJlc3NlcygpCiAgfQoKICBmcmVlemUoKSB7CiAgICB0aGlzLmZyb3plbiA9IHRydWUKICB9CgogIF91cGRhdGVGaXJld2FsbCgpIHsKICAgIGlmICghdGhpcy5kaHQuZmlyZXdhbGxlZCkgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuT1BFTgogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5zYW1wbGVkIDwgMykgcmV0dXJuCgogICAgY29uc3QgbWF4ID0gdGhpcy5fc2FtcGxlc0Z1bGxbMF0uaGl0cwoKICAgIGlmIChtYXggPj0gMykgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuQ09OU0lTVEVOVAogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAobWF4ID09PSAxKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5SQU5ET00KICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gZWxzZSBtYXggPT09IDIKCiAgICAvLyAxIGhvc3QsID49IDQgdG90YWwgc2FtcGxlcyBpZSwgMiBiYWQgb25lcyAtPiByYW5kb20KICAgIGlmICh0aGlzLl9zYW1wbGVzSG9zdC5sZW5ndGggPT09IDEgJiYgdGhpcy5zYW1wbGVkID4gMykgewogICAgICB0aGlzLmZpcmV3YWxsID0gRklSRVdBTEwuUkFORE9NCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGRvdWJsZSBoaXQgb24gdHdvIGRpZmZlcmVudCBpcHMgLT4gYXNzdW1lIGNvbnNpc3RlbnQKICAgIGlmICh0aGlzLl9zYW1wbGVzSG9zdC5sZW5ndGggPiAxICYmIHRoaXMuX3NhbXBsZXNGdWxsWzFdLmhpdHMgPiAxKSB7CiAgICAgIHRoaXMuZmlyZXdhbGwgPSBGSVJFV0FMTC5DT05TSVNURU5UCiAgICAgIHJldHVybgogICAgfQoKICAgIC8vICg0IGlzIGp1c3QgbWVhbnMgLSBhbGwgdGhlIHNhbXBsZXMgd2UgZXhwZWN0KSAtIG5vIGRlY2lzaW9uIC0gYXNzdW1lIHJhbmRvbQogICAgaWYgKHRoaXMuc2FtcGxlZCA+IDQpIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLlJBTkRPTQogICAgfQogIH0KCiAgX3VwZGF0ZUFkZHJlc3NlcygpIHsKICAgIGlmICh0aGlzLmZpcmV3YWxsID09PSBGSVJFV0FMTC5VTktOT1dOKSB7CiAgICAgIHRoaXMuYWRkcmVzc2VzID0gbnVsbAogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuUkFORE9NKSB7CiAgICAgIHRoaXMuYWRkcmVzc2VzID0gW3RoaXMuX3NhbXBsZXNIb3N0WzBdXQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAodGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVCkgewogICAgICB0aGlzLmFkZHJlc3NlcyA9IFtdCiAgICAgIGZvciAoY29uc3QgYWRkciBvZiB0aGlzLl9zYW1wbGVzRnVsbCkgewogICAgICAgIGlmIChhZGRyLmhpdHMgPj0gMiB8fCB0aGlzLmFkZHJlc3Nlcy5sZW5ndGggPCAyKSB0aGlzLmFkZHJlc3Nlcy5wdXNoKGFkZHIpCiAgICAgIH0KICAgIH0KICB9CgogIHVwZGF0ZSgpIHsKICAgIGlmICh0aGlzLmRodC5maXJld2FsbGVkICYmIHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLk9QRU4pIHsKICAgICAgdGhpcy5maXJld2FsbCA9IEZJUkVXQUxMLlVOS05PV04KICAgIH0KICAgIHRoaXMuX3VwZGF0ZUZpcmV3YWxsKCkKICAgIHRoaXMuX3VwZGF0ZUFkZHJlc3NlcygpCiAgfQoKICBhZGQoYWRkciwgZnJvbSkgewogICAgY29uc3QgcmVmID0gZnJvbS5ob3N0ICsgJzonICsgZnJvbS5wb3J0CgogICAgaWYgKHRoaXMuX3Zpc2l0ZWQuZ2V0KHJlZikgPT09IDIpIHJldHVybgogICAgdGhpcy5fdmlzaXRlZC5zZXQocmVmLCAyKQoKICAgIGFkZFNhbXBsZSh0aGlzLl9zYW1wbGVzSG9zdCwgYWRkci5ob3N0LCAwKQogICAgYWRkU2FtcGxlKHRoaXMuX3NhbXBsZXNGdWxsLCBhZGRyLmhvc3QsIGFkZHIucG9ydCkKCiAgICBpZiAoKCsrdGhpcy5zYW1wbGVkID49IDMgfHwgIXRoaXMuZGh0LmZpcmV3YWxsZWQpICYmICF0aGlzLmZyb3plbikgewogICAgICB0aGlzLnVwZGF0ZSgpCiAgICB9CgogICAgaWYgKHRoaXMuZmlyZXdhbGwgPT09IEZJUkVXQUxMLkNPTlNJU1RFTlQgfHwgdGhpcy5maXJld2FsbCA9PT0gRklSRVdBTEwuT1BFTikgewogICAgICB0aGlzLl9yZXNvbHZlKCkKICAgIH0gZWxzZSBpZiAodGhpcy5zYW1wbGVkID49IHRoaXMuX21pblNhbXBsZXMpIHsKICAgICAgdGhpcy5fcmVzb2x2ZSgpCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBhZGRTYW1wbGUoc2FtcGxlcywgaG9zdCwgcG9ydCkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgc2FtcGxlcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgcyA9IHNhbXBsZXNbaV0KCiAgICBpZiAocy5wb3J0ICE9PSBwb3J0IHx8IHMuaG9zdCAhPT0gaG9zdCkgY29udGludWUKICAgIHMuaGl0cysrCgogICAgZm9yICg7IGkgPiAwOyBpLS0pIHsKICAgICAgY29uc3QgcHJldiA9IHNhbXBsZXNbaSAtIDFdCiAgICAgIGlmIChwcmV2LmhpdHMgPj0gcy5oaXRzKSByZXR1cm4KICAgICAgc2FtcGxlc1tpIC0gMV0gPSBzCiAgICAgIHNhbXBsZXNbaV0gPSBwcmV2CiAgICB9CgogICAgcmV0dXJuCiAgfQoKICBzYW1wbGVzLnB1c2goewogICAgaG9zdCwKICAgIHBvcnQsCiAgICBoaXRzOiAxCiAgfSkKfQpjb25zdCBOb2lzZVNlY3JldFN0cmVhbSA9IHJlcXVpcmUoJ0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nKQpjb25zdCBOb2lzZUhhbmRzaGFrZSA9IHJlcXVpcmUoJ25vaXNlLWhhbmRzaGFrZScpCmNvbnN0IGN1cnZlID0gcmVxdWlyZSgnbm9pc2UtY3VydmUtZWQnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBtID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCmNvbnN0IHsgTlMgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyBIQU5EU0hBS0VfVU5GSU5JU0hFRCB9ID0gcmVxdWlyZSgnLi9lcnJvcnMnKQoKY29uc3QgTk9JU0VfUFJPTE9VR0UgPSBOUy5QRUVSX0hBTkRTSEFLRQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBOb2lzZVdyYXAgewogIGNvbnN0cnVjdG9yKGtleVBhaXIsIHJlbW90ZVB1YmxpY0tleSkgewogICAgdGhpcy5pc0luaXRpYXRvciA9ICEhcmVtb3RlUHVibGljS2V5CiAgICB0aGlzLnJlbW90ZVB1YmxpY0tleSA9IHJlbW90ZVB1YmxpY0tleQogICAgdGhpcy5rZXlQYWlyID0ga2V5UGFpcgogICAgdGhpcy5oYW5kc2hha2UgPSBuZXcgTm9pc2VIYW5kc2hha2UoJ0lLJywgdGhpcy5pc0luaXRpYXRvciwga2V5UGFpciwgeyBjdXJ2ZSB9KQogICAgdGhpcy5oYW5kc2hha2UuaW5pdGlhbGlzZShOT0lTRV9QUk9MT1VHRSwgcmVtb3RlUHVibGljS2V5KQogIH0KCiAgc2VuZChwYXlsb2FkKSB7CiAgICBjb25zdCBidWYgPSBjLmVuY29kZShtLm5vaXNlUGF5bG9hZCwgcGF5bG9hZCkKICAgIHJldHVybiB0aGlzLmhhbmRzaGFrZS5zZW5kKGJ1ZikKICB9CgogIHJlY3YoYnVmKSB7CiAgICBjb25zdCBwYXlsb2FkID0gYy5kZWNvZGUobS5ub2lzZVBheWxvYWQsIHRoaXMuaGFuZHNoYWtlLnJlY3YoYnVmKSkKICAgIHRoaXMucmVtb3RlUHVibGljS2V5ID0gYjRhLnRvQnVmZmVyKHRoaXMuaGFuZHNoYWtlLnJzKQogICAgcmV0dXJuIHBheWxvYWQKICB9CgogIGZpbmFsKCkgewogICAgaWYgKCF0aGlzLmhhbmRzaGFrZS5jb21wbGV0ZSkgdGhyb3cgSEFORFNIQUtFX1VORklOSVNIRUQoKQoKICAgIGNvbnN0IGhvbGVwdW5jaFNlY3JldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhvbGVwdW5jaFNlY3JldCwgTlMuUEVFUl9IT0xFUFVOQ0gsIHRoaXMuaGFuZHNoYWtlLmhhc2gpCgogICAgcmV0dXJuIHsKICAgICAgaXNJbml0aWF0b3I6IHRoaXMuaXNJbml0aWF0b3IsCiAgICAgIHB1YmxpY0tleTogdGhpcy5rZXlQYWlyLnB1YmxpY0tleSwKICAgICAgc3RyZWFtSWQ6IHRoaXMuc3RyZWFtSWQsCiAgICAgIHJlbW90ZVB1YmxpY0tleTogdGhpcy5yZW1vdGVQdWJsaWNLZXksCiAgICAgIHJlbW90ZUlkOiBOb2lzZVNlY3JldFN0cmVhbS5pZCh0aGlzLmhhbmRzaGFrZS5oYXNoLCAhdGhpcy5pc0luaXRpYXRvciksCiAgICAgIGhvbGVwdW5jaFNlY3JldCwKICAgICAgaGFzaDogYjRhLnRvQnVmZmVyKHRoaXMuaGFuZHNoYWtlLmhhc2gpLAogICAgICByeDogYjRhLnRvQnVmZmVyKHRoaXMuaGFuZHNoYWtlLnJ4KSwKICAgICAgdHg6IGI0YS50b0J1ZmZlcih0aGlzLmhhbmRzaGFrZS50eCkKICAgIH0KICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgUmVjb3JkQ2FjaGUgPSByZXF1aXJlKCdyZWNvcmQtY2FjaGUnKQpjb25zdCBDYWNoZSA9IHJlcXVpcmUoJ3hhY2hlJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IHsgZW5jb2RlVW5zbGFiIH0gPSByZXF1aXJlKCcuL2VuY29kZScpCmNvbnN0IG0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgeyBOUywgRVJST1IgfSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKCmNvbnN0IEVNUFRZID0gYjRhLmFsbG9jKDApCmNvbnN0IFRNUCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKY29uc3QgTUFYX0JVTVBfRFJJRlQgPSA2MF8wMDAKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUGVyc2lzdGVudCB7CiAgY29uc3RydWN0b3IoZGh0LCBvcHRzKSB7CiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy5yZWNvcmRzID0gbmV3IFJlY29yZENhY2hlKG9wdHMucmVjb3JkcykKICAgIHRoaXMuYnVtcHMgPSBuZXcgQ2FjaGUob3B0cy5idW1wcykKICAgIHRoaXMucmVmcmVzaGVzID0gbmV3IENhY2hlKG9wdHMucmVmcmVzaGVzKQogICAgdGhpcy5tdXRhYmxlcyA9IG5ldyBDYWNoZShvcHRzLm11dGFibGVzKQogICAgdGhpcy5pbW11dGFibGVzID0gbmV3IENhY2hlKG9wdHMuaW1tdXRhYmxlcykKICB9CgogIG9ubG9va3VwKHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0KSByZXR1cm4KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHJlcS50YXJnZXQsICdoZXgnKQogICAgY29uc3QgcmVjb3JkcyA9IHRoaXMucmVjb3Jkcy5nZXQoaywgMjApCiAgICBjb25zdCBidW1wID0gdGhpcy5idW1wcy5nZXQoaykgfHwgMAogICAgY29uc3QgZndkID0gdGhpcy5kaHQuX3JvdXRlci5nZXQoaykKCiAgICBpZiAoZndkICYmIHJlY29yZHMubGVuZ3RoIDwgMjApIHJlY29yZHMucHVzaChmd2QucmVjb3JkKQoKICAgIHJlcS5yZXBseShyZWNvcmRzLmxlbmd0aCA/IGMuZW5jb2RlKG0ubG9va3VwUmF3UmVwbHksIHsgcGVlcnM6IHJlY29yZHMsIGJ1bXAgfSkgOiBudWxsKQogIH0KCiAgb25maW5kcGVlcihyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCkgcmV0dXJuCiAgICBjb25zdCBmd2QgPSB0aGlzLmRodC5fcm91dGVyLmdldChyZXEudGFyZ2V0KQogICAgcmVxLnJlcGx5KGZ3ZCA/IGZ3ZC5yZWNvcmQgOiBudWxsKQogIH0KCiAgdW5hbm5vdW5jZSh0YXJnZXQsIHB1YmxpY0tleSkgewogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyh0YXJnZXQsICdoZXgnKQogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChUTVAsIHB1YmxpY0tleSkKCiAgICBpZiAoYjRhLmVxdWFscyhUTVAsIHRhcmdldCkpIHRoaXMuZGh0Ll9yb3V0ZXIuZGVsZXRlKGspCiAgICB0aGlzLnJlY29yZHMucmVtb3ZlKGssIHB1YmxpY0tleSkKICB9CgogIG9udW5hbm5vdW5jZShyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnRva2VuKSByZXR1cm4KCiAgICBjb25zdCB1bmFubiA9IGRlY29kZShtLmFubm91bmNlLCByZXEudmFsdWUpCiAgICBpZiAodW5hbm4gPT09IG51bGwpIHJldHVybgoKICAgIGNvbnN0IHsgcGVlciwgc2lnbmF0dXJlIH0gPSB1bmFubgogICAgaWYgKCFwZWVyIHx8ICFzaWduYXR1cmUpIHJldHVybgoKICAgIGNvbnN0IHNpZ25hYmxlID0gYW5uU2lnbmFibGUocmVxLnRhcmdldCwgcmVxLnRva2VuLCB0aGlzLmRodC5pZCwgdW5hbm4sIE5TLlVOQU5OT1VOQ0UpCgogICAgaWYgKCFzb2RpdW0uY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKHNpZ25hdHVyZSwgc2lnbmFibGUsIHBlZXIucHVibGljS2V5KSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLnVuYW5ub3VuY2UocmVxLnRhcmdldCwgcGVlci5wdWJsaWNLZXkpCiAgICByZXEucmVwbHkobnVsbCwgeyB0b2tlbjogZmFsc2UsIGNsb3Nlck5vZGVzOiBmYWxzZSB9KQogIH0KCiAgX29ucmVmcmVzaCh0b2tlbiwgcmVxKSB7CiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKFRNUCwgdG9rZW4pCiAgICBjb25zdCBhY3RpdmVSZWZyZXNoID0gYjRhLnRvU3RyaW5nKFRNUCwgJ2hleCcpCgogICAgY29uc3QgciA9IHRoaXMucmVmcmVzaGVzLmdldChhY3RpdmVSZWZyZXNoKQogICAgaWYgKCFyKSByZXR1cm4KCiAgICBjb25zdCB7IGFubm91bmNlU2VsZiwgaywgcmVjb3JkIH0gPSByCiAgICBjb25zdCBwdWJsaWNLZXkgPSByZWNvcmQuc3ViYXJyYXkoMCwgMzIpCgogICAgaWYgKGFubm91bmNlU2VsZikgewogICAgICB0aGlzLmRodC5fcm91dGVyLnNldChrLCB7CiAgICAgICAgcmVsYXk6IHJlcS5mcm9tLAogICAgICAgIHJlY29yZCwKICAgICAgICBvbmNvbm5lY3Q6IG51bGwsCiAgICAgICAgb25ob2xlcHVuY2g6IG51bGwKICAgICAgfSkKICAgICAgdGhpcy5yZWNvcmRzLnJlbW92ZShrLCBwdWJsaWNLZXkpCiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlY29yZHMuYWRkKGssIHB1YmxpY0tleSwgcmVjb3JkKQogICAgfQoKICAgIHRoaXMucmVmcmVzaGVzLmRlbGV0ZShhY3RpdmVSZWZyZXNoKQogICAgdGhpcy5yZWZyZXNoZXMuc2V0KGI0YS50b1N0cmluZyh0b2tlbiwgJ2hleCcpLCByKQoKICAgIHJlcS5yZXBseShudWxsLCB7IHRva2VuOiBmYWxzZSwgY2xvc2VyTm9kZXM6IGZhbHNlIH0pCiAgfQoKICBvbmFubm91bmNlKHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0IHx8ICFyZXEudG9rZW4gfHwgIXRoaXMuZGh0LmlkKSByZXR1cm4KCiAgICBjb25zdCBhbm4gPSBkZWNvZGUobS5hbm5vdW5jZSwgcmVxLnZhbHVlKQogICAgaWYgKGFubiA9PT0gbnVsbCkgcmV0dXJuCgogICAgY29uc3Qgc2lnbmFibGUgPSBhbm5TaWduYWJsZShyZXEudGFyZ2V0LCByZXEudG9rZW4sIHRoaXMuZGh0LmlkLCBhbm4sIE5TLkFOTk9VTkNFKQogICAgY29uc3QgeyBwZWVyLCByZWZyZXNoLCBzaWduYXR1cmUsIGJ1bXAgfSA9IGFubgoKICAgIGlmICghcGVlcikgewogICAgICBpZiAoIXJlZnJlc2gpIHJldHVybgogICAgICB0aGlzLl9vbnJlZnJlc2gocmVmcmVzaCwgcmVxKQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoIXNpZ25hdHVyZSB8fCAhc29kaXVtLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZChzaWduYXR1cmUsIHNpZ25hYmxlLCBwZWVyLnB1YmxpY0tleSkpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gVE9ETzogaXQgd291bGQgYmUgcG90ZW50aWFsbHkgYmUgbW9yZSBvcHRpbWFsIHRvIGFsbG93IG1vcmUgdGhhbiAzIGFkZHJlc3NlcyBoZXJlIGZvciBhIGZpbmRQZWVyIHJlc3BvbnNlCiAgICAvLyBhbmQgb25seSB1c2UgbWF4IDMgZm9yIGEgbG9va3VwIHJlcGx5CiAgICBpZiAocGVlci5yZWxheUFkZHJlc3Nlcy5sZW5ndGggPiAzKSB7CiAgICAgIHBlZXIucmVsYXlBZGRyZXNzZXMgPSBwZWVyLnJlbGF5QWRkcmVzc2VzLnNsaWNlKDAsIDMpCiAgICB9CgogICAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChUTVAsIHBlZXIucHVibGljS2V5KQoKICAgIGNvbnN0IGsgPSBiNGEudG9TdHJpbmcocmVxLnRhcmdldCwgJ2hleCcpCiAgICBjb25zdCBhbm5vdW5jZVNlbGYgPSBiNGEuZXF1YWxzKFRNUCwgcmVxLnRhcmdldCkKICAgIGNvbnN0IHJlY29yZCA9IGVuY29kZVVuc2xhYihtLnBlZXIsIHBlZXIpCgogICAgaWYgKGFubm91bmNlU2VsZikgewogICAgICB0aGlzLmRodC5fcm91dGVyLnNldChrLCB7CiAgICAgICAgcmVsYXk6IHJlcS5mcm9tLAogICAgICAgIHJlY29yZCwKICAgICAgICBvbmNvbm5lY3Q6IG51bGwsCiAgICAgICAgb25ob2xlcHVuY2g6IG51bGwKICAgICAgfSkKICAgICAgdGhpcy5yZWNvcmRzLnJlbW92ZShrLCBwZWVyLnB1YmxpY0tleSkKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGN1cnJlbnRCdW1wID0gdGhpcy5idW1wcy5nZXQoaykgfHwgMAogICAgICBpZiAoYnVtcCA+IGN1cnJlbnRCdW1wICYmIGJ1bXAgPD0gRGF0ZS5ub3coKSArIE1BWF9CVU1QX0RSSUZUKSB0aGlzLmJ1bXBzLnNldChrLCBidW1wKQogICAgICB0aGlzLnJlY29yZHMuYWRkKGssIHBlZXIucHVibGljS2V5LCByZWNvcmQpCiAgICB9CgogICAgaWYgKHJlZnJlc2gpIHsKICAgICAgdGhpcy5yZWZyZXNoZXMuc2V0KGI0YS50b1N0cmluZyhyZWZyZXNoLCAnaGV4JyksIHsgaywgcmVjb3JkLCBhbm5vdW5jZVNlbGYgfSkKICAgIH0KCiAgICByZXEucmVwbHkobnVsbCwgeyB0b2tlbjogZmFsc2UsIGNsb3Nlck5vZGVzOiBmYWxzZSB9KQogIH0KCiAgb25tdXRhYmxlZ2V0KHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0IHx8ICFyZXEudmFsdWUpIHJldHVybgoKICAgIGxldCBzZXEgPSAwCiAgICB0cnkgewogICAgICBzZXEgPSBjLmRlY29kZShjLnVpbnQsIHJlcS52YWx1ZSkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4KICAgIH0KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHJlcS50YXJnZXQsICdoZXgnKQogICAgY29uc3QgdmFsdWUgPSB0aGlzLm11dGFibGVzLmdldChrKQoKICAgIGlmICghdmFsdWUpIHsKICAgICAgcmVxLnJlcGx5KG51bGwpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGxvY2FsU2VxID0gYy5kZWNvZGUoYy51aW50LCB2YWx1ZSkKICAgIHJlcS5yZXBseShsb2NhbFNlcSA8IHNlcSA/IG51bGwgOiB2YWx1ZSkKICB9CgogIG9ubXV0YWJsZXB1dChyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnRva2VuIHx8ICFyZXEudmFsdWUpIHJldHVybgoKICAgIGNvbnN0IHAgPSBkZWNvZGUobS5tdXRhYmxlUHV0UmVxdWVzdCwgcmVxLnZhbHVlKQogICAgaWYgKCFwKSByZXR1cm4KCiAgICBjb25zdCB7IHB1YmxpY0tleSwgc2VxLCB2YWx1ZSwgc2lnbmF0dXJlIH0gPSBwCgogICAgY29uc3QgaGFzaCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaGFzaCwgcHVibGljS2V5KQogICAgaWYgKCFiNGEuZXF1YWxzKGhhc2gsIHJlcS50YXJnZXQpKSByZXR1cm4KCiAgICBpZiAoIXZhbHVlIHx8ICF2ZXJpZnlNdXRhYmxlKHNpZ25hdHVyZSwgc2VxLCB2YWx1ZSwgcHVibGljS2V5KSkgcmV0dXJuCgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhoYXNoLCAnaGV4JykKICAgIGNvbnN0IGxvY2FsID0gdGhpcy5tdXRhYmxlcy5nZXQoaykKCiAgICBpZiAobG9jYWwpIHsKICAgICAgY29uc3QgZXhpc3RpbmcgPSBjLmRlY29kZShtLm11dGFibGVHZXRSZXNwb25zZSwgbG9jYWwpCiAgICAgIGlmIChleGlzdGluZy52YWx1ZSAmJiBleGlzdGluZy5zZXEgPT09IHNlcSAmJiBiNGEuY29tcGFyZSh2YWx1ZSwgZXhpc3RpbmcudmFsdWUpICE9PSAwKSB7CiAgICAgICAgcmVxLmVycm9yKEVSUk9SLlNFUV9SRVVTRUQpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgaWYgKHNlcSA8IGV4aXN0aW5nLnNlcSkgewogICAgICAgIHJlcS5lcnJvcihFUlJPUi5TRVFfVE9PX0xPVykKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQoKICAgIHRoaXMubXV0YWJsZXMuc2V0KGssIGVuY29kZVVuc2xhYihtLm11dGFibGVHZXRSZXNwb25zZSwgeyBzZXEsIHZhbHVlLCBzaWduYXR1cmUgfSkpCiAgICByZXEucmVwbHkobnVsbCkKICB9CgogIG9uaW1tdXRhYmxlZ2V0KHJlcSkgewogICAgaWYgKCFyZXEudGFyZ2V0KSByZXR1cm4KCiAgICBjb25zdCBrID0gYjRhLnRvU3RyaW5nKHJlcS50YXJnZXQsICdoZXgnKQogICAgY29uc3QgdmFsdWUgPSB0aGlzLmltbXV0YWJsZXMuZ2V0KGspCgogICAgcmVxLnJlcGx5KHZhbHVlIHx8IG51bGwpCiAgfQoKICBvbmltbXV0YWJsZXB1dChyZXEpIHsKICAgIGlmICghcmVxLnRhcmdldCB8fCAhcmVxLnRva2VuIHx8ICFyZXEudmFsdWUpIHJldHVybgoKICAgIGNvbnN0IGhhc2ggPSBiNGEuYWxsb2MoMzIpCiAgICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGhhc2gsIHJlcS52YWx1ZSkKICAgIGlmICghYjRhLmVxdWFscyhoYXNoLCByZXEudGFyZ2V0KSkgcmV0dXJuCgogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhoYXNoLCAnaGV4JykKICAgIHRoaXMuaW1tdXRhYmxlcy5zZXQoaywgdW5zbGFiKHJlcS52YWx1ZSkpCgogICAgcmVxLnJlcGx5KG51bGwpCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5yZWNvcmRzLmRlc3Ryb3koKQogICAgdGhpcy5yZWZyZXNoZXMuZGVzdHJveSgpCiAgICB0aGlzLm11dGFibGVzLmRlc3Ryb3koKQogICAgdGhpcy5pbW11dGFibGVzLmRlc3Ryb3koKQogIH0KCiAgc3RhdGljIHNpZ25NdXRhYmxlKHNlcSwgdmFsdWUsIGtleVBhaXIpIHsKICAgIGNvbnN0IHNpZ25hYmxlID0gYjRhLmFsbG9jVW5zYWZlKDMyICsgMzIpCiAgICBjb25zdCBoYXNoID0gc2lnbmFibGUuc3ViYXJyYXkoMzIpCgogICAgc2lnbmFibGUuc2V0KE5TLk1VVEFCTEVfUFVULCAwKQoKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2goaGFzaCwgYy5lbmNvZGUobS5tdXRhYmxlU2lnbmFibGUsIHsgc2VxLCB2YWx1ZSB9KSkKICAgIHJldHVybiBzaWduKHNpZ25hYmxlLCBrZXlQYWlyKQogIH0KCiAgc3RhdGljIHZlcmlmeU11dGFibGUoc2lnbmF0dXJlLCBzZXEsIHZhbHVlLCBwdWJsaWNLZXkpIHsKICAgIHJldHVybiB2ZXJpZnlNdXRhYmxlKHNpZ25hdHVyZSwgc2VxLCB2YWx1ZSwgcHVibGljS2V5KQogIH0KCiAgc3RhdGljIHNpZ25Bbm5vdW5jZSh0YXJnZXQsIHRva2VuLCBpZCwgYW5uLCBrZXlQYWlyKSB7CiAgICByZXR1cm4gc2lnbihhbm5TaWduYWJsZSh0YXJnZXQsIHRva2VuLCBpZCwgYW5uLCBOUy5BTk5PVU5DRSksIGtleVBhaXIpCiAgfQoKICBzdGF0aWMgc2lnblVuYW5ub3VuY2UodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwga2V5UGFpcikgewogICAgcmV0dXJuIHNpZ24oYW5uU2lnbmFibGUodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwgTlMuVU5BTk5PVU5DRSksIGtleVBhaXIpCiAgfQp9CgpmdW5jdGlvbiB2ZXJpZnlNdXRhYmxlKHNpZ25hdHVyZSwgc2VxLCB2YWx1ZSwgcHVibGljS2V5KSB7CiAgY29uc3Qgc2lnbmFibGUgPSBiNGEuYWxsb2NVbnNhZmUoMzIgKyAzMikKICBjb25zdCBoYXNoID0gc2lnbmFibGUuc3ViYXJyYXkoMzIpCgogIHNpZ25hYmxlLnNldChOUy5NVVRBQkxFX1BVVCwgMCkKCiAgc29kaXVtLmNyeXB0b19nZW5lcmljaGFzaChoYXNoLCBjLmVuY29kZShtLm11dGFibGVTaWduYWJsZSwgeyBzZXEsIHZhbHVlIH0pKQogIHJldHVybiBzb2RpdW0uY3J5cHRvX3NpZ25fdmVyaWZ5X2RldGFjaGVkKHNpZ25hdHVyZSwgc2lnbmFibGUsIHB1YmxpY0tleSkKfQoKZnVuY3Rpb24gYW5uU2lnbmFibGUodGFyZ2V0LCB0b2tlbiwgaWQsIGFubiwgbnMpIHsKICBjb25zdCBzaWduYWJsZSA9IGI0YS5hbGxvY1Vuc2FmZSgzMiArIDMyKQogIGNvbnN0IGhhc2ggPSBzaWduYWJsZS5zdWJhcnJheSgzMikKCiAgc2lnbmFibGUuc2V0KG5zLCAwKQoKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKGhhc2gsIFsKICAgIHRhcmdldCwKICAgIGlkLAogICAgdG9rZW4sCiAgICBjLmVuY29kZShtLnBlZXIsIGFubi5wZWVyKSwgLy8gbm90ZSB0aGF0IHRoaXMgaXMgdGhlIHBhcnRpYWwgZW5jb2Rpbmcgb2YgdGhlIGFubm91bmNlIG1lc3NhZ2Ugc28gd2UgY291bGQganVzdCB1c2UgdGhhdCBmb3IgcGVyZgogICAgYW5uLnJlZnJlc2ggfHwgRU1QVFkKICBdKQoKICByZXR1cm4gc2lnbmFibGUKfQoKZnVuY3Rpb24gc2lnbihzaWduYWJsZSwga2V5UGFpcikgewogIGlmIChrZXlQYWlyLnNpZ24pIHsKICAgIHJldHVybiBrZXlQYWlyLnNpZ24oc2lnbmFibGUpCiAgfQogIGNvbnN0IHNlY3JldEtleSA9IGtleVBhaXIuc2VjcmV0S2V5ID8ga2V5UGFpci5zZWNyZXRLZXkgOiBrZXlQYWlyCiAgY29uc3Qgc2lnbmF0dXJlID0gYjRhLmFsbG9jVW5zYWZlKDY0KQogIHNvZGl1bS5jcnlwdG9fc2lnbl9kZXRhY2hlZChzaWduYXR1cmUsIHNpZ25hYmxlLCBzZWNyZXRLZXkpCiAgcmV0dXJuIHNpZ25hdHVyZQp9CgpmdW5jdGlvbiBkZWNvZGUoZW5jLCB2YWwpIHsKICB0cnkgewogICAgcmV0dXJuIHZhbCAmJiBjLmRlY29kZShlbmMsIHZhbCkKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBudWxsCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmF3U3RyZWFtU2V0IHsKICBjb25zdHJ1Y3RvcihkaHQpIHsKICAgIHRoaXMuX2RodCA9IGRodAoKICAgIHRoaXMuX3ByZWZpeCA9IDE2IC0gMSAvLyAxNiBpcyB0aGUgZGVmYXVsdCBzdHJlYW0tc2V0IHNpZGUgaW4gdWR4CiAgICB0aGlzLl9zdHJlYW1zID0gbmV3IE1hcCgpCiAgfQoKICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLl9zdHJlYW1zLnNpemUKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuX3N0cmVhbXMudmFsdWVzKCkKICB9CgogIGFkZChvcHRzKSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwoKICAgIC8vIFRPRE86IHdlIHNob3VsZCBwcm9iIGhhdmUgYSB1ZHggaGVscGVyIGZvciBpZCBnZW5lcmF0aW9uLCBnaXZlbiB0aGUgc2xpZ2h0IGNvbXBsZXhpdHkKICAgIC8vIG9mIHRoZSBiZWxvdy4gcmVxdWlyZXMgYSBQUk5HIGluIHVkeCB0aG8uCgogICAgbGV0IGlkID0gMAoKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlkID0gKE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMCkgPj4+IDAKCiAgICAgIGlmICh0aGlzLl9zdHJlYW1zLmhhcyhpZCAmIHRoaXMuX3ByZWZpeCkpIGNvbnRpbnVlCiAgICAgIGJyZWFrCiAgICB9CgogICAgLy8gYWx3YXlzIGhhdmUgfjUwJSBjaGFuZ2Ugb2Ygcm9sbGluZyBhIGZyZWUgb25lCiAgICBpZiAoMiAqIHRoaXMuX3N0cmVhbXMuc2l6ZSA+PSB0aGlzLl9wcmVmaXgpIHsKICAgICAgLy8gaWUgMGIxMTExMSA9IDBiMTExMSArIDEgKyAwYjExMTEKICAgICAgdGhpcy5fcHJlZml4ID0gMiAqIHRoaXMuX3ByZWZpeCArIDEKCiAgICAgIC8vIG1vdmUgdGhlIHByZWZpeGVzIG92ZXIKICAgICAgY29uc3QgbmV4dCA9IG5ldyBNYXAoKQogICAgICBmb3IgKGNvbnN0IHN0cmVhbSBvZiB0aGlzLl9zdHJlYW1zLnZhbHVlcygpKSB7CiAgICAgICAgbmV4dC5zZXQoc3RyZWFtLmlkICYgdGhpcy5fcHJlZml4LCBzdHJlYW0pCiAgICAgIH0KICAgICAgdGhpcy5fc3RyZWFtcyA9IG5leHQKICAgIH0KCiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLl9kaHQudWR4LmNyZWF0ZVN0cmVhbShpZCwgb3B0cykKICAgIHRoaXMuX3N0cmVhbXMuc2V0KGlkICYgdGhpcy5fcHJlZml4LCBzdHJlYW0pCgogICAgc3RyZWFtLm9uKCdjbG9zZScsIG9uY2xvc2UpCgogICAgcmV0dXJuIHN0cmVhbQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICAgIHNlbGYuX3N0cmVhbXMuZGVsZXRlKGlkICYgc2VsZi5fcHJlZml4KQogICAgfQogIH0KCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBjb25zdCBkZXN0cm95aW5nID0gW10KCiAgICBmb3IgKGNvbnN0IHN0cmVhbSBvZiB0aGlzLl9zdHJlYW1zLnZhbHVlcygpKSB7CiAgICAgIGRlc3Ryb3lpbmcucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc3RyZWFtLm9uY2UoJ2Nsb3NlJywgcmVzb2x2ZSkuZGVzdHJveSgpKSkKICAgIH0KCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoZGVzdHJveWluZykKICB9Cn0KY29uc3QgYyA9IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQpjb25zdCBDYWNoZSA9IHJlcXVpcmUoJ3hhY2hlJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IGhhbmRzaGFrZSwgaG9sZXB1bmNoIH0gPSByZXF1aXJlKCcuL21lc3NhZ2VzJykKY29uc3QgeyBDT01NQU5EUyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCB7IEJBRF9IQU5EU0hBS0VfUkVQTFksIEJBRF9IT0xFUFVOQ0hfUkVQTFkgfSA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IEZST01fQ0xJRU5UID0gMApjb25zdCBGUk9NX1NFUlZFUiA9IDEKY29uc3QgRlJPTV9SRUxBWSA9IDIKY29uc3QgRlJPTV9TRUNPTkRfUkVMQVkgPSAzCmNvbnN0IFJFUExZID0gNAoKLy8gVE9ETzogV2hpbGUgdGhlIGN1cnJlbnQgZGVzaWduIGlzIHZlcnkgdHJ1c3RsZXNzIGluIHJlZ2FyZHMgdG8gY2xpZW50cy9zZXJ2ZXJzIHRydXN0aW5nIHRoZSBESFQsCi8vIHdlIHNob3VsZCBhZGQgYSBidW5jaCBvZiByYXRlIGxpbWl0cyBldmVyeXdoZXJlLCBlc3BlY2lhbGx5IGluY2x1ZGluZyBoZXJlIHRvIGF2b2lkIGJhZCB1c2VycwovLyB1c2luZyBhIERIVCBub2RlIHRvIHJlbGF5IHRyYWZmaWMgaW5kaXNjcmltaW5hdGVseSB1c2luZyB0aGUgY29ubmVjdC9ob2xlcHVuY2ggbWVzc2FnZXMuCi8vIFRoYXQncyBtb3N0bHkgZnJvbSBhbiBhYnVzZSBQT1YgYXMgbm9uZSBvZiB0aGUgbWVzc3NhZ2VzIGRvIGFtcGxpY2F0aW9uLgoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSb3V0ZXIgewogIGNvbnN0cnVjdG9yKGRodCwgb3B0cykgewogICAgdGhpcy5kaHQgPSBkaHQKICAgIHRoaXMuZm9yd2FyZHMgPSBuZXcgQ2FjaGUob3B0cy5mb3J3YXJkcykKICB9CgogIHNldCh0YXJnZXQsIHN0YXRlKSB7CiAgICBpZiAoc3RhdGUub25wZWVyaGFuZHNoYWtlKSB7CiAgICAgIHRoaXMuZm9yd2FyZHMucmV0YWluKHRvU3RyaW5nKHRhcmdldCksIHN0YXRlKQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5mb3J3YXJkcy5zZXQodG9TdHJpbmcodGFyZ2V0KSwgc3RhdGUpCiAgICB9CiAgfQoKICBnZXQodGFyZ2V0KSB7CiAgICByZXR1cm4gdGhpcy5mb3J3YXJkcy5nZXQodG9TdHJpbmcodGFyZ2V0KSkKICB9CgogIGRlbGV0ZSh0YXJnZXQpIHsKICAgIHRoaXMuZm9yd2FyZHMuZGVsZXRlKHRvU3RyaW5nKHRhcmdldCkpCiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5mb3J3YXJkcy5kZXN0cm95KCkKICB9CgogIGFzeW5jIHBlZXJIYW5kc2hha2UodGFyZ2V0LCB7IG5vaXNlLCBwZWVyQWRkcmVzcywgcmVsYXlBZGRyZXNzLCBzb2NrZXQsIHNlc3Npb24gfSwgdG8pIHsKICAgIGNvbnN0IGRodCA9IHRoaXMuZGh0CgogICAgY29uc3QgcmVxdWVzdFZhbHVlID0gYy5lbmNvZGUoaGFuZHNoYWtlLCB7CiAgICAgIG1vZGU6IEZST01fQ0xJRU5ULAogICAgICBub2lzZSwKICAgICAgcGVlckFkZHJlc3MsCiAgICAgIHJlbGF5QWRkcmVzcwogICAgfSkKCiAgICBjb25zdCByZXMgPSBhd2FpdCBkaHQucmVxdWVzdCgKICAgICAgeyBjb21tYW5kOiBDT01NQU5EUy5QRUVSX0hBTkRTSEFLRSwgdGFyZ2V0LCB2YWx1ZTogcmVxdWVzdFZhbHVlIH0sCiAgICAgIHRvLAogICAgICB7IHNvY2tldCwgc2Vzc2lvbiB9CiAgICApCgogICAgY29uc3QgaHMgPSBkZWNvZGUoaGFuZHNoYWtlLCByZXMudmFsdWUpCiAgICBpZiAoCiAgICAgICFocyB8fAogICAgICBocy5tb2RlICE9PSBSRVBMWSB8fAogICAgICB0by5ob3N0ICE9PSByZXMuZnJvbS5ob3N0IHx8CiAgICAgIHRvLnBvcnQgIT09IHJlcy5mcm9tLnBvcnQgfHwKICAgICAgIWhzLm5vaXNlCiAgICApIHsKICAgICAgdGhyb3cgQkFEX0hBTkRTSEFLRV9SRVBMWSgpCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbm9pc2U6IGhzLm5vaXNlLAogICAgICByZWxheWVkOiAhIWhzLnBlZXJBZGRyZXNzLAogICAgICBzZXJ2ZXJBZGRyZXNzOiBocy5wZWVyQWRkcmVzcyB8fCB0bywKICAgICAgY2xpZW50QWRkcmVzczogcmVzLnRvCiAgICB9CiAgfQoKICBhc3luYyBvbnBlZXJoYW5kc2hha2UocmVxKSB7CiAgICBjb25zdCBocyA9IHJlcS52YWx1ZSAmJiBkZWNvZGUoaGFuZHNoYWtlLCByZXEudmFsdWUpCiAgICBpZiAoIWhzKSByZXR1cm4KCiAgICBjb25zdCB7IG1vZGUsIG5vaXNlLCBwZWVyQWRkcmVzcywgcmVsYXlBZGRyZXNzIH0gPSBocwoKICAgIGNvbnN0IHN0YXRlID0gcmVxLnRhcmdldCAmJiB0aGlzLmdldChyZXEudGFyZ2V0KQogICAgY29uc3QgaXNTZXJ2ZXIgPSAhIShzdGF0ZSAmJiBzdGF0ZS5vbnBlZXJoYW5kc2hha2UpCiAgICBjb25zdCByZWxheSA9IHN0YXRlICYmIHN0YXRlLnJlbGF5CgogICAgaWYgKGlzU2VydmVyKSB7CiAgICAgIGxldCByZXBseSA9IG51bGwKICAgICAgdHJ5IHsKICAgICAgICByZXBseSA9IG5vaXNlICYmIChhd2FpdCBzdGF0ZS5vbnBlZXJoYW5kc2hha2UoeyBub2lzZSwgcGVlckFkZHJlc3MgfSwgcmVxKSkKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNhZmV0eUNhdGNoKGUpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgaWYgKCFyZXBseSB8fCAhcmVwbHkubm9pc2UpIHJldHVybgogICAgICBjb25zdCBvcHRzID0geyBzb2NrZXQ6IHJlcGx5LnNvY2tldCwgY2xvc2VyTm9kZXM6IGZhbHNlLCB0b2tlbjogZmFsc2UgfQoKICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgY2FzZSBGUk9NX0NMSUVOVDogewogICAgICAgICAgcmVxLnJlcGx5KAogICAgICAgICAgICBjLmVuY29kZShoYW5kc2hha2UsIHsgbW9kZTogUkVQTFksIG5vaXNlOiByZXBseS5ub2lzZSwgcGVlckFkZHJlc3M6IG51bGwgfSksCiAgICAgICAgICAgIG9wdHMKICAgICAgICAgICkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBjYXNlIEZST01fUkVMQVk6IHsKICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7IG1vZGU6IEZST01fU0VSVkVSLCBub2lzZTogcmVwbHkubm9pc2UsIHBlZXJBZGRyZXNzIH0pLAogICAgICAgICAgICByZXEuZnJvbSwKICAgICAgICAgICAgb3B0cwogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIGNhc2UgRlJPTV9TRUNPTkRfUkVMQVk6IHsKICAgICAgICAgIGlmICghcmVsYXlBZGRyZXNzKSByZXR1cm4KICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7IG1vZGU6IEZST01fU0VSVkVSLCBub2lzZTogcmVwbHkubm9pc2UsIHBlZXJBZGRyZXNzIH0pLAogICAgICAgICAgICByZWxheUFkZHJlc3MsCiAgICAgICAgICAgIG9wdHMKICAgICAgICAgICkKICAgICAgICAgIHJldHVybiAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICBjYXNlIEZST01fQ0xJRU5UOiB7CiAgICAgICAgICAvLyBUT0RPOiBpZiBubyByZWxheSBpcyBrbm93biByb3V0ZSBjbG9zZXIgdG8gdGhlIHRhcmdldCBpbnN0ZWFkIG9mIHRpbWluZyBvdXQKICAgICAgICAgIGlmICghbm9pc2UpIHJldHVybgogICAgICAgICAgaWYgKCFyZWxheSAmJiAhcmVsYXlBZGRyZXNzKSB7CiAgICAgICAgICAgIC8vIGhlbHAgdGhlIHVzZXIgcm91dGUKICAgICAgICAgICAgcmVxLnJlcGx5KG51bGwsIHsgdG9rZW46IGZhbHNlLCBjbG9zZXJOb2RlczogdHJ1ZSB9KQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgIH0KICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7CiAgICAgICAgICAgICAgbW9kZTogRlJPTV9SRUxBWSwKICAgICAgICAgICAgICBub2lzZSwKICAgICAgICAgICAgICBwZWVyQWRkcmVzczogcmVxLmZyb20sCiAgICAgICAgICAgICAgcmVsYXlBZGRyZXNzOiBudWxsCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICByZWxheUFkZHJlc3MgfHwgcmVsYXkKICAgICAgICAgICkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBjYXNlIEZST01fUkVMQVk6IHsKICAgICAgICAgIGlmICghcmVsYXkgfHwgIW5vaXNlKSByZXR1cm4KICAgICAgICAgIHJlcS5yZWxheSgKICAgICAgICAgICAgYy5lbmNvZGUoaGFuZHNoYWtlLCB7CiAgICAgICAgICAgICAgbW9kZTogRlJPTV9TRUNPTkRfUkVMQVksCiAgICAgICAgICAgICAgbm9pc2UsCiAgICAgICAgICAgICAgcGVlckFkZHJlc3MsCiAgICAgICAgICAgICAgcmVsYXlBZGRyZXNzOiByZXEuZnJvbQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgcmVsYXkKICAgICAgICAgICkKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBjYXNlIEZST01fU0VSVkVSOiB7CiAgICAgICAgICBpZiAoIXBlZXJBZGRyZXNzIHx8ICFub2lzZSkgcmV0dXJuCiAgICAgICAgICByZXEucmVwbHkoCiAgICAgICAgICAgIGMuZW5jb2RlKGhhbmRzaGFrZSwgeyBtb2RlOiBSRVBMWSwgbm9pc2UsIHBlZXJBZGRyZXNzOiByZXEuZnJvbSwgcmVsYXlBZGRyZXNzOiBudWxsIH0pLAogICAgICAgICAgICB7IHRvOiBwZWVyQWRkcmVzcywgY2xvc2VyTm9kZXM6IGZhbHNlLCB0b2tlbjogZmFsc2UgfQogICAgICAgICAgKQogICAgICAgICAgcmV0dXJuIC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIHBlZXJIb2xlcHVuY2godGFyZ2V0LCB7IGlkLCBwYXlsb2FkLCBwZWVyQWRkcmVzcywgc29ja2V0LCBzZXNzaW9uIH0sIHRvKSB7CiAgICBjb25zdCBkaHQgPSB0aGlzLmRodAogICAgY29uc3QgcmVxdWVzdFZhbHVlID0gYy5lbmNvZGUoaG9sZXB1bmNoLCB7CiAgICAgIG1vZGU6IEZST01fQ0xJRU5ULAogICAgICBpZCwKICAgICAgcGF5bG9hZCwKICAgICAgcGVlckFkZHJlc3MKICAgIH0pCgogICAgY29uc3QgcmVzID0gYXdhaXQgZGh0LnJlcXVlc3QoCiAgICAgIHsgY29tbWFuZDogQ09NTUFORFMuUEVFUl9IT0xFUFVOQ0gsIHRhcmdldCwgdmFsdWU6IHJlcXVlc3RWYWx1ZSB9LAogICAgICB0bywKICAgICAgeyBzb2NrZXQsIHNlc3Npb24gfQogICAgKQoKICAgIGNvbnN0IGhwID0gZGVjb2RlKGhvbGVwdW5jaCwgcmVzLnZhbHVlKQogICAgaWYgKCFocCB8fCBocC5tb2RlICE9PSBSRVBMWSB8fCB0by5ob3N0ICE9PSByZXMuZnJvbS5ob3N0IHx8IHRvLnBvcnQgIT09IHJlcy5mcm9tLnBvcnQpIHsKICAgICAgdGhyb3cgQkFEX0hPTEVQVU5DSF9SRVBMWSgpCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZnJvbTogcmVzLmZyb20sCiAgICAgIHRvOiByZXMudG8sCiAgICAgIHBheWxvYWQ6IGhwLnBheWxvYWQsCiAgICAgIHBlZXJBZGRyZXNzOiBocC5wZWVyQWRkcmVzcyB8fCB0bwogICAgfQogIH0KCiAgYXN5bmMgb25wZWVyaG9sZXB1bmNoKHJlcSkgewogICAgY29uc3QgaHAgPSByZXEudmFsdWUgJiYgZGVjb2RlKGhvbGVwdW5jaCwgcmVxLnZhbHVlKQogICAgaWYgKCFocCkgcmV0dXJuCgogICAgY29uc3QgeyBtb2RlLCBpZCwgcGF5bG9hZCwgcGVlckFkZHJlc3MgfSA9IGhwCgogICAgY29uc3Qgc3RhdGUgPSByZXEudGFyZ2V0ICYmIHRoaXMuZ2V0KHJlcS50YXJnZXQpCiAgICBjb25zdCBpc1NlcnZlciA9ICEhKHN0YXRlICYmIHN0YXRlLm9ucGVlcmhvbGVwdW5jaCkKICAgIGNvbnN0IHJlbGF5ID0gc3RhdGUgJiYgc3RhdGUucmVsYXkKCiAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgY2FzZSBGUk9NX0NMSUVOVDogewogICAgICAgIGlmICghcGVlckFkZHJlc3MgJiYgIXJlbGF5KSByZXR1cm4KICAgICAgICByZXEucmVsYXkoCiAgICAgICAgICBjLmVuY29kZShob2xlcHVuY2gsIHsgbW9kZTogRlJPTV9SRUxBWSwgaWQsIHBheWxvYWQsIHBlZXJBZGRyZXNzOiByZXEuZnJvbSB9KSwKICAgICAgICAgIHBlZXJBZGRyZXNzIHx8IHJlbGF5CiAgICAgICAgKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGNhc2UgRlJPTV9SRUxBWTogewogICAgICAgIGlmICghaXNTZXJ2ZXIgfHwgIXBlZXJBZGRyZXNzKSByZXR1cm4KICAgICAgICBsZXQgcmVwbHkgPSBudWxsCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlcGx5ID0gYXdhaXQgc3RhdGUub25wZWVyaG9sZXB1bmNoKHsgaWQsIHBheWxvYWQsIHBlZXJBZGRyZXNzIH0sIHJlcSkKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBzYWZldHlDYXRjaChlKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIGlmICghcmVwbHkpIHJldHVybgogICAgICAgIGNvbnN0IG9wdHMgPSB7IHNvY2tldDogcmVwbHkuc29ja2V0LCBjbG9zZXJOb2RlczogZmFsc2UsIHRva2VuOiBmYWxzZSB9CiAgICAgICAgcmVxLnJlbGF5KAogICAgICAgICAgYy5lbmNvZGUoaG9sZXB1bmNoLCB7IG1vZGU6IEZST01fU0VSVkVSLCBpZDogMCwgcGF5bG9hZDogcmVwbHkucGF5bG9hZCwgcGVlckFkZHJlc3MgfSksCiAgICAgICAgICByZXEuZnJvbSwKICAgICAgICAgIG9wdHMKICAgICAgICApCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgY2FzZSBGUk9NX1NFUlZFUjogewogICAgICAgIHJlcS5yZXBseShjLmVuY29kZShob2xlcHVuY2gsIHsgbW9kZTogUkVQTFksIGlkLCBwYXlsb2FkLCBwZWVyQWRkcmVzczogcmVxLmZyb20gfSksIHsKICAgICAgICAgIHRvOiBwZWVyQWRkcmVzcywKICAgICAgICAgIGNsb3Nlck5vZGVzOiBmYWxzZSwKICAgICAgICAgIHRva2VuOiBmYWxzZQogICAgICAgIH0pCiAgICAgICAgcmV0dXJuIC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVjb2RlKGVuYywgdmFsKSB7CiAgdHJ5IHsKICAgIHJldHVybiBjLmRlY29kZShlbmMsIHZhbCkKICB9IGNhdGNoIHsKICAgIHJldHVybiBudWxsCiAgfQp9CgpmdW5jdGlvbiB0b1N0cmluZyh0KSB7CiAgcmV0dXJuIHR5cGVvZiB0ID09PSAnc3RyaW5nJyA/IHQgOiBiNGEudG9TdHJpbmcodCwgJ2hleCcpCn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHsgaG9sZXB1bmNoUGF5bG9hZCB9ID0gcmVxdWlyZSgnLi9tZXNzYWdlcycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEhvbGVwdW5jaFBheWxvYWQgewogIGNvbnN0cnVjdG9yKGhvbGVwdW5jaFNlY3JldCkgewogICAgdGhpcy5fc2hhcmVkU2VjcmV0ID0gaG9sZXB1bmNoU2VjcmV0CiAgICB0aGlzLl9sb2NhbFNlY3JldCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKCiAgICBzb2RpdW0ucmFuZG9tYnl0ZXNfYnVmKHRoaXMuX2xvY2FsU2VjcmV0KQogIH0KCiAgZGVjcnlwdChidWZmZXIpIHsKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMjQsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggLSAxNiwgYnVmZmVyIH0KCiAgICBpZiAoc3RhdGUuZW5kIDw9IHN0YXRlLnN0YXJ0KSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IG5vbmNlID0gYnVmZmVyLnN1YmFycmF5KDAsIDI0KQogICAgY29uc3QgbXNnID0gc3RhdGUuYnVmZmVyLnN1YmFycmF5KHN0YXRlLnN0YXJ0LCBzdGF0ZS5lbmQpCiAgICBjb25zdCBjaXBoZXIgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQpCgogICAgaWYgKCFzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9vcGVuX2Vhc3kobXNnLCBjaXBoZXIsIG5vbmNlLCB0aGlzLl9zaGFyZWRTZWNyZXQpKSByZXR1cm4gbnVsbAoKICAgIHRyeSB7CiAgICAgIHJldHVybiBob2xlcHVuY2hQYXlsb2FkLmRlY29kZShzdGF0ZSkKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0KCiAgZW5jcnlwdChwYXlsb2FkKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsgc3RhcnQ6IDI0LCBlbmQ6IDI0LCBidWZmZXI6IG51bGwgfQogICAgaG9sZXB1bmNoUGF5bG9hZC5wcmVlbmNvZGUoc3RhdGUsIHBheWxvYWQpCiAgICBzdGF0ZS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoc3RhdGUuZW5kICsgMTYpCgogICAgY29uc3Qgbm9uY2UgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoMCwgMjQpCiAgICBjb25zdCBtc2cgPSBzdGF0ZS5idWZmZXIuc3ViYXJyYXkoc3RhdGUuc3RhcnQsIHN0YXRlLmVuZCkKICAgIGNvbnN0IGNpcGhlciA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShzdGF0ZS5zdGFydCkKCiAgICBob2xlcHVuY2hQYXlsb2FkLmVuY29kZShzdGF0ZSwgcGF5bG9hZCkKICAgIHNvZGl1bS5yYW5kb21ieXRlc19idWYobm9uY2UpCiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldGJveF9lYXN5KGNpcGhlciwgbXNnLCBub25jZSwgdGhpcy5fc2hhcmVkU2VjcmV0KQoKICAgIHJldHVybiBzdGF0ZS5idWZmZXIKICB9CgogIHRva2VuKGFkZHIpIHsKICAgIGNvbnN0IG91dCA9IGI0YS5hbGxvY1Vuc2FmZSgzMikKICAgIHNvZGl1bS5jcnlwdG9fZ2VuZXJpY2hhc2gob3V0LCBiNGEuZnJvbShhZGRyLmhvc3QpLCB0aGlzLl9sb2NhbFNlY3JldCkKICAgIHJldHVybiBvdXQKICB9Cn0KY29uc3QgRE9ORSA9IFByb21pc2UucmVzb2x2ZSh0cnVlKQpjb25zdCBERVNUUk9ZRUQgPSBQcm9taXNlLnJlc29sdmUoZmFsc2UpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNlbWFwaG9yZSB7CiAgY29uc3RydWN0b3IobGltaXQgPSAxKSB7CiAgICB0aGlzLmxpbWl0ID0gbGltaXQKICAgIHRoaXMuYWN0aXZlID0gMAogICAgdGhpcy53YWl0aW5nID0gW10KCiAgICB0aGlzLmZsdXNoZWRQcm9taXNlID0gbnVsbAogICAgdGhpcy5mbHVzaGVkUmVzb2x2ZSA9IG51bGwKCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCgogICAgdGhpcy5fb253YWl0ID0gdGhpcy5fcXVldWVXYWl0aW5nLmJpbmQodGhpcykKICAgIHRoaXMuX29uZmx1c2ggPSB0aGlzLl9xdWV1ZUZsdXNoZWQuYmluZCh0aGlzKQogIH0KCiAgX3F1ZXVlV2FpdGluZyhyZXNvbHZlKSB7CiAgICB0aGlzLndhaXRpbmcucHVzaChyZXNvbHZlKQogIH0KCiAgX3F1ZXVlRmx1c2hlZChyZXNvbHZlKSB7CiAgICB0aGlzLmZsdXNoZWRSZXNvbHZlID0gcmVzb2x2ZQogIH0KCiAgd2FpdCgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuIERFU1RST1lFRAoKICAgIGlmICh0aGlzLmFjdGl2ZSA8IHRoaXMubGltaXQgJiYgdGhpcy53YWl0aW5nLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLmFjdGl2ZSsrCiAgICAgIHJldHVybiBET05FCiAgICB9CgogICAgcmV0dXJuIG5ldyBQcm9taXNlKHRoaXMuX29ud2FpdCkKICB9CgogIHNpZ25hbCgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuCgogICAgdGhpcy5hY3RpdmUtLQogICAgd2hpbGUgKHRoaXMuYWN0aXZlIDwgdGhpcy5saW1pdCAmJiB0aGlzLndhaXRpbmcubGVuZ3RoID4gMCAmJiB0aGlzLmRlc3Ryb3llZCA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy5hY3RpdmUrKwogICAgICB0aGlzLndhaXRpbmcuc2hpZnQoKSh0cnVlKQogICAgfQoKICAgIGlmICh0aGlzLmFjdGl2ZSA9PT0gMCAmJiB0aGlzLmZsdXNoZWRSZXNvbHZlKSB7CiAgICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLmZsdXNoZWRSZXNvbHZlCiAgICAgIHRoaXMuZmx1c2hlZFJlc29sdmUgPSBudWxsCiAgICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBudWxsCiAgICAgIHJlc29sdmUodHJ1ZSkKICAgIH0KICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSByZXR1cm4KICAgIGlmICh0aGlzLmFjdGl2ZSA9PT0gMCkgcmV0dXJuCiAgICBpZiAodGhpcy5mbHVzaGVkUHJvbWlzZSkgcmV0dXJuIHRoaXMuZmx1c2hlZFByb21pc2UKICAgIHRoaXMuZmx1c2hlZFByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9vbmZsdXNoKQogICAgcmV0dXJuIHRoaXMuZmx1c2hlZFByb21pc2UKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMuYWN0aXZlID0gMAogICAgd2hpbGUgKHRoaXMud2FpdGluZy5sZW5ndGgpIHRoaXMud2FpdGluZy5wb3AoKShmYWxzZSkKICAgIGlmICh0aGlzLmZsdXNoZWRSZXNvbHZlKSB0aGlzLmZsdXNoZWRSZXNvbHZlKGZhbHNlKQogIH0KfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3Qgc2FmZXR5Q2F0Y2ggPSByZXF1aXJlKCdzYWZldHktY2F0Y2gnKQpjb25zdCBOb2lzZVNlY3JldFN0cmVhbSA9IHJlcXVpcmUoJ0BoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0nKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCByZWxheSA9IHJlcXVpcmUoJ2JsaW5kLXJlbGF5JykKY29uc3QgTm9pc2VXcmFwID0gcmVxdWlyZSgnLi9ub2lzZS13cmFwJykKY29uc3QgQW5ub3VuY2VyID0gcmVxdWlyZSgnLi9hbm5vdW5jZXInKQpjb25zdCB7IEZJUkVXQUxMLCBFUlJPUiB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKQpjb25zdCB7IHVuc2xhYmJlZEhhc2ggfSA9IHJlcXVpcmUoJy4vY3J5cHRvJykKY29uc3QgU2VjdXJlUGF5bG9hZCA9IHJlcXVpcmUoJy4vc2VjdXJlLXBheWxvYWQnKQpjb25zdCBIb2xlcHVuY2hlciA9IHJlcXVpcmUoJy4vaG9sZXB1bmNoZXInKQpjb25zdCB7IGlzUHJpdmF0ZSB9ID0gcmVxdWlyZSgnYm9nb24nKQpjb25zdCB7IEFMUkVBRFlfTElTVEVOSU5HLCBOT0RFX0RFU1RST1lFRCwgS0VZUEFJUl9BTFJFQURZX1VTRUQgfSA9IHJlcXVpcmUoJy4vZXJyb3JzJykKCmNvbnN0IEhBTkRTSEFLRV9DTEVBUl9XQUlUID0gMTAwMDAKY29uc3QgSEFORFNIQUtFX0lOSVRJQUxfVElNRU9VVCA9IDEwMDAwCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNlcnZlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoZGh0LCBvcHRzID0ge30pIHsKICAgIHN1cGVyKCkKCiAgICB0aGlzLmRodCA9IGRodAogICAgdGhpcy50YXJnZXQgPSBudWxsCgogICAgdGhpcy5jbG9zZWQgPSBmYWxzZQogICAgdGhpcy5maXJld2FsbCA9IG9wdHMuZmlyZXdhbGwgfHwgKCgpID0+IGZhbHNlKQogICAgdGhpcy5ob2xlcHVuY2ggPSBvcHRzLmhvbGVwdW5jaCB8fCAoKCkgPT4gdHJ1ZSkKICAgIHRoaXMucmVsYXlUaHJvdWdoID0gb3B0cy5yZWxheVRocm91Z2ggfHwgbnVsbAogICAgdGhpcy5yZWxheUtlZXBBbGl2ZSA9IG9wdHMucmVsYXlLZWVwQWxpdmUgfHwgNTAwMAogICAgdGhpcy5wb29sID0gb3B0cy5wb29sIHx8IG51bGwKICAgIHRoaXMuY3JlYXRlSGFuZHNoYWtlID0gb3B0cy5jcmVhdGVIYW5kc2hha2UgfHwgZGVmYXVsdENyZWF0ZUhhbmRzaGFrZQogICAgdGhpcy5jcmVhdGVTZWNyZXRTdHJlYW0gPSBvcHRzLmNyZWF0ZVNlY3JldFN0cmVhbSB8fCBkZWZhdWx0Q3JlYXRlU2VjcmV0U3RyZWFtCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLmhhbmRzaGFrZUNsZWFyV2FpdCA9IG9wdHMuaGFuZHNoYWtlQ2xlYXJXYWl0IHx8IEhBTkRTSEFLRV9DTEVBUl9XQUlUCgogICAgdGhpcy5fc2hhcmVMb2NhbEFkZHJlc3MgPSBvcHRzLnNoYXJlTG9jYWxBZGRyZXNzICE9PSBmYWxzZQogICAgdGhpcy5fcmV1c2FibGVTb2NrZXQgPSAhIW9wdHMucmV1c2FibGVTb2NrZXQKICAgIHRoaXMuX25ldmVyUHVuY2ggPSBvcHRzLmhvbGVwdW5jaCA9PT0gZmFsc2UgLy8gdXNlZnVsIGZvciBmdWxseSBkaXNhYmxpbmcgcHVuY2hpbmcKICAgIHRoaXMuX2tleVBhaXIgPSBudWxsCiAgICB0aGlzLl9hbm5vdW5jZXIgPSBudWxsCiAgICB0aGlzLl9jb25uZWN0cyA9IG5ldyBNYXAoKQogICAgdGhpcy5faG9sZXB1bmNoZXMgPSBbXQogICAgdGhpcy5fbGlzdGVuaW5nID0gbnVsbAogICAgdGhpcy5fY2xvc2luZyA9IG51bGwKICB9CgogIGdldCBsaXN0ZW5pbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fbGlzdGVuaW5nICE9PSBudWxsCiAgfQoKICBnZXQgcHVibGljS2V5KCkgewogICAgcmV0dXJuIHRoaXMuX2tleVBhaXIgJiYgdGhpcy5fa2V5UGFpci5wdWJsaWNLZXkKICB9CgogIGdldCByZWxheUFkZHJlc3NlcygpIHsKICAgIHJldHVybiB0aGlzLl9hbm5vdW5jZXIgPyB0aGlzLl9hbm5vdW5jZXIucmVsYXlBZGRyZXNzZXMgOiBbXQogIH0KCiAgb25jb25uZWN0aW9uKGVuY3J5cHRlZFNvY2tldCkgewogICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgZW5jcnlwdGVkU29ja2V0KQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBsb2coJ1N1c3BlbmRpbmcgaHlwZXJkaHQgc2VydmVyJykKICAgIGlmICh0aGlzLl9saXN0ZW5pbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgbG9nKCdTdXNwZW5kaW5nIGh5cGVyZGh0IHNlcnZlciAocG9zdCBsaXN0ZW5pbmcpJykKICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQogICAgdGhpcy5fY2xlYXJBbGwoKQogICAgcmV0dXJuIHRoaXMuX2Fubm91bmNlciA/IHRoaXMuX2Fubm91bmNlci5zdXNwZW5kKHsgbG9nIH0pIDogUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIGFzeW5jIHJlc3VtZSgpIHsKICAgIGlmICh0aGlzLl9saXN0ZW5pbmcgIT09IG51bGwpIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZQogICAgcmV0dXJuIHRoaXMuX2Fubm91bmNlciA/IHRoaXMuX2Fubm91bmNlci5yZXN1bWUoKSA6IFByb21pc2UucmVzb2x2ZSgpCiAgfQoKICBhZGRyZXNzKCkgewogICAgaWYgKCF0aGlzLl9rZXlQYWlyKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7CiAgICAgIHB1YmxpY0tleTogdGhpcy5fa2V5UGFpci5wdWJsaWNLZXksCiAgICAgIGhvc3Q6IHRoaXMuZGh0Lmhvc3QsCiAgICAgIHBvcnQ6IHRoaXMuZGh0LnBvcnQKICAgIH0KICB9CgogIGNsb3NlKCkgewogICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybiB0aGlzLl9jbG9zaW5nCiAgICB0aGlzLl9jbG9zaW5nID0gdGhpcy5fY2xvc2UoKQogICAgcmV0dXJuIHRoaXMuX2Nsb3NpbmcKICB9CgogIF9nYygpIHsKICAgIHRoaXMuZGh0Lmxpc3RlbmluZy5kZWxldGUodGhpcykKICAgIGlmICh0aGlzLnRhcmdldCkgdGhpcy5kaHQuX3JvdXRlci5kZWxldGUodGhpcy50YXJnZXQpCiAgfQoKICBhc3luYyBfc3RvcExpc3RlbmluZygpIHsKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLl9hbm5vdW5jZXIpIGF3YWl0IHRoaXMuX2Fubm91bmNlci5zdG9wKCkKICAgIH0gY2F0Y2ggewogICAgICAvLyBpZ25vcmUKICAgIH0KCiAgICB0aGlzLl9hbm5vdW5jZXIgPSBudWxsCiAgICB0aGlzLl9saXN0ZW5pbmcgPSBudWxsCiAgICB0aGlzLl9rZXlQYWlyID0gbnVsbAogIH0KCiAgYXN5bmMgX2Nsb3NlKCkgewogICAgaWYgKHRoaXMuX2xpc3RlbmluZyA9PT0gbnVsbCkgewogICAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgfSBjYXRjaCB7fQoKICAgIHRoaXMuX2djKCkKICAgIHRoaXMuX2NsZWFyQWxsKCkKCiAgICBhd2FpdCB0aGlzLl9zdG9wTGlzdGVuaW5nKCkKCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogIH0KCiAgX2NsZWFyQWxsKCkgewogICAgd2hpbGUgKHRoaXMuX2hvbGVwdW5jaGVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgaCA9IHRoaXMuX2hvbGVwdW5jaGVzLnBvcCgpCiAgICAgIGlmIChoICYmIGgucHVuY2hlcikgaC5wdW5jaGVyLmRlc3Ryb3koKQogICAgICBpZiAoaCAmJiBoLmNsZWFyaW5nKSBjbGVhclRpbWVvdXQoaC5jbGVhcmluZykKICAgICAgaWYgKGggJiYgaC5wcmVwdW5jaGluZykgY2xlYXJUaW1lb3V0KGgucHJlcHVuY2hpbmcpCiAgICAgIGlmIChoICYmIGgucmF3U3RyZWFtKSBoLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgIH0KCiAgICB0aGlzLl9jb25uZWN0cy5jbGVhcigpCiAgfQoKICBhc3luYyBsaXN0ZW4oa2V5UGFpciA9IHRoaXMuZGh0LmRlZmF1bHRLZXlQYWlyLCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLl9saXN0ZW5pbmcgIT09IG51bGwpIHRocm93IEFMUkVBRFlfTElTVEVOSU5HKCkKICAgIGlmICh0aGlzLmRodC5kZXN0cm95ZWQpIHRocm93IE5PREVfREVTVFJPWUVEKCkKCiAgICB0aGlzLl9saXN0ZW5pbmcgPSB0aGlzLl9saXN0ZW4oa2V5UGFpciwgb3B0cykKICAgIGF3YWl0IHRoaXMuX2xpc3RlbmluZwogICAgcmV0dXJuIHRoaXMKICB9CgogIGFzeW5jIF9saXN0ZW4oa2V5UGFpciwgb3B0cykgewogICAgLy8gRnJvbSBub3cgb24sIHRoZSBESFQgb2JqZWN0IHdoaWNoIGNyZWF0ZWQgbWUgaXMgcmVzcG9uc2libGUgZm9yIGNsb3NpbmcgbWUKICAgIHRoaXMuZGh0Lmxpc3RlbmluZy5hZGQodGhpcykKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmRodC5iaW5kKCkKICAgICAgaWYgKHRoaXMuX2Nsb3NpbmcpIHJldHVybgoKICAgICAgZm9yIChjb25zdCBzIG9mIHRoaXMuZGh0Lmxpc3RlbmluZykgewogICAgICAgIGlmIChzLl9rZXlQYWlyICYmIGI0YS5lcXVhbHMocy5fa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIucHVibGljS2V5KSkgewogICAgICAgICAgdGhyb3cgS0VZUEFJUl9BTFJFQURZX1VTRUQoKQogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy50YXJnZXQgPSB1bnNsYWJiZWRIYXNoKGtleVBhaXIucHVibGljS2V5KQogICAgICB0aGlzLl9rZXlQYWlyID0ga2V5UGFpcgogICAgICB0aGlzLl9hbm5vdW5jZXIgPSBuZXcgQW5ub3VuY2VyKHRoaXMuZGh0LCBrZXlQYWlyLCB0aGlzLnRhcmdldCwgb3B0cykKCiAgICAgIHRoaXMuZGh0Ll9yb3V0ZXIuc2V0KHRoaXMudGFyZ2V0LCB7CiAgICAgICAgcmVsYXk6IG51bGwsCiAgICAgICAgcmVjb3JkOiB0aGlzLl9hbm5vdW5jZXIucmVjb3JkLAogICAgICAgIG9ucGVlcmhhbmRzaGFrZTogdGhpcy5fb25wZWVyaGFuZHNoYWtlLmJpbmQodGhpcyksCiAgICAgICAgb25wZWVyaG9sZXB1bmNoOiB0aGlzLl9vbnBlZXJob2xlcHVuY2guYmluZCh0aGlzKQogICAgICB9KQoKICAgICAgLy8gd2FybSBpdCB1cCBmb3Igbm93CiAgICAgIHRoaXMuX2xvY2FsQWRkcmVzc2VzKCkuY2F0Y2goc2FmZXR5Q2F0Y2gpCgogICAgICBhd2FpdCB0aGlzLl9hbm5vdW5jZXIuc3RhcnQoKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGF3YWl0IHRoaXMuX3N0b3BMaXN0ZW5pbmcoKQogICAgICB0aGlzLl9nYygpCiAgICAgIHRocm93IGVycgogICAgfQoKICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4KICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgYXdhaXQgdGhpcy5fYW5ub3VuY2VyLnN1c3BlbmQoKQoKICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4KICAgIGlmICh0aGlzLmRodC5kZXN0cm95ZWQpIHRocm93IE5PREVfREVTVFJPWUVEKCkKCiAgICBpZiAodGhpcy5wb29sKSB0aGlzLnBvb2wuX2F0dGFjaFNlcnZlcih0aGlzKQoKICAgIHRoaXMuZW1pdCgnbGlzdGVuaW5nJykKICB9CgogIHJlZnJlc2goKSB7CiAgICBpZiAodGhpcy5fYW5ub3VuY2VyICYmICF0aGlzLnN1c3BlbmRlZCkgdGhpcy5fYW5ub3VuY2VyLnJlZnJlc2goKQogIH0KCiAgbm90aWZ5T25saW5lKCkgewogICAgaWYgKHRoaXMuX2Fubm91bmNlcikgdGhpcy5fYW5ub3VuY2VyLm9ubGluZS5ub3RpZnkoKQogIH0KCiAgX2xvY2FsQWRkcmVzc2VzKCkgewogICAgcmV0dXJuIHRoaXMuZGh0LnZhbGlkYXRlTG9jYWxBZGRyZXNzZXMoSG9sZXB1bmNoZXIubG9jYWxBZGRyZXNzZXModGhpcy5kaHQuaW8uc2VydmVyU29ja2V0KSkKICB9CgogIGFzeW5jIF9hZGRIYW5kc2hha2Uoaywgbm9pc2UsIGNsaWVudEFkZHJlc3MsIHsgZnJvbSwgdG86IHNlcnZlckFkZHJlc3MsIHNvY2tldCB9LCBkaXJlY3QpIHsKICAgIGxldCBpZCA9IHRoaXMuX2hvbGVwdW5jaGVzLmluZGV4T2YobnVsbCkKICAgIGlmIChpZCA9PT0gLTEpIGlkID0gdGhpcy5faG9sZXB1bmNoZXMucHVzaChudWxsKSAtIDEKCiAgICBjb25zdCBocyA9IHsKICAgICAgcm91bmQ6IDAsCiAgICAgIHJlcGx5OiBudWxsLAogICAgICBwdW5jaGVyOiBudWxsLAogICAgICBwYXlsb2FkOiBudWxsLAogICAgICByYXdTdHJlYW06IG51bGwsCiAgICAgIGVuY3J5cHRlZFNvY2tldDogbnVsbCwKICAgICAgcHJlcHVuY2hpbmc6IG51bGwsCiAgICAgIGZpcmV3YWxsZWQ6IHRydWUsCiAgICAgIGNsZWFyaW5nOiBudWxsLAogICAgICBvbnNvY2tldDogbnVsbCwKICAgICAgYWJvcnRlZDogZmFsc2UsCgogICAgICAvLyBSZWxheSBzdGF0ZQogICAgICByZWxheVRpbWVvdXQ6IG51bGwsCiAgICAgIHJlbGF5VG9rZW46IG51bGwsCiAgICAgIHJlbGF5U29ja2V0OiBudWxsLAogICAgICByZWxheUNsaWVudDogbnVsbCwKICAgICAgcmVsYXlQYWlyZWQ6IGZhbHNlCiAgICB9CgogICAgdGhpcy5faG9sZXB1bmNoZXNbaWRdID0gaHMKCiAgICBjb25zdCBoYW5kc2hha2UgPSB0aGlzLmNyZWF0ZUhhbmRzaGFrZSh0aGlzLl9rZXlQYWlyLCBudWxsKQoKICAgIGxldCByZW1vdGVQYXlsb2FkCiAgICB0cnkgewogICAgICByZW1vdGVQYXlsb2FkID0gYXdhaXQgaGFuZHNoYWtlLnJlY3Yobm9pc2UpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICB0cnkgewogICAgICBocy5maXJld2FsbGVkID0gYXdhaXQgdGhpcy5maXJld2FsbChoYW5kc2hha2UucmVtb3RlUHVibGljS2V5LCByZW1vdGVQYXlsb2FkLCBjbGllbnRBZGRyZXNzKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNhZmV0eUNhdGNoKGVycikKICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICBpZiAoaHMuZmlyZXdhbGxlZCkgewogICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCBlcnJvciA9CiAgICAgIHJlbW90ZVBheWxvYWQudmVyc2lvbiA9PT0gMQogICAgICAgID8gcmVtb3RlUGF5bG9hZC51ZHgKICAgICAgICAgID8gRVJST1IuTk9ORQogICAgICAgICAgOiBFUlJPUi5BQk9SVEVECiAgICAgICAgOiBFUlJPUi5WRVJTSU9OX01JU01BVENICgogICAgY29uc3QgYWRkcmVzc2VzID0gW10KICAgIGNvbnN0IG91clJlbW90ZUFkZHIgPSB0aGlzLmRodC5yZW1vdGVBZGRyZXNzKCkKICAgIGNvbnN0IG91ckxvY2FsQWRkcnMgPSB0aGlzLl9zaGFyZUxvY2FsQWRkcmVzcyA/IGF3YWl0IHRoaXMuX2xvY2FsQWRkcmVzc2VzKCkgOiBudWxsCgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHJldHVybiBudWxsCgogICAgaWYgKG91clJlbW90ZUFkZHIpIGFkZHJlc3Nlcy5wdXNoKG91clJlbW90ZUFkZHIpCiAgICBpZiAob3VyTG9jYWxBZGRycykgYWRkcmVzc2VzLnB1c2goLi4ub3VyTG9jYWxBZGRycykKCiAgICBpZiAoZXJyb3IgPT09IEVSUk9SLk5PTkUpIHsKICAgICAgaHMucmF3U3RyZWFtID0gdGhpcy5kaHQuY3JlYXRlUmF3U3RyZWFtKHsKICAgICAgICBmcmFtZWQ6IHRydWUsCiAgICAgICAgZmlyZXdhbGwoc29ja2V0LCBwb3J0LCBob3N0KSB7CiAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgdHJhZmZpYyBvcmlnaW5hdGVkIGZyb20gdGhlIHNvY2tldCBvbiB3aGljaCB3ZSdyZSBleHBlY3RpbmcgcmVsYXkgdHJhZmZpYy4gSWYgc28sCiAgICAgICAgICAvLyB3ZSBoYXZlbid0IGhvbGUgcHVuY2hlZCB5ZXQgYW5kIHRoZSBvdGhlciBzaWRlIGlzIGp1c3Qgc2VuZGluZyB1cyB0cmFmZmljIHRocm91Z2ggdGhlIHJlbGF5LgogICAgICAgICAgaWYgKGhzLnJlbGF5U29ja2V0ICYmIGlzUmVsYXkoaHMucmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICB9CgogICAgICAgICAgaHMub25zb2NrZXQoc29ja2V0LCBwb3J0LCBob3N0KQogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICB9KQoKICAgICAgaHMucmF3U3RyZWFtLm9uKCdlcnJvcicsIGF1dG9EZXN0cm95KQoKICAgICAgLy8gSGFuZGxlcyB0aGUgY2FzZSB3aGVyZSBvbnNvY2tldCBpcyBuZXZlciBjYWxsZWQsIGJ1dCB0aGUgc3RyZWFtIGdvdCBzZXR1cAogICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gb24gYSByZWxheWVkIGNvbm5lY3Rpb24gd2hpY2ggbmV2ZXIgY29ubmVjdHMgZGlyZWN0bHkKICAgICAgLy8gKG9uc29ja2V0IGlzIGNhbGxlZCB0aGVyZSBvbmx5IHdoZW4gdGhlIGRpcmVjdCBjb25uZWN0aW9uIGlzIGVzdGFibGlzaGVkKQogICAgICBjb25zdCBvbnJhd3N0cmVhbWNsb3NlID0gKCkgPT4gewogICAgICAgIGlmICh0aGlzLl9jbG9zaW5nKSByZXR1cm4KICAgICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKICAgICAgfQogICAgICBocy5yYXdTdHJlYW0ub24oJ2Nsb3NlJywgb25yYXdzdHJlYW1jbG9zZSkKCiAgICAgIGhzLm9uc29ja2V0ID0gKHNvY2tldCwgcG9ydCwgaG9zdCkgPT4gewogICAgICAgIGlmIChocy5yYXdTdHJlYW0gPT09IG51bGwpIHJldHVybiAvLyBBbHJlYWR5IGhvbGUgcHVuY2hlZAoKICAgICAgICB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykKCiAgICAgICAgaWYgKGhzLnByZXB1bmNoaW5nKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoaHMucHJlcHVuY2hpbmcpCiAgICAgICAgICBocy5wcmVwdW5jaGluZyA9IG51bGwKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9yZXVzYWJsZVNvY2tldCAmJiByZW1vdGVQYXlsb2FkLnVkeC5yZXVzYWJsZVNvY2tldCkgewogICAgICAgICAgdGhpcy5kaHQuX3NvY2tldFBvb2wucm91dGVzLmFkZChoYW5kc2hha2UucmVtb3RlUHVibGljS2V5LCBocy5yYXdTdHJlYW0pCiAgICAgICAgfQoKICAgICAgICBocy5yYXdTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgYXV0b0Rlc3Ryb3kpCiAgICAgICAgaHMucmF3U3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9ucmF3c3RyZWFtY2xvc2UpCgogICAgICAgIGlmIChocy5yYXdTdHJlYW0uY29ubmVjdGVkKSB7CiAgICAgICAgICBjb25zdCByZW1vdGVDaGFuZ2luZyA9IGhzLnJhd1N0cmVhbS5jaGFuZ2VSZW1vdGUoc29ja2V0LCByZW1vdGVQYXlsb2FkLnVkeC5pZCwgcG9ydCwgaG9zdCkKCiAgICAgICAgICBpZiAocmVtb3RlQ2hhbmdpbmcpIHJlbW90ZUNoYW5naW5nLmNhdGNoKHNhZmV0eUNhdGNoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBocy5yYXdTdHJlYW0uY29ubmVjdChzb2NrZXQsIHJlbW90ZVBheWxvYWQudWR4LmlkLCBwb3J0LCBob3N0KQogICAgICAgICAgaHMuZW5jcnlwdGVkU29ja2V0ID0gdGhpcy5jcmVhdGVTZWNyZXRTdHJlYW0oZmFsc2UsIGhzLnJhd1N0cmVhbSwgewogICAgICAgICAgICBoYW5kc2hha2U6IGgsCiAgICAgICAgICAgIGtlZXBBbGl2ZTogdGhpcy5kaHQuY29ubmVjdGlvbktlZXBBbGl2ZQogICAgICAgICAgfSkKCiAgICAgICAgICB0aGlzLm9uY29ubmVjdGlvbihocy5lbmNyeXB0ZWRTb2NrZXQpCiAgICAgICAgfQoKICAgICAgICBpZiAoaHMucHVuY2hlcikgewogICAgICAgICAgaHMucHVuY2hlci5vbmFib3J0ID0gbm9vcAogICAgICAgICAgaHMucHVuY2hlci5kZXN0cm95KCkKICAgICAgICB9CgogICAgICAgIGhzLnJhd1N0cmVhbSA9IG51bGwKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYXV0b0Rlc3Ryb3koKSB7CiAgICAgICAgaWYgKGhzLnB1bmNoZXIpIGhzLnB1bmNoZXIuZGVzdHJveSgpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCByZWxheUFkZHJlc3NlcyA9IHRoaXMucmVsYXlBZGRyZXNzZXMKICAgIGNvbnN0IHJlbGF5VGhyb3VnaCA9IHNlbGVjdFJlbGF5KHRoaXMucmVsYXlUaHJvdWdoKQoKICAgIGlmIChyZWxheVRocm91Z2gpIGhzLnJlbGF5VG9rZW4gPSByZWxheS50b2tlbigpCgogICAgdHJ5IHsKICAgICAgaHMucmVwbHkgPSBhd2FpdCBoYW5kc2hha2Uuc2VuZCh7CiAgICAgICAgZXJyb3IsCiAgICAgICAgZmlyZXdhbGw6IG91clJlbW90ZUFkZHIgPyBGSVJFV0FMTC5PUEVOIDogRklSRVdBTEwuVU5LTk9XTiwKICAgICAgICBob2xlcHVuY2g6IG91clJlbW90ZUFkZHIgPyBudWxsIDogeyBpZCwgcmVsYXlzOiB0aGlzLl9hbm5vdW5jZXIucmVsYXlzIH0sCiAgICAgICAgYWRkcmVzc2VzNDogYWRkcmVzc2VzLAogICAgICAgIGFkZHJlc3NlczY6IG51bGwsCiAgICAgICAgdWR4OiB7CiAgICAgICAgICByZXVzYWJsZVNvY2tldDogdGhpcy5fcmV1c2FibGVTb2NrZXQsCiAgICAgICAgICBpZDogaHMucmF3U3RyZWFtID8gaHMucmF3U3RyZWFtLmlkIDogMCwKICAgICAgICAgIHNlcTogMAogICAgICAgIH0sCiAgICAgICAgc2VjcmV0U3RyZWFtOiB7fSwKICAgICAgICByZWxheVRocm91Z2g6IHJlbGF5VGhyb3VnaCA/IHsgcHVibGljS2V5OiByZWxheVRocm91Z2gsIHRva2VuOiBocy5yZWxheVRva2VuIH0gOiBudWxsLAogICAgICAgIHJlbGF5QWRkcmVzc2VzOiByZWxheUFkZHJlc3Nlcy5sZW5ndGggPyByZWxheUFkZHJlc3NlcyA6IG51bGwKICAgICAgfSkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBzYWZldHlDYXRjaChlcnIpCiAgICAgIGhzLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgaWYgKHRoaXMuX2Nsb3NpbmcgfHwgdGhpcy5zdXNwZW5kZWQpIHsKICAgICAgaHMucmF3U3RyZWFtLmRlc3Ryb3koKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IGggPSBoYW5kc2hha2UuZmluYWwoKQoKICAgIGlmIChlcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgICBocy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICAgIHRoaXMuX2NsZWFyTGF0ZXIoaHMsIGlkLCBrKQogICAgICByZXR1cm4gaHMKICAgIH0KCiAgICBpZiAocmVtb3RlUGF5bG9hZC5maXJld2FsbCA9PT0gRklSRVdBTEwuT1BFTiB8fCBkaXJlY3QpIHsKICAgICAgY29uc3Qgc29jayA9IGRpcmVjdCA/IHNvY2tldCA6IHRoaXMuZGh0LnNvY2tldAogICAgICB0aGlzLmRodC5zdGF0cy5wdW5jaGVzLm9wZW4rKwogICAgICBocy5vbnNvY2tldChzb2NrLCBjbGllbnRBZGRyZXNzLnBvcnQsIGNsaWVudEFkZHJlc3MuaG9zdCkKICAgICAgcmV0dXJuIGhzCiAgICB9CgogICAgaWYgKHJlbGF5VGhyb3VnaCB8fCByZW1vdGVQYXlsb2FkLnJlbGF5VGhyb3VnaCkgewogICAgICB0aGlzLl9yZWxheUNvbm5lY3Rpb24oaHMsIHJlbGF5VGhyb3VnaCwgcmVtb3RlUGF5bG9hZCwgaCkKICAgIH0KCiAgICBjb25zdCBvbmFib3J0ID0gKCkgPT4gewogICAgICBocy5hYm9ydGVkID0gdHJ1ZQogICAgICBpZiAoaHMucHJlcHVuY2hpbmcpIGNsZWFyVGltZW91dChocy5wcmVwdW5jaGluZykKICAgICAgaHMucHJlcHVuY2hpbmcgPSBudWxsCiAgICAgIGlmIChocy5yYXdTdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgdGhpcy5fY2xlYXJMYXRlcihocywgaWQsIGspCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGhzLnJhd1N0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB0aGlzLl9jbGVhckxhdGVyKGhzLCBpZCwgaykpCiAgICAgIGlmIChocy5yZWxheVRva2VuID09PSBudWxsKSBocy5yYXdTdHJlYW0uZGVzdHJveSgpCiAgICB9CgogICAgaWYgKCFkaXJlY3QgJiYgY2xpZW50QWRkcmVzcy5ob3N0ID09PSBzZXJ2ZXJBZGRyZXNzLmhvc3QpIHsKICAgICAgY29uc3QgY2xpZW50QWRkcmVzc2VzID0gcmVtb3RlUGF5bG9hZC5hZGRyZXNzZXM0LmZpbHRlcihvbmx5UHJpdmF0ZUhvc3RzKQoKICAgICAgaWYgKGNsaWVudEFkZHJlc3Nlcy5sZW5ndGggPiAwICYmIHRoaXMuX3NoYXJlTG9jYWxBZGRyZXNzKSB7CiAgICAgICAgY29uc3QgbXlBZGRyZXNzZXMgPSBhd2FpdCB0aGlzLl9sb2NhbEFkZHJlc3NlcygpCiAgICAgICAgY29uc3QgYWRkciA9IEhvbGVwdW5jaGVyLm1hdGNoQWRkcmVzcyhteUFkZHJlc3NlcywgY2xpZW50QWRkcmVzc2VzKQoKICAgICAgICBpZiAoYWRkcikgewogICAgICAgICAgaHMucHJlcHVuY2hpbmcgPSBzZXRUaW1lb3V0KG9uYWJvcnQsIEhBTkRTSEFLRV9JTklUSUFMX1RJTUVPVVQpCiAgICAgICAgICByZXR1cm4gaHMKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5fY2xvc2luZyB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuIG51bGwKCiAgICBpZiAob3VyUmVtb3RlQWRkciB8fCB0aGlzLl9uZXZlclB1bmNoKSB7CiAgICAgIGhzLnByZXB1bmNoaW5nID0gc2V0VGltZW91dChvbmFib3J0LCBIQU5EU0hBS0VfSU5JVElBTF9USU1FT1VUKQogICAgICByZXR1cm4gaHMKICAgIH0KCiAgICBocy5wYXlsb2FkID0gbmV3IFNlY3VyZVBheWxvYWQoaC5ob2xlcHVuY2hTZWNyZXQpCiAgICBocy5wdW5jaGVyID0gbmV3IEhvbGVwdW5jaGVyKHRoaXMuZGh0LCB0aGlzLmRodC5zZXNzaW9uKCksIGZhbHNlLCByZW1vdGVQYXlsb2FkLmZpcmV3YWxsKQoKICAgIGhzLnB1bmNoZXIub25jb25uZWN0ID0gaHMub25zb2NrZXQKICAgIGhzLnB1bmNoZXIub25hYm9ydCA9IG9uYWJvcnQKICAgIGhzLnByZXB1bmNoaW5nID0gc2V0VGltZW91dChocy5wdW5jaGVyLmRlc3Ryb3kuYmluZChocy5wdW5jaGVyKSwgSEFORFNIQUtFX0lOSVRJQUxfVElNRU9VVCkKCiAgICByZXR1cm4gaHMKICB9CgogIF9jbGVhckxhdGVyKGhzLCBpZCwgaykgewogICAgaWYgKGhzLmNsZWFyaW5nKSByZXR1cm4KICAgIGhzLmNsZWFyaW5nID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLl9jbGVhcihocywgaWQsIGspLCB0aGlzLmhhbmRzaGFrZUNsZWFyV2FpdCkKICB9CgogIF9jbGVhcihocywgaWQsIGspIHsKICAgIGlmIChpZCA+PSB0aGlzLl9ob2xlcHVuY2hlcy5sZW5ndGggfHwgdGhpcy5faG9sZXB1bmNoZXNbaWRdICE9PSBocykgcmV0dXJuCiAgICBpZiAoaHMuY2xlYXJpbmcpIGNsZWFyVGltZW91dChocy5jbGVhcmluZykKCiAgICB0aGlzLl9ob2xlcHVuY2hlc1tpZF0gPSBudWxsCiAgICB3aGlsZSAoCiAgICAgIHRoaXMuX2hvbGVwdW5jaGVzLmxlbmd0aCA+IDAgJiYKICAgICAgdGhpcy5faG9sZXB1bmNoZXNbdGhpcy5faG9sZXB1bmNoZXMubGVuZ3RoIC0gMV0gPT09IG51bGwKICAgICkgewogICAgICB0aGlzLl9ob2xlcHVuY2hlcy5wb3AoKQogICAgfQogICAgdGhpcy5fY29ubmVjdHMuZGVsZXRlKGspCiAgfQoKICBhc3luYyBfb25wZWVyaGFuZHNoYWtlKHsgbm9pc2UsIHBlZXJBZGRyZXNzIH0sIHJlcSkgewogICAgY29uc3QgayA9IGI0YS50b1N0cmluZyhub2lzZSwgJ2hleCcpCgogICAgLy8gVGhlIG5leHQgY291cGxlIG9mIHN0YXRlbWVudHMgTVVTVCBydW4gd2l0aGluIHRoZSBzYW1lIHRpY2sgdG8gcHJldmVudAogICAgLy8gYSBtYWxpY2lvdXMgcGVlciBmcm9tIGZsb29kaW5nIHVzIHdpdGggaGFuZHNoYWtlcy4KICAgIGxldCBwID0gdGhpcy5fY29ubmVjdHMuZ2V0KGspCiAgICBpZiAoIXApIHsKICAgICAgcCA9IHRoaXMuX2FkZEhhbmRzaGFrZShrLCBub2lzZSwgcGVlckFkZHJlc3MgfHwgcmVxLmZyb20sIHJlcSwgIXBlZXJBZGRyZXNzKQogICAgICB0aGlzLl9jb25uZWN0cy5zZXQoaywgcCkKICAgIH0KCiAgICBjb25zdCBoID0gYXdhaXQgcAogICAgaWYgKCFoKSByZXR1cm4gbnVsbAoKICAgIGlmICh0aGlzLl9jbG9zaW5nICE9PSBudWxsIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIHJldHVybiB7IHNvY2tldDogaC5wdW5jaGVyICYmIGgucHVuY2hlci5zb2NrZXQsIG5vaXNlOiBoLnJlcGx5IH0KICB9CgogIGFzeW5jIF9vbnBlZXJob2xlcHVuY2goeyBpZCwgcGVlckFkZHJlc3MsIHBheWxvYWQgfSwgcmVxKSB7CiAgICBjb25zdCBoID0gaWQgPCB0aGlzLl9ob2xlcHVuY2hlcy5sZW5ndGggPyB0aGlzLl9ob2xlcHVuY2hlc1tpZF0gOiBudWxsCiAgICBpZiAoIWgpIHJldHVybiBudWxsCgogICAgaWYgKCFwZWVyQWRkcmVzcyB8fCB0aGlzLl9jbG9zaW5nICE9PSBudWxsIHx8IHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHAgPSBoLnB1bmNoZXIKICAgIGlmICghcCB8fCAhcC5zb2NrZXQpIHJldHVybiB0aGlzLl9hYm9ydChoKSAvLyBub3Qgb3BlbmVkCgogICAgY29uc3QgcmVtb3RlUGF5bG9hZCA9IGgucGF5bG9hZC5kZWNyeXB0KHBheWxvYWQpCiAgICBpZiAoIXJlbW90ZVBheWxvYWQpIHJldHVybiBudWxsCgogICAgY29uc3QgaXNTZXJ2ZXJSZWxheSA9IHRoaXMuX2Fubm91bmNlci5pc1JlbGF5KHJlcS5mcm9tKQogICAgY29uc3QgeyBlcnJvciwgZmlyZXdhbGwsIHJvdW5kLCBwdW5jaGluZywgYWRkcmVzc2VzLCByZW1vdGVBZGRyZXNzLCByZW1vdGVUb2tlbiB9ID0KICAgICAgcmVtb3RlUGF5bG9hZAoKICAgIGlmIChlcnJvciAhPT0gRVJST1IuTk9ORSkgewogICAgICAvLyBXZSBhY3R1YWxseSBkbyBub3QgbmVlZCB0byBzZXQgdGhlIHJvdW5kIGhlcmUsIGJ1dCBqdXN0IGRvIGl0IGZvciBjb25zaXN0ZW5jeS4KICAgICAgaWYgKHJvdW5kID49IGgucm91bmQpIGgucm91bmQgPSByb3VuZAogICAgICByZXR1cm4gdGhpcy5fYWJvcnQoaCkKICAgIH0KCiAgICBjb25zdCB0b2tlbiA9IGgucGF5bG9hZC50b2tlbihwZWVyQWRkcmVzcykKICAgIGNvbnN0IGVjaG9lZCA9IGlzU2VydmVyUmVsYXkgJiYgISFyZW1vdGVUb2tlbiAmJiBiNGEuZXF1YWxzKHRva2VuLCByZW1vdGVUb2tlbikKCiAgICAvLyBVcGRhdGUgb3VyIGhldXJpc3RpY3MgaGVyZQogICAgaWYgKHJlcS5zb2NrZXQgPT09IHAuc29ja2V0KSB7CiAgICAgIHAubmF0LmFkZChyZXEudG8sIHJlcS5mcm9tKQogICAgfQoKICAgIGlmIChyb3VuZCA+PSBoLnJvdW5kKSB7CiAgICAgIGgucm91bmQgPSByb3VuZAogICAgICBwLnVwZGF0ZVJlbW90ZSh7IHB1bmNoaW5nLCBmaXJld2FsbCwgYWRkcmVzc2VzLCB2ZXJpZmllZDogZWNob2VkID8gcGVlckFkZHJlc3MuaG9zdCA6IG51bGwgfSkKICAgIH0KCiAgICAvLyBXYWl0IGZvciB0aGUgYW5hbHl6ZXIgdG8gcmVhY2ggYSBjb25jbHVzaW9uLi4uCiAgICBsZXQgc3RhYmxlID0gYXdhaXQgcC5hbmFseXplKGZhbHNlKQogICAgaWYgKHAuZGVzdHJveWVkKSByZXR1cm4gbnVsbAoKICAgIGlmICghcC5yZW1vdGVIb2xlcHVuY2hpbmcgJiYgIXN0YWJsZSkgewogICAgICBzdGFibGUgPSBhd2FpdCBwLmFuYWx5emUodHJ1ZSkKICAgICAgaWYgKHAuZGVzdHJveWVkKSByZXR1cm4gbnVsbAogICAgICBpZiAoIXN0YWJsZSkgcmV0dXJuIHRoaXMuX2Fib3J0KGgpCiAgICB9CgogICAgLy8gRmFzdCBtb2RlISBJZiB3ZSBhcmUgY29uc2lzdGVudCBhbmQgdGhlIHJlbW90ZSBoYXMgb3BlbmVkIGEgc2Vzc2lvbiB0byB1cyAocmVtb3RlQWRkcmVzcykKICAgIC8vIHRoZW4gZmlyZSBhIHF1aWNrIHB1bmNoIGJhY2suIE5vdGUgdGhlIGF3YWl0IGhlcmUganVzdCB3YWl0cyBmb3IgdGhlIHVkcCBzb2NrZXQgdG8gZmx1c2guCiAgICBpZiAoCiAgICAgIGlzQ29uc2lzdGVudChwLm5hdC5maXJld2FsbCkgJiYKICAgICAgcmVtb3RlQWRkcmVzcyAmJgogICAgICBoYXNTYW1lQWRkcihwLm5hdC5hZGRyZXNzZXMsIHJlbW90ZUFkZHJlc3MpCiAgICApIHsKICAgICAgYXdhaXQgcC5waW5nKHBlZXJBZGRyZXNzKQogICAgICBpZiAocC5kZXN0cm95ZWQpIHJldHVybiBudWxsCiAgICB9CgogICAgLy8gUmVtb3RlIHNhaWQgdGhleSBhcmUgcHVuY2hpbmcgKG9yIHdpbGxpbmcgdG8pLCBzbyB3ZSB3aWxsIHB1bmNoIGFzIHdlbGwuCiAgICAvLyBOb3RlIHRoYXQgdGhpcyByZXR1cm5zIHdoZW4gdGhlIHB1bmNoaW5nIGhhcyBTVEFSVEVELCBzbyBubyBndWFyYW50ZWUKICAgIC8vIHdlIHdpbGwgaGF2ZSBhIGNvbm5lY3Rpb24gYWZ0ZXIgdGhpcyBwcm9taXNlIGV0Yy4KICAgIGlmIChwLnJlbW90ZUhvbGVwdW5jaGluZykgewogICAgICAvLyBUT0RPOiBzdGlsbCBjb250aW51ZSBoZXJlIGlmIGEgbG9jYWwgY29ubmVjdGlvbiBtaWdodCB3b3JrLCBidXQgdGhlbiBkbyBub3QgaG9sZXB1bmNoLi4uCiAgICAgIGlmICghdGhpcy5ob2xlcHVuY2gocC5yZW1vdGVGaXJld2FsbCwgcC5uYXQuZmlyZXdhbGwsIHAucmVtb3RlQWRkcmVzc2VzLCBwLm5hdC5hZGRyZXNzZXMpKSB7CiAgICAgICAgcmV0dXJuIHAuZGVzdHJveWVkID8gbnVsbCA6IHRoaXMuX2Fib3J0KGgpCiAgICAgIH0KCiAgICAgIGlmIChoLnByZXB1bmNoaW5nKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGgucHJlcHVuY2hpbmcpCiAgICAgICAgaC5wcmVwdW5jaGluZyA9IG51bGwKICAgICAgfQoKICAgICAgaWYgKHAucmVtb3RlRmlyZXdhbGwgPj0gRklSRVdBTEwuUkFORE9NIHx8IHAubmF0LmZpcmV3YWxsID49IEZJUkVXQUxMLlJBTkRPTSkgewogICAgICAgIGlmICgKICAgICAgICAgIHRoaXMuZGh0Ll9yYW5kb21QdW5jaGVzID49IHRoaXMuZGh0Ll9yYW5kb21QdW5jaExpbWl0IHx8CiAgICAgICAgICBEYXRlLm5vdygpIC0gdGhpcy5kaHQuX2xhc3RSYW5kb21QdW5jaCA8IHRoaXMuZGh0Ll9yYW5kb21QdW5jaEludGVydmFsCiAgICAgICAgKSB7CiAgICAgICAgICBpZiAoIWgucmVsYXlUb2tlbikgcmV0dXJuIHRoaXMuX2Fib3J0KGgsIEVSUk9SLlRSWV9MQVRFUikKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNvY2tldDogcC5zb2NrZXQsCiAgICAgICAgICAgIHBheWxvYWQ6IGgucGF5bG9hZC5lbmNyeXB0KHsKICAgICAgICAgICAgICBlcnJvcjogRVJST1IuVFJZX0xBVEVSLAogICAgICAgICAgICAgIGZpcmV3YWxsOiBwLm5hdC5maXJld2FsbCwKICAgICAgICAgICAgICByb3VuZDogaC5yb3VuZCwKICAgICAgICAgICAgICBjb25uZWN0ZWQ6IHAuY29ubmVjdGVkLAogICAgICAgICAgICAgIHB1bmNoaW5nOiBwLnB1bmNoaW5nLAogICAgICAgICAgICAgIGFkZHJlc3NlczogcC5uYXQuYWRkcmVzc2VzLAogICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgICAgICAgICAgdG9rZW46IGlzU2VydmVyUmVsYXkgPyB0b2tlbiA6IG51bGwsCiAgICAgICAgICAgICAgcmVtb3RlVG9rZW46IHJlbW90ZVBheWxvYWQudG9rZW4KICAgICAgICAgICAgfSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHB1bmNoaW5nID0gYXdhaXQgcC5wdW5jaCgpCiAgICAgIGlmIChwLmRlc3Ryb3llZCkgcmV0dXJuIG51bGwKICAgICAgaWYgKCFwdW5jaGluZykgcmV0dXJuIHRoaXMuX2Fib3J0KGgpCiAgICB9CgogICAgLy8gRnJlZXplIHRoYXQgYW5hbHlzaXMgYXMgc29vbiBhcyB3ZSBoYXZlIGEgcmVzdWx0IHdlIGFyZSBnaXZpbmcgdG8gdGhlIG90aGVyIHBlZXIKICAgIGlmIChwLm5hdC5maXJld2FsbCAhPT0gRklSRVdBTEwuVU5LTk9XTikgewogICAgICBwLm5hdC5mcmVlemUoKQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHNvY2tldDogcC5zb2NrZXQsCiAgICAgIHBheWxvYWQ6IGgucGF5bG9hZC5lbmNyeXB0KHsKICAgICAgICBlcnJvcjogRVJST1IuTk9ORSwKICAgICAgICBmaXJld2FsbDogcC5uYXQuZmlyZXdhbGwsCiAgICAgICAgcm91bmQ6IGgucm91bmQsCiAgICAgICAgY29ubmVjdGVkOiBwLmNvbm5lY3RlZCwKICAgICAgICBwdW5jaGluZzogcC5wdW5jaGluZywKICAgICAgICBhZGRyZXNzZXM6IHAubmF0LmFkZHJlc3NlcywKICAgICAgICByZW1vdGVBZGRyZXNzOiBudWxsLAogICAgICAgIHRva2VuOiBpc1NlcnZlclJlbGF5ID8gdG9rZW4gOiBudWxsLAogICAgICAgIHJlbW90ZVRva2VuOiByZW1vdGVQYXlsb2FkLnRva2VuCiAgICAgIH0pCiAgICB9CiAgfQoKICBfYWJvcnQoaCwgZXJyb3IgPSBFUlJPUi5BQk9SVEVEKSB7CiAgICBpZiAoIWgucGF5bG9hZCkgewogICAgICBpZiAoaC5wdW5jaGVyKSBoLnB1bmNoZXIuZGVzdHJveSgpCiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3QgcGF5bG9hZCA9IGgucGF5bG9hZC5lbmNyeXB0KHsKICAgICAgZXJyb3IsCiAgICAgIGZpcmV3YWxsOiBGSVJFV0FMTC5VTktOT1dOLAogICAgICByb3VuZDogaC5yb3VuZCwKICAgICAgY29ubmVjdGVkOiBmYWxzZSwKICAgICAgcHVuY2hpbmc6IGZhbHNlLAogICAgICBhZGRyZXNzZXM6IG51bGwsCiAgICAgIHJlbW90ZUFkZHJlc3M6IG51bGwsCiAgICAgIHRva2VuOiBudWxsLAogICAgICByZW1vdGVUb2tlbjogbnVsbAogICAgfSkKCiAgICBoLnB1bmNoZXIuZGVzdHJveSgpCgogICAgcmV0dXJuIHsgc29ja2V0OiB0aGlzLmRodC5zb2NrZXQsIHBheWxvYWQgfQogIH0KCiAgX3JlbGF5Q29ubmVjdGlvbihocywgcmVsYXlUaHJvdWdoLCByZW1vdGVQYXlsb2FkLCBoKSB7CiAgICB0aGlzLmRodC5zdGF0cy5yZWxheWluZy5hdHRlbXB0cysrCgogICAgbGV0IGlzSW5pdGlhdG9yCiAgICBsZXQgcHVibGljS2V5CiAgICBsZXQgdG9rZW4KCiAgICBpZiAocmVsYXlUaHJvdWdoKSB7CiAgICAgIGlzSW5pdGlhdG9yID0gdHJ1ZQogICAgICBwdWJsaWNLZXkgPSByZWxheVRocm91Z2gKICAgICAgdG9rZW4gPSBocy5yZWxheVRva2VuCiAgICB9IGVsc2UgewogICAgICBpc0luaXRpYXRvciA9IGZhbHNlCiAgICAgIHB1YmxpY0tleSA9IHJlbW90ZVBheWxvYWQucmVsYXlUaHJvdWdoLnB1YmxpY0tleQogICAgICB0b2tlbiA9IHJlbW90ZVBheWxvYWQucmVsYXlUaHJvdWdoLnRva2VuCiAgICB9CgogICAgaHMucmVsYXlUb2tlbiA9IHRva2VuCiAgICBocy5yZWxheVNvY2tldCA9IHRoaXMuZGh0LmNvbm5lY3QocHVibGljS2V5KQogICAgaHMucmVsYXlTb2NrZXQuc2V0S2VlcEFsaXZlKHRoaXMucmVsYXlLZWVwQWxpdmUpCiAgICBocy5yZWxheUNsaWVudCA9IHJlbGF5LkNsaWVudC5mcm9tKGhzLnJlbGF5U29ja2V0LCB7IGlkOiBocy5yZWxheVNvY2tldC5wdWJsaWNLZXkgfSkKICAgIGhzLnJlbGF5VGltZW91dCA9IHNldFRpbWVvdXQob25hYm9ydCwgMTUwMDApCgogICAgaHMucmVsYXlDbGllbnQKICAgICAgLnBhaXIoaXNJbml0aWF0b3IsIHRva2VuLCBocy5yYXdTdHJlYW0pCiAgICAgIC5vbignZXJyb3InLCBvbmFib3J0KQogICAgICAub24oJ2RhdGEnLCAocmVtb3RlSWQpID0+IHsKICAgICAgICBpZiAoaHMucmVsYXlUaW1lb3V0KSBjbGVhclJlbGF5VGltZW91dChocykKICAgICAgICBpZiAoaHMucmF3U3RyZWFtID09PSBudWxsKSB7CiAgICAgICAgICBvbmFib3J0KG51bGwpCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGhzLnJlbGF5UGFpcmVkID0gdHJ1ZQogICAgICAgIHRoaXMuZGh0LnN0YXRzLnJlbGF5aW5nLnN1Y2Nlc3NlcysrCgogICAgICAgIGlmIChocy5wcmVwdW5jaGluZykgY2xlYXJUaW1lb3V0KGhzLnByZXB1bmNoaW5nKQogICAgICAgIGhzLnByZXB1bmNoaW5nID0gbnVsbAoKICAgICAgICBjb25zdCB7IHJlbW90ZVBvcnQsIHJlbW90ZUhvc3QsIHNvY2tldCB9ID0gaHMucmVsYXlTb2NrZXQucmF3U3RyZWFtCgogICAgICAgIGhzLnJhd1N0cmVhbQogICAgICAgICAgLm9uKCdjbG9zZScsICgpID0+IGhzLnJlbGF5U29ja2V0LmRlc3Ryb3koKSkKICAgICAgICAgIC5jb25uZWN0KHNvY2tldCwgcmVtb3RlSWQsIHJlbW90ZVBvcnQsIHJlbW90ZUhvc3QpCgogICAgICAgIGhzLmVuY3J5cHRlZFNvY2tldCA9IHRoaXMuY3JlYXRlU2VjcmV0U3RyZWFtKGZhbHNlLCBocy5yYXdTdHJlYW0sIHsgaGFuZHNoYWtlOiBoIH0pCgogICAgICAgIHRoaXMub25jb25uZWN0aW9uKGhzLmVuY3J5cHRlZFNvY2tldCkKICAgICAgfSkKCiAgICBjb25zdCBkaHQgPSB0aGlzLmRodAogICAgZnVuY3Rpb24gb25hYm9ydCgpIHsKICAgICAgaWYgKCFocy5yZWxheVBhaXJlZCkgZGh0LnN0YXRzLnJlbGF5aW5nLmFib3J0cysrCiAgICAgIGlmIChocy5yZWxheVRpbWVvdXQpIGNsZWFyUmVsYXlUaW1lb3V0KGhzKQogICAgICBjb25zdCBzb2NrZXQgPSBocy5yZWxheVNvY2tldAogICAgICBocy5yZWxheVRva2VuID0gbnVsbAogICAgICBocy5yZWxheVNvY2tldCA9IG51bGwKICAgICAgaWYgKHNvY2tldCkgc29ja2V0LmRlc3Ryb3koKQogICAgICBpZiAoaHMuYWJvcnRlZCAmJiBocy5yYXdTdHJlYW0pIGhzLnJhd1N0cmVhbS5kZXN0cm95KCkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNsZWFyUmVsYXlUaW1lb3V0KGhzKSB7CiAgY2xlYXJUaW1lb3V0KGhzLnJlbGF5VGltZW91dCkKICBocy5yZWxheVRpbWVvdXQgPSBudWxsCn0KCmZ1bmN0aW9uIGlzQ29uc2lzdGVudChmdykgewogIHJldHVybiBmdyA9PT0gRklSRVdBTEwuT1BFTiB8fCBmdyA9PT0gRklSRVdBTEwuQ09OU0lTVEVOVAp9CgpmdW5jdGlvbiBoYXNTYW1lQWRkcihhZGRycywgb3RoZXIpIHsKICBpZiAoYWRkcnMgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICBmb3IgKGNvbnN0IGFkZHIgb2YgYWRkcnMpIHsKICAgIGlmIChhZGRyLnBvcnQgPT09IG90aGVyLnBvcnQgJiYgYWRkci5ob3N0ID09PSBvdGhlci5ob3N0KSByZXR1cm4gdHJ1ZQogIH0KICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZUhhbmRzaGFrZShrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpIHsKICByZXR1cm4gbmV3IE5vaXNlV3JhcChrZXlQYWlyLCByZW1vdGVQdWJsaWNLZXkpCn0KCmZ1bmN0aW9uIGRlZmF1bHRDcmVhdGVTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykgewogIHJldHVybiBuZXcgTm9pc2VTZWNyZXRTdHJlYW0oaXNJbml0aWF0b3IsIHJhd1N0cmVhbSwgb3B0cykKfQoKZnVuY3Rpb24gb25seVByaXZhdGVIb3N0cyhhZGRyKSB7CiAgcmV0dXJuIGlzUHJpdmF0ZShhZGRyLmhvc3QpCn0KCmZ1bmN0aW9uIGlzUmVsYXkocmVsYXlTb2NrZXQsIHNvY2tldCwgcG9ydCwgaG9zdCkgewogIGNvbnN0IHN0cmVhbSA9IHJlbGF5U29ja2V0LnJhd1N0cmVhbQogIGlmICghc3RyZWFtKSByZXR1cm4gZmFsc2UKICBpZiAoc3RyZWFtLnNvY2tldCAhPT0gc29ja2V0KSByZXR1cm4gZmFsc2UKICByZXR1cm4gcG9ydCA9PT0gc3RyZWFtLnJlbW90ZVBvcnQgJiYgaG9zdCA9PT0gc3RyZWFtLnJlbW90ZUhvc3QKfQoKZnVuY3Rpb24gc2VsZWN0UmVsYXkocmVsYXlUaHJvdWdoKSB7CiAgaWYgKHR5cGVvZiByZWxheVRocm91Z2ggPT09ICdmdW5jdGlvbicpIHJlbGF5VGhyb3VnaCA9IHJlbGF5VGhyb3VnaCgpCiAgaWYgKHJlbGF5VGhyb3VnaCA9PT0gbnVsbCkgcmV0dXJuIG51bGwKICBpZiAoQXJyYXkuaXNBcnJheShyZWxheVRocm91Z2gpKSB7CiAgICByZXR1cm4gcmVsYXlUaHJvdWdoW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHJlbGF5VGhyb3VnaC5sZW5ndGgpXQogIH0KICByZXR1cm4gcmVsYXlUaHJvdWdoCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNsZWVwZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX3Jlc29sdmUgPSBudWxsCgogICAgdGhpcy5fc3RhcnQgPSAocmVzb2x2ZSkgPT4gewogICAgICB0aGlzLl9yZXNvbHZlID0gcmVzb2x2ZQogICAgfQoKICAgIHRoaXMuX3RyaWdnZXIgPSAoKSA9PiB7CiAgICAgIGlmICh0aGlzLl9yZXNvbHZlID09PSBudWxsKSByZXR1cm4KICAgICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuX3Jlc29sdmUKICAgICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgICAgcmVzb2x2ZSgpCiAgICB9CiAgfQoKICBwYXVzZShtcykgewogICAgY29uc3QgcCA9IG5ldyBQcm9taXNlKHRoaXMuX3N0YXJ0KQogICAgaWYgKHRoaXMuX3RpbWVvdXQgIT09IG51bGwpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpCiAgICAgIHRoaXMuX3RyaWdnZXIoKQogICAgfQogICAgdGhpcy5fdGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fdHJpZ2dlciwgbXMpCiAgICByZXR1cm4gcAogIH0KCiAgcmVzdW1lKCkgewogICAgaWYgKHRoaXMuX3RpbWVvdXQgIT09IG51bGwpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpCiAgICAgIHRoaXMuX3RyaWdnZXIoKQogICAgfQogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgTElOR0VSX1RJTUUgPSAzMDAwCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNvY2tldFBvb2wgewogIGNvbnN0cnVjdG9yKGRodCwgaG9zdCkgewogICAgdGhpcy5fZGh0ID0gZGh0CiAgICB0aGlzLl9zb2NrZXRzID0gbmV3IE1hcCgpCiAgICB0aGlzLl9saW5nZXJpbmcgPSBuZXcgU2V0KCkgLy8gdXBkYXRlZCBieSB0aGUgcmVmCiAgICB0aGlzLl9ob3N0ID0gaG9zdAoKICAgIHRoaXMucm91dGVzID0gbmV3IFNvY2tldFJvdXRlcyh0aGlzKQogIH0KCiAgX29ubWVzc2FnZShyZWYsIGRhdGEsIGFkZHJlc3MpIHsKICAgIHRoaXMuX2RodC5vbm1lc3NhZ2UocmVmLnNvY2tldCwgZGF0YSwgYWRkcmVzcykKICB9CgogIF9hZGQocmVmKSB7CiAgICB0aGlzLl9zb2NrZXRzLnNldChyZWYuc29ja2V0LCByZWYpCiAgfQoKICBfcmVtb3ZlKHJlZikgewogICAgdGhpcy5fc29ja2V0cy5kZWxldGUocmVmLnNvY2tldCkKICAgIHRoaXMuX2xpbmdlcmluZy5kZWxldGUocmVmKQogIH0KCiAgbG9va3VwKHNvY2tldCkgewogICAgcmV0dXJuIHRoaXMuX3NvY2tldHMuZ2V0KHNvY2tldCkgfHwgbnVsbAogIH0KCiAgc2V0UmV1c2FibGUoc29ja2V0LCBib29sKSB7CiAgICBjb25zdCByZWYgPSB0aGlzLmxvb2t1cChzb2NrZXQpCiAgICBpZiAocmVmKSByZWYucmV1c2FibGUgPSBib29sCiAgfQoKICBhY3F1aXJlKCkgewogICAgLy8gVE9ETzogRW5hYmxlIHNvY2tldCByZXVzZQogICAgcmV0dXJuIG5ldyBTb2NrZXRSZWYodGhpcykKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBjb25zdCBjbG9zaW5nID0gW10KCiAgICBmb3IgKGNvbnN0IHJlZiBvZiB0aGlzLl9zb2NrZXRzLnZhbHVlcygpKSB7CiAgICAgIHJlZi5fdW5saW5nZXIoKQogICAgICBjbG9zaW5nLnB1c2gocmVmLnNvY2tldC5jbG9zZSgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChjbG9zaW5nKQogIH0KfQoKY2xhc3MgU29ja2V0Um91dGVzIHsKICBjb25zdHJ1Y3Rvcihwb29sKSB7CiAgICB0aGlzLl9wb29sID0gcG9vbAogICAgdGhpcy5fcm91dGVzID0gbmV3IE1hcCgpCiAgfQoKICBhZGQocHVibGljS2V5LCByYXdTdHJlYW0pIHsKICAgIGlmIChyYXdTdHJlYW0uc29ja2V0KSB0aGlzLl9vbmNvbm5lY3QocHVibGljS2V5LCByYXdTdHJlYW0pCiAgICBlbHNlIHJhd1N0cmVhbS5vbignY29ubmVjdCcsIHRoaXMuX29uY29ubmVjdC5iaW5kKHRoaXMsIHB1YmxpY0tleSwgcmF3U3RyZWFtKSkKICB9CgogIGdldChwdWJsaWNLZXkpIHsKICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgICBjb25zdCByb3V0ZSA9IHRoaXMuX3JvdXRlcy5nZXQoaWQpCiAgICBpZiAoIXJvdXRlKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHJvdXRlCiAgfQoKICBfb25jb25uZWN0KHB1YmxpY0tleSwgcmF3U3RyZWFtKSB7CiAgICBjb25zdCBpZCA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQogICAgY29uc3Qgc29ja2V0ID0gcmF3U3RyZWFtLnNvY2tldAoKICAgIGxldCByb3V0ZSA9IHRoaXMuX3JvdXRlcy5nZXQoaWQpCgogICAgaWYgKCFyb3V0ZSkgewogICAgICBjb25zdCBnYyA9ICgpID0+IHsKICAgICAgICBpZiAodGhpcy5fcm91dGVzLmdldChpZCkgPT09IHJvdXRlKSB0aGlzLl9yb3V0ZXMuZGVsZXRlKGlkKQogICAgICAgIHNvY2tldC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBnYykKICAgICAgfQoKICAgICAgcm91dGUgPSB7CiAgICAgICAgc29ja2V0LAogICAgICAgIGFkZHJlc3M6IHsgaG9zdDogcmF3U3RyZWFtLnJlbW90ZUhvc3QsIHBvcnQ6IHJhd1N0cmVhbS5yZW1vdGVQb3J0IH0sCiAgICAgICAgZ2MKICAgICAgfQoKICAgICAgdGhpcy5fcm91dGVzLnNldChpZCwgcm91dGUpCiAgICAgIHNvY2tldC5vbignY2xvc2UnLCBnYykKICAgIH0KCiAgICB0aGlzLl9wb29sLnNldFJldXNhYmxlKHNvY2tldCwgdHJ1ZSkKCiAgICByYXdTdHJlYW0ub24oJ2Vycm9yJywgKCkgPT4gewogICAgICB0aGlzLl9wb29sLnNldFJldXNhYmxlKHNvY2tldCwgZmFsc2UpCiAgICAgIGlmICghcm91dGUpIHJvdXRlID0gdGhpcy5fcm91dGVzLmdldChpZCkKICAgICAgaWYgKHJvdXRlICYmIHJvdXRlLnNvY2tldCA9PT0gc29ja2V0KSByb3V0ZS5nYygpCiAgICB9KQogIH0KfQoKLy8gVE9ETzogd2Ugc2hvdWxkIGp1c3QgbWFrZSBzb21lICJ1c2VyIGRhdGEiIG9iamVjdCBvbiB1ZHggdG8gYWxsb3cgdG8gYXR0YWNoIHRoaXMgaW5mbwpjbGFzcyBTb2NrZXRSZWYgewogIGNvbnN0cnVjdG9yKHBvb2wpIHsKICAgIHRoaXMuX3Bvb2wgPSBwb29sCgogICAgLy8gRXZlbnRzCiAgICB0aGlzLm9uaG9sZXB1bmNobWVzc2FnZSA9IG5vb3AKCiAgICAvLyBXaGV0aGVyIGl0IHNob3VsZCB0ZWFyZG93biBpbW1lZGlhdGVseSBvciB3YWl0IGEgYml0CiAgICB0aGlzLnJldXNhYmxlID0gZmFsc2UKCiAgICB0aGlzLnNvY2tldCA9IHBvb2wuX2RodC51ZHguY3JlYXRlU29ja2V0KCkKICAgIHRoaXMuc29ja2V0CiAgICAgIC5vbignY2xvc2UnLCB0aGlzLl9vbmNsb3NlLmJpbmQodGhpcykpCiAgICAgIC5vbignbWVzc2FnZScsIHRoaXMuX29ubWVzc2FnZS5iaW5kKHRoaXMpKQogICAgICAub24oJ2lkbGUnLCB0aGlzLl9vbmlkbGUuYmluZCh0aGlzKSkKICAgICAgLm9uKCdidXN5JywgdGhpcy5fb25idXN5LmJpbmQodGhpcykpCiAgICAgIC5iaW5kKDAsIHRoaXMuX3Bvb2wuX2hvc3QpCgogICAgdGhpcy5fcmVmcyA9IDEKICAgIHRoaXMuX3JlbGVhc2VkID0gZmFsc2UKICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlCgogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX3dhc0J1c3kgPSBmYWxzZQoKICAgIHRoaXMuX3Bvb2wuX2FkZCh0aGlzKQogIH0KCiAgX29uY2xvc2UoKSB7CiAgICB0aGlzLl9wb29sLl9yZW1vdmUodGhpcykKICB9CgogIF9vbm1lc3NhZ2UoZGF0YSwgYWRkcmVzcykgewogICAgaWYgKGRhdGEuYnl0ZUxlbmd0aCA+IDEpIHsKICAgICAgdGhpcy5fcG9vbC5fb25tZXNzYWdlKHRoaXMsIGRhdGEsIGFkZHJlc3MpCiAgICB9IGVsc2UgewogICAgICB0aGlzLm9uaG9sZXB1bmNobWVzc2FnZShkYXRhLCBhZGRyZXNzLCB0aGlzKQogICAgfQogIH0KCiAgX29uaWRsZSgpIHsKICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogIH0KCiAgX29uYnVzeSgpIHsKICAgIHRoaXMuX3dhc0J1c3kgPSB0cnVlCiAgICB0aGlzLl91bmxpbmdlcigpCiAgfQoKICBfcmVzZXQoKSB7CiAgICB0aGlzLm9uaG9sZXB1bmNobWVzc2FnZSA9IG5vb3AKICB9CgogIF9jbG9zZU1heWJlKCkgewogICAgaWYgKHRoaXMuX3JlZnMgPT09IDAgJiYgdGhpcy5zb2NrZXQuaWRsZSAmJiAhdGhpcy5fdGltZW91dCkgdGhpcy5fY2xvc2UoKQogIH0KCiAgX2xpbmdlcmluZ0Nsb3NlKCkgewogICAgdGhpcy5fcG9vbC5fbGluZ2VyaW5nLmRlbGV0ZSh0aGlzKQogICAgdGhpcy5fdGltZW91dCA9IG51bGwKICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogIH0KCiAgX2Nsb3NlKCkgewogICAgdGhpcy5fdW5saW5nZXIoKQoKICAgIGlmICh0aGlzLnJldXNhYmxlICYmIHRoaXMuX3dhc0J1c3kpIHsKICAgICAgdGhpcy5fd2FzQnVzeSA9IGZhbHNlCiAgICAgIHRoaXMuX3Bvb2wuX2xpbmdlcmluZy5hZGQodGhpcykKICAgICAgdGhpcy5fdGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fbGluZ2VyaW5nQ2xvc2UuYmluZCh0aGlzKSwgTElOR0VSX1RJTUUpCiAgICAgIHJldHVybgogICAgfQoKICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKICAgIHRoaXMuc29ja2V0LmNsb3NlKCkKICB9CgogIF91bmxpbmdlcigpIHsKICAgIGlmICh0aGlzLl90aW1lb3V0ICE9PSBudWxsKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KQogICAgICB0aGlzLl9wb29sLl9saW5nZXJpbmcuZGVsZXRlKHRoaXMpCiAgICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsCiAgICB9CiAgfQoKICBnZXQgZnJlZSgpIHsKICAgIHJldHVybiB0aGlzLl9yZWZzID09PSAwCiAgfQoKICBhY3RpdmUoKSB7CiAgICB0aGlzLl9yZWZzKysKICAgIHRoaXMuX3VubGluZ2VyKCkKICB9CgogIGluYWN0aXZlKCkgewogICAgdGhpcy5fcmVmcy0tCiAgICB0aGlzLl9jbG9zZU1heWJlKCkKICB9CgogIGFkZHJlc3MoKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQuYWRkcmVzcygpCiAgfQoKICByZWxlYXNlKCkgewogICAgaWYgKHRoaXMuX3JlbGVhc2VkKSByZXR1cm4KCiAgICB0aGlzLl9yZWxlYXNlZCA9IHRydWUKICAgIHRoaXMuX3Jlc2V0KCkKCiAgICB0aGlzLl9yZWZzLS0KICAgIHRoaXMuX2Nsb3NlTWF5YmUoKQogIH0KfQoKZnVuY3Rpb24gbm9vcCgpIHt9CnsKICAibmFtZSI6ICJoeXBlcmRodCIsCiAgInZlcnNpb24iOiAiNi4yNy4xIiwKICAiZGVzY3JpcHRpb24iOiAiVGhlIERIVCBwb3dlcmluZyBIeXBlcnN3YXJtIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImJyb3dzZXIiOiAiYnJvd3Nlci5qcyIsCiAgImJpbiI6IHsKICAgICJoeXBlcmRodCI6ICIuL2Jpbi5qcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiYnJvd3Nlci5qcyIsCiAgICAidGVzdG5ldC5qcyIsCiAgICAiYmluLmpzIiwKICAgICJsaWIvKiouanMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfSwKICAgICJjaGlsZF9wcm9jZXNzIjogewogICAgICAiYmFyZSI6ICJiYXJlLW5vZGUtY2hpbGQtcHJvY2VzcyIsCiAgICAgICJkZWZhdWx0IjogImNoaWxkX3Byb2Nlc3MiCiAgICB9CiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuNi4yIiwKICAgICJiNGEiOiAiXjEuMy4xIiwKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiLAogICAgImJsaW5kLXJlbGF5IjogIl4xLjMuMCIsCiAgICAiYm9nb24iOiAiXjEuMC4wIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjQuMSIsCiAgICAiY29tcGFjdC1lbmNvZGluZy1uZXQiOiAiXjEuMC4xIiwKICAgICJkaHQtcnBjIjogIl42LjE1LjEiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuMy4wIiwKICAgICJoeXBlcmNvcmUtaWQtZW5jb2RpbmciOiAiXjEuMi4wIiwKICAgICJub2lzZS1jdXJ2ZS1lZCI6ICJeMi4wLjAiLAogICAgIm5vaXNlLWhhbmRzaGFrZSI6ICJeNC4wLjAiLAogICAgInJlY29yZC1jYWNoZSI6ICJeMS4xLjEiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjEiLAogICAgInNpZ25hbC1wcm9taXNlIjogIl4xLjAuMyIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjEiLAogICAgInN0cmVhbXgiOiAiXjIuMTYuMSIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIsCiAgICAieGFjaGUiOiAiXjEuMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLW5vZGUtY2hpbGQtcHJvY2VzcyI6ICJeMS4wLjEiLAogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJncmFjZWZ1bC1nb29kYnllIjogIl4xLjMuMCIsCiAgICAibmV3bGluZS1kZWNvZGVyIjogIl4xLjAuMiIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgInRlc3QiOiAicHJldHRpZXIgLS1jaGVjayAuICYmIG5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmdlbmVyYXRlIjogImJyaXR0bGUgLXIgdGVzdC9hbGwuanMgdGVzdC8qLmpzIiwKICAgICJpbnRlZ3JhdGlvbiI6ICJicml0dGxlIHRlc3QvaW50ZWdyYXRpb24vKi5qcyIsCiAgICAiZW5kLXRvLWVuZCI6ICJicml0dGxlIHRlc3QvZW5kLXRvLWVuZC8qLmpzIgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJkaXJlY3RvcmllcyI6IHsKICAgICJsaWIiOiAibGliIiwKICAgICJ0ZXN0IjogInRlc3QiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJkaHQuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogW10sCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcmRodC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyZGh0I3JlYWRtZSIKfQp7CiAgIm5hbWUiOiAiaHlwZXJzY2hlbWEiLAogICJ2ZXJzaW9uIjogIjEuMTguMCIsCiAgImRlc2NyaXB0aW9uIjogIkNyZWF0ZSByZWdpc3RyaWVzIG9mIGRlY2xhcmF0aXZlIGNvbXBhY3QtZW5jb2Rpbmcgc2NoZW1hcyIsCiAgImZpbGVzIjogWwogICAgImxpYi8qLmpzIiwKICAgICJidWlsZGVyLm1qcyIsCiAgICAiYnVpbGRlci5janMiLAogICAgInJ1bnRpbWUubWpzIiwKICAgICJydW50aW1lLmNqcyIsCiAgICAicHJpbWl0aXZlcy5tanMiLAogICAgInByaW1pdGl2ZXMuY2pzIgogIF0sCiAgImV4cG9ydHMiOiB7CiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIiwKICAgICIuIjogewogICAgICAiaW1wb3J0IjogIi4vYnVpbGRlci5tanMiLAogICAgICAiZGVmYXVsdCI6ICIuL2J1aWxkZXIuY2pzIgogICAgfSwKICAgICIuL3J1bnRpbWUiOiB7CiAgICAgICJpbXBvcnQiOiAiLi9ydW50aW1lLm1qcyIsCiAgICAgICJkZWZhdWx0IjogIi4vcnVudGltZS5janMiCiAgICB9LAogICAgIi4vcHJpbWl0aXZlcyI6IHsKICAgICAgImltcG9ydCI6ICIuL3ByaW1pdGl2ZXMubWpzIiwKICAgICAgImRlZmF1bHQiOiAiLi9wcmltaXRpdmVzLmNqcyIKICAgIH0KICB9LAogICJpbXBvcnRzIjogewogICAgImZzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWZzIiwKICAgICAgImRlZmF1bHQiOiAiZnMiCiAgICB9LAogICAgInBhdGgiOiB7CiAgICAgICJiYXJlIjogImJhcmUtcGF0aCIsCiAgICAgICJkZWZhdWx0IjogInBhdGgiCiAgICB9CiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJmb3JtYXQiOiAicHJldHRpZXIgLiAtLXdyaXRlIiwKICAgICJ0ZXN0IjogInByZXR0aWVyIC4gLS1jaGVjayAmJiBicml0dGxlIHRlc3QvaW5kZXguanMiLAogICAgInRlc3Q6YmFyZSI6ICJwcmV0dGllciAuIC0tY2hlY2sgJiYgYmFyZSB0ZXN0L2luZGV4LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc2NoZW1hLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc2NoZW1hL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzY2hlbWEjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtZnMiOiAiXjQuMC4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjE1LjAiLAogICAgImdlbmVyYXRlLW9iamVjdC1wcm9wZXJ0eSI6ICJeMi4wLjAiLAogICAgImdlbmVyYXRlLXN0cmluZyI6ICJeMS4wLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuNy4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIiwKICAgICJ0ZXN0LXRtcCI6ICJeMS4zLjAiCiAgfQp9Cm1vZHVsZS5leHBvcnRzID0gewogIGM6IHJlcXVpcmUoJ2NvbXBhY3QtZW5jb2RpbmcnKQp9CmNvbnN0IHsgRXZlbnRFbWl0dGVyIH0gPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCB7IGdldFN0cmVhbUVycm9yIH0gPSByZXF1aXJlKCdzdHJlYW14JykKY29uc3QgREhUID0gcmVxdWlyZSgnaHlwZXJkaHQnKQpjb25zdCBzcHEgPSByZXF1aXJlKCdzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZScpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBQZWVySW5mbyA9IHJlcXVpcmUoJy4vbGliL3BlZXItaW5mbycpCmNvbnN0IFJldHJ5VGltZXIgPSByZXF1aXJlKCcuL2xpYi9yZXRyeS10aW1lcicpCmNvbnN0IENvbm5lY3Rpb25TZXQgPSByZXF1aXJlKCcuL2xpYi9jb25uZWN0aW9uLXNldCcpCmNvbnN0IFBlZXJEaXNjb3ZlcnkgPSByZXF1aXJlKCcuL2xpYi9wZWVyLWRpc2NvdmVyeScpCgpjb25zdCBNQVhfUEVFUlMgPSA2NApjb25zdCBNQVhfUEFSQUxMRUwgPSAzCmNvbnN0IE1BWF9DTElFTlRfQ09OTkVDVElPTlMgPSBJbmZpbml0eSAvLyBUT0RPOiBDaGFuZ2UKY29uc3QgTUFYX1NFUlZFUl9DT05ORUNUSU9OUyA9IEluZmluaXR5Cgpjb25zdCBFUlJfTUlTU0lOR19UT1BJQyA9ICdUb3BpYyBpcyByZXF1aXJlZCBhbmQgbXVzdCBiZSBhIDMyLWJ5dGUgYnVmZmVyJwpjb25zdCBFUlJfREVTVFJPWUVEID0gJ1N3YXJtIGhhcyBiZWVuIGRlc3Ryb3llZCcKY29uc3QgRVJSX0RVUExJQ0FURSA9ICdEdXBsaWNhdGUgY29ubmVjdGlvbicKY29uc3QgRVJSX0ZJUkVXQUxMID0gJ1BlZXIgaXMgZmlyZXdhbGxlZCcKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgSHlwZXJzd2FybSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3Iob3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCiAgICBjb25zdCB7CiAgICAgIHNlZWQsCiAgICAgIHJlbGF5VGhyb3VnaCwKICAgICAga2V5UGFpciA9IERIVC5rZXlQYWlyKHNlZWQpLAogICAgICBtYXhQZWVycyA9IE1BWF9QRUVSUywKICAgICAgbWF4Q2xpZW50Q29ubmVjdGlvbnMgPSBNQVhfQ0xJRU5UX0NPTk5FQ1RJT05TLAogICAgICBtYXhTZXJ2ZXJDb25uZWN0aW9ucyA9IE1BWF9TRVJWRVJfQ09OTkVDVElPTlMsCiAgICAgIG1heFBhcmFsbGVsID0gTUFYX1BBUkFMTEVMLAogICAgICBmaXJld2FsbCA9IGFsbG93QWxsCiAgICB9ID0gb3B0cwogICAgdGhpcy5rZXlQYWlyID0ga2V5UGFpcgoKICAgIHRoaXMuZGh0ID0KICAgICAgb3B0cy5kaHQgfHwKICAgICAgbmV3IERIVCh7CiAgICAgICAgYm9vdHN0cmFwOiBvcHRzLmJvb3RzdHJhcCwKICAgICAgICBub2Rlczogb3B0cy5ub2RlcywKICAgICAgICBwb3J0OiBvcHRzLnBvcnQsCiAgICAgICAgZGVmZXJSYW5kb21QdW5jaDogb3B0cy5kZWZlclJhbmRvbVB1bmNoLAogICAgICAgIHJhbmRvbVB1bmNoSW50ZXJ2YWw6IG9wdHMucmFuZG9tUHVuY2hJbnRlcnZhbAogICAgICB9KQogICAgdGhpcy5zZXJ2ZXIgPSB0aGlzLmRodC5jcmVhdGVTZXJ2ZXIoCiAgICAgIHsKICAgICAgICBmaXJld2FsbDogdGhpcy5faGFuZGxlRmlyZXdhbGwuYmluZCh0aGlzKSwKICAgICAgICByZWxheVRocm91Z2g6IHRoaXMuX21heWJlUmVsYXlDb25uZWN0aW9uLmJpbmQodGhpcyksCiAgICAgICAgaGFuZHNoYWtlQ2xlYXJXYWl0OiBvcHRzLmhhbmRzaGFrZUNsZWFyV2FpdAogICAgICB9LAogICAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uLmJpbmQodGhpcykKICAgICkKCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlCiAgICB0aGlzLm1heFBlZXJzID0gbWF4UGVlcnMKICAgIHRoaXMubWF4Q2xpZW50Q29ubmVjdGlvbnMgPSBtYXhDbGllbnRDb25uZWN0aW9ucwogICAgdGhpcy5tYXhTZXJ2ZXJDb25uZWN0aW9ucyA9IG1heFNlcnZlckNvbm5lY3Rpb25zCiAgICB0aGlzLm1heFBhcmFsbGVsID0gbWF4UGFyYWxsZWwKICAgIHRoaXMucmVsYXlUaHJvdWdoID0gcmVsYXlUaHJvdWdoID8gdG9SZWxheUZ1bmN0aW9uKHJlbGF5VGhyb3VnaCkgOiBudWxsCgogICAgdGhpcy5jb25uZWN0aW5nID0gMAogICAgdGhpcy5jb25uZWN0aW9ucyA9IG5ldyBTZXQoKQogICAgdGhpcy5wZWVycyA9IG5ldyBNYXAoKQogICAgdGhpcy5leHBsaWNpdFBlZXJzID0gbmV3IFNldCgpCiAgICB0aGlzLmxpc3RlbmluZyA9IG51bGwKICAgIHRoaXMuc3RhdHMgPSB7CiAgICAgIHVwZGF0ZXM6IDAsCiAgICAgIGNvbm5lY3RzOiB7CiAgICAgICAgY2xpZW50OiB7CiAgICAgICAgICBvcGVuZWQ6IDAsCiAgICAgICAgICBjbG9zZWQ6IDAsCiAgICAgICAgICBhdHRlbXB0ZWQ6IDAKICAgICAgICB9LAogICAgICAgIHNlcnZlcjogewogICAgICAgICAgLy8gTm90ZTogdGhlcmUgaXMgbm8gbm90aW9uIG9mICdhdHRlbXB0cycgZm9yIHNlcnZlciBjb25uZWN0aW9ucwogICAgICAgICAgb3BlbmVkOiAwLAogICAgICAgICAgY2xvc2VkOiAwCiAgICAgICAgfQogICAgICB9LAogICAgICBiYW5uZWRQZWVyczogMAogICAgfQoKICAgIHRoaXMuX2Rpc2NvdmVyeSA9IG5ldyBNYXAoKQogICAgdGhpcy5fdGltZXIgPSBuZXcgUmV0cnlUaW1lcih0aGlzLl9yZXF1ZXVlLmJpbmQodGhpcyksIHsKICAgICAgYmFja29mZnM6IG9wdHMuYmFja29mZnMsCiAgICAgIGppdHRlcjogb3B0cy5qaXR0ZXIKICAgIH0pCiAgICB0aGlzLl9xdWV1ZSA9IHNwcSgpCgogICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMgPSBuZXcgQ29ubmVjdGlvblNldCgpCiAgICB0aGlzLl9wZW5kaW5nRmx1c2hlcyA9IFtdCiAgICB0aGlzLl9mbHVzaFRpY2sgPSAwCgogICAgdGhpcy5fZHJhaW5pbmdRdWV1ZSA9IGZhbHNlCiAgICB0aGlzLl9jbGllbnRDb25uZWN0aW9ucyA9IDAKICAgIHRoaXMuX3NlcnZlckNvbm5lY3Rpb25zID0gMAogICAgdGhpcy5fZmlyZXdhbGwgPSBmaXJld2FsbAoKICAgIHRoaXMuZGh0Lm9uKCduZXR3b3JrLWNoYW5nZScsIHRoaXMuX2hhbmRsZU5ldHdvcmtDaGFuZ2UuYmluZCh0aGlzKSkKICAgIHRoaXMuZGh0Lm9uKCduZXR3b3JrLXVwZGF0ZScsIHRoaXMuX2hhbmRsZU5ldHdvcmtVcGRhdGUuYmluZCh0aGlzKSkKICAgIHRoaXMub24oJ3VwZGF0ZScsIHRoaXMuX2hhbmRsZVVwZGF0ZSkKICB9CgogIF9tYXliZVJlbGF5Q29ubmVjdGlvbihmb3JjZSkgewogICAgaWYgKCF0aGlzLnJlbGF5VGhyb3VnaCkgcmV0dXJuIG51bGwKICAgIHJldHVybiB0aGlzLnJlbGF5VGhyb3VnaChmb3JjZSwgdGhpcykKICB9CgogIF9lbnF1ZXVlKHBlZXJJbmZvKSB7CiAgICBpZiAocGVlckluZm8ucXVldWVkKSByZXR1cm4KICAgIHBlZXJJbmZvLnF1ZXVlZCA9IHRydWUKICAgIHBlZXJJbmZvLl9mbHVzaFRpY2sgPSB0aGlzLl9mbHVzaFRpY2sKICAgIHRoaXMuX3F1ZXVlLmFkZChwZWVySW5mbykKCiAgICB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQogIH0KCiAgX3JlcXVldWUoYmF0Y2gpIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICBmb3IgKGNvbnN0IHBlZXJJbmZvIG9mIGJhdGNoKSB7CiAgICAgIHBlZXJJbmZvLndhaXRpbmcgPSBmYWxzZQoKICAgICAgaWYgKAogICAgICAgIHBlZXJJbmZvLl91cGRhdGVQcmlvcml0eSgpID09PSBmYWxzZSB8fAogICAgICAgIHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwZWVySW5mby5wdWJsaWNLZXkpIHx8CiAgICAgICAgcGVlckluZm8ucXVldWVkCiAgICAgICkKICAgICAgICBjb250aW51ZQogICAgICBwZWVySW5mby5xdWV1ZWQgPSB0cnVlCiAgICAgIHBlZXJJbmZvLl9mbHVzaFRpY2sgPSB0aGlzLl9mbHVzaFRpY2sKICAgICAgdGhpcy5fcXVldWUuYWRkKHBlZXJJbmZvKQogICAgfQoKICAgIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCiAgfQoKICBfZmx1c2hNYXliZShwZWVySW5mbykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9wZW5kaW5nRmx1c2hlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBmbHVzaCA9IHRoaXMuX3BlbmRpbmdGbHVzaGVzW2ldCiAgICAgIGlmIChwZWVySW5mby5fZmx1c2hUaWNrID4gZmx1c2gudGljaykgY29udGludWUKICAgICAgaWYgKC0tZmx1c2gubWlzc2luZyA+IDApIGNvbnRpbnVlCiAgICAgIGZsdXNoLm9uZmx1c2godHJ1ZSkKICAgICAgdGhpcy5fcGVuZGluZ0ZsdXNoZXMuc3BsaWNlKGktLSwgMSkKICAgIH0KICB9CgogIF9mbHVzaEFsbE1heWJlKCkgewogICAgaWYgKAogICAgICB0aGlzLmNvbm5lY3RpbmcgPiAwIHx8CiAgICAgICh0aGlzLl9hbGxDb25uZWN0aW9ucy5zaXplIDwgdGhpcy5tYXhQZWVycyAmJgogICAgICAgIHRoaXMuX2NsaWVudENvbm5lY3Rpb25zIDwgdGhpcy5tYXhDbGllbnRDb25uZWN0aW9ucykKICAgICkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICB3aGlsZSAodGhpcy5fcGVuZGluZ0ZsdXNoZXMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGZsdXNoID0gdGhpcy5fcGVuZGluZ0ZsdXNoZXMucG9wKCkKICAgICAgZmx1c2gub25mbHVzaCh0cnVlKQogICAgfQoKICAgIHJldHVybiB0cnVlCiAgfQoKICBfc2hvdWxkQ29ubmVjdEV4cGxpY2l0KCkgewogICAgcmV0dXJuICF0aGlzLmRlc3Ryb3llZCAmJiAhdGhpcy5zdXNwZW5kZWQgJiYgdGhpcy5jb25uZWN0aW5nIDwgdGhpcy5tYXhQYXJhbGxlbAogIH0KCiAgX3Nob3VsZENvbm5lY3QoKSB7CiAgICByZXR1cm4gKAogICAgICAhdGhpcy5kZXN0cm95ZWQgJiYKICAgICAgIXRoaXMuc3VzcGVuZGVkICYmCiAgICAgIHRoaXMuY29ubmVjdGluZyA8IHRoaXMubWF4UGFyYWxsZWwgJiYKICAgICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuc2l6ZSA8IHRoaXMubWF4UGVlcnMgJiYKICAgICAgdGhpcy5fY2xpZW50Q29ubmVjdGlvbnMgPCB0aGlzLm1heENsaWVudENvbm5lY3Rpb25zCiAgICApCiAgfQoKICBfc2hvdWxkUmVxdWV1ZShwZWVySW5mbykgewogICAgaWYgKHRoaXMuc3VzcGVuZGVkKSByZXR1cm4gZmFsc2UKICAgIGlmIChwZWVySW5mby5leHBsaWNpdCkgcmV0dXJuIHRydWUKICAgIGZvciAoY29uc3QgdG9waWMgb2YgcGVlckluZm8udG9waWNzKSB7CiAgICAgIGlmICh0aGlzLl9kaXNjb3ZlcnkuaGFzKGI0YS50b1N0cmluZyh0b3BpYywgJ2hleCcpKSAmJiAhdGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIF9jb25uZWN0KHBlZXJJbmZvLCBxdWV1ZWQpIHsKICAgIGlmIChwZWVySW5mby5iYW5uZWQgfHwgdGhpcy5fYWxsQ29ubmVjdGlvbnMuaGFzKHBlZXJJbmZvLnB1YmxpY0tleSkpIHsKICAgICAgaWYgKHF1ZXVlZCkgdGhpcy5fZmx1c2hNYXliZShwZWVySW5mbykKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gVE9ETzogU3VwcG9ydCBhc3luYyBmaXJld2FsbGluZyBhdCBzb21lIHBvaW50LgogICAgaWYgKHRoaXMuX2hhbmRsZUZpcmV3YWxsKHBlZXJJbmZvLnB1YmxpY0tleSwgbnVsbCkpIHsKICAgICAgaWYgKHF1ZXVlZCkgdGhpcy5fZmx1c2hNYXliZShwZWVySW5mbykKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgcmVsYXlUaHJvdWdoID0gdGhpcy5fbWF5YmVSZWxheUNvbm5lY3Rpb24ocGVlckluZm8uZm9yY2VSZWxheWluZykKICAgIGNvbnN0IGNvbm4gPSB0aGlzLmRodC5jb25uZWN0KHBlZXJJbmZvLnB1YmxpY0tleSwgewogICAgICByZWxheUFkZHJlc3NlczogcGVlckluZm8ucmVsYXlBZGRyZXNzZXMsCiAgICAgIGtleVBhaXI6IHRoaXMua2V5UGFpciwKICAgICAgcmVsYXlUaHJvdWdoCiAgICB9KQogICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuYWRkKGNvbm4pCgogICAgdGhpcy5zdGF0cy5jb25uZWN0cy5jbGllbnQuYXR0ZW1wdGVkKysKCiAgICB0aGlzLmNvbm5lY3RpbmcrKwogICAgdGhpcy5fY2xpZW50Q29ubmVjdGlvbnMrKwogICAgbGV0IG9wZW5lZCA9IGZhbHNlCgogICAgY29uc3Qgb25lcnJvciA9IChlcnIpID0+IHsKICAgICAgaWYgKHRoaXMucmVsYXlUaHJvdWdoICYmIHNob3VsZEZvcmNlUmVsYXlpbmcoZXJyLmNvZGUpKSB7CiAgICAgICAgcGVlckluZm8uZm9yY2VSZWxheWluZyA9IHRydWUKICAgICAgICAvLyBSZXNldCB0aGUgYXR0ZW1wdHMgaW4gb3JkZXIgdG8gZmFzdCBjb25uZWN0IHRvIHJlbGF5CiAgICAgICAgcGVlckluZm8uYXR0ZW1wdHMgPSAwCiAgICAgIH0KICAgIH0KCiAgICAvLyBSZW1vdmVkIG9uY2UgYSBjb25uZWN0aW9uIGlzIG9wZW5lZAogICAgY29ubi5vbignZXJyb3InLCBvbmVycm9yKQoKICAgIGNvbm4ub24oJ29wZW4nLCAoKSA9PiB7CiAgICAgIG9wZW5lZCA9IHRydWUKICAgICAgdGhpcy5zdGF0cy5jb25uZWN0cy5jbGllbnQub3BlbmVkKysKCiAgICAgIHRoaXMuX2Nvbm5lY3REb25lKCkKICAgICAgdGhpcy5jb25uZWN0aW9ucy5hZGQoY29ubikKICAgICAgY29ubi5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKQogICAgICBwZWVySW5mby5fY29ubmVjdGVkKCkKICAgICAgcGVlckluZm8uY2xpZW50ID0gdHJ1ZQogICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3Rpb24nLCBjb25uLCBwZWVySW5mbykKICAgICAgaWYgKHF1ZXVlZCkgdGhpcy5fZmx1c2hNYXliZShwZWVySW5mbykKCiAgICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgIH0pCiAgICBjb25uLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgaWYgKCFvcGVuZWQpIHRoaXMuX2Nvbm5lY3REb25lKCkKICAgICAgdGhpcy5zdGF0cy5jb25uZWN0cy5jbGllbnQuY2xvc2VkKysKCiAgICAgIGNvbnN0IGVyciA9IGdldFN0cmVhbUVycm9yKGNvbm4pCiAgICAgIGlmIChzaG91bGRCYW4oZXJyKSkgewogICAgICAgIHRoaXMuX2JhblBlZXIocGVlckluZm8sIHRydWUsIGVycikKICAgICAgfQoKICAgICAgdGhpcy5jb25uZWN0aW9ucy5kZWxldGUoY29ubikKICAgICAgdGhpcy5fYWxsQ29ubmVjdGlvbnMuZGVsZXRlKGNvbm4pCiAgICAgIHRoaXMuX2NsaWVudENvbm5lY3Rpb25zLS0KICAgICAgcGVlckluZm8uX2Rpc2Nvbm5lY3RlZCgpCgogICAgICBwZWVySW5mby53YWl0aW5nID0gdGhpcy5fc2hvdWxkUmVxdWV1ZShwZWVySW5mbykgJiYgdGhpcy5fdGltZXIuYWRkKHBlZXJJbmZvKQogICAgICB0aGlzLl9tYXliZURlbGV0ZVBlZXIocGVlckluZm8pCgogICAgICBpZiAoIW9wZW5lZCAmJiBxdWV1ZWQpIHRoaXMuX2ZsdXNoTWF5YmUocGVlckluZm8pCgogICAgICB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQoKICAgICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogICAgfSkKCiAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpCiAgfQoKICBfY29ubmVjdERvbmUoKSB7CiAgICB0aGlzLmNvbm5lY3RpbmctLQoKICAgIGlmICh0aGlzLmNvbm5lY3RpbmcgPCB0aGlzLm1heFBhcmFsbGVsKSB0aGlzLl9hdHRlbXB0Q2xpZW50Q29ubmVjdGlvbnMoKQogICAgaWYgKHRoaXMuY29ubmVjdGluZyA9PT0gMCkgdGhpcy5fZmx1c2hBbGxNYXliZSgpCiAgfQoKICAvLyBDYWxsZWQgd2hlbiB0aGUgUGVlclF1ZXVlIGluZGljYXRlcyBhIGNvbm5lY3Rpb24gc2hvdWxkIGJlIGF0dGVtcHRlZC4KICBfYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkgewogICAgLy8gR3VhcmQgYWdhaW5zdCByZS1lbnRyaWVzIC0gdW5zdXJlIGlmIGl0IHN0aWxsIG5lZWRlZCBidXQgZG9lc24ndCBodXJ0CiAgICBpZiAodGhpcy5fZHJhaW5pbmdRdWV1ZSB8fCB0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCiAgICB0aGlzLl9kcmFpbmluZ1F1ZXVlID0gdHJ1ZQoKICAgIGZvciAoY29uc3QgcGVlckluZm8gb2YgdGhpcy5leHBsaWNpdFBlZXJzKSB7CiAgICAgIGlmICghdGhpcy5fc2hvdWxkQ29ubmVjdEV4cGxpY2l0KCkpIGJyZWFrCiAgICAgIGlmICgKICAgICAgICBwZWVySW5mby5hdHRlbXB0cyA+PSA1IHx8CiAgICAgICAgRGF0ZS5ub3coKSAtIHBlZXJJbmZvLmRpc2Nvbm5lY3RlZFRpbWUgPCBwZWVySW5mby5hdHRlbXB0cyAqIDEwMDAKICAgICAgKQogICAgICAgIGNvbnRpbnVlCiAgICAgIHRoaXMuX2Nvbm5lY3QocGVlckluZm8sIGZhbHNlKQogICAgfQoKICAgIHdoaWxlICh0aGlzLl9xdWV1ZS5sZW5ndGggJiYgdGhpcy5fc2hvdWxkQ29ubmVjdCgpKSB7CiAgICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5fcXVldWUuc2hpZnQoKQogICAgICBwZWVySW5mby5xdWV1ZWQgPSBmYWxzZQogICAgICB0aGlzLl9jb25uZWN0KHBlZXJJbmZvLCB0cnVlKQogICAgfQogICAgdGhpcy5fZHJhaW5pbmdRdWV1ZSA9IGZhbHNlCiAgICBpZiAodGhpcy5jb25uZWN0aW5nID09PSAwKSB0aGlzLl9mbHVzaEFsbE1heWJlKCkKICB9CgogIF9oYW5kbGVGaXJld2FsbChyZW1vdGVQdWJsaWNLZXksIHBheWxvYWQpIHsKICAgIGlmIChiNGEuZXF1YWxzKHJlbW90ZVB1YmxpY0tleSwgdGhpcy5rZXlQYWlyLnB1YmxpY0tleSkpIHJldHVybiB0cnVlCgogICAgbGV0IHBlZXJJbmZvID0gdGhpcy5wZWVycy5nZXQoYjRhLnRvU3RyaW5nKHJlbW90ZVB1YmxpY0tleSwgJ2hleCcpKQogICAgaWYgKHBlZXJJbmZvICYmIHBlZXJJbmZvLmJhbm5lZCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBmaXJld2FsbGVkID0gdGhpcy5fZmlyZXdhbGwocmVtb3RlUHVibGljS2V5LCBwYXlsb2FkKQogICAgaWYgKGZpcmV3YWxsZWQpIHsKICAgICAgaWYgKCFwZWVySW5mbykgcGVlckluZm8gPSB0aGlzLl91cHNlcnRQZWVyKHJlbW90ZVB1YmxpY0tleSkKICAgICAgdGhpcy5fYmFuUGVlcihwZWVySW5mbywgdHJ1ZSwgbmV3IEVycm9yKEVSUl9GSVJFV0FMTCkpCiAgICB9CgogICAgcmV0dXJuIGZpcmV3YWxsZWQKICB9CgogIF9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uU3dhcChleGlzdGluZywgY29ubikgewogICAgbGV0IGNsb3NlZCA9IGZhbHNlCgogICAgZXhpc3Rpbmcub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICBpZiAoY2xvc2VkKSByZXR1cm4KCiAgICAgIGNvbm4ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgbm9vcCkKICAgICAgY29ubi5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKQoKICAgICAgdGhpcy5faGFuZGxlU2VydmVyQ29ubmVjdGlvbihjb25uKQogICAgfSkKCiAgICBjb25uLm9uKCdlcnJvcicsIG5vb3ApCiAgICBjb25uLm9uKCdjbG9zZScsIG9uY2xvc2UpCgogICAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgICAgY2xvc2VkID0gdHJ1ZQogICAgfQogIH0KCiAgLy8gQ2FsbGVkIHdoZW4gdGhlIERIVCByZWNlaXZlcyBhIG5ldyBzZXJ2ZXIgY29ubmVjdGlvbi4KICBfaGFuZGxlU2VydmVyQ29ubmVjdGlvbihjb25uKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQgfHwgdGhpcy5zdXNwZW5kZWQpIHsKICAgICAgLy8gVE9ETzogSW52ZXN0aWdhdGUgd2h5IGEgZmluYWwgc2VydmVyIGNvbm5lY3Rpb24gY2FuIGJlIHJlY2VpdmVkIGFmdGVyIGNsb3NlCiAgICAgIGNvbm4ub24oJ2Vycm9yJywgbm9vcCkKICAgICAgcmV0dXJuIGNvbm4uZGVzdHJveShFUlJfREVTVFJPWUVEKQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fYWxsQ29ubmVjdGlvbnMuZ2V0KGNvbm4ucmVtb3RlUHVibGljS2V5KQoKICAgIGlmIChleGlzdGluZykgewogICAgICAvLyBJZiBib3RoIGNvbm5lY3Rpb25zIGFyZSBmcm9tIHRoZSBzYW1lIHBlZXIsCiAgICAgIC8vIC0gcGljayB0aGUgbmV3IG9uZSBpZiB0aGUgZXhpc3Rpbmcgc3RyZWFtIGlzIGFscmVhZHkgZXN0YWJsaXNoZWQgKGhhcyBzZW50IGFuZCByZWNlaXZlZCBieXRlcyksCiAgICAgIC8vICAgYmVjYXVzZSB0aGUgb3RoZXIgY2xpZW50IG11c3QgaGF2ZSBsb3N0IHRoYXQgY29ubmVjdGlvbiBhbmQgYmUgcmVjb25uZWN0aW5nCiAgICAgIC8vIC0gb3RoZXJ3aXNlLCBwaWNrIHRoZSBvbmUgdGhhdHMgZXhwZWN0ZWQgdG8gaW5pdGlhdGUgaW4gYSB0aWUgYnJlYWsKICAgICAgY29uc3QgZXhpc3RpbmdJc091dGRhdGVkID0gZXhpc3RpbmcucmF3Qnl0ZXNSZWFkID4gMCAmJiBleGlzdGluZy5yYXdCeXRlc1dyaXR0ZW4gPiAwCiAgICAgIGNvbnN0IGV4cGVjdGVkSW5pdGlhdG9yID0gYjRhLmNvbXBhcmUoY29ubi5wdWJsaWNLZXksIGNvbm4ucmVtb3RlUHVibGljS2V5KSA+IDAKICAgICAgY29uc3Qga2VlcE5ldyA9IGV4aXN0aW5nSXNPdXRkYXRlZCB8fCBleHBlY3RlZEluaXRpYXRvciA9PT0gY29ubi5pc0luaXRpYXRvcgoKICAgICAgaWYgKGtlZXBOZXcgPT09IGZhbHNlKSB7CiAgICAgICAgZXhpc3Rpbmcuc2VuZEtlZXBBbGl2ZSgpCiAgICAgICAgY29ubi5vbignZXJyb3InLCBub29wKQogICAgICAgIGNvbm4uZGVzdHJveShuZXcgRXJyb3IoRVJSX0RVUExJQ0FURSkpCiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIGV4aXN0aW5nLm9uKCdlcnJvcicsIG5vb3ApCiAgICAgIGV4aXN0aW5nLmRlc3Ryb3kobmV3IEVycm9yKEVSUl9EVVBMSUNBVEUpKQogICAgICB0aGlzLl9oYW5kbGVTZXJ2ZXJDb25uZWN0aW9uU3dhcChleGlzdGluZywgY29ubikKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gV2hlbiByZWFjaGluZyBoZXJlLCB0aGUgY29ubmVjdGlvbiB3aWxsIGFsd2F5cyBiZSAnb3BlbmVkJyBuZXh0IHRpY2sKICAgIHRoaXMuc3RhdHMuY29ubmVjdHMuc2VydmVyLm9wZW5lZCsrCgogICAgY29uc3QgcGVlckluZm8gPSB0aGlzLl91cHNlcnRQZWVyKGNvbm4ucmVtb3RlUHVibGljS2V5LCBudWxsKQoKICAgIHRoaXMuY29ubmVjdGlvbnMuYWRkKGNvbm4pCiAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5hZGQoY29ubikKICAgIHRoaXMuX3NlcnZlckNvbm5lY3Rpb25zKysKCiAgICBjb25uLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgY29uc3QgZXJyID0gZ2V0U3RyZWFtRXJyb3IoY29ubikKICAgICAgaWYgKHNob3VsZEJhbihlcnIpKSB7CiAgICAgICAgdGhpcy5fYmFuUGVlcihwZWVySW5mbywgdHJ1ZSwgZXJyKQogICAgICB9CgogICAgICB0aGlzLmNvbm5lY3Rpb25zLmRlbGV0ZShjb25uKQogICAgICB0aGlzLl9hbGxDb25uZWN0aW9ucy5kZWxldGUoY29ubikKICAgICAgdGhpcy5fc2VydmVyQ29ubmVjdGlvbnMtLQogICAgICB0aGlzLnN0YXRzLmNvbm5lY3RzLnNlcnZlci5jbG9zZWQrKwoKICAgICAgdGhpcy5fbWF5YmVEZWxldGVQZWVyKHBlZXJJbmZvKQoKICAgICAgdGhpcy5fYXR0ZW1wdENsaWVudENvbm5lY3Rpb25zKCkKCiAgICAgIHRoaXMuZW1pdCgndXBkYXRlJykKICAgIH0pCiAgICBwZWVySW5mby5jbGllbnQgPSBmYWxzZQogICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgY29ubiwgcGVlckluZm8pCgogICAgdGhpcy5lbWl0KCd1cGRhdGUnKQogIH0KCiAgX3Vwc2VydFBlZXIocHVibGljS2V5LCByZWxheUFkZHJlc3NlcykgewogICAgaWYgKGI0YS5lcXVhbHMocHVibGljS2V5LCB0aGlzLmtleVBhaXIucHVibGljS2V5KSkgcmV0dXJuIG51bGwKICAgIGNvbnN0IGtleVN0cmluZyA9IGI0YS50b1N0cmluZyhwdWJsaWNLZXksICdoZXgnKQogICAgbGV0IHBlZXJJbmZvID0gdGhpcy5wZWVycy5nZXQoa2V5U3RyaW5nKQoKICAgIGlmIChwZWVySW5mbykgewogICAgICBwZWVySW5mby5yZWxheUFkZHJlc3NlcyA9IHJlbGF5QWRkcmVzc2VzIC8vIG5ldyBpcyBhbHdheXMgYmV0dGVyCiAgICAgIHJldHVybiBwZWVySW5mbwogICAgfQoKICAgIHBlZXJJbmZvID0gbmV3IFBlZXJJbmZvKHsKICAgICAgcHVibGljS2V5LAogICAgICByZWxheUFkZHJlc3NlcwogICAgfSkKCiAgICB0aGlzLnBlZXJzLnNldChrZXlTdHJpbmcsIHBlZXJJbmZvKQogICAgcmV0dXJuIHBlZXJJbmZvCiAgfQoKICBfaGFuZGxlVXBkYXRlKCkgewogICAgdGhpcy5zdGF0cy51cGRhdGVzKysKICB9CgogIF9tYXliZURlbGV0ZVBlZXIocGVlckluZm8pIHsKICAgIGlmICghcGVlckluZm8uc2hvdWxkR0MoKSkgcmV0dXJuCgogICAgY29uc3QgaGFzQWN0aXZlQ29ubiA9IHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwZWVySW5mby5wdWJsaWNLZXkpCiAgICBpZiAoaGFzQWN0aXZlQ29ubikgcmV0dXJuCgogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHBlZXJJbmZvLnB1YmxpY0tleSwgJ2hleCcpCiAgICB0aGlzLnBlZXJzLmRlbGV0ZShrZXlTdHJpbmcpCiAgfQoKICAvKgogICAqIENhbGxlZCB3aGVuIGEgcGVlciBpcyBhY3RpdmVseSBkaXNjb3ZlcmVkIGR1cmluZyBhIGxvb2t1cC4KICAgKgogICAqIFRocmVlIGNvbmRpdGlvbnM6CiAgICogIDEuIE5vdCBhIGtub3duIHBlZXIgLS0gaW5zZXJ0IGludG8gcXVldWUKICAgKiAgMi4gQSBrbm93biBwZWVyIHdpdGggbm9ybWFsIHByaW9yaXR5IC0tIGRvIG5vdGhpbmcKICAgKiAgMy4gQSBrbm93biBwZWVyIHdpdGggbG93IHByaW9yaXR5IC0tIGJ1bXAgcHJpb3JpdHksIGJlY2F1c2UgaXQncyBiZWVuIHJlZGlzY292ZXJlZAogICAqLwogIF9oYW5kbGVQZWVyKHBlZXIsIHRvcGljKSB7CiAgICBjb25zdCBwZWVySW5mbyA9IHRoaXMuX3Vwc2VydFBlZXIocGVlci5wdWJsaWNLZXksIHBlZXIucmVsYXlBZGRyZXNzZXMpCiAgICBpZiAocGVlckluZm8pIHBlZXJJbmZvLl90b3BpYyh0b3BpYykKICAgIGlmICghcGVlckluZm8gfHwgdGhpcy5fYWxsQ29ubmVjdGlvbnMuaGFzKHBlZXIucHVibGljS2V5KSkgcmV0dXJuCiAgICBpZiAoIXBlZXJJbmZvLnByaW9yaXRpemVkIHx8IHBlZXJJbmZvLnNlcnZlcikgcGVlckluZm8uX3Jlc2V0KCkKICAgIGlmIChwZWVySW5mby5fdXBkYXRlUHJpb3JpdHkoKSkgewogICAgICB0aGlzLl9lbnF1ZXVlKHBlZXJJbmZvKQogICAgfQogIH0KCiAgYXN5bmMgX2hhbmRsZU5ldHdvcmtVcGRhdGUoKSB7CiAgICBpZiAoIXRoaXMub25saW5lKSByZXR1cm4KICAgIHRoaXMuX2hhbmRsZU5ldHdvcmtDaGFuZ2UoKQogIH0KCiAgYXN5bmMgX2hhbmRsZU5ldHdvcmtDaGFuZ2UoKSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIC8vIHByaW9yaXRpemUgZmlndXJpbmcgb3V0IGlmIGV4aXN0aW5nIGNvbm5lY3Rpb25zIGFyZSBkZWFkCiAgICBmb3IgKGNvbnN0IGNvbm4gb2YgdGhpcy5fYWxsQ29ubmVjdGlvbnMpIHsKICAgICAgY29ubi5zZW5kS2VlcEFsaXZlKCkKICAgIH0KCiAgICBjb25zdCByZWZyZXNoZXMgPSBbXQoKICAgIGZvciAoY29uc3QgZGlzY292ZXJ5IG9mIHRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKSkgewogICAgICByZWZyZXNoZXMucHVzaChkaXNjb3ZlcnkucmVmcmVzaCgpKQogICAgfQoKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChyZWZyZXNoZXMpCiAgfQoKICBfYmFuUGVlcihwZWVySW5mbywgYmFubmVkLCBlcnIpIHsKICAgIHBlZXJJbmZvLmJhbihiYW5uZWQpCiAgICB0aGlzLnN0YXRzLmJhbm5lZFBlZXJzKysKICAgIHRoaXMuZW1pdCgnYmFuJywgcGVlckluZm8sIGVycikKICB9CgogIHN0YXR1cyhrZXkpIHsKICAgIHJldHVybiB0aGlzLl9kaXNjb3ZlcnkuZ2V0KGI0YS50b1N0cmluZyhrZXksICdoZXgnKSkgfHwgbnVsbAogIH0KCiAgbGlzdGVuKCkgewogICAgaWYgKCF0aGlzLmxpc3RlbmluZykgewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignU3dhcm0gZGVzdHJveWVkJykKICAgICAgdGhpcy5saXN0ZW5pbmcgPSB0aGlzLnNlcnZlci5saXN0ZW4odGhpcy5rZXlQYWlyKQogICAgfQogICAgcmV0dXJuIHRoaXMubGlzdGVuaW5nCiAgfQoKICAvLyBPYmplY3QgdGhhdCBleHBvc2VzIGEgY2FuY2VsbGF0aW9uIG1ldGhvZCAoZGVzdHJveSkKICAvLyBUT0RPOiBXaGVuIHlvdSByZWpvaW4sIGl0IHNob3VsZCByZWFubm91bmNlICsgYnVtcCBsb29rdXAgcHJpb3JpdHkKICBqb2luKHRvcGljLCBvcHRzID0ge30pIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdTd2FybSBkZXN0cm95ZWQnKQogICAgaWYgKCF0b3BpYykgdGhyb3cgbmV3IEVycm9yKEVSUl9NSVNTSU5HX1RPUElDKQogICAgdG9waWMgPSB1bnNsYWIodG9waWMpCgogICAgY29uc3QgdG9waWNTdHJpbmcgPSBiNGEudG9TdHJpbmcodG9waWMsICdoZXgnKQoKICAgIGxldCBkaXNjb3ZlcnkgPSB0aGlzLl9kaXNjb3ZlcnkuZ2V0KHRvcGljU3RyaW5nKQoKICAgIGlmIChkaXNjb3ZlcnkgJiYgIWRpc2NvdmVyeS5kZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuIGRpc2NvdmVyeS5zZXNzaW9uKG9wdHMpCiAgICB9CgogICAgZGlzY292ZXJ5ID0gbmV3IFBlZXJEaXNjb3ZlcnkodGhpcywgdG9waWMsIHsKICAgICAgbGltaXQ6IG9wdHMubGltaXQsCiAgICAgIHdhaXQ6IGRpc2NvdmVyeSA/IGRpc2NvdmVyeS5kZXN0cm95KCkgOiBudWxsLAogICAgICBzdXNwZW5kZWQ6IHRoaXMuc3VzcGVuZGVkLAogICAgICBvbnBlZXI6IChwZWVyKSA9PiB0aGlzLl9oYW5kbGVQZWVyKHBlZXIsIHRvcGljKQogICAgfSkKICAgIHRoaXMuX2Rpc2NvdmVyeS5zZXQodG9waWNTdHJpbmcsIGRpc2NvdmVyeSkKICAgIHJldHVybiBkaXNjb3Zlcnkuc2Vzc2lvbihvcHRzKQogIH0KCiAgLy8gUmV0dXJucyBhIHByb21pc2UKICBhc3luYyBsZWF2ZSh0b3BpYykgewogICAgaWYgKCF0b3BpYykgdGhyb3cgbmV3IEVycm9yKEVSUl9NSVNTSU5HX1RPUElDKQogICAgY29uc3QgdG9waWNTdHJpbmcgPSBiNGEudG9TdHJpbmcodG9waWMsICdoZXgnKQogICAgaWYgKCF0aGlzLl9kaXNjb3ZlcnkuaGFzKHRvcGljU3RyaW5nKSkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpCgogICAgY29uc3QgZGlzY292ZXJ5ID0gdGhpcy5fZGlzY292ZXJ5LmdldCh0b3BpY1N0cmluZykKCiAgICB0cnkgewogICAgICBhd2FpdCBkaXNjb3ZlcnkuZGVzdHJveSgpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlLCBwcm9wIG5ldHdvcmsKICAgIH0KCiAgICBpZiAodGhpcy5fZGlzY292ZXJ5LmdldCh0b3BpY1N0cmluZykgPT09IGRpc2NvdmVyeSkgewogICAgICB0aGlzLl9kaXNjb3ZlcnkuZGVsZXRlKHRvcGljU3RyaW5nKQogICAgfQogIH0KCiAgam9pblBlZXIocHVibGljS2V5KSB7CiAgICBjb25zdCBwZWVySW5mbyA9IHRoaXMuX3Vwc2VydFBlZXIocHVibGljS2V5LCBudWxsKQogICAgaWYgKCFwZWVySW5mbykgcmV0dXJuCiAgICBpZiAoIXRoaXMuZXhwbGljaXRQZWVycy5oYXMocGVlckluZm8pKSB7CiAgICAgIHBlZXJJbmZvLmV4cGxpY2l0ID0gdHJ1ZQogICAgICB0aGlzLmV4cGxpY2l0UGVlcnMuYWRkKHBlZXJJbmZvKQogICAgfQogICAgaWYgKHRoaXMuX2FsbENvbm5lY3Rpb25zLmhhcyhwdWJsaWNLZXkpKSByZXR1cm4KICAgIGlmIChwZWVySW5mby5fdXBkYXRlUHJpb3JpdHkoKSkgewogICAgICB0aGlzLl9lbnF1ZXVlKHBlZXJJbmZvKQogICAgfQogIH0KCiAgbGVhdmVQZWVyKHB1YmxpY0tleSkgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKHB1YmxpY0tleSwgJ2hleCcpCiAgICBpZiAoIXRoaXMucGVlcnMuaGFzKGtleVN0cmluZykpIHJldHVybgoKICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5wZWVycy5nZXQoa2V5U3RyaW5nKQogICAgcGVlckluZm8uZXhwbGljaXQgPSBmYWxzZQogICAgdGhpcy5leHBsaWNpdFBlZXJzLmRlbGV0ZShwZWVySW5mbykKICAgIHRoaXMuX21heWJlRGVsZXRlUGVlcihwZWVySW5mbykKICB9CgogIC8vIFJldHVybnMgYSBwcm9taXNlCiAgYXN5bmMgZmx1c2goKSB7CiAgICBjb25zdCBhbGxGbHVzaGVkID0gWy4uLnRoaXMuX2Rpc2NvdmVyeS52YWx1ZXMoKV0ubWFwKCh2KSA9PiB2LmZsdXNoZWQoKSkKICAgIGF3YWl0IFByb21pc2UuYWxsKGFsbEZsdXNoZWQpCiAgICBpZiAodGhpcy5fZmx1c2hBbGxNYXliZSgpKSByZXR1cm4gdHJ1ZQogICAgY29uc3QgcGVuZGluZ1NpemUgPSB0aGlzLl9hbGxDb25uZWN0aW9ucy5zaXplIC0gdGhpcy5jb25uZWN0aW9ucy5zaXplCiAgICBpZiAoIXRoaXMuX3F1ZXVlLmxlbmd0aCAmJiAhcGVuZGluZ1NpemUpIHJldHVybiB0cnVlCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgdGhpcy5fcGVuZGluZ0ZsdXNoZXMucHVzaCh7CiAgICAgICAgb25mbHVzaDogcmVzb2x2ZSwKICAgICAgICBtaXNzaW5nOiB0aGlzLl9xdWV1ZS5sZW5ndGggKyBwZW5kaW5nU2l6ZSwKICAgICAgICB0aWNrOiB0aGlzLl9mbHVzaFRpY2srKwogICAgICB9KQogICAgfSkKICB9CgogIGFzeW5jIGNsZWFyKCkgewogICAgY29uc3QgY2xlYXJlZCA9IFByb21pc2UuYWxsU2V0dGxlZChbLi4udGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpXS5tYXAoKGQpID0+IGQuZGVzdHJveSgpKSkKICAgIHRoaXMuX2Rpc2NvdmVyeS5jbGVhcigpCiAgICByZXR1cm4gY2xlYXJlZAogIH0KCiAgYXN5bmMgZGVzdHJveSh7IGZvcmNlIH0gPSB7fSkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkICYmICFmb3JjZSkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKCiAgICB0aGlzLl90aW1lci5kZXN0cm95KCkKCiAgICBpZiAoIWZvcmNlKSBhd2FpdCB0aGlzLmNsZWFyKCkKCiAgICBhd2FpdCB0aGlzLnNlcnZlci5jbG9zZSgpCgogICAgd2hpbGUgKHRoaXMuX3BlbmRpbmdGbHVzaGVzLmxlbmd0aCkgewogICAgICBjb25zdCBmbHVzaCA9IHRoaXMuX3BlbmRpbmdGbHVzaGVzLnBvcCgpCiAgICAgIGZsdXNoLm9uZmx1c2goZmFsc2UpCiAgICB9CgogICAgYXdhaXQgdGhpcy5kaHQuZGVzdHJveSh7IGZvcmNlIH0pCiAgfQoKICBhc3luYyBzdXNwZW5kKHsgbG9nID0gbm9vcCB9ID0ge30pIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgY29uc3QgcHJvbWlzZXMgPSBbXQoKICAgIHByb21pc2VzLnB1c2godGhpcy5zZXJ2ZXIuc3VzcGVuZCh7IGxvZyB9KSkKCiAgICBmb3IgKGNvbnN0IGRpc2NvdmVyeSBvZiB0aGlzLl9kaXNjb3ZlcnkudmFsdWVzKCkpIHsKICAgICAgcHJvbWlzZXMucHVzaChkaXNjb3Zlcnkuc3VzcGVuZCh7IGxvZyB9KSkKICAgIH0KCiAgICBjb25zdCBwZW5kaW5nID0gW10KICAgIGZvciAoY29uc3QgY29ubmVjdGlvbiBvZiB0aGlzLl9hbGxDb25uZWN0aW9ucykgewogICAgICBjb25uZWN0aW9uLmRlc3Ryb3koKQogICAgICBwZW5kaW5nLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUpID0+IGNvbm5lY3Rpb24ub24oJ2Nsb3NlJywgcmVzb2x2ZSkpKQogICAgfQoKICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZQoKICAgIGxvZygnU3VzcGVuZGluZyBzZXJ2ZXIgYW5kIGRpc2NvdmVyeS4uLiAoJyArIHByb21pc2VzLmxlbmd0aCArICcpJykKICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwcm9taXNlcykKICAgIGxvZygnRG9uZSwgc3VzcGVuZGluZyB0aGUgZGh0Li4uJykKICAgIGF3YWl0IHRoaXMuZGh0LnN1c3BlbmQoeyBsb2cgfSkKICAgIGxvZygnRG9uZSwgc3dhcm0gZnVsbHkgc3VzcGVuZGVkJykKCiAgICBhd2FpdCBQcm9taXNlLmFsbChwZW5kaW5nKQoKICAgIC8vIHJlc2V0IHF1ZXVlCiAgICB0aGlzLl90aW1lci5kZXN0cm95KCkKICAgIHRoaXMuX3RpbWVyID0gbmV3IFJldHJ5VGltZXIodGhpcy5fcmVxdWV1ZS5iaW5kKHRoaXMpLCB7CiAgICAgIGJhY2tvZmZzOiB0aGlzLl90aW1lci5iYWNrb2ZmcywKICAgICAgaml0dGVyOiB0aGlzLl90aW1lci5qaXR0ZXIKICAgIH0pCiAgICB0aGlzLl9xdWV1ZSA9IHNwcSgpCiAgfQoKICBhc3luYyByZXN1bWUoeyBsb2cgPSBub29wIH0gPSB7fSkgewogICAgaWYgKCF0aGlzLnN1c3BlbmRlZCkgcmV0dXJuCgogICAgbG9nKCdSZXN1bWluZyB0aGUgZGh0JykKICAgIGF3YWl0IHRoaXMuZGh0LnJlc3VtZSgpCiAgICBsb2coJ0RvbmUsIHJlc3VtaW5nIHRoZSBzZXJ2ZXInKQogICAgYXdhaXQgdGhpcy5zZXJ2ZXIucmVzdW1lKCkKICAgIGxvZygnRG9uZSwgYWxsIGRpc2NvdmVyeScpCgogICAgZm9yIChjb25zdCBkaXNjb3Zlcnkgb2YgdGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpKSB7CiAgICAgIGRpc2NvdmVyeS5yZXN1bWUoKQogICAgfQoKICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMuX2F0dGVtcHRDbGllbnRDb25uZWN0aW9ucygpCiAgfQoKICB0b3BpY3MoKSB7CiAgICByZXR1cm4gdGhpcy5fZGlzY292ZXJ5LnZhbHVlcygpCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIGFsbG93QWxsKCkgewogIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiBzaG91bGRGb3JjZVJlbGF5aW5nKGNvZGUpIHsKICByZXR1cm4gKAogICAgY29kZSA9PT0gJ0hPTEVQVU5DSF9BQk9SVEVEJyB8fAogICAgY29kZSA9PT0gJ0hPTEVQVU5DSF9ET1VCTEVfUkFORE9NSVpFRF9OQVRTJyB8fAogICAgY29kZSA9PT0gJ1JFTU9URV9OT1RfSE9MRVBVTkNIQUJMRScKICApCn0KCmZ1bmN0aW9uIHNob3VsZEJhbigpIHsKICAvLyByZXR1cm4gISFlcnIgJiYgZXJyLm5hbWUgPT09ICdIeXBlcmNvcmVFcnJvcicgJiYgZXJyLmNvZGUgPT09ICdJTlZBTElEX09QRVJBVElPTicKICByZXR1cm4gZmFsc2UKfQoKZnVuY3Rpb24gdG9SZWxheUZ1bmN0aW9uKHJlbGF5VGhyb3VnaCkgewogIHJldHVybiB0eXBlb2YgcmVsYXlUaHJvdWdoID09PSAnZnVuY3Rpb24nCiAgICA/IHJlbGF5VGhyb3VnaAogICAgOiAoZm9yY2UsIHN3YXJtKSA9PiAoZm9yY2UgfHwgc3dhcm0uZGh0LnJhbmRvbWl6ZWQgPyByZWxheVRocm91Z2ggOiBudWxsKQp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQnVsa1RpbWVyIHsKICBjb25zdHJ1Y3Rvcih0aW1lLCBmbikgewogICAgdGhpcy5fdGltZSA9IHRpbWUKICAgIHRoaXMuX2ZuID0gZm4KICAgIHRoaXMuX2ludGVydmFsID0gbnVsbAogICAgdGhpcy5fbmV4dCA9IFtdCiAgICB0aGlzLl9wZW5kaW5nID0gW10KICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCiAgICBjbGVhckludGVydmFsKHRoaXMuX2ludGVydmFsKQogICAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCiAgfQoKICBfb250aWNrKCkgewogICAgaWYgKCF0aGlzLl9uZXh0Lmxlbmd0aCAmJiAhdGhpcy5fcGVuZGluZy5sZW5ndGgpIHJldHVybgogICAgaWYgKHRoaXMuX25leHQubGVuZ3RoKSB0aGlzLl9mbih0aGlzLl9uZXh0KQogICAgdGhpcy5fbmV4dCA9IHRoaXMuX3BlbmRpbmcKICAgIHRoaXMuX3BlbmRpbmcgPSBbXQogIH0KCiAgYWRkKGluZm8pIHsKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgogICAgaWYgKCF0aGlzLl9pbnRlcnZhbCkgewogICAgICB0aGlzLl9pbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX29udGljay5iaW5kKHRoaXMpLCBNYXRoLmZsb29yKHRoaXMuX3RpbWUgKiAwLjY2KSkKICAgIH0KCiAgICB0aGlzLl9wZW5kaW5nLnB1c2goaW5mbykKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ29ubmVjdGlvblNldCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9ieVB1YmxpY0tleSA9IG5ldyBNYXAoKQogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5fYnlQdWJsaWNLZXkudmFsdWVzKCkKICB9CgogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuX2J5UHVibGljS2V5LnNpemUKICB9CgogIGhhcyhwdWJsaWNLZXkpIHsKICAgIHJldHVybiB0aGlzLl9ieVB1YmxpY0tleS5oYXModG9IZXgocHVibGljS2V5KSkKICB9CgogIGdldChwdWJsaWNLZXkpIHsKICAgIHJldHVybiB0aGlzLl9ieVB1YmxpY0tleS5nZXQodG9IZXgocHVibGljS2V5KSkKICB9CgogIGFkZChjb25uZWN0aW9uKSB7CiAgICB0aGlzLl9ieVB1YmxpY0tleS5zZXQoYjRhLnRvU3RyaW5nKGNvbm5lY3Rpb24ucmVtb3RlUHVibGljS2V5LCAnaGV4JyksIGNvbm5lY3Rpb24pCiAgfQoKICBkZWxldGUoY29ubmVjdGlvbikgewogICAgY29uc3Qga2V5U3RyaW5nID0gYjRhLnRvU3RyaW5nKGNvbm5lY3Rpb24ucmVtb3RlUHVibGljS2V5LCAnaGV4JykKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fYnlQdWJsaWNLZXkuZ2V0KGtleVN0cmluZykKICAgIGlmIChleGlzdGluZyAhPT0gY29ubmVjdGlvbikgcmV0dXJuCiAgICB0aGlzLl9ieVB1YmxpY0tleS5kZWxldGUoa2V5U3RyaW5nKQogIH0KfQoKZnVuY3Rpb24gdG9IZXgoYikgewogIHJldHVybiB0eXBlb2YgYiA9PT0gJ3N0cmluZycgPyBiIDogYjRhLnRvU3RyaW5nKGIsICdoZXgnKQp9CmNvbnN0IHNhZmV0eUNhdGNoID0gcmVxdWlyZSgnc2FmZXR5LWNhdGNoJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IFJFRlJFU0hfSU5URVJWQUwgPSAxMDAwICogNjAgKiAxMCAvLyAxMCBtaW4KY29uc3QgUkFORE9NX0pJVFRFUiA9IDEwMDAgKiA2MCAqIDIgLy8gMiBtaW4KY29uc3QgREVMQVlfR1JBQ0VfUEVSSU9EID0gMTAwMCAqIDMwIC8vIDMwcwoKY29uc3QgTUFYX0RJU0NPVkVSWV9DQUNIRSA9IDY0Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFBlZXJEaXNjb3ZlcnkgewogIGNvbnN0cnVjdG9yKAogICAgc3dhcm0sCiAgICB0b3BpYywKICAgIHsgbGltaXQgPSBJbmZpbml0eSwgd2FpdCA9IG51bGwsIHN1c3BlbmRlZCA9IGZhbHNlLCBvbnBlZXIgPSBub29wLCBvbmVycm9yID0gc2FmZXR5Q2F0Y2ggfQogICkgewogICAgdGhpcy5saW1pdCA9IGxpbWl0CiAgICB0aGlzLnN3YXJtID0gc3dhcm0KICAgIHRoaXMudG9waWMgPSB0b3BpYwogICAgdGhpcy5pc0NsaWVudCA9IGZhbHNlCiAgICB0aGlzLmlzU2VydmVyID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWluZyA9IG51bGwKICAgIHRoaXMuc3VzcGVuZGVkID0gc3VzcGVuZGVkCgogICAgdGhpcy5fc2Vzc2lvbnMgPSBbXQogICAgdGhpcy5fY2xpZW50U2Vzc2lvbnMgPSAwCiAgICB0aGlzLl9zZXJ2ZXJTZXNzaW9ucyA9IDAKCiAgICB0aGlzLl9vbnBlZXIgPSBvbnBlZXIKICAgIHRoaXMuX29uZXJyb3IgPSBvbmVycm9yCgogICAgdGhpcy5fZGlzY292ZXJlZCA9IG5ldyBTZXQoKQogICAgdGhpcy5fYWN0aXZlUXVlcnkgPSBudWxsCiAgICB0aGlzLl90aW1lciA9IG51bGwKICAgIHRoaXMuX2N1cnJlbnRSZWZyZXNoID0gbnVsbAogICAgdGhpcy5fY2xvc2VzdE5vZGVzID0gbnVsbAogICAgdGhpcy5fZmlyc3RBbm5vdW5jZSA9IHRydWUKICAgIHRoaXMuX25lZWRzVW5hbm5vdW5jZSA9IGZhbHNlCiAgICB0aGlzLl9yZWZyZXNoZXMgPSAwCiAgICB0aGlzLl93YWl0ID0gd2FpdAogIH0KCiAgc2Vzc2lvbih7IHNlcnZlciA9IHRydWUsIGNsaWVudCA9IHRydWUsIGxpbWl0ID0gSW5maW5pdHksIG9uZXJyb3IgPSBzYWZldHlDYXRjaCB9KSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignUGVlckRpc2NvdmVyeSBpcyBkZXN0cm95ZWQnKQogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBQZWVyRGlzY292ZXJ5U2Vzc2lvbih0aGlzKQogICAgc2Vzc2lvbi5yZWZyZXNoKHsgc2VydmVyLCBjbGllbnQsIGxpbWl0IH0pLmNhdGNoKG9uZXJyb3IpCiAgICB0aGlzLl9zZXNzaW9ucy5wdXNoKHNlc3Npb24pCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgX3JlZnJlc2hMYXRlcihlYWdlcikgewogICAgY29uc3Qgaml0dGVyID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogUkFORE9NX0pJVFRFUikKICAgIGNvbnN0IGRlbGF5ID0gIWVhZ2VyID8gUkVGUkVTSF9JTlRFUlZBTCArIGppdHRlciA6IGppdHRlcgoKICAgIGlmICh0aGlzLl90aW1lcikgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQoKICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCkKICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIC8vIElmIHlvdXIgbGFwdG9wIHdlbnQgdG8gc2xlZXAsIGFuZCBpcyBjb21pbmcgYmFjayBvbmxpbmUuLi4KICAgICAgY29uc3Qgb3ZlcmR1ZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWUgPiBkZWxheSArIERFTEFZX0dSQUNFX1BFUklPRAogICAgICBpZiAob3ZlcmR1ZSkgdGhpcy5fcmVmcmVzaExhdGVyKHRydWUpCiAgICAgIGVsc2UgdGhpcy5yZWZyZXNoKCkuY2F0Y2godGhpcy5fb25lcnJvcikKICAgIH0sIGRlbGF5KQogIH0KCiAgX2lzQWN0aXZlKCkgewogICAgcmV0dXJuICF0aGlzLmRlc3Ryb3llZCAmJiAhdGhpcy5zdXNwZW5kZWQKICB9CgogIC8vIFRPRE86IEFsbG93IGFubm91bmNlIHRvIGJlIGFuIGFyZ3VtZW50IHRvIHRoaXMKICAvLyBUT0RPOiBNYXliZSBhbm5vdW5jZSBzaG91bGQgYmUgYSBzZXR0ZXI/CiAgYXN5bmMgX3JlZnJlc2goKSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgY29uc3QgY2xvY2sgPSArK3RoaXMuX3JlZnJlc2hlcwoKICAgIGlmICh0aGlzLl93YWl0KSB7CiAgICAgIGF3YWl0IHRoaXMuX3dhaXQKICAgICAgdGhpcy5fd2FpdCA9IG51bGwKICAgICAgaWYgKGNsb2NrICE9PSB0aGlzLl9yZWZyZXNoZXMgfHwgIXRoaXMuX2lzQWN0aXZlKCkpIHJldHVybgogICAgfQoKICAgIGNvbnN0IGNsZWFyID0gdGhpcy5pc1NlcnZlciAmJiB0aGlzLl9maXJzdEFubm91bmNlCiAgICBpZiAoY2xlYXIpIHRoaXMuX2ZpcnN0QW5ub3VuY2UgPSBmYWxzZQoKICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgIGNsZWFyLAogICAgICBjbG9zZXN0Tm9kZXM6IHRoaXMuX2Nsb3Nlc3ROb2RlcwogICAgfQoKICAgIGlmICh0aGlzLmlzU2VydmVyKSB7CiAgICAgIGF3YWl0IHRoaXMuc3dhcm0ubGlzdGVuKCkKICAgICAgLy8gaWYgYSBwYXJhbGxlbCByZWZyZXNoIGlzIGhhcHBlbmluZywgeWllbGQgdG8gdGhlIG5ldyBvbmUKICAgICAgaWYgKGNsb2NrICE9PSB0aGlzLl9yZWZyZXNoZXMgfHwgIXRoaXMuX2lzQWN0aXZlKCkpIHJldHVybgogICAgICB0aGlzLl9uZWVkc1VuYW5ub3VuY2UgPSB0cnVlCiAgICB9CgogICAgbGV0IGxpbWl0ID0gdGhpcy5saW1pdAoKICAgIGlmIChsaW1pdCA8IEluZmluaXR5ICYmIGxpbWl0ID4gMCkgewogICAgICBmb3IgKGNvbnN0IGlkIG9mIHRoaXMuX2Rpc2NvdmVyZWQpIHsKICAgICAgICBpZiAoIXRoaXMuc3dhcm0uY29ubmVjdGlvbnMuaGFzKGlkKSkgY29udGludWUKICAgICAgICBpZiAoLS1saW1pdCA9PT0gMCkgYnJlYWsKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2Rpc2NvdmVyZWQuY2xlYXIoKQoKICAgIGNvbnN0IGFubm91bmNpbmcgPSB0aGlzLmlzU2VydmVyCiAgICBjb25zdCBxdWVyeSA9ICh0aGlzLl9hY3RpdmVRdWVyeSA9IGFubm91bmNpbmcKICAgICAgPyB0aGlzLnN3YXJtLmRodC5hbm5vdW5jZSgKICAgICAgICAgIHRoaXMudG9waWMsCiAgICAgICAgICB0aGlzLnN3YXJtLmtleVBhaXIsCiAgICAgICAgICB0aGlzLnN3YXJtLnNlcnZlci5yZWxheUFkZHJlc3NlcywKICAgICAgICAgIG9wdHMKICAgICAgICApCiAgICAgIDogdGhpcy5fbmVlZHNVbmFubm91bmNlCiAgICAgICAgPyB0aGlzLnN3YXJtLmRodC5sb29rdXBBbmRVbmFubm91bmNlKHRoaXMudG9waWMsIHRoaXMuc3dhcm0ua2V5UGFpciwgb3B0cykKICAgICAgICA6IHRoaXMuc3dhcm0uZGh0Lmxvb2t1cCh0aGlzLnRvcGljLCBvcHRzKSkKCiAgICB0cnkgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IGRhdGEgb2YgdGhpcy5fYWN0aXZlUXVlcnkpIHsKICAgICAgICBpZiAoIXRoaXMuaXNDbGllbnQgfHwgIXRoaXMuX2lzQWN0aXZlKCkpIGNvbnRpbnVlCiAgICAgICAgZm9yIChjb25zdCBwZWVyIG9mIGRhdGEucGVlcnMpIHsKICAgICAgICAgIGlmIChsaW1pdCA8IEluZmluaXR5KSB7CiAgICAgICAgICAgIGNvbnN0IGlkID0gYjRhLnRvU3RyaW5nKHBlZXIucHVibGljS2V5LCAnaGV4JykKCiAgICAgICAgICAgIGlmICh0aGlzLl9kaXNjb3ZlcmVkLnNpemUgPCBNQVhfRElTQ09WRVJZX0NBQ0hFKSB7CiAgICAgICAgICAgICAgdGhpcy5fZGlzY292ZXJlZC5hZGQoaWQpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChsaW1pdCA9PT0gMCkgY29udGludWUKCiAgICAgICAgICAgIC8vIHRoZXJlIGlzIGEgY2hhbmNlIGl0IGhhcyB1cGRhdGVkIGEgY29ubmVjdGlvbiBkdXJpbmcgZGlzY292ZXJ5IGFuZCB3ZSBnbyBvdmVyCiAgICAgICAgICAgIC8vIHRoZSBsaW1pdCAtIHRoYXRzIGFjY2VwdGFibGUgdG8gYXZvaWQgYSBjb21wbGV4aXR5IHNwaXJhbCBoZXJlLgogICAgICAgICAgICBpZiAoIXRoaXMuc3dhcm0uY29ubmVjdGlvbnMuaGFzKGlkKSkgbGltaXQtLQogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuX29ucGVlcihwZWVyLCBkYXRhKQogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICh0aGlzLl9pc0FjdGl2ZSgpKSB0aHJvdyBlcnIKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICh0aGlzLl9hY3RpdmVRdWVyeSA9PT0gcXVlcnkpIHsKICAgICAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKICAgICAgICBpZiAoIXRoaXMuZGVzdHJveWVkICYmICF0aGlzLnN1c3BlbmRlZCkgdGhpcy5fcmVmcmVzaExhdGVyKGZhbHNlKQogICAgICB9CiAgICB9CgogICAgLy8gVGhpcyBpcyBzZXQgYXQgdGhlIHZlcnkgZW5kLCB3aGVuIHRoZSBxdWVyeSBjb21wbGV0ZXMgc3VjY2Vzc2Z1bGx5LgogICAgdGhpcy5fY2xvc2VzdE5vZGVzID0gcXVlcnkuY2xvc2VzdE5vZGVzCgogICAgaWYgKGNsb2NrICE9PSB0aGlzLl9yZWZyZXNoZXMpIHJldHVybgoKICAgIC8vIEluIHRoaXMgaXMgdGhlIGxhdGVzdCBxdWVyeSwgdW5hbm5vdW5jZSBoYXMgYmVlbiBmdWxmaWxsZWQgYXMgd2VsbAogICAgaWYgKCFhbm5vdW5jaW5nKSB0aGlzLl9uZWVkc1VuYW5ub3VuY2UgPSBmYWxzZQogIH0KCiAgYXN5bmMgcmVmcmVzaCgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdQZWVyRGlzY292ZXJ5IGlzIGRlc3Ryb3llZCcpCgogICAgY29uc3Qgc2VydmVyID0gdGhpcy5fc2VydmVyU2Vzc2lvbnMgPiAwCiAgICBjb25zdCBjbGllbnQgPSB0aGlzLl9jbGllbnRTZXNzaW9ucyA+IDAKCiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgoKICAgIGlmIChzZXJ2ZXIgPT09IHRoaXMuaXNTZXJ2ZXIgJiYgY2xpZW50ID09PSB0aGlzLmlzQ2xpZW50KSB7CiAgICAgIGlmICh0aGlzLl9jdXJyZW50UmVmcmVzaCkgcmV0dXJuIHRoaXMuX2N1cnJlbnRSZWZyZXNoCiAgICAgIHRoaXMuX2N1cnJlbnRSZWZyZXNoID0gdGhpcy5fcmVmcmVzaCgpCiAgICB9IGVsc2UgewogICAgICBpZiAodGhpcy5fYWN0aXZlUXVlcnkpIHRoaXMuX2FjdGl2ZVF1ZXJ5LmRlc3Ryb3koKQogICAgICB0aGlzLmlzU2VydmVyID0gc2VydmVyCiAgICAgIHRoaXMuaXNDbGllbnQgPSBjbGllbnQKICAgICAgdGhpcy5fY3VycmVudFJlZnJlc2ggPSB0aGlzLl9yZWZyZXNoKCkKICAgIH0KCiAgICBjb25zdCByZWZyZXNoID0gdGhpcy5fY3VycmVudFJlZnJlc2gKICAgIHRyeSB7CiAgICAgIGF3YWl0IHJlZnJlc2gKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0gZmluYWxseSB7CiAgICAgIGlmIChyZWZyZXNoID09PSB0aGlzLl9jdXJyZW50UmVmcmVzaCkgewogICAgICAgIHRoaXMuX2N1cnJlbnRSZWZyZXNoID0gbnVsbAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWUKICB9CgogIGFzeW5jIGZsdXNoZWQoKSB7CiAgICBpZiAodGhpcy5zd2FybS5saXN0ZW5pbmcpIGF3YWl0IHRoaXMuc3dhcm0ubGlzdGVuaW5nCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fY3VycmVudFJlZnJlc2gKICAgICAgcmV0dXJuIHRydWUKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CgogIGFzeW5jIF9kZXN0cm95TWF5YmUoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgoKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLl9zZXNzaW9ucy5sZW5ndGggPT09IDApIGF3YWl0IHRoaXMuc3dhcm0ubGVhdmUodGhpcy50b3BpYykKICAgICAgZWxzZSBpZiAodGhpcy5fc2VydmVyU2Vzc2lvbnMgPT09IDAgJiYgdGhpcy5fbmVlZHNVbmFubm91bmNlKSBhd2FpdCB0aGlzLnJlZnJlc2goKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIC8vIGlnbm9yZSBuZXR3b3JrIGZhaWx1cmVzIGhlcmUsIGFzIHdlIGFyZSB0ZWFyaW5nIGRvd24KICAgICAgc2FmZXR5Q2F0Y2goZXJyKQogICAgfQogIH0KCiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3lpbmcpIHJldHVybiB0aGlzLmRlc3Ryb3lpbmcKICAgIHRoaXMuZGVzdHJveWluZyA9IHRoaXMuX2Rlc3Ryb3koKQogICAgcmV0dXJuIHRoaXMuZGVzdHJveWluZwogIH0KCiAgYXN5bmMgX2Fib3J0KGxvZykgewogICAgY29uc3QgaWQgPSBsb2cgPT09IG5vb3AgPyAnJyA6IGI0YS50b1N0cmluZyh0aGlzLnRvcGljLCAnaGV4JykKCiAgICBsb2coJ0Fib3J0aW5nIGRpc2NvdmVyeScsIGlkKQogICAgaWYgKHRoaXMuX3dhaXQpIGF3YWl0IHRoaXMuX3dhaXQKICAgIGxvZygnQWJvcnRpbmcgZGlzY292ZXJ5IChwb3N0IHdhaXQpJywgaWQpCgogICAgaWYgKHRoaXMuX2FjdGl2ZVF1ZXJ5KSB7CiAgICAgIHRoaXMuX2FjdGl2ZVF1ZXJ5LmRlc3Ryb3koKQogICAgICB0aGlzLl9hY3RpdmVRdWVyeSA9IG51bGwKICAgIH0KICAgIGlmICh0aGlzLl90aW1lcikgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgICAgIHRoaXMuX3RpbWVyID0gbnVsbAogICAgfQoKICAgIGxldCBub2RlcyA9IHRoaXMuX2Nsb3Nlc3ROb2RlcwoKICAgIGlmICh0aGlzLl9jdXJyZW50UmVmcmVzaCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuX2N1cnJlbnRSZWZyZXNoCiAgICAgIH0gY2F0Y2ggewogICAgICAgIC8vIElmIHRoZSBkZXN0cm95IGNhdXNlcyB0aGUgcmVmcmVzaCB0byBmYWlsLCBzdXBwcmVzcyBpdC4KICAgICAgfQogICAgfQoKICAgIGxvZygnQWJvcnRpbmcgZGlzY292ZXJ5IChwb3N0IHJlZnJlc2gpJywgaWQpCiAgICBpZiAodGhpcy5faXNBY3RpdmUoKSkgcmV0dXJuCgogICAgaWYgKCFub2Rlcykgbm9kZXMgPSB0aGlzLl9jbG9zZXN0Tm9kZXMKICAgIGVsc2UgaWYgKHRoaXMuX2Nsb3Nlc3ROb2RlcyAhPT0gbm9kZXMpIHsKICAgICAgY29uc3QgbGVuID0gbm9kZXMubGVuZ3RoCiAgICAgIGZvciAoY29uc3QgbmV3ZXIgb2YgdGhpcy5fY2xvc2VzdE5vZGVzKSB7CiAgICAgICAgaWYgKG5ld2VyLmlkICYmICFoYXNOb2RlKG5vZGVzLCBsZW4sIG5ld2VyKSkgbm9kZXMucHVzaChuZXdlcikKICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLl9uZWVkc1VuYW5ub3VuY2UpIHsKICAgICAgbG9nKCdVbmFubm91bmNpbmcgZGlzY292ZXJ5JywgaWQpCiAgICAgIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpCiAgICAgICAgYXdhaXQgdGhpcy5zd2FybS5kaHQudW5hbm5vdW5jZSh0aGlzLnRvcGljLCB0aGlzLnN3YXJtLmtleVBhaXIsIHsKICAgICAgICAgIGNsb3Nlc3ROb2Rlczogbm9kZXMsCiAgICAgICAgICBvbmx5Q2xvc2VzdE5vZGVzOiB0cnVlLAogICAgICAgICAgZm9yY2U6IHRydWUKICAgICAgICB9KQogICAgICB0aGlzLl9uZWVkc1VuYW5ub3VuY2UgPSBmYWxzZQogICAgICBsb2coJ1VuYW5ub3VuY2luZyBkaXNjb3ZlcnkgKGRvbmUpJywgaWQpCiAgICB9CiAgfQoKICBfZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHJldHVybiB0aGlzLl9hYm9ydChub29wKQogIH0KCiAgYXN5bmMgc3VzcGVuZCh7IGxvZyA9IG5vb3AgfSA9IHt9KSB7CiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHJldHVybgogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9hYm9ydChsb2cpCiAgICB9IGNhdGNoIHsKICAgICAgLy8gaWdub3JlCiAgICB9CiAgfQoKICByZXN1bWUoKSB7CiAgICBpZiAoIXRoaXMuc3VzcGVuZGVkKSByZXR1cm4KICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2UKICAgIHRoaXMucmVmcmVzaCgpLmNhdGNoKG5vb3ApCiAgfQp9CgpjbGFzcyBQZWVyRGlzY292ZXJ5U2Vzc2lvbiB7CiAgY29uc3RydWN0b3IoZGlzY292ZXJ5KSB7CiAgICB0aGlzLmRpc2NvdmVyeSA9IGRpc2NvdmVyeQogICAgdGhpcy5pc0NsaWVudCA9IGZhbHNlCiAgICB0aGlzLmlzU2VydmVyID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICB9CgogIGdldCBzd2FybSgpIHsKICAgIHJldHVybiB0aGlzLmRpc2NvdmVyeS5zd2FybQogIH0KCiAgZ2V0IHRvcGljKCkgewogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5LnRvcGljCiAgfQoKICBhc3luYyByZWZyZXNoKHsgY2xpZW50ID0gdGhpcy5pc0NsaWVudCwgc2VydmVyID0gdGhpcy5pc1NlcnZlciwgbGltaXQgPSBJbmZpbml0eSB9ID0ge30pIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgdGhyb3cgbmV3IEVycm9yKCdQZWVyRGlzY292ZXJ5IGlzIGRlc3Ryb3llZCcpCiAgICBpZiAoIWNsaWVudCAmJiAhc2VydmVyKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCByZWZyZXNoIHdpdGggbmVpdGhlciBjbGllbnQgbm9yIHNlcnZlciBvcHRpb24nKQoKICAgIGlmIChjbGllbnQgIT09IHRoaXMuaXNDbGllbnQpIHsKICAgICAgdGhpcy5pc0NsaWVudCA9IGNsaWVudAogICAgICB0aGlzLmRpc2NvdmVyeS5fY2xpZW50U2Vzc2lvbnMgKz0gY2xpZW50ID8gMSA6IC0xCiAgICB9CgogICAgaWYgKHNlcnZlciAhPT0gdGhpcy5pc1NlcnZlcikgewogICAgICB0aGlzLmlzU2VydmVyID0gc2VydmVyCiAgICAgIHRoaXMuZGlzY292ZXJ5Ll9zZXJ2ZXJTZXNzaW9ucyArPSBzZXJ2ZXIgPyAxIDogLTEKICAgIH0KCiAgICB0aGlzLmRpc2NvdmVyeS5saW1pdCA9IGxpbWl0CgogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5LnJlZnJlc2goKQogIH0KCiAgYXN5bmMgZmx1c2hlZCgpIHsKICAgIHJldHVybiB0aGlzLmRpc2NvdmVyeS5mbHVzaGVkKCkKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybgogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuaXNDbGllbnQpIHRoaXMuZGlzY292ZXJ5Ll9jbGllbnRTZXNzaW9ucy0tCiAgICBpZiAodGhpcy5pc1NlcnZlcikgdGhpcy5kaXNjb3ZlcnkuX3NlcnZlclNlc3Npb25zLS0KCiAgICBjb25zdCBpbmRleCA9IHRoaXMuZGlzY292ZXJ5Ll9zZXNzaW9ucy5pbmRleE9mKHRoaXMpCiAgICBjb25zdCBoZWFkID0gdGhpcy5kaXNjb3ZlcnkuX3Nlc3Npb25zLnBvcCgpCgogICAgaWYgKGhlYWQgIT09IHRoaXMpIHRoaXMuZGlzY292ZXJ5Ll9zZXNzaW9uc1tpbmRleF0gPSBoZWFkCgogICAgcmV0dXJuIHRoaXMuZGlzY292ZXJ5Ll9kZXN0cm95TWF5YmUoKQogIH0KfQoKZnVuY3Rpb24gaGFzTm9kZShub2RlcywgbGVuLCBub2RlKSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgY29uc3QgZXhpc3RpbmcgPSBub2Rlc1tpXQogICAgaWYgKGV4aXN0aW5nLmlkICYmIGI0YS5lcXVhbHMoZXhpc3RpbmcuaWQsIG5vZGUuaWQpKSByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgdW5zbGFiID0gcmVxdWlyZSgndW5zbGFiJykKCmNvbnN0IE1JTl9DT05ORUNUSU9OX1RJTUUgPSAxNTAwMAoKY29uc3QgVkVSWV9MT1dfUFJJT1JJVFkgPSAwCmNvbnN0IExPV19QUklPUklUWSA9IDEKY29uc3QgTk9STUFMX1BSSU9SSVRZID0gMgpjb25zdCBISUdIX1BSSU9SSVRZID0gMwpjb25zdCBWRVJZX0hJR0hfUFJJT1JJVFkgPSA0Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFBlZXJJbmZvIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3Rvcih7IHB1YmxpY0tleSwgcmVsYXlBZGRyZXNzZXMgfSkgewogICAgc3VwZXIoKQoKICAgIHRoaXMucHVibGljS2V5ID0gdW5zbGFiKHB1YmxpY0tleSkKICAgIHRoaXMucmVsYXlBZGRyZXNzZXMgPSByZWxheUFkZHJlc3NlcwoKICAgIHRoaXMucmVjb25uZWN0aW5nID0gdHJ1ZQogICAgdGhpcy5wcm92ZW4gPSBmYWxzZQogICAgdGhpcy5jb25uZWN0ZWRUaW1lID0gLTEKICAgIHRoaXMuZGlzY29ubmVjdGVkVGltZSA9IDAKICAgIHRoaXMuYmFubmVkID0gZmFsc2UKICAgIHRoaXMudHJpZWQgPSBmYWxzZQogICAgdGhpcy5leHBsaWNpdCA9IGZhbHNlCiAgICB0aGlzLndhaXRpbmcgPSBmYWxzZQogICAgdGhpcy5mb3JjZVJlbGF5aW5nID0gZmFsc2UKCiAgICAvLyBTZXQgYnkgdGhlIFN3YXJtCiAgICB0aGlzLnF1ZXVlZCA9IGZhbHNlCiAgICB0aGlzLmNsaWVudCA9IGZhbHNlCiAgICB0aGlzLnRvcGljcyA9IFtdIC8vIFRPRE86IHJlbW92ZSBvbiBuZXh0IG1ham9yIChjaGVjayB3aXRoIG1hZmludG9zaCBmb3IgY29udGV4dCkKCiAgICB0aGlzLmF0dGVtcHRzID0gMAogICAgdGhpcy5wcmlvcml0eSA9IE5PUk1BTF9QUklPUklUWQoKICAgIC8vIFVzZWQgYnkgc2h1ZmZsZWQtcHJpb3JpdHktcXVldWUKICAgIHRoaXMuX2luZGV4ID0gMAoKICAgIC8vIFVzZWQgZm9yIGZsdXNoIG1hbmFnZW1lbnQKICAgIHRoaXMuX2ZsdXNoVGljayA9IDAKCiAgICAvLyBVc2VkIGZvciB0b3BpYyBtdWx0aXBsZXhpbmcKICAgIHRoaXMuX3NlZW5Ub3BpY3MgPSBuZXcgU2V0KCkKICB9CgogIGdldCBzZXJ2ZXIoKSB7CiAgICByZXR1cm4gIXRoaXMuY2xpZW50CiAgfQoKICBnZXQgcHJpb3JpdGl6ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5wcmlvcml0eSA+PSBOT1JNQUxfUFJJT1JJVFkKICB9CgogIF9nZXRQcmlvcml0eSgpIHsKICAgIGNvbnN0IHBlZXJJc1N0YWxlID0gdGhpcy50cmllZCAmJiAhdGhpcy5wcm92ZW4KICAgIGlmIChwZWVySXNTdGFsZSB8fCB0aGlzLmF0dGVtcHRzID4gMykgcmV0dXJuIFZFUllfTE9XX1BSSU9SSVRZCiAgICBpZiAodGhpcy5hdHRlbXB0cyA9PT0gMykgcmV0dXJuIExPV19QUklPUklUWQogICAgaWYgKHRoaXMuYXR0ZW1wdHMgPT09IDIpIHJldHVybiBISUdIX1BSSU9SSVRZCiAgICBpZiAodGhpcy5hdHRlbXB0cyA9PT0gMSkgcmV0dXJuIFZFUllfSElHSF9QUklPUklUWQogICAgcmV0dXJuIE5PUk1BTF9QUklPUklUWQogIH0KCiAgX2Nvbm5lY3RlZCgpIHsKICAgIHRoaXMucHJvdmVuID0gdHJ1ZQogICAgdGhpcy5jb25uZWN0ZWRUaW1lID0gRGF0ZS5ub3coKQogIH0KCiAgX2Rpc2Nvbm5lY3RlZCgpIHsKICAgIHRoaXMuZGlzY29ubmVjdGVkVGltZSA9IERhdGUubm93KCkKICAgIGlmICh0aGlzLmNvbm5lY3RlZFRpbWUgPiAtMSkgewogICAgICBpZiAodGhpcy5kaXNjb25uZWN0ZWRUaW1lIC0gdGhpcy5jb25uZWN0ZWRUaW1lID49IE1JTl9DT05ORUNUSU9OX1RJTUUpIHRoaXMuYXR0ZW1wdHMgPSAwIC8vIGZhc3QgcmV0cnkKICAgICAgdGhpcy5jb25uZWN0ZWRUaW1lID0gLTEKICAgIH0KICAgIHRoaXMuYXR0ZW1wdHMrKwogIH0KCiAgX2RlcHJpb3JpdGl6ZSgpIHsKICAgIHRoaXMuYXR0ZW1wdHMgPSAzCiAgfQoKICBfcmVzZXQoKSB7CiAgICB0aGlzLmNsaWVudCA9IGZhbHNlCiAgICB0aGlzLnByb3ZlbiA9IGZhbHNlCiAgICB0aGlzLnRyaWVkID0gZmFsc2UKICAgIHRoaXMuYXR0ZW1wdHMgPSAwCiAgfQoKICBfdXBkYXRlUHJpb3JpdHkoKSB7CiAgICBpZiAodGhpcy5leHBsaWNpdCAmJiB0aGlzLmF0dGVtcHRzID4gMykgdGhpcy5fZGVwcmlvcml0aXplKCkKICAgIGlmICh0aGlzLmJhbm5lZCB8fCB0aGlzLnF1ZXVlZCB8fCB0aGlzLmF0dGVtcHRzID4gMykgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnByaW9yaXR5ID0gdGhpcy5fZ2V0UHJpb3JpdHkoKQogICAgcmV0dXJuIHRydWUKICB9CgogIF90b3BpYyh0b3BpYykgewogICAgY29uc3QgdG9waWNTdHJpbmcgPSBiNGEudG9TdHJpbmcodG9waWMsICdoZXgnKQogICAgaWYgKHRoaXMuX3NlZW5Ub3BpY3MuaGFzKHRvcGljU3RyaW5nKSkgcmV0dXJuCiAgICB0aGlzLl9zZWVuVG9waWNzLmFkZCh0b3BpY1N0cmluZykKICAgIHRoaXMudG9waWNzLnB1c2godG9waWMpCiAgICB0aGlzLmVtaXQoJ3RvcGljJywgdG9waWMpCiAgfQoKICByZWNvbm5lY3QodmFsKSB7CiAgICB0aGlzLnJlY29ubmVjdGluZyA9ICEhdmFsCiAgfQoKICBiYW4odmFsKSB7CiAgICB0aGlzLmJhbm5lZCA9ICEhdmFsCiAgfQoKICBzaG91bGRHQygpIHsKICAgIHJldHVybiAhKHRoaXMuYmFubmVkIHx8IHRoaXMucXVldWVkIHx8IHRoaXMuZXhwbGljaXQgfHwgdGhpcy53YWl0aW5nKQogIH0KfQpjb25zdCBCdWxrVGltZXIgPSByZXF1aXJlKCcuL2J1bGstdGltZXInKQoKY29uc3QgQkFDS09GRl9KSVRURVIgPSA1MDAKY29uc3QgQkFDS09GRl9TID0gMTAwMCArIE1hdGgucm91bmQoQkFDS09GRl9KSVRURVIgKiBNYXRoLnJhbmRvbSgpKQpjb25zdCBCQUNLT0ZGX00gPSA1MDAwICsgTWF0aC5yb3VuZCgyICogQkFDS09GRl9KSVRURVIgKiBNYXRoLnJhbmRvbSgpKQpjb25zdCBCQUNLT0ZGX0wgPSAxNTAwMCArIE1hdGgucm91bmQoNCAqIEJBQ0tPRkZfSklUVEVSICogTWF0aC5yYW5kb20oKSkKY29uc3QgQkFDS09GRl9YID0gMTAwMCAqIDYwICogMTAgKyBNYXRoLnJvdW5kKDI0MCAqIEJBQ0tPRkZfSklUVEVSICogTWF0aC5yYW5kb20oKSkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmV0cnlUaW1lciB7CiAgY29uc3RydWN0b3IoCiAgICBwdXNoLAogICAgeyBiYWNrb2ZmcyA9IFtCQUNLT0ZGX1MsIEJBQ0tPRkZfTSwgQkFDS09GRl9MLCBCQUNLT0ZGX1hdLCBqaXR0ZXIgPSBCQUNLT0ZGX0pJVFRFUiB9ID0ge30KICApIHsKICAgIHRoaXMuaml0dGVyID0gaml0dGVyCiAgICB0aGlzLmJhY2tvZmZzID0gYmFja29mZnMKCiAgICB0aGlzLl9zVGltZXIgPSBuZXcgQnVsa1RpbWVyKGJhY2tvZmZzWzBdICsgTWF0aC5yb3VuZChqaXR0ZXIgKiBNYXRoLnJhbmRvbSgpKSwgcHVzaCkKICAgIHRoaXMuX21UaW1lciA9IG5ldyBCdWxrVGltZXIoYmFja29mZnNbMV0gKyBNYXRoLnJvdW5kKGppdHRlciAqIE1hdGgucmFuZG9tKCkpLCBwdXNoKQogICAgdGhpcy5fbFRpbWVyID0gbmV3IEJ1bGtUaW1lcihiYWNrb2Zmc1syXSArIE1hdGgucm91bmQoaml0dGVyICogTWF0aC5yYW5kb20oKSksIHB1c2gpCiAgICB0aGlzLl94VGltZXIgPSBuZXcgQnVsa1RpbWVyKGJhY2tvZmZzWzNdICsgTWF0aC5yb3VuZChqaXR0ZXIgKiBNYXRoLnJhbmRvbSgpKSwgcHVzaCkKICB9CgogIF9zZWxlY3RSZXRyeVRpbWVyKHBlZXJJbmZvKSB7CiAgICBpZiAocGVlckluZm8uYmFubmVkIHx8ICFwZWVySW5mby5yZWNvbm5lY3RpbmcpIHJldHVybiBudWxsCgogICAgaWYgKHBlZXJJbmZvLmF0dGVtcHRzID4gMykgewogICAgICByZXR1cm4gcGVlckluZm8uZXhwbGljaXQgPyB0aGlzLl94VGltZXIgOiBudWxsCiAgICB9CgogICAgaWYgKHBlZXJJbmZvLmF0dGVtcHRzID09PSAwKSByZXR1cm4gdGhpcy5fc1RpbWVyCiAgICBpZiAocGVlckluZm8ucHJvdmVuKSB7CiAgICAgIHN3aXRjaCAocGVlckluZm8uYXR0ZW1wdHMpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICByZXR1cm4gdGhpcy5fc1RpbWVyCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIHRoaXMuX21UaW1lcgogICAgICAgIGNhc2UgMzoKICAgICAgICAgIHJldHVybiB0aGlzLl9sVGltZXIKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgc3dpdGNoIChwZWVySW5mby5hdHRlbXB0cykgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJldHVybiB0aGlzLl9tVGltZXIKICAgICAgICBjYXNlIDI6CiAgICAgICAgICByZXR1cm4gdGhpcy5fbFRpbWVyCiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmV0dXJuIHRoaXMuX2xUaW1lcgogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIGFkZChwZWVySW5mbykgewogICAgY29uc3QgdGltZXIgPSB0aGlzLl9zZWxlY3RSZXRyeVRpbWVyKHBlZXJJbmZvKQogICAgaWYgKCF0aW1lcikgcmV0dXJuIGZhbHNlCgogICAgdGltZXIuYWRkKHBlZXJJbmZvKQogICAgcmV0dXJuIHRydWUKICB9CgogIGRlc3Ryb3koKSB7CiAgICB0aGlzLl9zVGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl9tVGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl9sVGltZXIuZGVzdHJveSgpCiAgICB0aGlzLl94VGltZXIuZGVzdHJveSgpCiAgfQp9CnsKICAibmFtZSI6ICJoeXBlcnN3YXJtIiwKICAidmVyc2lvbiI6ICI0LjE2LjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIGRpc3RyaWJ1dGVkIG5ldHdvcmtpbmcgc3RhY2sgZm9yIGNvbm5lY3RpbmcgcGVlcnMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAibGliLyoqLmpzIgogIF0sCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjMuMSIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJoeXBlcmRodCI6ICJeNi4yMS4wIiwKICAgICJzYWZldHktY2F0Y2giOiAiXjEuMC4yIiwKICAgICJzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSI6ICJeMi4xLjAiLAogICAgInN0cmVhbXgiOiAiXjIuMjIuMSIsCiAgICAidW5zbGFiIjogIl4xLjMuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4wLjIiLAogICAgImh5cGVyY29yZS1jcnlwdG8iOiAiXjMuNC4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgInRlc3QiOiAibm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2h5cGVyc3dhcm0uZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAiY29udHJpYnV0b3JzIjogWwogICAgIkRhdmlkIE1hcmsgQ2xlbWVudHMgKEBkYXZpZG1hcmtjbGVtKSIsCiAgICAiQW5kcmV3IE9zaGVyb2ZmIChAYW5kcmV3b3NoKSIKICBdLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9oeXBlcnN3YXJtL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaHlwZXJzd2FybSIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgTUFYID0gYjRhLmZyb20oWzB4ZmZdKQpjb25zdCBCVUZGRVIgPSB7fQoKQlVGRkVSLnByZWVuY29kZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYnVmKSB7CiAgaWYgKGJ1ZiA9PT0gbnVsbCkgYnVmID0gRU1QVFkKCiAgbGV0IGkgPSAwCiAgbGV0IGV4dHJhID0gMwoKICB3aGlsZSAoKGkgPSBiNGEuaW5kZXhPZihidWYsIDB4MDAsIGkpKSA+IC0xKSB7CiAgICBpKysKICAgIGV4dHJhKysKICB9CgogIHN0YXRlLmVuZCArPSBidWYuYnl0ZUxlbmd0aCArIGV4dHJhCn0KCkJVRkZFUi5lbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIGJ1ZikgewogIGlmIChidWYgPT09IG51bGwpIGJ1ZiA9IEVNUFRZCgogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4MDAKCiAgbGV0IHByZXYgPSAwCiAgbGV0IGkgPSAwCgogIHdoaWxlICgoaSA9IGI0YS5pbmRleE9mKGJ1ZiwgMHgwMCwgaSkpID4gLTEpIHsKICAgIGNvbnN0IHNsaWNlID0gYnVmLnN1YmFycmF5KHByZXYsICsraSkKCiAgICBzdGF0ZS5idWZmZXIuc2V0KHNsaWNlLCBzdGF0ZS5zdGFydCkKICAgIHN0YXRlLnN0YXJ0ICs9IHNsaWNlLmJ5dGVMZW5ndGgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4MDIKICAgIHByZXYgPSBpCiAgfQoKICBjb25zdCBzbGljZSA9IGJ1Zi5zdWJhcnJheShwcmV2KQoKICBzdGF0ZS5idWZmZXIuc2V0KHNsaWNlLCBzdGF0ZS5zdGFydCkKICBzdGF0ZS5zdGFydCArPSBzbGljZS5ieXRlTGVuZ3RoCgogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4MDAKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAweDAxCn0KCkJVRkZFUi5kZWNvZGUgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGUuc3RhcnQgPj0gc3RhdGUuZW5kKSB0aHJvdyBuZXcgRXJyb3IoJ091dCBvZiBib3VuZHMnKQogIGlmIChzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gIT09IDB4MDApIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzdGFydCBvZiBzdHJpbmcnKQoKICBsZXQgZXNjYXBlZCA9IG51bGwKCiAgbGV0IHByZXYgPSBzdGF0ZS5zdGFydAogIGxldCBpID0gc3RhdGUuc3RhcnQKCiAgd2hpbGUgKChpID0gYjRhLmluZGV4T2Yoc3RhdGUuYnVmZmVyLCAweDAwLCBpKSkgPiAtMSkgewogICAgY29uc3QgbmV4dCA9ICsraSA8IHN0YXRlLmVuZCA/IHN0YXRlLmJ1ZmZlcltpXSA6IDB4MDAKCiAgICBpKysKCiAgICBpZiAobmV4dCA9PT0gMHgwMSkgewogICAgICBicmVhawogICAgfQoKICAgIGlmIChuZXh0ID09PSAweDAyKSB7CiAgICAgIGlmIChlc2NhcGVkID09PSBudWxsKSBlc2NhcGVkID0gW10KICAgICAgZXNjYXBlZC5wdXNoKHN0YXRlLmJ1ZmZlci5zdWJhcnJheShwcmV2LCBpIC0gMSkpCiAgICAgIHByZXYgPSBpCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHZhbHVlIGluIHRlcm1pbmF0b3InKQogIH0KCiAgaWYgKGkgPT09IC0xKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHRlcm1pbmF0b3IgZm91bmQnKQogIH0KCiAgc3RhdGUuc3RhcnQgPSBpCiAgY29uc3QgbGFzdCA9IHN0YXRlLmJ1ZmZlci5zdWJhcnJheShwcmV2LCBpIC0gMikKICBpZiAoZXNjYXBlZCA9PT0gbnVsbCkgcmV0dXJuIGxhc3QKCiAgZXNjYXBlZC5wdXNoKGxhc3QpCiAgcmV0dXJuIGI0YS5jb25jYXQoZXNjYXBlZCkKfQoKLy8gVE9ETzogY2FuIGJlIG9wdGltaXNlZCBhIGxvdAoKY29uc3QgU1RSSU5HID0ge30KClNUUklORy5wcmVlbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHN0cikgewogIEJVRkZFUi5wcmVlbmNvZGUoc3RhdGUsIGI0YS5mcm9tKHN0ciB8fCAnJykpCn0KClNUUklORy5lbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHN0cikgewogIEJVRkZFUi5lbmNvZGUoc3RhdGUsIGI0YS5mcm9tKHN0ciB8fCAnJykpCn0KClNUUklORy5kZWNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHN0cikgewogIHJldHVybiBiNGEudG9TdHJpbmcoQlVGRkVSLmRlY29kZShzdGF0ZSkpCn0KCmNvbnN0IFVJTlQgPSB7fQoKVUlOVC5wcmVlbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIG4pIHsKICBzdGF0ZS5lbmQgKz0gbiA8PSAweGZiID8gMSA6IG4gPD0gMHhmZmZmID8gMyA6IG4gPD0gMHhmZmZmZmZmZiA/IDUgOiAobiA9PT0gSW5maW5pdHkgPyAxIDogOSkKfQoKVUlOVC5lbmNvZGUgPSBmdW5jdGlvbiAoc3RhdGUsIG4pIHsKICBpZiAobiA9PT0gSW5maW5pdHkpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmYKICAgIHJldHVybgogIH0KCiAgaWYgKG4gPD0gMHhmYikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbgogICAgcmV0dXJuCiAgfQoKICBpZiAobiA8PSAweGZmZmYpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmMKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KICAgIHJldHVybgogIH0KCiAgaWYgKG4gPD0gMHhmZmZmZmZmZikgewogICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gMHhmZAogICAgZW5jb2RlVWludDMyKHN0YXRlLCBuKQogICAgcmV0dXJuCiAgfQoKICBpZiAoTnVtYmVyLmlzU2FmZUludGVnZXIobikpIHsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDB4ZmUKCiAgICBjb25zdCByID0gTWF0aC5mbG9vcihuIC8gMHgxMDAwMDAwMDApCiAgICBlbmNvZGVVaW50MzIoc3RhdGUsIHIpCiAgICBlbmNvZGVVaW50MzIoc3RhdGUsIG4pCiAgICByZXR1cm4KICB9CgogIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBudW1iZXIgJyArIG4pCn0KClVJTlQuZGVjb2RlID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlLnN0YXJ0ID49IHN0YXRlLmVuZCkgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKCiAgY29uc3QgYSA9IHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQoKICBpZiAoYSA8PSAweGZiKSByZXR1cm4gYQoKICBpZiAoYSA9PT0gMHhmYykgewogICAgaWYgKHN0YXRlLmVuZCAtIHN0YXRlLnN0YXJ0IDwgMikgdGhyb3cgbmV3IEVycm9yKCdPdXQgb2YgYm91bmRzJykKICAgIHJldHVybiAoCiAgICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwICsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdCiAgICApCiAgfQoKICBpZiAoYSA9PT0gMHhmZCkgewogICAgcmV0dXJuIGRlY29kZVVpbnQzMihzdGF0ZSkKICB9CgogIGlmIChhID09PSAweGZlKSB7CiAgICByZXR1cm4gKAogICAgICBkZWNvZGVVaW50MzIoc3RhdGUpICogMHgxMDAwMDAwMDAgKwogICAgICBkZWNvZGVVaW50MzIoc3RhdGUpCiAgICApCiAgfQoKICByZXR1cm4gSW5maW5pdHkKfQoKY29uc3QgQk9PTCA9IHt9CgpCT09MLnByZWVuY29kZSA9IChzdGF0ZSwgYikgPT4gVUlOVC5wcmVlbmNvZGUoc3RhdGUsIGIgPyAxIDogMCkKQk9PTC5lbmNvZGUgPSAoc3RhdGUsIGIpID0+IFVJTlQuZW5jb2RlKHN0YXRlLCBiID8gMSA6IDApCkJPT0wuZGVjb2RlID0gKHN0YXRlLCBiKSA9PiAhIVVJTlQuZGVjb2RlKHN0YXRlKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBJbmRleEVuY29kZXIgewogIGNvbnN0cnVjdG9yIChlbmNvZGluZ3MsIHsgcHJlZml4ID0gLTEgfSA9IHt9KSB7CiAgICB0aGlzLmVuY29kaW5ncyA9IGVuY29kaW5ncwogICAgdGhpcy5wcmVmaXggPSBwcmVmaXgKICB9CgogIHN0YXRpYyBCVUZGRVIgPSBCVUZGRVIKICBzdGF0aWMgU1RSSU5HID0gU1RSSU5HCiAgc3RhdGljIFVJTlQgPSBVSU5UCiAgc3RhdGljIEJPT0wgPSBCT09MCgogIHN0YXRpYyBsb29rdXAgKGMpIHsKICAgIHN3aXRjaCAoYykgewogICAgICBjYXNlICd1aW50JzogcmV0dXJuIFVJTlQKICAgICAgY2FzZSAndWludDgnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50MTYnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50MjQnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50MzInOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NDAnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NDgnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NTYnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICd1aW50NjQnOiByZXR1cm4gVUlOVAogICAgICBjYXNlICdzdHJpbmcnOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ3V0ZjgnOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ2FzY2lpJzogcmV0dXJuIFNUUklORwogICAgICBjYXNlICdoZXgnOiByZXR1cm4gU1RSSU5HCiAgICAgIGNhc2UgJ2Jhc2U2NCc6IHJldHVybiBTVFJJTkcKICAgICAgY2FzZSAnZml4ZWQzMic6IHJldHVybiBCVUZGRVIKICAgICAgY2FzZSAnZml4ZWQ2NCc6IHJldHVybiBCVUZGRVIKICAgICAgY2FzZSAnYnVmZmVyJzogcmV0dXJuIEJVRkZFUgogICAgICBjYXNlICdib29sJzogcmV0dXJuIEJPT0wKICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHlwZScpCiAgfQoKICBlbmNvZGUgKGtleXMpIHsKICAgIHJldHVybiB0aGlzLl9lbmNvZGUoa2V5cywgZmFsc2UpCiAgfQoKICBfZW5jb2RlIChrZXlzLCB0ZXJtaW5hdGUpIHsKICAgIGlmIChiNGEuaXNCdWZmZXIoa2V5cykpIHJldHVybiBrZXlzCgogICAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CgogICAgaWYgKHRoaXMucHJlZml4ICE9PSAtMSkgVUlOVC5wcmVlbmNvZGUoc3RhdGUsIHRoaXMucHJlZml4KQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMuZW5jb2RpbmdzW2ldLnByZWVuY29kZShzdGF0ZSwga2V5c1tpXSkKICAgIH0KCiAgICBpZiAodGVybWluYXRlICYmIGtleXMubGVuZ3RoIDwgdGhpcy5lbmNvZGluZ3MubGVuZ3RoKSB7CiAgICAgIHN0YXRlLmVuZCsrCiAgICB9CgogICAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKCiAgICBpZiAodGhpcy5wcmVmaXggIT09IC0xKSBVSU5ULmVuY29kZShzdGF0ZSwgdGhpcy5wcmVmaXgpCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5lbmNvZGluZ3NbaV0uZW5jb2RlKHN0YXRlLCBrZXlzW2ldKQogICAgfQoKICAgIGlmICh0ZXJtaW5hdGUgJiYga2V5cy5sZW5ndGggPCB0aGlzLmVuY29kaW5ncy5sZW5ndGgpIHsKICAgICAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gTUFYWzBdCiAgICB9CgogICAgcmV0dXJuIHN0YXRlLmJ1ZmZlcgogIH0KCiAgZGVjb2RlIChidWZmZXIpIHsKICAgIGNvbnN0IHN0YXRlID0geyBzdGFydDogMCwgZW5kOiBidWZmZXIuYnl0ZUxlbmd0aCwgYnVmZmVyIH0KICAgIGNvbnN0IHJlc3VsdCA9IFtdCgogICAgaWYgKHRoaXMucHJlZml4ICE9PSAtMSkgVUlOVC5kZWNvZGUoc3RhdGUpCiAgICBmb3IgKGNvbnN0IGVuYyBvZiB0aGlzLmVuY29kaW5ncykgewogICAgICBjb25zdCBrZXkgPSBzdGF0ZS5zdGFydCA8IHN0YXRlLmVuZCA/IGVuYy5kZWNvZGUoc3RhdGUpIDogKGVuYyA9PT0gVUlOVCA/IDAgOiBudWxsKQogICAgICByZXN1bHQucHVzaChrZXkpCiAgICB9CgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgZW5jb2RlUmFuZ2UgKHsgZ3QsIGd0ZSwgbHQsIGx0ZSB9KSB7CiAgICBjb25zdCByYW5nZSA9IHsKICAgICAgZ3Q6IGd0ICYmIHRoaXMuX2VuY29kZShndCwgdHJ1ZSksCiAgICAgIGd0ZTogZ3RlICYmIHRoaXMuX2VuY29kZShndGUsIGZhbHNlKSwKICAgICAgbHQ6IGx0ICYmIHRoaXMuX2VuY29kZShsdCwgZmFsc2UpLAogICAgICBsdGU6IGx0ZSAmJiB0aGlzLl9lbmNvZGUobHRlLCB0cnVlKQogICAgfQoKICAgIGlmICh0aGlzLnByZWZpeCAhPT0gLTEpIHsKICAgICAgaWYgKCFndCAmJiAhZ3RlKSByYW5nZS5ndGUgPSBlbmNvZGVVaW50KHRoaXMucHJlZml4KQogICAgICBpZiAoIWx0ICYmICFsdGUpIHJhbmdlLmx0ID0gZW5jb2RlVWludCh0aGlzLnByZWZpeCArIDEpCiAgICB9CgogICAgcmV0dXJuIHJhbmdlCiAgfQp9CgpmdW5jdGlvbiBlbmNvZGVVaW50IChuKSB7CiAgY29uc3Qgc3RhdGUgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAsIGJ1ZmZlcjogbnVsbCB9CiAgVUlOVC5wcmVlbmNvZGUoc3RhdGUsIG4pCiAgc3RhdGUuYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKHN0YXRlLmVuZCkKICBVSU5ULmVuY29kZShzdGF0ZSwgbikKICByZXR1cm4gc3RhdGUuYnVmZmVyCn0KCmZ1bmN0aW9uIGVuY29kZVVpbnQzMiAoc3RhdGUsIG4pIHsKICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSBuID4+PiAyNAogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4gPj4+IDE2CiAgc3RhdGUuYnVmZmVyW3N0YXRlLnN0YXJ0KytdID0gbiA+Pj4gOAogIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IG4KfQoKZnVuY3Rpb24gZGVjb2RlVWludDMyIChzdGF0ZSwgbikgewogIGlmIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCA8IDQpIHRocm93IG5ldyBFcnJvcignT3V0IG9mIGJvdW5kcycpCiAgcmV0dXJuICgKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwMDAwMCArCiAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gKiAweDEwMDAwICsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSAqIDB4MTAwICsKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXQogICkKfQp7CiAgIm5hbWUiOiAiaW5kZXgtZW5jb2RlciIsCiAgInZlcnNpb24iOiAiMy40LjAiLAogICJkZXNjcmlwdGlvbiI6ICJFbmNvZGUgbXVsdGlwbGUgdmFsdWVzIGludG8gc29ydGVkIGtleXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjQiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMi4xIiwKICAgICJoeXBlcmJlZSI6ICJeMi4xMC41IiwKICAgICJoeXBlcmNvcmUiOiAiXjEwLjkuMiIsCiAgICAicmFuZG9tLWFjY2Vzcy1tZW1vcnkiOiAiXjYuMi4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9pbmRleC1lbmNvZGVyLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9pbmRleC1lbmNvZGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vaW5kZXgtZW5jb2RlciIKfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpc09wdGlvbnMgKG9wdHMpIHsKICByZXR1cm4gdHlwZW9mIG9wdHMgPT09ICdvYmplY3QnICYmIG9wdHMgJiYgIWI0YS5pc0J1ZmZlcihvcHRzKQp9CnsKICAibmFtZSI6ICJpcy1vcHRpb25zIiwKICAidmVyc2lvbiI6ICIxLjAuMiIsCiAgImRlc2NyaXB0aW9uIjogIkVhc2lseSBjaGVjayBpZiBpbnB1dCBpcyBhbiBvcHRpb25zIG1hcCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjEuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjExLjAuMSIsCiAgICAidGFwZSI6ICJeNC45LjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9pcy1vcHRpb25zLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9pcy1vcHRpb25zL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2lzLW9wdGlvbnMiCn0KY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFJvdXRpbmdUYWJsZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKGlkLCBvcHRzKSB7CiAgICBpZiAoIW9wdHMpIG9wdHMgPSB7fQoKICAgIHN1cGVyKCkKCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMuayA9IG9wdHMuayB8fCAyMAogICAgdGhpcy5zaXplID0gMAogICAgdGhpcy5yb3dzID0gbmV3IEFycmF5KGlkLmxlbmd0aCAqIDgpCiAgfQoKICBhZGQgKG5vZGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9kaWZmKG5vZGUuaWQpCgogICAgbGV0IHJvdyA9IHRoaXMucm93c1tpXQoKICAgIGlmICghcm93KSB7CiAgICAgIHJvdyA9IHRoaXMucm93c1tpXSA9IG5ldyBSb3codGhpcywgaSkKICAgICAgdGhpcy5lbWl0KCdyb3cnLCByb3cpCiAgICB9CgogICAgY29uc3QgbGVuID0gcm93Lm5vZGVzLmxlbmd0aAogICAgaWYgKCFyb3cuYWRkKG5vZGUsIHRoaXMuaykpIHJldHVybiBmYWxzZQoKICAgIHRoaXMuc2l6ZSArPSByb3cubm9kZXMubGVuZ3RoIC0gbGVuCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmVtb3ZlIChpZCkgewogICAgY29uc3QgaSA9IHRoaXMuX2RpZmYoaWQpCiAgICBjb25zdCByb3cgPSB0aGlzLnJvd3NbaV0KICAgIGlmICghcm93KSByZXR1cm4gZmFsc2UKICAgIGlmICghcm93LnJlbW92ZShpZCkpIHJldHVybiBmYWxzZQogICAgdGhpcy5zaXplLS0KICAgIHJldHVybiB0cnVlCiAgfQoKICBnZXQgKGlkKSB7CiAgICBjb25zdCBpID0gdGhpcy5fZGlmZihpZCkKICAgIGNvbnN0IHJvdyA9IHRoaXMucm93c1tpXQogICAgaWYgKCFyb3cpIHJldHVybiBudWxsCiAgICByZXR1cm4gcm93LmdldChpZCkKICB9CgogIGhhcyAoaWQpIHsKICAgIHJldHVybiB0aGlzLmdldChpZCkgIT09IG51bGwKICB9CgogIHJhbmRvbSAoKSB7CiAgICBsZXQgbiA9IChNYXRoLnJhbmRvbSgpICogdGhpcy5zaXplKSB8IDAKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucm93cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByID0gdGhpcy5yb3dzW2ldCiAgICAgIGlmICghcikgY29udGludWUKICAgICAgaWYgKG4gPCByLm5vZGVzLmxlbmd0aCkgcmV0dXJuIHIubm9kZXNbbl0KICAgICAgbiAtPSByLm5vZGVzLmxlbmd0aAogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBjbG9zZXN0IChpZCwgaykgewogICAgaWYgKCFrKSBrID0gdGhpcy5rCgogICAgY29uc3QgcmVzdWx0ID0gW10KICAgIGNvbnN0IGQgPSB0aGlzLl9kaWZmKGlkKQoKICAgIC8vIHB1c2ggY2xvc2Ugbm9kZXMKICAgIGZvciAobGV0IGkgPSBkOyBpID49IDAgJiYgcmVzdWx0Lmxlbmd0aCA8IGs7IGktLSkgdGhpcy5fcHVzaE5vZGVzKGksIGssIHJlc3VsdCkKCiAgICAvLyBpZiB3ZSBkb24ndCBoYXZlIGVub3VnaCBjbG9zZSBub2RlcywgcG9wdWxhdGUgZnJvbSBvdGhlciByb3dzLCByZSB0aGUgcGFwZXIKICAgIGZvciAobGV0IGkgPSBkICsgMTsgaSA8IHRoaXMucm93cy5sZW5ndGggJiYgcmVzdWx0Lmxlbmd0aCA8IGs7IGkrKykgdGhpcy5fcHVzaE5vZGVzKGksIGssIHJlc3VsdCkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBfcHVzaE5vZGVzIChpLCBrLCByZXN1bHQpIHsKICAgIGNvbnN0IHJvdyA9IHRoaXMucm93c1tpXQogICAgaWYgKCFyb3cpIHJldHVybgoKICAgIGNvbnN0IG1pc3NpbmcgPSBNYXRoLm1pbihrIC0gcmVzdWx0Lmxlbmd0aCwgcm93Lm5vZGVzLmxlbmd0aCkKICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWlzc2luZzsgaisrKSByZXN1bHQucHVzaChyb3cubm9kZXNbal0pCiAgfQoKICB0b0FycmF5ICgpIHsKICAgIHJldHVybiB0aGlzLmNsb3Nlc3QodGhpcy5pZCwgSW5maW5pdHkpCiAgfQoKICBfZGlmZiAoaWQpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaWQubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYSA9IGlkW2ldCiAgICAgIGNvbnN0IGIgPSB0aGlzLmlkW2ldCgogICAgICBpZiAoYSAhPT0gYikgcmV0dXJuIGkgKiA4ICsgTWF0aC5jbHozMihhIF4gYikgLSAyNAogICAgfQoKICAgIHJldHVybiB0aGlzLnJvd3MubGVuZ3RoIC0gMQogIH0KfQoKY2xhc3MgUm93IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAodGFibGUsIGluZGV4KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5kYXRhID0gbnVsbCAvLyBjYW4gYmUgdXNlZCBiZSB1cHN0cmVhbSBmb3Igd2hhdGV2cwogICAgdGhpcy5ieXRlT2Zmc2V0ID0gaW5kZXggPj4gMwogICAgdGhpcy5pbmRleCA9IGluZGV4CiAgICB0aGlzLnRhYmxlID0gdGFibGUKICAgIHRoaXMubm9kZXMgPSBbXQogIH0KCiAgYWRkIChub2RlKSB7CiAgICBjb25zdCBpZCA9IG5vZGUuaWQKCiAgICBsZXQgbCA9IDAKICAgIGxldCByID0gdGhpcy5ub2Rlcy5sZW5ndGggLSAxCgogICAgd2hpbGUgKGwgPD0gcikgewogICAgICBjb25zdCBtID0gKGwgKyByKSA+PiAxCiAgICAgIGNvbnN0IGMgPSB0aGlzLmNvbXBhcmUoaWQsIHRoaXMubm9kZXNbbV0uaWQpCgogICAgICBpZiAoYyA9PT0gMCkgewogICAgICAgIHRoaXMubm9kZXNbbV0gPSBub2RlCiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQoKICAgICAgaWYgKGMgPCAwKSByID0gbSAtIDEKICAgICAgZWxzZSBsID0gbSArIDEKICAgIH0KCiAgICBpZiAodGhpcy5ub2Rlcy5sZW5ndGggPj0gdGhpcy50YWJsZS5rKSB7CiAgICAgIHRoaXMuZW1pdCgnZnVsbCcsIG5vZGUpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIHRoaXMuaW5zZXJ0KGwsIG5vZGUpCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmVtb3ZlIChpZCkgewogICAgbGV0IGwgPSAwCiAgICBsZXQgciA9IHRoaXMubm9kZXMubGVuZ3RoIC0gMQoKICAgIHdoaWxlIChsIDw9IHIpIHsKICAgICAgY29uc3QgbSA9IChsICsgcikgPj4gMQogICAgICBjb25zdCBjID0gdGhpcy5jb21wYXJlKGlkLCB0aGlzLm5vZGVzW21dLmlkKQoKICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICB0aGlzLnNwbGljZShtKQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KCiAgICAgIGlmIChjIDwgMCkgciA9IG0gLSAxCiAgICAgIGVsc2UgbCA9IG0gKyAxCiAgICB9CgogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBnZXQgKGlkKSB7CiAgICBsZXQgbCA9IDAKICAgIGxldCByID0gdGhpcy5ub2Rlcy5sZW5ndGggLSAxCgogICAgd2hpbGUgKGwgPD0gcikgewogICAgICBjb25zdCBtID0gKGwgKyByKSA+PiAxCiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzW21dCiAgICAgIGNvbnN0IGMgPSB0aGlzLmNvbXBhcmUoaWQsIG5vZGUuaWQpCgogICAgICBpZiAoYyA9PT0gMCkgcmV0dXJuIG5vZGUKICAgICAgaWYgKGMgPCAwKSByID0gbSAtIDEKICAgICAgZWxzZSBsID0gbSArIDEKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgaW5zZXJ0IChpLCBub2RlKSB7CiAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSkgLy8gcHVzaCBub2RlIG9yIG51bGwgb3Igd2hhdGV2cywganVzdCB0cnlpbmcgdG8gbm90IGJlIHBvbHltb3JwaGljCiAgICBmb3IgKGxldCBqID0gdGhpcy5ub2Rlcy5sZW5ndGggLSAxOyBqID4gaTsgai0tKSB0aGlzLm5vZGVzW2pdID0gdGhpcy5ub2Rlc1tqIC0gMV0KICAgIHRoaXMubm9kZXNbaV0gPSBub2RlCiAgICB0aGlzLmVtaXQoJ2FkZCcsIG5vZGUpCiAgfQoKICBzcGxpY2UgKGkpIHsKICAgIGZvciAoOyBpIDwgdGhpcy5ub2Rlcy5sZW5ndGggLSAxOyBpKyspIHRoaXMubm9kZXNbaV0gPSB0aGlzLm5vZGVzW2kgKyAxXQogICAgdGhpcy5lbWl0KCdyZW1vdmUnLCB0aGlzLm5vZGVzLnBvcCgpKQogIH0KCiAgLy8gdmVyeSBsaWtlbHkgdGhleSBkaXZlcmdlIGFmdGVyIGEgY291cGxlIG9mIGJ5dGVzIHNvIGEgc2ltcGxlIGltcGwsIGxpa2UgdGhpcyBpcyBwcm9wIGZhc3Rlc3QgdnMgQnVmZmVyLmNvbXBhcmUKICBjb21wYXJlIChhLCBiKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5ieXRlT2Zmc2V0OyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBhaSA9IGFbaV0KICAgICAgY29uc3QgYmkgPSBiW2ldCiAgICAgIGlmIChhaSA9PT0gYmkpIGNvbnRpbnVlCiAgICAgIHJldHVybiBhaSA8IGJpID8gLTEgOiAxCiAgICB9CiAgICByZXR1cm4gMAogIH0KfQp7CiAgIm5hbWUiOiAia2FkZW1saWEtcm91dGluZy10YWJsZSIsCiAgInZlcnNpb24iOiAiMS4wLjYiLAogICJkZXNjcmlwdGlvbiI6ICJYT1IgYmFzZWQgcm91dGluZyB0YWJsZSB1c2VkIGZvciBQMlAgbmV0d29ya3Mgc3VjaCBhcyBhIEthZGVtbGlhIERIVC4iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiaW1wb3J0cyI6IHsKICAgICJldmVudHMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZXZlbnRzIiwKICAgICAgImRlZmF1bHQiOiAiZXZlbnRzIgogICAgfQogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAia2FkZW1saWEiLAogICAgInAycCIsCiAgICAiay1idWNrZXQiLAogICAgImstYnVja2V0cyIsCiAgICAieG9yIiwKICAgICJyb3V0aW5nIiwKICAgICJkaXN0cmlidXRlZCIsCiAgICAic3lzdGVtcyIKICBdLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9rYWRlbWxpYS1yb3V0aW5nLXRhYmxlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL2thZGVtbGlhLXJvdXRpbmctdGFibGUiCn0KdmFyIHF1ZXVlVGljayA9IHJlcXVpcmUoJ3F1ZXVlLXRpY2snKQoKdmFyIG11dGV4aWZ5ID0gZnVuY3Rpb24gKCkgewogIHZhciBxdWV1ZSA9IFtdCiAgdmFyIHVzZWQgPSBudWxsCgogIHZhciBjYWxsID0gZnVuY3Rpb24gKCkgewogICAgdXNlZChyZWxlYXNlKQogIH0KCiAgdmFyIGFjcXVpcmUgPSBmdW5jdGlvbiAoZm4pIHsKICAgIGlmICh1c2VkKSByZXR1cm4gcXVldWUucHVzaChmbikKICAgIHVzZWQgPSBmbgogICAgYWNxdWlyZS5sb2NrZWQgPSB0cnVlCiAgICBxdWV1ZVRpY2soY2FsbCkKICAgIHJldHVybiAwCiAgfQoKICBhY3F1aXJlLmxvY2tlZCA9IGZhbHNlCgogIHZhciByZWxlYXNlID0gZnVuY3Rpb24gKGZuLCBlcnIsIHZhbHVlKSB7CiAgICB1c2VkID0gbnVsbAogICAgYWNxdWlyZS5sb2NrZWQgPSBmYWxzZQogICAgaWYgKHF1ZXVlLmxlbmd0aCkgYWNxdWlyZShxdWV1ZS5zaGlmdCgpKQogICAgaWYgKGZuKSBmbihlcnIsIHZhbHVlKQogIH0KCiAgcmV0dXJuIGFjcXVpcmUKfQoKbW9kdWxlLmV4cG9ydHMgPSBtdXRleGlmeQp7CiAgIm5hbWUiOiAibXV0ZXhpZnkiLAogICJ2ZXJzaW9uIjogIjEuNC4wIiwKICAiZGVzY3JpcHRpb24iOiAibXV0ZXggbG9jayBmb3IgamF2YXNjcmlwdCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAicXVldWUtdGljayI6ICJeMS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNC4zLjMiLAogICAgInRhcGUiOiAiXjMuMC4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJ0YXBlIHRlc3QuanMiLAogICAgInBvc3R0ZXN0IjogIm5wbSBydW4gbGludCIsCiAgICAibGludCI6ICJzdGFuZGFyZCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9tdXRleGlmeS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbXV0ZXhpZnkvaXNzdWVzIgogIH0sCiAgImtleXdvcmRzIjogWwogICAgIm11dGV4IiwKICAgICJsb2NrIgogIF0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbXV0ZXhpZnkiCn0KdmFyIG11dGV4aWZ5ID0gcmVxdWlyZSgnLicpCgp2YXIgbXV0ZXhpZnlQcm9taXNlID0gZnVuY3Rpb24gKCkgewogIHZhciBsb2NrID0gbXV0ZXhpZnkoKQoKICB2YXIgYWNxdWlyZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShsb2NrKQogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFjcXVpcmUsICdsb2NrZWQnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGxvY2subG9ja2VkIH0sCiAgICBlbnVtZXJhYmxlOiB0cnVlCiAgfSkKCiAgcmV0dXJuIGFjcXVpcmUKfQoKbW9kdWxlLmV4cG9ydHMgPSBtdXRleGlmeVByb21pc2UKbW9kdWxlLmV4cG9ydHMgPSBhc3NlcnQKCmNsYXNzIEFzc2VydGlvbkVycm9yIGV4dGVuZHMgRXJyb3Ige30KQXNzZXJ0aW9uRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnQXNzZXJ0aW9uRXJyb3InCgovKioKICogTWluaW1hbCBhc3NlcnQgZnVuY3Rpb24KICogQHBhcmFtICB7YW55fSB0IFZhbHVlIHRvIGNoZWNrIGlmIGZhbHN5CiAqIEBwYXJhbSAge3N0cmluZz19IG0gT3B0aW9uYWwgYXNzZXJ0aW9uIGVycm9yIG1lc3NhZ2UKICogQHRocm93cyB7QXNzZXJ0aW9uRXJyb3J9CiAqLwpmdW5jdGlvbiBhc3NlcnQgKHQsIG0pIHsKICBpZiAoIXQpIHsKICAgIHZhciBlcnIgPSBuZXcgQXNzZXJ0aW9uRXJyb3IobSkKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UoZXJyLCBhc3NlcnQpCiAgICB0aHJvdyBlcnIKICB9Cn0KewogICJuYW1lIjogIm5hbm9hc3NlcnQiLAogICJ2ZXJzaW9uIjogIjIuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAiTmFub3NjYWxlIGFzc2VydGlvbiBtb2R1bGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJ0YXBlIjogIl40LjkuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAidGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2VtaWxiYXllcy9uYW5vYXNzZXJ0LmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJhc3NlcnQiLAogICAgInVuYXNzZXJ0IiwKICAgICJwb3dlci1hc3NlcnQiLAogICAgInRpbnkiLAogICAgIm5hbm8iLAogICAgInBpY28iCiAgXSwKICAiYXV0aG9yIjogIkVtaWwgQmF5IDxnaXRodWJAdGl4ei5kaz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9lbWlsYmF5ZXMvbmFub2Fzc2VydC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2VtaWxiYXllcy9uYW5vYXNzZXJ0I3JlYWRtZSIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5hdFNhbXBsZXIgewogIGNvbnN0cnVjdG9yICgpIHsKICAgIHRoaXMuaG9zdCA9IG51bGwKICAgIHRoaXMucG9ydCA9IDAKICAgIHRoaXMuc2l6ZSA9IDAKCiAgICB0aGlzLl9hID0gbnVsbAogICAgdGhpcy5fYiA9IG51bGwKICAgIHRoaXMuX3RocmVzaG9sZCA9IDAKICAgIHRoaXMuX3RvcCA9IDAKICAgIHRoaXMuX3NhbXBsZXMgPSBbXQogIH0KCiAgYWRkIChob3N0LCBwb3J0KSB7CiAgICBjb25zdCBhID0gdGhpcy5fYnVtcChob3N0LCBwb3J0LCAyKQogICAgY29uc3QgYiA9IHRoaXMuX2J1bXAoaG9zdCwgMCwgMSkKCiAgICBpZiAodGhpcy5fc2FtcGxlcy5sZW5ndGggPCAzMikgewogICAgICB0aGlzLnNpemUrKwogICAgICB0aGlzLl90aHJlc2hvbGQgPSB0aGlzLnNpemUgLSAodGhpcy5zaXplIDwgNCA/IDAgOiB0aGlzLnNpemUgPCA4ID8gMSA6IHRoaXMuc2l6ZSA8IDEyID8gMiA6IDMpCiAgICAgIHRoaXMuX3NhbXBsZXMucHVzaChhLCBiKQogICAgICB0aGlzLl90b3AgKz0gMgogICAgfSBlbHNlIHsKICAgICAgaWYgKHRoaXMuX3RvcCA9PT0gMzIpIHRoaXMuX3RvcCA9IDAKCiAgICAgIGNvbnN0IG9hID0gdGhpcy5fc2FtcGxlc1t0aGlzLl90b3BdCiAgICAgIHRoaXMuX3NhbXBsZXNbdGhpcy5fdG9wKytdID0gYQogICAgICBvYS5oaXRzLS0KCiAgICAgIGNvbnN0IG9iID0gdGhpcy5fc2FtcGxlc1t0aGlzLl90b3BdCiAgICAgIHRoaXMuX3NhbXBsZXNbdGhpcy5fdG9wKytdID0gYgogICAgICBvYi5oaXRzLS0KICAgIH0KCiAgICBpZiAodGhpcy5fYSA9PT0gbnVsbCB8fCB0aGlzLl9hLmhpdHMgPCBhLmhpdHMpIHRoaXMuX2EgPSBhCiAgICBpZiAodGhpcy5fYiA9PT0gbnVsbCB8fCB0aGlzLl9iLmhpdHMgPCBiLmhpdHMpIHRoaXMuX2IgPSBiCgogICAgaWYgKHRoaXMuX2EuaGl0cyA+PSB0aGlzLl90aHJlc2hvbGQpIHsKICAgICAgdGhpcy5ob3N0ID0gdGhpcy5fYS5ob3N0CiAgICAgIHRoaXMucG9ydCA9IHRoaXMuX2EucG9ydAogICAgfSBlbHNlIGlmICh0aGlzLl9iLmhpdHMgPj0gdGhpcy5fdGhyZXNob2xkKSB7CiAgICAgIHRoaXMuaG9zdCA9IHRoaXMuX2IuaG9zdAogICAgICB0aGlzLnBvcnQgPSAwCiAgICB9IGVsc2UgewogICAgICB0aGlzLmhvc3QgPSBudWxsCiAgICAgIHRoaXMucG9ydCA9IDAKICAgIH0KCiAgICByZXR1cm4gYS5oaXRzCiAgfQoKICBfYnVtcCAoaG9zdCwgcG9ydCwgaW5jKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICBjb25zdCBqID0gKHRoaXMuX3RvcCAtIGluYyAtICgyICogaSkpICYgMzEKICAgICAgaWYgKGogPj0gdGhpcy5fc2FtcGxlcy5sZW5ndGgpIHJldHVybiB7IGhvc3QsIHBvcnQsIGhpdHM6IDEgfQogICAgICBjb25zdCBzID0gdGhpcy5fc2FtcGxlc1tqXQogICAgICBpZiAocy5wb3J0ID09PSBwb3J0ICYmIHMuaG9zdCA9PT0gaG9zdCkgewogICAgICAgIHMuaGl0cysrCiAgICAgICAgcmV0dXJuIHMKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsgaG9zdCwgcG9ydCwgaGl0czogMSB9CiAgfQp9CnsKICAibmFtZSI6ICJuYXQtc2FtcGxlciIsCiAgInZlcnNpb24iOiAiMS4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJTYW1wbGUgYWRkcmVzc2VzIHRvIGZpZ3VyZSBvdXQgaWYgYSBob3N0ICsgcG9ydCBpcyBjb25zaXN0ZW50IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIsCiAgICAidGFwZSI6ICJeNS4yLjIiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbmF0LXNhbXBsZXIuZ2l0IgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbmF0LXNhbXBsZXIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvbmF0LXNhbXBsZXIiCn0KLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovCmNvbnN0IHNvZGl1bSA9IHJlcXVpcmUoJ3NvZGl1bS11bml2ZXJzYWwnKQpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IERITEVOID0gc29kaXVtLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMKY29uc3QgUEtMRU4gPSBzb2RpdW0uY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUwpjb25zdCBTQ0FMQVJMRU4gPSBzb2RpdW0uY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUwpjb25zdCBTS0xFTiA9IHNvZGl1bS5jcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUwpjb25zdCBBTEcgPSAnRWQyNTUxOScKCm1vZHVsZS5leHBvcnRzID0gewogIERITEVOLAogIFBLTEVOLAogIFNDQUxBUkxFTiwKICBTS0xFTiwKICBBTEcsCiAgbmFtZTogQUxHLAogIGdlbmVyYXRlS2V5UGFpciwKICBkaAp9CgpmdW5jdGlvbiBnZW5lcmF0ZUtleVBhaXIgKHByaXZLZXkpIHsKICBpZiAocHJpdktleSkgcmV0dXJuIGdlbmVyYXRlU2VlZEtleVBhaXIocHJpdktleS5zdWJhcnJheSgwLCAzMikpCgogIGNvbnN0IGtleVBhaXIgPSB7fQogIGtleVBhaXIuc2VjcmV0S2V5ID0gYjRhLmFsbG9jKFNLTEVOKQogIGtleVBhaXIucHVibGljS2V5ID0gYjRhLmFsbG9jKFBLTEVOKQoKICBzb2RpdW0uY3J5cHRvX3NpZ25fa2V5cGFpcihrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXkpCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gZ2VuZXJhdGVTZWVkS2V5UGFpciAoc2VlZCkgewogIGNvbnN0IGtleVBhaXIgPSB7fQogIGtleVBhaXIuc2VjcmV0S2V5ID0gYjRhLmFsbG9jKFNLTEVOKQogIGtleVBhaXIucHVibGljS2V5ID0gYjRhLmFsbG9jKFBLTEVOKQoKICBzb2RpdW0uY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSwgc2VlZCkKICByZXR1cm4ga2V5UGFpcgp9CgpmdW5jdGlvbiBkaCAocHVibGljS2V5LCB7IHNjYWxhciwgc2VjcmV0S2V5IH0pIHsKICAvLyB0d2Vha2VkIGtleXMgZXhwb3NlIHNjYWxhciBkaXJlY3RseQogIGlmICghc2NhbGFyKSB7CiAgICBhc3NlcnQoc2VjcmV0S2V5LmJ5dGVMZW5ndGggPT09IFNLTEVOKQoKICAgIC8vIGxpYnNvZGl1bSBzdG9yZXMgc2VlZCBub3QgYWN0dWFsIHNjYWxhcgogICAgY29uc3Qgc2sgPSBiNGEuYWxsb2MoNjQpCiAgICBzb2RpdW0uY3J5cHRvX2hhc2hfc2hhNTEyKHNrLCBzZWNyZXRLZXkuc3ViYXJyYXkoMCwgMzIpKQogICAgc2tbMF0gJj0gMjQ4CiAgICBza1szMV0gJj0gMTI3CiAgICBza1szMV0gfD0gNjQKCiAgICBzY2FsYXIgPSBzay5zdWJhcnJheSgwLCAzMikKICB9CgogIGFzc2VydChzY2FsYXIuYnl0ZUxlbmd0aCA9PT0gU0NBTEFSTEVOKQogIGFzc2VydChwdWJsaWNLZXkuYnl0ZUxlbmd0aCA9PT0gUEtMRU4pCgogIGNvbnN0IG91dHB1dCA9IGI0YS5hbGxvYyhESExFTikKCiAgLy8gd2UgY2xhbXAgaWYgbmVjZXNzYXJ5IGFib3ZlCiAgc29kaXVtLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfbm9jbGFtcCgKICAgIG91dHB1dCwKICAgIHNjYWxhciwKICAgIHB1YmxpY0tleQogICkKCiAgcmV0dXJuIG91dHB1dAp9CnsKICAibmFtZSI6ICJub2lzZS1jdXJ2ZS1lZCIsCiAgInZlcnNpb24iOiAiMi4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJFZDI1NTE5IGVsbGlwdGljIGN1cnZlIG9wZXJhdGlvbnMgZm9yIFtgbm9pc2UtaGFuZHNoYWtlYF0oaHR0cHM6Ly9naXRodWIuY29tL2NobS1kaWVkZXJpY2hzL25vaXNlLWhhbmRzaGFrZSkiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5weCBzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vY2htLWRpZWRlcmljaHMvbm9pc2UtY3VydmUtZWQuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogW10sCiAgImF1dGhvciI6ICIiLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9jaG0tZGllZGVyaWNocy9ub2lzZS1jdXJ2ZS1lZC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2NobS1kaWVkZXJpY2hzL25vaXNlLWN1cnZlLWVkI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMS4wIiwKICAgICJuYW5vYXNzZXJ0IjogIl4yLjAuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgIm5vaXNlLWhhbmRzaGFrZSI6ICJeMy4wLjAiLAogICAgInN0YW5kYXJkIjogIl4xNi4wLjMiLAogICAgInRhcGUiOiAiXjUuMi4yIgogIH0KfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQ2lwaGVyU3RhdGUgewogIGNvbnN0cnVjdG9yIChrZXkpIHsKICAgIHRoaXMua2V5ID0ga2V5IHx8IG51bGwKICAgIHRoaXMubm9uY2UgPSAwCiAgICB0aGlzLkNJUEhFUl9BTEcgPSAnQ2hhQ2hhUG9seScKICB9CgogIGluaXRpYWxpc2VLZXkgKGtleSkgewogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMubm9uY2UgPSAwCiAgfQoKICBzZXROb25jZSAobm9uY2UpIHsKICAgIHRoaXMubm9uY2UgPSBub25jZQogIH0KCiAgZW5jcnlwdCAocGxhaW50ZXh0LCBhZCkgewogICAgaWYgKCF0aGlzLmhhc0tleSkgcmV0dXJuIHBsYWludGV4dAogICAgaWYgKCFhZCkgYWQgPSBiNGEuYWxsb2MoMCkKCiAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gZW5jcnlwdFdpdGhBRCh0aGlzLmtleSwgdGhpcy5ub25jZSwgYWQsIHBsYWludGV4dCkKICAgIGlmIChjaXBoZXJ0ZXh0Lmxlbmd0aCA+IDY1NTM1KSB0aHJvdyBuZXcgRXJyb3IoYGNpcGhlcnRleHQgbGVuZ3RoIG9mICR7Y2lwaGVydGV4dC5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBOb2lzZSBtZXNzYWdlIGxlbmd0aCBvZiA2NTUzNWApCiAgICB0aGlzLm5vbmNlKysKCiAgICByZXR1cm4gY2lwaGVydGV4dAogIH0KCiAgZGVjcnlwdCAoY2lwaGVydGV4dCwgYWQpIHsKICAgIGlmICghdGhpcy5oYXNLZXkpIHJldHVybiBjaXBoZXJ0ZXh0CiAgICBpZiAoIWFkKSBhZCA9IGI0YS5hbGxvYygwKQogICAgaWYgKGNpcGhlcnRleHQubGVuZ3RoID4gNjU1MzUpIHRocm93IG5ldyBFcnJvcihgY2lwaGVydGV4dCBsZW5ndGggb2YgJHtjaXBoZXJ0ZXh0Lmxlbmd0aH0gZXhjZWVkcyBtYXhpbXVtIE5vaXNlIG1lc3NhZ2UgbGVuZ3RoIG9mIDY1NTM1YCkKCiAgICBjb25zdCBwbGFpbnRleHQgPSBkZWNyeXB0V2l0aEFEKHRoaXMua2V5LCB0aGlzLm5vbmNlLCBhZCwgY2lwaGVydGV4dCkKICAgIHRoaXMubm9uY2UrKwoKICAgIHJldHVybiBwbGFpbnRleHQKICB9CgogIGdldCBoYXNLZXkgKCkgewogICAgcmV0dXJuIHRoaXMua2V5ICE9PSBudWxsCiAgfQoKICBfY2xlYXIgKCkgewogICAgc29kaXVtLnNvZGl1bV9tZW16ZXJvKHRoaXMua2V5KQogICAgdGhpcy5rZXkgPSBudWxsCiAgICB0aGlzLm5vbmNlID0gbnVsbAogIH0KCiAgc3RhdGljIGdldCBNQUNCWVRFUyAoKSB7CiAgICByZXR1cm4gMTYKICB9CgogIHN0YXRpYyBnZXQgTk9OQ0VCWVRFUyAoKSB7CiAgICByZXR1cm4gOAogIH0KCiAgc3RhdGljIGdldCBLRVlCWVRFUyAoKSB7CiAgICByZXR1cm4gMzIKICB9Cn0KCmZ1bmN0aW9uIGVuY3J5cHRXaXRoQUQgKGtleSwgY291bnRlciwgYWRkaXRpb25hbERhdGEsIHBsYWludGV4dCkgewogIC8vIGZvciBvdXIgcHVycG9zZXMsIGFkZGl0aW9uYWxEYXRhIHdpbGwgYWx3YXlzIGJlIGEgcHVia2V5IHNvIHdlIGVuY29kZSBmcm9tIGhleAogIGlmICghYjRhLmlzQnVmZmVyKGFkZGl0aW9uYWxEYXRhKSkgYWRkaXRpb25hbERhdGEgPSBiNGEuZnJvbShhZGRpdGlvbmFsRGF0YSwgJ2hleCcpCiAgaWYgKCFiNGEuaXNCdWZmZXIocGxhaW50ZXh0KSkgcGxhaW50ZXh0ID0gYjRhLmZyb20ocGxhaW50ZXh0LCAnaGV4JykKCiAgY29uc3Qgbm9uY2UgPSBiNGEuYWxsb2Moc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhub25jZS5idWZmZXIsIG5vbmNlLmJ5dGVPZmZzZXQsIG5vbmNlLmJ5dGVMZW5ndGgpCiAgdmlldy5zZXRVaW50MzIoNCwgY291bnRlciwgdHJ1ZSkKCiAgY29uc3QgY2lwaGVydGV4dCA9IGI0YS5hbGxvYyhwbGFpbnRleHQuYnl0ZUxlbmd0aCArIHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQoKICBzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHQoY2lwaGVydGV4dCwgcGxhaW50ZXh0LCBhZGRpdGlvbmFsRGF0YSwgbnVsbCwgbm9uY2UsIGtleSkKICByZXR1cm4gY2lwaGVydGV4dAp9CgpmdW5jdGlvbiBkZWNyeXB0V2l0aEFEIChrZXksIGNvdW50ZXIsIGFkZGl0aW9uYWxEYXRhLCBjaXBoZXJ0ZXh0KSB7CiAgLy8gZm9yIG91ciBwdXJwb3NlcywgYWRkaXRpb25hbERhdGEgd2lsbCBhbHdheXMgYmUgYSBwdWJrZXkgc28gd2UgZW5jb2RlIGZyb20gaGV4CiAgaWYgKCFiNGEuaXNCdWZmZXIoYWRkaXRpb25hbERhdGEpKSBhZGRpdGlvbmFsRGF0YSA9IGI0YS5mcm9tKGFkZGl0aW9uYWxEYXRhLCAnaGV4JykKICBpZiAoIWI0YS5pc0J1ZmZlcihjaXBoZXJ0ZXh0KSkgY2lwaGVydGV4dCA9IGI0YS5mcm9tKGNpcGhlcnRleHQsICdoZXgnKQoKICBjb25zdCBub25jZSA9IGI0YS5hbGxvYyhzb2RpdW0uY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX05QVUJCWVRFUykKICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KG5vbmNlLmJ1ZmZlciwgbm9uY2UuYnl0ZU9mZnNldCwgbm9uY2UuYnl0ZUxlbmd0aCkKICB2aWV3LnNldFVpbnQzMig0LCBjb3VudGVyLCB0cnVlKQoKICBjb25zdCBwbGFpbnRleHQgPSBiNGEuYWxsb2MoY2lwaGVydGV4dC5ieXRlTGVuZ3RoIC0gc29kaXVtLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCgogIHNvZGl1bS5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdChwbGFpbnRleHQsIG51bGwsIGNpcGhlcnRleHQsIGFkZGl0aW9uYWxEYXRhLCBub25jZSwga2V5KQogIHJldHVybiBwbGFpbnRleHQKfQovKiBlc2xpbnQtZGlzYWJsZSBjYW1lbGNhc2UgKi8KY29uc3QgewogIGNyeXB0b19reF9TRUVEQllURVMsCiAgY3J5cHRvX2t4X2tleXBhaXIsCiAgY3J5cHRvX2t4X3NlZWRfa2V5cGFpciwKICBjcnlwdG9fc2NhbGFybXVsdF9CWVRFUywKICBjcnlwdG9fc2NhbGFybXVsdF9TQ0FMQVJCWVRFUywKICBjcnlwdG9fc2NhbGFybXVsdCwKICBjcnlwdG9fc2NhbGFybXVsdF9iYXNlCn0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQoKY29uc3QgREhMRU4gPSBjcnlwdG9fc2NhbGFybXVsdF9CWVRFUwpjb25zdCBQS0xFTiA9IGNyeXB0b19zY2FsYXJtdWx0X0JZVEVTCmNvbnN0IFNLTEVOID0gY3J5cHRvX3NjYWxhcm11bHRfU0NBTEFSQllURVMKY29uc3QgU0VFRExFTiA9IGNyeXB0b19reF9TRUVEQllURVMKY29uc3QgQUxHID0gJzI1NTE5JwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgREhMRU4sCiAgUEtMRU4sCiAgU0tMRU4sCiAgU0VFRExFTiwKICBBTEcsCiAgZ2VuZXJhdGVLZXlQYWlyLAogIGdlbmVyYXRlU2VlZEtleVBhaXIsCiAgZGgKfQoKZnVuY3Rpb24gZ2VuZXJhdGVLZXlQYWlyIChwcml2S2V5KSB7CiAgY29uc3Qga2V5UGFpciA9IHt9CgogIGtleVBhaXIuc2VjcmV0S2V5ID0gcHJpdktleSB8fCBiNGEuYWxsb2MoU0tMRU4pCiAga2V5UGFpci5wdWJsaWNLZXkgPSBiNGEuYWxsb2MoUEtMRU4pCgogIGlmIChwcml2S2V5KSB7CiAgICBjcnlwdG9fc2NhbGFybXVsdF9iYXNlKGtleVBhaXIucHVibGljS2V5LCBrZXlQYWlyLnNlY3JldEtleSkKICB9IGVsc2UgewogICAgY3J5cHRvX2t4X2tleXBhaXIoa2V5UGFpci5wdWJsaWNLZXksIGtleVBhaXIuc2VjcmV0S2V5KQogIH0KCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gZ2VuZXJhdGVTZWVkS2V5UGFpciAoc2VlZCkgewogIGFzc2VydChzZWVkLmJ5dGVMZW5ndGggPT09IFNLTEVOKQoKICBjb25zdCBrZXlQYWlyID0ge30KICBrZXlQYWlyLnNlY3JldEtleSA9IGI0YS5hbGxvYyhTS0xFTikKICBrZXlQYWlyLnB1YmxpY0tleSA9IGI0YS5hbGxvYyhQS0xFTikKCiAgY3J5cHRvX2t4X3NlZWRfa2V5cGFpcihrZXlQYWlyLnB1YmxpY0tleSwga2V5UGFpci5zZWNyZXRLZXksIHNlZWQpCiAgcmV0dXJuIGtleVBhaXIKfQoKZnVuY3Rpb24gZGggKHB1YmxpY0tleSwgeyBzZWNyZXRLZXkgfSkgewogIGFzc2VydChzZWNyZXRLZXkuYnl0ZUxlbmd0aCA9PT0gU0tMRU4pCiAgYXNzZXJ0KHB1YmxpY0tleS5ieXRlTGVuZ3RoID09PSBQS0xFTikKCiAgY29uc3Qgb3V0cHV0ID0gYjRhLmFsbG9jKERITEVOKQoKICBjcnlwdG9fc2NhbGFybXVsdCgKICAgIG91dHB1dCwKICAgIHNlY3JldEtleSwKICAgIHB1YmxpY0tleQogICkKCiAgcmV0dXJuIG91dHB1dAp9CmNvbnN0IGhtYWNCbGFrZTJiID0gcmVxdWlyZSgnLi9obWFjJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEhBU0hMRU4gPSA2NAoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaGtkZiwKICBIQVNITEVOCn0KCi8vIEhNQUMtYmFzZWQgRXh0cmFjdC1hbmQtRXhwYW5kIEtERgovLyBodHRwczovL3d3dy5pZXRmLm9yZy9yZmMvcmZjNTg2OS50eHQKCmZ1bmN0aW9uIGhrZGYgKHNhbHQsIGlucHV0S2V5TWF0ZXJpYWwsIGluZm8gPSAnJywgbGVuZ3RoID0gMiAqIEhBU0hMRU4pIHsKICBjb25zdCBwc2V1ZG9SYW5kb21LZXkgPSBoa2RmRXh0cmFjdChzYWx0LCBpbnB1dEtleU1hdGVyaWFsKQogIHJldHVybiBoa2RmRXhwYW5kKHBzZXVkb1JhbmRvbUtleSwgaW5mbywgbGVuZ3RoKQp9CgpmdW5jdGlvbiBoa2RmRXh0cmFjdCAoc2FsdCwgaW5wdXRLZXlNYXRlcmlhbCkgewogIGNvbnN0IGhtYWMgPSBiNGEuYWxsb2MoSEFTSExFTikKICByZXR1cm4gaG1hY0RpZ2VzdChobWFjLCBzYWx0LCBpbnB1dEtleU1hdGVyaWFsKQp9CgpmdW5jdGlvbiBoa2RmRXhwYW5kIChrZXksIGluZm8sIGxlbmd0aCkgewogIC8vIFB1dCBpbiBkZWRpY2F0ZWQgc2xhYiB0byBhdm9pZCBrZWVwaW5nIHNoYXJlZCBzbGFiIGZyb20gYmVpbmcgZ2MnZWQKICBjb25zdCBidWZmZXIgPSBiNGEuYWxsb2NVbnNhZmVTbG93KGxlbmd0aCkKCiAgY29uc3QgaW5mb0J1ZiA9IGI0YS5mcm9tKGluZm8pCiAgbGV0IHByZXYgPSBpbmZvQnVmCgogIGNvbnN0IHJlc3VsdCA9IFtdCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gSEFTSExFTikgewogICAgY29uc3QgcG9zID0gYjRhLmZyb20oWyhpIC8gSEFTSExFTikgKyAxXSkKCiAgICBjb25zdCBvdXQgPSBidWZmZXIuc3ViYXJyYXkoaSwgaSArIEhBU0hMRU4pCiAgICByZXN1bHQucHVzaChvdXQpCgogICAgcHJldiA9IGhtYWNEaWdlc3Qob3V0LCBrZXksIFtwcmV2LCBpbmZvQnVmLCBwb3NdKQogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CgpmdW5jdGlvbiBobWFjRGlnZXN0IChvdXQsIGtleSwgaW5wdXQpIHsKICBobWFjQmxha2UyYihvdXQsIGlucHV0LCBrZXkpCiAgcmV0dXJuIG91dAp9Ci8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCB7IHNvZGl1bV9tZW16ZXJvLCBjcnlwdG9fZ2VuZXJpY2hhc2gsIGNyeXB0b19nZW5lcmljaGFzaF9iYXRjaCB9ID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCgpjb25zdCBIQVNITEVOID0gNjQKY29uc3QgQkxPQ0tMRU4gPSAxMjgKY29uc3Qgc2NyYXRjaCA9IGI0YS5hbGxvYyhCTE9DS0xFTiAqIDMpCmNvbnN0IEhNQUNLZXkgPSBzY3JhdGNoLnN1YmFycmF5KEJMT0NLTEVOICogMCwgQkxPQ0tMRU4gKiAxKQpjb25zdCBPdXRlcktleVBhZCA9IHNjcmF0Y2guc3ViYXJyYXkoQkxPQ0tMRU4gKiAxLCBCTE9DS0xFTiAqIDIpCmNvbnN0IElubmVyS2V5UGFkID0gc2NyYXRjaC5zdWJhcnJheShCTE9DS0xFTiAqIDIsIEJMT0NLTEVOICogMykKCi8vIFBvc3QtZmlsbCBpcyBkb25lIGluIHRoZSBjYXNlcyB3aGVyZSBzb21lb25lIGNhdWdodCBhbiBleGNlcHRpb24gdGhhdAovLyBoYXBwZW5lZCBiZWZvcmUgd2Ugd2VyZSBhYmxlIHRvIGNsZWFyIGRhdGEgYXQgdGhlIGVuZAoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBobWFjIChvdXQsIGJhdGNoLCBrZXkpIHsKICBpZiAoa2V5LmJ5dGVMZW5ndGggPiBCTE9DS0xFTikgewogICAgY3J5cHRvX2dlbmVyaWNoYXNoKEhNQUNLZXkuc3ViYXJyYXkoMCwgSEFTSExFTiksIGtleSkKICAgIHNvZGl1bV9tZW16ZXJvKEhNQUNLZXkuc3ViYXJyYXkoSEFTSExFTikpCiAgfSBlbHNlIHsKICAgIC8vIENvdmVycyBrZXkgPD0gQkxPQ0tMRU4KICAgIEhNQUNLZXkuc2V0KGtleSkKICAgIHNvZGl1bV9tZW16ZXJvKEhNQUNLZXkuc3ViYXJyYXkoa2V5LmJ5dGVMZW5ndGgpKQogIH0KCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBITUFDS2V5LmJ5dGVMZW5ndGg7IGkrKykgewogICAgT3V0ZXJLZXlQYWRbaV0gPSAweDVjIF4gSE1BQ0tleVtpXQogICAgSW5uZXJLZXlQYWRbaV0gPSAweDM2IF4gSE1BQ0tleVtpXQogIH0KICBzb2RpdW1fbWVtemVybyhITUFDS2V5KQoKICBjcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2gob3V0LCBbSW5uZXJLZXlQYWRdLmNvbmNhdChiYXRjaCkpCiAgc29kaXVtX21lbXplcm8oSW5uZXJLZXlQYWQpCiAgY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoKG91dCwgW091dGVyS2V5UGFkLCBvdXRdKQogIHNvZGl1bV9tZW16ZXJvKE91dGVyS2V5UGFkKQp9Cgptb2R1bGUuZXhwb3J0cy5CWVRFUyA9IEhBU0hMRU4KbW9kdWxlLmV4cG9ydHMuS0VZQllURVMgPSBCTE9DS0xFTgpjb25zdCBhc3NlcnQgPSByZXF1aXJlKCduYW5vYXNzZXJ0JykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IFN5bW1ldHJpY1N0YXRlID0gcmVxdWlyZSgnLi9zeW1tZXRyaWMtc3RhdGUnKQpjb25zdCB7IEhBU0hMRU4gfSA9IHJlcXVpcmUoJy4vaGtkZicpCgpjb25zdCBQUkVTSEFSRV9JUyA9IFN5bWJvbCgnaW5pdGlhdG9yIHN0YXRpYyBrZXkgcHJlc2hhcmVkJykKY29uc3QgUFJFU0hBUkVfUlMgPSBTeW1ib2woJ3Jlc3BvbmRlciBzdGF0aWMga2V5IHByZXNoYXJlZCcpCgpjb25zdCBUT0tfUFNLID0gU3ltYm9sKCdwc2snKQoKY29uc3QgVE9LX1MgPSBTeW1ib2woJ3MnKQpjb25zdCBUT0tfRSA9IFN5bWJvbCgnZScpCgpjb25zdCBUT0tfRVMgPSBTeW1ib2woJ2VzJykKY29uc3QgVE9LX1NFID0gU3ltYm9sKCdzZScpCmNvbnN0IFRPS19FRSA9IFN5bWJvbCgnZWUnKQpjb25zdCBUT0tfU1MgPSBTeW1ib2woJ3NzJykKCmNvbnN0IEhBTkRTSEFLRVMgPSBPYmplY3QuZnJlZXplKHsKICBOTjogWwogICAgW1RPS19FXSwKICAgIFtUT0tfRSwgVE9LX0VFXQogIF0sCiAgTk5wc2swOiBbCiAgICBbVE9LX1BTSywgVE9LX0VdLAogICAgW1RPS19FLCBUT0tfRUVdCiAgXSwKICBYWDogWwogICAgW1RPS19FXSwKICAgIFtUT0tfRSwgVE9LX0VFLCBUT0tfUywgVE9LX0VTXSwKICAgIFtUT0tfUywgVE9LX1NFXQogIF0sCiAgWFhwc2swOiBbCiAgICBbVE9LX1BTSywgVE9LX0VdLAogICAgW1RPS19FLCBUT0tfRUUsIFRPS19TLCBUT0tfRVNdLAogICAgW1RPS19TLCBUT0tfU0VdCiAgXSwKICBJSzogWwogICAgUFJFU0hBUkVfUlMsCiAgICBbVE9LX0UsIFRPS19FUywgVE9LX1MsIFRPS19TU10sCiAgICBbVE9LX0UsIFRPS19FRSwgVE9LX1NFXQogIF0sCiAgWEs6IFsKICAgIFBSRVNIQVJFX1JTLAogICAgW1RPS19FLCBUT0tfRVNdLAogICAgW1RPS19FLCBUT0tfRUVdLAogICAgW1RPS19TLCBUT0tfU0VdCiAgXQp9KQoKY2xhc3MgV3JpdGVyIHsKICBjb25zdHJ1Y3RvciAoKSB7CiAgICB0aGlzLnNpemUgPSAwCiAgICB0aGlzLmJ1ZmZlcnMgPSBbXQogIH0KCiAgcHVzaCAoYikgewogICAgdGhpcy5zaXplICs9IGIuYnl0ZUxlbmd0aAogICAgdGhpcy5idWZmZXJzLnB1c2goYikKICB9CgogIGVuZCAoKSB7CiAgICBjb25zdCBhbGwgPSBiNGEuYWxsb2ModGhpcy5zaXplKQogICAgbGV0IG9mZnNldCA9IDAKICAgIGZvciAoY29uc3QgYiBvZiB0aGlzLmJ1ZmZlcnMpIHsKICAgICAgYWxsLnNldChiLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSBiLmJ5dGVMZW5ndGgKICAgIH0KICAgIHJldHVybiBhbGwKICB9Cn0KCmNsYXNzIFJlYWRlciB7CiAgY29uc3RydWN0b3IgKGJ1ZikgewogICAgdGhpcy5vZmZzZXQgPSAwCiAgICB0aGlzLmJ1ZmZlciA9IGJ1ZgogIH0KCiAgc2hpZnQgKG4pIHsKICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5vZmZzZXQKICAgIGNvbnN0IGVuZCA9IHRoaXMub2Zmc2V0ICs9IG4KICAgIGlmIChlbmQgPiB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ0luc3VmZmljaWVudCBieXRlcycpCiAgICByZXR1cm4gdGhpcy5idWZmZXIuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICB9CgogIGVuZCAoKSB7CiAgICByZXR1cm4gdGhpcy5zaGlmdCh0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoIC0gdGhpcy5vZmZzZXQpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5vaXNlU3RhdGUgZXh0ZW5kcyBTeW1tZXRyaWNTdGF0ZSB7CiAgY29uc3RydWN0b3IgKHBhdHRlcm4sIGluaXRpYXRvciwgc3RhdGljS2V5cGFpciwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMucyA9IHN0YXRpY0tleXBhaXIgfHwgdGhpcy5jdXJ2ZS5nZW5lcmF0ZUtleVBhaXIoKQogICAgdGhpcy5lID0gbnVsbAoKICAgIHRoaXMucHNrID0gbnVsbAogICAgaWYgKG9wdHMgJiYgb3B0cy5wc2spIHRoaXMucHNrID0gb3B0cy5wc2sKCiAgICB0aGlzLnJlID0gbnVsbAogICAgdGhpcy5ycyA9IG51bGwKCiAgICB0aGlzLnBhdHRlcm4gPSBwYXR0ZXJuCiAgICB0aGlzLmhhbmRzaGFrZSA9IEhBTkRTSEFLRVNbdGhpcy5wYXR0ZXJuXS5zbGljZSgpCgogICAgdGhpcy5pc1Bza0hhbmRzaGFrZSA9ICEhdGhpcy5wc2sgJiYgaGFzUHNrVG9rZW4odGhpcy5oYW5kc2hha2UpCgogICAgdGhpcy5wcm90b2NvbCA9IGI0YS5mcm9tKFsKICAgICAgJ05vaXNlJywKICAgICAgdGhpcy5wYXR0ZXJuLAogICAgICB0aGlzLkRIX0FMRywKICAgICAgdGhpcy5DSVBIRVJfQUxHLAogICAgICAnQkxBS0UyYicKICAgIF0uam9pbignXycpKQoKICAgIHRoaXMuaW5pdGlhdG9yID0gaW5pdGlhdG9yCiAgICB0aGlzLmNvbXBsZXRlID0gZmFsc2UKCiAgICB0aGlzLnJ4ID0gbnVsbAogICAgdGhpcy50eCA9IG51bGwKICAgIHRoaXMuaGFzaCA9IG51bGwKICB9CgogIGluaXRpYWxpc2UgKHByb2xvZ3VlLCByZW1vdGVTdGF0aWMpIHsKICAgIGlmICh0aGlzLnByb3RvY29sLmJ5dGVMZW5ndGggPD0gSEFTSExFTikgdGhpcy5kaWdlc3Quc2V0KHRoaXMucHJvdG9jb2wpCiAgICBlbHNlIHRoaXMubWl4SGFzaCh0aGlzLnByb3RvY29sKQoKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBiNGEuZnJvbSh0aGlzLmRpZ2VzdCkKCiAgICB0aGlzLm1peEhhc2gocHJvbG9ndWUpCgogICAgd2hpbGUgKCFBcnJheS5pc0FycmF5KHRoaXMuaGFuZHNoYWtlWzBdKSkgewogICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5oYW5kc2hha2Uuc2hpZnQoKQoKICAgICAgLy8gaGFuZHNoYWtlIHN0ZXBzIHNob3VsZCBiZSBhcyBhcnJheXMsIG9ubHkKICAgICAgLy8gcHJlc2hhcmUgdG9rZW5zIGFyZSBwcm92aWRlZCBvdGhlcndpc2UKICAgICAgYXNzZXJ0KG1lc3NhZ2UgPT09IFBSRVNIQVJFX1JTIHx8IG1lc3NhZ2UgPT09IFBSRVNIQVJFX0lTLAogICAgICAgICdVbmV4cGVjdGVkIHBhdHRlcm4nKQoKICAgICAgY29uc3QgdGFrZVJlbW90ZUtleSA9IHRoaXMuaW5pdGlhdG9yCiAgICAgICAgPyBtZXNzYWdlID09PSBQUkVTSEFSRV9SUwogICAgICAgIDogbWVzc2FnZSA9PT0gUFJFU0hBUkVfSVMKCiAgICAgIGlmICh0YWtlUmVtb3RlS2V5KSB0aGlzLnJzID0gcmVtb3RlU3RhdGljCgogICAgICBjb25zdCBrZXkgPSB0YWtlUmVtb3RlS2V5ID8gdGhpcy5ycyA6IHRoaXMucy5wdWJsaWNLZXkKICAgICAgYXNzZXJ0KGtleSAhPSBudWxsLCAnUmVtb3RlIHB1YmtleSByZXF1aXJlZCcpCgogICAgICB0aGlzLm1peEhhc2goa2V5KQogICAgfQogIH0KCiAgZmluYWwgKCkgewogICAgY29uc3QgW2sxLCBrMl0gPSB0aGlzLnNwbGl0KCkKCiAgICB0aGlzLnR4ID0gdGhpcy5pbml0aWF0b3IgPyBrMSA6IGsyCiAgICB0aGlzLnJ4ID0gdGhpcy5pbml0aWF0b3IgPyBrMiA6IGsxCgogICAgdGhpcy5jb21wbGV0ZSA9IHRydWUKICAgIHRoaXMuaGFzaCA9IHRoaXMuZ2V0SGFuZHNoYWtlSGFzaCgpCgogICAgdGhpcy5fY2xlYXIoKQogIH0KCiAgcmVjdiAoYnVmKSB7CiAgICBjb25zdCByID0gbmV3IFJlYWRlcihidWYpCgogICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHRoaXMuaGFuZHNoYWtlLnNoaWZ0KCkpIHsKICAgICAgc3dpdGNoIChwYXR0ZXJuKSB7CiAgICAgICAgY2FzZSBUT0tfUFNLIDoKICAgICAgICAgIHRoaXMubWl4S2V5QW5kSGFzaCh0aGlzLnBzaykKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX0UgOgogICAgICAgICAgdGhpcy5yZSA9IHIuc2hpZnQodGhpcy5jdXJ2ZS5QS0xFTikKICAgICAgICAgIHRoaXMubWl4SGFzaCh0aGlzLnJlKQogICAgICAgICAgaWYgKHRoaXMuaXNQc2tIYW5kc2hha2UpIHRoaXMubWl4S2V5Tm9ybWFsKHRoaXMucmUpCiAgICAgICAgICBicmVhawoKICAgICAgICBjYXNlIFRPS19TIDogewogICAgICAgICAgY29uc3Qga2xlbiA9IHRoaXMuaGFzS2V5ID8gdGhpcy5jdXJ2ZS5QS0xFTiArIDE2IDogdGhpcy5jdXJ2ZS5QS0xFTgogICAgICAgICAgdGhpcy5ycyA9IHRoaXMuZGVjcnlwdEFuZEhhc2goci5zaGlmdChrbGVuKSkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBjYXNlIFRPS19FRSA6CiAgICAgICAgY2FzZSBUT0tfRVMgOgogICAgICAgIGNhc2UgVE9LX1NFIDoKICAgICAgICBjYXNlIFRPS19TUyA6IHsKICAgICAgICAgIGNvbnN0IHVzZVN0YXRpYyA9IGtleVBhdHRlcm4ocGF0dGVybiwgdGhpcy5pbml0aWF0b3IpCgogICAgICAgICAgY29uc3QgbG9jYWxLZXkgPSB1c2VTdGF0aWMubG9jYWwgPyB0aGlzLnMgOiB0aGlzLmUKICAgICAgICAgIGNvbnN0IHJlbW90ZUtleSA9IHVzZVN0YXRpYy5yZW1vdGUgPyB0aGlzLnJzIDogdGhpcy5yZQoKICAgICAgICAgIHRoaXMubWl4S2V5KHJlbW90ZUtleSwgbG9jYWxLZXkpCiAgICAgICAgICBicmVhawogICAgICAgIH0KCiAgICAgICAgZGVmYXVsdCA6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgbWVzc2FnZScpCiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5kZWNyeXB0QW5kSGFzaChyLmVuZCgpKQoKICAgIGlmICghdGhpcy5oYW5kc2hha2UubGVuZ3RoKSB0aGlzLmZpbmFsKCkKICAgIHJldHVybiBwYXlsb2FkCiAgfQoKICBzZW5kIChwYXlsb2FkID0gYjRhLmFsbG9jKDApKSB7CiAgICBjb25zdCB3ID0gbmV3IFdyaXRlcigpCgogICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHRoaXMuaGFuZHNoYWtlLnNoaWZ0KCkpIHsKICAgICAgc3dpdGNoIChwYXR0ZXJuKSB7CiAgICAgICAgY2FzZSBUT0tfUFNLIDoKICAgICAgICAgIHRoaXMubWl4S2V5QW5kSGFzaCh0aGlzLnBzaykKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX0UgOgogICAgICAgICAgaWYgKHRoaXMuZSA9PT0gbnVsbCkgdGhpcy5lID0gdGhpcy5jdXJ2ZS5nZW5lcmF0ZUtleVBhaXIoKQogICAgICAgICAgdGhpcy5taXhIYXNoKHRoaXMuZS5wdWJsaWNLZXkpCiAgICAgICAgICBpZiAodGhpcy5pc1Bza0hhbmRzaGFrZSkgdGhpcy5taXhLZXlOb3JtYWwodGhpcy5lLnB1YmxpY0tleSkKICAgICAgICAgIHcucHVzaCh0aGlzLmUucHVibGljS2V5KQogICAgICAgICAgYnJlYWsKCiAgICAgICAgY2FzZSBUT0tfUyA6CiAgICAgICAgICB3LnB1c2godGhpcy5lbmNyeXB0QW5kSGFzaCh0aGlzLnMucHVibGljS2V5KSkKICAgICAgICAgIGJyZWFrCgogICAgICAgIGNhc2UgVE9LX0VTIDoKICAgICAgICBjYXNlIFRPS19TRSA6CiAgICAgICAgY2FzZSBUT0tfRUUgOgogICAgICAgIGNhc2UgVE9LX1NTIDogewogICAgICAgICAgY29uc3QgdXNlU3RhdGljID0ga2V5UGF0dGVybihwYXR0ZXJuLCB0aGlzLmluaXRpYXRvcikKCiAgICAgICAgICBjb25zdCBsb2NhbEtleSA9IHVzZVN0YXRpYy5sb2NhbCA/IHRoaXMucyA6IHRoaXMuZQogICAgICAgICAgY29uc3QgcmVtb3RlS2V5ID0gdXNlU3RhdGljLnJlbW90ZSA/IHRoaXMucnMgOiB0aGlzLnJlCgogICAgICAgICAgdGhpcy5taXhLZXkocmVtb3RlS2V5LCBsb2NhbEtleSkKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQoKICAgICAgICBkZWZhdWx0IDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBtZXNzYWdlJykKICAgICAgfQogICAgfQoKICAgIHcucHVzaCh0aGlzLmVuY3J5cHRBbmRIYXNoKHBheWxvYWQpKQogICAgY29uc3QgcmVzcG9uc2UgPSB3LmVuZCgpCgogICAgaWYgKCF0aGlzLmhhbmRzaGFrZS5sZW5ndGgpIHRoaXMuZmluYWwoKQogICAgcmV0dXJuIHJlc3BvbnNlCiAgfQoKICBfY2xlYXIgKCkgewogICAgc3VwZXIuX2NsZWFyKCkKCiAgICB0aGlzLmUuc2VjcmV0S2V5LmZpbGwoMCkKICAgIHRoaXMuZS5wdWJsaWNLZXkuZmlsbCgwKQoKICAgIHRoaXMucmUuZmlsbCgwKQoKICAgIHRoaXMuZSA9IG51bGwKICAgIHRoaXMucmUgPSBudWxsCiAgfQp9CgpmdW5jdGlvbiBrZXlQYXR0ZXJuIChwYXR0ZXJuLCBpbml0aWF0b3IpIHsKICBjb25zdCByZXQgPSB7CiAgICBsb2NhbDogZmFsc2UsCiAgICByZW1vdGU6IGZhbHNlCiAgfQoKICBzd2l0Y2ggKHBhdHRlcm4pIHsKICAgIGNhc2UgVE9LX0VFOgogICAgICByZXR1cm4gcmV0CgogICAgY2FzZSBUT0tfRVM6CiAgICAgIHJldC5sb2NhbCBePSAhaW5pdGlhdG9yCiAgICAgIHJldC5yZW1vdGUgXj0gaW5pdGlhdG9yCiAgICAgIHJldHVybiByZXQKCiAgICBjYXNlIFRPS19TRToKICAgICAgcmV0LmxvY2FsIF49IGluaXRpYXRvcgogICAgICByZXQucmVtb3RlIF49ICFpbml0aWF0b3IKICAgICAgcmV0dXJuIHJldAoKICAgIGNhc2UgVE9LX1NTOgogICAgICByZXQubG9jYWwgXj0gMQogICAgICByZXQucmVtb3RlIF49IDEKICAgICAgcmV0dXJuIHJldAogIH0KfQoKZnVuY3Rpb24gaGFzUHNrVG9rZW4gKGhhbmRzaGFrZSkgewogIHJldHVybiBoYW5kc2hha2Uuc29tZSh4ID0+IHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHgpICYmIHguaW5kZXhPZihUT0tfUFNLKSAhPT0gLTEKICB9KQp9CnsKICAibmFtZSI6ICJub2lzZS1oYW5kc2hha2UiLAogICJ2ZXJzaW9uIjogIjQuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiTm9pc2UgcHJvdG9jb2wgaGFuZHNoYWtlIiwKICAibWFpbiI6ICJub2lzZS5qcyIsCiAgImZpbGVzIjogWwogICAgIiouanMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC8qLmpzIgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9ub2lzZS1oYW5kc2hha2UuZ2l0IgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMS4wIiwKICAgICJuYW5vYXNzZXJ0IjogIl4yLjAuMCIsCiAgICAic29kaXVtLXVuaXZlcnNhbCI6ICJeNS4wLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMy4yIiwKICAgICJub2lzZS1wcm90b2NvbCI6ICJjaG0tZGllZGVyaWNocy9ub2lzZS1wcm90b2NvbC5naXQjeHgtZXBoZW1lcmFsLWtleSIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIKICB9Cn0KY29uc3Qgc29kaXVtID0gcmVxdWlyZSgnc29kaXVtLXVuaXZlcnNhbCcpCmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ25hbm9hc3NlcnQnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBDaXBoZXJTdGF0ZSA9IHJlcXVpcmUoJy4vY2lwaGVyJykKY29uc3QgY3VydmUgPSByZXF1aXJlKCcuL2RoJykKY29uc3QgeyBIQVNITEVOLCBoa2RmIH0gPSByZXF1aXJlKCcuL2hrZGYnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTeW1tZXRyaWNTdGF0ZSBleHRlbmRzIENpcGhlclN0YXRlIHsKICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5jdXJ2ZSA9IG9wdHMuY3VydmUgfHwgY3VydmUKICAgIHRoaXMuZGlnZXN0ID0gYjRhLmFsbG9jKEhBU0hMRU4pCiAgICB0aGlzLmNoYWluaW5nS2V5ID0gbnVsbAogICAgdGhpcy5vZmZzZXQgPSAwCgogICAgdGhpcy5ESF9BTEcgPSB0aGlzLmN1cnZlLkFMRwogIH0KCiAgbWl4SGFzaCAoZGF0YSkgewogICAgYWNjdW11bGF0ZURpZ2VzdCh0aGlzLmRpZ2VzdCwgZGF0YSkKICB9CgogIG1peEtleUFuZEhhc2ggKGtleSkgewogICAgY29uc3QgW2NrLCB0ZW1wSCwgdGVtcEtdID0gaGtkZih0aGlzLmNoYWluaW5nS2V5LCBrZXksICcnLCAzICogSEFTSExFTikKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBjawogICAgdGhpcy5taXhIYXNoKHRlbXBIKQogICAgdGhpcy5pbml0aWFsaXNlS2V5KHRlbXBLLnN1YmFycmF5KDAsIDMyKSkKICB9CgogIG1peEtleU5vcm1hbCAoa2V5KSB7CiAgICBjb25zdCBbY2ssIHRlbXBLXSA9IGhrZGYodGhpcy5jaGFpbmluZ0tleSwga2V5KQogICAgdGhpcy5jaGFpbmluZ0tleSA9IGNrCiAgICB0aGlzLmluaXRpYWxpc2VLZXkodGVtcEsuc3ViYXJyYXkoMCwgMzIpKQogIH0KCiAgbWl4S2V5IChyZW1vdGVLZXksIGxvY2FsS2V5KSB7CiAgICBjb25zdCBkaCA9IHRoaXMuY3VydmUuZGgocmVtb3RlS2V5LCBsb2NhbEtleSkKICAgIGNvbnN0IGhrZGZSZXN1bHQgPSBoa2RmKHRoaXMuY2hhaW5pbmdLZXksIGRoKQogICAgdGhpcy5jaGFpbmluZ0tleSA9IGhrZGZSZXN1bHRbMF0KICAgIHRoaXMuaW5pdGlhbGlzZUtleShoa2RmUmVzdWx0WzFdLnN1YmFycmF5KDAsIDMyKSkKICB9CgogIGVuY3J5cHRBbmRIYXNoIChwbGFpbnRleHQpIHsKICAgIGNvbnN0IGNpcGhlcnRleHQgPSB0aGlzLmVuY3J5cHQocGxhaW50ZXh0LCB0aGlzLmRpZ2VzdCkKICAgIGFjY3VtdWxhdGVEaWdlc3QodGhpcy5kaWdlc3QsIGNpcGhlcnRleHQpCiAgICByZXR1cm4gY2lwaGVydGV4dAogIH0KCiAgZGVjcnlwdEFuZEhhc2ggKGNpcGhlcnRleHQpIHsKICAgIGNvbnN0IHBsYWludGV4dCA9IHRoaXMuZGVjcnlwdChjaXBoZXJ0ZXh0LCB0aGlzLmRpZ2VzdCkKICAgIGFjY3VtdWxhdGVEaWdlc3QodGhpcy5kaWdlc3QsIGNpcGhlcnRleHQpCiAgICByZXR1cm4gcGxhaW50ZXh0CiAgfQoKICBnZXRIYW5kc2hha2VIYXNoIChvdXQpIHsKICAgIGlmICghb3V0KSByZXR1cm4gdGhpcy5nZXRIYW5kc2hha2VIYXNoKGI0YS5hbGxvYyhIQVNITEVOKSkKICAgIGFzc2VydChvdXQuYnl0ZUxlbmd0aCA9PT0gSEFTSExFTiwgYG91dHB1dCBtdXN0IGJlICR7SEFTSExFTn0gYnl0ZXNgKQoKICAgIG91dC5zZXQodGhpcy5kaWdlc3QpCiAgICByZXR1cm4gb3V0CiAgfQoKICBzcGxpdCAoKSB7CiAgICBjb25zdCByZXMgPSBoa2RmKHRoaXMuY2hhaW5pbmdLZXksIGI0YS5hbGxvYygwKSkKICAgIHJldHVybiByZXMubWFwKGsgPT4gay5zdWJhcnJheSgwLCAzMikpCiAgfQoKICBfY2xlYXIgKCkgewogICAgc3VwZXIuX2NsZWFyKCkKCiAgICBzb2RpdW0uc29kaXVtX21lbXplcm8odGhpcy5kaWdlc3QpCiAgICBzb2RpdW0uc29kaXVtX21lbXplcm8odGhpcy5jaGFpbmluZ0tleSkKCiAgICB0aGlzLmRpZ2VzdCA9IG51bGwKICAgIHRoaXMuY2hhaW5pbmdLZXkgPSBudWxsCiAgICB0aGlzLm9mZnNldCA9IG51bGwKCiAgICB0aGlzLmN1cnZlID0gbnVsbAogIH0KCiAgc3RhdGljIGdldCBhbGcgKCkgewogICAgcmV0dXJuIENpcGhlclN0YXRlLmFsZyArICdfQkxBS0UyYicKICB9Cn0KCmZ1bmN0aW9uIGFjY3VtdWxhdGVEaWdlc3QgKGRpZ2VzdCwgaW5wdXQpIHsKICBjb25zdCB0b0hhc2ggPSBiNGEuY29uY2F0KFtkaWdlc3QsIGlucHV0XSkKICBzb2RpdW0uY3J5cHRvX2dlbmVyaWNoYXNoKGRpZ2VzdCwgdG9IYXNoKQp9CnZhciB2YXJpbnQgPSByZXF1aXJlKCd2YXJpbnQnKQp2YXIgc3ZhcmludCA9IHJlcXVpcmUoJ3NpZ25lZC12YXJpbnQnKQp2YXIgYjRhID0gcmVxdWlyZSgnYjRhJykKCmV4cG9ydHMubWFrZSA9IGVuY29kZXIKCmV4cG9ydHMubmFtZSA9IGZ1bmN0aW9uIChlbmMpIHsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGV4cG9ydHMpCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoZXhwb3J0c1trZXlzW2ldXSA9PT0gZW5jKSByZXR1cm4ga2V5c1tpXQogIH0KICByZXR1cm4gbnVsbAp9CgpleHBvcnRzLnNraXAgPSBmdW5jdGlvbiAodHlwZSwgYnVmZmVyLCBvZmZzZXQpIHsKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgMDoKICAgICAgdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgICAgcmV0dXJuIG9mZnNldCArIHZhcmludC5kZWNvZGUuYnl0ZXMKCiAgICBjYXNlIDE6CiAgICAgIHJldHVybiBvZmZzZXQgKyA4CgogICAgY2FzZSAyOgogICAgICB2YXIgbGVuID0gdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgICAgcmV0dXJuIG9mZnNldCArIHZhcmludC5kZWNvZGUuYnl0ZXMgKyBsZW4KCiAgICBjYXNlIDM6CiAgICBjYXNlIDQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignR3JvdXBzIGFyZSBub3Qgc3VwcG9ydGVkJykKCiAgICBjYXNlIDU6CiAgICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQoKICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gd2lyZSB0eXBlOiAnICsgdHlwZSkKfQoKZXhwb3J0cy5ieXRlcyA9IGVuY29kZXIoMiwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBsZW4gPSBidWZmZXJMZW5ndGgodmFsKQoKICAgIHZhcmludC5lbmNvZGUobGVuLCBidWZmZXIsIG9mZnNldCkKICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCgogICAgaWYgKGI0YS5pc0J1ZmZlcih2YWwpKSBiNGEuY29weSh2YWwsIGJ1ZmZlciwgb2Zmc2V0KQogICAgZWxzZSBiNGEud3JpdGUoYnVmZmVyLCB2YWwsIG9mZnNldCwgbGVuKQogICAgb2Zmc2V0ICs9IGxlbgoKICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAoKICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKCiAgICB2YXIgdmFsID0gYnVmZmVyLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgbGVuKQogICAgb2Zmc2V0ICs9IHZhbC5sZW5ndGgKCiAgICBkZWNvZGUuYnl0ZXMgPSBvZmZzZXQgLSBvbGRPZmZzZXQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICh2YWwpIHsKICAgIHZhciBsZW4gPSBidWZmZXJMZW5ndGgodmFsKQogICAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pICsgbGVuCiAgfQopCgpleHBvcnRzLnN0cmluZyA9IGVuY29kZXIoMiwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKICAgIHZhciBsZW4gPSBiNGEuYnl0ZUxlbmd0aCh2YWwpCgogICAgdmFyaW50LmVuY29kZShsZW4sIGJ1ZmZlciwgb2Zmc2V0LCAndXRmLTgnKQogICAgb2Zmc2V0ICs9IHZhcmludC5lbmNvZGUuYnl0ZXMKCiAgICBiNGEud3JpdGUoYnVmZmVyLCB2YWwsIG9mZnNldCwgbGVuKQogICAgb2Zmc2V0ICs9IGxlbgoKICAgIGVuY29kZS5ieXRlcyA9IG9mZnNldCAtIG9sZE9mZnNldAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIG9sZE9mZnNldCA9IG9mZnNldAoKICAgIHZhciBsZW4gPSB2YXJpbnQuZGVjb2RlKGJ1ZmZlciwgb2Zmc2V0KQogICAgb2Zmc2V0ICs9IHZhcmludC5kZWNvZGUuYnl0ZXMKCiAgICB2YXIgdmFsID0gYjRhLnRvU3RyaW5nKGJ1ZmZlciwgJ3V0Zi04Jywgb2Zmc2V0LCBvZmZzZXQgKyBsZW4pCiAgICBvZmZzZXQgKz0gbGVuCgogICAgZGVjb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAodmFsKSB7CiAgICB2YXIgbGVuID0gYjRhLmJ5dGVMZW5ndGgodmFsKQogICAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aChsZW4pICsgbGVuCiAgfQopCgpleHBvcnRzLmJvb2wgPSBlbmNvZGVyKDAsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBidWZmZXJbb2Zmc2V0XSA9IHZhbCA/IDEgOiAwCiAgICBlbmNvZGUuYnl0ZXMgPSAxCiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgYm9vbCA9IGJ1ZmZlcltvZmZzZXRdID4gMAogICAgZGVjb2RlLmJ5dGVzID0gMQogICAgcmV0dXJuIGJvb2wKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiAxCiAgfQopCgpleHBvcnRzLmludDMyID0gZW5jb2RlcigwLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgdmFyaW50LmVuY29kZSh2YWwgPCAwID8gdmFsICsgNDI5NDk2NzI5NiA6IHZhbCwgYnVmZmVyLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gdmFyaW50LmRlY29kZShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IHZhcmludC5kZWNvZGUuYnl0ZXMKICAgIHJldHVybiB2YWwgPiAyMTQ3NDgzNjQ3ID8gdmFsIC0gNDI5NDk2NzI5NiA6IHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKHZhbCkgewogICAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aCh2YWwgPCAwID8gdmFsICsgNDI5NDk2NzI5NiA6IHZhbCkKICB9CikKCmV4cG9ydHMuaW50NjQgPSBlbmNvZGVyKDAsCiAgZnVuY3Rpb24gZW5jb2RlICh2YWwsIGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBpZiAodmFsIDwgMCkgewogICAgICB2YXIgbGFzdCA9IG9mZnNldCArIDkKICAgICAgdmFyaW50LmVuY29kZSh2YWwgKiAtMSwgYnVmZmVyLCBvZmZzZXQpCiAgICAgIG9mZnNldCArPSB2YXJpbnQuZW5jb2RlLmJ5dGVzIC0gMQogICAgICBidWZmZXJbb2Zmc2V0XSA9IGJ1ZmZlcltvZmZzZXRdIHwgMHg4MAogICAgICB3aGlsZSAob2Zmc2V0IDwgbGFzdCAtIDEpIHsKICAgICAgICBvZmZzZXQrKwogICAgICAgIGJ1ZmZlcltvZmZzZXRdID0gMHhmZgogICAgICB9CiAgICAgIGJ1ZmZlcltsYXN0XSA9IDB4MDEKICAgICAgZW5jb2RlLmJ5dGVzID0gMTAKICAgIH0gZWxzZSB7CiAgICAgIHZhcmludC5lbmNvZGUodmFsLCBidWZmZXIsIG9mZnNldCkKICAgICAgZW5jb2RlLmJ5dGVzID0gdmFyaW50LmVuY29kZS5ieXRlcwogICAgfQogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IHZhcmludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpCiAgICBpZiAodmFsID49IE1hdGgucG93KDIsIDYzKSkgewogICAgICB2YXIgbGltaXQgPSA5CiAgICAgIHdoaWxlIChidWZmZXJbb2Zmc2V0ICsgbGltaXQgLSAxXSA9PT0gMHhmZikgbGltaXQtLQogICAgICBsaW1pdCA9IGxpbWl0IHx8IDkKICAgICAgdmFyIHN1YnNldCA9IGI0YS5hbGxvY1Vuc2FmZShsaW1pdCkKICAgICAgYjRhLmNvcHkoYnVmZmVyLCBzdWJzZXQsIDAsIG9mZnNldCwgb2Zmc2V0ICsgbGltaXQpCiAgICAgIHN1YnNldFtsaW1pdCAtIDFdID0gc3Vic2V0W2xpbWl0IC0gMV0gJiAweDdmCiAgICAgIHZhbCA9IC0xICogdmFyaW50LmRlY29kZShzdWJzZXQsIDApCiAgICAgIGRlY29kZS5ieXRlcyA9IDEwCiAgICB9IGVsc2UgewogICAgICBkZWNvZGUuYnl0ZXMgPSB2YXJpbnQuZGVjb2RlLmJ5dGVzCiAgICB9CiAgICByZXR1cm4gdmFsCiAgfSwKICBmdW5jdGlvbiBlbmNvZGluZ0xlbmd0aCAodmFsKSB7CiAgICByZXR1cm4gdmFsIDwgMCA/IDEwIDogdmFyaW50LmVuY29kaW5nTGVuZ3RoKHZhbCkKICB9CikKCmV4cG9ydHMuc2ludDMyID0KZXhwb3J0cy5zaW50NjQgPSBlbmNvZGVyKDAsCiAgc3ZhcmludC5lbmNvZGUsCiAgc3ZhcmludC5kZWNvZGUsCiAgc3ZhcmludC5lbmNvZGluZ0xlbmd0aAopCgpleHBvcnRzLnVpbnQzMiA9CmV4cG9ydHMudWludDY0ID0KZXhwb3J0cy5lbnVtID0KZXhwb3J0cy52YXJpbnQgPSBlbmNvZGVyKDAsCiAgdmFyaW50LmVuY29kZSwKICB2YXJpbnQuZGVjb2RlLAogIHZhcmludC5lbmNvZGluZ0xlbmd0aAopCgovLyB3ZSBjYW5ub3QgcmVwcmVzZW50IHRoZXNlIGluIGphdmFzY3JpcHQgc28gd2UganVzdCB1c2UgYnVmZmVycwpleHBvcnRzLmZpeGVkNjQgPQpleHBvcnRzLnNmaXhlZDY0ID0gZW5jb2RlcigxLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLmNvcHkodmFsLCBidWZmZXIsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IDgKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSBidWZmZXIuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA4KQogICAgZGVjb2RlLmJ5dGVzID0gOAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDgKICB9CikKCmV4cG9ydHMuZG91YmxlID0gZW5jb2RlcigxLAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLndyaXRlRG91YmxlTEUoYnVmZmVyLCB2YWwsIG9mZnNldCkKICAgIGVuY29kZS5ieXRlcyA9IDgKICAgIHJldHVybiBidWZmZXIKICB9LAogIGZ1bmN0aW9uIGRlY29kZSAoYnVmZmVyLCBvZmZzZXQpIHsKICAgIHZhciB2YWwgPSBiNGEucmVhZERvdWJsZUxFKGJ1ZmZlciwgb2Zmc2V0KQogICAgZGVjb2RlLmJ5dGVzID0gOAogICAgcmV0dXJuIHZhbAogIH0sCiAgZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKCkgewogICAgcmV0dXJuIDgKICB9CikKCmV4cG9ydHMuZml4ZWQzMiA9IGVuY29kZXIoNSwKICBmdW5jdGlvbiBlbmNvZGUgKHZhbCwgYnVmZmVyLCBvZmZzZXQpIHsKICAgIGI0YS53cml0ZVVJbnQzMkxFKGJ1ZmZlciwgdmFsLCBvZmZzZXQpCiAgICBlbmNvZGUuYnl0ZXMgPSA0CiAgICByZXR1cm4gYnVmZmVyCiAgfSwKICBmdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICB2YXIgdmFsID0gYjRhLnJlYWRVSW50MzJMRShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA0CiAgfQopCgpleHBvcnRzLnNmaXhlZDMyID0gZW5jb2Rlcig1LAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLndyaXRlSW50MzJMRShidWZmZXIsIHZhbCwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IGI0YS5yZWFkSW50MzJMRShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA0CiAgfQopCgpleHBvcnRzLmZsb2F0ID0gZW5jb2Rlcig1LAogIGZ1bmN0aW9uIGVuY29kZSAodmFsLCBidWZmZXIsIG9mZnNldCkgewogICAgYjRhLndyaXRlRmxvYXRMRShidWZmZXIsIHZhbCwgb2Zmc2V0KQogICAgZW5jb2RlLmJ5dGVzID0gNAogICAgcmV0dXJuIGJ1ZmZlcgogIH0sCiAgZnVuY3Rpb24gZGVjb2RlIChidWZmZXIsIG9mZnNldCkgewogICAgdmFyIHZhbCA9IGI0YS5yZWFkRmxvYXRMRShidWZmZXIsIG9mZnNldCkKICAgIGRlY29kZS5ieXRlcyA9IDQKICAgIHJldHVybiB2YWwKICB9LAogIGZ1bmN0aW9uIGVuY29kaW5nTGVuZ3RoICgpIHsKICAgIHJldHVybiA0CiAgfQopCgpmdW5jdGlvbiBlbmNvZGVyICh0eXBlLCBlbmNvZGUsIGRlY29kZSwgZW5jb2RpbmdMZW5ndGgpIHsKICBlbmNvZGUuYnl0ZXMgPSBkZWNvZGUuYnl0ZXMgPSAwCgogIHJldHVybiB7CiAgICB0eXBlOiB0eXBlLAogICAgZW5jb2RlOiBlbmNvZGUsCiAgICBkZWNvZGU6IGRlY29kZSwKICAgIGVuY29kaW5nTGVuZ3RoOiBlbmNvZGluZ0xlbmd0aAogIH0KfQoKZnVuY3Rpb24gYnVmZmVyTGVuZ3RoICh2YWwpIHsKICByZXR1cm4gYjRhLmlzQnVmZmVyKHZhbCkgPyB2YWwubGVuZ3RoIDogYjRhLmJ5dGVMZW5ndGgodmFsKQp9CnsKICAibmFtZSI6ICJwcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncyIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJCYXNlIGVuY29kaW5ncyBmb3IgcHJvdG9jb2wtYnVmZmVycyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIsCiAgICAic2lnbmVkLXZhcmludCI6ICJeMi4wLjEiLAogICAgInZhcmludCI6ICI1LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE0LjMuNCIsCiAgICAidGFwZSI6ICJeNS4wLjEiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b2NvbC1idWZmZXJzLWVuY29kaW5ncy5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHJvdG9jb2wtYnVmZmVycy1lbmNvZGluZ3MiCn0KY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnaHlwZXJjb3JlLWNyeXB0bycpCmNvbnN0IFByb3RvbXV4ID0gcmVxdWlyZSgncHJvdG9tdXgnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzY2hlbWEgPSByZXF1aXJlKCcuL3NwZWMvaHlwZXJzY2hlbWEnKQoKY29uc3QgW05TX0lOSVRBVE9SLCBOU19SRVNQT05ERVJdID0gY3J5cHRvLm5hbWVzcGFjZSgnd2FrZXVwJywgMikKCmNvbnN0IEhhbmRzaGFrZSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQHdha2V1cC9oYW5kc2hha2UnKQpjb25zdCBBbm5vdW5jZSA9IHNjaGVtYS5nZXRFbmNvZGluZygnQHdha2V1cC9hbm5vdW5jZScpCmNvbnN0IExvb2t1cCA9IHNjaGVtYS5nZXRFbmNvZGluZygnQHdha2V1cC9sb29rdXAnKQpjb25zdCBJbmZvID0gc2NoZW1hLmdldEVuY29kaW5nKCdAd2FrZXVwL2luZm8nKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBXYWtldXBTd2FybSB7CiAgY29uc3RydWN0b3Iob253YWtldXAgPSBub29wLCB7IGdjVGlja1RpbWUgPSAyMDAwIH0gPSB7fSkgewogICAgdGhpcy5nY1RpY2tUaW1lID0gZ2NUaWNrVGltZQoKICAgIHRoaXMudG9waWNzID0gbmV3IE1hcCgpCiAgICB0aGlzLnRvcGljc0dDID0gbmV3IFNldCgpCiAgICB0aGlzLm11eGVycyA9IG5ldyBTZXQoKQogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgc2Vzc2lvbnNPcGVuZWQ6IDAsCiAgICAgIHNlc3Npb25zQ2xvc2VkOiAwLAogICAgICB0b3BpY3NBZGRlZDogMCwKICAgICAgdG9waWNzR2NkOiAwLAogICAgICBwZWVyc0FkZGVkOiAwLAogICAgICBwZWVyc1JlbW92ZWQ6IDAsCiAgICAgIHdpcmVBbm5vdW5jZTogeyByeDogMCwgdHg6IDAgfSwKICAgICAgd2lyZUxvb2t1cDogeyByeDogMCwgdHg6IDAgfSwKICAgICAgd2lyZUluZm86IHsgcng6IDAsIHR4OiAwIH0KICAgIH0KCiAgICB0aGlzLm9ud2FrZXVwID0gb253YWtldXAKCiAgICB0aGlzLl9nY0ludGVydmFsID0gbnVsbAogICAgdGhpcy5fZ2NCb3VuZCA9IHRoaXMuX2djLmJpbmQodGhpcykKICB9CgogIHNlc3Npb24oY2FwYWJpbGl0eSwgaGFuZGxlcnMgPSB7fSkgewogICAgY29uc3QgaWQgPSBoYW5kbGVycy5kaXNjb3ZlcnlLZXkgfHwgY3J5cHRvLmRpc2NvdmVyeUtleShjYXBhYmlsaXR5KQogICAgY29uc3QgYWN0aXZlID0gaGFuZGxlcnMuYWN0aXZlICE9PSBmYWxzZQogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKCiAgICBsZXQgdyA9IHRoaXMudG9waWNzLmdldChoZXgpCgogICAgaWYgKHcpIHJldHVybiB3LmFkZFNlc3Npb24oaGFuZGxlcnMpCgogICAgdyA9IG5ldyBXYWtldXBUb3BpYyh0aGlzLCBpZCwgY2FwYWJpbGl0eSwgYWN0aXZlKQoKICAgIHRoaXMudG9waWNzLnNldChoZXgsIHcpCgogICAgZm9yIChjb25zdCBtdXhlciBvZiB0aGlzLm11eGVycykgewogICAgICB3Ll9vbm9wZW4obXV4ZXIsIHRydWUpCiAgICB9CgogICAgcmV0dXJuIHcuYWRkU2Vzc2lvbihoYW5kbGVycykKICB9CgogIGdldFNlc3Npb25zKGNhcGFiaWxpdHksIGhhbmRsZXJzID0ge30pIHsKICAgIGNvbnN0IGlkID0gaGFuZGxlcnMuZGlzY292ZXJ5S2V5IHx8IGNyeXB0by5kaXNjb3ZlcnlLZXkoY2FwYWJpbGl0eSkKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpCiAgICBjb25zdCB3ID0gdGhpcy50b3BpY3MuZ2V0KGhleCkKICAgIHJldHVybiB3ID8gdy5zZXNzaW9ucyA6IFtdCiAgfQoKICBoYXNTdHJlYW0oc3RyZWFtLCBjYXBhYmlsaXR5LCBoYW5kbGVycyA9IHt9KSB7CiAgICBpZiAoIWNhcGFiaWxpdHkpIHsKICAgICAgY29uc3Qgbm9pc2VTdHJlYW0gPSBzdHJlYW0ubm9pc2VTdHJlYW0gfHwgc3RyZWFtCiAgICAgIHJldHVybiB0aGlzLm11eGVycy5oYXMoZ2V0TXV4ZXIobm9pc2VTdHJlYW0pKQogICAgfQoKICAgIGNvbnN0IGlkID0gaGFuZGxlcnMuZGlzY292ZXJ5S2V5IHx8IGNyeXB0by5kaXNjb3ZlcnlLZXkoY2FwYWJpbGl0eSkKICAgIGNvbnN0IGhleCA9IGI0YS50b1N0cmluZyhpZCwgJ2hleCcpCiAgICBjb25zdCB0ID0gdGhpcy50b3BpY3MuZ2V0KGhleCkKCiAgICByZXR1cm4gdCA/IHQucGVlcnNCeVN0cmVhbS5oYXMoc3RyZWFtKSA6IGZhbHNlCiAgfQoKICBhZGRTdHJlYW0oc3RyZWFtKSB7CiAgICBjb25zdCBub2lzZVN0cmVhbSA9IHN0cmVhbS5ub2lzZVN0cmVhbSB8fCBzdHJlYW0KCiAgICBpZiAoIW5vaXNlU3RyZWFtLmNvbm5lY3RlZCkgewogICAgICBub2lzZVN0cmVhbS5vbmNlKCdvcGVuJywgdGhpcy5hZGRTdHJlYW0uYmluZCh0aGlzLCBub2lzZVN0cmVhbSkpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IG11eGVyID0gZ2V0TXV4ZXIobm9pc2VTdHJlYW0pCiAgICBtdXhlci5wYWlyKHsgcHJvdG9jb2w6ICd3YWtldXAnIH0sIChpZCkgPT4gdGhpcy5fb25wYWlyKGlkLCBtdXhlcikpCgogICAgdGhpcy5tdXhlcnMuYWRkKG11eGVyKQogICAgbm9pc2VTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4gdGhpcy5tdXhlcnMuZGVsZXRlKG11eGVyKSkKCiAgICBmb3IgKGNvbnN0IHcgb2YgdGhpcy50b3BpY3MudmFsdWVzKCkpIHsKICAgICAgaWYgKCF3LmlzQWN0aXZlKSBjb250aW51ZQogICAgICB3Ll9vbm9wZW4obXV4ZXIsIHRydWUpCiAgICB9CiAgfQoKICBfb25BY3RpdmUodykgewogICAgZm9yIChjb25zdCBtIG9mIHRoaXMubXV4ZXJzKSB7CiAgICAgIHcuX29ub3BlbihtLCBmYWxzZSkKICAgIH0KICB9CgogIF9hZGRHQyh0b3BpYykgewogICAgaWYgKHRvcGljLmRlc3Ryb3llZCkgcmV0dXJuCiAgICB0aGlzLnRvcGljc0dDLmFkZCh0b3BpYykKICAgIGlmICh0aGlzLl9nY0ludGVydmFsID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9nY0JvdW5kLCB0aGlzLmdjVGlja1RpbWUpCiAgICB9CiAgfQoKICBfcmVtb3ZlR0ModG9waWMpIHsKICAgIHRoaXMudG9waWNzR0MuZGVsZXRlKHRvcGljKQogICAgaWYgKHRoaXMudG9waWNzR0Muc2l6ZSA9PT0gMCAmJiB0aGlzLl9nY0ludGVydmFsKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZ2NJbnRlcnZhbCkKICAgICAgdGhpcy5fZ2NJbnRlcnZhbCA9IG51bGwKICAgIH0KICB9CgogIF9nYygpIHsKICAgIGNvbnN0IGRlc3Ryb3kgPSBbXQogICAgZm9yIChjb25zdCB3IG9mIHRoaXMudG9waWNzR0MpIHsKICAgICAgdy5pZGxlVGlja3MrKwogICAgICBpZiAody5pZGxlVGlja3MgPj0gNSkgZGVzdHJveS5wdXNoKHcpCiAgICB9CiAgICBmb3IgKGNvbnN0IHcgb2YgZGVzdHJveSkgdy50ZWFyZG93bigpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2djSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGhpcy5fZ2NJbnRlcnZhbCkKICAgIHRoaXMuX2djSW50ZXJ2YWwgPSBudWxsCgogICAgZm9yIChjb25zdCB3IG9mIHRoaXMudG9waWNzLnZhbHVlcygpKSB3LnRlYXJkb3duKCkKICB9CgogIGFzeW5jIF9vbnBhaXIoaWQsIHN0cmVhbSkgewogICAgY29uc3QgaGV4ID0gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykKICAgIGNvbnN0IHcgPSB0aGlzLnRvcGljcy5nZXQoaGV4KQogICAgaWYgKCF3IHx8ICF3LnNlc3Npb25zLmxlbmd0aCkgcmV0dXJuIHRoaXMub253YWtldXAoaWQsIHN0cmVhbSkKICAgIHcuX29ub3BlbihnZXRNdXhlcihzdHJlYW0pLCBmYWxzZSkKICB9CgogIHJlZ2lzdGVyTWV0cmljcyhwcm9tQ2xpZW50KSB7CiAgICBjb25zdCBzZWxmID0gdGhpcwogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3Nlc3Npb25zX29wZW5lZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHNlc3Npb25zIG9wZW5lZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMuc2Vzc2lvbnNPcGVuZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3Nlc3Npb25zX2Nsb3NlZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHNlc3Npb25zIGNsb3NlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMuc2Vzc2lvbnNDbG9zZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3RvcGljc19hZGRlZCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHRvcGljcyBhZGRlZCB0byBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMudG9waWNzQWRkZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3RvcGljc19nY2QnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB0b3BpY3MgdGhhdCBnb3QgZ2FyYmFnZSBjb2xsZWN0ZWQgYnkgcHJvdG9tdXggd2FrZXVwJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnRvcGljc0djZCkKICAgICAgfQogICAgfSkKCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfcGVlcnNfYWRkZWQnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiBwZWVycyBhZGRlZCBieSBwcm90b211eCB3YWtldXAsIGFjcm9zcyBhbGwgdG9waWNzJywKICAgICAgY29sbGVjdCgpIHsKICAgICAgICB0aGlzLnNldChzZWxmLnN0YXRzLnBlZXJzQWRkZWQpCiAgICAgIH0KICAgIH0pCgogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3BlZXJzX3JlbW92ZWQnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiBwZWVycyByZW1vdmVkIGJ5IHByb3RvbXV4IHdha2V1cCwgYWNyb3NzIGFsbCB0b3BpY3MnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMucGVlcnNSZW1vdmVkKQogICAgICB9CiAgICB9KQoKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2Fubm91bmNlX3J4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBhbm5vdW5jZSBtZXNzYWdlcyByZWNlaXZlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUFubm91bmNlLnJ4KQogICAgICB9CiAgICB9KQogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfYW5ub3VuY2VfdHgnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGFubm91bmNlIG1lc3NhZ2VzIHRyYW5zbWl0dGVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlQW5ub3VuY2UudHgpCiAgICAgIH0KICAgIH0pCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9sb29rdXBfcngnLAogICAgICBoZWxwOiAnVGhlIGFtb3VudCBvZiB3aXJlIGxvb2t1cCBtZXNzYWdlcyByZWNlaXZlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUxvb2t1cC5yeCkKICAgICAgfQogICAgfSkKICAgIG5ldyBwcm9tQ2xpZW50LkdhdWdlKHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1uZXcKICAgICAgbmFtZTogJ3Byb3RvbXV4X3dha2V1cF93aXJlX2xvb2t1cF90eCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgbG9va3VwIG1lc3NhZ2VzIHRyYW5zbWl0dGVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlTG9va3VwLnR4KQogICAgICB9CiAgICB9KQogICAgbmV3IHByb21DbGllbnQuR2F1Z2UoewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogICAgICBuYW1lOiAncHJvdG9tdXhfd2FrZXVwX3dpcmVfaW5mb19yeCcsCiAgICAgIGhlbHA6ICdUaGUgYW1vdW50IG9mIHdpcmUgaW5mbyBtZXNzYWdlcyByZWNlaXZlZCBieSBwcm90b211eCB3YWtldXAnLAogICAgICBjb2xsZWN0KCkgewogICAgICAgIHRoaXMuc2V0KHNlbGYuc3RhdHMud2lyZUluZm8ucngpCiAgICAgIH0KICAgIH0pCiAgICBuZXcgcHJvbUNsaWVudC5HYXVnZSh7CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmV3CiAgICAgIG5hbWU6ICdwcm90b211eF93YWtldXBfd2lyZV9pbmZvX3R4JywKICAgICAgaGVscDogJ1RoZSBhbW91bnQgb2Ygd2lyZSBpbmZvIG1lc3NhZ2VzIHRyYW5zbWl0dGVkIGJ5IHByb3RvbXV4IHdha2V1cCcsCiAgICAgIGNvbGxlY3QoKSB7CiAgICAgICAgdGhpcy5zZXQoc2VsZi5zdGF0cy53aXJlSW5mby5yeCkKICAgICAgfQogICAgfSkKICB9Cn0KCmNsYXNzIFdha2V1cFBlZXIgewogIGNvbnN0cnVjdG9yKHRvcGljKSB7CiAgICB0aGlzLmluZGV4ID0gMAogICAgdGhpcy51c2VyRGF0YSA9IG51bGwgLy8gZm9yIHRoZSB1c2VyCiAgICB0aGlzLmNsb2NrID0gMCAvLyBmb3IgdGhlIHVzZXIsIHYgdXNlZnVsIHRvIHJlZHVjZSB0cmFmZmljCiAgICB0aGlzLnBlbmRpbmcgPSB0cnVlCiAgICB0aGlzLnJlbW92ZWQgPSBmYWxzZQogICAgdGhpcy50b3BpYyA9IHRvcGljCiAgICB0aGlzLmNoYW5uZWwgPSBudWxsCiAgICB0aGlzLnN0cmVhbSA9IG51bGwKICAgIHRoaXMud2lyZUxvb2t1cCA9IG51bGwKICAgIHRoaXMud2lyZUFubm91bmNlID0gbnVsbAogICAgdGhpcy53aXJlSW5mbyA9IG51bGwKICAgIHRoaXMuYWN0aXZlID0gZmFsc2UKICB9CgogIHVubGluayhsaXN0KSB7CiAgICAvLyBub3RlIHRoYXQgc2luY2Ugd2UgcG9wIGhlcmUgd2UgY2FuIGl0ZXJhdGUgaW4gcmV2ZXJzZSBzYWZlbHkgaW4gY2FzZSBhIHBlZXIgaXMgcmVtb3ZlZCBpbiB0aGUgc2FtZSB0aWNrCiAgICBjb25zdCBoZWFkID0gbGlzdC5wb3AoKQogICAgaWYgKGhlYWQgPT09IHRoaXMpIHJldHVybgogICAgaGVhZC5pbmRleCA9IHRoaXMuaW5kZXgKICAgIGxpc3RbaGVhZC5pbmRleF0gPSBoZWFkCiAgfQp9CgpjbGFzcyBXYWtldXBTZXNzaW9uIHsKICBjb25zdHJ1Y3Rvcih0b3BpYywgaGFuZGxlcnMpIHsKICAgIHRoaXMuaW5kZXggPSAwCiAgICB0aGlzLnRvcGljID0gdG9waWMKICAgIHRoaXMuaGFuZGxlcnMgPSBoYW5kbGVycwogICAgdGhpcy5pc0FjdGl2ZSA9IGhhbmRsZXJzLmFjdGl2ZSAhPT0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKICB9CgogIGdldCBwZWVycygpIHsKICAgIHJldHVybiB0aGlzLnRvcGljLnBlZXJzCiAgfQoKICBoYXNTdHJlYW0oc3RyZWFtKSB7CiAgICByZXR1cm4gISF0aGlzLmdldFBlZXIoc3RyZWFtKQogIH0KCiAgYWRkU3RyZWFtKHN0cmVhbSkgewogICAgdGhpcy50b3BpYy5hZGRTdHJlYW0oc3RyZWFtKQogIH0KCiAgZ2V0UGVlcihzdHJlYW0pIHsKICAgIHJldHVybiB0aGlzLnRvcGljLnBlZXJzQnlTdHJlYW0uZ2V0KHN0cmVhbSkgfHwgbnVsbAogIH0KCiAgYnJvYWRjYXN0TG9va3VwKHJlcSkgewogICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMudG9waWMucGVuZGluZ1BlZXJzKSB7CiAgICAgIHRoaXMubG9va3VwKHBlZXIsIHJlcSkKICAgIH0KICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnRvcGljLnBlZXJzKSB7CiAgICAgIHRoaXMubG9va3VwKHBlZXIsIHJlcSkKICAgIH0KICB9CgogIGxvb2t1cEJ5U3RyZWFtKHN0cmVhbSwgcmVxKSB7CiAgICBjb25zdCBwZWVyID0gdGhpcy50b3BpYy5wZWVyc0J5U3RyZWFtLmdldChzdHJlYW0pCiAgICBpZiAocGVlcikgdGhpcy5sb29rdXAocGVlciwgcmVxKQogIH0KCiAgbG9va3VwKHBlZXIsIHJlcSkgewogICAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlTG9va3VwLnR4KysKICAgIHBlZXIud2lyZUxvb2t1cC5zZW5kKHJlcSB8fCB7IGhhc2g6IG51bGwgfSkKICB9CgogIGFubm91bmNlQnlTdHJlYW0oc3RyZWFtLCB3YWtldXApIHsKICAgIGNvbnN0IHBlZXIgPSB0aGlzLnRvcGljLnBlZXJzQnlTdHJlYW0uZ2V0KHN0cmVhbSkKICAgIGlmIChwZWVyICYmICFwZWVyLnBlbmRpbmcpIHRoaXMuYW5ub3VuY2UocGVlciwgd2FrZXVwKQogIH0KCiAgYW5ub3VuY2UocGVlciwgd2FrZXVwKSB7CiAgICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVBbm5vdW5jZS50eCsrCiAgICBwZWVyLndpcmVBbm5vdW5jZS5zZW5kKHdha2V1cCkKICB9CgogIGFjdGl2ZSgpIHsKICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlCiAgICB0aGlzLnRvcGljLl9idW1wQWN0aXZpdHkoKQogIH0KCiAgaW5hY3RpdmUoKSB7CiAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgIHRoaXMudG9waWMuX2J1bXBBY3Rpdml0eSgpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQogICAgdGhpcy50b3BpYy5yZW1vdmVTZXNzaW9uKHRoaXMpCiAgfQp9CgpjbGFzcyBXYWtldXBUb3BpYyB7CiAgY29uc3RydWN0b3Ioc3RhdGUsIGlkLCBjYXBhYmlsaXR5LCBhY3RpdmUpIHsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZQogICAgdGhpcy5zZXNzaW9ucyA9IFtdCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMuY2FwYWJpbGl0eSA9IGNhcGFiaWxpdHkKICAgIHRoaXMucGVlcnMgPSBbXQogICAgdGhpcy5wZW5kaW5nUGVlcnMgPSBbXQogICAgdGhpcy5wZWVyc0J5U3RyZWFtID0gbmV3IE1hcCgpCiAgICB0aGlzLmFjdGl2ZVBlZXJzID0gMAogICAgdGhpcy5pc0FjdGl2ZSA9IGFjdGl2ZQogICAgdGhpcy5pZGxlVGlja3MgPSAwCiAgICB0aGlzLmdjaW5nID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKCiAgICB0aGlzLnN0YXRlLnN0YXRzLnRvcGljc0FkZGVkKysKICB9CgogIGFkZFNlc3Npb24oaGFuZGxlcnMpIHsKICAgIHRoaXMuc3RhdGUuc3RhdHMuc2Vzc2lvbnNPcGVuZWQrKwogICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBXYWtldXBTZXNzaW9uKHRoaXMsIGhhbmRsZXJzKQogICAgc2Vzc2lvbi5pbmRleCA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoCiAgICB0aGlzLnNlc3Npb25zLnB1c2goc2Vzc2lvbikKICAgIHRoaXMuX2J1bXBBY3Rpdml0eSgpCiAgICB0aGlzLl9jaGVja0dDKCkKICAgIHJldHVybiBzZXNzaW9uCiAgfQoKICByZW1vdmVTZXNzaW9uKHNlc3Npb24pIHsKICAgIGlmICh0aGlzLnNlc3Npb25zLmxlbmd0aCA8PSBzZXNzaW9uLmluZGV4KSByZXR1cm4KICAgIGlmICh0aGlzLnNlc3Npb25zW3Nlc3Npb24uaW5kZXhdICE9PSBzZXNzaW9uKSByZXR1cm4KCiAgICB0aGlzLnN0YXRlLnN0YXRzLnNlc3Npb25zQ2xvc2VkKysKCiAgICAvLyBzYW1lIGFzIHdpdGggdGhlIHBlZXIsIHRoaXMgYWxsb3dzIHVzIHRvIGl0ZXJhdGUgd2hpbGUgcmVtb3ZpbmcgaWYgaXRlcmF0aW5nIGJhY2t3YXJkcwogICAgY29uc3QgaGVhZCA9IHRoaXMuc2Vzc2lvbnMucG9wKCkKICAgIGlmIChoZWFkICE9PSBzZXNzaW9uKSB7CiAgICAgIGhlYWQuaW5kZXggPSBzZXNzaW9uLmluZGV4CiAgICAgIHRoaXMuc2Vzc2lvbnNbaGVhZC5pbmRleF0gPSBoZWFkCiAgICB9CgogICAgdGhpcy5fYnVtcEFjdGl2aXR5KCkKICAgIHRoaXMuX2NoZWNrR0MoKQogIH0KCiAgX2J1bXBBY3Rpdml0eSgpIHsKICAgIGxldCBpc0FjdGl2ZSA9IGZhbHNlCgogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgaWYgKHRoaXMuc2Vzc2lvbnNbaV0uaXNBY3RpdmUpIHsKICAgICAgICBpc0FjdGl2ZSA9IHRydWUKICAgICAgICBicmVhawogICAgICB9CiAgICB9CgogICAgaWYgKGlzQWN0aXZlKSB0aGlzLmFjdGl2ZSgpCiAgICBlbHNlIHRoaXMuaW5hY3RpdmUoKQogIH0KCiAgYWN0aXZlKCkgewogICAgaWYgKHRoaXMuaXNBY3RpdmUpIHJldHVybgogICAgdGhpcy5pZGxlVGlja3MgPSAwCiAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZQogICAgdGhpcy5fdXBkYXRlQWN0aXZlKHRydWUpCiAgfQoKICBpbmFjdGl2ZSgpIHsKICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgcmV0dXJuCiAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2UKICAgIHRoaXMuX3VwZGF0ZUFjdGl2ZShmYWxzZSkKICB9CgogIF91cGRhdGVBY3RpdmUoYWN0aXZlKSB7CiAgICBjb25zdCBpbmZvID0geyBhY3RpdmUgfQoKICAgIGZvciAoY29uc3QgcGVlciBvZiB0aGlzLnBlbmRpbmdQZWVycykgewogICAgICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVJbmZvLnR4KysKICAgICAgcGVlci53aXJlSW5mby5zZW5kKGluZm8pCiAgICB9CiAgICBmb3IgKGNvbnN0IHBlZXIgb2YgdGhpcy5wZWVycykgewogICAgICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVJbmZvLnR4KysKICAgICAgcGVlci53aXJlSW5mby5zZW5kKGluZm8pCiAgICB9CgogICAgdGhpcy5fY2hlY2tHQygpCgogICAgaWYgKGFjdGl2ZSkgdGhpcy5zdGF0ZS5fb25BY3RpdmUodGhpcykKICB9CgogIHRlYXJkb3duKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZQoKICAgIHRoaXMuc3RhdGUuc3RhdHMudG9waWNzR2NkKysKCiAgICBmb3IgKGxldCBpID0gdGhpcy5wZWVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnBlZXJzW2ldLmNoYW5uZWwuY2xvc2UoKQogICAgfQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnBlbmRpbmdQZWVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnBlbmRpbmdQZWVyc1tpXS5jaGFubmVsLmNsb3NlKCkKICAgIH0KCiAgICBjb25zdCBoZXggPSBiNGEudG9TdHJpbmcodGhpcy5pZCwgJ2hleCcpCgogICAgdGhpcy5nY2luZyA9IGZhbHNlCiAgICB0aGlzLnN0YXRlLnRvcGljcy5kZWxldGUoaGV4KQogICAgdGhpcy5zdGF0ZS5fcmVtb3ZlR0ModGhpcykKCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB0aGlzLnN0YXRlLnN0YXRzLnNlc3Npb25zQ2xvc2VkKysKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgaWYgKHNlc3Npb24uaGFuZGxlcnMub25kZXN0cm95KSBzZXNzaW9uLmhhbmRsZXJzLm9uZGVzdHJveShzZXNzaW9uKQogICAgfQogIH0KCiAgYWRkU3RyZWFtKHN0cmVhbSkgewogICAgdGhpcy5fb25vcGVuKGdldE11eGVyKHN0cmVhbSksIGZhbHNlKQogIH0KCiAgX3Byb3ZlQ2FwYWJpbGl0eVRvKHN0cmVhbSkgewogICAgcmV0dXJuIHRoaXMuX21ha2VDYXBhYmlsaXR5KHN0cmVhbS5pc0luaXRpYXRvciwgc3RyZWFtLmhhbmRzaGFrZUhhc2gpCiAgfQoKICBfbWFrZUNhcGFiaWxpdHkoaXNJbml0aWF0b3IsIGhhbmRzaGFrZUhhc2gpIHsKICAgIHJldHVybiBjcnlwdG8uaGFzaChbaXNJbml0aWF0b3IgPyBOU19JTklUQVRPUiA6IE5TX1JFU1BPTkRFUiwgdGhpcy5jYXBhYmlsaXR5LCBoYW5kc2hha2VIYXNoXSkKICB9CgogIF9hZGRQZWVyKHBlZXIsIG9wZW4pIHsKICAgIGlmICgKICAgICAgIWI0YS5lcXVhbHMoCiAgICAgICAgb3Blbi5jYXBhYmlsaXR5LAogICAgICAgIHRoaXMuX21ha2VDYXBhYmlsaXR5KCFwZWVyLnN0cmVhbS5pc0luaXRpYXRvciwgcGVlci5zdHJlYW0uaGFuZHNoYWtlSGFzaCkKICAgICAgKQogICAgKSB7CiAgICAgIHBlZXIuY2hhbm5lbC5jbG9zZSgpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmIChwZWVyLnBlbmRpbmcpIHsKICAgICAgcGVlci51bmxpbmsodGhpcy5wZW5kaW5nUGVlcnMpCiAgICB9CgogICAgcGVlci5hY3RpdmUgPSBvcGVuLmFjdGl2ZQogICAgcGVlci5wZW5kaW5nID0gZmFsc2UKICAgIHBlZXIuaW5kZXggPSB0aGlzLnBlZXJzLnB1c2gocGVlcikgLSAxCgogICAgaWYgKHBlZXIuYWN0aXZlKSB7CiAgICAgIHRoaXMuYWN0aXZlUGVlcnMrKwogICAgICB0aGlzLl9jaGVja0dDKCkKICAgIH0KCiAgICBmb3IgKGxldCBpID0gdGhpcy5zZXNzaW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tpXQogICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgIGlmIChoYW5kbGVycy5vbnBlZXJhZGQpIGhhbmRsZXJzLm9ucGVlcmFkZChwZWVyLCBzZXNzaW9uKQogICAgICBpZiAocGVlci5hY3RpdmUgJiYgaGFuZGxlcnMub25wZWVyYWN0aXZlKSBoYW5kbGVycy5vbnBlZXJhY3RpdmUocGVlciwgc2Vzc2lvbikKICAgIH0KICB9CgogIF9jaGVja0dDKCkgewogICAgY29uc3Qgc2hvdWxkR0MgPSB0aGlzLmFjdGl2ZVBlZXJzID09PSAwICYmIHRoaXMuc2Vzc2lvbnMubGVuZ3RoID09PSAwCgogICAgaWYgKHNob3VsZEdDKSB7CiAgICAgIGlmICghdGhpcy5nY2luZykgewogICAgICAgIHRoaXMuZ2NpbmcgPSB0cnVlCiAgICAgICAgdGhpcy5zdGF0ZS5fYWRkR0ModGhpcykKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHRoaXMuZ2NpbmcpIHsKICAgICAgICB0aGlzLmdjaW5nID0gZmFsc2UKICAgICAgICB0aGlzLnN0YXRlLl9yZW1vdmVHQyh0aGlzKQogICAgICB9CiAgICB9CiAgfQoKICBfcmVtb3ZlUGVlcihwZWVyKSB7CiAgICB0aGlzLnN0YXRlLnN0YXRzLnBlZXJzUmVtb3ZlZCsrCiAgICBwZWVyLnJlbW92ZWQgPSB0cnVlCiAgICB0aGlzLnBlZXJzQnlTdHJlYW0uZGVsZXRlKHBlZXIuc3RyZWFtKQoKICAgIGlmIChwZWVyLnBlbmRpbmcpIHsKICAgICAgcGVlci51bmxpbmsodGhpcy5wZW5kaW5nUGVlcnMpCiAgICAgIHJldHVybgogICAgfQoKICAgIGNvbnN0IGFjdGl2ZSA9IHBlZXIuYWN0aXZlCgogICAgaWYgKGFjdGl2ZSkgewogICAgICBwZWVyLmFjdGl2ZSA9IGZhbHNlCiAgICAgIHRoaXMuYWN0aXZlUGVlcnMtLQogICAgICB0aGlzLl9jaGVja0dDKCkKICAgIH0KCiAgICBwZWVyLnVubGluayh0aGlzLnBlZXJzKQoKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgaWYgKGFjdGl2ZSAmJiBoYW5kbGVycy5vbnBlZXJpbmFjdGl2ZSkgaGFuZGxlcnMub25wZWVyaW5hY3RpdmUocGVlciwgc2Vzc2lvbikKICAgICAgaWYgKGhhbmRsZXJzLm9ucGVlcnJlbW92ZSkgaGFuZGxlcnMub25wZWVycmVtb3ZlKHBlZXIsIHNlc3Npb24pCiAgICB9CiAgfQoKICBfb25hbm5vdW5jZSh3YWtldXAsIHBlZXIpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgIGNvbnN0IGhhbmRsZXJzID0gc2Vzc2lvbi5oYW5kbGVycwoKICAgICAgaWYgKGhhbmRsZXJzLm9uYW5ub3VuY2UpIGhhbmRsZXJzLm9uYW5ub3VuY2Uod2FrZXVwLCBwZWVyLCBzZXNzaW9uKQogICAgfQogIH0KCiAgX29ubG9va3VwKHJlcSwgcGVlcikgewogICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbaV0KICAgICAgY29uc3QgaGFuZGxlcnMgPSBzZXNzaW9uLmhhbmRsZXJzCgogICAgICBpZiAoaGFuZGxlcnMub25sb29rdXApIGhhbmRsZXJzLm9ubG9va3VwKHJlcSwgcGVlciwgc2Vzc2lvbikKICAgIH0KICB9CgogIF9vbmluZm8oaW5mbywgcGVlcikgewogICAgaWYgKGluZm8uYWN0aXZlKSB7CiAgICAgIGlmICghcGVlci5hY3RpdmUpIHsKICAgICAgICBwZWVyLmFjdGl2ZSA9IHRydWUKICAgICAgICB0aGlzLmFjdGl2ZVBlZXJzKysKICAgICAgICB0aGlzLl9jaGVja0dDKCkKCiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgICAgICBpZiAoaGFuZGxlcnMub25wZWVyYWN0aXZlKSBoYW5kbGVycy5vbnBlZXJhY3RpdmUocGVlciwgc2Vzc2lvbikKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChwZWVyLmFjdGl2ZSkgewogICAgICAgIHBlZXIuYWN0aXZlID0gZmFsc2UKICAgICAgICB0aGlzLmFjdGl2ZVBlZXJzLS0KICAgICAgICB0aGlzLl9jaGVja0dDKCkKCiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc2Vzc2lvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2ldCiAgICAgICAgICBjb25zdCBoYW5kbGVycyA9IHNlc3Npb24uaGFuZGxlcnMKCiAgICAgICAgICBpZiAoaGFuZGxlcnMub25wZWVyaW5hY3RpdmUpIGhhbmRsZXJzLm9ucGVlcmluYWN0aXZlKHBlZXIsIHNlc3Npb24pCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBfb25vcGVuKG11eGVyLCB1bmlxdWUpIHsKICAgIGlmICghdW5pcXVlICYmIHRoaXMucGVlcnNCeVN0cmVhbS5oYXMobXV4ZXIuc3RyZWFtKSkgcmV0dXJuCgogICAgY29uc3QgcGVlciA9IG5ldyBXYWtldXBQZWVyKHRoaXMpCiAgICBjb25zdCBjaCA9IG11eGVyLmNyZWF0ZUNoYW5uZWwoewogICAgICB1c2VyRGF0YTogcGVlciwKICAgICAgcHJvdG9jb2w6ICd3YWtldXAnLAogICAgICBpZDogdGhpcy5pZCwKICAgICAgaGFuZHNoYWtlOiBIYW5kc2hha2UsCiAgICAgIG1lc3NhZ2VzOiBbCiAgICAgICAgeyBlbmNvZGluZzogTG9va3VwLCBvbm1lc3NhZ2U6IG9ubG9va3VwIH0sCiAgICAgICAgeyBlbmNvZGluZzogQW5ub3VuY2UsIG9ubWVzc2FnZTogb25hbm5vdW5jZSB9LAogICAgICAgIHsgZW5jb2Rpbmc6IEluZm8sIG9ubWVzc2FnZTogb25jaGFubmVsaW5mbyB9CiAgICAgIF0sCiAgICAgIG9ub3Blbjogb25jaGFubmVsb3BlbiwKICAgICAgb25jbG9zZTogb25jaGFubmVsY2xvc2UKICAgIH0pCgogICAgaWYgKCFjaCkgcmV0dXJuCgogICAgdGhpcy5zdGF0ZS5zdGF0cy5wZWVyc0FkZGVkKysKCiAgICBwZWVyLmNoYW5uZWwgPSBjaAogICAgcGVlci5zdHJlYW0gPSBtdXhlci5zdHJlYW0KCiAgICBwZWVyLndpcmVMb29rdXAgPSBjaC5tZXNzYWdlc1swXQogICAgcGVlci53aXJlQW5ub3VuY2UgPSBjaC5tZXNzYWdlc1sxXQogICAgcGVlci53aXJlSW5mbyA9IGNoLm1lc3NhZ2VzWzJdCgogICAgcGVlci5pbmRleCA9IHRoaXMucGVuZGluZ1BlZXJzLnB1c2gocGVlcikgLSAxCiAgICB0aGlzLnBlZXJzQnlTdHJlYW0uc2V0KG11eGVyLnN0cmVhbSwgcGVlcikKCiAgICBjaC5vcGVuKHsKICAgICAgdmVyc2lvbjogMCwKICAgICAgY2FwYWJpbGl0eTogdGhpcy5fcHJvdmVDYXBhYmlsaXR5VG8obXV4ZXIuc3RyZWFtKSwKICAgICAgYWN0aXZlOiB0aGlzLmlzQWN0aXZlCiAgICB9KQogIH0KfQoKZnVuY3Rpb24gb25jaGFubmVsb3BlbihvcGVuLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLl9hZGRQZWVyKHBlZXIsIG9wZW4pCn0KCmZ1bmN0aW9uIG9uY2hhbm5lbGNsb3NlKGNsb3NlLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLl9yZW1vdmVQZWVyKHBlZXIpCn0KCmZ1bmN0aW9uIG9ubG9va3VwKHJlcSwgY2hhbm5lbCkgewogIGNvbnN0IHBlZXIgPSBjaGFubmVsLnVzZXJEYXRhCiAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlTG9va3VwLnJ4KysKICBwZWVyLnRvcGljLl9vbmxvb2t1cChyZXEsIHBlZXIpCn0KCmZ1bmN0aW9uIG9uYW5ub3VuY2Uod2FrZXVwLCBjaGFubmVsKSB7CiAgY29uc3QgcGVlciA9IGNoYW5uZWwudXNlckRhdGEKICBwZWVyLnRvcGljLnN0YXRlLnN0YXRzLndpcmVBbm5vdW5jZS5yeCsrCiAgcGVlci50b3BpYy5fb25hbm5vdW5jZSh3YWtldXAsIHBlZXIpCn0KCmZ1bmN0aW9uIG9uY2hhbm5lbGluZm8oaW5mbywgY2hhbm5lbCkgewogIGNvbnN0IHBlZXIgPSBjaGFubmVsLnVzZXJEYXRhCiAgcGVlci50b3BpYy5zdGF0ZS5zdGF0cy53aXJlSW5mby5yeCsrCiAgcGVlci50b3BpYy5fb25pbmZvKGluZm8sIHBlZXIpCn0KCmZ1bmN0aW9uIGdldE11eGVyKHN0cmVhbSkgewogIGlmIChQcm90b211eC5pc1Byb3RvbXV4KHN0cmVhbSkpIHJldHVybiBzdHJlYW0KICBpZiAoc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhKSByZXR1cm4gc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhCiAgY29uc3QgbXV4ID0gUHJvdG9tdXguZnJvbShzdHJlYW0ubm9pc2VTdHJlYW0pCiAgc3RyZWFtLm5vaXNlU3RyZWFtLnVzZXJEYXRhID0gbXV4CiAgcmV0dXJuIG11eAp9CgpmdW5jdGlvbiBub29wKCkge30KewogICJuYW1lIjogInByb3RvbXV4LXdha2V1cCIsCiAgInZlcnNpb24iOiAiMi45LjAiLAogICJkZXNjcmlwdGlvbiI6ICJXYWtldXAgcHJvdG9jb2wgb3ZlciBwcm90b211eCIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNyIsCiAgICAiaHlwZXJjb3JlLWNyeXB0byI6ICJeMy41LjAiLAogICAgImh5cGVyc2NoZW1hIjogIl4xLjEwLjQiLAogICAgInByb3RvbXV4IjogIl4zLjEwLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuOC4xIiwKICAgICJicml0dGxlIjogIl4zLjE3LjEiLAogICAgImx1bnRlIjogIl4xLjAuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIsCiAgICAicHJvbS1jbGllbnQiOiAiXjE1LjEuMyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAic3BlYy9oeXBlcnNjaGVtYS8qLmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAiZm9ybWF0IjogInByZXR0aWVyIC0td3JpdGUgLiIsCiAgICAidGVzdCI6ICJwcmV0dGllciAtLWNoZWNrIC4gJiYgbHVudGUgJiYgYnJpdHRsZSB0ZXN0LyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9wcm90b211eC13YWtldXAuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9wcm90b211eC13YWtldXAvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9wcm90b211eC13YWtldXAiCn0KLy8gVGhpcyBmaWxlIGlzIGF1dG9nZW5lcmF0ZWQgYnkgdGhlIGh5cGVyc2NoZW1hIGNvbXBpbGVyCi8vIFNjaGVtYSBWZXJzaW9uOiAxCi8qIGVzbGludC1kaXNhYmxlIGNhbWVsY2FzZSAqLwovKiBlc2xpbnQtZGlzYWJsZSBxdW90ZXMgKi8KCmNvbnN0IFZFUlNJT04gPSAxCmNvbnN0IHsgYyB9ID0gcmVxdWlyZSgnaHlwZXJzY2hlbWEvcnVudGltZScpCgovLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMKbGV0IHZlcnNpb24gPSBWRVJTSU9OCgovLyBAd2FrZXVwL2luZm8KY29uc3QgZW5jb2RpbmcwID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgc3RhdGUuZW5kKysgLy8gbWF4IGZsYWcgaXMgMSBzbyBhbHdheXMgb25lIGJ5dGUKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmFjdGl2ZSA/IDEgOiAwCgogICAgYy51aW50LmVuY29kZShzdGF0ZSwgZmxhZ3MpCiAgfSwKICBkZWNvZGUoc3RhdGUpIHsKICAgIGNvbnN0IGZsYWdzID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICByZXR1cm4gewogICAgICBhY3RpdmU6IChmbGFncyAmIDEpICE9PSAwCiAgICB9CiAgfQp9CgovLyBAd2FrZXVwL2hhbmRzaGFrZQpjb25zdCBlbmNvZGluZzEgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLmZpeGVkMzIucHJlZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQogIH0sCiAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBjb25zdCBmbGFncyA9IG0uYWN0aXZlID8gMSA6IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLnZlcnNpb24pCiAgICBjLmZpeGVkMzIuZW5jb2RlKHN0YXRlLCBtLmNhcGFiaWxpdHkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBmbGFncykKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIHZlcnNpb246IHIwLAogICAgICBjYXBhYmlsaXR5OiByMSwKICAgICAgYWN0aXZlOiAoZmxhZ3MgJiAxKSAhPT0gMAogICAgfQogIH0KfQoKLy8gQHdha2V1cC93cml0ZXIKY29uc3QgZW5jb2RpbmcyID0gewogIHByZWVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLnByZWVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgYy5maXhlZDMyLmVuY29kZShzdGF0ZSwgbS5rZXkpCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBtLmxlbmd0aCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgcjAgPSBjLmZpeGVkMzIuZGVjb2RlKHN0YXRlKQogICAgY29uc3QgcjEgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGtleTogcjAsCiAgICAgIGxlbmd0aDogcjEKICAgIH0KICB9Cn0KCi8vIEB3YWtldXAvYW5ub3VuY2UKY29uc3QgZW5jb2RpbmczID0gYy5hcnJheShlbmNvZGluZzIpCgovLyBAd2FrZXVwL2xvb2t1cApjb25zdCBlbmNvZGluZzQgPSB7CiAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICBzdGF0ZS5lbmQrKyAvLyBtYXggZmxhZyBpcyAxIHNvIGFsd2F5cyBvbmUgYnl0ZQoKICAgIGlmIChtLmhhc2gpIGMuZml4ZWQzMi5wcmVlbmNvZGUoc3RhdGUsIG0uaGFzaCkKICB9LAogIGVuY29kZShzdGF0ZSwgbSkgewogICAgY29uc3QgZmxhZ3MgPSBtLmhhc2ggPyAxIDogMAoKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIGZsYWdzKQoKICAgIGlmIChtLmhhc2gpIGMuZml4ZWQzMi5lbmNvZGUoc3RhdGUsIG0uaGFzaCkKICB9LAogIGRlY29kZShzdGF0ZSkgewogICAgY29uc3QgZmxhZ3MgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIHJldHVybiB7CiAgICAgIGhhc2g6IChmbGFncyAmIDEpICE9PSAwID8gYy5maXhlZDMyLmRlY29kZShzdGF0ZSkgOiBudWxsCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBzZXRWZXJzaW9uKHYpIHsKICB2ZXJzaW9uID0gdgp9CgpmdW5jdGlvbiBlbmNvZGUobmFtZSwgdmFsdWUsIHYgPSBWRVJTSU9OKSB7CiAgdmVyc2lvbiA9IHYKICByZXR1cm4gYy5lbmNvZGUoZ2V0RW5jb2RpbmcobmFtZSksIHZhbHVlKQp9CgpmdW5jdGlvbiBkZWNvZGUobmFtZSwgYnVmZmVyLCB2ID0gVkVSU0lPTikgewogIHZlcnNpb24gPSB2CiAgcmV0dXJuIGMuZGVjb2RlKGdldEVuY29kaW5nKG5hbWUpLCBidWZmZXIpCn0KCmZ1bmN0aW9uIGdldEVudW0obmFtZSkgewogIHN3aXRjaCAobmFtZSkgewogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbnVtIG5vdCBmb3VuZCAnICsgbmFtZSkKICB9Cn0KCmZ1bmN0aW9uIGdldEVuY29kaW5nKG5hbWUpIHsKICBzd2l0Y2ggKG5hbWUpIHsKICAgIGNhc2UgJ0B3YWtldXAvaW5mbyc6CiAgICAgIHJldHVybiBlbmNvZGluZzAKICAgIGNhc2UgJ0B3YWtldXAvaGFuZHNoYWtlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMQogICAgY2FzZSAnQHdha2V1cC93cml0ZXInOgogICAgICByZXR1cm4gZW5jb2RpbmcyCiAgICBjYXNlICdAd2FrZXVwL2Fubm91bmNlJzoKICAgICAgcmV0dXJuIGVuY29kaW5nMwogICAgY2FzZSAnQHdha2V1cC9sb29rdXAnOgogICAgICByZXR1cm4gZW5jb2Rpbmc0CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY29kZXIgbm90IGZvdW5kICcgKyBuYW1lKQogIH0KfQoKZnVuY3Rpb24gZ2V0U3RydWN0KG5hbWUsIHYgPSBWRVJTSU9OKSB7CiAgY29uc3QgZW5jID0gZ2V0RW5jb2RpbmcobmFtZSkKICByZXR1cm4gewogICAgcHJlZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZW5jb2RlKHN0YXRlLCBtKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIGVuYy5lbmNvZGUoc3RhdGUsIG0pCiAgICB9LAogICAgZGVjb2RlKHN0YXRlKSB7CiAgICAgIHZlcnNpb24gPSB2CiAgICAgIHJldHVybiBlbmMuZGVjb2RlKHN0YXRlKQogICAgfQogIH0KfQoKY29uc3QgcmVzb2x2ZVN0cnVjdCA9IGdldFN0cnVjdCAvLyBjb21wYXQKCm1vZHVsZS5leHBvcnRzID0gewogIHJlc29sdmVTdHJ1Y3QsCiAgZ2V0U3RydWN0LAogIGdldEVudW0sCiAgZ2V0RW5jb2RpbmcsCiAgZW5jb2RlLAogIGRlY29kZSwKICBzZXRWZXJzaW9uLAogIHZlcnNpb24KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHF1ZXVlVGljayA9IHJlcXVpcmUoJ3F1ZXVlLXRpY2snKQpjb25zdCBzYWZldHlDYXRjaCA9IHJlcXVpcmUoJ3NhZmV0eS1jYXRjaCcpCmNvbnN0IHVuc2xhYiA9IHJlcXVpcmUoJ3Vuc2xhYicpCgpjb25zdCBNQVhfQlVGRkVSRUQgPSAzMjc2OApjb25zdCBNQVhfQkFDS0xPRyA9IEluZmluaXR5IC8vIFRPRE86IGltcGwgIm9wZW4iIGJhY2twcmVzc3VyZQpjb25zdCBNQVhfQkFUQ0ggPSA4ICogMTAyNCAqIDEwMjQKCmNsYXNzIENoYW5uZWwgewogIGNvbnN0cnVjdG9yIChtdXgsIGluZm8sIHVzZXJEYXRhLCBwcm90b2NvbCwgYWxpYXNlcywgaWQsIGhhbmRzaGFrZSwgbWVzc2FnZXMsIG9ub3Blbiwgb25jbG9zZSwgb25kZXN0cm95LCBvbmRyYWluKSB7CiAgICB0aGlzLnVzZXJEYXRhID0gdXNlckRhdGEKICAgIHRoaXMucHJvdG9jb2wgPSBwcm90b2NvbAogICAgdGhpcy5hbGlhc2VzID0gYWxpYXNlcwogICAgdGhpcy5pZCA9IGlkCiAgICB0aGlzLmhhbmRzaGFrZSA9IG51bGwKICAgIHRoaXMubWVzc2FnZXMgPSBbXQoKICAgIHRoaXMub3BlbmVkID0gZmFsc2UKICAgIHRoaXMuY2xvc2VkID0gZmFsc2UKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2UKCiAgICB0aGlzLm9ub3BlbiA9IG9ub3BlbgogICAgdGhpcy5vbmNsb3NlID0gb25jbG9zZQogICAgdGhpcy5vbmRlc3Ryb3kgPSBvbmRlc3Ryb3kKICAgIHRoaXMub25kcmFpbiA9IG9uZHJhaW4KCiAgICB0aGlzLl9oYW5kc2hha2UgPSBoYW5kc2hha2UKICAgIHRoaXMuX211eCA9IG11eAogICAgdGhpcy5faW5mbyA9IGluZm8KICAgIHRoaXMuX2xvY2FsSWQgPSAwCiAgICB0aGlzLl9yZW1vdGVJZCA9IDAKICAgIHRoaXMuX2FjdGl2ZSA9IDAKICAgIHRoaXMuX2V4dGVuc2lvbnMgPSBudWxsCgogICAgdGhpcy5fZGVjQm91bmQgPSB0aGlzLl9kZWMuYmluZCh0aGlzKQogICAgdGhpcy5fZGVjQW5kRGVzdHJveUJvdW5kID0gdGhpcy5fZGVjQW5kRGVzdHJveS5iaW5kKHRoaXMpCgogICAgdGhpcy5fb3BlbmVkUHJvbWlzZSA9IG51bGwKICAgIHRoaXMuX29wZW5lZFJlc29sdmUgPSBudWxsCgogICAgdGhpcy5fZGVzdHJveWVkUHJvbWlzZSA9IG51bGwKICAgIHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgPSBudWxsCgogICAgZm9yIChjb25zdCBtIG9mIG1lc3NhZ2VzKSB0aGlzLmFkZE1lc3NhZ2UobSkKICB9CgogIGdldCBkcmFpbmVkICgpIHsKICAgIHJldHVybiB0aGlzLl9tdXguZHJhaW5lZAogIH0KCiAgZnVsbHlPcGVuZWQgKCkgewogICAgaWYgKHRoaXMub3BlbmVkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpCiAgICBpZiAodGhpcy5jbG9zZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpCiAgICBpZiAodGhpcy5fb3BlbmVkUHJvbWlzZSkgcmV0dXJuIHRoaXMuX29wZW5lZFByb21pc2UKCiAgICB0aGlzLl9vcGVuZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsgdGhpcy5fb3BlbmVkUmVzb2x2ZSA9IHJlc29sdmUgfSkKICAgIHJldHVybiB0aGlzLl9vcGVuZWRQcm9taXNlCiAgfQoKICBmdWxseUNsb3NlZCAoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZFByb21pc2UpIHJldHVybiB0aGlzLl9kZXN0cm95ZWRQcm9taXNlCgogICAgdGhpcy5fZGVzdHJveWVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7IHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgPSByZXNvbHZlIH0pCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWVkUHJvbWlzZQogIH0KCiAgb3BlbiAoaGFuZHNoYWtlKSB7CiAgICBjb25zdCBpZCA9IHRoaXMuX211eC5fZnJlZS5sZW5ndGggPiAwCiAgICAgID8gdGhpcy5fbXV4Ll9mcmVlLnBvcCgpCiAgICAgIDogdGhpcy5fbXV4Ll9sb2NhbC5wdXNoKG51bGwpIC0gMQoKICAgIHRoaXMuX2luZm8ub3BlbmVkKysKICAgIHRoaXMuX2luZm8ubGFzdENoYW5uZWwgPSB0aGlzCiAgICB0aGlzLl9sb2NhbElkID0gaWQgKyAxCiAgICB0aGlzLl9tdXguX2xvY2FsW2lkXSA9IHRoaXMKCiAgICBpZiAodGhpcy5fcmVtb3RlSWQgPT09IDApIHsKICAgICAgdGhpcy5faW5mby5vdXRnb2luZy5wdXNoKHRoaXMuX2xvY2FsSWQpCiAgICB9CgogICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDIsIGVuZDogMiB9CgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgdGhpcy5fbG9jYWxJZCkKICAgIGMuc3RyaW5nLnByZWVuY29kZShzdGF0ZSwgdGhpcy5wcm90b2NvbCkKICAgIGMuYnVmZmVyLnByZWVuY29kZShzdGF0ZSwgdGhpcy5pZCkKICAgIGlmICh0aGlzLl9oYW5kc2hha2UpIHRoaXMuX2hhbmRzaGFrZS5wcmVlbmNvZGUoc3RhdGUsIGhhbmRzaGFrZSkKCiAgICBzdGF0ZS5idWZmZXIgPSB0aGlzLl9tdXguX2FsbG9jKHN0YXRlLmVuZCkKCiAgICBzdGF0ZS5idWZmZXJbMF0gPSAwCiAgICBzdGF0ZS5idWZmZXJbMV0gPSAxCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0aGlzLl9sb2NhbElkKQogICAgYy5zdHJpbmcuZW5jb2RlKHN0YXRlLCB0aGlzLnByb3RvY29sKQogICAgYy5idWZmZXIuZW5jb2RlKHN0YXRlLCB0aGlzLmlkKQogICAgaWYgKHRoaXMuX2hhbmRzaGFrZSkgdGhpcy5faGFuZHNoYWtlLmVuY29kZShzdGF0ZSwgaGFuZHNoYWtlKQoKICAgIHRoaXMuX211eC5fd3JpdGUwKHN0YXRlLmJ1ZmZlcikKICB9CgogIF9kZWMgKCkgewogICAgaWYgKC0tdGhpcy5fYWN0aXZlID09PSAwICYmIHRoaXMuY2xvc2VkID09PSB0cnVlKSB0aGlzLl9kZXN0cm95KCkKICB9CgogIF9kZWNBbmREZXN0cm95IChlcnIpIHsKICAgIHRoaXMuX2RlYygpCiAgICB0aGlzLl9tdXguX3NhZmVEZXN0cm95KGVycikKICB9CgogIF9mdWxseU9wZW5Tb29uICgpIHsKICAgIHRoaXMuX211eC5fcmVtb3RlW3RoaXMuX3JlbW90ZUlkIC0gMV0uc2Vzc2lvbiA9IHRoaXMKICAgIHF1ZXVlVGljayh0aGlzLl9mdWxseU9wZW4uYmluZCh0aGlzKSkKICB9CgogIF9mdWxseU9wZW4gKCkgewogICAgaWYgKHRoaXMub3BlbmVkID09PSB0cnVlIHx8IHRoaXMuY2xvc2VkID09PSB0cnVlKSByZXR1cm4KCiAgICBjb25zdCByZW1vdGUgPSB0aGlzLl9tdXguX3JlbW90ZVt0aGlzLl9yZW1vdGVJZCAtIDFdCgogICAgdGhpcy5vcGVuZWQgPSB0cnVlCiAgICB0aGlzLmhhbmRzaGFrZSA9IHRoaXMuX2hhbmRzaGFrZSA/IHRoaXMuX2hhbmRzaGFrZS5kZWNvZGUocmVtb3RlLnN0YXRlKSA6IG51bGwKICAgIHRoaXMuX3RyYWNrKHRoaXMub25vcGVuKHRoaXMuaGFuZHNoYWtlLCB0aGlzKSkKCiAgICByZW1vdGUuc2Vzc2lvbiA9IHRoaXMKICAgIHJlbW90ZS5zdGF0ZSA9IG51bGwKICAgIGlmIChyZW1vdGUucGVuZGluZyAhPT0gbnVsbCkgdGhpcy5fZHJhaW4ocmVtb3RlKQoKICAgIHRoaXMuX3Jlc29sdmVPcGVuKHRydWUpCiAgfQoKICBfcmVzb2x2ZU9wZW4gKG9wZW5lZCkgewogICAgaWYgKHRoaXMuX29wZW5lZFJlc29sdmUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fb3BlbmVkUmVzb2x2ZShvcGVuZWQpCiAgICAgIHRoaXMuX29wZW5lZFJlc29sdmUgPSB0aGlzLl9vcGVuZWRQcm9taXNlID0gbnVsbAogICAgfQogIH0KCiAgX3Jlc29sdmVEZXN0cm95ZWQgKCkgewogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fZGVzdHJveWVkUmVzb2x2ZSgpCiAgICAgIHRoaXMuX2Rlc3Ryb3llZFJlc29sdmUgPSB0aGlzLl9kZXN0cm95ZWRQcm9taXNlID0gbnVsbAogICAgfQogIH0KCiAgX2RyYWluIChyZW1vdGUpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVtb3RlLnBlbmRpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcCA9IHJlbW90ZS5wZW5kaW5nW2ldCiAgICAgIHRoaXMuX211eC5fYnVmZmVyZWQgLT0gYnl0ZVNpemUocC5zdGF0ZSkKICAgICAgdGhpcy5fcmVjdihwLnR5cGUsIHAuc3RhdGUpCiAgICB9CgogICAgcmVtb3RlLnBlbmRpbmcgPSBudWxsCiAgICB0aGlzLl9tdXguX3Jlc3VtZU1heWJlKCkKICB9CgogIF90cmFjayAocCkgewogICAgaWYgKGlzUHJvbWlzZShwKSA9PT0gdHJ1ZSkgewogICAgICB0aGlzLl9hY3RpdmUrKwogICAgICByZXR1cm4gcC50aGVuKHRoaXMuX2RlY0JvdW5kLCB0aGlzLl9kZWNBbmREZXN0cm95Qm91bmQpCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIF9jbG9zZSAoaXNSZW1vdGUpIHsKICAgIGlmICh0aGlzLmNsb3NlZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLmNsb3NlZCA9IHRydWUKCiAgICB0aGlzLl9pbmZvLm9wZW5lZC0tCiAgICBpZiAodGhpcy5faW5mby5sYXN0Q2hhbm5lbCA9PT0gdGhpcykgdGhpcy5faW5mby5sYXN0Q2hhbm5lbCA9IG51bGwKCiAgICBpZiAodGhpcy5fcmVtb3RlSWQgPiAwKSB7CiAgICAgIHRoaXMuX211eC5fcmVtb3RlW3RoaXMuX3JlbW90ZUlkIC0gMV0gPSBudWxsCiAgICAgIHRoaXMuX3JlbW90ZUlkID0gMAogICAgICAvLyBJZiByZW1vdGUgaGFzIGFja2VkLCB3ZSBjYW4gcmV1c2UgdGhlIGxvY2FsIGlkIG5vdwogICAgICAvLyBvdGhlcndpc2UsIHdlIG5lZWQgdG8gd2FpdCBmb3IgdGhlICJhY2siIHRvIGFycml2ZQogICAgICB0aGlzLl9tdXguX2ZyZWUucHVzaCh0aGlzLl9sb2NhbElkIC0gMSkKICAgIH0KCiAgICB0aGlzLl9tdXguX2xvY2FsW3RoaXMuX2xvY2FsSWQgLSAxXSA9IG51bGwKICAgIHRoaXMuX2xvY2FsSWQgPSAwCgogICAgdGhpcy5fbXV4Ll9nYyh0aGlzLl9pbmZvKQogICAgdGhpcy5fdHJhY2sodGhpcy5vbmNsb3NlKGlzUmVtb3RlLCB0aGlzKSkKCiAgICBpZiAodGhpcy5fYWN0aXZlID09PSAwKSB0aGlzLl9kZXN0cm95KCkKCiAgICB0aGlzLl9yZXNvbHZlT3BlbihmYWxzZSkKICB9CgogIF9kZXN0cm95ICgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgcmV0dXJuCiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICAgIHRoaXMuX3RyYWNrKHRoaXMub25kZXN0cm95KHRoaXMpKQogICAgdGhpcy5fcmVzb2x2ZURlc3Ryb3llZCgpCiAgfQoKICBfcmVjdiAodHlwZSwgc3RhdGUpIHsKICAgIGlmICh0eXBlIDwgdGhpcy5tZXNzYWdlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgbSA9IHRoaXMubWVzc2FnZXNbdHlwZV0KICAgICAgY29uc3QgcCA9IG0ucmVjdihzdGF0ZSwgdGhpcykKICAgICAgaWYgKG0uYXV0b0JhdGNoID09PSB0cnVlKSByZXR1cm4gcAogICAgfQogICAgcmV0dXJuIG51bGwKICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fbXV4LmNvcmsoKQogIH0KCiAgdW5jb3JrICgpIHsKICAgIHRoaXMuX211eC51bmNvcmsoKQogIH0KCiAgY2xvc2UgKCkgewogICAgaWYgKHRoaXMuY2xvc2VkID09PSB0cnVlKSByZXR1cm4KCiAgICBjb25zdCBzdGF0ZSA9IHsgYnVmZmVyOiBudWxsLCBzdGFydDogMiwgZW5kOiAyIH0KCiAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCB0aGlzLl9sb2NhbElkKQoKICAgIHN0YXRlLmJ1ZmZlciA9IHRoaXMuX211eC5fYWxsb2Moc3RhdGUuZW5kKQoKICAgIHN0YXRlLmJ1ZmZlclswXSA9IDAKICAgIHN0YXRlLmJ1ZmZlclsxXSA9IDMKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHRoaXMuX2xvY2FsSWQpCgogICAgdGhpcy5fY2xvc2UoZmFsc2UpCiAgICB0aGlzLl9tdXguX3dyaXRlMChzdGF0ZS5idWZmZXIpCiAgfQoKICBhZGRNZXNzYWdlIChvcHRzKSB7CiAgICBpZiAoIW9wdHMpIHJldHVybiB0aGlzLl9za2lwTWVzc2FnZSgpCgogICAgY29uc3QgdHlwZSA9IHRoaXMubWVzc2FnZXMubGVuZ3RoCiAgICBjb25zdCBhdXRvQmF0Y2ggPSBvcHRzLmF1dG9CYXRjaCAhPT0gZmFsc2UKICAgIGNvbnN0IGVuY29kaW5nID0gb3B0cy5lbmNvZGluZyB8fCBjLnJhdwogICAgY29uc3Qgb25tZXNzYWdlID0gb3B0cy5vbm1lc3NhZ2UgfHwgbm9vcAoKICAgIGNvbnN0IHMgPSB0aGlzCiAgICBjb25zdCB0eXBlTGVuID0gZW5jb2RpbmdMZW5ndGgoYy51aW50LCB0eXBlKQoKICAgIGNvbnN0IG0gPSB7CiAgICAgIHR5cGUsCiAgICAgIGF1dG9CYXRjaCwKICAgICAgZW5jb2RpbmcsCiAgICAgIG9ubWVzc2FnZSwKICAgICAgcmVjdiAoc3RhdGUsIHNlc3Npb24pIHsKICAgICAgICByZXR1cm4gc2Vzc2lvbi5fdHJhY2sobS5vbm1lc3NhZ2UoZW5jb2RpbmcuZGVjb2RlKHN0YXRlKSwgc2Vzc2lvbikpCiAgICAgIH0sCiAgICAgIHNlbmQgKG0sIHNlc3Npb24gPSBzKSB7CiAgICAgICAgaWYgKHNlc3Npb24uY2xvc2VkID09PSB0cnVlKSByZXR1cm4gZmFsc2UKCiAgICAgICAgY29uc3QgbXV4ID0gc2Vzc2lvbi5fbXV4CiAgICAgICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogdHlwZUxlbiB9CgogICAgICAgIGlmIChtdXguX2JhdGNoICE9PSBudWxsKSB7CiAgICAgICAgICBlbmNvZGluZy5wcmVlbmNvZGUoc3RhdGUsIG0pCiAgICAgICAgICBzdGF0ZS5idWZmZXIgPSBtdXguX2FsbG9jKHN0YXRlLmVuZCkKCiAgICAgICAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCB0eXBlKQogICAgICAgICAgZW5jb2RpbmcuZW5jb2RlKHN0YXRlLCBtKQoKICAgICAgICAgIG11eC5fcHVzaEJhdGNoKHNlc3Npb24uX2xvY2FsSWQsIHN0YXRlLmJ1ZmZlcikKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQoKICAgICAgICBjLnVpbnQucHJlZW5jb2RlKHN0YXRlLCBzZXNzaW9uLl9sb2NhbElkKQogICAgICAgIGVuY29kaW5nLnByZWVuY29kZShzdGF0ZSwgbSkKCiAgICAgICAgc3RhdGUuYnVmZmVyID0gbXV4Ll9hbGxvYyhzdGF0ZS5lbmQpCgogICAgICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHNlc3Npb24uX2xvY2FsSWQpCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgdHlwZSkKICAgICAgICBlbmNvZGluZy5lbmNvZGUoc3RhdGUsIG0pCgogICAgICAgIG11eC5kcmFpbmVkID0gbXV4LnN0cmVhbS53cml0ZShzdGF0ZS5idWZmZXIpCgogICAgICAgIHJldHVybiBtdXguZHJhaW5lZAogICAgICB9CiAgICB9CgogICAgdGhpcy5tZXNzYWdlcy5wdXNoKG0pCgogICAgcmV0dXJuIG0KICB9CgogIF9za2lwTWVzc2FnZSAoKSB7CiAgICBjb25zdCB0eXBlID0gdGhpcy5tZXNzYWdlcy5sZW5ndGgKICAgIGNvbnN0IG0gPSB7CiAgICAgIHR5cGUsCiAgICAgIGVuY29kaW5nOiBjLnJhdywKICAgICAgb25tZXNzYWdlOiBub29wLAogICAgICByZWN2IChzdGF0ZSwgc2Vzc2lvbikge30sCiAgICAgIHNlbmQgKG0sIHNlc3Npb24pIHt9CiAgICB9CgogICAgdGhpcy5tZXNzYWdlcy5wdXNoKG0pCiAgICByZXR1cm4gbQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBQcm90b211eCB7CiAgY29uc3RydWN0b3IgKHN0cmVhbSwgeyBhbGxvYyB9ID0ge30pIHsKICAgIGlmIChzdHJlYW0udXNlckRhdGEgPT09IG51bGwpIHN0cmVhbS51c2VyRGF0YSA9IHRoaXMKCiAgICB0aGlzLmlzUHJvdG9tdXggPSB0cnVlCiAgICB0aGlzLnN0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5jb3JrZWQgPSAwCiAgICB0aGlzLmRyYWluZWQgPSB0cnVlCgogICAgdGhpcy5fYWxsb2MgPSBhbGxvYyB8fCAodHlwZW9mIHN0cmVh","bS5hbGxvYyA9PT0gJ2Z1bmN0aW9uJyA/IHN0cmVhbS5hbGxvYy5iaW5kKHN0cmVhbSkgOiBiNGEuYWxsb2NVbnNhZmUpCiAgICB0aGlzLl9zYWZlRGVzdHJveUJvdW5kID0gdGhpcy5fc2FmZURlc3Ryb3kuYmluZCh0aGlzKQogICAgdGhpcy5fdW5jb3JrQm91bmQgPSB0aGlzLnVuY29yay5iaW5kKHRoaXMpCgogICAgdGhpcy5fcmVtb3RlQmFja2xvZyA9IDAKICAgIHRoaXMuX2J1ZmZlcmVkID0gMAogICAgdGhpcy5fcGF1c2VkID0gZmFsc2UKICAgIHRoaXMuX3JlbW90ZSA9IFtdCiAgICB0aGlzLl9sb2NhbCA9IFtdCiAgICB0aGlzLl9mcmVlID0gW10KICAgIHRoaXMuX2JhdGNoID0gbnVsbAogICAgdGhpcy5fYmF0Y2hTdGF0ZSA9IG51bGwKCiAgICB0aGlzLl9pbmZvcyA9IG5ldyBNYXAoKQogICAgdGhpcy5fbm90aWZ5ID0gbmV3IE1hcCgpCgogICAgdGhpcy5zdHJlYW0ub24oJ2RhdGEnLCB0aGlzLl9vbmRhdGEuYmluZCh0aGlzKSkKICAgIHRoaXMuc3RyZWFtLm9uKCdkcmFpbicsIHRoaXMuX29uZHJhaW4uYmluZCh0aGlzKSkKICAgIHRoaXMuc3RyZWFtLm9uKCdlbmQnLCB0aGlzLl9vbmVuZC5iaW5kKHRoaXMpKQogICAgdGhpcy5zdHJlYW0ub24oJ2Vycm9yJywgbm9vcCkgLy8gd2UgaGFuZGxlIHRoaXMgaW4gImNsb3NlIgogICAgdGhpcy5zdHJlYW0ub24oJ2Nsb3NlJywgdGhpcy5fc2h1dGRvd24uYmluZCh0aGlzKSkKICB9CgogIHN0YXRpYyBmcm9tIChzdHJlYW0sIG9wdHMpIHsKICAgIGlmIChzdHJlYW0udXNlckRhdGEgJiYgc3RyZWFtLnVzZXJEYXRhLmlzUHJvdG9tdXgpIHJldHVybiBzdHJlYW0udXNlckRhdGEKICAgIGlmIChzdHJlYW0uaXNQcm90b211eCkgcmV0dXJuIHN0cmVhbQogICAgcmV0dXJuIG5ldyB0aGlzKHN0cmVhbSwgb3B0cykKICB9CgogIHN0YXRpYyBpc1Byb3RvbXV4IChtdXgpIHsKICAgIHJldHVybiB0eXBlb2YgbXV4ID09PSAnb2JqZWN0JyAmJiBtdXguaXNQcm90b211eCA9PT0gdHJ1ZQogIH0KCiAgKiBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICBmb3IgKGNvbnN0IHNlc3Npb24gb2YgdGhpcy5fbG9jYWwpIHsKICAgICAgaWYgKHNlc3Npb24gIT09IG51bGwpIHlpZWxkIHNlc3Npb24KICAgIH0KICB9CgogIGlzSWRsZSAoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9jYWwubGVuZ3RoID09PSB0aGlzLl9mcmVlLmxlbmd0aAogIH0KCiAgY29yayAoKSB7CiAgICBpZiAoKyt0aGlzLmNvcmtlZCA9PT0gMSkgewogICAgICB0aGlzLl9iYXRjaCA9IFtdCiAgICAgIHRoaXMuX2JhdGNoU3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogMSB9CiAgICB9CiAgfQoKICB1bmNvcmsgKCkgewogICAgaWYgKC0tdGhpcy5jb3JrZWQgPT09IDApIHsKICAgICAgdGhpcy5fc2VuZEJhdGNoKHRoaXMuX2JhdGNoLCB0aGlzLl9iYXRjaFN0YXRlKQogICAgICB0aGlzLl9iYXRjaCA9IG51bGwKICAgICAgdGhpcy5fYmF0Y2hTdGF0ZSA9IG51bGwKICAgIH0KICB9CgogIGdldExhc3RDaGFubmVsICh7IHByb3RvY29sLCBpZCA9IG51bGwgfSkgewogICAgY29uc3Qga2V5ID0gdG9LZXkocHJvdG9jb2wsIGlkKQogICAgY29uc3QgaW5mbyA9IHRoaXMuX2luZm9zLmdldChrZXkpCiAgICBpZiAoaW5mbykgcmV0dXJuIGluZm8ubGFzdENoYW5uZWwKICAgIHJldHVybiBudWxsCiAgfQoKICBwYWlyICh7IHByb3RvY29sLCBpZCA9IG51bGwgfSwgbm90aWZ5KSB7CiAgICB0aGlzLl9ub3RpZnkuc2V0KHRvS2V5KHByb3RvY29sLCBpZCksIG5vdGlmeSkKICB9CgogIHVucGFpciAoeyBwcm90b2NvbCwgaWQgPSBudWxsIH0pIHsKICAgIHRoaXMuX25vdGlmeS5kZWxldGUodG9LZXkocHJvdG9jb2wsIGlkKSkKICB9CgogIG9wZW5lZCAoeyBwcm90b2NvbCwgaWQgPSBudWxsIH0pIHsKICAgIGNvbnN0IGtleSA9IHRvS2V5KHByb3RvY29sLCBpZCkKICAgIGNvbnN0IGluZm8gPSB0aGlzLl9pbmZvcy5nZXQoa2V5KQogICAgcmV0dXJuIGluZm8gPyBpbmZvLm9wZW5lZCA+IDAgOiBmYWxzZQogIH0KCiAgY3JlYXRlQ2hhbm5lbCAoeyB1c2VyRGF0YSA9IG51bGwsIHByb3RvY29sLCBhbGlhc2VzID0gW10sIGlkID0gbnVsbCwgdW5pcXVlID0gdHJ1ZSwgaGFuZHNoYWtlID0gbnVsbCwgbWVzc2FnZXMgPSBbXSwgb25vcGVuID0gbm9vcCwgb25jbG9zZSA9IG5vb3AsIG9uZGVzdHJveSA9IG5vb3AsIG9uZHJhaW4gPSBub29wIH0pIHsKICAgIGlmICh0aGlzLnN0cmVhbS5kZXN0cm95ZWQpIHJldHVybiBudWxsCgogICAgY29uc3QgaW5mbyA9IHRoaXMuX2dldChwcm90b2NvbCwgaWQsIGFsaWFzZXMpCiAgICBpZiAodW5pcXVlICYmIGluZm8ub3BlbmVkID4gMCkgcmV0dXJuIG51bGwKCiAgICBpZiAoaW5mby5pbmNvbWluZy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG5ldyBDaGFubmVsKHRoaXMsIGluZm8sIHVzZXJEYXRhLCBwcm90b2NvbCwgYWxpYXNlcywgaWQsIGhhbmRzaGFrZSwgbWVzc2FnZXMsIG9ub3Blbiwgb25jbG9zZSwgb25kZXN0cm95LCBvbmRyYWluKQogICAgfQoKICAgIHRoaXMuX3JlbW90ZUJhY2tsb2ctLQoKICAgIGNvbnN0IHJlbW90ZUlkID0gaW5mby5pbmNvbWluZy5zaGlmdCgpCiAgICBjb25zdCByID0gdGhpcy5fcmVtb3RlW3JlbW90ZUlkIC0gMV0KICAgIGlmIChyID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgQ2hhbm5lbCh0aGlzLCBpbmZvLCB1c2VyRGF0YSwgcHJvdG9jb2wsIGFsaWFzZXMsIGlkLCBoYW5kc2hha2UsIG1lc3NhZ2VzLCBvbm9wZW4sIG9uY2xvc2UsIG9uZGVzdHJveSwgb25kcmFpbikKCiAgICBzZXNzaW9uLl9yZW1vdGVJZCA9IHJlbW90ZUlkCiAgICBzZXNzaW9uLl9mdWxseU9wZW5Tb29uKCkKCiAgICByZXR1cm4gc2Vzc2lvbgogIH0KCiAgX3B1c2hCYXRjaCAobG9jYWxJZCwgYnVmZmVyKSB7CiAgICBpZiAodGhpcy5fYmF0Y2hTdGF0ZS5lbmQgPj0gTUFYX0JBVENIKSB7CiAgICAgIHRoaXMuX3NlbmRCYXRjaCh0aGlzLl9iYXRjaCwgdGhpcy5fYmF0Y2hTdGF0ZSkKICAgICAgdGhpcy5fYmF0Y2ggPSBbXQogICAgICB0aGlzLl9iYXRjaFN0YXRlID0geyBidWZmZXI6IG51bGwsIHN0YXJ0OiAwLCBlbmQ6IDEgfQogICAgfQoKICAgIGlmICh0aGlzLl9iYXRjaC5sZW5ndGggPT09IDAgfHwgdGhpcy5fYmF0Y2hbdGhpcy5fYmF0Y2gubGVuZ3RoIC0gMV0ubG9jYWxJZCAhPT0gbG9jYWxJZCkgewogICAgICB0aGlzLl9iYXRjaFN0YXRlLmVuZCsrCiAgICAgIGMudWludC5wcmVlbmNvZGUodGhpcy5fYmF0Y2hTdGF0ZSwgbG9jYWxJZCkKICAgIH0KICAgIGMuYnVmZmVyLnByZWVuY29kZSh0aGlzLl9iYXRjaFN0YXRlLCBidWZmZXIpCiAgICB0aGlzLl9iYXRjaC5wdXNoKHsgbG9jYWxJZCwgYnVmZmVyIH0pCiAgfQoKICBfc2VuZEJhdGNoIChiYXRjaCwgc3RhdGUpIHsKICAgIGlmIChiYXRjaC5sZW5ndGggPT09IDApIHJldHVybgoKICAgIGxldCBwcmV2ID0gYmF0Y2hbMF0ubG9jYWxJZAoKICAgIHN0YXRlLmJ1ZmZlciA9IHRoaXMuX2FsbG9jKHN0YXRlLmVuZCkKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKICAgIHN0YXRlLmJ1ZmZlcltzdGF0ZS5zdGFydCsrXSA9IDAKCiAgICBjLnVpbnQuZW5jb2RlKHN0YXRlLCBwcmV2KQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmF0Y2gubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYiA9IGJhdGNoW2ldCiAgICAgIGlmIChwcmV2ICE9PSBiLmxvY2FsSWQpIHsKICAgICAgICBzdGF0ZS5idWZmZXJbc3RhdGUuc3RhcnQrK10gPSAwCiAgICAgICAgYy51aW50LmVuY29kZShzdGF0ZSwgKHByZXYgPSBiLmxvY2FsSWQpKQogICAgICB9CiAgICAgIGMuYnVmZmVyLmVuY29kZShzdGF0ZSwgYi5idWZmZXIpCiAgICB9CgogICAgdGhpcy5kcmFpbmVkID0gdGhpcy5zdHJlYW0ud3JpdGUoc3RhdGUuYnVmZmVyKQogIH0KCiAgX2dldCAocHJvdG9jb2wsIGlkLCBhbGlhc2VzID0gW10pIHsKICAgIGNvbnN0IGtleSA9IHRvS2V5KHByb3RvY29sLCBpZCkKCiAgICBsZXQgaW5mbyA9IHRoaXMuX2luZm9zLmdldChrZXkpCiAgICBpZiAoaW5mbykgcmV0dXJuIGluZm8KCiAgICBpbmZvID0geyBrZXksIHByb3RvY29sLCBhbGlhc2VzOiBbXSwgaWQsIHBhaXJpbmc6IDAsIG9wZW5lZDogMCwgaW5jb21pbmc6IFtdLCBvdXRnb2luZzogW10sIGxhc3RDaGFubmVsOiBudWxsIH0KICAgIHRoaXMuX2luZm9zLnNldChrZXksIGluZm8pCgogICAgZm9yIChjb25zdCBhbGlhcyBvZiBhbGlhc2VzKSB7CiAgICAgIGNvbnN0IGtleSA9IHRvS2V5KGFsaWFzLCBpZCkKICAgICAgaW5mby5hbGlhc2VzLnB1c2goa2V5KQoKICAgICAgdGhpcy5faW5mb3Muc2V0KGtleSwgaW5mbykKICAgIH0KCiAgICByZXR1cm4gaW5mbwogIH0KCiAgX2djIChpbmZvKSB7CiAgICBpZiAoaW5mby5vcGVuZWQgPT09IDAgJiYgaW5mby5vdXRnb2luZy5sZW5ndGggPT09IDAgJiYgaW5mby5pbmNvbWluZy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5faW5mb3MuZGVsZXRlKGluZm8ua2V5KQoKICAgICAgZm9yIChjb25zdCBhbGlhcyBvZiBpbmZvLmFsaWFzZXMpIHRoaXMuX2luZm9zLmRlbGV0ZShhbGlhcykKICAgIH0KICB9CgogIF9vbmRhdGEgKGJ1ZmZlcikgewogICAgaWYgKGJ1ZmZlci5ieXRlTGVuZ3RoID09PSAwKSByZXR1cm4gLy8gaWdub3JlIGVtcHR5IGZyYW1lcy4uLgogICAgdHJ5IHsKICAgICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQ6IDAsIGVuZDogYnVmZmVyLmJ5dGVMZW5ndGggfQogICAgICB0aGlzLl9kZWNvZGUoYy51aW50LmRlY29kZShzdGF0ZSksIHN0YXRlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX3NhZmVEZXN0cm95KGVycikKICAgIH0KICB9CgogIF9vbmRyYWluICgpIHsKICAgIHRoaXMuZHJhaW5lZCA9IHRydWUKCiAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fbG9jYWwpIHsKICAgICAgaWYgKHMgIT09IG51bGwpIHMuX3RyYWNrKHMub25kcmFpbihzKSkKICAgIH0KICB9CgogIF9vbmVuZCAoKSB7IC8vIFRPRE86IHN1cHBvcnQgaGFsZiBvcGVuIG1vZGUgZm9yIHRoZSB1c2VycyB3aG8gd2FudHMgdGhhdCBoZXJlCiAgICB0aGlzLnN0cmVhbS5lbmQoKQogIH0KCiAgX2RlY29kZSAocmVtb3RlSWQsIHN0YXRlKSB7CiAgICBjb25zdCB0eXBlID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAocmVtb3RlSWQgPT09IDApIHsKICAgICAgcmV0dXJuIHRoaXMuX29uY29udHJvbHNlc3Npb24odHlwZSwgc3RhdGUpCiAgICB9CgogICAgY29uc3QgciA9IHJlbW90ZUlkIDw9IHRoaXMuX3JlbW90ZS5sZW5ndGggPyB0aGlzLl9yZW1vdGVbcmVtb3RlSWQgLSAxXSA6IG51bGwKCiAgICAvLyBpZiB0aGUgY2hhbm5lbCBpcyBjbG9zZWQgaWdub3JlIC0gY291bGQganVzdCBiZSBhIHBpcGVsaW5lIG1lc3NhZ2UuLi4KICAgIGlmIChyID09PSBudWxsKSByZXR1cm4gbnVsbAoKICAgIGlmIChyLnBlbmRpbmcgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyTWVzc2FnZShyLCB0eXBlLCBzdGF0ZSkKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICByZXR1cm4gci5zZXNzaW9uLl9yZWN2KHR5cGUsIHN0YXRlKQogIH0KCiAgX29uY29udHJvbHNlc3Npb24gKHR5cGUsIHN0YXRlKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX29uYmF0Y2goc3RhdGUpCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgMToKICAgICAgICAvLyByZXR1cm4gdGhlIHByb21pc2UgYmFjayB1cCBhcyB0aGlzIGhhcyBzaWRlZWZmZWN0cyBzbyB3ZSBjYW4gYmF0Y2ggcmVwbHkKICAgICAgICByZXR1cm4gdGhpcy5fb25vcGVuc2Vzc2lvbihzdGF0ZSkKCiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9vbnJlamVjdHNlc3Npb24oc3RhdGUpCiAgICAgICAgYnJlYWsKCiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLl9vbmNsb3Nlc2Vzc2lvbihzdGF0ZSkKICAgICAgICBicmVhawogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBfYnVmZmVyTWVzc2FnZSAociwgdHlwZSwgeyBidWZmZXIsIHN0YXJ0LCBlbmQgfSkgewogICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlciwgc3RhcnQsIGVuZCB9IC8vIGNvcHkKICAgIHIucGVuZGluZy5wdXNoKHsgdHlwZSwgc3RhdGUgfSkKICAgIHRoaXMuX2J1ZmZlcmVkICs9IGJ5dGVTaXplKHN0YXRlKQogICAgdGhpcy5fcGF1c2VNYXliZSgpCiAgfQoKICBfcGF1c2VNYXliZSAoKSB7CiAgICBpZiAodGhpcy5fcGF1c2VkID09PSB0cnVlIHx8IHRoaXMuX2J1ZmZlcmVkIDw9IE1BWF9CVUZGRVJFRCkgcmV0dXJuCiAgICB0aGlzLl9wYXVzZWQgPSB0cnVlCiAgICB0aGlzLnN0cmVhbS5wYXVzZSgpCiAgfQoKICBfcmVzdW1lTWF5YmUgKCkgewogICAgaWYgKHRoaXMuX3BhdXNlZCA9PT0gZmFsc2UgfHwgdGhpcy5fYnVmZmVyZWQgPiBNQVhfQlVGRkVSRUQpIHJldHVybgogICAgdGhpcy5fcGF1c2VkID0gZmFsc2UKICAgIHRoaXMuc3RyZWFtLnJlc3VtZSgpCiAgfQoKICBfb25iYXRjaCAoc3RhdGUpIHsKICAgIGNvbnN0IGVuZCA9IHN0YXRlLmVuZAogICAgbGV0IHJlbW90ZUlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBsZXQgd2FpdGluZyA9IG51bGwKCiAgICB3aGlsZSAoc3RhdGUuZW5kID4gc3RhdGUuc3RhcnQpIHsKICAgICAgY29uc3QgbGVuID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgaWYgKGxlbiA9PT0gMCkgewogICAgICAgIHJlbW90ZUlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICAgIHN0YXRlLmVuZCA9IHN0YXRlLnN0YXJ0ICsgbGVuCiAgICAgIC8vIGlmIGJhdGNoIGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgbWVzc2FnZSwgY29yayBpdCBzbyB3ZSByZXBseSBiYWNrIHdpdGggYSBiYXRjaAogICAgICBpZiAoZW5kICE9PSBzdGF0ZS5lbmQgJiYgd2FpdGluZyA9PT0gbnVsbCkgewogICAgICAgIHdhaXRpbmcgPSBbXQogICAgICAgIHRoaXMuY29yaygpCiAgICAgIH0KICAgICAgY29uc3QgcCA9IHRoaXMuX2RlY29kZShyZW1vdGVJZCwgc3RhdGUpCiAgICAgIGlmICh3YWl0aW5nICE9PSBudWxsICYmIHAgIT09IG51bGwpIHdhaXRpbmcucHVzaChwKQogICAgICBzdGF0ZS5zdGFydCA9IHN0YXRlLmVuZAogICAgICBzdGF0ZS5lbmQgPSBlbmQKICAgIH0KCiAgICBpZiAod2FpdGluZyAhPT0gbnVsbCkgewogICAgICAvLyB0aGUgd2FpdGluZyBwcm9taXNlcyBhcmUgbm90IGFsbG93ZWQgdG8gdGhyb3cgYnV0IHdlIGRlc3Ryb3kgdGhlIHN0cmVhbSBpbiBjYXNlIHdlIGFyZSB3cm9uZwogICAgICBQcm9taXNlLmFsbCh3YWl0aW5nKS50aGVuKHRoaXMuX3VuY29ya0JvdW5kLCB0aGlzLl9zYWZlRGVzdHJveUJvdW5kKQogICAgfQogIH0KCiAgX29ub3BlbnNlc3Npb24gKHN0YXRlKSB7CiAgICBjb25zdCByZW1vdGVJZCA9IGMudWludC5kZWNvZGUoc3RhdGUpCiAgICBjb25zdCBwcm90b2NvbCA9IGMuc3RyaW5nLmRlY29kZShzdGF0ZSkKICAgIGNvbnN0IGlkID0gdW5zbGFiKGMuYnVmZmVyLmRlY29kZShzdGF0ZSkpCgogICAgLy8gcmVtb3RlIHRyaWVkIHRvIG9wZW4gdGhlIGNvbnRyb2wgc2Vzc2lvbiAtIGF1dG8gcmVqZWN0IGZvciBub3cKICAgIC8vIGFzIHdlIGNhbiB1c2UgYXMgYW4gZXhwbGljaXQgY29udHJvbCBwcm90b2NvbCBkZWNsYXJhdGlvbiBpZiB3ZSBuZWVkIHRvCiAgICBpZiAocmVtb3RlSWQgPT09IDApIHsKICAgICAgdGhpcy5fcmVqZWN0U2Vzc2lvbigwKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHJpZCA9IHJlbW90ZUlkIC0gMQogICAgY29uc3QgaW5mbyA9IHRoaXMuX2dldChwcm90b2NvbCwgaWQpCgogICAgLy8gYWxsb3cgdGhlIHJlbW90ZSB0byBncm93IHRoZSBpZHMgYnkgb25lCiAgICBpZiAodGhpcy5fcmVtb3RlLmxlbmd0aCA9PT0gcmlkKSB7CiAgICAgIHRoaXMuX3JlbW90ZS5wdXNoKG51bGwpCiAgICB9CgogICAgaWYgKHJpZCA+PSB0aGlzLl9yZW1vdGUubGVuZ3RoIHx8IHRoaXMuX3JlbW90ZVtyaWRdICE9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBvcGVuIG1lc3NhZ2UnKQogICAgfQoKICAgIGlmIChpbmZvLm91dGdvaW5nLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgbG9jYWxJZCA9IGluZm8ub3V0Z29pbmcuc2hpZnQoKQogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5fbG9jYWxbbG9jYWxJZCAtIDFdCgogICAgICBpZiAoc2Vzc2lvbiA9PT0gbnVsbCkgeyAvLyB3ZSBhbHJlYWR5IGNsb3NlZCB0aGUgY2hhbm5lbCAtIGlnbm9yZQogICAgICAgIHRoaXMuX2ZyZWUucHVzaChsb2NhbElkIC0gMSkKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CgogICAgICB0aGlzLl9yZW1vdGVbcmlkXSA9IHsgc3RhdGUsIHBlbmRpbmc6IG51bGwsIHNlc3Npb246IG51bGwgfQoKICAgICAgc2Vzc2lvbi5fcmVtb3RlSWQgPSByZW1vdGVJZAogICAgICBzZXNzaW9uLl9mdWxseU9wZW4oKQogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IGNvcHlTdGF0ZSA9IHsgYnVmZmVyOiBzdGF0ZS5idWZmZXIsIHN0YXJ0OiBzdGF0ZS5zdGFydCwgZW5kOiBzdGF0ZS5lbmQgfQogICAgdGhpcy5fcmVtb3RlW3JpZF0gPSB7IHN0YXRlOiBjb3B5U3RhdGUsIHBlbmRpbmc6IFtdLCBzZXNzaW9uOiBudWxsIH0KCiAgICBpZiAoKyt0aGlzLl9yZW1vdGVCYWNrbG9nID4gTUFYX0JBQ0tMT0cpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZW1vdGUgZXhjZWVkZWQgYmFja2xvZycpCiAgICB9CgogICAgaW5mby5wYWlyaW5nKysKICAgIGluZm8uaW5jb21pbmcucHVzaChyZW1vdGVJZCkKCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdFNlc3Npb24ocHJvdG9jb2wsIGlkLCBpbmZvKS5jYXRjaCh0aGlzLl9zYWZlRGVzdHJveUJvdW5kKQogIH0KCiAgX29ucmVqZWN0c2Vzc2lvbiAoc3RhdGUpIHsKICAgIGNvbnN0IGxvY2FsSWQgPSBjLnVpbnQuZGVjb2RlKHN0YXRlKQoKICAgIC8vIFRPRE86IGNhbiBiZSBkb25lIHNtYXJ0ZXIuLi4KICAgIGZvciAoY29uc3QgaW5mbyBvZiB0aGlzLl9pbmZvcy52YWx1ZXMoKSkgewogICAgICBjb25zdCBpID0gaW5mby5vdXRnb2luZy5pbmRleE9mKGxvY2FsSWQpCiAgICAgIGlmIChpID09PSAtMSkgY29udGludWUKCiAgICAgIGluZm8ub3V0Z29pbmcuc3BsaWNlKGksIDEpCgogICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5fbG9jYWxbbG9jYWxJZCAtIDFdCgogICAgICB0aGlzLl9mcmVlLnB1c2gobG9jYWxJZCAtIDEpCiAgICAgIGlmIChzZXNzaW9uICE9PSBudWxsKSBzZXNzaW9uLl9jbG9zZSh0cnVlKQoKICAgICAgdGhpcy5fZ2MoaW5mbykKICAgICAgcmV0dXJuCiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHJlamVjdCBtZXNzYWdlJykKICB9CgogIF9vbmNsb3Nlc2Vzc2lvbiAoc3RhdGUpIHsKICAgIGNvbnN0IHJlbW90ZUlkID0gYy51aW50LmRlY29kZShzdGF0ZSkKCiAgICBpZiAocmVtb3RlSWQgPT09IDApIHJldHVybiAvLyBpZ25vcmUKCiAgICBjb25zdCByaWQgPSByZW1vdGVJZCAtIDEKICAgIGNvbnN0IHIgPSByaWQgPCB0aGlzLl9yZW1vdGUubGVuZ3RoID8gdGhpcy5fcmVtb3RlW3JpZF0gOiBudWxsCgogICAgaWYgKHIgPT09IG51bGwpIHJldHVybgoKICAgIGlmIChyLnNlc3Npb24gIT09IG51bGwpIHIuc2Vzc2lvbi5fY2xvc2UodHJ1ZSkKICB9CgogIGFzeW5jIF9yZXF1ZXN0U2Vzc2lvbiAocHJvdG9jb2wsIGlkLCBpbmZvKSB7CiAgICBjb25zdCBub3RpZnkgPSB0aGlzLl9ub3RpZnkuZ2V0KHRvS2V5KHByb3RvY29sLCBpZCkpIHx8IHRoaXMuX25vdGlmeS5nZXQodG9LZXkocHJvdG9jb2wsIG51bGwpKQoKICAgIGlmIChub3RpZnkpIGF3YWl0IG5vdGlmeShpZCkKCiAgICBpZiAoLS1pbmZvLnBhaXJpbmcgPiAwKSByZXR1cm4KCiAgICB3aGlsZSAoaW5mby5pbmNvbWluZy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuX3JlamVjdFNlc3Npb24oaW5mbywgaW5mby5pbmNvbWluZy5zaGlmdCgpKQogICAgfQoKICAgIHRoaXMuX2djKGluZm8pCiAgfQoKICBfcmVqZWN0U2Vzc2lvbiAoaW5mbywgcmVtb3RlSWQpIHsKICAgIGlmIChyZW1vdGVJZCA+IDApIHsKICAgICAgY29uc3QgciA9IHRoaXMuX3JlbW90ZVtyZW1vdGVJZCAtIDFdCgogICAgICBpZiAoci5wZW5kaW5nICE9PSBudWxsKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByLnBlbmRpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRoaXMuX2J1ZmZlcmVkIC09IGJ5dGVTaXplKHIucGVuZGluZ1tpXS5zdGF0ZSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX3JlbW90ZVtyZW1vdGVJZCAtIDFdID0gbnVsbAogICAgICB0aGlzLl9yZXN1bWVNYXliZSgpCiAgICB9CgogICAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDIsIGVuZDogMiB9CgogICAgYy51aW50LnByZWVuY29kZShzdGF0ZSwgcmVtb3RlSWQpCgogICAgc3RhdGUuYnVmZmVyID0gdGhpcy5fYWxsb2Moc3RhdGUuZW5kKQoKICAgIHN0YXRlLmJ1ZmZlclswXSA9IDAKICAgIHN0YXRlLmJ1ZmZlclsxXSA9IDIKICAgIGMudWludC5lbmNvZGUoc3RhdGUsIHJlbW90ZUlkKQoKICAgIHRoaXMuX3dyaXRlMChzdGF0ZS5idWZmZXIpCiAgfQoKICBfd3JpdGUwIChidWZmZXIpIHsKICAgIGlmICh0aGlzLl9iYXRjaCAhPT0gbnVsbCkgewogICAgICB0aGlzLl9wdXNoQmF0Y2goMCwgYnVmZmVyLnN1YmFycmF5KDEpKQogICAgICByZXR1cm4KICAgIH0KCiAgICB0aGlzLmRyYWluZWQgPSB0aGlzLnN0cmVhbS53cml0ZShidWZmZXIpCiAgfQoKICBkZXN0cm95IChlcnIpIHsKICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koZXJyKQogIH0KCiAgX3NhZmVEZXN0cm95IChlcnIpIHsKICAgIHNhZmV0eUNhdGNoKGVycikKICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koZXJyKQogIH0KCiAgX3NodXRkb3duICgpIHsKICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9sb2NhbCkgewogICAgICBpZiAocyAhPT0gbnVsbCkgcy5fY2xvc2UodHJ1ZSkKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIG5vb3AgKCkge30KCmZ1bmN0aW9uIHRvS2V5IChwcm90b2NvbCwgaWQpIHsKICByZXR1cm4gcHJvdG9jb2wgKyAnIyMnICsgKGlkID8gYjRhLnRvU3RyaW5nKGlkLCAnaGV4JykgOiAnJykKfQoKZnVuY3Rpb24gYnl0ZVNpemUgKHN0YXRlKSB7CiAgcmV0dXJuIDUxMiArIChzdGF0ZS5lbmQgLSBzdGF0ZS5zdGFydCkKfQoKZnVuY3Rpb24gaXNQcm9taXNlIChwKSB7CiAgcmV0dXJuICEhKHAgJiYgdHlwZW9mIHAudGhlbiA9PT0gJ2Z1bmN0aW9uJykKfQoKZnVuY3Rpb24gZW5jb2RpbmdMZW5ndGggKGVuYywgdmFsKSB7CiAgY29uc3Qgc3RhdGUgPSB7IGJ1ZmZlcjogbnVsbCwgc3RhcnQ6IDAsIGVuZDogMCB9CiAgZW5jLnByZWVuY29kZShzdGF0ZSwgdmFsKQogIHJldHVybiBzdGF0ZS5lbmQKfQp7CiAgIm5hbWUiOiAicHJvdG9tdXgiLAogICJ2ZXJzaW9uIjogIjMuMTAuMSIsCiAgImRlc2NyaXB0aW9uIjogIk11bHRpcGxleCBtdWx0aXBsZSBtZXNzYWdlIG9yaWVudGVkIHByb3RvY29scyBvdmVyIGEgc3RyZWFtIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuMy4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjUuMSIsCiAgICAicXVldWUtdGljayI6ICJeMS4wLjAiLAogICAgInNhZmV0eS1jYXRjaCI6ICJeMS4wLjEiLAogICAgInVuc2xhYiI6ICJeMS4zLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgIkBoeXBlcnN3YXJtL3NlY3JldC1zdHJlYW0iOiAiXjYuMC4wIiwKICAgICJicml0dGxlIjogIl4zLjAuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE2LjAuNCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Byb3RvbXV4LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b211eC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9wcm90b211eCIKfQp7CiAgIm5hbWUiOiAicXVldWUtdGljayIsCiAgInZlcnNpb24iOiAiMS4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJOZXh0IHRpY2sgc2hpbSB0aGF0IHByZWZlcnMgcHJvY2Vzcy5uZXh0VGljayBvdmVyIHF1ZXVlTWljcm90YXNrIGZvciBjb21wYXQiLAogICJtYWluIjogIi4vcHJvY2Vzcy1uZXh0LXRpY2suanMiLAogICJicm93c2VyIjogIi4vcXVldWUtbWljcm90YXNrLmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTYuMC4zIiwKICAgICJ0YXBlIjogIl41LjMuMSIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgdGFwZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3F1ZXVlLXRpY2suZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3F1ZXVlLXRpY2svaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcXVldWUtdGljayIKfQptb2R1bGUuZXhwb3J0cyA9ICh0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHByb2Nlc3MubmV4dFRpY2sgPT09ICdmdW5jdGlvbicpCiAgPyBwcm9jZXNzLm5leHRUaWNrLmJpbmQocHJvY2VzcykKICA6IHJlcXVpcmUoJy4vcXVldWUtbWljcm90YXNrJykKbW9kdWxlLmV4cG9ydHMgPSB0eXBlb2YgcXVldWVNaWNyb3Rhc2sgPT09ICdmdW5jdGlvbicgPyBxdWV1ZU1pY3JvdGFzayA6IChmbikgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmbikKcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCgpleHBvcnRzLmdldCA9IGZ1bmN0aW9uIGdldChmaWVsZCwgYml0KSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9nZXQodG9CdWZmZXIoZmllbGQpLCBiaXQpICE9PSAwCn0KCmV4cG9ydHMuc2V0ID0gZnVuY3Rpb24gc2V0KGZpZWxkLCBiaXQsIHZhbHVlID0gdHJ1ZSkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfc2V0KHRvQnVmZmVyKGZpZWxkKSwgYml0LCB2YWx1ZSA/IDEgOiAwKSAhPT0gMAp9CgpleHBvcnRzLmZpbGwgPSBmdW5jdGlvbiBmaWxsKAogIGZpZWxkLAogIHZhbHVlLAogIHN0YXJ0ID0gMCwKICBlbmQgPSBmaWVsZC5ieXRlTGVuZ3RoICogOAopIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgKz0gbgogIGlmIChlbmQgPCAwKSBlbmQgKz0gbgogIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gZmllbGQuYnl0ZUxlbmd0aCAqIDggfHwgc3RhcnQgPj0gZW5kKSByZXR1cm4gZmllbGQKCiAgYmluZGluZy5xdWlja2JpdF9uYXBpX2ZpbGwodG9CdWZmZXIoZmllbGQpLCB2YWx1ZSA/IDEgOiAwLCBzdGFydCwgZW5kKQogIHJldHVybiBmaWVsZAp9CgpleHBvcnRzLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoZmllbGQsIC4uLmNodW5rcykgewogIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9jbGVhcih0b0J1ZmZlcihmaWVsZCksIGNodW5rcy5tYXAodG9CdWZmZXJDaHVuaykpCn0KCmV4cG9ydHMuZmluZEZpcnN0ID0gZnVuY3Rpb24gZmluZEZpcnN0KGZpZWxkLCB2YWx1ZSwgcG9zaXRpb24gPSAwKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiA9IDAKICBpZiAocG9zaXRpb24gPj0gbikgcmV0dXJuIC0xCgogIHJldHVybiBiaW5kaW5nLnF1aWNrYml0X25hcGlfZmluZF9maXJzdCgKICAgIHRvQnVmZmVyKGZpZWxkKSwKICAgIHZhbHVlID8gMSA6IDAsCiAgICBwb3NpdGlvbgogICkKfQoKZXhwb3J0cy5maW5kTGFzdCA9IGZ1bmN0aW9uIGZpbmRMYXN0KAogIGZpZWxkLAogIHZhbHVlLAogIHBvc2l0aW9uID0gZmllbGQuYnl0ZUxlbmd0aCAqIDggLSAxCikgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgaWYgKHBvc2l0aW9uIDwgMCkgcmV0dXJuIC0xCiAgaWYgKHBvc2l0aW9uID49IG4pIHBvc2l0aW9uID0gbiAtIDEKCiAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9maW5kX2xhc3QoCiAgICB0b0J1ZmZlcihmaWVsZCksCiAgICB2YWx1ZSA/IDEgOiAwLAogICAgcG9zaXRpb24KICApCn0KCmZ1bmN0aW9uIHRvQnVmZmVyKGZpZWxkKSB7CiAgaWYgKGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UID09PSAxKSByZXR1cm4gZmllbGQKICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZmllbGQuYnVmZmVyLCBmaWVsZC5ieXRlT2Zmc2V0LCBmaWVsZC5ieXRlTGVuZ3RoKQp9CgpmdW5jdGlvbiB0b0J1ZmZlckNodW5rKGNodW5rKSB7CiAgcmV0dXJuIHsgZmllbGQ6IHRvQnVmZmVyKGNodW5rLmZpZWxkKSwgb2Zmc2V0OiBjaHVuay5vZmZzZXQgfQp9CgpjbGFzcyBJbmRleCB7CiAgc3RhdGljIGZyb20oZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCA9IC0xKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShmaWVsZE9yQ2h1bmtzKSkgewogICAgICByZXR1cm4gbmV3IFNwYXJzZUluZGV4KGZpZWxkT3JDaHVua3MsIGJ5dGVMZW5ndGgpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IERlbnNlSW5kZXgoZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCkKICAgIH0KICB9CgogIGNvbnN0cnVjdG9yKGJ5dGVMZW5ndGgpIHsKICAgIHRoaXMuX2J5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgICB0aGlzLmhhbmRsZSA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShiaW5kaW5nLnNpemVvZl9xdWlja2JpdF9pbmRleF90KQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fYnl0ZUxlbmd0aAogIH0KCiAgc2tpcEZpcnN0KHZhbHVlLCBwb3NpdGlvbiA9IDApIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gPSAwCiAgICBpZiAocG9zaXRpb24gPj0gbikgcmV0dXJuIG4gLSAxCgogICAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9za2lwX2ZpcnN0KAogICAgICB0aGlzLmhhbmRsZSwKICAgICAgdGhpcy5ieXRlTGVuZ3RoLAogICAgICB2YWx1ZSA/IDEgOiAwLAogICAgICBwb3NpdGlvbgogICAgKQogIH0KCiAgc2tpcExhc3QodmFsdWUsIHBvc2l0aW9uID0gdGhpcy5ieXRlTGVuZ3RoICogOCAtIDEpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogICAgaWYgKHBvc2l0aW9uIDwgMCkgcmV0dXJuIDAKICAgIGlmIChwb3NpdGlvbiA+PSBuKSBwb3NpdGlvbiA9IG4gLSAxCgogICAgcmV0dXJuIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9za2lwX2xhc3QoCiAgICAgIHRoaXMuaGFuZGxlLAogICAgICB0aGlzLmJ5dGVMZW5ndGgsCiAgICAgIHZhbHVlID8gMSA6IDAsCiAgICAgIHBvc2l0aW9uCiAgICApCiAgfQp9CgpleHBvcnRzLkluZGV4ID0gSW5kZXgKCmNsYXNzIERlbnNlSW5kZXggZXh0ZW5kcyBJbmRleCB7CiAgY29uc3RydWN0b3IoZmllbGQsIGJ5dGVMZW5ndGgpIHsKICAgIHN1cGVyKGJ5dGVMZW5ndGgpCiAgICB0aGlzLmZpZWxkID0gZmllbGQKCiAgICBiaW5kaW5nLnF1aWNrYml0X25hcGlfaW5kZXhfaW5pdCh0aGlzLmhhbmRsZSwgdG9CdWZmZXIodGhpcy5maWVsZCkpCiAgfQoKICBnZXQgYnl0ZUxlbmd0aCgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIHJldHVybiB0aGlzLmZpZWxkLmJ5dGVMZW5ndGgKICB9CgogIHVwZGF0ZShiaXQpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogICAgcmV0dXJuICgKICAgICAgYmluZGluZy5xdWlja2JpdF9uYXBpX2luZGV4X3VwZGF0ZSgKICAgICAgICB0aGlzLmhhbmRsZSwKICAgICAgICB0b0J1ZmZlcih0aGlzLmZpZWxkKSwKICAgICAgICBiaXQKICAgICAgKSAhPT0gMAogICAgKQogIH0KfQoKZnVuY3Rpb24gc2VsZWN0Q2h1bmsoY2h1bmtzLCBvZmZzZXQpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgbmV4dCA9IGNodW5rc1tpXQoKICAgIGNvbnN0IHN0YXJ0ID0gbmV4dC5vZmZzZXQKICAgIGNvbnN0IGVuZCA9IG5leHQub2Zmc2V0ICsgbmV4dC5maWVsZC5ieXRlTGVuZ3RoCgogICAgaWYgKG9mZnNldCA+PSBzdGFydCAmJiBvZmZzZXQgKyAxNiA8PSBlbmQpIHsKICAgICAgcmV0dXJuIG5leHQKICAgIH0KICB9CgogIHJldHVybiBudWxsCn0KCmNsYXNzIFNwYXJzZUluZGV4IGV4dGVuZHMgSW5kZXggewogIGNvbnN0cnVjdG9yKGNodW5rcywgYnl0ZUxlbmd0aCkgewogICAgc3VwZXIoYnl0ZUxlbmd0aCkKICAgIHRoaXMuY2h1bmtzID0gY2h1bmtzCgogICAgYmluZGluZy5xdWlja2JpdF9uYXBpX2luZGV4X2luaXRfc3BhcnNlKAogICAgICB0aGlzLmhhbmRsZSwKICAgICAgdGhpcy5jaHVua3MubWFwKHRvQnVmZmVyQ2h1bmspCiAgICApCiAgfQoKICBnZXQgYnl0ZUxlbmd0aCgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmNodW5rc1t0aGlzLmNodW5rcy5sZW5ndGggLSAxXQogICAgcmV0dXJuIGxhc3QgPyBsYXN0Lm9mZnNldCArIGxhc3QuZmllbGQuYnl0ZUxlbmd0aCA6IDAKICB9CgogIHVwZGF0ZShiaXQpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmJ5dGVMZW5ndGggKiA4CgogICAgaWYgKGJpdCA8IDApIGJpdCArPSBuCiAgICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaiA9IE1hdGguZmxvb3IoYml0IC8gMTI4KQoKICAgIGNvbnN0IG9mZnNldCA9IGogKiAxNgoKICAgIGNvbnN0IGNodW5rID0gc2VsZWN0Q2h1bmsodGhpcy5jaHVua3MsIG9mZnNldCkKCiAgICBpZiAoY2h1bmsgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIHJldHVybiAoCiAgICAgIGJpbmRpbmcucXVpY2tiaXRfbmFwaV9pbmRleF91cGRhdGVfc3BhcnNlKAogICAgICAgIHRoaXMuaGFuZGxlLAogICAgICAgIHRvQnVmZmVyKGNodW5rLmZpZWxkKSwKICAgICAgICBjaHVuay5vZmZzZXQsCiAgICAgICAgYml0CiAgICAgICkgIT09IDAKICAgICkKICB9Cn0KewogICJuYW1lIjogInF1aWNrYml0LW5hdGl2ZSIsCiAgInZlcnNpb24iOiAiMi40LjgiLAogICJkZXNjcmlwdGlvbiI6ICJsaWJxdWlja2JpdCBKYXZhU2NyaXB0IGJpbmRpbmdzIGZvciBOb2RlLmpzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIiwKICAgICJtYWNyb3MuaCIsCiAgICAiYmluZGluZy5jYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgInByZWJ1aWxkcyIKICBdLAogICJhZGRvbiI6IHRydWUsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJucG0gcnVuIGxpbnQgJiYgbnBtIHJ1biB0ZXN0OmJhcmUgJiYgbnBtIHJ1biB0ZXN0Om5vZGUiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QubWpzIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0Lm1qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAuIC0tY2hlY2siCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtbmF0aXZlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LW5hdGl2ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LW5hdGl2ZSNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4xLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjciLAogICAgImJhcmUtY29tcGF0LW5hcGkiOiAiXjEuMy4yIiwKICAgICJicml0dGxlIjogIl4zLjEuMCIsCiAgICAiY21ha2UtYmFyZSI6ICJeMS4xLjciLAogICAgImNtYWtlLWZldGNoIjogIl4xLjEuMCIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4wLjIiLAogICAgInByZXR0aWVyIjogIl4zLjUuMyIsCiAgICAicHJldHRpZXItY29uZmlnLXN0YW5kYXJkIjogIl43LjAuMCIKICB9Cn0KY29uc3Qgc2ltZGxlID0gcmVxdWlyZSgnc2ltZGxlLXVuaXZlcnNhbCcpCgpjb25zdCBJTkRFWF9MRU4gPSAoMTYgLyogcm9vdCAqLyArIDEyOCAqIDE2IC8qIGNoaWxkcmVuICovKSAqIDIKCmNvbnN0IGdldCA9IGV4cG9ydHMuZ2V0ID0gZnVuY3Rpb24gZ2V0IChmaWVsZCwgYml0KSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogIGlmIChiaXQgPCAwIHx8IGJpdCA+PSBuKSByZXR1cm4gZmFsc2UKCiAgY29uc3QgbSA9IGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBjb25zdCBvZmZzZXQgPSBiaXQgJiAobSAtIDEpCiAgY29uc3QgaSA9IChiaXQgLSBvZmZzZXQpIC8gbQoKICByZXR1cm4gKGZpZWxkW2ldICYgKDEgPDwgb2Zmc2V0KSkgIT09IDAKfQoKY29uc3Qgc2V0ID0gZXhwb3J0cy5zZXQgPSBmdW5jdGlvbiBzZXQgKGZpZWxkLCBiaXQsIHZhbHVlID0gdHJ1ZSkgewogIGNvbnN0IG4gPSBmaWVsZC5ieXRlTGVuZ3RoICogOAoKICBpZiAoYml0IDwgMCkgYml0ICs9IG4KICBpZiAoYml0IDwgMCB8fCBiaXQgPj0gbikgcmV0dXJuIGZhbHNlCgogIGNvbnN0IG0gPSBmaWVsZC5CWVRFU19QRVJfRUxFTUVOVCAqIDgKCiAgY29uc3Qgb2Zmc2V0ID0gYml0ICYgKG0gLSAxKQogIGNvbnN0IGkgPSAoYml0IC0gb2Zmc2V0KSAvIG0KICBjb25zdCBtYXNrID0gMSA8PCBvZmZzZXQKCiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoKGZpZWxkW2ldICYgbWFzaykgIT09IDApIHJldHVybiBmYWxzZQogIH0gZWxzZSB7CiAgICBpZiAoKGZpZWxkW2ldICYgbWFzaykgPT09IDApIHJldHVybiBmYWxzZQogIH0KCiAgZmllbGRbaV0gXj0gbWFzawoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLmZpbGwgPSBmdW5jdGlvbiBmaWxsIChmaWVsZCwgdmFsdWUsIHN0YXJ0ID0gMCwgZW5kID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgKz0gbgogIGlmIChlbmQgPCAwKSBlbmQgKz0gbgogIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gZmllbGQuYnl0ZUxlbmd0aCAqIDggfHwgc3RhcnQgPj0gZW5kKSByZXR1cm4gZmllbGQKCiAgY29uc3QgbSA9IGZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UICogOAoKICBsZXQgaSwgagoKICB7CiAgICBjb25zdCBvZmZzZXQgPSBzdGFydCAmIChtIC0gMSkKICAgIGkgPSAoc3RhcnQgLSBvZmZzZXQpIC8gbQoKICAgIGlmIChvZmZzZXQgIT09IDApIHsKICAgICAgbGV0IHNoaWZ0ID0gbSAtIG9mZnNldAogICAgICBpZiAoZW5kIC0gc3RhcnQgPCBzaGlmdCkgc2hpZnQgPSBlbmQgLSBzdGFydAoKICAgICAgY29uc3QgbWFzayA9ICgoMSA8PCBzaGlmdCkgLSAxKSA8PCBvZmZzZXQKCiAgICAgIGlmICh2YWx1ZSkgZmllbGRbaV0gfD0gbWFzawogICAgICBlbHNlIGZpZWxkW2ldICY9IH5tYXNrCgogICAgICBpKysKICAgIH0KICB9CgogIHsKICAgIGNvbnN0IG9mZnNldCA9IGVuZCAmIChtIC0gMSkKICAgIGogPSAoZW5kIC0gb2Zmc2V0KSAvIG0KCiAgICBpZiAob2Zmc2V0ICE9PSAwICYmIGogPj0gaSkgewogICAgICBjb25zdCBtYXNrID0gKDEgPDwgb2Zmc2V0KSAtIDEKCiAgICAgIGlmICh2YWx1ZSkgZmllbGRbal0gfD0gbWFzawogICAgICBlbHNlIGZpZWxkW2pdICY9IH5tYXNrCiAgICB9CiAgfQoKICBpZiAoaSA8IGopIGZpZWxkLmZpbGwodmFsdWUgPyAoMiAqKiBtKSAtIDEgOiAwLCBpLCBqKQoKICByZXR1cm4gZmllbGQKfQoKZXhwb3J0cy5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyIChmaWVsZCwgLi4uY2h1bmtzKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGgKCiAgZm9yIChjb25zdCBjaHVuayBvZiBjaHVua3MpIHsKICAgIGlmIChjaHVuay5vZmZzZXQgPj0gbikgY29udGludWUKCiAgICBjb25zdCBtID0gY2h1bmsuZmllbGQuYnl0ZUxlbmd0aAoKICAgIGxldCBpID0gY2h1bmsub2Zmc2V0CiAgICBsZXQgaiA9IDAKCiAgICB3aGlsZSAoKChpICYgMTUpICE9PSAwIHx8IChqICYgMTUpICE9PSAwKSAmJiBpIDwgbiAmJiBqIDwgbSkgewogICAgICBmaWVsZFtpXSA9IGZpZWxkW2ldICYgfmNodW5rLmZpZWxkW2pdCiAgICAgIGkrKwogICAgICBqKysKICAgIH0KCiAgICBpZiAoaSArIDE1IDwgbiAmJiBqICsgMTUgPCBtKSB7CiAgICAgIGNvbnN0IGxlbiA9IE1hdGgubWluKG4gLSAobiAmIDE1KSAtIGksIG0gLSAobSAmIDE1KSAtIGopCgogICAgICBzaW1kbGUuY2xlYXIoZmllbGQuc3ViYXJyYXkoaSwgaSArIGxlbiksIGNodW5rLmZpZWxkLnN1YmFycmF5KGosIGogKyBsZW4pLCBmaWVsZC5zdWJhcnJheShpLCBpICsgbGVuKSkKICAgIH0KCiAgICB3aGlsZSAoaSA8IG4gJiYgaiA8IG0pIHsKICAgICAgZmllbGRbaV0gPSBmaWVsZFtpXSAmIH5jaHVuay5maWVsZFtqXQogICAgICBpKysKICAgICAgaisrCiAgICB9CiAgfQp9CgpmdW5jdGlvbiBiaXRPZmZzZXQgKGJpdCwgb2Zmc2V0KSB7CiAgcmV0dXJuICFiaXQgPyBvZmZzZXQgOiAoSU5ERVhfTEVOICogOCAvIDIpICsgb2Zmc2V0Cn0KCmZ1bmN0aW9uIGJ5dGVPZmZzZXQgKGJpdCwgb2Zmc2V0KSB7CiAgcmV0dXJuICFiaXQgPyBvZmZzZXQgOiAoSU5ERVhfTEVOIC8gMikgKyBvZmZzZXQKfQoKZXhwb3J0cy5maW5kRmlyc3QgPSBmdW5jdGlvbiBmaW5kRmlyc3QgKGZpZWxkLCB2YWx1ZSwgcG9zaXRpb24gPSAwKSB7CiAgY29uc3QgbiA9IGZpZWxkLmJ5dGVMZW5ndGggKiA4CgogIGlmIChwb3NpdGlvbiA8IDApIHBvc2l0aW9uICs9IG4KICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiA9IDAKICBpZiAocG9zaXRpb24gPj0gbikgcmV0dXJuIC0xCgogIHZhbHVlID0gISF2YWx1ZQoKICBmb3IgKGxldCBpID0gcG9zaXRpb247IGkgPCBuOyBpKyspIHsKICAgIGlmIChnZXQoZmllbGQsIGkpID09PSB2YWx1ZSkgcmV0dXJuIGkKICB9CgogIHJldHVybiAtMQp9CgpleHBvcnRzLmZpbmRMYXN0ID0gZnVuY3Rpb24gZmluZExhc3QgKGZpZWxkLCB2YWx1ZSwgcG9zaXRpb24gPSBmaWVsZC5ieXRlTGVuZ3RoICogOCAtIDEpIHsKICBjb25zdCBuID0gZmllbGQuYnl0ZUxlbmd0aCAqIDgKCiAgaWYgKHBvc2l0aW9uIDwgMCkgcG9zaXRpb24gKz0gbgogIGlmIChwb3NpdGlvbiA8IDApIHJldHVybiAtMQogIGlmIChwb3NpdGlvbiA+PSBuKSBwb3NpdGlvbiA9IG4gLSAxCgogIHZhbHVlID0gISF2YWx1ZQoKICBmb3IgKGxldCBpID0gcG9zaXRpb247IGkgPj0gMDsgaS0tKSB7CiAgICBpZiAoZ2V0KGZpZWxkLCBpKSA9PT0gdmFsdWUpIHJldHVybiBpCiAgfQoKICByZXR1cm4gLTEKfQoKY29uc3QgSW5kZXggPSBleHBvcnRzLkluZGV4ID0gY2xhc3MgSW5kZXggewogIHN0YXRpYyBmcm9tIChmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoID0gLTEpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGZpZWxkT3JDaHVua3MpKSB7CiAgICAgIHJldHVybiBuZXcgU3BhcnNlSW5kZXgoZmllbGRPckNodW5rcywgYnl0ZUxlbmd0aCkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgRGVuc2VJbmRleChmaWVsZE9yQ2h1bmtzLCBieXRlTGVuZ3RoKQogICAgfQogIH0KCiAgY29uc3RydWN0b3IgKGJ5dGVMZW5ndGgpIHsKICAgIHRoaXMuX2J5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgICB0aGlzLmhhbmRsZSA9IG5ldyBVaW50MzJBcnJheShJTkRFWF9MRU4gLyA0KQogIH0KCiAgZ2V0IGJ5dGVMZW5ndGggKCkgewogICAgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICB9CgogIHNraXBGaXJzdCAodmFsdWUsIHBvc2l0aW9uID0gMCkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiA9IDAKICAgIGlmIChwb3NpdGlvbiA+PSBuKSByZXR1cm4gbiAtIDEKCiAgICBsZXQgaSA9IE1hdGguZmxvb3IocG9zaXRpb24gLyAxNjM4NCkKCiAgICBpZiAoaSA+IDEyNykgcmV0dXJuIHBvc2l0aW9uCgogICAgd2hpbGUgKGkgPD0gMTI3ICYmIGdldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHZhbHVlLCBpKSkpIHsKICAgICAgaSsrCiAgICB9CgogICAgaWYgKGkgPT09IDEyOCkgcmV0dXJuIG4gLSAxCgogICAgbGV0IGsgPSBpICogMTYzODQKICAgIGxldCBqID0gMAoKICAgIGlmIChwb3NpdGlvbiA+IGspIGogPSBNYXRoLmZsb29yKChwb3NpdGlvbiAtIGspIC8gMTI4KQoKICAgIHdoaWxlIChqIDw9IDEyNyAmJiBnZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh2YWx1ZSwgaSAqIDEyOCArIGogKyAxMjgpKSkgewogICAgICBqKysKICAgICAgayArPSAxMjgKICAgIH0KCiAgICBpZiAoaiA9PT0gMTI4ICYmIGkgIT09IDEyNykgcmV0dXJuIHRoaXMuc2tpcEZpcnN0KHZhbHVlLCAoaSArIDEpICogMTYzODQpCgogICAgaWYgKGsgPiBwb3NpdGlvbikgcG9zaXRpb24gPSBrCgogICAgcmV0dXJuIHBvc2l0aW9uIDwgbiA/IHBvc2l0aW9uIDogbiAtIDEKICB9CgogIHNraXBMYXN0ICh2YWx1ZSwgcG9zaXRpb24gPSB0aGlzLmJ5dGVMZW5ndGggKiA4IC0gMSkgewogICAgY29uc3QgbiA9IHRoaXMuYnl0ZUxlbmd0aCAqIDgKCiAgICBpZiAocG9zaXRpb24gPCAwKSBwb3NpdGlvbiArPSBuCiAgICBpZiAocG9zaXRpb24gPCAwKSByZXR1cm4gMAogICAgaWYgKHBvc2l0aW9uID49IG4pIHBvc2l0aW9uID0gbiAtIDEKCiAgICBsZXQgaSA9IE1hdGguZmxvb3IocG9zaXRpb24gLyAxNjM4NCkKCiAgICBpZiAoaSA+IDEyNykgcmV0dXJuIHBvc2l0aW9uCgogICAgd2hpbGUgKGkgPj0gMCAmJiBnZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh2YWx1ZSwgaSkpKSB7CiAgICAgIGktLQogICAgfQoKICAgIGlmIChpID09PSAtMSkgcmV0dXJuIDAKCiAgICBsZXQgayA9ICgoaSArIDEpICogMTYzODQpIC0gMQogICAgbGV0IGogPSAxMjcKCiAgICBpZiAocG9zaXRpb24gPCBrKSBqID0gMTI4IC0gTWF0aC5jZWlsKChrIC0gcG9zaXRpb24pIC8gMTI4KQoKICAgIHdoaWxlIChqID49IDAgJiYgZ2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodmFsdWUsIGkgKiAxMjggKyBqICsgMTI4KSkpIHsKICAgICAgai0tCiAgICAgIGsgLT0gMTI4CiAgICB9CgogICAgaWYgKGogPT09IC0xICYmIGkgIT09IDApIHJldHVybiB0aGlzLnNraXBMYXN0KHZhbHVlLCBpICogMTYzODQgLSAxKQoKICAgIGlmIChrIDwgcG9zaXRpb24pIHBvc2l0aW9uID0gawoKICAgIHJldHVybiBwb3NpdGlvbgogIH0KfQoKY2xhc3MgRGVuc2VJbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvciAoZmllbGQsIGJ5dGVMZW5ndGgpIHsKICAgIHN1cGVyKGJ5dGVMZW5ndGgpCiAgICB0aGlzLmZpZWxkID0gZmllbGQKCiAgICBjb25zdCBtID0gZmllbGQuQllURVNfUEVSX0VMRU1FTlQKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEyODsgaSsrKSB7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMTI4OyBqKyspIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSAoaSAqIDEyOCArIGopICogMTYKICAgICAgICBsZXQgYWxseiA9IHRydWUKICAgICAgICBsZXQgYWxsbyA9IGZhbHNlCgogICAgICAgIGlmIChvZmZzZXQgKyAxNiA8PSB0aGlzLmZpZWxkLmJ5dGVMZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IHZlYyA9IHRoaXMuZmllbGQuc3ViYXJyYXkob2Zmc2V0IC8gbSwgKG9mZnNldCArIDE2KSAvIG0pCgogICAgICAgICAgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgICAgICAgIGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBrID0gaSAqIDEyOCArIDEyOCArIGoKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGspLCBhbGx6KQogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGspLCBhbGxvKQogICAgICB9CgogICAgICB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldChmYWxzZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgaSksIGFsbG8pCiAgICAgIH0KCiAgICAgIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KHRydWUsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgaSksIGFsbG8pCiAgICAgIH0KICAgIH0KICB9CgogIGdldCBieXRlTGVuZ3RoICgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIHJldHVybiB0aGlzLmZpZWxkLmJ5dGVMZW5ndGgKICB9CgogIHVwZGF0ZSAoYml0KSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogICAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IG0gPSB0aGlzLmZpZWxkLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgY29uc3QgaSA9IE1hdGguZmxvb3IoYml0IC8gMTYzODQpCiAgICBjb25zdCBqID0gTWF0aC5mbG9vcihiaXQgLyAxMjgpCgogICAgY29uc3Qgb2Zmc2V0ID0gKGogKiAxNikgLyBtCiAgICBjb25zdCB2ZWMgPSB0aGlzLmZpZWxkLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgKDE2IC8gbSkpCgogICAgY29uc3QgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCgogICAgbGV0IGNoYW5nZWQgPSBmYWxzZQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgMTI4ICsgaiksIGFsbHopKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlCgogICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KGZhbHNlLCBpICogMTYgKyAxNikgLyA0CiAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGkpLCBhbGxvKQogICAgfQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCAxMjggKyBqKSwgYWxsbykpIHsKICAgICAgY2hhbmdlZCA9IHRydWUKCiAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQodHJ1ZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGkpLCBhbGxvKQogICAgfQoKICAgIHJldHVybiBjaGFuZ2VkCiAgfQp9CgpmdW5jdGlvbiBzZWxlY3RDaHVuayAoY2h1bmtzLCBvZmZzZXQpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgbmV4dCA9IGNodW5rc1tpXQoKICAgIGNvbnN0IHN0YXJ0ID0gbmV4dC5vZmZzZXQKICAgIGNvbnN0IGVuZCA9IG5leHQub2Zmc2V0ICsgbmV4dC5maWVsZC5ieXRlTGVuZ3RoCgogICAgaWYgKG9mZnNldCA+PSBzdGFydCAmJiBvZmZzZXQgKyAxNiA8PSBlbmQpIHsKICAgICAgcmV0dXJuIG5leHQKICAgIH0KICB9CgogIHJldHVybiBudWxsCn0KCmNsYXNzIFNwYXJzZUluZGV4IGV4dGVuZHMgSW5kZXggewogIGNvbnN0cnVjdG9yIChjaHVua3MsIGJ5dGVMZW5ndGgpIHsKICAgIHN1cGVyKGJ5dGVMZW5ndGgpCiAgICB0aGlzLmNodW5rcyA9IGNodW5rcwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTI4OyBpKyspIHsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAxMjg7IGorKykgewogICAgICAgIGNvbnN0IG9mZnNldCA9IChpICogMTI4ICsgaikgKiAxNgogICAgICAgIGxldCBhbGx6ID0gdHJ1ZQogICAgICAgIGxldCBhbGxvID0gZmFsc2UKCiAgICAgICAgY29uc3QgY2h1bmsgPSBzZWxlY3RDaHVuayh0aGlzLmNodW5rcywgb2Zmc2V0KQoKICAgICAgICBpZiAoY2h1bmsgIT09IG51bGwpIHsKICAgICAgICAgIGNvbnN0IG0gPSBjaHVuay5maWVsZC5CWVRFU19QRVJfRUxFTUVOVAoKICAgICAgICAgIGNvbnN0IHZlYyA9IGNodW5rLmZpZWxkLnN1YmFycmF5KChvZmZzZXQgLSBjaHVuay5vZmZzZXQpIC8gbSwgKG9mZnNldCAtIGNodW5rLm9mZnNldCArIDE2KSAvIG0pCgogICAgICAgICAgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgICAgICAgIGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCiAgICAgICAgfQoKICAgICAgICBjb25zdCBrID0gaSAqIDEyOCArIDEyOCArIGoKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGspLCBhbGx6KQogICAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGspLCBhbGxvKQogICAgICB9CgogICAgICB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gYnl0ZU9mZnNldChmYWxzZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgICBzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgaSksIGFsbG8pCiAgICAgIH0KCiAgICAgIHsKICAgICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KHRydWUsIGkgKiAxNiArIDE2KSAvIDQKICAgICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQodHJ1ZSwgaSksIGFsbG8pCiAgICAgIH0KICAgIH0KICB9CgogIGdldCBieXRlTGVuZ3RoICgpIHsKICAgIGlmICh0aGlzLl9ieXRlTGVuZ3RoICE9PSAtMSkgcmV0dXJuIHRoaXMuX2J5dGVMZW5ndGgKICAgIGNvbnN0IGxhc3QgPSB0aGlzLmNodW5rc1t0aGlzLmNodW5rcy5sZW5ndGggLSAxXQogICAgcmV0dXJuIGxhc3QgPyBsYXN0Lm9mZnNldCArIGxhc3QuZmllbGQuYnl0ZUxlbmd0aCA6IDAKICB9CgogIHVwZGF0ZSAoYml0KSB7CiAgICBjb25zdCBuID0gdGhpcy5ieXRlTGVuZ3RoICogOAoKICAgIGlmIChiaXQgPCAwKSBiaXQgKz0gbgogICAgaWYgKGJpdCA8IDAgfHwgYml0ID49IG4pIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IGkgPSBNYXRoLmZsb29yKGJpdCAvIDE2Mzg0KQogICAgY29uc3QgaiA9IE1hdGguZmxvb3IoYml0IC8gMTI4KQoKICAgIGNvbnN0IG9mZnNldCA9IGogKiAxNgoKICAgIGNvbnN0IGNodW5rID0gc2VsZWN0Q2h1bmsodGhpcy5jaHVua3MsIG9mZnNldCkKCiAgICBpZiAoY2h1bmsgPT09IG51bGwpIHJldHVybiBmYWxzZQoKICAgIGNvbnN0IG0gPSBjaHVuay5maWVsZC5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGNvbnN0IHZlYyA9IGNodW5rLmZpZWxkLnN1YmFycmF5KChvZmZzZXQgLSBjaHVuay5vZmZzZXQpIC8gbSwgKG9mZnNldCAtIGNodW5rLm9mZnNldCArIDE2KSAvIG0pCgogICAgY29uc3QgYWxseiA9IHNpbWRsZS5hbGx6KHZlYykKICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh2ZWMpCgogICAgbGV0IGNoYW5nZWQgPSBmYWxzZQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldChmYWxzZSwgMTI4ICsgaiksIGFsbHopKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlCgogICAgICBjb25zdCBvZmZzZXQgPSBieXRlT2Zmc2V0KGZhbHNlLCBpICogMTYgKyAxNikgLyA0CiAgICAgIGNvbnN0IGFsbG8gPSBzaW1kbGUuYWxsbyh0aGlzLmhhbmRsZS5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIDQpKQoKICAgICAgc2V0KHRoaXMuaGFuZGxlLCBiaXRPZmZzZXQoZmFsc2UsIGkpLCBhbGxvKQogICAgfQoKICAgIGlmIChzZXQodGhpcy5oYW5kbGUsIGJpdE9mZnNldCh0cnVlLCAxMjggKyBqKSwgYWxsbykpIHsKICAgICAgY2hhbmdlZCA9IHRydWUKCiAgICAgIGNvbnN0IG9mZnNldCA9IGJ5dGVPZmZzZXQodHJ1ZSwgaSAqIDE2ICsgMTYpIC8gNAogICAgICBjb25zdCBhbGxvID0gc2ltZGxlLmFsbG8odGhpcy5oYW5kbGUuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyA0KSkKCiAgICAgIHNldCh0aGlzLmhhbmRsZSwgYml0T2Zmc2V0KHRydWUsIGkpLCBhbGxvKQogICAgfQoKICAgIHJldHVybiBjaGFuZ2VkCiAgfQp9CmNvbnN0IGZhbGxiYWNrID0gcmVxdWlyZSgnLi9mYWxsYmFjaycpCgp0cnkgewogIGNvbnN0IG5hdGl2ZSA9IHJlcXVpcmUoJ3F1aWNrYml0LW5hdGl2ZScpCgogIC8vIFRoZXNlIGZ1bmN0aW9ucyBhcmUgZmFzdGVyIGluIEphdmFTY3JpcHQKICBleHBvcnRzLmdldCA9IGZhbGxiYWNrLmdldAogIGV4cG9ydHMuc2V0ID0gZmFsbGJhY2suc2V0CiAgZXhwb3J0cy5maWxsID0gZmFsbGJhY2suZmlsbAoKICAvLyBUaGVzZSBmdW5jdGlvbnMgYXJlIGZhc3RlciBpbiBDCiAgZXhwb3J0cy5jbGVhciA9IG5hdGl2ZS5jbGVhcgogIGV4cG9ydHMuZmluZEZpcnN0ID0gbmF0aXZlLmZpbmRGaXJzdAogIGV4cG9ydHMuZmluZExhc3QgPSBuYXRpdmUuZmluZExhc3QKICBleHBvcnRzLkluZGV4ID0gbmF0aXZlLkluZGV4Cn0gY2F0Y2ggewogIG1vZHVsZS5leHBvcnRzID0gZmFsbGJhY2sKfQp7CiAgIm5hbWUiOiAicXVpY2tiaXQtdW5pdmVyc2FsIiwKICAidmVyc2lvbiI6ICIyLjIuMCIsCiAgImRlc2NyaXB0aW9uIjogIlVuaXZlcnNhbCB3cmFwcGVyIGZvciBsaWJxdWlja2JpdCB3aXRoIGEgSmF2YVNjcmlwdCBmYWxsYmFjayIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJmYWxsYmFjay5qcyIsCiAgICAiaW5kZXguanMiCiAgXSwKICAiYnJvd3NlciI6IHsKICAgICIuL2luZGV4LmpzIjogIi4vZmFsbGJhY2suanMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcXVpY2tiaXQtdW5pdmVyc2FsLmdpdCIKICB9LAogICJhdXRob3IiOiAiS2FzcGVyIElzYWdlciBEYWxzZ2Fyw7AgPGthc3BlckBmdW5rdGlvbmVsLmNvPiIsCiAgImxpY2Vuc2UiOiAiSVNDIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LXVuaXZlcnNhbC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3F1aWNrYml0LXVuaXZlcnNhbCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIsCiAgICAic2ltZGxlLXVuaXZlcnNhbCI6ICJeMS4xLjAiCiAgfSwKICAib3B0aW9uYWxEZXBlbmRlbmNpZXMiOiB7CiAgICAicXVpY2tiaXQtbmF0aXZlIjogIl4yLjIuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfQp9CmNsYXNzIENhY2hlRW50cnkgewogIGNvbnN0cnVjdG9yIChrZXksIGluZGV4LCBtYXApIHsKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLmluZGV4ID0gaW5kZXgKICAgIHRoaXMubWFwID0gbWFwCiAgfQp9CgpjbGFzcyBDYWNoZVZhbHVlIHsKICBjb25zdHJ1Y3RvciAoZW50cnksIHZhbHVlKSB7CiAgICB0aGlzLmVudHJ5ID0gZW50cnkKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogIH0KfQoKY2xhc3MgUmFjaGUgewogIGNvbnN0cnVjdG9yICh7IG1heFNpemUgPSA2NTUzNiwgcGFyZW50ID0gbnVsbCB9ID0ge30pIHsKICAgIHRoaXMubWF4U2l6ZSA9IHBhcmVudD8ubWF4U2l6ZSB8fCBtYXhTaXplCgogICAgdGhpcy5fYXJyYXkgPSBwYXJlbnQ/Ll9hcnJheSB8fCBbXQogICAgdGhpcy5fbWFwID0gbmV3IE1hcCgpCiAgfQoKICBzdGF0aWMgZnJvbSAoY2FjaGUpIHsKICAgIHJldHVybiBjYWNoZSA/IG5ldyB0aGlzKHsgcGFyZW50OiBjYWNoZSB9KSA6IG5ldyB0aGlzKCkKICB9CgogIGdldCBnbG9iYWxTaXplICgpIHsKICAgIHJldHVybiB0aGlzLl9hcnJheS5sZW5ndGgKICB9CgogIGdldCBzaXplICgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuc2l6ZQogIH0KCiAgc3ViICgpIHsKICAgIHJldHVybiBuZXcgUmFjaGUoeyBwYXJlbnQ6IHRoaXMgfSkKICB9CgogIHNldCAoa2V5LCB2YWx1ZSkgeyAvLyB+Y29uc3RhbnQgdGltZQogICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLl9tYXAuZ2V0KGtleSkKICAgIGlmIChleGlzdGluZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGV4aXN0aW5nLnZhbHVlID0gdmFsdWUKICAgICAgcmV0dXJuCiAgICB9CgogICAgaWYgKHRoaXMuX2FycmF5Lmxlbmd0aCA+PSB0aGlzLm1heFNpemUpIHRoaXMuX2djKCkKCiAgICBjb25zdCBlbnRyeSA9IG5ldyBDYWNoZUVudHJ5KGtleSwgdGhpcy5fYXJyYXkubGVuZ3RoLCB0aGlzLl9tYXApCiAgICB0aGlzLl9hcnJheS5wdXNoKGVudHJ5KQogICAgY29uc3QgY2FjaGVWYWx1ZSA9IG5ldyBDYWNoZVZhbHVlKGVudHJ5LCB2YWx1ZSkKICAgIHRoaXMuX21hcC5zZXQoa2V5LCBjYWNoZVZhbHVlKQogIH0KCiAgZGVsZXRlIChrZXkpIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5fbWFwLmdldChrZXkpCiAgICBpZiAoZXhpc3RpbmcgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlCgogICAgdGhpcy5fZGVsZXRlKGV4aXN0aW5nLmVudHJ5LmluZGV4KQogICAgcmV0dXJuIHRydWUKICB9CgogIGdldCAoa2V5KSB7CiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX21hcC5nZXQoa2V5KQogICAgcmV0dXJuIGV4aXN0aW5nID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBleGlzdGluZy52YWx1ZQogIH0KCiAgKiBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIHsgdmFsdWUgfV0gb2YgdGhpcy5fbWFwKSB7CiAgICAgIHlpZWxkIFtrZXksIHZhbHVlXQogICAgfQogIH0KCiAga2V5cyAoKSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLmtleXMoKQogIH0KCiAgKiB2YWx1ZXMgKCkgewogICAgZm9yIChjb25zdCB7IHZhbHVlIH0gb2YgdGhpcy5fbWFwLnZhbHVlcygpKSB7CiAgICAgIHlpZWxkIHZhbHVlCiAgICB9CiAgfQoKICBjbGVhciAoKSB7CiAgICAvLyBUaGUgZW50cmllcyBpbiBtYXAgbGluZ2VyIG9uIGluIF9hcnJheSwKICAgIC8vIHNvIG9uIHRvcCBvZiBjbGVhcmluZyB0aGUgbWFwLCB3ZSBhbHNvIGtpbGwgdGhlIHJlZiwKICAgIC8vIHNvIHRoYXQgYW55IGdjIHJ1bm5pbmcgbGF0ZXIgb24gdGhlIG9sZCBtYXAgd29uJ3QgaW50ZXJmZXJlCiAgICAvLyAoaW4gY2FzZSBhIG5ldyBlbnRyeSB3YXMgYWRkZWQgd2l0aCB0aGUgc2FtZSBrZXkgYXMgYSBjbGVhcmVkIGVudHJ5KQoKICAgIHRoaXMuX21hcC5jbGVhcigpCiAgICB0aGlzLl9tYXAgPSBuZXcgTWFwKCkKICB9CgogIGRlc3Ryb3kgKCkgewogICAgdGhpcy5fbWFwID0gbnVsbAogICAgdGhpcy5fYXJyYXkgPSBudWxsCiAgfQoKICBfZ2MgKCkgewogICAgdGhpcy5fZGVsZXRlKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHRoaXMuX2FycmF5Lmxlbmd0aCkpCiAgfQoKICBfZGVsZXRlIChpbmRleCkgeyAvLyB+Y29uc3RhbnQgdGltZQogICAgaWYgKGluZGV4ID49IHRoaXMuX2FycmF5Lmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZGVsZXRlIHVudXNlZCBpbmRleCAobG9naWMgYnVnPyknKQoKICAgIGNvbnN0IGhlYWQgPSB0aGlzLl9hcnJheS5wb3AoKQogICAgbGV0IHJlbW92ZWQgPSBoZWFkCgogICAgaWYgKGluZGV4IDwgdGhpcy5fYXJyYXkubGVuZ3RoKSB7CiAgICAgIHJlbW92ZWQgPSB0aGlzLl9hcnJheVtpbmRleF0KICAgICAgaGVhZC5pbmRleCA9IGluZGV4CiAgICAgIHRoaXMuX2FycmF5W2luZGV4XSA9IGhlYWQKICAgIH0KCiAgICByZW1vdmVkLm1hcC5kZWxldGUocmVtb3ZlZC5rZXkpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IFJhY2hlCnsKICAibmFtZSI6ICJyYWNoZSIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJSYW5kb20tZXZpY3Rpb24gY2FjaGUiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyAtLWNvdmVyYWdlIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JhY2hlLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JhY2hlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmFjaGUjcmVhZG1lIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjUuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSYW5kb21BcnJheUl0ZXJhdG9yIHsKICBjb25zdHJ1Y3RvciAodmFsdWVzKSB7CiAgICB0aGlzLnZhbHVlcyA9IHZhbHVlcwogICAgdGhpcy5zdGFydCA9IDAKICAgIHRoaXMubGVuZ3RoID0gdGhpcy52YWx1ZXMubGVuZ3RoCiAgfQoKICBuZXh0ICgpIHsKICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAodGhpcy5zdGFydCA9PT0gMCkgcmV0dXJuIHsgZG9uZTogdHJ1ZSwgdmFsdWU6IHVuZGVmaW5lZCB9CiAgICAgIHRoaXMubGVuZ3RoID0gdGhpcy5zdGFydAogICAgICB0aGlzLnN0YXJ0ID0gMAogICAgfQoKICAgIGNvbnN0IGkgPSB0aGlzLnN0YXJ0ICsgKChNYXRoLnJhbmRvbSgpICogdGhpcy5sZW5ndGgpIHwgMCkKICAgIGNvbnN0IGogPSB0aGlzLnN0YXJ0ICsgLS10aGlzLmxlbmd0aAogICAgY29uc3QgdmFsdWUgPSB0aGlzLnZhbHVlc1tpXQoKICAgIHRoaXMudmFsdWVzW2ldID0gdGhpcy52YWx1ZXNbal0KICAgIHRoaXMudmFsdWVzW2pdID0gdmFsdWUKCiAgICByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWUgfQogIH0KCiAgZGVxdWV1ZSAoKSB7CiAgICB0aGlzLnZhbHVlc1t0aGlzLnN0YXJ0ICsgdGhpcy5sZW5ndGhdID0gdGhpcy52YWx1ZXNbdGhpcy52YWx1ZXMubGVuZ3RoIC0gMV0KICAgIHRoaXMudmFsdWVzLnBvcCgpCiAgfQoKICByZXF1ZXVlICgpIHsKICAgIGNvbnN0IGkgPSB0aGlzLnN0YXJ0ICsgdGhpcy5sZW5ndGgKICAgIGNvbnN0IHZhbHVlID0gdGhpcy52YWx1ZXNbaV0KICAgIHRoaXMudmFsdWVzW2ldID0gdGhpcy52YWx1ZXNbdGhpcy5zdGFydF0KICAgIHRoaXMudmFsdWVzW3RoaXMuc3RhcnQrK10gPSB2YWx1ZQogIH0KCiAgcmVzdGFydCAoKSB7CiAgICB0aGlzLnN0YXJ0ID0gMAogICAgdGhpcy5sZW5ndGggPSB0aGlzLnZhbHVlcy5sZW5ndGgKICAgIHJldHVybiB0aGlzCiAgfQoKICBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICByZXR1cm4gdGhpcwogIH0KfQp7CiAgIm5hbWUiOiAicmFuZG9tLWFycmF5LWl0ZXJhdG9yIiwKICAidmVyc2lvbiI6ICIxLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIkFuIGl0ZXJhdG9yIHRvIGl0ZXJhdGUgYW4gYXJyYXkgaW4gcmFuZG9tIG9yZGVyIHdpdGggY29udHJvbHMgdG8gcmVxdWV1ZSBvciBkZXF1ZXVlIGVsZW1lbnRzIGR1cmluZyB0aGUgaXRlcmF0aW9uIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjE2LjAuMyIsCiAgICAidGFwZSI6ICJeNS4wLjEiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yYW5kb20tYXJyYXktaXRlcmF0b3IuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JhbmRvbS1hcnJheS1pdGVyYXRvci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yYW5kb20tYXJyYXktaXRlcmF0b3IiCn0KY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUmVhZHlSZXNvdXJjZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IgKCkgewogICAgc3VwZXIoKQoKICAgIHRoaXMub3BlbmluZyA9IG51bGwKICAgIHRoaXMuY2xvc2luZyA9IG51bGwKCiAgICB0aGlzLm9wZW5lZCA9IGZhbHNlCiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlCiAgfQoKICByZWFkeSAoKSB7CiAgICBpZiAodGhpcy5vcGVuaW5nICE9PSBudWxsKSByZXR1cm4gdGhpcy5vcGVuaW5nCiAgICB0aGlzLm9wZW5pbmcgPSBvcGVuKHRoaXMpCiAgICByZXR1cm4gdGhpcy5vcGVuaW5nCiAgfQoKICBjbG9zZSAoKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nICE9PSBudWxsKSByZXR1cm4gdGhpcy5jbG9zaW5nCiAgICB0aGlzLmNsb3NpbmcgPSBjbG9zZSh0aGlzKQogICAgcmV0dXJuIHRoaXMuY2xvc2luZwogIH0KCiAgYXN5bmMgX29wZW4gKCkgewogICAgLy8gYWRkIGltcGwgaGVyZQogIH0KCiAgYXN5bmMgX2Nsb3NlICgpIHsKICAgIC8vIGFkZCBpbXBsIGhlcmUKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIG9wZW4gKHNlbGYpIHsKICAvLyBvcGVuIGFmdGVyIGNsb3NlCiAgaWYgKHNlbGYuY2xvc2luZyAhPT0gbnVsbCkgcmV0dXJuCgogIHRyeSB7CiAgICBhd2FpdCBzZWxmLl9vcGVuKCkKICB9IGNhdGNoIChlcnIpIHsKICAgIHNlbGYuY2xvc2UoKSAvLyBzYWZlIHRvIHJ1biBpbiBiZwogICAgdGhyb3cgZXJyCiAgfQoKICBzZWxmLm9wZW5lZCA9IHRydWUKICBzZWxmLmVtaXQoJ3JlYWR5JykKfQoKYXN5bmMgZnVuY3Rpb24gY2xvc2UgKHNlbGYpIHsKICB0cnkgewogICAgaWYgKHNlbGYub3BlbmVkID09PSBmYWxzZSAmJiBzZWxmLm9wZW5pbmcgIT09IG51bGwpIGF3YWl0IHNlbGYub3BlbmluZwogIH0gY2F0Y2ggewogICAgLy8gaWdub3JlIGVycm9ycyBvbiBjbG9zaW5nCiAgfQogIGlmIChzZWxmLm9wZW5lZCA9PT0gdHJ1ZSB8fCBzZWxmLm9wZW5pbmcgPT09IG51bGwpIGF3YWl0IHNlbGYuX2Nsb3NlKCkKICBzZWxmLmNsb3NlZCA9IHRydWUKICBzZWxmLmVtaXQoJ2Nsb3NlJykKfQp7CiAgIm5hbWUiOiAicmVhZHktcmVzb3VyY2UiLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiTW9kZXJuIHNpbmdsZSByZXNvdXJjZSBtYW5hZ2VtZW50IiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImltcG9ydHMiOiB7CiAgICAiZXZlbnRzIjogewogICAgICAiYmFyZSI6ICJiYXJlLWV2ZW50cyIsCiAgICAgICJkZWZhdWx0IjogImV2ZW50cyIKICAgIH0KICB9LAogICJ0eXBlcyI6ICJpbmRleC5kLnRzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImluZGV4LmQudHMiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVhZHktcmVzb3VyY2UuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVhZHktcmVzb3VyY2UvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZWFkeS1yZXNvdXJjZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWV2ZW50cyI6ICJeMi4yLjAiCiAgfQp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgp2YXIgRU1QVFkgPSBbXQoKbW9kdWxlLmV4cG9ydHMgPSBSZWNvcmRDYWNoZQoKZnVuY3Rpb24gUmVjb3JkU2V0ICgpIHsKICB0aGlzLmxpc3QgPSBbXQogIHRoaXMubWFwID0gbmV3IE1hcCgpCn0KClJlY29yZFNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKHJlY29yZCwgdmFsdWUpIHsKICB2YXIgayA9IHRvU3RyaW5nKHJlY29yZCkKICB2YXIgciA9IHRoaXMubWFwLmdldChrKQogIGlmIChyKSByZXR1cm4gZmFsc2UKCiAgciA9IHtpbmRleDogdGhpcy5saXN0Lmxlbmd0aCwgcmVjb3JkOiB2YWx1ZSB8fCByZWNvcmR9CiAgdGhpcy5saXN0LnB1c2gocikKICB0aGlzLm1hcC5zZXQoaywgcikKICByZXR1cm4gdHJ1ZQp9CgpSZWNvcmRTZXQucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChyZWNvcmQpIHsKICB2YXIgayA9IHRvU3RyaW5nKHJlY29yZCkKICB2YXIgciA9IHRoaXMubWFwLmdldChrKQogIGlmICghcikgcmV0dXJuIGZhbHNlCgogIHN3YXAodGhpcy5saXN0LCByLmluZGV4LCB0aGlzLmxpc3QubGVuZ3RoIC0gMSkKICB0aGlzLmxpc3QucG9wKCkKICB0aGlzLm1hcC5kZWxldGUoaykKICByZXR1cm4gdHJ1ZQp9CgpmdW5jdGlvbiBSZWNvcmRTdG9yZSAoKSB7CiAgdGhpcy5yZWNvcmRzID0gbmV3IE1hcCgpCiAgdGhpcy5zaXplID0gMAp9CgpSZWNvcmRTdG9yZS5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKG5hbWUsIHJlY29yZCwgdmFsdWUpIHsKICB2YXIgciA9IHRoaXMucmVjb3Jkcy5nZXQobmFtZSkKCiAgaWYgKCFyKSB7CiAgICByID0gbmV3IFJlY29yZFNldCgpCiAgICB0aGlzLnJlY29yZHMuc2V0KG5hbWUsIHIpCiAgfQoKICBpZiAoci5hZGQocmVjb3JkLCB2YWx1ZSkpIHsKICAgIHRoaXMuc2l6ZSsrCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgcmV0dXJuIGZhbHNlCn0KClJlY29yZFN0b3JlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAobmFtZSwgcmVjb3JkLCB2YWx1ZSkgewogIHZhciByID0gdGhpcy5yZWNvcmRzLmdldChuYW1lKQogIGlmICghcikgcmV0dXJuIGZhbHNlCgogIGlmIChyLnJlbW92ZShyZWNvcmQsIHZhbHVlKSkgewogICAgdGhpcy5zaXplLS0KICAgIGlmICghci5tYXAuc2l6ZSkgdGhpcy5yZWNvcmRzLmRlbGV0ZShuYW1lKQogICAgcmV0dXJuIHRydWUKICB9CgogIHJldHVybiBmYWxzZQp9CgpSZWNvcmRTdG9yZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKG5hbWUpIHsKICB2YXIgciA9IHRoaXMucmVjb3Jkcy5nZXQobmFtZSkKICByZXR1cm4gciA/IHIubGlzdCA6IEVNUFRZCn0KCmZ1bmN0aW9uIFJlY29yZENhY2hlIChvcHRzKSB7CiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFJlY29yZENhY2hlKSkgcmV0dXJuIG5ldyBSZWNvcmRDYWNoZShvcHRzKQogIGlmICghb3B0cykgb3B0cyA9IHt9CgogIHRoaXMubWF4U2l6ZSA9IG9wdHMubWF4U2l6ZSB8fCBJbmZpbml0eQogIHRoaXMubWF4QWdlID0gb3B0cy5tYXhBZ2UgfHwgMAoKICB0aGlzLl9vbnN0YWxlID0gb3B0cy5vblN0YWxlIHx8IG9wdHMub25zdGFsZSB8fCBudWxsCiAgdGhpcy5fZnJlc2ggPSBuZXcgUmVjb3JkU3RvcmUoKQogIHRoaXMuX3N0YWxlID0gbmV3IFJlY29yZFN0b3JlKCkKICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKICB0aGlzLl9nY2VkID0gZmFsc2UKCiAgaWYgKHRoaXMubWF4QWdlICYmIHRoaXMubWF4QWdlIDwgSW5maW5pdHkpIHsKICAgIC8vIDIvMyBnaXZlcyB1cyBhIHNwYW4gb2YgMC42Ni0xLjMzIG1heEFnZSBvciBhdmcgbWF4QWdlCiAgICB2YXIgdGljayA9IE1hdGguY2VpbCgyIC8gMyAqIHRoaXMubWF4QWdlKQogICAgdGhpcy5faW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLl9nY0F1dG8uYmluZCh0aGlzKSwgdGljaykKICAgIGlmICh0aGlzLl9pbnRlcnZhbC51bnJlZikgdGhpcy5faW50ZXJ2YWwudW5yZWYoKQogIH0KfQoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFJlY29yZENhY2hlLnByb3RvdHlwZSwgJ3NpemUnLCB7CiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZnJlc2guc2l6ZSArIHRoaXMuX3N0YWxlLnNpemUKICB9Cn0pCgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKG5hbWUsIHJlY29yZCwgdmFsdWUpIHsKICB0aGlzLl9zdGFsZS5yZW1vdmUobmFtZSwgcmVjb3JkLCB2YWx1ZSkKICBpZiAodGhpcy5fZnJlc2guYWRkKG5hbWUsIHJlY29yZCwgdmFsdWUpICYmIHRoaXMuX2ZyZXNoLnNpemUgPiB0aGlzLm1heFNpemUpIHsKICAgIHRoaXMuX2djKCkKICB9Cn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAobmFtZSwgcmVjb3JkLCB2YWx1ZSkgewogIHRoaXMuX2ZyZXNoLnJlbW92ZShuYW1lLCByZWNvcmQsIHZhbHVlKQogIHRoaXMuX3N0YWxlLnJlbW92ZShuYW1lLCByZWNvcmQsIHZhbHVlKQp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKG5hbWUsIG4pIHsKICB2YXIgYSA9IHRoaXMuX2ZyZXNoLmdldChuYW1lKQogIHZhciBiID0gdGhpcy5fc3RhbGUuZ2V0KG5hbWUpCiAgdmFyIGFMZW4gPSBhLmxlbmd0aAogIHZhciBiTGVuID0gYi5sZW5ndGgKICB2YXIgbGVuID0gYUxlbiArIGJMZW4KCiAgaWYgKG4gPiBsZW4gfHwgIW4pIG4gPSBsZW4KICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KG4pCgogIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICB2YXIgaiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChhTGVuICsgYkxlbikpCiAgICBpZiAoaiA8IGFMZW4pIHsKICAgICAgcmVzdWx0W2ldID0gYVtqXS5yZWNvcmQKICAgICAgc3dhcChhLCBqLCAtLWFMZW4pCiAgICB9IGVsc2UgewogICAgICBqIC09IGFMZW4KICAgICAgcmVzdWx0W2ldID0gYltqXS5yZWNvcmQKICAgICAgc3dhcChiLCBqLCAtLWJMZW4pCiAgICB9CiAgfQoKICByZXR1cm4gcmVzdWx0Cn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5fZ2NBdXRvID0gZnVuY3Rpb24gKCkgewogIGlmICghdGhpcy5fZ2NlZCkgdGhpcy5fZ2MoKQogIHRoaXMuX2djZWQgPSBmYWxzZQp9CgpSZWNvcmRDYWNoZS5wcm90b3R5cGUuX2djID0gZnVuY3Rpb24gKCkgewogIGlmICh0aGlzLl9vbnN0YWxlICYmIHRoaXMuX3N0YWxlLnNpemUgPiAwKSB0aGlzLl9vbnN0YWxlKHRoaXMuX3N0YWxlKQogIHRoaXMuX3N0YWxlID0gdGhpcy5fZnJlc2gKICB0aGlzLl9mcmVzaCA9IG5ldyBSZWNvcmRTdG9yZSgpCiAgdGhpcy5fZ2NlZCA9IHRydWUKfQoKUmVjb3JkQ2FjaGUucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKCkgewogIHRoaXMuX2djKCkKICB0aGlzLl9nYygpCn0KClJlY29yZENhY2hlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogIHRoaXMuY2xlYXIoKQogIGNsZWFySW50ZXJ2YWwodGhpcy5faW50ZXJ2YWwpCiAgdGhpcy5faW50ZXJ2YWwgPSBudWxsCn0KCmZ1bmN0aW9uIHRvU3RyaW5nIChyZWNvcmQpIHsKICByZXR1cm4gYjRhLmlzQnVmZmVyKHJlY29yZCkgPyBiNGEudG9TdHJpbmcocmVjb3JkLCAnaGV4JykgOiByZWNvcmQKfQoKZnVuY3Rpb24gc3dhcCAobGlzdCwgYSwgYikgewogIHZhciB0bXAgPSBsaXN0W2FdCiAgdG1wLmluZGV4ID0gYgogIGxpc3RbYl0uaW5kZXggPSBhCiAgbGlzdFthXSA9IGxpc3RbYl0KICBsaXN0W2JdID0gdG1wCn0KewogICJuYW1lIjogInJlY29yZC1jYWNoZSIsCiAgInZlcnNpb24iOiAiMS4yLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDYWNoZSBvcHRpbWlzZWQgZm9yIHJlY29yZCBsaWtlIHRoaW5ncyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjMuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAic3RhbmRhcmQiOiAiXjEwLjAuMyIsCiAgICAidGFwZSI6ICJeNC44LjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZWNvcmQtY2FjaGUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJNYXRoaWFzIEJ1dXMgKEBtYWZpbnRvc2gpIiwKICAibGljZW5zZSI6ICJNSVQiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3JlY29yZC1jYWNoZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZWNvcmQtY2FjaGUiCn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSZWZDb3VudGVyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuY291bnQgPSAwCgogICAgdGhpcy5fb25pZGxlID0gbnVsbAogICAgdGhpcy5faWRsZSA9IG51bGwKICB9CgogIGlzSWRsZSgpIHsKICAgIHJldHVybiB0aGlzLmNvdW50ID09PSAwCiAgfQoKICBpZGxlKCkgewogICAgaWYgKHRoaXMuY291bnQgPT09IDApIHJldHVybiBQcm9taXNlLnJlc29sdmUoKQogICAgaWYgKHRoaXMuX2lkbGUgIT09IG51bGwpIHJldHVybiB0aGlzLl9pZGxlCgogICAgdGhpcy5faWRsZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHRoaXMuX29uaWRsZSA9IHJlc29sdmUKICAgIH0pCgogICAgcmV0dXJuIHRoaXMuX2lkbGUKICB9CgogIGluYygpIHsKICAgIHRoaXMuY291bnQrKwogIH0KCiAgZGVjKCkgewogICAgaWYgKC0tdGhpcy5jb3VudCA+IDApIHJldHVybgoKICAgIGlmICh0aGlzLl9vbmlkbGUgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMuX29uaWRsZQogICAgICB0aGlzLl9pZGxlID0gbnVsbAogICAgICB0aGlzLl9vbmlkbGUgPSBudWxsCiAgICAgIHJlc29sdmUoKQogICAgfQogIH0KfQp7CiAgIm5hbWUiOiAicmVmY291bnRlciIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJTaW1wbGUgcmVmY291bnRlciIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjoge30sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVmY291bnRlci5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVmY291bnRlci9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3JlZmNvdW50ZXIiCn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uLmJpbmQocmVxdWlyZSkKewogICJuYW1lIjogInJlcXVpcmUtYWRkb24iLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiSW1wb3J0IG5hdGl2ZSBhZGRvbnMgYWNyb3NzIEphdmFTY3JpcHQgcnVudGltZXMiLAogICJleHBvcnRzIjogewogICAgIi4vcGFja2FnZSI6ICIuL3BhY2thZ2UuanNvbiIsCiAgICAiLiI6IHsKICAgICAgImJhcmUiOiAiLi9saWIvYmFyZS5qcyIsCiAgICAgICJub2RlIjogIi4vbGliL25vZGUuanMiLAogICAgICAiZGVmYXVsdCI6ICIuL2xpYi9kZWZhdWx0LmpzIgogICAgfQogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiB7CiAgICAgICJiYXJlIjogImJhcmUtZnMiLAogICAgICAiZGVmYXVsdCI6ICJmcyIKICAgIH0sCiAgICAicGF0aCI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1wYXRoIiwKICAgICAgImRlZmF1bHQiOiAicGF0aCIKICAgIH0sCiAgICAidXJsIjogewogICAgICAiYmFyZSI6ICJiYXJlLXVybCIsCiAgICAgICJkZWZhdWx0IjogInVybCIKICAgIH0KICB9LAogICJmaWxlcyI6IFsKICAgICJsaWIiCiAgXSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5qcyIsCiAgICAibGludCI6ICJwcmV0dGllciAtLWNoZWNrIC4iLAogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVxdWlyZS1hZGRvbi5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yZXF1aXJlLWFkZG9uL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcmVxdWlyZS1hZGRvbiNyZWFkbWUiLAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjEwLjAiCiAgfSwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYWRkb24tcmVzb2x2ZSI6ICJeMS4zLjAiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJhcmUtYnVuZGxlIjogIl4xLjguMSIsCiAgICAiYmFyZS1idW5kbGUtZXZhbHVhdGUiOiAiXjEuMS4wIiwKICAgICJiYXJlLWZzIjogIl40LjAuMCIsCiAgICAiYmFyZS1wYXRoIjogIl4zLjAuMCIsCiAgICAiYmFyZS11cmwiOiAiXjIuMS4wIiwKICAgICJicml0dGxlIjogIl4zLjcuMCIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4yLjAuMCIKICB9Cn0KbGV0IHRtcFJlc29sdmUgPSBudWxsCmxldCB0bXBSZWplY3QgPSBudWxsCgppZiAoUHJvbWlzZS53aXRoUmVzb2x2ZXJzKSB7CiAgbW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMuYmluZChQcm9taXNlKQp9IGVsc2UgewogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gcmVzb2x2ZVJlamVjdFByb21pc2UgKCkgewogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHNldFRtcCkKICAgIGNvbnN0IHJlc3VsdCA9IHsgcHJvbWlzZSwgcmVzb2x2ZTogdG1wUmVzb2x2ZSwgcmVqZWN0OiB0bXBSZWplY3QgfQogICAgdG1wUmVzb2x2ZSA9IHRtcFJlamVjdCA9IG51bGwKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIHNldFRtcCAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgdG1wUmVzb2x2ZSA9IHJlc29sdmUKICB0bXBSZWplY3QgPSByZWplY3QKfQp7CiAgIm5hbWUiOiAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSIsCiAgInZlcnNpb24iOiAiMS4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJDcmVhdGUgYW4gaW52ZXJ0ZWQgcHJvbWlzZSB3aXRoIG5vIGZ1bmN0aW9uIGFsbG9jcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xNy4xLjIiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcmVzb2x2ZS1yZWplY3QtcHJvbWlzZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9yZXNvbHZlLXJlamVjdC1wcm9taXNlIgp9CmNvbnN0IHJlc291cmNlcyA9IG5ldyBNYXAoKQoKZXhwb3J0cy5hZGQgPSBmdW5jdGlvbihyZXNvdXJjZSwgdGVhcmRvd24pIHsKICByZXNvdXJjZXMuc2V0KHJlc291cmNlLCB0ZWFyZG93bikKfQoKZXhwb3J0cy5yZW1vdmUgPSBmdW5jdGlvbihyZXNvdXJjZSkgewogIHJlc291cmNlcy5kZWxldGUocmVzb3VyY2UpCn0KCmlmIChnbG9iYWwuQmFyZSkgZ2xvYmFsLkJhcmUub24oJ2V4aXQnLCBydW4pCmVsc2UgZ2xvYmFsLnByb2Nlc3Mub24oJ2V4aXQnLCBydW4pCgpmdW5jdGlvbiBydW4oKSB7CiAgZm9yIChjb25zdCBbcmVzb3VyY2UsIHRlYXJkb3duXSBvZiByZXNvdXJjZXMpIHsKICAgIHRlYXJkb3duKHJlc291cmNlKQogIH0KfQp7CiAgIm5hbWUiOiAicmVzb3VyY2Utb24tZXhpdCIsCiAgInZlcnNpb24iOiAiMS4wLjAiLAogICJkZXNjcmlwdGlvbiI6ICJSZWdpc3RlciBzeW5jIHRlYXJkb3duIGhhbmRsZXJzIGZvciBhIHJlc291cmNlIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHt9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7fSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9iYXJlLXRlYXJkb3duLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIEluYy4iLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vYmFyZS10ZWFyZG93bi9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL2JhcmUtdGVhcmRvd24iCn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgQ29sdW1uRmFtaWx5ID0gcmVxdWlyZSgnLi9saWIvY29sdW1uLWZhbWlseScpCmNvbnN0IEl0ZXJhdG9yID0gcmVxdWlyZSgnLi9saWIvaXRlcmF0b3InKQpjb25zdCBTbmFwc2hvdCA9IHJlcXVpcmUoJy4vbGliL3NuYXBzaG90JykKY29uc3QgU3RhdGUgPSByZXF1aXJlKCcuL2xpYi9zdGF0ZScpCmNvbnN0IHsgQmxvb21GaWx0ZXJQb2xpY3ksIFJpYmJvbkZpbHRlclBvbGljeSB9ID0gcmVxdWlyZSgnLi9saWIvZmlsdGVyLXBvbGljeScpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vbGliL2NvbnN0YW50cycpCgpjbGFzcyBSb2Nrc0RCIHsKICBjb25zdHJ1Y3RvcihwYXRoLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgY29sdW1uRmFtaWx5LAogICAgICBzdGF0ZSA9IG5ldyBTdGF0ZSh0aGlzLCBwYXRoLCBvcHRzKSwKICAgICAgc25hcHNob3QgPSBudWxsLAogICAgICBrZXlFbmNvZGluZyA9IG51bGwsCiAgICAgIHZhbHVlRW5jb2RpbmcgPSBudWxsCiAgICB9ID0gb3B0cwoKICAgIHRoaXMuX3N0YXRlID0gc3RhdGUKICAgIHRoaXMuX3NuYXBzaG90ID0gc25hcHNob3QKICAgIHRoaXMuX2NvbHVtbkZhbWlseSA9IHN0YXRlLmdldENvbHVtbkZhbWlseShjb2x1bW5GYW1pbHkpCiAgICB0aGlzLl9rZXlFbmNvZGluZyA9IGtleUVuY29kaW5nCiAgICB0aGlzLl92YWx1ZUVuY29kaW5nID0gdmFsdWVFbmNvZGluZwogICAgdGhpcy5faW5kZXggPSAtMQoKICAgIHRoaXMuX3N0YXRlLmFkZFNlc3Npb24odGhpcykKICB9CgogIGdldCBvcGVuZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUub3BlbmVkCiAgfQoKICBnZXQgY2xvc2VkKCkgewogICAgcmV0dXJuIHRoaXMuaXNSb290KCkgPyB0aGlzLl9zdGF0ZS5jbG9zZWQgOiB0aGlzLl9pbmRleCA9PT0gLTEKICB9CgogIGdldCBwYXRoKCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlLnBhdGgKICB9CgogIGdldCBzbmFwc2hvdHRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9zbmFwc2hvdCAhPT0gbnVsbAogIH0KCiAgZ2V0IGRlZmF1bHRDb2x1bW5GYW1pbHkoKSB7CiAgICByZXR1cm4gdGhpcy5fY29sdW1uRmFtaWx5CiAgfQoKICBzZXNzaW9uKHsKICAgIGNvbHVtbkZhbWlseSA9IHRoaXMuX2NvbHVtbkZhbWlseSwKICAgIHNuYXBzaG90ID0gdGhpcy5fc25hcHNob3QgIT09IG51bGwsCiAgICBrZXlFbmNvZGluZyA9IHRoaXMuX2tleUVuY29kaW5nLAogICAgdmFsdWVFbmNvZGluZyA9IHRoaXMuX3ZhbHVlRW5jb2RpbmcKICB9ID0ge30pIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIG5ldyBSb2Nrc0RCKG51bGwsIHsKICAgICAgc3RhdGU6IHRoaXMuX3N0YXRlLAogICAgICBjb2x1bW5GYW1pbHksCiAgICAgIHNuYXBzaG90OiBzbmFwc2hvdCA/IHRoaXMuX3NuYXBzaG90IHx8IG5ldyBTbmFwc2hvdCh0aGlzLl9zdGF0ZSkgOiBudWxsLAogICAgICBrZXlFbmNvZGluZywKICAgICAgdmFsdWVFbmNvZGluZwogICAgfSkKICB9CgogIGNvbHVtbkZhbWlseShuYW1lLCBvcHRzKSB7CiAgICByZXR1cm4gdGhpcy5zZXNzaW9uKHsgLi4ub3B0cywgY29sdW1uRmFtaWx5OiBuYW1lIH0pCiAgfQoKICBzbmFwc2hvdCgpIHsKICAgIHJldHVybiB0aGlzLnNlc3Npb24oeyBzbmFwc2hvdDogdHJ1ZSB9KQogIH0KCiAgaXNSb290KCkgewogICAgcmV0dXJuIHRoaXMgPT09IHRoaXMuX3N0YXRlLmRiCiAgfQoKICByZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5yZWFkeSgpCiAgfQoKICBhc3luYyBjbG9zZSh7IGZvcmNlIH0gPSB7fSkgewogICAgaWYgKCF0aGlzLl9zdGF0ZS5vcGVuZWQpIGF3YWl0IHRoaXMuX3N0YXRlLnJlYWR5KCkKCiAgICBpZiAodGhpcy5faW5kZXggIT09IC0xKSB0aGlzLl9zdGF0ZS5yZW1vdmVTZXNzaW9uKHRoaXMpCgogICAgaWYgKGZvcmNlKSB7CiAgICAgIHdoaWxlICh0aGlzLl9zdGF0ZS5zZXNzaW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc3RhdGUuc2Vzc2lvbnNbdGhpcy5fc3RhdGUuc2Vzc2lvbnMubGVuZ3RoIC0gMV0uY2xvc2UoKQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuaXNSb290KCkgPyB0aGlzLl9zdGF0ZS5jbG9zZSgpIDogUHJvbWlzZS5yZXNvbHZlKCkKICB9CgogIHN1c3BlbmQoKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5zdXNwZW5kKCkKICB9CgogIHJlc3VtZSgpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIHRoaXMuX3N0YXRlLnJlc3VtZSgpCiAgfQoKICBpc0lkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUuaGFuZGxlcy5pc0lkbGUoKQogIH0KCiAgaWRsZSgpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5oYW5kbGVzLmlkbGUoKQogIH0KCiAgaXRlcmF0b3IocmFuZ2UsIG9wdHMpIHsKICAgIG1heWJlQ2xvc2VkKHRoaXMpCgogICAgcmV0dXJuIG5ldyBJdGVyYXRvcih0aGlzLCB7IC4uLnJhbmdlLCAuLi5vcHRzIH0pCiAgfQoKICBhc3luYyAqa2V5cyhyYW5nZSwgb3B0cykgewogICAgZm9yIGF3YWl0IChjb25zdCB7IGtleSB9IG9mIHRoaXMuaXRlcmF0b3IocmFuZ2UsIHsKICAgICAgLi4ub3B0cywKICAgICAgdmFsdWVzOiBmYWxzZQogICAgfSkpIHsKICAgICAgeWllbGQga2V5CiAgICB9CiAgfQoKICBhc3luYyBwZWVrKHJhbmdlLCBvcHRzKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IHZhbHVlIG9mIHRoaXMuaXRlcmF0b3IoeyAuLi5yYW5nZSwgLi4ub3B0cywgbGltaXQ6IDEgfSkpIHsKICAgICAgcmV0dXJuIHZhbHVlCiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9CgogIHJlYWQob3B0cykgewogICAgbWF5YmVDbG9zZWQodGhpcykKCiAgICByZXR1cm4gdGhpcy5fc3RhdGUuY3JlYXRlUmVhZEJhdGNoKHRoaXMsIG9wdHMpCiAgfQoKICB3cml0ZShvcHRzKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5jcmVhdGVXcml0ZUJhdGNoKHRoaXMsIG9wdHMpCiAgfQoKICBmbHVzaChvcHRzKSB7CiAgICBtYXliZUNsb3NlZCh0aGlzKQoKICAgIHJldHVybiB0aGlzLl9zdGF0ZS5mbHVzaCh0aGlzLCBvcHRzKQogIH0KCiAgYXN5bmMgZ2V0KGtleSwgb3B0cykgewogICAgY29uc3QgYmF0Y2ggPSB0aGlzLnJlYWQoeyAuLi5vcHRzLCBjYXBhY2l0eTogMSwgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGNvbnN0IHZhbHVlID0gYmF0Y2guZ2V0KGtleSkKICAgIGJhdGNoLnRyeUZsdXNoKCkKICAgIHJldHVybiB2YWx1ZQogIH0KCiAgYXN5bmMgcHV0KGtleSwgdmFsdWUsIG9wdHMpIHsKICAgIGNvbnN0IGJhdGNoID0gdGhpcy53cml0ZSh7IC4uLm9wdHMsIGNhcGFjaXR5OiAxLCBhdXRvRGVzdHJveTogdHJ1ZSB9KQogICAgYmF0Y2gudHJ5UHV0KGtleSwgdmFsdWUpCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCiAgfQoKICBhc3luYyBkZWxldGUoa2V5LCBvcHRzKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMud3JpdGUoeyAuLi5vcHRzLCBjYXBhY2l0eTogMSwgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGJhdGNoLnRyeURlbGV0ZShrZXkpCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCiAgfQoKICBhc3luYyBkZWxldGVSYW5nZShzdGFydCwgZW5kLCBvcHRzKSB7CiAgICBjb25zdCBiYXRjaCA9IHRoaXMud3JpdGUoeyAuLi5vcHRzLCBjYXBhY2l0eTogMSwgYXV0b0Rlc3Ryb3k6IHRydWUgfSkKICAgIGJhdGNoLnRyeURlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpCiAgICBhd2FpdCBiYXRjaC5mbHVzaCgpCiAgfQoKICBhc3luYyBjb21wYWN0UmFuZ2Uoc3RhcnQgPSBudWxsLCBlbmQgPSBudWxsLCBvcHRzID0ge30pIHsKICAgIGlmICh0eXBlb2YgZW5kID09PSAnb2JqZWN0JyAmJiBlbmQgIT09IG51bGwpIHsKICAgICAgb3B0cyA9IGVuZAogICAgICBlbmQgPSBudWxsCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdGFydCA9PT0gJ29iamVjdCcgJiYgc3RhcnQgIT09IG51bGwpIHsKICAgICAgb3B0cyA9IHN0YXJ0CiAgICAgIHN0YXJ0ID0gbnVsbAogICAgICBlbmQgPSBudWxsCiAgICB9CgogICAgYXdhaXQgdGhpcy5fc3RhdGUuY29tcGFjdFJhbmdlKHRoaXMsIHN0YXJ0LCBlbmQsIG9wdHMpCiAgfQoKICBhc3luYyBhcHByb3hpbWF0ZVNpemUoc3RhcnQsIGVuZCwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGUuYXBwcm94aW1hdGVTaXplKHRoaXMsIHN0YXJ0LCBlbmQsIG9wdHMpCiAgfQoKICBfcmVmKCkgewogICAgaWYgKHRoaXMuX3NuYXBzaG90KSB0aGlzLl9zbmFwc2hvdC5yZWYoKQogICAgdGhpcy5fc3RhdGUuaGFuZGxlcy5pbmMoKQogIH0KCiAgX3VucmVmKCkgewogICAgaWYgKHRoaXMuX3NuYXBzaG90KSB0aGlzLl9zbmFwc2hvdC51bnJlZigpCiAgICB0aGlzLl9zdGF0ZS5oYW5kbGVzLmRlYygpCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBSb2Nrc0RCCgpleHBvcnRzLmNvbnN0YW50cyA9IGNvbnN0YW50cwoKZXhwb3J0cy5Db2x1bW5GYW1pbHkgPSBDb2x1bW5GYW1pbHkKZXhwb3J0cy5CbG9vbUZpbHRlclBvbGljeSA9IEJsb29tRmlsdGVyUG9saWN5CmV4cG9ydHMuUmliYm9uRmlsdGVyUG9saWN5ID0gUmliYm9uRmlsdGVyUG9saWN5CgpmdW5jdGlvbiBtYXliZUNsb3NlZChkYikgewogIGlmIChkYi5fc3RhdGUuY2xvc2luZyB8fCBkYi5faW5kZXggPT09IC0xKSB0aHJvdyBuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKQp9CmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKY29uc3QgZW1wdHkgPSBCdWZmZXIuYWxsb2MoMCkKY29uc3QgcmVzb2x2ZWQgPSBQcm9taXNlLnJlc29sdmUoKQoKY2xhc3MgUm9ja3NEQkJhdGNoIHsKICBjb25zdHJ1Y3RvcihkYiwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IGNhcGFjaXR5ID0gOCwgYXV0b0Rlc3Ryb3kgPSBmYWxzZSB9ID0gb3B0cwoKICAgIGRiLl9yZWYoKQoKICAgIHRoaXMuX2RiID0gZGIKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLl9jYXBhY2l0eSA9IGNhcGFjaXR5CiAgICB0aGlzLl9vcGVyYXRpb25zID0gW10KICAgIHRoaXMuX3Byb21pc2VzID0gW10KCiAgICB0aGlzLl9lbnF1ZXVlUHJvbWlzZSA9IHRoaXMuX2VucXVldWVQcm9taXNlLmJpbmQodGhpcykKCiAgICB0aGlzLl9yZXF1ZXN0ID0gbnVsbAogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX3JlamVjdCA9IG51bGwKCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCiAgICB0aGlzLl9idWZmZXIgPSBudWxsCiAgICB0aGlzLl9hdXRvRGVzdHJveSA9IGF1dG9EZXN0cm95CgogICAgaWYgKGRiLl9zdGF0ZS5vcGVuZWQgPT09IHRydWUpIHRoaXMucmVhZHkoKQogIH0KCiAgX3JldXNlKGRiLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgYXV0b0Rlc3Ryb3kgPSBmYWxzZSB9ID0gb3B0cwoKICAgIGRiLl9yZWYoKQoKICAgIHRoaXMuX2RiID0gZGIKICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlCiAgICB0aGlzLl9hdXRvRGVzdHJveSA9IGF1dG9EZXN0cm95CiAgfQoKICBfb25maW5pc2hlZChlcnIpIHsKICAgIGNvbnN0IHJlc29sdmUgPSB0aGlzLl9yZXNvbHZlCiAgICBjb25zdCByZWplY3QgPSB0aGlzLl9yZWplY3QKCiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCgogICAgdGhpcy5fb3BlcmF0aW9ucyA9IFtdCiAgICB0aGlzLl9wcm9taXNlcyA9IFtdCiAgICB0aGlzLl9yZXF1ZXN0ID0gbnVsbAogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX3JlamVjdCA9IG51bGwKCiAgICBpZiAodGhpcy5fYXV0b0Rlc3Ryb3kgPT09IHRydWUpIHRoaXMuZGVzdHJveSgpCgogICAgaWYgKHJlamVjdCAhPT0gbnVsbCAmJiBlcnIpIHJlamVjdChlcnIpCiAgICBlbHNlIGlmIChyZXNvbHZlICE9PSBudWxsKSByZXNvbHZlKCkKICB9CgogIF9yZXNpemUoKSB7CiAgICBpZiAodGhpcy5fb3BlcmF0aW9ucy5sZW5ndGggPD0gdGhpcy5fY2FwYWNpdHkpIHJldHVybiBmYWxzZQoKICAgIHdoaWxlICh0aGlzLl9vcGVyYXRpb25zLmxlbmd0aCA+IHRoaXMuX2NhcGFjaXR5KSB7CiAgICAgIHRoaXMuX2NhcGFjaXR5ICo9IDIKICAgIH0KCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgYXN5bmMgcmVhZHkoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlICE9PSBudWxsKSByZXR1cm4KCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZWFkeSgpCgogICAgdGhpcy5faW5pdCgpCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBpbiBwcm9ncmVzcycpCiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm4KCiAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCgogICAgaWYgKHRoaXMuX3Byb21pc2VzLmxlbmd0aCkgdGhpcy5fYWJvcnQoKQoKICAgIHRoaXMuX2RiLl91bnJlZigpCiAgICB0aGlzLl9vbmZyZWUoKQogIH0KCiAgX29uZnJlZSgpIHsKICAgIHRoaXMuX2RiLl9zdGF0ZS5mcmVlQmF0Y2godGhpcywgZmFsc2UpCiAgICB0aGlzLl9kYiA9IG51bGwKICB9CgogIF9hYm9ydCgpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcHJvbWlzZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2VzW2ldCiAgICAgIGlmIChwcm9taXNlICE9PSBudWxsKSBwcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0JhdGNoIGlzIGRlc3Ryb3llZCcpKQogICAgfQoKICAgIHRoaXMuX29uZmluaXNoZWQobmV3IEVycm9yKCdCYXRjaCBpcyBkZXN0cm95ZWQnKSkKICB9CgogIGFzeW5jIGZsdXNoKCkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBpbiBwcm9ncmVzcycpCiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoJ0JhdGNoIGlzIGRlc3Ryb3llZCcpCgogICAgdGhpcy5fcmVxdWVzdCA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmUKICAgICAgdGhpcy5fcmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRoaXMuX2ZsdXNoKCkKCiAgICByZXR1cm4gdGhpcy5fcmVxdWVzdAogIH0KCiAgdHJ5Rmx1c2goKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGluIHByb2dyZXNzJykKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcignQmF0Y2ggaXMgZGVzdHJveWVkJykKCiAgICB0aGlzLl9yZXF1ZXN0ID0gcmVzb2x2ZWQKCiAgICB0aGlzLl9mbHVzaCgpCiAgfQoKICBhc3luYyBfZmx1c2goKSB7CiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSBhd2FpdCB0aGlzLnJlYWR5KCkKCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzdW1lZCA9IGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkLnByb21pc2UKCiAgICAgIGlmICghcmVzdW1lZCkgewogICAgICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHsKICAgICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlCiAgICAgICAgICB0aGlzLl9hYm9ydCgpCiAgICAgICAgICB0aGlzLl9kYi5fdW5yZWYoKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgX2VucXVldWVQcm9taXNlKHJlc29sdmUsIHJlamVjdCkgewogICAgdGhpcy5fcHJvbWlzZXMucHVzaCh7IHJlc29sdmUsIHJlamVjdCB9KQogIH0KCiAgX2VuY29kZUtleShrKSB7CiAgICBpZiAodGhpcy5fZGIuX2tleUVuY29kaW5nKSByZXR1cm4gYy5lbmNvZGUodGhpcy5fZGIuX2tleUVuY29kaW5nLCBrKQogICAgaWYgKHR5cGVvZiBrID09PSAnc3RyaW5nJykgcmV0dXJuIEJ1ZmZlci5mcm9tKGspCiAgICByZXR1cm4gawogIH0KCiAgX2VuY29kZVZhbHVlKHYpIHsKICAgIGlmICh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZykgcmV0dXJuIGMuZW5jb2RlKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nLCB2KQogICAgaWYgKHYgPT09IG51bGwpIHJldHVybiBlbXB0eQogICAgaWYgKHR5cGVvZiB2ID09PSAnc3RyaW5nJykgcmV0dXJuIEJ1ZmZlci5mcm9tKHYpCiAgICByZXR1cm4gdgogIH0KCiAgX2RlY29kZVZhbHVlKGIpIHsKICAgIGlmICh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZykgcmV0dXJuIGMuZGVjb2RlKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nLCBiKQogICAgcmV0dXJuIGIKICB9Cn0KCmV4cG9ydHMuUmVhZEJhdGNoID0gY2xhc3MgUm9ja3NEQlJlYWRCYXRjaCBleHRlbmRzIFJvY2tzREJCYXRjaCB7CiAgY29uc3RydWN0b3IoZGIsIG9wdHMgPSB7fSkgewogICAgc3VwZXIoZGIsIG9wdHMpCgogICAgY29uc3QgeyBhc3luY0lPID0gZmFsc2UsIGZpbGxDYWNoZSA9IHRydWUgfSA9IG9wdHMKCiAgICB0aGlzLl9hc3luY0lPID0gYXN5bmNJTwogICAgdGhpcy5fZmlsbENhY2hlID0gZmlsbENhY2hlCiAgfQoKICBfaW5pdCgpIHsKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcucmVhZEluaXQoKQogICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy5yZWFkQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgfQoKICBfcmVzaXplKCkgewogICAgaWYgKHN1cGVyLl9yZXNpemUoKSAmJiB0aGlzLl9oYW5kbGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy5yZWFkQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgICB9CiAgfQoKICBhc3luYyBfZmx1c2goKSB7CiAgICBhd2FpdCBzdXBlci5fZmx1c2goKQoKICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcucmVhZCgKICAgICAgICB0aGlzLl9kYi5fc3RhdGUuX2hhbmRsZSwKICAgICAgICB0aGlzLl9oYW5kbGUsCiAgICAgICAgdGhpcy5fb3BlcmF0aW9ucywKICAgICAgICB0aGlzLl9kYi5fc25hcHNob3QgPyB0aGlzLl9kYi5fc25hcHNob3QuX2hhbmRsZSA6IHVuZGVmaW5lZCwKICAgICAgICB0aGlzLl9hc3luY0lPLAogICAgICAgIHRoaXMuX2ZpbGxDYWNoZSwKICAgICAgICB0aGlzLAogICAgICAgIHRoaXMuX29ucmVhZAogICAgICApCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICAgIHRocm93IGVycgogICAgfQogIH0KCiAgX29ucmVhZChlcnJzLCB2YWx1ZXMpIHsKICAgIGxldCBhcHBsaWVkID0gdHJ1ZQoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gdGhpcy5fcHJvbWlzZXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGVyciA9IGVycnNbaV0KICAgICAgaWYgKGVycikgYXBwbGllZCA9IGZhbHNlCgogICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5fcHJvbWlzZXNbaV0KICAgICAgaWYgKHByb21pc2UgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICBpZiAoZXJyKSBwcm9taXNlLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSBwcm9taXNlLnJlc29sdmUodmFsdWVzW2ldID8gdGhpcy5fZGVjb2RlVmFsdWUoQnVmZmVyLmZyb20odmFsdWVzW2ldKSkgOiBudWxsKQogICAgfQoKICAgIHRoaXMuX29uZmluaXNoZWQoYXBwbGllZCA/IG51bGwgOiBuZXcgRXJyb3IoJ0JhdGNoIHdhcyBub3QgYXBwbGllZCcpKQogIH0KCiAgZ2V0KGtleSkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fZW5xdWV1ZVByb21pc2UpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKG5ldyBSb2Nrc0RCR2V0KHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KSkKCiAgICB0aGlzLl9yZXNpemUoKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQp9CgpleHBvcnRzLldyaXRlQmF0Y2ggPSBjbGFzcyBSb2Nrc0RCV3JpdGVCYXRjaCBleHRlbmRzIFJvY2tzREJCYXRjaCB7CiAgX2luaXQoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLndyaXRlSW5pdCgpCiAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLndyaXRlQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgfQoKICBfcmVzaXplKCkgewogICAgaWYgKHN1cGVyLl9yZXNpemUoKSAmJiB0aGlzLl9oYW5kbGUgIT09IG51bGwpIHsKICAgICAgdGhpcy5fYnVmZmVyID0gYmluZGluZy53cml0ZUJ1ZmZlcih0aGlzLl9oYW5kbGUsIHRoaXMuX2NhcGFjaXR5KQogICAgfQogIH0KCiAgX29uZnJlZSgpIHsKICAgIHRoaXMuX2RiLl9zdGF0ZS5mcmVlQmF0Y2godGhpcywgdHJ1ZSkKICB9CgogIGFzeW5jIF9mbHVzaCgpIHsKICAgIGF3YWl0IHN1cGVyLl9mbHVzaCgpCgogICAgaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuCgogICAgdHJ5IHsKICAgICAgYmluZGluZy53cml0ZSh0aGlzLl9kYi5fc3RhdGUuX2hhbmRsZSwgdGhpcy5faGFuZGxlLCB0aGlzLl9vcGVyYXRpb25zLCB0aGlzLCB0aGlzLl9vbndyaXRlKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIF9vbndyaXRlKGVycikgewogICAgY29uc3QgYXBwbGllZCA9ICFlcnIKCiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHRoaXMuX3Byb21pc2VzLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5fcHJvbWlzZXNbaV0KICAgICAgaWYgKHByb21pc2UgPT09IG51bGwpIGNvbnRpbnVlCgogICAgICBpZiAoZXJyKSBwcm9taXNlLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSBwcm9taXNlLnJlc29sdmUoKQogICAgfQoKICAgIHRoaXMuX29uZmluaXNoZWQoYXBwbGllZCA/IG51bGwgOiBuZXcgRXJyb3IoJ0JhdGNoIHdhcyBub3QgYXBwbGllZCcpKQogIH0KCiAgcHV0KGtleSwgdmFsdWUpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWVQcm9taXNlKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaCgKICAgICAgbmV3IFJvY2tzREJQdXQodGhpcy5fZW5jb2RlS2V5KGtleSksIHRoaXMuX2VuY29kZVZhbHVlKHZhbHVlKSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkKICAgICkKCiAgICB0aGlzLl9yZXNpemUoKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB0cnlQdXQoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMuX3JlcXVlc3QpIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzJykKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2goCiAgICAgIG5ldyBSb2Nrc0RCUHV0KHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9lbmNvZGVWYWx1ZSh2YWx1ZSksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpCiAgICApCgogICAgdGhpcy5fcHJvbWlzZXMucHVzaChudWxsKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCiAgfQoKICBkZWxldGUoa2V5KSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGlzLl9lbnF1ZXVlUHJvbWlzZSkKCiAgICB0aGlzLl9vcGVyYXRpb25zLnB1c2gobmV3IFJvY2tzREJEZWxldGUodGhpcy5fZW5jb2RlS2V5KGtleSksIHRoaXMuX2RiLl9jb2x1bW5GYW1pbHkpKQoKICAgIHRoaXMuX3Jlc2l6ZSgpCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHRyeURlbGV0ZShrZXkpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKG5ldyBSb2Nrc0RCRGVsZXRlKHRoaXMuX2VuY29kZUtleShrZXkpLCB0aGlzLl9kYi5fY29sdW1uRmFtaWx5KSkKCiAgICB0aGlzLl9wcm9taXNlcy5wdXNoKG51bGwpCgogICAgdGhpcy5fcmVzaXplKCkKICB9CgogIGRlbGV0ZVJhbmdlKHN0YXJ0LCBlbmQpIHsKICAgIGlmICh0aGlzLl9yZXF1ZXN0KSB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWxyZWFkeSBpbiBwcm9ncmVzcycpCgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHRoaXMuX2VucXVldWVQcm9taXNlKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaCgKICAgICAgbmV3IFJvY2tzREJEZWxldGVSYW5nZSh0aGlzLl9lbmNvZGVLZXkoc3RhcnQpLCB0aGlzLl9lbmNvZGVLZXkoZW5kKSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkKICAgICkKCiAgICB0aGlzLl9yZXNpemUoKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB0cnlEZWxldGVSYW5nZShzdGFydCwgZW5kKSB7CiAgICBpZiAodGhpcy5fcmVxdWVzdCkgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGFscmVhZHkgaW4gcHJvZ3Jlc3MnKQoKICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaCgKICAgICAgbmV3IFJvY2tzREJEZWxldGVSYW5nZSh0aGlzLl9lbmNvZGVLZXkoc3RhcnQpLCB0aGlzLl9lbmNvZGVLZXkoZW5kKSwgdGhpcy5fZGIuX2NvbHVtbkZhbWlseSkKICAgICkKCiAgICB0aGlzLl9wcm9taXNlcy5wdXNoKG51bGwpCgogICAgdGhpcy5fcmVzaXplKCkKICB9Cn0KCmNsYXNzIFJvY2tzREJHZXQgewogIGNvbnN0cnVjdG9yKGtleSwgY29sdW1uRmFtaWx5KSB7CiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5jb2x1bW5GYW1pbHkgPSBjb2x1bW5GYW1pbHkuX2hhbmRsZQogIH0KCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gYmluZGluZy5HRVQKICB9Cn0KCmNsYXNzIFJvY2tzREJQdXQgewogIGNvbnN0cnVjdG9yKGtleSwgdmFsdWUsIGNvbHVtbkZhbWlseSkgewogICAgdGhpcy5rZXkgPSBrZXkKICAgIHRoaXMudmFsdWUgPSB2YWx1ZQogICAgdGhpcy5jb2x1bW5GYW1pbHkgPSBjb2x1bW5GYW1pbHkuX2hhbmRsZQogIH0KCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gYmluZGluZy5QVVQKICB9Cn0KCmNsYXNzIFJvY2tzREJEZWxldGUgewogIGNvbnN0cnVjdG9yKGtleSwgY29sdW1uRmFtaWx5KSB7CiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5jb2x1bW5GYW1pbHkgPSBjb2x1bW5GYW1pbHkuX2hhbmRsZQogIH0KCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gYmluZGluZy5ERUxFVEUKICB9Cn0KCmNsYXNzIFJvY2tzREJEZWxldGVSYW5nZSB7CiAgY29uc3RydWN0b3Ioc3RhcnQsIGVuZCwgY29sdW1uRmFtaWx5KSB7CiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQKICAgIHRoaXMuZW5kID0gZW5kCiAgICB0aGlzLmNvbHVtbkZhbWlseSA9IGNvbHVtbkZhbWlseS5faGFuZGxlCiAgfQoKICBnZXQgdHlwZSgpIHsKICAgIHJldHVybiBiaW5kaW5nLkRFTEVURV9SQU5HRQogIH0KfQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykKY29uc3QgeyBCbG9vbUZpbHRlclBvbGljeSB9ID0gcmVxdWlyZSgnLi9maWx0ZXItcG9saWN5JykKCmNsYXNzIFJvY2tzREJDb2x1bW5GYW1pbHkgewogIGNvbnN0cnVjdG9yKG5hbWUsIG9wdHMgPSB7fSkgewogICAgY29uc3QgewogICAgICAvLyBCbG9iIG9wdGlvbnMKICAgICAgZW5hYmxlQmxvYkZpbGVzID0gZmFsc2UsCiAgICAgIG1pbkJsb2JTaXplID0gMCwKICAgICAgYmxvYkZpbGVTaXplID0gMCwKICAgICAgZW5hYmxlQmxvYkdhcmJhZ2VDb2xsZWN0aW9uID0gdHJ1ZSwKICAgICAgLy8gQmxvY2sgdGFibGUgb3B0aW9ucwogICAgICB0YWJsZUJsb2NrU2l6ZSA9IDgxOTIsCiAgICAgIHRhYmxlQ2FjaGVJbmRleEFuZEZpbHRlckJsb2NrcyA9IHRydWUsCiAgICAgIHRhYmxlRm9ybWF0VmVyc2lvbiA9IDYsCiAgICAgIG9wdGltaXplRmlsdGVyc0Zvck1lbW9yeSA9IGZhbHNlLAogICAgICBibG9ja0NhY2hlID0gdHJ1ZSwKICAgICAgZmlsdGVyUG9saWN5ID0gbmV3IEJsb29tRmlsdGVyUG9saWN5KDEwKSwKICAgICAgdG9wTGV2ZWxJbmRleFBpbm5pbmdUaWVyID0gY29uc3RhbnRzLnBpbm5pbmdUaWVyLkFMTCwKICAgICAgcGFydGl0aW9uUGlubmluZ1RpZXIgPSBjb25zdGFudHMucGlubmluZ1RpZXIuQUxMLAogICAgICB1bnBhcnRpdGlvbmVkUGlubmluZ1RpZXIgPSBjb25zdGFudHMucGlubmluZ1RpZXIuQUxMLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JIaXRzID0gZmFsc2UsCiAgICAgIG51bUxldmVscyA9IDcsCiAgICAgIG1heFdyaXRlQnVmZmVyTnVtYmVyID0gMgogICAgfSA9IG9wdHMKCiAgICB0aGlzLl9uYW1lID0gbmFtZQogICAgdGhpcy5fZmx1c2hpbmcgPSBudWxsCiAgICB0aGlzLl9vcHRpb25zID0gewogICAgICBlbmFibGVCbG9iRmlsZXMsCiAgICAgIG1pbkJsb2JTaXplLAogICAgICBibG9iRmlsZVNpemUsCiAgICAgIGVuYWJsZUJsb2JHYXJiYWdlQ29sbGVjdGlvbiwKICAgICAgdGFibGVCbG9ja1NpemUsCiAgICAgIHRhYmxlQ2FjaGVJbmRleEFuZEZpbHRlckJsb2NrcywKICAgICAgdGFibGVGb3JtYXRWZXJzaW9uLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JNZW1vcnksCiAgICAgIGJsb2NrQ2FjaGUsCiAgICAgIGZpbHRlclBvbGljeSwKICAgICAgdG9wTGV2ZWxJbmRleFBpbm5pbmdUaWVyLAogICAgICBwYXJ0aXRpb25QaW5uaW5nVGllciwKICAgICAgdW5wYXJ0aXRpb25lZFBpbm5pbmdUaWVyLAogICAgICBvcHRpbWl6ZUZpbHRlcnNGb3JIaXRzLAogICAgICBudW1MZXZlbHMsCiAgICAgIG1heFdyaXRlQnVmZmVyTnVtYmVyCiAgICB9CgogICAgY29uc3QgZmlsdGVyUG9saWN5QXJndW1lbnRzID0gWzAsIDAsIDBdCgogICAgaWYgKGZpbHRlclBvbGljeSAhPT0gbnVsbCkgewogICAgICBmaWx0ZXJQb2xpY3lBcmd1bWVudHNbMF0gPSBmaWx0ZXJQb2xpY3kudHlwZQoKICAgICAgc3dpdGNoIChmaWx0ZXJQb2xpY3kudHlwZSkgewogICAgICAgIGNhc2UgMTogLy8gQmxvb20gZmlsdGVyIHBvbGljeQogICAgICAgICAgZmlsdGVyUG9saWN5QXJndW1lbnRzWzFdID0gZmlsdGVyUG9saWN5LmJpdHNQZXJLZXkKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAyOiAvLyBSaWJib24gZmlsdGVyIHBvbGljeQogICAgICAgICAgZmlsdGVyUG9saWN5QXJndW1lbnRzWzFdID0gZmlsdGVyUG9saWN5LmJsb29tRXF1aXZhbGVudEJpdHNQZXJLZXkKICAgICAgICAgIGZpbHRlclBvbGljeUFyZ3VtZW50c1syXSA9IGZpbHRlclBvbGljeS5ibG9vbUJlZm9yZUxldmVsCgogICAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2hhbmRsZSA9IGJpbmRpbmcuY29sdW1uRmFtaWx5SW5pdCgKICAgICAgbmFtZSwKICAgICAgZW5hYmxlQmxvYkZpbGVzLAogICAgICBtaW5CbG9iU2l6ZSwKICAgICAgYmxvYkZpbGVTaXplLAogICAgICBlbmFibGVCbG9iR2FyYmFnZUNvbGxlY3Rpb24sCiAgICAgIHRhYmxlQmxvY2tTaXplLAogICAgICB0YWJsZUNhY2hlSW5kZXhBbmRGaWx0ZXJCbG9ja3MsCiAgICAgIHRhYmxlRm9ybWF0VmVyc2lvbiwKICAgICAgb3B0aW1pemVGaWx0ZXJzRm9yTWVtb3J5LAogICAgICBibG9ja0NhY2hlID09PSBmYWxzZSwKICAgICAgLi4uZmlsdGVyUG9saWN5QXJndW1lbnRzLAogICAgICB0b3BMZXZlbEluZGV4UGlubmluZ1RpZXIsCiAgICAgIHBhcnRpdGlvblBpbm5pbmdUaWVyLAogICAgICB1bnBhcnRpdGlvbmVkUGlubmluZ1RpZXIsCiAgICAgIG9wdGltaXplRmlsdGVyc0ZvckhpdHMsCiAgICAgIG51bUxldmVscywKICAgICAgbWF4V3JpdGVCdWZmZXJOdW1iZXIKICAgICkKICB9CgogIGNsb25lU2V0dGluZ3MobmFtZSkgewogICAgcmV0dXJuIG5ldyBSb2Nrc0RCQ29sdW1uRmFtaWx5KG5hbWUsIHRoaXMuX29wdGlvbnMpCiAgfQoKICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9uYW1lCiAgfQoKICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gbnVsbCkgcmV0dXJuCgogICAgYmluZGluZy5jb2x1bW5GYW1pbHlEZXN0cm95KHRoaXMuX2hhbmRsZSkKCiAgICB0aGlzLl9oYW5kbGUgPSBudWxsCiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IFJvY2tzREJDb2x1bW5GYW1pbHkKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcGlubmluZ1RpZXI6IHsKICAgIE5PTkU6IDAsCiAgICBGTFVTSEVEX0FORF9TSU1JTEFSOiAxLAogICAgQUxMOiAyCiAgfQp9CmV4cG9ydHMuQmxvb21GaWx0ZXJQb2xpY3kgPSBjbGFzcyBSb2Nrc0RCQmxvb21GaWx0ZXJQb2xpY3kgewogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIDEKICB9CgogIGNvbnN0cnVjdG9yKGJpdHNQZXJLZXkpIHsKICAgIHRoaXMuYml0c1BlcktleSA9IGJpdHNQZXJLZXkKICB9Cn0KCmV4cG9ydHMuUmliYm9uRmlsdGVyUG9saWN5ID0gY2xhc3MgUm9ja3NEQlJpYmJvbkZpbHRlclBvbGljeSB7CiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gMgogIH0KCiAgY29uc3RydWN0b3IoYmxvb21FcXVpdmFsZW50Qml0c1BlcktleSwgYmxvb21CZWZvcmVMZXZlbCA9IDApIHsKICAgIHRoaXMuYmxvb21FcXVpdmFsZW50Qml0c1BlcktleSA9IGJsb29tRXF1aXZhbGVudEJpdHNQZXJLZXkKICAgIHRoaXMuYmxvb21CZWZvcmVMZXZlbCA9IGJsb29tQmVmb3JlTGV2ZWwKICB9Cn0KY29uc3QgeyBSZWFkYWJsZSB9ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGMgPSByZXF1aXJlKCdjb21wYWN0LWVuY29kaW5nJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKY29uc3QgZW1wdHkgPSBCdWZmZXIuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUm9ja3NEQkl0ZXJhdG9yIGV4dGVuZHMgUmVhZGFibGUgewogIGNvbnN0cnVjdG9yKGRiLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgZ3QgPSBudWxsLAogICAgICBndGUgPSBudWxsLAogICAgICBsdCA9IG51bGwsCiAgICAgIGx0ZSA9IG51bGwsCiAgICAgIHJldmVyc2UgPSBmYWxzZSwKICAgICAgdmFsdWVzID0gdHJ1ZSwKICAgICAgbGltaXQgPSBJbmZpbml0eSwKICAgICAgY2FwYWNpdHkgPSA4CiAgICB9ID0gb3B0cwoKICAgIHN1cGVyKCkKCiAgICBkYi5fcmVmKCkKCiAgICB0aGlzLl9kYiA9IGRiCgogICAgdGhpcy5fZ3QgPSBndCA/IHRoaXMuX2VuY29kZUtleShndCkgOiBlbXB0eQogICAgdGhpcy5fZ3RlID0gZ3RlID8gdGhpcy5fZW5jb2RlS2V5KGd0ZSkgOiBlbXB0eQogICAgdGhpcy5fbHQgPSBsdCA/IHRoaXMuX2VuY29kZUtleShsdCkgOiBlbXB0eQogICAgdGhpcy5fbHRlID0gbHRlID8gdGhpcy5fZW5jb2RlS2V5KGx0ZSkgOiBlbXB0eQoKICAgIHRoaXMuX3JldmVyc2UgPSByZXZlcnNlCiAgICB0aGlzLl92YWx1ZXMgPSB2YWx1ZXMKICAgIHRoaXMuX2xpbWl0ID0gbGltaXQgPCAwID8gSW5maW5pdHkgOiBsaW1pdAogICAgdGhpcy5fY2FwYWNpdHkgPSBjYXBhY2l0eQogICAgdGhpcy5fb3BlbmVkID0gZmFsc2UKCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IG51bGwKICAgIHRoaXMuX3BlbmRpbmdSZWFkID0gbnVsbAogICAgdGhpcy5fcGVuZGluZ0Rlc3Ryb3kgPSBudWxsCgogICAgdGhpcy5fYnVmZmVyID0gbnVsbAogICAgdGhpcy5faGFuZGxlID0gbnVsbAoKICAgIGlmICh0aGlzLl9kYi5fc3RhdGUub3BlbmVkID09PSB0cnVlKSB0aGlzLnJlYWR5KCkKICB9CgogIF9vbm9wZW4oZXJyKSB7CiAgICBjb25zdCBjYiA9IHRoaXMuX3BlbmRpbmdPcGVuCiAgICB0aGlzLl9wZW5kaW5nT3BlbiA9IG51bGwKICAgIHRoaXMuX29wZW5lZCA9IHRydWUKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgY2IoZXJyKQogIH0KCiAgX29ucmVhZChlcnIsIGtleXMsIHZhbHVlcykgewogICAgY29uc3QgY2IgPSB0aGlzLl9wZW5kaW5nUmVhZAogICAgdGhpcy5fcGVuZGluZ1JlYWQgPSBudWxsCiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpCgogICAgY29uc3QgbiA9IGtleXMubGVuZ3RoCgogICAgdGhpcy5fbGltaXQgLT0gbgoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgIHRoaXMucHVzaCh7CiAgICAgICAga2V5OiB0aGlzLl9kZWNvZGVLZXkoQnVmZmVyLmZyb20oa2V5c1tpXSkpLAogICAgICAgIHZhbHVlOiB0aGlzLl92YWx1ZXMgPyB0aGlzLl9kZWNvZGVWYWx1ZShCdWZmZXIuZnJvbSh2YWx1ZXNbaV0pKSA6IG51bGwKICAgICAgfSkKICAgIH0KCiAgICBpZiAobiA8IHRoaXMuX2NhcGFjaXR5KSB0aGlzLnB1c2gobnVsbCkKCiAgICBjYihudWxsKQogIH0KCiAgX29uY2xvc2UoZXJyKSB7CiAgICBjb25zdCBjYiA9IHRoaXMuX3BlbmRpbmdEZXN0cm95CiAgICB0aGlzLl9wZW5kaW5nRGVzdHJveSA9IG51bGwKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgdGhpcy5fZGIuX3VucmVmKCkKICAgIGNiKGVycikKICB9CgogIF9yZXNpemUoKSB7CiAgICBpZiAodGhpcy5faGFuZGxlICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX2J1ZmZlciA9IGJpbmRpbmcuaXRlcmF0b3JCdWZmZXIodGhpcy5faGFuZGxlLCB0aGlzLl9jYXBhY2l0eSkKICAgIH0KICB9CgogIGFzeW5jIHJlYWR5KCkgewogICAgaWYgKHRoaXMuX2hhbmRsZSAhPT0gbnVsbCkgcmV0dXJuCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5vcGVuZWQgPT09IGZhbHNlKSBhd2FpdCB0aGlzLl9kYi5fc3RhdGUucmVhZHkoKQoKICAgIHRoaXMuX2luaXQoKQogIH0KCiAgX2luaXQoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiaW5kaW5nLml0ZXJhdG9ySW5pdCgpCiAgICB0aGlzLl9idWZmZXIgPSBiaW5kaW5nLml0ZXJhdG9yQnVmZmVyKHRoaXMuX2hhbmRsZSwgdGhpcy5fY2FwYWNpdHkpCiAgfQoKICBhc3luYyBfb3BlbihjYikgewogICAgYXdhaXQgdGhpcy5yZWFkeSgpCgogICAgdGhpcy5fZGIuX3N0YXRlLmlvLmluYygpCgogICAgaWYgKHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCB0aGlzLl9kYi5fc3RhdGUucmVzdW1lZC5wcm9taXNlCgogICAgICBpZiAoIXJlc3VtZWQpIHsKICAgICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKCiAgICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcignUm9ja3NEQiBzZXNzaW9uIGlzIGNsb3NlZCcpKQogICAgICB9CiAgICB9CgogICAgdGhpcy5fcGVuZGluZ09wZW4gPSBjYgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuaXRlcmF0b3JPcGVuKAogICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5faGFuZGxlLAogICAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgICB0aGlzLl9kYi5fY29sdW1uRmFtaWx5Ll9oYW5kbGUsCiAgICAgICAgdGhpcy5fZ3QsCiAgICAgICAgdGhpcy5fZ3RlLAogICAgICAgIHRoaXMuX2x0LAogICAgICAgIHRoaXMuX2x0ZSwKICAgICAgICB0aGlzLl9yZXZlcnNlLAogICAgICAgICF0aGlzLl92YWx1ZXMsIC8vIEtleXMgb25seQogICAgICAgIHRoaXMuX2RiLl9zbmFwc2hvdCA/IHRoaXMuX2RiLl9zbmFwc2hvdC5faGFuZGxlIDogdW5kZWZpbmVkLAogICAgICAgIHRoaXMsCiAgICAgICAgdGhpcy5fb25vcGVuLAogICAgICAgIHRoaXMuX29uY2xvc2UsCiAgICAgICAgdGhpcy5fb25yZWFkCiAgICAgICkKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9kYi5fc3RhdGUuaW8uZGVjKCkKCiAgICAgIGNiKGVycikKICAgIH0KICB9CgogIGFzeW5jIF9yZWFkKGNiKSB7CiAgICB0aGlzLl9kYi5fc3RhdGUuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5fZGIuX3N0YXRlLnJlc3VtZWQgIT09IG51bGwpIHsKICAgICAgY29uc3QgcmVzdW1lZCA9IGF3YWl0IHRoaXMuX2RiLl9zdGF0ZS5yZXN1bWVkLnByb21pc2UKCiAgICAgIGlmICghcmVzdW1lZCkgewogICAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQoKICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKCdSb2Nrc0RCIHNlc3Npb24gaXMgY2xvc2VkJykpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9wZW5kaW5nUmVhZCA9IGNiCgogICAgdHJ5IHsKICAgICAgYmluZGluZy5pdGVyYXRvclJlYWQodGhpcy5faGFuZGxlLCBNYXRoLm1pbih0aGlzLl9jYXBhY2l0eSwgdGhpcy5fbGltaXQpKQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQoKICAgICAgY2IoZXJyKQogICAgfQogIH0KCiAgYXN5bmMgX2Rlc3Ryb3koY2IpIHsKICAgIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5pbmMoKQoKICAgIGlmICh0aGlzLl9vcGVuZWQgPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX2RiLl9zdGF0ZS5pby5kZWMoKQogICAgICB0aGlzLl9kYi5fdW5yZWYoKQoKICAgICAgcmV0dXJuIGNiKG51bGwpCiAgICB9CgogICAgdGhpcy5fcGVuZGluZ0Rlc3Ryb3kgPSBjYgoKICAgIHRyeSB7CiAgICAgIGJpbmRpbmcuaXRlcmF0b3JDbG9zZSh0aGlzLl9oYW5kbGUpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGIuX3N0YXRlLmlvLmRlYygpCiAgICAgIHRoaXMuX2RiLl91bnJlZigpCgogICAgICBjYihlcnIpCiAgICB9CiAgfQoKICBfZW5jb2RlS2V5KGspIHsKICAgIGlmICh0aGlzLl9kYi5fa2V5RW5jb2RpbmcgIT09IG51bGwpIHJldHVybiBjLmVuY29kZSh0aGlzLl9kYi5fa2V5RW5jb2RpbmcsIGspCiAgICBpZiAodHlwZW9mIGsgPT09ICdzdHJpbmcnKSByZXR1cm4gQnVmZmVyLmZyb20oaykKICAgIHJldHVybiBrCiAgfQoKICBfZGVjb2RlS2V5KGIpIHsKICAgIGlmICh0aGlzLl9kYi5fa2V5RW5jb2RpbmcgIT09IG51bGwpIHJldHVybiBjLmRlY29kZSh0aGlzLl9kYi5fa2V5RW5jb2RpbmcsIGIpCiAgICByZXR1cm4gYgogIH0KCiAgX2RlY29kZVZhbHVlKGIpIHsKICAgIGlmICh0aGlzLl9kYi5fdmFsdWVFbmNvZGluZyAhPT0gbnVsbCkgcmV0dXJuIGMuZGVjb2RlKHRoaXMuX2RiLl92YWx1ZUVuY29kaW5nLCBiKQogICAgcmV0dXJuIGIKICB9Cn0KY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBSb2Nrc0RCU25hcHNob3QgewogIGNvbnN0cnVjdG9yKHN0YXRlKSB7CiAgICB0aGlzLl9zdGF0ZSA9IHN0YXRlCgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogICAgdGhpcy5fcmVmcyA9IDAKCiAgICBpZiAoc3RhdGUuZGVmZXJTbmFwc2hvdEluaXQgPT09IGZhbHNlKSB0aGlzLl9pbml0KCkKICB9CgogIF9pbml0KCkgewogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5zbmFwc2hvdENyZWF0ZSh0aGlzLl9zdGF0ZS5faGFuZGxlKQogIH0KCiAgcmVmKCkgewogICAgdGhpcy5fcmVmcysrCiAgfQoKICB1bnJlZigpIHsKICAgIGlmICgtLXRoaXMuX3JlZnMgPiAwKSByZXR1cm4KCiAgICBpZiAodGhpcy5faGFuZGxlID09PSBudWxsKSByZXR1cm4KCiAgICBiaW5kaW5nLnNuYXBzaG90RGVzdHJveSh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5faGFuZGxlID0gbnVsbAogIH0KfQpjb25zdCBSZWFkeVJlc291cmNlID0gcmVxdWlyZSgncmVhZHktcmVzb3VyY2UnKQpjb25zdCBSZWZDb3VudGVyID0gcmVxdWlyZSgncmVmY291bnRlcicpCmNvbnN0IHJycCA9IHJlcXVpcmUoJ3Jlc29sdmUtcmVqZWN0LXByb21pc2UnKQpjb25zdCBTaWduYWxQcm9taXNlID0gcmVxdWlyZSgnc2lnbmFsLXByb21pc2UnKQpjb25zdCBjID0gcmVxdWlyZSgnY29tcGFjdC1lbmNvZGluZycpCmNvbnN0IHsgUmVhZEJhdGNoLCBXcml0ZUJhdGNoIH0gPSByZXF1aXJlKCcuL2JhdGNoJykKY29uc3QgQ29sdW1uRmFtaWx5ID0gcmVxdWlyZSgnLi9jb2x1bW4tZmFtaWx5JykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQoKY29uc3QgTUFYX0JBVENIX1JFVVNFID0gNjQKY29uc3QgZW1wdHkgPSBCdWZmZXIuYWxsb2MoMCkKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUm9ja3NEQlN0YXRlIGV4dGVuZHMgUmVhZHlSZXNvdXJjZSB7CiAgY29uc3RydWN0b3IoZGIsIHBhdGgsIG9wdHMpIHsKICAgIHN1cGVyKCkKCiAgICBjb25zdCB7CiAgICAgIGNvbHVtbkZhbWlseSA9IG5ldyBDb2x1bW5GYW1pbHkoJ2RlZmF1bHQnLCBvcHRzKSwKICAgICAgY29sdW1uRmFtaWxpZXMgPSBbXSwKICAgICAgcmVhZE9ubHkgPSBmYWxzZSwKICAgICAgY3JlYXRlSWZNaXNzaW5nID0gdHJ1ZSwKICAgICAgY3JlYXRlTWlzc2luZ0NvbHVtbkZhbWlsaWVzID0gdHJ1ZSwKICAgICAgbWF4QmFja2dyb3VuZEpvYnMgPSA2LAogICAgICBieXRlc1BlclN5bmMgPSAxMDQ4NTc2LAogICAgICBtYXhPcGVuRmlsZXMgPSAtMSwKICAgICAgdXNlRGlyZWN0UmVhZHMgPSBmYWxzZSwKICAgICAgYXZvaWRVbm5lY2Vzc2FyeUJsb2NraW5nSU8gPSBmYWxzZSwKICAgICAgc2tpcFN0YXRzVXBkYXRlT25PcGVuID0gZmFsc2UsCiAgICAgIHVzZURpcmVjdElPRm9yRmx1c2hBbmRDb21wYWN0aW9uID0gZmFsc2UsCiAgICAgIG1heEZpbGVPcGVuaW5nVGhyZWFkcyA9IDE2LAogICAgICBsb2NrID0gbnVsbAogICAgfSA9IG9wdHMKCiAgICB0aGlzLnBhdGggPSBwYXRoCiAgICB0aGlzLmRiID0gZGIKICAgIHRoaXMuaGFuZGxlcyA9IG5ldyBSZWZDb3VudGVyKCkKICAgIHRoaXMuaW8gPSBuZXcgUmVmQ291bnRlcigpCiAgICB0aGlzLnNlc3Npb25zID0gW10KICAgIHRoaXMuY29sdW1uRmFtaWxpZXMgPSBbY29sdW1uRmFtaWx5XQogICAgdGhpcy5kZWZlclNuYXBzaG90SW5pdCA9IHRydWUKICAgIHRoaXMucmVzdW1lZCA9IG51bGwKCiAgICB0aGlzLl9zdXNwZW5kZWQgPSBmYWxzZQogICAgdGhpcy5fc3VzcGVuZGluZyA9IGZhbHNlCiAgICB0aGlzLl91cGRhdGluZyA9IGZhbHNlCiAgICB0aGlzLl91cGRhdGluZ1NpZ25hbCA9IG5ldyBTaWduYWxQcm9taXNlKCkKICAgIHRoaXMuX2NvbHVtbnNGbHVzaGVkID0gZmFsc2UKICAgIHRoaXMuX2xvY2sgPSBsb2NrCiAgICB0aGlzLl9yZWFkQmF0Y2hlcyA9IFtdCiAgICB0aGlzLl93cml0ZUJhdGNoZXMgPSBbXQoKICAgIGZvciAoY29uc3QgY29sdW1uRmFtaWx5IG9mIGNvbHVtbkZhbWlsaWVzKSB7CiAgICAgIHRoaXMuY29sdW1uRmFtaWxpZXMucHVzaCgKICAgICAgICB0eXBlb2YgY29sdW1uRmFtaWx5ID09PSAnc3RyaW5nJyA/IG5ldyBDb2x1bW5GYW1pbHkoY29sdW1uRmFtaWx5LCBvcHRzKSA6IGNvbHVtbkZhbWlseQogICAgICApCiAgICB9CgogICAgdGhpcy5faGFuZGxlID0gYmluZGluZy5pbml0KAogICAgICByZWFkT25seSwKICAgICAgY3JlYXRlSWZNaXNzaW5nLAogICAgICBjcmVhdGVNaXNzaW5nQ29sdW1uRmFtaWxpZXMsCiAgICAgIG1heEJhY2tncm91bmRKb2JzLAogICAgICBieXRlc1BlclN5bmMsCiAgICAgIG1heE9wZW5GaWxlcywKICAgICAgdXNlRGlyZWN0UmVhZHMsCiAgICAgIGF2b2lkVW5uZWNlc3NhcnlCbG9ja2luZ0lPLAogICAgICBza2lwU3RhdHNVcGRhdGVPbk9wZW4sCiAgICAgIHVzZURpcmVjdElPRm9yRmx1c2hBbmRDb21wYWN0aW9uLAogICAgICBtYXhGaWxlT3BlbmluZ1RocmVhZHMKICAgICkKICB9CgogIGNyZWF0ZVJlYWRCYXRjaChkYiwgb3B0cykgewogICAgaWYgKHRoaXMuX3JlYWRCYXRjaGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG5ldyBSZWFkQmF0Y2goZGIsIG9wdHMpCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuX3JlYWRCYXRjaGVzLnBvcCgpCiAgICBiYXRjaC5fcmV1c2UoZGIsIG9wdHMpCiAgICByZXR1cm4gYmF0Y2gKICB9CgogIGNyZWF0ZVdyaXRlQmF0Y2goZGIsIG9wdHMpIHsKICAgIGlmICh0aGlzLl93cml0ZUJhdGNoZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IFdyaXRlQmF0Y2goZGIsIG9wdHMpCiAgICBjb25zdCBiYXRjaCA9IHRoaXMuX3dyaXRlQmF0Y2hlcy5wb3AoKQogICAgYmF0Y2guX3JldXNlKGRiLCBvcHRzKQogICAgcmV0dXJuIGJhdGNoCiAgfQoKICBmcmVlQmF0Y2goYmF0Y2gsIHdyaXRhYmxlKSB7CiAgICBpZiAoYmF0Y2guX2NhcGFjaXR5ID4gMTYpIHJldHVybgogICAgY29uc3QgcXVldWUgPSB3cml0YWJsZSA/IHRoaXMuX3dyaXRlQmF0Y2hlcyA6IHRoaXMuX3JlYWRCYXRjaGVzCiAgICBpZiAocXVldWUubGVuZ3RoID49IE1BWF9CQVRDSF9SRVVTRSkgcmV0dXJuCiAgICBxdWV1ZS5wdXNoKGJhdGNoKQogIH0KCiAgYWRkU2Vzc2lvbihkYikgewogICAgZGIuX2luZGV4ID0gdGhpcy5zZXNzaW9ucy5wdXNoKGRiKSAtIDEKICAgIGlmIChkYi5fc25hcHNob3QpIGRiLl9zbmFwc2hvdC5yZWYoKQogIH0KCiAgcmVtb3ZlU2Vzc2lvbihkYikgewogICAgY29uc3QgaGVhZCA9IHRoaXMuc2Vzc2lvbnMucG9wKCkKICAgIGlmIChoZWFkICE9PSBkYikgdGhpcy5zZXNzaW9uc1soaGVhZC5faW5kZXggPSBkYi5faW5kZXgpXSA9IGhlYWQKICAgIGRiLl9pbmRleCA9IC0xCiAgICBpZiAoZGIuX3NuYXBzaG90KSBkYi5fc25hcHNob3QudW5yZWYoKQogIH0KCiAgdXBzZXJ0Q29sdW1uRmFtaWx5KGMpIHsKICAgIGlmICh0eXBlb2YgYyA9PT0gJ3N0cmluZycpIHsKICAgICAgbGV0IGNvbCA9IHRoaXMuZ2V0Q29sdW1uRmFtaWx5QnlOYW1lKGMpCiAgICAgIGlmIChjb2wpIHJldHVybiBjb2wKICAgICAgY29sID0gdGhpcy5jb2x1bW5GYW1pbGllc1swXS5jbG9uZVNldHRpbmdzKGMpCiAgICAgIHRoaXMuY29sdW1uRmFtaWxpZXMucHVzaChjb2wpCiAgICAgIHJldHVybiBjb2wKICAgIH0KCiAgICBpZiAodGhpcy5jb2x1bW5GYW1pbGllcy5pbmNsdWRlcyhjKSkgcmV0dXJuIGMKICAgIHRoaXMuY29sdW1uRmFtaWxpZXMucHVzaChjKQogICAgcmV0dXJuIGMKICB9CgogIGdldENvbHVtbkZhbWlseShjKSB7CiAgICBpZiAoIWMpIHJldHVybiB0aGlzLmNvbHVtbkZhbWlsaWVzWzBdCiAgICBpZiAoIXRoaXMuX2NvbHVtbnNGbHVzaGVkKSByZXR1cm4gdGhpcy51cHNlcnRDb2x1bW5GYW1pbHkoYykKCiAgICBpZiAodHlwZW9mIGMgIT09ICdzdHJpbmcnKSByZXR1cm4gYwoKICAgIGNvbnN0IGNvbCA9IHRoaXMuZ2V0Q29sdW1uRmFtaWx5QnlOYW1lKGMpCiAgICBpZiAoY29sID09PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gY29sdW1uIGZhbWlseScpCiAgICByZXR1cm4gY29sCiAgfQoKICBnZXRDb2x1bW5GYW1pbHlCeU5hbWUobmFtZSkgewogICAgZm9yIChjb25zdCBjb2wgb2YgdGhpcy5jb2x1bW5GYW1pbGllcykgewogICAgICBpZiAoY29sLm5hbWUgPT09IG5hbWUpIHJldHVybiBjb2wKICAgIH0KICAgIHJldHVybiBudWxsCiAgfQoKICBhc3luYyBfb3BlbigpIHsKICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpIC8vIEFsbG93IGNvbHVtbiBmYW1pbGllcyB0byBwb3B1bGF0ZSBpZiBvbi1kZW1hbmQKCiAgICBpZiAodGhpcy5fbG9jaykgYXdhaXQgdGhpcy5fbG9jay5yZWFkeSgpCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdGhpcy5fY29sdW1uc0ZsdXNoZWQgPSB0cnVlCgogICAgY29uc3QgbG9jayA9IHRoaXMuX2xvY2sgPT09IG51bGwgPyAtMSA6IHRoaXMuX2xvY2sudHJhbnNmZXIoKQoKICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLm9wZW4oCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgdGhpcywKICAgICAgdGhpcy5wYXRoLAogICAgICB0aGlzLmNvbHVtbkZhbWlsaWVzLm1hcCgoYykgPT4gYy5faGFuZGxlKSwKICAgICAgbG9jaywKICAgICAgcmVxLAogICAgICBvbm9wZW4KICAgICkKCiAgICBhd2FpdCBwcm9taXNlCgogICAgdGhpcy5kZWZlclNuYXBzaG90SW5pdCA9IGZhbHNlCgogICAgZm9yIChjb25zdCBzZXNzaW9uIG9mIHRoaXMuc2Vzc2lvbnMpIHsKICAgICAgaWYgKHNlc3Npb24uX3NuYXBzaG90KSBzZXNzaW9uLl9zbmFwc2hvdC5faW5pdCgpCiAgICB9CgogICAgZnVuY3Rpb24gb25vcGVuKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIGFzeW5jIF9jbG9zZSgpIHsKICAgIHdoaWxlICh0aGlzLl91cGRhdGluZykgYXdhaXQgdGhpcy5fdXBkYXRpbmdTaWduYWwud2FpdCgpCiAgICBpZiAodGhpcy5yZXN1bWVkKSB0aGlzLnJlc3VtZWQucmVzb2x2ZShmYWxzZSkKCiAgICB3aGlsZSAoIXRoaXMuaW8uaXNJZGxlKCkpIGF3YWl0IHRoaXMuaW8uaWRsZSgpCiAgICB3aGlsZSAoIXRoaXMuaGFuZGxlcy5pc0lkbGUoKSkgYXdhaXQgdGhpcy5oYW5kbGVzLmlkbGUoKQoKICAgIHdoaWxlICh0aGlzLnNlc3Npb25zLmxlbmd0aCA+IDApIHsKICAgICAgYXdhaXQgdGhpcy5zZXNzaW9uc1t0aGlzLnNlc3Npb25zLmxlbmd0aCAtIDFdLmNsb3NlKCkKICAgIH0KCiAgICBmb3IgKGNvbnN0IGNvbHVtbkZhbWlseSBvZiB0aGlzLmNvbHVtbkZhbWlsaWVzKSBjb2x1bW5GYW1pbHkuZGVzdHJveSgpCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuY2xvc2UodGhpcy5faGFuZGxlLCByZXEsIG9uY2xvc2UpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgcHJvbWlzZQogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKHRoaXMuX2xvY2spIGF3YWl0IHRoaXMuX2xvY2suY2xvc2UoKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UoZXJyKSB7CiAgICAgIGlmIChlcnIpIHJlcS5yZWplY3QobmV3IEVycm9yKGVycikpCiAgICAgIGVsc2UgcmVxLnJlc29sdmUoKQogICAgfQogIH0KCiAgYXN5bmMgZmx1c2goZGIsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuaW8uaW5jKCkKCiAgICBpZiAodGhpcy5yZXN1bWVkICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJlc3VtZWQgPSBhd2FpdCB0aGlzLnJlc3VtZWQucHJvbWlzZQoKICAgICAgaWYgKCFyZXN1bWVkKSB7CiAgICAgICAgdGhpcy5pby5kZWMoKQoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JvY2tzREIgc2Vzc2lvbiBpcyBjbG9zZWQnKQogICAgICB9CiAgICB9CgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgdHJ5IHsKICAgICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcuZmx1c2godGhpcy5faGFuZGxlLCBkYi5fY29sdW1uRmFtaWx5Ll9oYW5kbGUsIHJlcSwgb25mbHVzaCkKCiAgICAgIGF3YWl0IHByb21pc2UKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuaW8uZGVjKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmZsdXNoKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIHN1c3BlbmQoKSB7CiAgICB0aGlzLl9zdXNwZW5kaW5nID0gdHJ1ZQogICAgcmV0dXJuIHRoaXMudXBkYXRlKCkKICB9CgogIHJlc3VtZSgpIHsKICAgIHRoaXMuX3N1c3BlbmRpbmcgPSBmYWxzZQogICAgcmV0dXJuIHRoaXMudXBkYXRlKCkKICB9CgogIGFzeW5jIHVwZGF0ZSgpIHsKICAgIHdoaWxlICh0aGlzLl91cGRhdGluZykgYXdhaXQgdGhpcy5fdXBkYXRpbmdTaWduYWwud2FpdCgpCiAgICBpZiAodGhpcy5fc3VzcGVuZGluZyA9PT0gdGhpcy5fc3VzcGVuZGVkIHx8IHRoaXMuY2xvc2luZykgcmV0dXJuCiAgICB0aGlzLl91cGRhdGluZyA9IHRydWUKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLl9zdXNwZW5kaW5nKSBhd2FpdCB0aGlzLl9zdXNwZW5kKCkKICAgICAgZWxzZSBhd2FpdCB0aGlzLl9yZXN1bWUoKQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fdXBkYXRpbmcgPSBmYWxzZQogICAgICB0aGlzLl91cGRhdGluZ1NpZ25hbC5ub3RpZnkoKQogICAgfQogIH0KCiAgYXN5bmMgX3N1c3BlbmQoKSB7CiAgICBpZiAodGhpcy5fc3VzcGVuZGVkID09PSB0cnVlKSByZXR1cm4KCiAgICB3aGlsZSAoIXRoaXMuaW8uaXNJZGxlKCkpIGF3YWl0IHRoaXMuaW8uaWRsZSgpCgogICAgdGhpcy5pby5pbmMoKQogICAgdGhpcy5yZXN1bWVkID0gcnJwKCkKCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0cnkgewogICAgICByZXEuaGFuZGxlID0gYmluZGluZy5zdXNwZW5kKHRoaXMuX2hhbmRsZSwgcmVxLCBvbnN1c3BlbmQpCgogICAgICBhd2FpdCBwcm9taXNlCgogICAgICB0aGlzLl9zdXNwZW5kZWQgPSB0cnVlCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmlvLmRlYygpCiAgICB9CgogICAgZnVuY3Rpb24gb25zdXNwZW5kKGVycikgewogICAgICBpZiAoZXJyKSByZXEucmVqZWN0KG5ldyBFcnJvcihlcnIpKQogICAgICBlbHNlIHJlcS5yZXNvbHZlKCkKICAgIH0KICB9CgogIGFzeW5jIF9yZXN1bWUoKSB7CiAgICBpZiAodGhpcy5fc3VzcGVuZGVkID09PSBmYWxzZSkgcmV0dXJuCgogICAgY29uc3QgcmVxID0geyByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwsIGhhbmRsZTogbnVsbCB9CgogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgcmVxLnJlc29sdmUgPSByZXNvbHZlCiAgICAgIHJlcS5yZWplY3QgPSByZWplY3QKICAgIH0pCgogICAgcmVxLmhhbmRsZSA9IGJpbmRpbmcucmVzdW1lKHRoaXMuX2hhbmRsZSwgcmVxLCBvbnJlc3VtZSkKCiAgICBhd2FpdCBwcm9taXNlCgogICAgdGhpcy5fc3VzcGVuZGVkID0gZmFsc2UKCiAgICBjb25zdCByZXN1bWVkID0gdGhpcy5yZXN1bWVkCiAgICB0aGlzLnJlc3VtZWQgPSBudWxsCiAgICByZXN1bWVkLnJlc29sdmUodHJ1ZSkKCiAgICBmdW5jdGlvbiBvbnJlc3VtZShlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBhc3luYyBjb21wYWN0UmFuZ2UoZGIsIHN0YXJ0LCBlbmQsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuaW8uaW5jKCkKCiAgICBjb25zdCB7IGV4Y2x1c2l2ZSA9IGZhbHNlIH0gPSBvcHRzCgogICAgc3RhcnQgPSB0aGlzLl9lbmNvZGVLZXkoc3RhcnQpCiAgICBlbmQgPSB0aGlzLl9lbmNvZGVLZXkoZW5kKQoKICAgIGNvbnN0IHJlcSA9IHsgcmVzb2x2ZTogbnVsbCwgcmVqZWN0OiBudWxsLCBoYW5kbGU6IG51bGwsIHN0YXJ0LCBlbmQgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHJlcS5yZXNvbHZlID0gcmVzb2x2ZQogICAgICByZXEucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIHRyeSB7CiAgICAgIHJlcS5oYW5kbGUgPSBiaW5kaW5nLmNvbXBhY3RSYW5nZSgKICAgICAgICB0aGlzLl9oYW5kbGUsCiAgICAgICAgZGIuX2NvbHVtbkZhbWlseS5faGFuZGxlLAogICAgICAgIHN0YXJ0LAogICAgICAgIGVuZCwKICAgICAgICBleGNsdXNpdmUsCiAgICAgICAgcmVxLAogICAgICAgIG9uY29tcGFjdHJhbmdlCiAgICAgICkKCiAgICAgIGF3YWl0IHByb21pc2UKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuaW8uZGVjKCkKICAgIH0KCiAgICBmdW5jdGlvbiBvbmNvbXBhY3RyYW5nZShlcnIpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZSgpCiAgICB9CiAgfQoKICBhc3luYyBhcHByb3hpbWF0ZVNpemUoZGIsIHN0YXJ0LCBlbmQsIG9wdHMpIHsKICAgIGlmICh0aGlzLm9wZW5lZCA9PT0gZmFsc2UpIGF3YWl0IHRoaXMucmVhZHkoKQoKICAgIHRoaXMuaW8uaW5jKCkKCiAgICBjb25zdCB7IGluY2x1ZGVNZW10YWJsZXMgPSBmYWxzZSwgaW5jbHVkZUZpbGVzID0gdHJ1ZSwgZmlsZXNTaXplRXJyb3JNYXJnaW4gPSAtMSB9ID0gb3B0cwoKICAgIHN0YXJ0ID0gdGhpcy5fZW5jb2RlS2V5KHN0YXJ0KQogICAgZW5kID0gdGhpcy5fZW5jb2RlS2V5KGVuZCkKCiAgICBjb25zdCByZXEgPSB7IHJlc29sdmU6IG51bGwsIHJlamVjdDogbnVsbCwgaGFuZGxlOiBudWxsLCBzdGFydCwgZW5kIH0KCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICByZXEucmVzb2x2ZSA9IHJlc29sdmUKICAgICAgcmVxLnJlamVjdCA9IHJlamVjdAogICAgfSkKCiAgICB0cnkgewogICAgICByZXEuaGFuZGxlID0gYmluZGluZy5hcHByb3hpbWF0ZVNpemUoCiAgICAgICAgdGhpcy5faGFuZGxlLAogICAgICAgIGRiLl9jb2x1bW5GYW1pbHkuX2hhbmRsZSwKICAgICAgICBzdGFydCwKICAgICAgICBlbmQsCiAgICAgICAgaW5jbHVkZU1lbXRhYmxlcywKICAgICAgICBpbmNsdWRlRmlsZXMsCiAgICAgICAgZmlsZXNTaXplRXJyb3JNYXJnaW4sCiAgICAgICAgcmVxLAogICAgICAgIG9uYXBwcm94aW1hdGVzaXplCiAgICAgICkKCiAgICAgIHJldHVybiBhd2FpdCBwcm9taXNlCiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmlvLmRlYygpCiAgICB9CgogICAgZnVuY3Rpb24gb25hcHByb3hpbWF0ZXNpemUoZXJyLCByZXN1bHQpIHsKICAgICAgaWYgKGVycikgcmVxLnJlamVjdChuZXcgRXJyb3IoZXJyKSkKICAgICAgZWxzZSByZXEucmVzb2x2ZShyZXN1bHQpCiAgICB9CiAgfQoKICBfZW5jb2RlS2V5KGspIHsKICAgIGlmICh0aGlzLmRiLl9rZXlFbmNvZGluZykgcmV0dXJuIGMuZW5jb2RlKHRoaXMuZGIuX2tleUVuY29kaW5nLCBrKQogICAgaWYgKHR5cGVvZiBrID09PSAnc3RyaW5nJykgcmV0dXJuIEJ1ZmZlci5mcm9tKGspCiAgICBpZiAoayA9PT0gbnVsbCkgcmV0dXJuIGVtcHR5CiAgICByZXR1cm4gawogIH0KfQp7CiAgIm5hbWUiOiAicm9ja3NkYi1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjMuMTEuNCIsCiAgImRlc2NyaXB0aW9uIjogImxpYnJvY2tzZGIgYmluZGluZ3MgZm9yIEphdmFTY3JpcHQiLAogICJleHBvcnRzIjogewogICAgIi4iOiAiLi9pbmRleC5qcyIsCiAgICAiLi9wYWNrYWdlIjogIi4vcGFja2FnZS5qc29uIgogIH0sCiAgImltcG9ydHMiOiB7CiAgICAiZnMiOiAiYmFyZS1mcyIsCiAgICAiZGVmYXVsdCI6ICJmcyIKICB9LAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIsCiAgICAiYmluZGluZy5jYyIsCiAgICAiYmluZGluZy5qcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiLAogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIiwKICAgICIhcHJlYnVpbGRzL2FuZHJvaWQtKi8qKi8qLm5vZGUiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5qcyIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yb2Nrc2RiLW5hdGl2ZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMiLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vcm9ja3NkYi1uYXRpdmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9yb2Nrc2RiLW5hdGl2ZSIsCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTYuMCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiY29tcGFjdC1lbmNvZGluZyI6ICJeMi4xNS4wIiwKICAgICJyZWFkeS1yZXNvdXJjZSI6ICJeMS4wLjAiLAogICAgInJlZmNvdW50ZXIiOiAiXjEuMC4wIiwKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjAuMiIsCiAgICAicmVzb2x2ZS1yZWplY3QtcHJvbWlzZSI6ICJeMS4xLjAiLAogICAgInNpZ25hbC1wcm9taXNlIjogIl4xLjAuMyIsCiAgICAic3RyZWFteCI6ICJeMi4xNi4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuMCIsCiAgICAiYmFyZS1mcyI6ICJeNC41LjAiLAogICAgImJyaXR0bGUiOiAiXjMuNS4wIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjEuMTQiLAogICAgImNtYWtlLWZldGNoIjogIl4xLjAuMSIsCiAgICAiY21ha2UtbmFwaSI6ICJeMS4wLjYiLAogICAgImZkLWxvY2siOiAiXjIuMC4wIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIgogIH0KfQptb2R1bGUuZXhwb3J0cyA9IHNhZmV0eUNhdGNoCgpmdW5jdGlvbiBpc0FjdHVhbGx5VW5jYXVnaHQgKGVycikgewogIGlmICghZXJyKSByZXR1cm4gZmFsc2UKICByZXR1cm4gZXJyIGluc3RhbmNlb2YgVHlwZUVycm9yIHx8CiAgICBlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgUmVmZXJlbmNlRXJyb3IgfHwKICAgIGVyciBpbnN0YW5jZW9mIEV2YWxFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgUmFuZ2VFcnJvciB8fAogICAgZXJyIGluc3RhbmNlb2YgVVJJRXJyb3IgfHwKICAgIGVyci5jb2RlID09PSAnRVJSX0FTU0VSVElPTicKfQoKZnVuY3Rpb24gdGhyb3dFcnJvck5UIChlcnIpIHsKICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7IHRocm93IGVyciB9KQp9CgpmdW5jdGlvbiBzYWZldHlDYXRjaCAoZXJyKSB7CiAgaWYgKGlzQWN0dWFsbHlVbmNhdWdodChlcnIpKSB7CiAgICB0aHJvd0Vycm9yTlQoZXJyKQogICAgdGhyb3cgZXJyCiAgfQp9CnsKICAibmFtZSI6ICJzYWZldHktY2F0Y2giLAogICJ2ZXJzaW9uIjogIjEuMC4yIiwKICAiZGVzY3JpcHRpb24iOiAiU21hbGwgbW9kdWxlIHRoYXQgbWFrZXMgc3VyZSB5b3VyIGNhdGNoLCBjYXVnaHQgYW4gYWN0dWFsIGVycm9yIGFuZCBub3QgYSBwcm9ncmFtbWluZyBtaXN0YWtlIG9yIGFzc2VydGlvbiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjoge30sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NhZmV0eS1jYXRjaC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvc2FmZXR5LWNhdGNoL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NhZmV0eS1jYXRjaCIKfQpsZXQgdG1wUmVzb2x2ZSA9IG51bGwKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU2NvcGVMb2NrIHsKICBjb25zdHJ1Y3RvciAoeyBkZWJvdW5jZSA9IGZhbHNlIH0gPSB7fSkgewogICAgdGhpcy5kZWJvdW5jZSA9IGRlYm91bmNlCiAgICB0aGlzLndhaXRpbmcgPSBbXQogICAgdGhpcy5sb2NrZWQgPSBmYWxzZQogICAgdGhpcy5za2lwID0gMAogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZQogIH0KCiAgZmx1c2ggKCkgewogICAgaWYgKHRoaXMubG9ja2VkID09PSBmYWxzZSAmJiB0aGlzLndhaXRpbmcubGVuZ3RoID09PSAwKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuZGVzdHJveWVkID09PSBmYWxzZSkKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2Uoc2V0VG1wUmVzb2x2ZSkKICAgIGNvbnN0IHJlc29sdmUgPSB0bXBSZXNvbHZlCgogICAgdG1wUmVzb2x2ZSA9IG51bGwKICAgIHRoaXMud2FpdGluZy5wdXNoKHsgbG9jazogZmFsc2UsIHJlc29sdmUgfSkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWUKICB9CgogIGxvY2sgKCkgewogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHNldFRtcFJlc29sdmUpCiAgICBjb25zdCByZXNvbHZlID0gdG1wUmVzb2x2ZQoKICAgIHRtcFJlc29sdmUgPSBudWxsCgogICAgaWYgKHRoaXMubG9ja2VkID09PSB0cnVlKSB7CiAgICAgIHRoaXMud2FpdGluZy5wdXNoKHsgbG9jazogdHJ1ZSwgcmVzb2x2ZSB9KQogICAgICByZXR1cm4gcHJvbWlzZQogICAgfQoKICAgIGlmICh0aGlzLmRlc3Ryb3llZCA9PT0gdHJ1ZSkgewogICAgICByZXNvbHZlKGZhbHNlKQogICAgICByZXR1cm4gcHJvbWlzZQogICAgfQoKICAgIHRoaXMubG9ja2VkID0gdHJ1ZQogICAgcmVzb2x2ZSh0cnVlKQoKICAgIHJldHVybiBwcm9taXNlCiAgfQoKICB1bmxvY2sgKCkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkID09PSB0cnVlKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy53YWl0aW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy53YWl0aW5nW2ldLnJlc29sdmUoZmFsc2UpCiAgICAgIH0KICAgICAgdGhpcy53YWl0aW5nID0gW10KICAgICAgdGhpcy5za2lwID0gMAogICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICh0aGlzLnNraXAgIT09IDApIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNraXA7IGkrKykgewogICAgICAgIGNvbnN0IHsgbG9jaywgcmVzb2x2ZSB9ID0gdGhpcy53YWl0aW5nW2ldCiAgICAgICAgcmVzb2x2ZShsb2NrID09PSBmYWxzZSkKICAgICAgfQoKICAgICAgdGhpcy53YWl0aW5nID0gdGhpcy53YWl0aW5nLnNsaWNlKHRoaXMuc2tpcCkKICAgICAgdGhpcy5za2lwID0gMAogICAgfQoKICAgIHdoaWxlICh0aGlzLndhaXRpbmcubGVuZ3RoID4gMCAmJiB0aGlzLndhaXRpbmdbMF0ubG9jayA9PT0gZmFsc2UpIHsKICAgICAgdGhpcy53YWl0aW5nLnNoaWZ0KCkucmVzb2x2ZSh0cnVlKQogICAgfQoKICAgIGlmICh0aGlzLndhaXRpbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMubG9ja2VkID0gZmFsc2UKICAgICAgcmV0dXJuCiAgICB9CgogICAgY29uc3QgeyByZXNvbHZlIH0gPSB0aGlzLndhaXRpbmcuc2hpZnQoKQogICAgaWYgKHRoaXMuZGVib3VuY2UgPT09IHRydWUpIHRoaXMuc2tpcCA9IHRoaXMud2FpdGluZy5sZW5ndGgKCiAgICByZXNvbHZlKHRydWUpCiAgfQp9CgpmdW5jdGlvbiBzZXRUbXBSZXNvbHZlIChyZXNvbHZlKSB7CiAgdG1wUmVzb2x2ZSA9IHJlc29sdmUKfQp7CiAgIm5hbWUiOiAic2NvcGUtbG9jayIsCiAgInZlcnNpb24iOiAiMS4yLjQiLAogICJkZXNjcmlwdGlvbiI6ICJTb21lIGNvbmN1cnJlbmN5IHNlbWFudGljcyBhcm91bmQgZW50ZXJpbmcgc2NvcGVzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjcuMCIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMiIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2NvcGUtbG9jay5naXQiCiAgfSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Njb3BlLWxvY2svaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zY29wZS1sb2NrIgp9CmNvbnN0IHNldCA9IHJlcXVpcmUoJ3Vub3JkZXJlZC1zZXQnKQoKbW9kdWxlLmV4cG9ydHMgPSBvcHRzID0+IG5ldyBTaHVmZmxlZFByaW9yaXR5UXVldWUob3B0cykKCmNsYXNzIFNodWZmbGVkUHJpb3JpdHlRdWV1ZSB7CiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHRoaXMucHJpb3JpdGllcyA9IFtdCiAgICB0aGlzLmVxdWFscyA9IChvcHRzICYmIG9wdHMuZXF1YWxzKSB8fCBudWxsCiAgfQoKICBnZXQgbGVuZ3RoICgpIHsKICAgIHJldHVybiB0aGlzLnByaW9yaXRpZXMucmVkdWNlKGFkZCwgMCkKICB9CgogIFtTeW1ib2wuaXRlcmF0b3JdICgpIHsKICAgIHJldHVybiBuZXcgSXRlcmF0b3IodGhpcykKICB9CgogIGhlYWQgKCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMucHJpb3JpdGllcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBxID0gdGhpcy5wcmlvcml0aWVzW2ldCiAgICAgIGlmIChxLmxlbmd0aCkgcmV0dXJuIHNodWZmbGUocSwgMCkKICAgIH0KICAgIHJldHVybiBudWxsCiAgfQoKICB0YWlsICgpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wcmlvcml0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHEgPSB0aGlzLnByaW9yaXRpZXNbaV0KICAgICAgaWYgKHEubGVuZ3RoKSByZXR1cm4gc2h1ZmZsZShxLCAwKQogICAgfQogICAgcmV0dXJuIG51bGwKICB9CgogIHByZXYgKHByZXYpIHsKICAgIGlmICghcHJldikgcmV0dXJuIHRoaXMudGFpbCgpCiAgICByZXR1cm4gbmV4dCh0aGlzLnByaW9yaXRpZXMsIHByZXYsIDEpCiAgfQoKICBuZXh0IChwcmV2KSB7CiAgICBpZiAoIXByZXYpIHJldHVybiB0aGlzLmhlYWQoKQogICAgcmV0dXJuIG5leHQodGhpcy5wcmlvcml0aWVzLCBwcmV2LCAtMSkKICB9CgogIHNoaWZ0ICgpIHsKICAgIHJldHVybiB0aGlzLnJlbW92ZSh0aGlzLmhlYWQoKSkKICB9CgogIHBvcCAoKSB7CiAgICByZXR1cm4gdGhpcy5yZW1vdmUodGhpcy50YWlsKCkpCiAgfQoKICBhZGQgKHZhbCkgewogICAgY29uc3QgcHJpbyA9IHZhbC5wcmlvcml0eSB8fCAwCiAgICB3aGlsZSAocHJpbyA+PSB0aGlzLnByaW9yaXRpZXMubGVuZ3RoKSB0aGlzLnByaW9yaXRpZXMucHVzaChbXSkKICAgIHNldC5hZGQodGhpcy5wcmlvcml0aWVzW3ByaW9dLCB2YWwpCiAgICByZXR1cm4gdmFsCiAgfQoKICByZW1vdmUgKHZhbCkgewogICAgaWYgKCF2YWwpIHJldHVybiBudWxsCgogICAgaWYgKHZhbC5faW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICB2YWwgPSB0aGlzLmZpbmQodmFsKQogICAgICBpZiAoIXZhbCkgcmV0dXJuIG51bGwKICAgIH0KCiAgICByZXR1cm4gc2V0LnJlbW92ZSh0aGlzLnByaW9yaXRpZXNbdmFsLnByaW9yaXR5IHx8IDBdLCB2YWwpCiAgfQoKICBoYXMgKHZhbCkgewogICAgaWYgKHZhbC5faW5kZXggPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXMuZmluZCh2YWwpCiAgICBjb25zdCBwcmlvcml0eSA9IHZhbC5wcmlvcml0eSB8fCAwCiAgICBpZiAocHJpb3JpdHkgPj0gdGhpcy5wcmlvcml0aWVzLmxlbmd0aCkgcmV0dXJuIGZhbHNlCiAgICByZXR1cm4gc2V0Lmhhcyh0aGlzLnByaW9yaXRpZXNbcHJpb3JpdHldLCB2YWwpCiAgfQoKICBmaW5kICh2YWwpIHsKICAgIGlmICh2YWwuX2luZGV4ICE9PSB1bmRlZmluZWQpIHJldHVybiB2YWwKCiAgICBjb25zdCBwcmlvID0gdmFsLnByaW9yaXR5IHx8IDAKICAgIGNvbnN0IHFzID0gdGhpcy5wcmlvcml0aWVzCiAgICBpZiAocHJpbyA+PSBxcy5sZW5ndGgpIHJldHVybiBudWxsCgogICAgY29uc3QgcSA9IHFzW3ByaW9dCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLmVxdWFscyhxW2ldLCB2YWwpKSByZXR1cm4gcVtpXQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQp9CgpjbGFzcyBJdGVyYXRvciB7CiAgY29uc3RydWN0b3IgKHF1ZXVlKSB7CiAgICB0aGlzLnByZXYgPSBudWxsCiAgICB0aGlzLnF1ZXVlID0gcXVldWUKICB9CgogIG5leHQgKCkgewogICAgY29uc3QgbmV4dCA9IHRoaXMucXVldWUubmV4dCh0aGlzLnByZXYpCiAgICB0aGlzLnByZXYgPSBuZXh0CiAgICByZXR1cm4geyBkb25lOiAhbmV4dCwgdmFsdWU6IG5leHQgfQogIH0KfQoKZnVuY3Rpb24gc2h1ZmZsZSAocSwgaSkgewogIGNvbnN0IHJhbiA9IGkgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAocS5sZW5ndGggLSBpKSkKICBzZXQuc3dhcChxLCBxW3Jhbl0sIHFbaV0pCiAgcmV0dXJuIHFbaV0KfQoKZnVuY3Rpb24gbmV4dCAocXVldWVzLCBwcmV2LCBpbmMpIHsKICBsZXQgaSA9IHByZXYucHJpb3JpdHkgfHwgMAogIGxldCBqID0gKHByZXYuX2luZGV4IHx8IDApICsgMQoKICB3aGlsZSAodHJ1ZSkgewogICAgaWYgKGkgPCAwIHx8IGkgPj0gcXVldWVzLmxlbmd0aCkgcmV0dXJuIG51bGwKICAgIGNvbnN0IHEgPSBxdWV1ZXNbaV0KCiAgICBpZiAoaiA+PSBxLmxlbmd0aCkgewogICAgICBpICs9IGluYwogICAgICBqID0gMAogICAgICBjb250aW51ZQogICAgfQoKICAgIHJldHVybiBzaHVmZmxlKHEsIGopCiAgfQp9CgpmdW5jdGlvbiBhZGQgKGxlbiwgYikgewogIHJldHVybiBsZW4gKyBiLmxlbmd0aAp9CnsKICAibmFtZSI6ICJzaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSIsCiAgInZlcnNpb24iOiAiMi4xLjAiLAogICJkZXNjcmlwdGlvbiI6ICJBIHByaW9yaXR5IHF1ZXVlIHRoYXQgc2h1ZmZsZXMgZWxlbWVudHMgd2l0aCB0aGUgc2FtZSBwcmlvcml0eS4iLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAidW5vcmRlcmVkLXNldCI6ICJeMi4wLjEiCiAgfSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl4xMi4wLjEiLAogICAgInRhcGUiOiAiXjQuOS4xIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NodWZmbGVkLXByaW9yaXR5LXF1ZXVlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaHVmZmxlZC1wcmlvcml0eS1xdWV1ZSIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFNpZ25hbCB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5fcmVzb2x2ZSA9IG51bGwKICAgIHRoaXMuX3JlamVjdCA9IG51bGwKICAgIHRoaXMuX3Byb21pc2UgPSBudWxsCiAgICB0aGlzLl9iaW5kID0gYmluZC5iaW5kKHRoaXMpCiAgICB0aGlzLl9vbmVycm9yID0gY2xlYXIuYmluZCh0aGlzKQogICAgdGhpcy5fb25zdWNjZXNzID0gY2xlYXIuYmluZCh0aGlzLCBudWxsKQogICAgdGhpcy5fdGltZXJzID0gbmV3IFNldCgpCiAgfQoKICB3YWl0IChtYXgpIHsKICAgIGlmICghdGhpcy5fcHJvbWlzZSkgewogICAgICB0aGlzLl9wcm9taXNlID0gbmV3IFByb21pc2UodGhpcy5fYmluZCkKICAgICAgdGhpcy5fcHJvbWlzZS50aGVuKHRoaXMuX29uc3VjY2VzcykuY2F0Y2godGhpcy5fb25lcnJvcikKICAgIH0KICAgIGlmIChtYXgpIHJldHVybiB0aGlzLl9zbGVlcChtYXgpCiAgICByZXR1cm4gdGhpcy5fcHJvbWlzZQogIH0KCiAgX3NsZWVwIChtYXgpIHsKICAgIGNvbnN0IHMgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IGRvbmUgPSAoKSA9PiB7CiAgICAgICAgdGhpcy5fdGltZXJzLmRlbGV0ZShzdGF0ZSkKICAgICAgICByZXNvbHZlKHRydWUpCiAgICAgIH0KICAgICAgY29uc3QgaWQgPSBzZXRUaW1lb3V0KGRvbmUsIG1heCkKICAgICAgY29uc3Qgc3RhdGUgPSB7IGlkLCByZXNvbHZlLCByZWplY3QgfQogICAgICB0aGlzLl90aW1lcnMuYWRkKHN0YXRlKQogICAgfSkKCiAgICByZXR1cm4gcwogIH0KCiAgbm90aWZ5IChlcnIpIHsKICAgIGlmICghdGhpcy5fcHJvbWlzZSkgcmV0dXJuCiAgICBjb25zdCByZXNvbHZlID0gdGhpcy5fcmVzb2x2ZQogICAgY29uc3QgcmVqZWN0ID0gdGhpcy5fcmVqZWN0CiAgICB0aGlzLl9wcm9taXNlID0gbnVsbAogICAgaWYgKGVycikgcmVqZWN0KGVycikKICAgIGVsc2UgcmVzb2x2ZSh0cnVlKQogIH0KfQoKZnVuY3Rpb24gY2xlYXIgKGVycikgewogIGZvciAoY29uc3QgeyBpZCwgcmVzb2x2ZSwgcmVqZWN0IH0gb2YgdGhpcy5fdGltZXJzKSB7CiAgICBjbGVhclRpbWVvdXQoaWQpCiAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgZWxzZSByZXNvbHZlKHRydWUpCiAgfQogIHRoaXMuX3RpbWVycy5jbGVhcigpCn0KCmZ1bmN0aW9uIGJpbmQgKHJlc29sdmUsIHJlamVjdCkgewogIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlCiAgdGhpcy5fcmVqZWN0ID0gcmVqZWN0Cn0KewogICJuYW1lIjogInNpZ25hbC1wcm9taXNlIiwKICAidmVyc2lvbiI6ICIxLjAuMyIsCiAgImRlc2NyaXB0aW9uIjogIlNpbXBsZSB3YWl0L25vdGlmeSBwcm9taXNlIHdpdGggb3B0aW9uYWwgbWF4IHdhaXQgdGltZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjoge30sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NpZ25hbC1wcm9taXNlLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaWduYWwtcHJvbWlzZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zaWduYWwtcHJvbWlzZSIKfQp2YXIgdmFyaW50ID0gcmVxdWlyZSgndmFyaW50JykKZXhwb3J0cy5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUgKHYsIGIsIG8pIHsKICB2ID0gdiA+PSAwID8gdioyIDogdiotMiAtIDEKICB2YXIgciA9IHZhcmludC5lbmNvZGUodiwgYiwgbykKICBlbmNvZGUuYnl0ZXMgPSB2YXJpbnQuZW5jb2RlLmJ5dGVzCiAgcmV0dXJuIHIKfQpleHBvcnRzLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZSAoYiwgbykgewogIHZhciB2ID0gdmFyaW50LmRlY29kZShiLCBvKQogIGRlY29kZS5ieXRlcyA9IHZhcmludC5kZWNvZGUuYnl0ZXMKICByZXR1cm4gdiAmIDEgPyAodisxKSAvIC0yIDogdiAvIDIKfQoKZXhwb3J0cy5lbmNvZGluZ0xlbmd0aCA9IGZ1bmN0aW9uICh2KSB7CiAgcmV0dXJuIHZhcmludC5lbmNvZGluZ0xlbmd0aCh2ID49IDAgPyB2KjIgOiB2Ki0yIC0gMSkKfQp7CiAgIm5hbWUiOiAic2lnbmVkLXZhcmludCIsCiAgImRlc2NyaXB0aW9uIjogImVmZmljaWVudGx5IHN0b3JlIHNpZ25lZCBpbnRlZ2VycyBpbiB2YXJpbnQiLAogICJ2ZXJzaW9uIjogIjIuMC4xIiwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2RvbWluaWN0YXJyL3NpZ25lZC12YXJpbnQiLAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0Oi8vZ2l0aHViLmNvbS9kb21pbmljdGFyci9zaWduZWQtdmFyaW50LmdpdCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAidmFyaW50IjogIn41LjAuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAidGFwZSI6ICJ+Mi4xMi4zIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJub2RlIHRlc3QuanMiCiAgfSwKICAiYXV0aG9yIjogIkRvbWluaWMgVGFyciA8ZG9taW5pYy50YXJyQGdtYWlsLmNvbT4gKGh0dHA6Ly9kb21pbmljdGFyci5jb20pIiwKICAibGljZW5zZSI6ICJNSVQiCn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4vYmluZGluZycpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgpmdW5jdGlvbiBwcmVkaWNhdGUodTgsIHUxNiwgdTMyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHByZWRpY2F0ZShidWYpIHsKICAgIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGNvbnN0IG4gPSBidWYuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgcmV0dXJuIHU4KGJ1ZikKICAgIGlmIChuID09PSAyKSByZXR1cm4gdTE2KGJ1ZikKICAgIHJldHVybiB1MzIoYnVmKQogIH0KfQoKZnVuY3Rpb24gdW5hcnkodTgsIHUxNiwgdTMyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHVuYXJ5KGJ1ZiwgcmVzdWx0ID0gYjRhLmFsbG9jVW5zYWZlKGJ1Zi5ieXRlTGVuZ3RoKSkgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICE9PSByZXN1bHQuYnl0ZUxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xlbmd0aCBvZiByZXN1bHQgYnVmZmVyIGlzIGluc3VmZmljaWVudCcpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSB1OChidWYsIHJlc3VsdCkKICAgIGVsc2UgaWYgKG4gPT09IDIpIHUxNihidWYsIHJlc3VsdCkKICAgIGVsc2UgdTMyKGJ1ZiwgcmVzdWx0KQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIGJpbmFyeSh1OCwgdTE2LCB1MzIpIHsKICByZXR1cm4gZnVuY3Rpb24gYmluYXJ5KGEsIGIsIHJlc3VsdCA9IGI0YS5hbGxvY1Vuc2FmZShhLmJ5dGVMZW5ndGgpKSB7CiAgICBpZiAoYS5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgaWYgKGEuYnl0ZUxlbmd0aCAhPT0gYi5ieXRlTGVuZ3RoIHx8IGEuYnl0ZUxlbmd0aCAhPT0gcmVzdWx0LmJ5dGVMZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXJzIG11c3QgYmUgdGhlIHNhbWUgbGVuZ3RoJykKICAgIH0KCiAgICBjb25zdCBuID0gYS5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSB1OChhLCBiLCByZXN1bHQpCiAgICBlbHNlIGlmIChuID09PSAyKSB1MTYoYSwgYiwgcmVzdWx0KQogICAgZWxzZSB1MzIoYSwgYiwgcmVzdWx0KQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIHJlZHVjZSh1OCwgdTE2LCB1MzIpIHsKICByZXR1cm4gZnVuY3Rpb24gcmVkdWNlKGJ1ZikgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSByZXR1cm4gdTgoYnVmKQogICAgaWYgKG4gPT09IDIpIHJldHVybiB1MTYoYnVmKQogICAgcmV0dXJuIHUzMihidWYpCiAgfQp9CgpleHBvcnRzLmFsbG8gPSBwcmVkaWNhdGUoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbG9fdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsb192MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsb192MTI4X3UzMgopCgpleHBvcnRzLmFsbHogPSBwcmVkaWNhdGUoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FsbHpfdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsel92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYWxsel92MTI4X3UzMgopCgpleHBvcnRzLmFuZCA9IGJpbmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYW5kX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2FuZF92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfYW5kX3YxMjhfdTMyCikKCmV4cG9ydHMuY2xlYXIgPSBiaW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NsZWFyX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NsZWFyX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbGVhcl92MTI4X3UzMgopCgpleHBvcnRzLmNsbyA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbG9fdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2xvX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbG9fdjEyOF91MzIKKQoKZXhwb3J0cy5jbHogPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2x6X3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2Nsel92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY2x6X3YxMjhfdTMyCikKCmV4cG9ydHMuY250ID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NudF92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jbnRfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2NudF92MTI4X3UzMgopCgpleHBvcnRzLmN0byA9IHVuYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdG9fdjEyOF91OCwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3RvX3YxMjhfdTE2LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9jdG9fdjEyOF91MzIKKQoKZXhwb3J0cy5jdHogPSB1bmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3R6X3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX2N0el92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfY3R6X3YxMjhfdTMyCikKCmV4cG9ydHMubm90ID0gdW5hcnkoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX25vdF92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9ub3RfdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX25vdF92MTI4X3UzMgopCgpleHBvcnRzLm9yID0gYmluYXJ5KAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9vcl92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9vcl92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfb3JfdjEyOF91MzIKKQoKZXhwb3J0cy5zdW0gPSByZWR1Y2UoCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3N1bV92MTI4X3U4LAogIGJpbmRpbmcuc2ltZGxlX25hdGl2ZV9zdW1fdjEyOF91MTYsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3N1bV92MTI4X3UzMgopCgpleHBvcnRzLnhvciA9IGJpbmFyeSgKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfeG9yX3YxMjhfdTgsCiAgYmluZGluZy5zaW1kbGVfbmF0aXZlX3hvcl92MTI4X3UxNiwKICBiaW5kaW5nLnNpbWRsZV9uYXRpdmVfeG9yX3YxMjhfdTMyCikKewogICJuYW1lIjogInNpbWRsZS1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjEuMy45IiwKICAiZGVzY3JpcHRpb24iOiAibGlic2ltZGxlIEphdmFTY3JpcHQgYmluZGluZ3MgZm9yIE5vZGUuanMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImJpbmRpbmcuY2MiLAogICAgImJpbmRpbmcuanMiLAogICAgIkNNYWtlTGlzdHMudHh0IiwKICAgICJwcmVidWlsZHMiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC5tanMiLAogICAgInRlc3Q6bm9kZSI6ICJub2RlIHRlc3QubWpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS1uYXRpdmUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLW5hdGl2ZS9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NpbWRsZS1uYXRpdmUjcmVhZG1lIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS42LjAiLAogICAgInJlcXVpcmUtYWRkb24iOiAiXjEuMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuMiIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS43IiwKICAgICJjbWFrZS1mZXRjaCI6ICJeMS4xLjAiLAogICAgImNtYWtlLW5hcGkiOiAiXjEuMC4yIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjEuMC4wIgogIH0KfQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBzY2FsYXIgPSByZXF1aXJlKCcuL3NjYWxhcicpCgpmdW5jdGlvbiB2aWV3IChidWYsIG4pIHsKICBpZiAobiA9PT0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UKSByZXR1cm4gYnVmCgogIGxldCBUeXBlZEFycmF5CgogIGlmIChuID09PSAxKSBUeXBlZEFycmF5ID0gVWludDhBcnJheQogIGVsc2UgaWYgKG4gPT09IDIpIFR5cGVkQXJyYXkgPSBVaW50MTZBcnJheQogIGVsc2UgVHlwZWRBcnJheSA9IFVpbnQzMkFycmF5CgogIHJldHVybiBuZXcgVHlwZWRBcnJheShidWYuYnVmZmVyLCBidWYuYnl0ZU9mZnNldCwgYnVmLmJ5dGVMZW5ndGggLyBuKQp9CgpmdW5jdGlvbiB1bmFyeSAodTgsIHUxNiA9IHU4LCB1MzIgPSB1MTYpIHsKICByZXR1cm4gZnVuY3Rpb24gdW5hcnkgKGJ1ZiwgcmVzdWx0ID0gYjRhLmFsbG9jVW5zYWZlKGJ1Zi5ieXRlTGVuZ3RoKSkgewogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICUgMTYgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdWZmZXIgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNicpCiAgICB9CgogICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoICE9PSByZXN1bHQuYnl0ZUxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xlbmd0aCBvZiByZXN1bHQgYnVmZmVyIGlzIGluc3VmZmljaWVudCcpCiAgICB9CgogICAgY29uc3QgbiA9IGJ1Zi5CWVRFU19QRVJfRUxFTUVOVAoKICAgIGlmIChuID09PSAxKSB1OChidWYsIHZpZXcocmVzdWx0LCBuKSkKICAgIGVsc2UgaWYgKG4gPT09IDIpIHUxNihidWYsIHZpZXcocmVzdWx0LCBuKSkKICAgIGVsc2UgdTMyKGJ1ZiwgdmlldyhyZXN1bHQsIG4pKQoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KCmZ1bmN0aW9uIGJpbmFyeSAodTgsIHUxNiA9IHU4LCB1MzIgPSB1MTYpIHsKICByZXR1cm4gZnVuY3Rpb24gYmluYXJ5IChhLCBiLCByZXN1bHQgPSBiNGEuYWxsb2NVbnNhZmUoYS5ieXRlTGVuZ3RoKSkgewogICAgaWYgKGEuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQogICAgfQoKICAgIGlmIChhLmJ5dGVMZW5ndGggIT09IGIuYnl0ZUxlbmd0aCB8fCBhLmJ5dGVMZW5ndGggIT09IHJlc3VsdC5ieXRlTGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnVmZmVycyBtdXN0IGJlIHRoZSBzYW1lIGxlbmd0aCcpCiAgICB9CgogICAgY29uc3QgbiA9IGEuQllURVNfUEVSX0VMRU1FTlQKCiAgICBpZiAobiA9PT0gMSkgdTgoYSwgYiwgdmlldyhyZXN1bHQsIG4pKQogICAgZWxzZSBpZiAobiA9PT0gMikgdTE2KGEsIGIsIHZpZXcocmVzdWx0LCBuKSkKICAgIGVsc2UgdTMyKGEsIGIsIHZpZXcocmVzdWx0LCBuKSkKCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiByZWR1Y2UgKHU4LCB1MTYgPSB1OCwgdTMyID0gdTE2KSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHJlZHVjZSAoYnVmKSB7CiAgICBpZiAoYnVmLmJ5dGVMZW5ndGggJSAxNiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICAgIH0KCiAgICBjb25zdCBuID0gYnVmLkJZVEVTX1BFUl9FTEVNRU5UCgogICAgaWYgKG4gPT09IDEpIHJldHVybiB1OChidWYpCiAgICBpZiAobiA9PT0gMikgcmV0dXJuIHUxNihidWYpCiAgICByZXR1cm4gdTMyKGJ1ZikKICB9Cn0KCmV4cG9ydHMuYWxsbyA9IGZ1bmN0aW9uIGFsbG8gKGJ1ZikgewogIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICB9CgogIGNvbnN0IG0gPSAyICoqIChidWYuQllURVNfUEVSX0VMRU1FTlQgKiA4KSAtIDEKCiAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICBpZiAoYnVmW2ldICE9PSBtKSByZXR1cm4gZmFsc2UKICB9CgogIHJldHVybiB0cnVlCn0KCmV4cG9ydHMuYWxseiA9IGZ1bmN0aW9uIGFsbHogKGJ1ZikgewogIGlmIChidWYuYnl0ZUxlbmd0aCAlIDE2ICE9PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0J1ZmZlciBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2JykKICB9CgogIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgaWYgKGJ1ZltpXSAhPT0gMCkgcmV0dXJuIGZhbHNlCiAgfQoKICByZXR1cm4gdHJ1ZQp9CgpleHBvcnRzLmFuZCA9IGJpbmFyeSgKICAoYSwgYiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHJlc3VsdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gYVtpXSAmIGJbaV0KICAgIH0KICB9CikKCmV4cG9ydHMuY2xlYXIgPSBiaW5hcnkoCiAgKGEsIGIsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSByZXN1bHQubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IGFbaV0gJiB+YltpXQogICAgfQogIH0KKQoKZXhwb3J0cy5jbG8gPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSAyNCAtIHNjYWxhci5jbG8oYnVmW2ldKQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gMTYgLSBzY2FsYXIuY2xvKGJ1ZltpXSkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbG8oYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5jbHogPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSAyNCAtIHNjYWxhci5jbHooYnVmW2ldKQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gMTYgLSBzY2FsYXIuY2x6KGJ1ZltpXSkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbHooYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5jbnQgPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY250KGJ1ZltpXSkgJiAweGZmCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY250KGJ1ZltpXSkgJiAweGZmZmYKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IHNjYWxhci5jbnQoYnVmW2ldKQogICAgfQogIH0KKQoKZXhwb3J0cy5jdG8gPSB1bmFyeSgKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBNYXRoLm1pbihzY2FsYXIuY3RvKGJ1ZltpXSksIDgpCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBNYXRoLm1pbihzY2FsYXIuY3RvKGJ1ZltpXSksIDE2KQogICAgfQogIH0sCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gc2NhbGFyLmN0byhidWZbaV0pCiAgICB9CiAgfQopCgpleHBvcnRzLmN0eiA9IHVuYXJ5KAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IE1hdGgubWluKHNjYWxhci5jdHooYnVmW2ldKSwgOCkKICAgIH0KICB9LAogIChidWYsIHJlc3VsdCkgPT4gewogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBidWYubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IE1hdGgubWluKHNjYWxhci5jdHooYnVmW2ldKSwgMTYpCiAgICB9CiAgfSwKICAoYnVmLCByZXN1bHQpID0+IHsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHRbaV0gPSBzY2FsYXIuY3R6KGJ1ZltpXSkKICAgIH0KICB9CikKCmV4cG9ydHMubm90ID0gdW5hcnkoCiAgKGJ1ZiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGJ1Zi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gfmJ1ZltpXQogICAgfQogIH0KKQoKZXhwb3J0cy5vciA9IGJpbmFyeSgKICAoYSwgYiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHJlc3VsdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gYVtpXSB8IGJbaV0KICAgIH0KICB9CikKCmV4cG9ydHMuc3VtID0gcmVkdWNlKAogIChidWYpID0+IHsKICAgIGxldCByZXN1bHQgPSAwbgoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gYnVmLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICByZXN1bHQgKz0gQmlnSW50KGJ1ZltpXSkKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0CiAgfQopCgpleHBvcnRzLnhvciA9IGJpbmFyeSgKICAoYSwgYiwgcmVzdWx0KSA9PiB7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHJlc3VsdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcmVzdWx0W2ldID0gYVtpXSBeIGJbaV0KICAgIH0KICB9CikKdHJ5IHsKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJ3NpbWRsZS1uYXRpdmUnKQp9IGNhdGNoIHsKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vZmFsbGJhY2snKQp9CnsKICAibmFtZSI6ICJzaW1kbGUtdW5pdmVyc2FsIiwKICAidmVyc2lvbiI6ICIxLjEuMiIsCiAgImRlc2NyaXB0aW9uIjogIlVuaXZlcnNhbCB3cmFwcGVyIGZvciBsaWJzaW1kbGUgd2l0aCBhIEphdmFTY3JpcHQgZmFsbGJhY2siLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiZmFsbGJhY2suanMiLAogICAgImluZGV4LmpzIiwKICAgICJzY2FsYXIuanMiCiAgXSwKICAiYnJvd3NlciI6IHsKICAgICIuL2luZGV4LmpzIjogIi4vZmFsbGJhY2suanMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5tanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLXVuaXZlcnNhbC5naXQiCiAgfSwKICAiYXV0aG9yIjogIkthc3BlciBJc2FnZXIgRGFsc2dhcsOwIDxrYXNwZXJAZnVua3Rpb25lbC5jbz4iLAogICJsaWNlbnNlIjogIklTQyIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zaW1kbGUtdW5pdmVyc2FsL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc2ltZGxlLXVuaXZlcnNhbCNyZWFkbWUiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuMCIKICB9LAogICJvcHRpb25hbERlcGVuZGVuY2llcyI6IHsKICAgICJzaW1kbGUtbmF0aXZlIjogIl4xLjEuMSIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfQp9CmNvbnN0IGNseiA9IGV4cG9ydHMuY2x6ID0gZnVuY3Rpb24gY2x6IChuKSB7CiAgcmV0dXJuIE1hdGguY2x6MzIobikKfQoKZXhwb3J0cy5jbG8gPSBmdW5jdGlvbiBjbG8gKG4pIHsKICByZXR1cm4gY2x6KH5uKQp9Cgpjb25zdCBjdHogPSBleHBvcnRzLmN0eiA9IGZ1bmN0aW9uIGN0eiAobikgewogIHJldHVybiAzMiAtIChuID09PSAwID8gMCA6IChjbHoobiAmIC1uKSArIDEpKQp9CgpleHBvcnRzLmN0byA9IGZ1bmN0aW9uIGN0byAobikgewogIHJldHVybiBjdHoofm4pCn0KCmV4cG9ydHMuY250ID0gZnVuY3Rpb24gY250IChuKSB7CiAgbiA9IG4gLSAoKG4gPj4+IDEpICYgMHg1NTU1NTU1NSkKICBuID0gKG4gJiAweDMzMzMzMzMzKSArICgobiA+Pj4gMikgJiAweDMzMzMzMzMzKQogIG4gPSAobiArIChuID4+PiA0KSkgJiAweDBmMGYwZjBmCiAgbiA9IChuICogMHgwMTAxMDEwMSkgPj4+IDI0CiAgcmV0dXJuIG4KfQpyZXF1aXJlLmFkZG9uID0gcmVxdWlyZSgncmVxdWlyZS1hZGRvbicpCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZS5hZGRvbignLicsIF9fZmlsZW5hbWUpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuL2JpbmRpbmcnKQpjb25zdCB7IGlzTm9kZSB9ID0gcmVxdWlyZSgnd2hpY2gtcnVudGltZScpCgpjb25zdCBPUFRJT05BTCA9IEJ1ZmZlci5mcm9tKG5ldyBBcnJheUJ1ZmZlcigwKSkKCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsgLi4uYmluZGluZyB9CgovLyBtZW1vcnkKCmV4cG9ydHMuc29kaXVtX21lbXplcm8gPSBmdW5jdGlvbiAoYnVmKSB7CiAgYmluZGluZy5zb2RpdW1fbWVtemVybyhidWYpCn0KCmV4cG9ydHMuc29kaXVtX21sb2NrID0gZnVuY3Rpb24gKGJ1ZikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuc29kaXVtX21sb2NrKGJ1ZikKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ21lbW9yeSBsb2NrIGZhaWxlZCcpCn0KCmV4cG9ydHMuc29kaXVtX211bmxvY2sgPSBmdW5jdGlvbiAoYnVmKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5zb2RpdW1fbXVubG9jayhidWYpCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdtZW1vcnkgdW5sb2NrIGZhaWxlZCcpCn0KCmV4cG9ydHMuc29kaXVtX21hbGxvYyA9IGZ1bmN0aW9uIChzaXplKSB7CiAgaWYgKHNpemUgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgc2l6ZScpCiAgY29uc3QgYnVmID0gQnVmZmVyLmZyb20oYmluZGluZy5zb2RpdW1fbWFsbG9jKHNpemUpKQogIGJ1Zi5zZWN1cmUgPSB0cnVlCgogIHJldHVybiBidWYKfQoKZXhwb3J0cy5zb2RpdW1fZnJlZSA9IGZ1bmN0aW9uIChidWYpIHsKICBpZiAoIWJ1Zj8uc2VjdXJlKSByZXR1cm4KCiAgYmluZGluZy5zb2RpdW1fZnJlZShidWYuYnVmZmVyKQp9CgpleHBvcnRzLnNvZGl1bV9tcHJvdGVjdF9ub2FjY2VzcyA9IGZ1bmN0aW9uIChidWYpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLnNvZGl1bV9tcHJvdGVjdF9ub2FjY2VzcyhidWYuYnVmZmVyKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBsb2NrIGJ1ZmZlcicpCn0KCmV4cG9ydHMuc29kaXVtX21wcm90ZWN0X3JlYWRvbmx5ID0gZnVuY3Rpb24gKGJ1ZikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuc29kaXVtX21wcm90ZWN0X3JlYWRvbmx5KGJ1Zi5idWZmZXIpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIHVubG9jayBidWZmZXInKQp9CgpleHBvcnRzLnNvZGl1bV9tcHJvdGVjdF9yZWFkd3JpdGUgPSBmdW5jdGlvbiAoYnVmKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5zb2RpdW1fbXByb3RlY3RfcmVhZHdyaXRlKGJ1Zi5idWZmZXIpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIHVubG9jayBidWZmZXInKQp9CgovLyBjcnlwdG9fcmFuZG9tYnl0ZXMKCmV4cG9ydHMucmFuZG9tYnl0ZXNfYnVmID0gZnVuY3Rpb24gKGJ1ZmZlcikgewogIGJpbmRpbmcucmFuZG9tYnl0ZXNfYnVmKGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCkKfQoKZXhwb3J0cy5yYW5kb21ieXRlc19idWZfZGV0ZXJtaW5pc3RpYyA9IGZ1bmN0aW9uIChidWZmZXIsIHNlZWQpIHsKICBiaW5kaW5nLnJhbmRvbWJ5dGVzX2J1Zl9kZXRlcm1pbmlzdGljKAogICAgYnVmZmVyLmJ1ZmZlciwKICAgIGJ1ZmZlci5ieXRlT2Zmc2V0LAogICAgYnVmZmVyLmJ5dGVMZW5ndGgsCgogICAgc2VlZC5idWZmZXIsCiAgICBzZWVkLmJ5dGVPZmZzZXQsCiAgICBzZWVkLmJ5dGVMZW5ndGgKICApCn0KCi8vIHNvZGl1bV9oZWxwZXJzCgpleHBvcnRzLnNvZGl1bV9tZW1jbXAgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhPy5ieXRlTGVuZ3RoICE9PSBiPy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWZmZXJzIG11c3QgYmUgb2Ygc2FtZSBsZW5ndGgiJykKICByZXR1cm4gYmluZGluZy5zb2RpdW1fbWVtY21wKGEsIGIpCn0KCmV4cG9ydHMuc29kaXVtX2FkZCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgaWYgKGE/LmJ5dGVMZW5ndGggIT09IGI/LmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1ZmZlcnMgbXVzdCBiZSBvZiBzYW1lIGxlbmd0aCInKQogIGJpbmRpbmcuc29kaXVtX2FkZChhLCBiKQp9CgpleHBvcnRzLnNvZGl1bV9zdWIgPSBmdW5jdGlvbiAoYSwgYikgewogIGlmIChhPy5ieXRlTGVuZ3RoICE9PSBiPy5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWZmZXJzIG11c3QgYmUgb2Ygc2FtZSBsZW5ndGgiJykKICBiaW5kaW5nLnNvZGl1bV9zdWIoYSwgYikKfQoKZXhwb3J0cy5zb2RpdW1fY29tcGFyZSA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgaWYgKGE/LmJ5dGVMZW5ndGggIT09IGI/LmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2J1ZmZlcnMgbXVzdCBiZSBvZiBzYW1lIGxlbmd0aCInKQogIHJldHVybiBiaW5kaW5nLnNvZGl1bV9jb21wYXJlKGEsIGIpCn0KCmV4cG9ydHMuc29kaXVtX2lzX3plcm8gPSBmdW5jdGlvbiAoYnVmZmVyLCBsZW5ndGgpIHsKICBpZiAoIWJ1ZmZlcikgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGJ1ZmZlcicpCiAgbGVuZ3RoID8/PSBidWZmZXIuYnl0ZUxlbmd0aAogIGlmIChsZW5ndGggPiBidWZmZXIuYnl0ZUxlbmd0aCB8fCBsZW5ndGggPCAwKQogICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGxlbmd0aCcpCgogIHJldHVybiBiaW5kaW5nLnNvZGl1bV9pc196ZXJvKGJ1ZmZlciwgbGVuZ3RoKQp9CgpleHBvcnRzLnNvZGl1bV9wYWQgPSBmdW5jdGlvbiAoYnVmZmVyLCB1bnBhZGRlZEJ1ZmxlbiwgYmxvY2tTaXplKSB7CiAgaWYgKHVucGFkZGVkQnVmbGVuID4gYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3VucGFkZGVkIGxlbmd0aCBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPiBidWZmZXIuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYmxvY2sgc2l6ZSBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPCAxKSB0aHJvdyBuZXcgRXJyb3IoJ2Jsb2NrIHNpemVtdXN0IGJlIGF0IGxlYXN0IDEgYnl0ZScpCiAgaWYgKAogICAgYnVmZmVyPy5ieXRlTGVuZ3RoIDwKICAgIHVucGFkZGVkQnVmbGVuICsgKGJsb2NrU2l6ZSAtICh1bnBhZGRlZEJ1ZmxlbiAlIGJsb2NrU2l6ZSkpCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKCdidWYgbm90IGxvbmcgZW5vdWdoJykKCiAgcmV0dXJuIGJpbmRpbmcuc29kaXVtX3BhZChidWZmZXIsIHVucGFkZGVkQnVmbGVuLCBibG9ja1NpemUpCn0KCmV4cG9ydHMuc29kaXVtX3VucGFkID0gZnVuY3Rpb24gKGJ1ZmZlciwgcGFkZGVkQnVmbGVuLCBibG9ja1NpemUpIHsKICBpZiAocGFkZGVkQnVmbGVuID4gYnVmZmVyLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3VucGFkZGVkIGxlbmd0aCBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPiBidWZmZXIuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYmxvY2sgc2l6ZSBjYW5ub3QgZXhjZWVkIGJ1ZmZlciBsZW5ndGgnKQogIGlmIChibG9ja1NpemUgPCAxKSB0aHJvdyBuZXcgRXJyb3IoJ2Jsb2NrIHNpemUgbXVzdCBiZSBhdCBsZWFzdCAxIGJ5dGUnKQoKICByZXR1cm4gYmluZGluZy5zb2RpdW1fdW5wYWQoYnVmZmVyLCBwYWRkZWRCdWZsZW4sIGJsb2NrU2l6ZSkKfQoKLy8gY3J5cHRvX3NpZ24KCmV4cG9ydHMuY3J5cHRvX3NpZ25fa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2spIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9rZXlwYWlyKHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fc2VlZF9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaywgc2VlZCkgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX3NlZWRfa2V5cGFpcihwaywgc2ssIHNlZWQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduID0gZnVuY3Rpb24gKHNtLCBtLCBzaykgewogIGlmIChzbT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUyArIG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignc20gbXVzdCBiZSAibS5ieXRlTGVuZ3RoICsgY3J5cHRvX3NpZ25fQllURVMiIGJ5dGVzJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbihzbSwgbSwgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX29wZW4gPSBmdW5jdGlvbiAobSwgc20sIHBrKSB7CiAgaWYgKHNtPy5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzbScpCiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IHNtLmJ5dGVMZW5ndGggLSBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgInNtLmJ5dGVMZW5ndGggLSBjcnlwdG9fc2lnbl9CWVRFUyIgYnl0ZXMnKQogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaWduX29wZW4obSwgc20sIHBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl9vcGVuID0gZnVuY3Rpb24gKG0sIHNtLCBwaykgewogIGlmIChzbT8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpIHRocm93IG5ldyBFcnJvcignc20nKQogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBzbS5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fc2lnbl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJzbS5ieXRlTGVuZ3RoIC0gY3J5cHRvX3NpZ25fQllURVMiIGJ5dGVzJykKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3NpZ25fb3BlbihtLCBzbSwgcGspCn0KCmV4cG9ydHMuY3J5cHRvX3NpZ25fZGV0YWNoZWQgPSBmdW5jdGlvbiAoc2lnLCBtLCBzaykgewogIGlmIChzaWc/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fQllURVMpIHRocm93IG5ldyBFcnJvcignc2lnJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2lnbl9kZXRhY2hlZChzaWcsIG0sIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2lnbl92ZXJpZnlfZGV0YWNoZWQgPSBmdW5jdGlvbiAoc2lnLCBtLCBwaykgewogIHJldHVybiBiaW5kaW5nLmNyeXB0b19zaWduX3ZlcmlmeV9kZXRhY2hlZCgKICAgIHNpZy5idWZmZXIsCiAgICBzaWcuYnl0ZU9mZnNldCwKICAgIHNpZy5ieXRlTGVuZ3RoLAoKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIHBrLmJ1ZmZlciwKICAgIHBrLmJ5dGVPZmZzZXQsCiAgICBway5ieXRlTGVuZ3RoCiAgKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX2VkMjU1MTlfc2tfdG9fcGsgPSBmdW5jdGlvbiAocGssIHNrKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fZWQyNTUxOV9za190b19wayhwaywgc2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX2VkMjU1MTlfcGtfdG9fY3VydmUyNTUxOSA9IGZ1bmN0aW9uICh4MjU1MTlwaywgZWQyNTUxOXBrKSB7CiAgaWYgKHgyNTUxOXBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3gyNTUxOV9waycpCiAgaWYgKGVkMjU1MTlwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignZWQyNTUxOV9waycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fZWQyNTUxOV9wa190b19jdXJ2ZTI1NTE5KHgyNTUxOXBrLCBlZDI1NTE5cGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zaWduX2VkMjU1MTlfc2tfdG9fY3VydmUyNTUxOSA9IGZ1bmN0aW9uICh4MjU1MTlzaywgZWQyNTUxOXNrKSB7CiAgaWYgKHgyNTUxOXNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3gyNTUxOV9zaycpCgogIGNvbnN0IGVkTGVuID0gZWQyNTUxOXNrLmJ5dGVMZW5ndGgKCiAgaWYgKAogICAgZWRMZW4gIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMgJiYKICAgIGVkTGVuICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfU0VDUkVUS0VZQllURVMKICApIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgImVkMjU1MTlfc2sgc2hvdWxkIGVpdGhlciBiZSAnY3J5cHRvX3NpZ25fU0VDUkVUS0VZQllURVMnIGJ5dGVzIG9yICdjcnlwdG9fc2lnbl9TRUNSRVRLRVlCWVRFUyAtIGNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTJyBieXRlcyIKICAgICkKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NpZ25fZWQyNTUxOV9za190b19jdXJ2ZTI1NTE5KHgyNTUxOXNrLCBlZDI1NTE5c2spCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fYm94CgpleHBvcnRzLmNyeXB0b19ib3hfa2V5cGFpciA9IGZ1bmN0aW9uIChwaywgc2spIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYm94X1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9rZXlwYWlyKHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9zZWVkX2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrLCBzZWVkKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19ib3hfUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2s/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2JveF9TRUNSRVRLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19ib3hfc2VlZF9rZXlwYWlyKHBrLCBzaywgc2VlZCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9lYXN5ID0gZnVuY3Rpb24gKGMsIG0sIG4sIHBrLCBzaykgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9lYXN5KGMsIG0sIG4sIHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9kZXRhY2hlZCA9IGZ1bmN0aW9uIChjLCBtYWMsIG0sIG4sIHBrLCBzaykgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2JveF9kZXRhY2hlZChjLCBtYWMsIG0sIG4sIHBrLCBzaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2JveF9zZWFsID0gZnVuY3Rpb24gKGMsIG0sIHBrKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYm94X3NlYWwoYywgbSwgcGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19ib3hfc2VhbF9vcGVuID0gZnVuY3Rpb24gKG0sIGMsIHBrLCBzaykgewogIHJldHVybiBiaW5kaW5nLmNyeXB0b19ib3hfc2VhbF9vcGVuKAogICAgbS5idWZmZXIsCiAgICBtLmJ5dGVPZmZzZXQsCiAgICBtLmJ5dGVMZW5ndGgsCgogICAgYy5idWZmZXIsCiAgICBjLmJ5dGVPZmZzZXQsCiAgICBjLmJ5dGVMZW5ndGgsCgogICAgcGsuYnVmZmVyLAogICAgcGsuYnl0ZU9mZnNldCwKICAgIHBrLmJ5dGVMZW5ndGgsCgogICAgc2suYnVmZmVyLAogICAgc2suYnl0ZU9mZnNldCwKICAgIHNrLmJ5dGVMZW5ndGgKICApCn0KCi8vIGNyeXB0b19zZWNyZXRib3gKCmV4cG9ydHMuY3J5cHRvX3NlY3JldGJveF9lYXN5ID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoICsgYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGggKyBjcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTIiBieXRlcycKICAgICkKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9lYXN5KGMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRib3hfb3Blbl9lYXN5ID0gZnVuY3Rpb24gKG0sIGMsIG4sIGspIHsKICBpZiAobT8uYnl0ZUxlbmd0aCAhPT0gYy5ieXRlTGVuZ3RoIC0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMgLSBjcnlwdG9fc2VjcmV0Ym94X01BQ0JZVEVTIiBieXRlcycpCiAgaWYgKGM/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpIHRocm93IG5ldyBFcnJvcignYycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZWFzeShtLCBjLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRib3hfZGV0YWNoZWQgPSBmdW5jdGlvbiAoYywgbWFjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0ICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfZGV0YWNoZWQoYywgbWFjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZGV0YWNoZWQgPSBmdW5jdGlvbiAobSwgYywgbWFjLCBuLCBrKSB7CiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IGMuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zZWNyZXRib3hfTUFDQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NlY3JldGJveF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fc2VjcmV0Ym94X29wZW5fZGV0YWNoZWQobSwgYywgbWFjLCBuLCBrKQp9CgovLyBjcnlwdG9fZ2VuZXJpY2hhc2gKCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoID0gZnVuY3Rpb24gKG91dHB1dCwgaW5wdXQsIGtleSA9IE9QVElPTkFMKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2goCiAgICBvdXRwdXQuYnVmZmVyLAogICAgb3V0cHV0LmJ5dGVPZmZzZXQsCiAgICBvdXRwdXQuYnl0ZUxlbmd0aCwKCiAgICBpbnB1dC5idWZmZXIsCiAgICBpbnB1dC5ieXRlT2Zmc2V0LAogICAgaW5wdXQuYnl0ZUxlbmd0aCwKCiAgICBrZXkuYnVmZmVyLAogICAga2V5LmJ5dGVPZmZzZXQsCiAgICBrZXkuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2JhdGNoID0gZnVuY3Rpb24gKG91dHB1dCwgYmF0Y2gsIGtleSkgewogIGlmIChpc05vZGUgfHwgYmF0Y2gubGVuZ3RoIDwgNCkgewogICAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfYmF0Y2goCiAgICAgIG91dHB1dCwKICAgICAgYmF0Y2gsCiAgICAgICEha2V5LAogICAgICBrZXkgfHwgT1BUSU9OQUwKICAgICkKICAgIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQogIH0gZWxzZSB7CiAgICBjb25zdCBzdGF0ZSA9IEJ1ZmZlci5hbGxvYyhiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF9TVEFURUJZVEVTKQoKICAgIGV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2luaXQoc3RhdGUsIGtleSwgb3V0cHV0LmJ5dGVMZW5ndGgpCgogICAgZm9yIChjb25zdCBidWYgb2YgYmF0Y2gpIHsKICAgICAgZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfdXBkYXRlKHN0YXRlLCBidWYpCiAgICB9CgogICAgZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfZmluYWwoc3RhdGUsIG91dHB1dCkKICB9Cn0KCmV4cG9ydHMuY3J5cHRvX2dlbmVyaWNoYXNoX2tleWdlbiA9IGZ1bmN0aW9uIChrZXkpIHsKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19nZW5lcmljaGFzaF9rZXlnZW4oCiAgICBrZXkuYnVmZmVyLAogICAga2V5LmJ5dGVPZmZzZXQsCiAgICBrZXkuYnl0ZUxlbmd0aAogICkKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fZ2VuZXJpY2hhc2hfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwga2V5LCBvdXRwdXRMZW5ndGgpIHsKICBrZXkgfHw9IE9QVElPTkFMCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2dlbmVyaWNoYXNoX2luaXQoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBrZXkuYnVmZmVyLAogICAga2V5LmJ5dGVPZmZzZXQsCiAgICBrZXkuYnl0ZUxlbmd0aCwKCiAgICBvdXRwdXRMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGlucHV0KSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfdXBkYXRlKAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgsCgogICAgaW5wdXQuYnVmZmVyLAogICAgaW5wdXQuYnl0ZU9mZnNldCwKICAgIGlucHV0LmJ5dGVMZW5ndGgKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19nZW5lcmljaGFzaF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgb3V0cHV0KSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fZ2VuZXJpY2hhc2hfZmluYWwoCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBvdXRwdXQuYnVmZmVyLAogICAgb3V0cHV0LmJ5dGVPZmZzZXQsCiAgICBvdXRwdXQuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIHNlY3JldHN0cmVhbQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2tleWdlbiA9IGZ1bmN0aW9uIChrKSB7CiAgYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2tleWdlbigKICAgIGsuYnVmZmVyLAogICAgay5ieXRlT2Zmc2V0LAogICAgay5ieXRlTGVuZ3RoCiAgKQp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfaW5pdF9wdXNoID0gZnVuY3Rpb24gKAogIHN0YXRlLAogIGhlYWRlciwKICBrCikgewogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1c2goCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBoZWFkZXIuYnVmZmVyLAogICAgaGVhZGVyLmJ5dGVPZmZzZXQsCiAgICBoZWFkZXIuYnl0ZUxlbmd0aCwKCiAgICBrLmJ1ZmZlciwKICAgIGsuYnl0ZU9mZnNldCwKICAgIGsuYnl0ZUxlbmd0aAogICkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1bGwgPSBmdW5jdGlvbiAoCiAgc3RhdGUsCiAgaGVhZGVyLAogIGsKKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVsbCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIGhlYWRlci5idWZmZXIsCiAgICBoZWFkZXIuYnl0ZU9mZnNldCwKICAgIGhlYWRlci5ieXRlTGVuZ3RoLAoKICAgIGsuYnVmZmVyLAogICAgay5ieXRlT2Zmc2V0LAogICAgay5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1c2ggPSBmdW5jdGlvbiAoCiAgc3RhdGUsCiAgYywKICBtLAogIGFkLAogIHRhZwopIHsKICBhZCB8fD0gT1BUSU9OQUwKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1c2goCiAgICBzdGF0ZS5idWZmZXIsCiAgICBzdGF0ZS5ieXRlT2Zmc2V0LAogICAgc3RhdGUuYnl0ZUxlbmd0aCwKCiAgICBjLmJ1ZmZlciwKICAgIGMuYnl0ZU9mZnNldCwKICAgIGMuYnl0ZUxlbmd0aCwKCiAgICBtLmJ1ZmZlciwKICAgIG0uYnl0ZU9mZnNldCwKICAgIG0uYnl0ZUxlbmd0aCwKCiAgICBhZC5idWZmZXIsCiAgICBhZC5ieXRlT2Zmc2V0LAogICAgYWQuYnl0ZUxlbmd0aCwKCiAgICB0YWcKICApCgogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ3B1c2ggZmFpbGVkJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVsbCA9IGZ1bmN0aW9uICgKICBzdGF0ZSwKICBtLAogIHRhZywKICBjLAogIGFkCikgewogIGFkIHx8PSBPUFRJT05BTAoKICBpZiAoYz8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9BQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgY2lwaGVyIGxlbmd0aCcpCiAgaWYgKAogICAgbT8uYnl0ZUxlbmd0aCAhPT0KICAgIGMuYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgbWVzc2FnZSBsZW5ndGgnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVsbCgKICAgIHN0YXRlLmJ1ZmZlciwKICAgIHN0YXRlLmJ5dGVPZmZzZXQsCiAgICBzdGF0ZS5ieXRlTGVuZ3RoLAoKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIHRhZy5idWZmZXIsCiAgICB0YWcuYnl0ZU9mZnNldCwKICAgIHRhZy5ieXRlTGVuZ3RoLAoKICAgIGMuYnVmZmVyLAogICAgYy5ieXRlT2Zmc2V0LAogICAgYy5ieXRlTGVuZ3RoLAoKICAgIGFkLmJ1ZmZlciwKICAgIGFkLmJ5dGVPZmZzZXQsCiAgICBhZC5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdwdWxsIGZhaWxlZCcpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3Jla2V5ID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgYmluZGluZy5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3Jla2V5KAogICAgc3RhdGUuYnVmZmVyLAogICAgc3RhdGUuYnl0ZU9mZnNldCwKICAgIHN0YXRlLmJ5dGVMZW5ndGgKICApCn0KCi8vIGNyeXB0b19zdHJlYW0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbSA9IGZ1bmN0aW9uIChjLCBuLCBrKSB7CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9OT05DRUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbShjLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hvciA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hvcigKICAgIGMuYnVmZmVyLAogICAgYy5ieXRlT2Zmc2V0LAogICAgYy5ieXRlTGVuZ3RoLAoKICAgIG0uYnVmZmVyLAogICAgbS5ieXRlT2Zmc2V0LAogICAgbS5ieXRlTGVuZ3RoLAoKICAgIG4uYnVmZmVyLAogICAgbi5ieXRlT2Zmc2V0LAogICAgbi5ieXRlTGVuZ3RoLAoKICAgIGsuYnVmZmVyLAogICAgay5ieXRlT2Zmc2V0LAogICAgay5ieXRlTGVuZ3RoCiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjAoYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3IgPSBmdW5jdGlvbiAoYywgbSwgbiwgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcihjLCBtLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9pYyA9IGZ1bmN0aW9uIChjLCBtLCBuLCBpYywgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9pYyhjLCBtLCBuLCBpYywgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGYoYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvciA9IGZ1bmN0aW9uIChjLCBtLCBuLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yKGMsIG0sIG4sIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfaWMgPSBmdW5jdGlvbiAoYywgbSwgbiwgaWMsIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3JfaWMoYywgbSwgbiwgaWMsIGspCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwID0gZnVuY3Rpb24gKGMsIG4sIGspIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjAoYywgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1feGNoYWNoYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3IoYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX2ljID0gZnVuY3Rpb24gKGMsIG0sIG4sIGljLCBrKSB7CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX2ljKGMsIG0sIG4sIGljLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjAgPSBmdW5jdGlvbiAoYywgbiwgaykgewogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMChjLCBuLCBrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yID0gZnVuY3Rpb24gKGMsIG0sIG4sIGspIHsKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdtIG11c3QgYmUgImMuYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3IoYywgbSwgbiwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9pYyA9IGZ1bmN0aW9uIChjLCBtLCBuLCBpYywgaykgewogIGlmIChjPy5ieXRlTGVuZ3RoICE9PSBtLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9pYyhjLCBtLCBuLCBpYywgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19hdXRoCgpleHBvcnRzLmNyeXB0b19hdXRoID0gZnVuY3Rpb24gKG91dCwgaW5wdXQsIGspIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hdXRoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2F1dGhfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2F1dGgob3V0LCBpbnB1dCwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2F1dGhfdmVyaWZ5ID0gZnVuY3Rpb24gKGgsIGlucHV0LCBrKSB7CiAgaWYgKGg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2F1dGhfQllURVMpIHRocm93IG5ldyBFcnJvcignaCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2F1dGhfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19hdXRoX3ZlcmlmeShoLCBpbnB1dCwgaykKfQoKLy8gY3J5cHRvX29uZXRpbWVhdXRoCgpleHBvcnRzLmNyeXB0b19vbmV0aW1lYXV0aCA9IGZ1bmN0aW9uIChvdXQsIGlucHV0LCBrKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGgob3V0LCBpbnB1dCwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX29uZXRpbWVhdXRoX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIGspIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTJyBieXRlcyIpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fb25ldGltZWF1dGhfaW5pdChzdGF0ZSwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX29uZXRpbWVhdXRoX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgaW5wdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX1NUQVRFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTJyBieXRlcyIpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX3VwZGF0ZShzdGF0ZSwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19vbmV0aW1lYXV0aF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgb3V0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9TVEFURUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fb25ldGltZWF1dGhfU1RBVEVCWVRFUycgYnl0ZXMiKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9maW5hbChzdGF0ZSwgb3V0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fb25ldGltZWF1dGhfdmVyaWZ5ID0gZnVuY3Rpb24gKGgsIGlucHV0LCBrKSB7CiAgaWYgKGg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX29uZXRpbWVhdXRoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2gnKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19vbmV0aW1lYXV0aF92ZXJpZnkoaCwgaW5wdXQsIGspCn0KCi8vIGNyeXB0b19wd2hhc2gKCmV4cG9ydHMuY3J5cHRvX3B3aGFzaCA9IGZ1bmN0aW9uIChvdXQsIHBhc3N3ZCwgc2FsdCwgb3BzbGltaXQsIG1lbWxpbWl0LCBhbGcpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX0JZVEVTX01JTikgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfQllURVNfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKHNhbHQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TQUxUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChhbGcgPCAxIHx8IGFsZyA+IDIpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2FsZyBtdXN0IGJlIGVpdGhlciBBcmdvbjJpIDEuMyBvciBBcmdvbjJpZCAxLjMnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19wd2hhc2gob3V0LCBwYXNzd2QsIHNhbHQsIG9wc2xpbWl0LCBtZW1saW1pdCwgYWxnKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX2FzeW5jID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgc2FsdCwKICBvcHNsaW1pdCwKICBtZW1saW1pdCwKICBhbGcsCiAgY2FsbGJhY2sgPSB1bmRlZmluZWQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9CWVRFU19NSU4pIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAob3V0Py5ieXRlTGVuZ3RoID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX0JZVEVTX01BWCkgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChzYWx0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU0FMVEJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzYWx0JykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfT1BTTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAoYWxnIDwgMSB8fCBhbGcgPiAyKQogICAgdGhyb3cgbmV3IEVycm9yKCdhbGcgbXVzdCBiZSBlaXRoZXIgQXJnb24yaSAxLjMgb3IgQXJnb24yaWQgMS4zJykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9hc3luYygKICAgIG91dC5idWZmZXIsCiAgICBvdXQuYnl0ZU9mZnNldCwKICAgIG91dC5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIHNhbHQuYnVmZmVyLAogICAgc2FsdC5ieXRlT2Zmc2V0LAogICAgc2FsdC5ieXRlTGVuZ3RoLAoKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQsCiAgICBhbGcsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0ciA9IGZ1bmN0aW9uIChvdXQsIHBhc3N3ZCwgb3BzbGltaXQsIG1lbWxpbWl0KSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NUUkJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKHR5cGVvZiBvcHNsaW1pdCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmICh0eXBlb2YgbWVtbGltaXQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cihvdXQsIHBhc3N3ZCwgb3BzbGltaXQsIG1lbWxpbWl0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0cl9hc3luYyA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIG9wc2xpbWl0LAogIG1lbWxpbWl0LAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TVFJCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCiAgaWYgKHR5cGVvZiBvcHNsaW1pdCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmICh0eXBlb2YgbWVtbGltaXQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUlOKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfTUVNTElNSVRfTUFYKSB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zdHJfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0LAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zdHJfdmVyaWZ5ID0gZnVuY3Rpb24gKHN0ciwgcGFzc3dkKSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX1NUUkJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCgogIHJldHVybiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc3RyX3ZlcmlmeShzdHIsIHBhc3N3ZCkKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3N0cl92ZXJpZnlfYXN5bmMgPSBmdW5jdGlvbiAoCiAgc3RyLAogIHBhc3N3ZCwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfU1RSQllURVMpIHRocm93IG5ldyBFcnJvcignc3RyJykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQoKICBjb25zdCBbZG9uZSwgcHJvbWlzZV0gPSBjaGVja1N0YXR1cyhjYWxsYmFjaywgdHJ1ZSkKCiAgYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cl92ZXJpZnlfYXN5bmMoCiAgICBzdHIuYnVmZmVyLAogICAgc3RyLmJ5dGVPZmZzZXQsCiAgICBzdHIuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBkb25lCiAgKQoKICByZXR1cm4gcHJvbWlzZQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc3RyX25lZWRzX3JlaGFzaCA9IGZ1bmN0aW9uIChzdHIsIG9wc2xpbWl0LCBtZW1saW1pdCkgewogIGlmIChzdHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9TVFJCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzdHInKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3N0cl9uZWVkc19yZWhhc2goc3RyLCBvcHNsaW1pdCwgbWVtbGltaXQpCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1NiA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIHNhbHQsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQKKSB7CiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9CWVRFU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKG91dD8uYnl0ZUxlbmd0aCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9CWVRFU19NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKHNhbHQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TQUxUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2KAogICAgb3V0LAogICAgcGFzc3dkLAogICAgc2FsdCwKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfYXN5bmMgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBzYWx0LAogIG9wc2xpbWl0LAogIG1lbWxpbWl0LAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfQllURVNfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfQllURVNfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQogIGlmICghcGFzc3dkPy5ieXRlTGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3Bhc3N3ZCcpCiAgaWYgKHNhbHQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TQUxUQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NhbHQnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9hc3luYygKICAgIG91dC5idWZmZXIsCiAgICBvdXQuYnl0ZU9mZnNldCwKICAgIG91dC5ieXRlTGVuZ3RoLAoKICAgIHBhc3N3ZC5idWZmZXIsCiAgICBwYXNzd2QuYnl0ZU9mZnNldCwKICAgIHBhc3N3ZC5ieXRlTGVuZ3RoLAoKICAgIHNhbHQuYnVmZmVyLAogICAgc2FsdC5ieXRlT2Zmc2V0LAogICAgc2FsdC5ieXRlTGVuZ3RoLAoKICAgIG9wc2xpbWl0LAogICAgbWVtbGltaXQsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl9hc3luYyA9IGZ1bmN0aW9uICgKICBvdXQsCiAgcGFzc3dkLAogIG9wc2xpbWl0LAogIG1lbWxpbWl0LAogIGNhbGxiYWNrID0gdW5kZWZpbmVkCikgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9TVFJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9PUFNMSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ29wc2xpbWl0JykKICBpZiAob3BzbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG1lbWxpbWl0IDwgYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X01FTUxJTUlUX01JTikKICAgIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0LAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHIgPSBmdW5jdGlvbiAoCiAgb3V0LAogIHBhc3N3ZCwKICBvcHNsaW1pdCwKICBtZW1saW1pdAopIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKICBpZiAob3BzbGltaXQgPCBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfT1BTTElNSVRfTUlOKQogICAgdGhyb3cgbmV3IEVycm9yKCdvcHNsaW1pdCcpCiAgaWYgKG9wc2xpbWl0ID4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X09QU0xJTUlUX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9NRU1MSU1JVF9NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21lbWxpbWl0JykKICBpZiAobWVtbGltaXQgPiBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfTUVNTElNSVRfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdtZW1saW1pdCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHIoCiAgICBvdXQsCiAgICBwYXNzd2QsCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0CiAgKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl92ZXJpZnlfYXN5bmMgPSBmdW5jdGlvbiAoCiAgc3RyLAogIHBhc3N3ZCwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2ssIHRydWUpCgogIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfdmVyaWZ5X2FzeW5jKAogICAgc3RyLmJ1ZmZlciwKICAgIHN0ci5ieXRlT2Zmc2V0LAogICAgc3RyLmJ5dGVMZW5ndGgsCgogICAgcGFzc3dkLmJ1ZmZlciwKICAgIHBhc3N3ZC5ieXRlT2Zmc2V0LAogICAgcGFzc3dkLmJ5dGVMZW5ndGgsCgogICAgZG9uZQogICkKCiAgcmV0dXJuIHByb21pc2UKfQoKZXhwb3J0cy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl92ZXJpZnkgPSBmdW5jdGlvbiAoc3RyLCBwYXNzd2QpIHsKICBpZiAoc3RyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfU1RSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0cicpCiAgaWYgKCFwYXNzd2Q/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcigncGFzc3dkJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9zY3J5cHRzYWxzYTIwOHNoYTI1Nl9zdHJfdmVyaWZ5KHN0ciwgcGFzc3dkKQp9CgpleHBvcnRzLmNyeXB0b19wd2hhc2hfc2NyeXB0c2Fsc2EyMDhzaGEyNTZfc3RyX25lZWRzX3JlaGFzaCA9IGZ1bmN0aW9uICgKICBzdHIsCiAgb3BzbGltaXQsCiAgbWVtbGltaXQKKSB7CiAgaWYgKHN0cj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X1NUUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzdHInKQogIGlmIChvcHNsaW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChvcHNsaW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9PUFNMSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignb3BzbGltaXQnKQogIGlmIChtZW1saW1pdCA8IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NSU4pIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQogIGlmIChtZW1saW1pdCA+IGJpbmRpbmcuY3J5cHRvX3B3aGFzaF9NRU1MSU1JVF9NQVgpIHRocm93IG5ldyBFcnJvcignbWVtbGltaXQnKQoKICByZXR1cm4gYmluZGluZy5jcnlwdG9fcHdoYXNoX3NjcnlwdHNhbHNhMjA4c2hhMjU2X3N0cl9uZWVkc19yZWhhc2goCiAgICBzdHIsCiAgICBvcHNsaW1pdCwKICAgIG1lbWxpbWl0CiAgKQp9CgovLyBjcnlwdG9fa3gKCmV4cG9ydHMuY3J5cHRvX2t4X2tleXBhaXIgPSBmdW5jdGlvbiAocGssIHNrKSB7CiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRUNSRVRLRVlCWVRFUykgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2t4X2tleXBhaXIocGssIHNrKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fa3hfc2VlZF9rZXlwYWlyID0gZnVuY3Rpb24gKHBrLCBzaywgc2VlZCkgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfUFVCTElDS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VDUkVUS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignc2snKQogIGlmIChzZWVkPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRUVEQllURVMpIHRocm93IG5ldyBFcnJvcignc2VlZCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2t4X3NlZWRfa2V5cGFpcihwaywgc2ssIHNlZWQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19reF9jbGllbnRfc2Vzc2lvbl9rZXlzID0gZnVuY3Rpb24gKAogIHJ4LAogIHR4LAogIGNsaWVudFBrLAogIGNsaWVudFNrLAogIHNlcnZlclBrCikgewogIC8vIG1hdGNoIGBzdGQ6Om9wdGlvbmFsYCBieSBjb2VyY2luZyBudWxsIHRvIHVuZGVmaW5lZAogIHJ4ID8/PSB1bmRlZmluZWQKICB0eCA/Pz0gdW5kZWZpbmVkCgogIGlmICghcnggJiYgIXR4KSB0aHJvdyBuZXcgRXJyb3IoJ2F0IGxlYXN0IG9uZSBzZXNzaW9uIGtleSBtdXN0IGJlIHNwZWNpZmllZCcpCgogIGlmIChyeCkgewogICAgaWYgKHJ4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRVNTSU9OS0VZQllURVMpCiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAncmVjZWl2aW5nIGtleSBidWZmZXIgbXVzdCBiZSAiY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUyIgYnl0ZXMgb3IgbnVsbCcKICAgICAgKQogIH0gZWxzZSB7CiAgICBpZiAodHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUykKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICd0cmFuc21pdHRpbmcga2V5IGJ1ZmZlciBtdXN0IGJlICJjcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTIiBieXRlcyBvciBudWxsJwogICAgICApCiAgfQoKICBpZiAoY2xpZW50UGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdjbGllbnRfcGsnKQogIGlmIChjbGllbnRTaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsaWVudF9zaycpCiAgaWYgKHNlcnZlclBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2VydmVyX3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa3hfY2xpZW50X3Nlc3Npb25fa2V5cygKICAgIHJ4LAogICAgdHgsCiAgICBjbGllbnRQaywKICAgIGNsaWVudFNrLAogICAgc2VydmVyUGsKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19reF9zZXJ2ZXJfc2Vzc2lvbl9rZXlzID0gZnVuY3Rpb24gKAogIHJ4LAogIHR4LAogIHNlcnZlclBrLAogIHNlcnZlclNrLAogIGNsaWVudFBrCikgewogIHJ4ID8/PSB1bmRlZmluZWQKICB0eCA/Pz0gdW5kZWZpbmVkCgogIGlmICghcnggJiYgIXR4KSB0aHJvdyBuZXcgRXJyb3IoJ2F0IGxlYXN0IG9uZSBzZXNzaW9uIGtleSBtdXN0IGJlIHNwZWNpZmllZCcpCgogIGlmIChyeCkgewogICAgaWYgKHJ4Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9TRVNTSU9OS0VZQllURVMpCiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAncmVjZWl2aW5nIGtleSBidWZmZXIgbXVzdCBiZSAiY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUyIgYnl0ZXMgb3IgbnVsbCcKICAgICAgKQogIH0gZWxzZSB7CiAgICBpZiAodHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1NFU1NJT05LRVlCWVRFUykKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICd0cmFuc21pdHRpbmcga2V5IGJ1ZmZlciBtdXN0IGJlICJjcnlwdG9fa3hfU0VTU0lPTktFWUJZVEVTIiBieXRlcyBvciBudWxsJwogICAgICApCiAgfQoKICBpZiAoc2VydmVyUGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2t4X1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzZXJ2ZXJfcGsnKQogIGlmIChzZXJ2ZXJTaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa3hfU0VDUkVUS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcnZlcl9zaycpCiAgaWYgKGNsaWVudFBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19reF9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY2xpZW50X3BrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa3hfc2VydmVyX3Nlc3Npb25fa2V5cygKICAgIHJ4LAogICAgdHgsCiAgICBzZXJ2ZXJQaywKICAgIHNlcnZlclNrLAogICAgY2xpZW50UGsKICApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgovLyBjcnlwdG9fc2NhbGFybXVsdAoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdF9iYXNlID0gZnVuY3Rpb24gKHEsIG4pIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfYmFzZShxLCBuKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdCA9IGZ1bmN0aW9uIChxLCBuLCBwKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfQllURVMpIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0KHEsIG4sIHApCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfYmFzZSA9IGZ1bmN0aW9uIChxLCBuKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9iYXNlKHEsIG4pCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTkgPSBmdW5jdGlvbiAocSwgbiwgcCkgewogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3EnKQogIGlmIChuPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zY2FsYXJtdWx0X2VkMjU1MTkocSwgbiwgcCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9pc192YWxpZF9wb2ludCA9IGZ1bmN0aW9uIChwKSB7CiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgcmV0dXJuIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9pc192YWxpZF9wb2ludChwKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfZnJvbV91bmlmb3JtID0gZnVuY3Rpb24gKHAsIHIpIHsKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQogIGlmIChyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfVU5JRk9STUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdyJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X2Zyb21fdW5pZm9ybShwLCByKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X2Jhc2Vfbm9jbGFtcCA9IGZ1bmN0aW9uIChxLCBuKSB7CiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncScpCiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9iYXNlX25vY2xhbXAocSwgbikKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX3NjYWxhcm11bHRfZWQyNTUxOV9ub2NsYW1wID0gZnVuY3Rpb24gKHEsIG4sIHApIHsKICBpZiAocT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdxJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fc2NhbGFybXVsdF9lZDI1NTE5X25vY2xhbXAocSwgbiwgcCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19jb3JlCgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfYWRkID0gZnVuY3Rpb24gKHIsIHAsIHEpIHsKICBpZiAocj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3InKQogIGlmIChwPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCiAgaWYgKHE/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdxJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X2FkZChyLCBwLCBxKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3N1YiA9IGZ1bmN0aW9uIChyLCBwLCBxKSB7CiAgaWYgKHI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9CWVRFUykgdGhyb3cgbmV3IEVycm9yKCdyJykKICBpZiAocD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3AnKQogIGlmIChxPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfQllURVMpIHRocm93IG5ldyBFcnJvcigncScpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zdWIociwgcCwgcSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfcmFuZG9tID0gZnVuY3Rpb24gKHIpIHsKICBpZiAocj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdyJykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9yYW5kb20ocikKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9yZWR1Y2UgPSBmdW5jdGlvbiAociwgcykgewogIGlmIChyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3InKQogIGlmIChzPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfTk9OUkVEVUNFRFNDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzJykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9yZWR1Y2UociwgcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9pbnZlcnQgPSBmdW5jdGlvbiAocmVjaXAsIHMpIHsKICBpZiAocmVjaXA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncmVjaXAnKQogIGlmIChzPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3MnKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2ludmVydChyZWNpcCwgcykKfQoKZXhwb3J0cy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9uZWdhdGUgPSBmdW5jdGlvbiAobmVnLCBzKSB7CiAgaWYgKG5lZz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduZWcnKQogIGlmIChzPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3MnKQoKICBiaW5kaW5nLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX25lZ2F0ZShuZWcsIHMpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfY29tcGxlbWVudCA9IGZ1bmN0aW9uIChjb21wLCBzKSB7CiAgaWYgKGNvbXA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY29tcCcpCiAgaWYgKHM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncycpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfY29tcGxlbWVudChjb21wLCBzKQp9CgpleHBvcnRzLmNyeXB0b19jb3JlX2VkMjU1MTlfc2NhbGFyX2FkZCA9IGZ1bmN0aW9uICh6LCB4LCB5KSB7CiAgaWYgKHo/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneicpCiAgaWYgKHg/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneCcpCiAgaWYgKHk/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigneScpCgogIGJpbmRpbmcuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfYWRkKHosIHgsIHkpCn0KCmV4cG9ydHMuY3J5cHRvX2NvcmVfZWQyNTUxOV9zY2FsYXJfc3ViID0gZnVuY3Rpb24gKHosIHgsIHkpIHsKICBpZiAoej8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd6JykKICBpZiAoeD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd4JykKICBpZiAoeT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd5JykKCiAgYmluZGluZy5jcnlwdG9fY29yZV9lZDI1NTE5X3NjYWxhcl9zdWIoeiwgeCwgeSkKfQoKLy8gY3J5cHRvX3Nob3J0aGFzaAoKZXhwb3J0cy5jcnlwdG9fc2hvcnRoYXNoID0gZnVuY3Rpb24gKG91dCwgaW5wdXQsIGspIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaG9ydGhhc2hfQllURVMpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2hvcnRoYXNoX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19zaG9ydGhhc2gob3V0LCBpbnB1dCwgaykKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19rZGYKCmV4cG9ydHMuY3J5cHRvX2tkZl9rZXlnZW4gPSBmdW5jdGlvbiAoa2V5KSB7CiAgaWYgKGtleT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa2RmX0tFWUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ2tleScpCgogIGJpbmRpbmcuY3J5cHRvX2tkZl9rZXlnZW4oa2V5KQp9CgpleHBvcnRzLmNyeXB0b19rZGZfZGVyaXZlX2Zyb21fa2V5ID0gZnVuY3Rpb24gKHN1YmtleSwgc3Via2V5SWQsIGN0eCwga2V5KSB7CiAgaWYgKHN1YmtleT8uYnl0ZUxlbmd0aCA8IGJpbmRpbmcuY3J5cHRvX2tkZl9CWVRFU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N1YmtleScpCiAgaWYgKHN1YmtleT8uYnl0ZUxlbmd0aCA+IGJpbmRpbmcuY3J5cHRvX2tkZl9CWVRFU19NQVgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3N1YmtleScpCiAgaWYgKGN0eD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fa2RmX0NPTlRFWFRCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignY3R4JykKICBpZiAoa2V5Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19rZGZfS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigna2V5JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fa2RmX2Rlcml2ZV9mcm9tX2tleShzdWJrZXksIHN1YmtleUlkLCBjdHgsIGtleSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCi8vIGNyeXB0b19oYXNoCgpleHBvcnRzLmNyeXB0b19oYXNoID0gZnVuY3Rpb24gKG91dCwgaW5wdXQpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2gob3V0LCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhMjU2ID0gZnVuY3Rpb24gKG91dCwgaW5wdXQpIHsKICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTYob3V0LCBpbnB1dCkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhMjU2X2luaXQgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhMjU2X1NUQVRFQllURVMnIGJ5dGVzIikKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhMjU2X2luaXQoc3RhdGUpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTI1Nl91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGlucHV0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTI1Nl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl91cGRhdGUoc3RhdGUsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGEyNTZfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUsIG91dCkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGEyNTZfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KICBpZiAob3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc3RhdGUnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTI1Nl9maW5hbChzdGF0ZSwgb3V0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGE1MTIgPSBmdW5jdGlvbiAob3V0LCBpbnB1dCkgewogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMihvdXQsIGlucHV0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKZXhwb3J0cy5jcnlwdG9faGFzaF9zaGE1MTJfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdjcnlwdG9faGFzaF9zaGE1MTJfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9faGFzaF9zaGE1MTJfaW5pdChzdGF0ZSkKCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdzdGF0dXM6ICcgKyByZXMpCn0KCmV4cG9ydHMuY3J5cHRvX2hhc2hfc2hhNTEyX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgaW5wdXQpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnY3J5cHRvX2hhc2hfc2hhNTEyX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX3VwZGF0ZShzdGF0ZSwgaW5wdXQpCgogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignc3RhdHVzOiAnICsgcmVzKQp9CgpleHBvcnRzLmNyeXB0b19oYXNoX3NoYTUxMl9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgb3V0KSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ2NyeXB0b19oYXNoX3NoYTUxMl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2hhc2hfc2hhNTEyX0JZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXQnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19oYXNoX3NoYTUxMl9maW5hbChzdGF0ZSwgb3V0KQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ3N0YXR1czogJyArIHJlcykKfQoKLy8gY3J5cHRvX2FlYWQKCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9rZXlnZW4gPSBmdW5jdGlvbiAoaykgewogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfa2V5Z2VuKGspCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0ID0gZnVuY3Rpb24gKAogIGMsCiAgbSwKICBhZCwKICBuc2VjID0gbnVsbCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmICgKICAgIGM/LmJ5dGVMZW5ndGggIT09CiAgICBtLmJ5dGVMZW5ndGggKyBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTCiAgKQogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnYyBtdXN0ICJtLmJ5dGVMZW5ndGggKyBjcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUyIgYnl0ZXMnCiAgICApCiAgaWYgKGM/LmJ5dGVMZW5ndGggPiAweGZmZmZmZmZmKQogICAgdGhyb3cgbmV3IEVycm9yKCdjLmJ5dGVMZW5ndGggbXVzdCBiZSBhIDMyYml0IGludGVnZXInKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2VuY3J5cHQoCiAgICBjLAogICAgbSwKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IGVuY3J5cHQgZGF0YScpCgogIHJldHVybiByZXMKfQoKZXhwb3J0cy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQgPSBmdW5jdGlvbiAoCiAgbSwKICBuc2VjID0gbnVsbCwKICBjLAogIGFkLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKAogICAgbT8uYnl0ZUxlbmd0aCAhPT0KICAgIGMuYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdtIG11c3QgImMuYnl0ZUxlbmd0aCAtIGNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTIiBieXRlcycKICAgICkKICBpZiAobT8uYnl0ZUxlbmd0aCA+IDB4ZmZmZmZmZmYpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20uYnl0ZUxlbmd0aCBtdXN0IGJlIGEgMzJiaXQgaW50ZWdlcicpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdCgKICAgIG0sCiAgICBjLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgdmVyaWZ5IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0X2RldGFjaGVkID0gZnVuY3Rpb24gKAogIGMsCiAgbWFjLAogIG0sCiAgYWQsCiAgbnNlYyA9IG51bGwsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ21hYycpCiAgaWYgKG5wdWI/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfeGNoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZW5jcnlwdF9kZXRhY2hlZCgKICAgIGMsCiAgICBtYWMsCiAgICBtLAogICAgYWQsCiAgICBucHViLAogICAgawogICkKICBpZiAocmVzIDwgMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgZW5jcnlwdCBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfZGVjcnlwdF9kZXRhY2hlZCA9IGZ1bmN0aW9uICgKICBtLAogIG5zZWMgPSBudWxsLAogIGMsCiAgbWFjLAogIGFkLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKG0/LmJ5dGVMZW5ndGggIT09IGMuYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignbSBtdXN0IGJlICJjLmJ5dGVMZW5ndGgiIGJ5dGVzJykKICBpZiAobWFjPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX3hjaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgY29uc3QgcmVzID0gYmluZGluZy5jcnlwdG9fYWVhZF94Y2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHRfZGV0YWNoZWQoCiAgICBtLAogICAgYywKICAgIG1hYywKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgdmVyaWZ5IGRhdGEnKQp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9rZXlnZW4gPSBmdW5jdGlvbiAoaykgewogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2tleWdlbihrKQp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0ID0gZnVuY3Rpb24gKAogIGMsCiAgbSwKICBhZCwKICBuc2VjID0gbnVsbCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmICgKICAgIGM/LmJ5dGVMZW5ndGggIT09CiAgICBtLmJ5dGVMZW5ndGggKyBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMKICApCiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdjIG11c3QgIm0uYnl0ZUxlbmd0aCArIGNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9BQllURVMiIGJ5dGVzJwogICAgKQogIGlmIChjPy5ieXRlTGVuZ3RoID4gMHhmZmZmZmZmZikKICAgIHRocm93IG5ldyBFcnJvcignYy5ieXRlTGVuZ3RoIG11c3QgYmUgYSAzMmJpdCBpbnRlZ2VyJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0KAogICAgYywKICAgIG0sCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCBlbmNyeXB0IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQgPSBmdW5jdGlvbiAoCiAgbSwKICBuc2VjID0gbnVsbCwKICBjLAogIGFkLAogIG5wdWIsCiAgawopIHsKICBhZCA/Pz0gdW5kZWZpbmVkCiAgaWYgKG5zZWMgIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignbnNlYyBtdXN0IGFsd2F5cyBiZSBzZXQgdG8gbnVsbCcpCiAgaWYgKAogICAgbT8uYnl0ZUxlbmd0aCAhPT0KICAgIGMuYnl0ZUxlbmd0aCAtIGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUwogICkKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgJ20gbXVzdCAiYy5ieXRlTGVuZ3RoIC0gY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUyIgYnl0ZXMnCiAgICApCiAgaWYgKG0/LmJ5dGVMZW5ndGggPiAweGZmZmZmZmZmKQogICAgdGhyb3cgbmV3IEVycm9yKCdtLmJ5dGVMZW5ndGggbXVzdCBiZSBhIDMyYml0IGludGVnZXInKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHQoCiAgICBtLAogICAgYywKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyA8IDApIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IHZlcmlmeSBkYXRhJykKCiAgcmV0dXJuIHJlcwp9CgpleHBvcnRzLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0X2RldGFjaGVkID0gZnVuY3Rpb24gKAogIGMsCiAgbWFjLAogIG0sCiAgYWQsCiAgbnNlYyA9IG51bGwsCiAgbnB1YiwKICBrCikgewogIGFkID8/PSB1bmRlZmluZWQKICBpZiAobnNlYyAhPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCduc2VjIG11c3QgYWx3YXlzIGJlIHNldCB0byBudWxsJykKICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQogIGlmIChtYWM/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX0FCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbWFjJykKICBpZiAobnB1Yj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfTlBVQkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCducHViJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9lbmNyeXB0X2RldGFjaGVkKAogICAgYywKICAgIG1hYywKICAgIG0sCiAgICBhZCwKICAgIG5wdWIsCiAgICBrCiAgKQogIGlmIChyZXMgPCAwKSB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCBlbmNyeXB0IGRhdGEnKQoKICByZXR1cm4gcmVzCn0KCmV4cG9ydHMuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHRfZGV0YWNoZWQgPSBmdW5jdGlvbiAoCiAgbSwKICBuc2VjID0gbnVsbCwKICBjLAogIG1hYywKICBhZCwKICBucHViLAogIGsKKSB7CiAgYWQgPz89IHVuZGVmaW5lZAogIGlmIChuc2VjICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ25zZWMgbXVzdCBhbHdheXMgYmUgc2V0IHRvIG51bGwnKQogIGlmIChtPy5ieXRlTGVuZ3RoICE9PSBjLmJ5dGVMZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ20gbXVzdCBiZSAiYy5ieXRlTGVuZ3RoIiBieXRlcycpCiAgaWYgKG1hYz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fYWVhZF9jaGFjaGEyMHBvbHkxMzA1X2lldGZfQUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdtYWMnKQogIGlmIChucHViPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9OUFVCQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25wdWInKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19hZWFkX2NoYWNoYTIwcG9seTEzMDVfaWV0Zl9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuY3J5cHRvX2FlYWRfY2hhY2hhMjBwb2x5MTMwNV9pZXRmX2RlY3J5cHRfZGV0YWNoZWQoCiAgICBtLAogICAgYywKICAgIG1hYywKICAgIGFkLAogICAgbnB1YiwKICAgIGsKICApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgdmVyaWZ5IGRhdGEnKQp9CgovLyBjcnlwdG9fc3RyZWFtCgpleHBvcnRzLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgbiwgaykgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5zbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXRlIG11c3QgYmUgJ3NuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMnIGJ5dGVzIikKICB9CiAgaWYgKG4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9OT05DRUJZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fS0VZQllURVMpIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94b3Jfd3JhcF9pbml0KHN0YXRlLCBuLCBrKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLnNuX2NyeXB0b19zdHJlYW1feG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigic3RhdGUgbXVzdCBiZSAnc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUycgYnl0ZXMiKQogIH0KICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfdXBkYXRlKHN0YXRlLCBjLCBtKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuc25fY3J5cHRvX3N0cmVhbV94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBtdXN0IGJlICdzbl9jcnlwdG9fc3RyZWFtX3hvcl9TVEFURUJZVEVTJyBieXRlcyIpCiAgfQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1feG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF94b3Jfd3JhcF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBuLCBrKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX05PTkNFQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ24nKQogIGlmIChrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2snKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX3VwZGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgYywgbSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX3VwZGF0ZShzdGF0ZSwgYywgbSkKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fY2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX3hvcl93cmFwX2ZpbmFsKHN0YXRlKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF9pbml0ID0gZnVuY3Rpb24gKHN0YXRlLCBuLCBrKSB7CiAgaWYgKAogICAgc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTCiAgKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKAogICAgc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTCiAgKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAoYz8uYnl0ZUxlbmd0aCAhPT0gbS5ieXRlTGVuZ3RoKQogICAgdGhyb3cgbmV3IEVycm9yKCdjIG11c3QgYmUgIm0uYnl0ZUxlbmd0aCIgYnl0ZXMnKQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fY2hhY2hhMjBfaWV0Zl94b3Jfd3JhcF91cGRhdGUoc3RhdGUsIGMsIG0pCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl93cmFwX2ZpbmFsID0gZnVuY3Rpb24gKHN0YXRlKSB7CiAgaWYgKAogICAgc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9jaGFjaGEyMF9pZXRmX3hvcl9TVEFURUJZVEVTCiAgKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX2NoYWNoYTIwX2lldGZfeG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSwgbiwgaykgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9OT05DRUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCduJykKICBpZiAoaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF9LRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignaycpCgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF91cGRhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIGMsIG0pIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3hjaGFjaGEyMF94b3Jfd3JhcF91cGRhdGUoc3RhdGUsIGMsIG0pCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfZmluYWwgPSBmdW5jdGlvbiAoc3RhdGUpIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1feGNoYWNoYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CgogIGJpbmRpbmcuY3J5cHRvX3N0cmVhbV94Y2hhY2hhMjBfeG9yX3dyYXBfZmluYWwoc3RhdGUpCn0KCmV4cG9ydHMuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl93cmFwX2luaXQgPSBmdW5jdGlvbiAoc3RhdGUsIG4sIGspIHsKICBpZiAoc3RhdGU/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICJzdGF0ZSBtdXN0IGJlICdjcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMnIGJ5dGVzIgogICAgKQogIH0KICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfTk9OQ0VCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3N0cmVhbV9zYWxzYTIwX0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdrJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfaW5pdChzdGF0ZSwgbiwgaykKfQoKZXhwb3J0cy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfdXBkYXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjLCBtKSB7CiAgaWYgKHN0YXRlPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUykgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAic3RhdGUgbXVzdCBiZSAnY3J5cHRvX3N0cmVhbV9zYWxzYTIwX3hvcl9TVEFURUJZVEVTJyBieXRlcyIKICAgICkKICB9CiAgaWYgKGM/LmJ5dGVMZW5ndGggIT09IG0uYnl0ZUxlbmd0aCkKICAgIHRocm93IG5ldyBFcnJvcignYyBtdXN0IGJlICJtLmJ5dGVMZW5ndGgiIGJ5dGVzJykKCiAgYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX3dyYXBfdXBkYXRlKHN0YXRlLCBjLCBtKQp9CgpleHBvcnRzLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF9maW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSkgewogIGlmIChzdGF0ZT8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc3RyZWFtX3NhbHNhMjBfeG9yX1NUQVRFQllURVMpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgInN0YXRlIG11c3QgYmUgJ2NyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3JfU1RBVEVCWVRFUycgYnl0ZXMiCiAgICApCiAgfQoKICBiaW5kaW5nLmNyeXB0b19zdHJlYW1fc2Fsc2EyMF94b3Jfd3JhcF9maW5hbChzdGF0ZSkKfQoKLy8gZXhwZXJpbWVudGFsCgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2Jhc2UgPSBmdW5jdGlvbiAobiwgcCwgbnMpIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3AnKQoKICBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2Jhc2UobiwgcCwgbnMpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2lnbl9kZXRhY2hlZCA9IGZ1bmN0aW9uIChzaWcsIG0sIHNjYWxhciwgcGspIHsKICBpZiAoc2lnPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX0JZVEVTKSB0aHJvdyBuZXcgRXJyb3IoJ3NpZycpCiAgaWYgKHNjYWxhcj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyJykKICBpZiAocGsgJiYgcGsuYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NpZ25fZGV0YWNoZWQoc2lnLCBtLCBzY2FsYXIsIHBrKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIGNvbXB1dGUgc2lnbmF0dXJlJykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9za190b19zY2FsYXIgPSBmdW5jdGlvbiAobiwgc2spIHsKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCiAgaWYgKHNrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1NFQ1JFVEtFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzaycpCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2tfdG9fc2NhbGFyKG4sIHNrKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NjYWxhciA9IGZ1bmN0aW9uIChzY2FsYXJPdXQsIHNjYWxhciwgbnMpIHsKICBpZiAoc2NhbGFyT3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfb3V0JykKICBpZiAoc2NhbGFyPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXInKQoKICBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3NjYWxhcihzY2FsYXJPdXQsIHNjYWxhciwgbnMpCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfcGsgPSBmdW5jdGlvbiAodHBrLCBwaywgbnMpIHsKICBpZiAodHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd0cGsnKQogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5jcnlwdG9fc2lnbl9QVUJMSUNLRVlCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQoKICBjb25zdCByZXMgPSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X3BrKHRwaywgcGssIG5zKQogIGlmIChyZXMgIT09IDApIHRocm93IG5ldyBFcnJvcignZmFpbGVkIHRvIHR3ZWFrIHB1YmxpYyBrZXknKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2tleXBhaXIgPSBmdW5jdGlvbiAoCiAgcGssCiAgc2NhbGFyT3V0LAogIHNjYWxhckluLAogIG5zCikgewogIGlmIChwaz8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9CWVRFUykKICAgIHRocm93IG5ldyBFcnJvcigncGsnKQogIGlmIChzY2FsYXJPdXQ/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9vdXQnKQogIGlmIChzY2FsYXJJbj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX2luJykKCiAgYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9rZXlwYWlyKHBrLCBzY2FsYXJPdXQsIHNjYWxhckluLCBucykKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9zY2FsYXJfYWRkID0gZnVuY3Rpb24gKHNjYWxhck91dCwgc2NhbGFyLCBuKSB7CiAgaWYgKHNjYWxhck91dD8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyX291dCcpCiAgaWYgKHNjYWxhcj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignc2NhbGFyJykKICBpZiAobj8uYnl0ZUxlbmd0aCAhPT0gYmluZGluZy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9TQ0FMQVJCWVRFUykKICAgIHRocm93IG5ldyBFcnJvcignbicpCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfc2NhbGFyX2FkZChzY2FsYXJPdXQsIHNjYWxhciwgbikKfQoKZXhwb3J0cy5leHRlbnNpb25fdHdlYWtfZWQyNTUxOV9wa19hZGQgPSBmdW5jdGlvbiAodHBrLCBwaywgcCkgewogIGlmICh0cGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RwaycpCiAgaWYgKHBrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmNyeXB0b19zaWduX1BVQkxJQ0tFWUJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdwaycpCiAgaWYgKHA/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuY3J5cHRvX3NpZ25fUFVCTElDS0VZQllURVMpIHRocm93IG5ldyBFcnJvcigncCcpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfcGtfYWRkKHRwaywgcGssIHApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gYWRkIHR3ZWFrIHRvIHB1YmxpYyBrZXknKQp9CgpleHBvcnRzLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X2tleXBhaXJfYWRkID0gZnVuY3Rpb24gKAogIHBrLAogIHNjYWxhck91dCwKICBzY2FsYXJJbiwKICB0d2VhawopIHsKICBpZiAocGs/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BrJykKICBpZiAoc2NhbGFyT3V0Py5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsYXJfb3V0JykKICBpZiAoc2NhbGFySW4/LmJ5dGVMZW5ndGggIT09IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfU0NBTEFSQllURVMpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjYWxhcl9pbicpCiAgaWYgKHR3ZWFrPy5ieXRlTGVuZ3RoICE9PSBiaW5kaW5nLmV4dGVuc2lvbl90d2Vha19lZDI1NTE5X1NDQUxBUkJZVEVTKQogICAgdGhyb3cgbmV3IEVycm9yKCd0d2VhaycpCgogIGNvbnN0IHJlcyA9IGJpbmRpbmcuZXh0ZW5zaW9uX3R3ZWFrX2VkMjU1MTlfa2V5cGFpcl9hZGQoCiAgICBwaywKICAgIHNjYWxhck91dCwKICAgIHNjYWxhckluLAogICAgdHdlYWsKICApCiAgaWYgKHJlcyAhPT0gMCkgdGhyb3cgbmV3IEVycm9yKCdmYWlsZWQgdG8gYWRkIHR3ZWFrIHRvIGtleXBhaXInKQp9CgpleHBvcnRzLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX2FzeW5jID0gZnVuY3Rpb24gKAogIG91dCwKICBwYXNzd2QsCiAgc2FsdCwKICBpdGVyLAogIG91dGxlbiwKICBjYWxsYmFjayA9IHVuZGVmaW5lZAopIHsKICBpZiAoaXRlciA8IGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfSVRFUkFUSU9OU19NSU4pCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2l0ZXJhdGlvbnMnKQogIGlmIChvdXRsZW4gPiBiaW5kaW5nLmV4dGVuc2lvbl9wYmtkZjJfc2hhNTEyX0JZVEVTX01BWCkKICAgIHRocm93IG5ldyBFcnJvcignb3V0bGVuJykKICBpZiAob3V0Py5ieXRlTGVuZ3RoIDwgb3V0bGVuKSB0aHJvdyBuZXcgRXJyb3IoJ291dCcpCiAgaWYgKCFvdXQ/LmJ5dGVMZW5ndGgpIHRocm93IG5ldyBFcnJvcignb3V0JykKICBpZiAoIXBhc3N3ZD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdwYXNzd2QnKQogIGlmICghc2FsdD8uYnl0ZUxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdzYWx0JykKCiAgY29uc3QgW2RvbmUsIHByb21pc2VdID0gY2hlY2tTdGF0dXMoY2FsbGJhY2spCgogIGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfYXN5bmMoCiAgICBvdXQuYnVmZmVyLAogICAgb3V0LmJ5dGVPZmZzZXQsCiAgICBvdXQuYnl0ZUxlbmd0aCwKCiAgICBwYXNzd2QuYnVmZmVyLAogICAgcGFzc3dkLmJ5dGVPZmZzZXQsCiAgICBwYXNzd2QuYnl0ZUxlbmd0aCwKCiAgICBzYWx0LmJ1ZmZlciwKICAgIHNhbHQuYnl0ZU9mZnNldCwKICAgIHNhbHQuYnl0ZUxlbmd0aCwKCiAgICBpdGVyLAogICAgb3V0bGVuLAoKICAgIGRvbmUKICApCgogIHJldHVybiBwcm9taXNlCn0KCmV4cG9ydHMuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTIgPSBmdW5jdGlvbiAob3V0LCBwYXNzd2QsIHNhbHQsIGl0ZXIsIG91dGxlbikgewogIGlmIChpdGVyIDwgYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMl9JVEVSQVRJT05TX01JTikKICAgIHRocm93IG5ldyBFcnJvcignaXRlcmF0aW9ucycpCiAgaWYgKG91dGxlbiA+IGJpbmRpbmcuZXh0ZW5zaW9uX3Bia2RmMl9zaGE1MTJfQllURVNfTUFYKQogICAgdGhyb3cgbmV3IEVycm9yKCdvdXRsZW4nKQogIGlmIChvdXQ/LmJ5dGVMZW5ndGggPCBvdXRsZW4pIHRocm93IG5ldyBFcnJvcignb3V0JykKCiAgY29uc3QgcmVzID0gYmluZGluZy5leHRlbnNpb25fcGJrZGYyX3NoYTUxMihvdXQsIHBhc3N3ZCwgc2FsdCwgaXRlciwgb3V0bGVuKQoKICBpZiAocmVzICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWxlZCB0byBhZGQgdHdlYWsgdG8gcHVibGljIGtleScpCn0KCmZ1bmN0aW9uIGNoZWNrU3RhdHVzKGNhbGxiYWNrLCBib29sZWFuUmVzdWx0ID0gZmFsc2UpIHsKICBsZXQgZG9uZSwgcHJvbWlzZQoKICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICBkb25lID0gZnVuY3Rpb24gKHN0YXR1cykgewogICAgICBpZiAoYm9vbGVhblJlc3VsdCkgY2FsbGJhY2sobnVsbCwgc3RhdHVzID09PSAwKQogICAgICBlbHNlIGlmIChzdGF0dXMgPT09IDApIGNhbGxiYWNrKG51bGwpCiAgICAgIGVsc2UgY2FsbGJhY2sobmV3IEVycm9yKCdzdGF0dXM6ICcgKyBzdGF0dXMpKQogICAgfQogIH0gZWxzZSB7CiAgICBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBkb25lID0gZnVuY3Rpb24gKHN0YXR1cykgewogICAgICAgIGlmIChib29sZWFuUmVzdWx0KSByZXNvbHZlKHN0YXR1cyA9PT0gMCkKICAgICAgICBlbHNlIGlmIChzdGF0dXMgPT09IDApIHJlc29sdmUoKQogICAgICAgIGVsc2UgcmVqZWN0KG5ldyBFcnJvcignc3RhdHVzOiAnICsgc3RhdHVzKSkKICAgICAgfQogICAgfSkKICB9CgogIHJldHVybiBbZG9uZSwgcHJvbWlzZV0KfQp7CiAgIm5hbWUiOiAic29kaXVtLW5hdGl2ZSIsCiAgInZlcnNpb24iOiAiNS4wLjEwIiwKICAiZGVzY3JpcHRpb24iOiAiTG93IGxldmVsIGJpbmRpbmdzIGZvciBsaWJzb2RpdW0iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImJpbmRpbmcuY2MiLAogICAgImJpbmRpbmcuanMiLAogICAgImV4dGVuc2lvbnMiLAogICAgInByZWJ1aWxkcyIsCiAgICAiQ01ha2VMaXN0cy50eHQiCiAgXSwKICAiYWRkb24iOiB0cnVlLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAicmVxdWlyZS1hZGRvbiI6ICJeMS4xLjAiLAogICAgIndoaWNoLXJ1bnRpbWUiOiAiXjEuMi4xIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuNSIsCiAgICAiYnJpdHRsZSI6ICJeMy4xNi4yIiwKICAgICJjbWFrZS1iYXJlIjogIl4xLjYuMSIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuNC4zIiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjIuMSIsCiAgICAicHJldHRpZXIiOiAiXjMuNi4yIiwKICAgICJwcmV0dGllci1jb25maWctaG9sZXB1bmNoIjogIl4xLjAuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAicHJldHRpZXIgLiAtLWNoZWNrICYmIG5wbSBydW4gdGVzdDpub2RlICYmIG5wbSBydW4gdGVzdDpiYXJlIiwKICAgICJ0ZXN0Om5vZGUiOiAibm9kZSB0ZXN0L2FsbC5qcyIsCiAgICAidGVzdDpiYXJlIjogImJhcmUgdGVzdC9hbGwuanMiCiAgfSwKICAic3RhbmRhcmQiOiB7CiAgICAiaWdub3JlIjogWwogICAgICAiL3Rlc3QvZml4dHVyZXMvKi5qcyIKICAgIF0KICB9LAogICJlbmdpbmVzIjogewogICAgImJhcmUiOiAiPj0xLjE2LjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLW5hdGl2ZS5naXQiCiAgfSwKICAiY29udHJpYnV0b3JzIjogWwogICAgIkVtaWwgQmF5IDxnaXRodWJAdGl4ei5kaz4gKGh0dHA6Ly9iYXllcy5kaykiLAogICAgIk1hdGhpYXMgQnV1cyA8bWF0aGlhc2J1dXNAZ21haWwuY29tPiAoaHR0cHM6Ly9tYWZpbnRvLnNoKSIsCiAgICAiQ2hyaXN0b3BoZSBEaWVkZXJpY2hzIDxjaG0tZGllZGVyaWNoc0BoeXBlcmRpdmlzaW9uLmRrPiIKICBdLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tbmF0aXZlL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc29kaXVtLW5hdGl2ZSIKfQpjb25zdCBzb2RpdW0gPSByZXF1aXJlKCdzb2RpdW0tdW5pdmVyc2FsJykKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEFCWVRFUyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X0FCWVRFUwpjb25zdCBUQUdfTUVTU0FHRSA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X1RBR19NRVNTQUdFCmNvbnN0IFRBR19GSU5BTCA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X1RBR19GSU5BTApjb25zdCBTVEFURUJZVEVTID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfU1RBVEVCWVRFUwpjb25zdCBIRUFERVJCWVRFUyA9IHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X0hFQURFUkJZVEVTCmNvbnN0IEtFWUJZVEVTID0gc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfS0VZQllURVMKY29uc3QgVEFHX0ZJTkFMX0JZVEUgPSBiNGEuaXNCdWZmZXIoVEFHX0ZJTkFMKSA/IFRBR19GSU5BTFswXSA6IFRBR19GSU5BTAoKY29uc3QgRU1QVFkgPSBiNGEuYWxsb2MoMCkKY29uc3QgVEFHID0gYjRhLmFsbG9jKDEpCgpjbGFzcyBQdXNoIHsKICBjb25zdHJ1Y3RvciAoa2V5LCBzdGF0ZSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coU1RBVEVCWVRFUyksIGhlYWRlciA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coSEVBREVSQllURVMpKSB7CiAgICBpZiAoIVRBR19GSU5BTCkgdGhyb3cgbmV3IEVycm9yKCdKYXZhU2NyaXB0IHNvZGl1bSB2ZXJzaW9uIG5lZWRzIHRvIHN1cHBvcnQgY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5JykKCiAgICB0aGlzLmtleSA9IGtleQogICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB0aGlzLmhlYWRlciA9IGhlYWRlcgoKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2luaXRfcHVzaCh0aGlzLnN0YXRlLCB0aGlzLmhlYWRlciwgdGhpcy5rZXkpCiAgfQoKICBuZXh0IChtZXNzYWdlLCBjaXBoZXIgPSBiNGEuYWxsb2NVbnNhZmUobWVzc2FnZS5ieXRlTGVuZ3RoICsgQUJZVEVTKSkgewogICAgc29kaXVtLmNyeXB0b19zZWNyZXRzdHJlYW1feGNoYWNoYTIwcG9seTEzMDVfcHVzaCh0aGlzLnN0YXRlLCBjaXBoZXIsIG1lc3NhZ2UsIG51bGwsIFRBR19NRVNTQUdFKQogICAgcmV0dXJuIGNpcGhlcgogIH0KCiAgZmluYWwgKG1lc3NhZ2UgPSBFTVBUWSwgY2lwaGVyID0gYjRhLmFsbG9jVW5zYWZlKEFCWVRFUykpIHsKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1c2godGhpcy5zdGF0ZSwgY2lwaGVyLCBtZXNzYWdlLCBudWxsLCBUQUdfRklOQUwpCiAgICByZXR1cm4gY2lwaGVyCiAgfQp9CgpjbGFzcyBQdWxsIHsKICBjb25zdHJ1Y3RvciAoa2V5LCBzdGF0ZSA9IGI0YS5hbGxvY1Vuc2FmZVNsb3coU1RBVEVCWVRFUykpIHsKICAgIGlmICghVEFHX0ZJTkFMKSB0aHJvdyBuZXcgRXJyb3IoJ0phdmFTY3JpcHQgc29kaXVtIHZlcnNpb24gbmVlZHMgdG8gc3VwcG9ydCBjcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHknKQoKICAgIHRoaXMua2V5ID0ga2V5CiAgICB0aGlzLnN0YXRlID0gc3RhdGUKICAgIHRoaXMuZmluYWwgPSBmYWxzZQogIH0KCiAgaW5pdCAoaGVhZGVyKSB7CiAgICBzb2RpdW0uY3J5cHRvX3NlY3JldHN0cmVhbV94Y2hhY2hhMjBwb2x5MTMwNV9pbml0X3B1bGwodGhpcy5zdGF0ZSwgaGVhZGVyLCB0aGlzLmtleSkKICB9CgogIG5leHQgKGNpcGhlciwgbWVzc2FnZSA9IGI0YS5hbGxvY1Vuc2FmZShjaXBoZXIuYnl0ZUxlbmd0aCAtIEFCWVRFUykpIHsKICAgIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X3B1bGwodGhpcy5zdGF0ZSwgbWVzc2FnZSwgVEFHLCBjaXBoZXIsIG51bGwpCiAgICB0aGlzLmZpbmFsID0gVEFHWzBdID09PSBUQUdfRklOQUxfQllURQogICAgcmV0dXJuIG1lc3NhZ2UKICB9Cn0KCmZ1bmN0aW9uIGtleWdlbiAoYnVmID0gYjRhLmFsbG9jKEtFWUJZVEVTKSkgewogIHNvZGl1bS5jcnlwdG9fc2VjcmV0c3RyZWFtX3hjaGFjaGEyMHBvbHkxMzA1X2tleWdlbihidWYpCiAgcmV0dXJuIGJ1Zgp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBrZXlnZW4sCiAgS0VZQllURVMsCiAgQUJZVEVTLAogIFNUQVRFQllURVMsCiAgSEVBREVSQllURVMsCiAgUHVzaCwKICBQdWxsCn0KewogICJuYW1lIjogInNvZGl1bS1zZWNyZXRzdHJlYW0iLAogICJ2ZXJzaW9uIjogIjEuMi4wIiwKICAiZGVzY3JpcHRpb24iOiAiV3JhcHMgbGlic29kaXVtcyBzZWNyZXRzdHJlYW0gaW4gYSBoaWdoZXIgbGV2ZWwgYWJzdHJhY3Rpb24iLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgImI0YSI6ICJeMS4xLjEiLAogICAgInNvZGl1bS11bml2ZXJzYWwiOiAiXjUuMC4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zb2RpdW0tc2VjcmV0c3RyZWFtLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zb2RpdW0tc2VjcmV0c3RyZWFtL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3NvZGl1bS1zZWNyZXRzdHJlYW0iCn0KbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCdzb2RpdW0tbmF0aXZlJykKewogICJuYW1lIjogInNvZGl1bS11bml2ZXJzYWwiLAogICJ2ZXJzaW9uIjogIjUuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiVW5pdmVyc2FsIHdyYXBwZXIgZm9yIHNvZGl1bS1qYXZhc2NyaXB0IGFuZCBzb2RpdW0tbmF0aXZlIHdvcmtpbmcgaW4gTm9kZS5qcyBhbmQgdGhlIEJyb3dzZXIiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjogewogICAgInNvZGl1bS1uYXRpdmUiOiAiXjUuMC4xIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXMiOiB7CiAgICAic29kaXVtLWphdmFzY3JpcHQiOiAifjAuOC4wIgogIH0sCiAgInBlZXJEZXBlbmRlbmNpZXNNZXRhIjogewogICAgInNvZGl1bS1qYXZhc2NyaXB0IjogewogICAgICAib3B0aW9uYWwiOiB0cnVlCiAgICB9CiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJwcmVwdWJsaXNoIjogIi4vYnVpbGQtc2NyaXB0cy9nZW5lcmF0ZS5qcyIKICB9LAogICJicm93c2VyIjogewogICAgInNvZGl1bS1uYXRpdmUiOiAic29kaXVtLWphdmFzY3JpcHQiCiAgfSwKICAiYnJvd3NlcmlmeSI6IHsKICAgICJ0cmFuc2Zvcm0iOiBbCiAgICAgICIuL2J1aWxkLXNjcmlwdHMvdHJhbnNmb3JtLmpzIgogICAgXQogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS11bml2ZXJzYWwuZ2l0IgogIH0sCiAgImtleXdvcmRzIjogWwogICAgImxpYnNvZGl1bSIsCiAgICAic29kaXVtIiwKICAgICJzb2RpdW0tbmF0aXZlIiwKICAgICJzb2RpdW0tamF2YXNjcmlwdCIsCiAgICAiYnJvd3NlcmlmeSIKICBdLAogICJjb250cmlidXRvcnMiOiBbCiAgICAiRW1pbCBCYXkgPGdpdGh1YkB0aXh6LmRrPiAoaHR0cDovL2JheWVzLmRrKSIsCiAgICAiTWF0aGlhcyBCdXVzIDxtYXRoaWFzYnV1c0BnbWFpbC5jb20+IChodHRwczovL21hZmludG8uc2gpIiwKICAgICJDaHJpc3RvcGhlIERpZWRlcmljaHMgPGNobS1kaWVkZXJpY2hzQGh5cGVyZGl2aXNpb24uZGs+IgogIF0sCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3NvZGl1bS11bml2ZXJzYWwvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by9zb2RpdW0tdW5pdmVyc2FsI3JlYWRtZSIKfQpjb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gcmVxdWlyZSgnZXZlbnRzLXVuaXZlcnNhbCcpCmNvbnN0IFNUUkVBTV9ERVNUUk9ZRUQgPSBuZXcgRXJyb3IoJ1N0cmVhbSB3YXMgZGVzdHJveWVkJykKY29uc3QgUFJFTUFUVVJFX0NMT1NFID0gbmV3IEVycm9yKCdQcmVtYXR1cmUgY2xvc2UnKQoKY29uc3QgRklGTyA9IHJlcXVpcmUoJ2Zhc3QtZmlmbycpCmNvbnN0IFRleHREZWNvZGVyID0gcmVxdWlyZSgndGV4dC1kZWNvZGVyJykKCi8vIGlmIHdlIGRvIGEgZnV0dXJlIG1ham9yLCBleHBlY3QgcXVldWUgbWljcm90YXNrIHRvIGJlIHRoZXJlIGFsd2F5cywgZm9yIG5vdyBhIGJpdCBkZWZlbnNpdmUKY29uc3QgcW10ID0gdHlwZW9mIHF1ZXVlTWljcm90YXNrID09PSAndW5kZWZpbmVkJyA/IGZuID0+IGdsb2JhbC5wcm9jZXNzLm5leHRUaWNrKGZuKSA6IHF1ZXVlTWljcm90YXNrCgovKiBlc2xpbnQtZGlzYWJsZSBuby1tdWx0aS1zcGFjZXMgKi8KCi8vIDI5IGJpdHMgdXNlZCB0b3RhbCAoNCBmcm9tIHNoYXJlZCwgMTQgZnJvbSByZWFkLCBhbmQgMTEgZnJvbSB3cml0ZSkKY29uc3QgTUFYID0gKCgxIDw8IDI5KSAtIDEpCgovLyBTaGFyZWQgc3RhdGUKY29uc3QgT1BFTklORyAgICAgICA9IDBiMDAwMQpjb25zdCBQUkVERVNUUk9ZSU5HID0gMGIwMDEwCmNvbnN0IERFU1RST1lJTkcgICAgPSAwYjAxMDAKY29uc3QgREVTVFJPWUVEICAgICA9IDBiMTAwMAoKY29uc3QgTk9UX09QRU5JTkcgPSBNQVggXiBPUEVOSU5HCmNvbnN0IE5PVF9QUkVERVNUUk9ZSU5HID0gTUFYIF4gUFJFREVTVFJPWUlORwoKLy8gUmVhZCBzdGF0ZSAoNCBiaXQgb2Zmc2V0IGZyb20gc2hhcmVkIHN0YXRlKQpjb25zdCBSRUFEX0FDVElWRSAgICAgICAgICAgPSAwYjAwMDAwMDAwMDAwMDAxIDw8IDQKY29uc3QgUkVBRF9VUERBVElORyAgICAgICAgID0gMGIwMDAwMDAwMDAwMDAxMCA8PCA0CmNvbnN0IFJFQURfUFJJTUFSWSAgICAgICAgICA9IDBiMDAwMDAwMDAwMDAxMDAgPDwgNApjb25zdCBSRUFEX1FVRVVFRCAgICAgICAgICAgPSAwYjAwMDAwMDAwMDAxMDAwIDw8IDQKY29uc3QgUkVBRF9SRVNVTUVEICAgICAgICAgID0gMGIwMDAwMDAwMDAxMDAwMCA8PCA0CmNvbnN0IFJFQURfUElQRV9EUkFJTkVEICAgICA9IDBiMDAwMDAwMDAxMDAwMDAgPDwgNApjb25zdCBSRUFEX0VORElORyAgICAgICAgICAgPSAwYjAwMDAwMDAxMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9FTUlUX0RBVEEgICAgICAgID0gMGIwMDAwMDAxMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfRU1JVF9SRUFEQUJMRSAgICA9IDBiMDAwMDAxMDAwMDAwMDAgPDwgNApjb25zdCBSRUFEX0VNSVRURURfUkVBREFCTEUgPSAwYjAwMDAxMDAwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9ET05FICAgICAgICAgICAgID0gMGIwMDAxMDAwMDAwMDAwMCA8PCA0CmNvbnN0IFJFQURfTkVYVF9USUNLICAgICAgICA9IDBiMDAxMDAwMDAwMDAwMDAgPDwgNApjb25zdCBSRUFEX05FRURTX1BVU0ggICAgICAgPSAwYjAxMDAwMDAwMDAwMDAwIDw8IDQKY29uc3QgUkVBRF9SRUFEX0FIRUFEICAgICAgID0gMGIxMDAwMDAwMDAwMDAwMCA8PCA0CgovLyBDb21iaW5lZCByZWFkIHN0YXRlCmNvbnN0IFJFQURfRkxPV0lORyA9IFJFQURfUkVTVU1FRCB8IFJFQURfUElQRV9EUkFJTkVECmNvbnN0IFJFQURfQUNUSVZFX0FORF9ORUVEU19QVVNIID0gUkVBRF9BQ1RJVkUgfCBSRUFEX05FRURTX1BVU0gKY29uc3QgUkVBRF9QUklNQVJZX0FORF9BQ1RJVkUgPSBSRUFEX1BSSU1BUlkgfCBSRUFEX0FDVElWRQpjb25zdCBSRUFEX0VNSVRfUkVBREFCTEVfQU5EX1FVRVVFRCA9IFJFQURfRU1JVF9SRUFEQUJMRSB8IFJFQURfUVVFVUVECmNvbnN0IFJFQURfUkVTVU1FRF9SRUFEX0FIRUFEID0gUkVBRF9SRVNVTUVEIHwgUkVBRF9SRUFEX0FIRUFECgpjb25zdCBSRUFEX05PVF9BQ1RJVkUgICAgICAgICAgICAgPSBNQVggXiBSRUFEX0FDVElWRQpjb25zdCBSRUFEX05PTl9QUklNQVJZICAgICAgICAgICAgPSBNQVggXiBSRUFEX1BSSU1BUlkKY29uc3QgUkVBRF9OT05fUFJJTUFSWV9BTkRfUFVTSEVEID0gTUFYIF4gKFJFQURfUFJJTUFSWSB8IFJFQURfTkVFRFNfUFVTSCkKY29uc3QgUkVBRF9QVVNIRUQgICAgICAgICAgICAgICAgID0gTUFYIF4gUkVBRF9ORUVEU19QVVNICmNvbnN0IFJFQURfUEFVU0VEICAgICAgICAgICAgICAgICA9IE1BWCBeIFJFQURfUkVTVU1FRApjb25zdCBSRUFEX05PVF9RVUVVRUQgICAgICAgICAgICAgPSBNQVggXiAoUkVBRF9RVUVVRUQgfCBSRUFEX0VNSVRURURfUkVBREFCTEUpCmNvbnN0IFJFQURfTk9UX0VORElORyAgICAgICAgICAgICA9IE1BWCBeIFJFQURfRU5ESU5HCmNvbnN0IFJFQURfUElQRV9OT1RfRFJBSU5FRCAgICAgICA9IE1BWCBeIFJFQURfRkxPV0lORwpjb25zdCBSRUFEX05PVF9ORVhUX1RJQ0sgICAgICAgICAgPSBNQVggXiBSRUFEX05FWFRfVElDSwpjb25zdCBSRUFEX05PVF9VUERBVElORyAgICAgICAgICAgPSBNQVggXiBSRUFEX1VQREFUSU5HCmNvbnN0IFJFQURfTk9fUkVBRF9BSEVBRCAgICAgICAgICA9IE1BWCBeIFJFQURfUkVBRF9BSEVBRApjb25zdCBSRUFEX1BBVVNFRF9OT19SRUFEX0FIRUFEICAgPSBNQVggXiBSRUFEX1JFU1VNRURfUkVBRF9BSEVBRAoKLy8gV3JpdGUgc3RhdGUgKDE4IGJpdCBvZmZzZXQsIDQgYml0IG9mZnNldCBmcm9tIHNoYXJlZCBzdGF0ZSBhbmQgMTQgZnJvbSByZWFkIHN0YXRlKQpjb25zdCBXUklURV9BQ1RJVkUgICAgID0gMGIwMDAwMDAwMDAwMSA8PCAxOApjb25zdCBXUklURV9VUERBVElORyAgID0gMGIwMDAwMDAwMDAxMCA8PCAxOApjb25zdCBXUklURV9QUklNQVJZICAgID0gMGIwMDAwMDAwMDEwMCA8PCAxOApjb25zdCBXUklURV9RVUVVRUQgICAgID0gMGIwMDAwMDAwMTAwMCA8PCAxOApjb25zdCBXUklURV9VTkRSQUlORUQgID0gMGIwMDAwMDAxMDAwMCA8PCAxOApjb25zdCBXUklURV9ET05FICAgICAgID0gMGIwMDAwMDEwMDAwMCA8PCAxOApjb25zdCBXUklURV9FTUlUX0RSQUlOID0gMGIwMDAwMTAwMDAwMCA8PCAxOApjb25zdCBXUklURV9ORVhUX1RJQ0sgID0gMGIwMDAxMDAwMDAwMCA8PCAxOApjb25zdCBXUklURV9XUklUSU5HICAgID0gMGIwMDEwMDAwMDAwMCA8PCAxOApjb25zdCBXUklURV9GSU5JU0hJTkcgID0gMGIwMTAwMDAwMDAwMCA8PCAxOApjb25zdCBXUklURV9DT1JLRUQgICAgID0gMGIxMDAwMDAwMDAwMCA8PCAxOAoKY29uc3QgV1JJVEVfTk9UX0FDVElWRSAgICA9IE1BWCBeIChXUklURV9BQ1RJVkUgfCBXUklURV9XUklUSU5HKQpjb25zdCBXUklURV9OT05fUFJJTUFSWSAgID0gTUFYIF4gV1JJVEVfUFJJTUFSWQpjb25zdCBXUklURV9OT1RfRklOSVNISU5HID0gTUFYIF4gKFdSSVRFX0FDVElWRSB8IFdSSVRFX0ZJTklTSElORykKY29uc3QgV1JJVEVfRFJBSU5FRCAgICAgICA9IE1BWCBeIFdSSVRFX1VORFJBSU5FRApjb25zdCBXUklURV9OT1RfUVVFVUVEICAgID0gTUFYIF4gV1JJVEVfUVVFVUVECmNvbnN0IFdSSVRFX05PVF9ORVhUX1RJQ0sgPSBNQVggXiBXUklURV9ORVhUX1RJQ0sKY29uc3QgV1JJVEVfTk9UX1VQREFUSU5HICA9IE1BWCBeIFdSSVRFX1VQREFUSU5HCmNvbnN0IFdSSVRFX05PVF9DT1JLRUQgICAgPSBNQVggXiBXUklURV9DT1JLRUQKCi8vIENvbWJpbmVkIHNoYXJlZCBzdGF0ZQpjb25zdCBBQ1RJVkUgPSBSRUFEX0FDVElWRSB8IFdSSVRFX0FDVElWRQpjb25zdCBOT1RfQUNUSVZFID0gTUFYIF4gQUNUSVZFCmNvbnN0IERPTkUgPSBSRUFEX0RPTkUgfCBXUklURV9ET05FCmNvbnN0IERFU1RST1lfU1RBVFVTID0gREVTVFJPWUlORyB8IERFU1RST1lFRCB8IFBSRURFU1RST1lJTkcKY29uc3QgT1BFTl9TVEFUVVMgPSBERVNUUk9ZX1NUQVRVUyB8IE9QRU5JTkcKY29uc3QgQVVUT19ERVNUUk9ZID0gREVTVFJPWV9TVEFUVVMgfCBET05FCmNvbnN0IE5PTl9QUklNQVJZID0gV1JJVEVfTk9OX1BSSU1BUlkgJiBSRUFEX05PTl9QUklNQVJZCmNvbnN0IEFDVElWRV9PUl9USUNLSU5HID0gV1JJVEVfTkVYVF9USUNLIHwgUkVBRF9ORVhUX1RJQ0sKY29uc3QgVElDS0lORyA9IEFDVElWRV9PUl9USUNLSU5HICYgTk9UX0FDVElWRQpjb25zdCBJU19PUEVOSU5HID0gT1BFTl9TVEFUVVMgfCBUSUNLSU5HCgovLyBDb21iaW5lZCBzaGFyZWQgc3RhdGUgYW5kIHJlYWQgc3RhdGUKY29uc3QgUkVBRF9QUklNQVJZX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgUkVBRF9FTkRJTkcgfCBSRUFEX0RPTkUKY29uc3QgUkVBRF9TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFJFQURfRE9ORSB8IFJFQURfUVVFVUVECmNvbnN0IFJFQURfRU5ESU5HX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgUkVBRF9FTkRJTkcgfCBSRUFEX1FVRVVFRApjb25zdCBSRUFEX1JFQURBQkxFX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgUkVBRF9FTUlUX1JFQURBQkxFIHwgUkVBRF9RVUVVRUQgfCBSRUFEX0VNSVRURURfUkVBREFCTEUKY29uc3QgU0hPVUxEX05PVF9SRUFEID0gT1BFTl9TVEFUVVMgfCBSRUFEX0FDVElWRSB8IFJFQURfRU5ESU5HIHwgUkVBRF9ET05FIHwgUkVBRF9ORUVEU19QVVNIIHwgUkVBRF9SRUFEX0FIRUFECmNvbnN0IFJFQURfQkFDS1BSRVNTVVJFX1NUQVRVUyA9IERFU1RST1lfU1RBVFVTIHwgUkVBRF9FTkRJTkcgfCBSRUFEX0RPTkUKY29uc3QgUkVBRF9VUERBVEVfU1lOQ19TVEFUVVMgPSBSRUFEX1VQREFUSU5HIHwgT1BFTl9TVEFUVVMgfCBSRUFEX05FWFRfVElDSyB8IFJFQURfUFJJTUFSWQpjb25zdCBSRUFEX05FWFRfVElDS19PUl9PUEVOSU5HID0gUkVBRF9ORVhUX1RJQ0sgfCBPUEVOSU5HCgovLyBDb21iaW5lZCB3cml0ZSBzdGF0ZQpjb25zdCBXUklURV9QUklNQVJZX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgV1JJVEVfRklOSVNISU5HIHwgV1JJVEVfRE9ORQpjb25zdCBXUklURV9RVUVVRURfQU5EX1VORFJBSU5FRCA9IFdSSVRFX1FVRVVFRCB8IFdSSVRFX1VORFJBSU5FRApjb25zdCBXUklURV9RVUVVRURfQU5EX0FDVElWRSA9IFdSSVRFX1FVRVVFRCB8IFdSSVRFX0FDVElWRQpjb25zdCBXUklURV9EUkFJTl9TVEFUVVMgPSBXUklURV9RVUVVRUQgfCBXUklURV9VTkRSQUlORUQgfCBPUEVOX1NUQVRVUyB8IFdSSVRFX0FDVElWRQpjb25zdCBXUklURV9TVEFUVVMgPSBPUEVOX1NUQVRVUyB8IFdSSVRFX0FDVElWRSB8IFdSSVRFX1FVRVVFRCB8IFdSSVRFX0NPUktFRApjb25zdCBXUklURV9QUklNQVJZX0FORF9BQ1RJVkUgPSBXUklURV9QUklNQVJZIHwgV1JJVEVfQUNUSVZFCmNvbnN0IFdSSVRFX0FDVElWRV9BTkRfV1JJVElORyA9IFdSSVRFX0FDVElWRSB8IFdSSVRFX1dSSVRJTkcKY29uc3QgV1JJVEVfRklOSVNISU5HX1NUQVRVUyA9IE9QRU5fU1RBVFVTIHwgV1JJVEVfRklOSVNISU5HIHwgV1JJVEVfUVVFVUVEX0FORF9BQ1RJVkUgfCBXUklURV9ET05FCmNvbnN0IFdSSVRFX0JBQ0tQUkVTU1VSRV9TVEFUVVMgPSBXUklURV9VTkRSQUlORUQgfCBERVNUUk9ZX1NUQVRVUyB8IFdSSVRFX0ZJTklTSElORyB8IFdSSVRFX0RPTkUKY29uc3QgV1JJVEVfVVBEQVRFX1NZTkNfU1RBVFVTID0gV1JJVEVfVVBEQVRJTkcgfCBPUEVOX1NUQVRVUyB8IFdSSVRFX05FWFRfVElDSyB8IFdSSVRFX1BSSU1BUlkKY29uc3QgV1JJVEVfRFJPUF9EQVRBID0gV1JJVEVfRklOSVNISU5HIHwgV1JJVEVfRE9ORSB8IERFU1RST1lfU1RBVFVTCgpjb25zdCBhc3luY0l0ZXJhdG9yID0gU3ltYm9sLmFzeW5jSXRlcmF0b3IgfHwgU3ltYm9sKCdhc3luY0l0ZXJhdG9yJykKCmNsYXNzIFdyaXRhYmxlU3RhdGUgewogIGNvbnN0cnVjdG9yIChzdHJlYW0sIHsgaGlnaFdhdGVyTWFyayA9IDE2Mzg0LCBtYXAgPSBudWxsLCBtYXBXcml0YWJsZSwgYnl0ZUxlbmd0aCwgYnl0ZUxlbmd0aFdyaXRhYmxlIH0gPSB7fSkgewogICAgdGhpcy5zdHJlYW0gPSBzdHJlYW0KICAgIHRoaXMucXVldWUgPSBuZXcgRklGTygpCiAgICB0aGlzLmhpZ2hXYXRlck1hcmsgPSBoaWdoV2F0ZXJNYXJrCiAgICB0aGlzLmJ1ZmZlcmVkID0gMAogICAgdGhpcy5lcnJvciA9IG51bGwKICAgIHRoaXMucGlwZWxpbmUgPSBudWxsCiAgICB0aGlzLmRyYWlucyA9IG51bGwgLy8gaWYgd2UgYWRkIG1vcmUgc2VsZG9tbHkgdXNlZCBoZWxwZXJzIHdlIG1pZ2h0IHRoZW0gaW50byBhIHN1Ym9iamVjdCBzbyBpdHMgYSBzaW5nbGUgcHRyCiAgICB0aGlzLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoV3JpdGFibGUgfHwgYnl0ZUxlbmd0aCB8fCBkZWZhdWx0Qnl0ZUxlbmd0aAogICAgdGhpcy5tYXAgPSBtYXBXcml0YWJsZSB8fCBtYXAKICAgIHRoaXMuYWZ0ZXJXcml0ZSA9IGFmdGVyV3JpdGUuYmluZCh0aGlzKQogICAgdGhpcy5hZnRlclVwZGF0ZU5leHRUaWNrID0gdXBkYXRlV3JpdGVOVC5iaW5kKHRoaXMpCiAgfQoKICBnZXQgZW5kZWQgKCkgewogICAgcmV0dXJuICh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9ET05FKSAhPT0gMAogIH0KCiAgcHVzaCAoZGF0YSkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9EUk9QX0RBVEEpICE9PSAwKSByZXR1cm4gZmFsc2UKICAgIGlmICh0aGlzLm1hcCAhPT0gbnVsbCkgZGF0YSA9IHRoaXMubWFwKGRhdGEpCgogICAgdGhpcy5idWZmZXJlZCArPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgIHRoaXMucXVldWUucHVzaChkYXRhKQoKICAgIGlmICh0aGlzLmJ1ZmZlcmVkIDwgdGhpcy5oaWdoV2F0ZXJNYXJrKSB7CiAgICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9RVUVVRUQKICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfUVVFVUVEX0FORF9VTkRSQUlORUQKICAgIHJldHVybiBmYWxzZQogIH0KCiAgc2hpZnQgKCkgewogICAgY29uc3QgZGF0YSA9IHRoaXMucXVldWUuc2hpZnQoKQoKICAgIHRoaXMuYnVmZmVyZWQgLT0gdGhpcy5ieXRlTGVuZ3RoKGRhdGEpCiAgICBpZiAodGhpcy5idWZmZXJlZCA9PT0gMCkgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9RVUVVRUQKCiAgICByZXR1cm4gZGF0YQogIH0KCiAgZW5kIChkYXRhKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicpIHRoaXMuc3RyZWFtLm9uY2UoJ2ZpbmlzaCcsIGRhdGEpCiAgICBlbHNlIGlmIChkYXRhICE9PSB1bmRlZmluZWQgJiYgZGF0YSAhPT0gbnVsbCkgdGhpcy5wdXNoKGRhdGEpCiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgPSAodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHwgV1JJVEVfRklOSVNISU5HKSAmIFdSSVRFX05PTl9QUklNQVJZCiAgfQoKICBhdXRvQmF0Y2ggKGRhdGEsIGNiKSB7CiAgICBjb25zdCBidWZmZXIgPSBbXQogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBidWZmZXIucHVzaChkYXRhKQogICAgd2hpbGUgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfU1RBVFVTKSA9PT0gV1JJVEVfUVVFVUVEX0FORF9BQ1RJVkUpIHsKICAgICAgYnVmZmVyLnB1c2goc3RyZWFtLl93cml0YWJsZVN0YXRlLnNoaWZ0KCkpCiAgICB9CgogICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgT1BFTl9TVEFUVVMpICE9PSAwKSByZXR1cm4gY2IobnVsbCkKICAgIHN0cmVhbS5fd3JpdGV2KGJ1ZmZlciwgY2IpCiAgfQoKICB1cGRhdGUgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFdSSVRFX1VQREFUSU5HCgogICAgZG8gewogICAgICB3aGlsZSAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9TVEFUVVMpID09PSBXUklURV9RVUVVRUQpIHsKICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5zaGlmdCgpCiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9BQ1RJVkVfQU5EX1dSSVRJTkcKICAgICAgICBzdHJlYW0uX3dyaXRlKGRhdGEsIHRoaXMuYWZ0ZXJXcml0ZSkKICAgICAgfQoKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfUFJJTUFSWV9BTkRfQUNUSVZFKSA9PT0gMCkgdGhpcy51cGRhdGVOb25QcmltYXJ5KCkKICAgIH0gd2hpbGUgKHRoaXMuY29udGludWVVcGRhdGUoKSA9PT0gdHJ1ZSkKCiAgICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9VUERBVElORwogIH0KCiAgdXBkYXRlTm9uUHJpbWFyeSAoKSB7CiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0ZJTklTSElOR19TVEFUVVMpID09PSBXUklURV9GSU5JU0hJTkcpIHsKICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSA9IHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBXUklURV9BQ1RJVkUKICAgICAgc3RyZWFtLl9maW5hbChhZnRlckZpbmFsLmJpbmQodGhpcykpCiAgICAgIHJldHVybgogICAgfQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSA9PT0gREVTVFJPWUlORykgewogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBQ1RJVkVfT1JfVElDS0lORykgPT09IDApIHsKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IEFDVElWRQogICAgICAgIHN0cmVhbS5fZGVzdHJveShhZnRlckRlc3Ryb3kuYmluZCh0aGlzKSkKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBJU19PUEVOSU5HKSA9PT0gT1BFTklORykgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBBQ1RJVkUpICYgTk9UX09QRU5JTkcKICAgICAgc3RyZWFtLl9vcGVuKGFmdGVyT3Blbi5iaW5kKHRoaXMpKQogICAgfQogIH0KCiAgY29udGludWVVcGRhdGUgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9ORVhUX1RJQ0spID09PSAwKSByZXR1cm4gZmFsc2UKICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfTkVYVF9USUNLCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgdXBkYXRlQ2FsbGJhY2sgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9VUERBVEVfU1lOQ19TVEFUVVMpID09PSBXUklURV9QUklNQVJZKSB0aGlzLnVwZGF0ZSgpCiAgICBlbHNlIHRoaXMudXBkYXRlTmV4dFRpY2soKQogIH0KCiAgdXBkYXRlTmV4dFRpY2sgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9ORVhUX1RJQ0spICE9PSAwKSByZXR1cm4KICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9ORVhUX1RJQ0sKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgV1JJVEVfVVBEQVRJTkcpID09PSAwKSBxbXQodGhpcy5hZnRlclVwZGF0ZU5leHRUaWNrKQogIH0KfQoKY2xhc3MgUmVhZGFibGVTdGF0ZSB7CiAgY29uc3RydWN0b3IgKHN0cmVhbSwgeyBoaWdoV2F0ZXJNYXJrID0gMTYzODQsIG1hcCA9IG51bGwsIG1hcFJlYWRhYmxlLCBieXRlTGVuZ3RoLCBieXRlTGVuZ3RoUmVhZGFibGUgfSA9IHt9KSB7CiAgICB0aGlzLnN0cmVhbSA9IHN0cmVhbQogICAgdGhpcy5xdWV1ZSA9IG5ldyBGSUZPKCkKICAgIHRoaXMuaGlnaFdhdGVyTWFyayA9IGhpZ2hXYXRlck1hcmsgPT09IDAgPyAxIDogaGlnaFdhdGVyTWFyawogICAgdGhpcy5idWZmZXJlZCA9IDAKICAgIHRoaXMucmVhZEFoZWFkID0gaGlnaFdhdGVyTWFyayA+IDAKICAgIHRoaXMuZXJyb3IgPSBudWxsCiAgICB0aGlzLnBpcGVsaW5lID0gbnVsbAogICAgdGhpcy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aFJlYWRhYmxlIHx8IGJ5dGVMZW5ndGggfHwgZGVmYXVsdEJ5dGVMZW5ndGgKICAgIHRoaXMubWFwID0gbWFwUmVhZGFibGUgfHwgbWFwCiAgICB0aGlzLnBpcGVUbyA9IG51bGwKICAgIHRoaXMuYWZ0ZXJSZWFkID0gYWZ0ZXJSZWFkLmJpbmQodGhpcykKICAgIHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljayA9IHVwZGF0ZVJlYWROVC5iaW5kKHRoaXMpCiAgfQoKICBnZXQgZW5kZWQgKCkgewogICAgcmV0dXJuICh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0RPTkUpICE9PSAwCiAgfQoKICBwaXBlIChwaXBlVG8sIGNiKSB7CiAgICBpZiAodGhpcy5waXBlVG8gIT09IG51bGwpIHRocm93IG5ldyBFcnJvcignQ2FuIG9ubHkgcGlwZSB0byBvbmUgZGVzdGluYXRpb24nKQogICAgaWYgKHR5cGVvZiBjYiAhPT0gJ2Z1bmN0aW9uJykgY2IgPSBudWxsCgogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfUElQRV9EUkFJTkVECiAgICB0aGlzLnBpcGVUbyA9IHBpcGVUbwogICAgdGhpcy5waXBlbGluZSA9IG5ldyBQaXBlbGluZSh0aGlzLnN0cmVhbSwgcGlwZVRvLCBjYikKCiAgICBpZiAoY2IpIHRoaXMuc3RyZWFtLm9uKCdlcnJvcicsIG5vb3ApIC8vIFdlIGFscmVhZHkgZXJyb3IgaGFuZGxlIHRoaXMgc28gc3VwcmVzcyBjcmFzaGVzCgogICAgaWYgKGlzU3RyZWFteChwaXBlVG8pKSB7CiAgICAgIHBpcGVUby5fd3JpdGFibGVTdGF0ZS5waXBlbGluZSA9IHRoaXMucGlwZWxpbmUKICAgICAgaWYgKGNiKSBwaXBlVG8ub24oJ2Vycm9yJywgbm9vcCkgLy8gV2UgYWxyZWFkeSBlcnJvciBoYW5kbGUgdGhpcyBzbyBzdXByZXNzIGNyYXNoZXMKICAgICAgcGlwZVRvLm9uKCdmaW5pc2gnLCB0aGlzLnBpcGVsaW5lLmZpbmlzaGVkLmJpbmQodGhpcy5waXBlbGluZSkpIC8vIFRPRE86IGp1c3QgY2FsbCBmaW5pc2hlZCBmcm9tIHBpcGVUbyBpdHNlbGYKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IG9uZXJyb3IgPSB0aGlzLnBpcGVsaW5lLmRvbmUuYmluZCh0aGlzLnBpcGVsaW5lLCBwaXBlVG8pCiAgICAgIGNvbnN0IG9uY2xvc2UgPSB0aGlzLnBpcGVsaW5lLmRvbmUuYmluZCh0aGlzLnBpcGVsaW5lLCBwaXBlVG8sIG51bGwpIC8vIG9uY2xvc2UgaGFzIGEgd2VpcmQgYm9vbCBhcmcKICAgICAgcGlwZVRvLm9uKCdlcnJvcicsIG9uZXJyb3IpCiAgICAgIHBpcGVUby5vbignY2xvc2UnLCBvbmNsb3NlKQogICAgICBwaXBlVG8ub24oJ2ZpbmlzaCcsIHRoaXMucGlwZWxpbmUuZmluaXNoZWQuYmluZCh0aGlzLnBpcGVsaW5lKSkKICAgIH0KCiAgICBwaXBlVG8ub24oJ2RyYWluJywgYWZ0ZXJEcmFpbi5iaW5kKHRoaXMpKQogICAgdGhpcy5zdHJlYW0uZW1pdCgncGlwaW5nJywgcGlwZVRvKQogICAgcGlwZVRvLmVtaXQoJ3BpcGUnLCB0aGlzLnN0cmVhbSkKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgaWYgKGRhdGEgPT09IG51bGwpIHsKICAgICAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gMAogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBSRUFEX0VORElORykgJiBSRUFEX05PTl9QUklNQVJZX0FORF9QVVNIRUQKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgaWYgKHRoaXMubWFwICE9PSBudWxsKSB7CiAgICAgIGRhdGEgPSB0aGlzLm1hcChkYXRhKQogICAgICBpZiAoZGF0YSA9PT0gbnVsbCkgewogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9QVVNIRUQKICAgICAgICByZXR1cm4gdGhpcy5idWZmZXJlZCA8IHRoaXMuaGlnaFdhdGVyTWFyawogICAgICB9CiAgICB9CgogICAgdGhpcy5idWZmZXJlZCArPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgIHRoaXMucXVldWUucHVzaChkYXRhKQoKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgPSAoc3RyZWFtLl9kdXBsZXhTdGF0ZSB8IFJFQURfUVVFVUVEKSAmIFJFQURfUFVTSEVECgogICAgcmV0dXJuIHRoaXMuYnVmZmVyZWQgPCB0aGlzLmhpZ2hXYXRlck1hcmsKICB9CgogIHNoaWZ0ICgpIHsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLnF1ZXVlLnNoaWZ0KCkKCiAgICB0aGlzLmJ1ZmZlcmVkIC09IHRoaXMuYnl0ZUxlbmd0aChkYXRhKQogICAgaWYgKHRoaXMuYnVmZmVyZWQgPT09IDApIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PVF9RVUVVRUQKICAgIHJldHVybiBkYXRhCiAgfQoKICB1bnNoaWZ0IChkYXRhKSB7CiAgICBjb25zdCBwZW5kaW5nID0gW3RoaXMubWFwICE9PSBudWxsID8gdGhpcy5tYXAoZGF0YSkgOiBkYXRhXQogICAgd2hpbGUgKHRoaXMuYnVmZmVyZWQgPiAwKSBwZW5kaW5nLnB1c2godGhpcy5zaGlmdCgpKQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGVuZGluZy5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgY29uc3QgZGF0YSA9IHBlbmRpbmdbaV0KICAgICAgdGhpcy5idWZmZXJlZCArPSB0aGlzLmJ5dGVMZW5ndGgoZGF0YSkKICAgICAgdGhpcy5xdWV1ZS5wdXNoKGRhdGEpCiAgICB9CgogICAgdGhpcy5wdXNoKHBlbmRpbmdbcGVuZGluZy5sZW5ndGggLSAxXSkKICB9CgogIHJlYWQgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1NUQVRVUykgPT09IFJFQURfUVVFVUVEKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnNoaWZ0KCkKICAgICAgaWYgKHRoaXMucGlwZVRvICE9PSBudWxsICYmIHRoaXMucGlwZVRvLndyaXRlKGRhdGEpID09PSBmYWxzZSkgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX1BJUEVfTk9UX0RSQUlORUQKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9FTUlUX0RBVEEpICE9PSAwKSBzdHJlYW0uZW1pdCgnZGF0YScsIGRhdGEpCiAgICAgIHJldHVybiBkYXRhCiAgICB9CgogICAgaWYgKHRoaXMucmVhZEFoZWFkID09PSBmYWxzZSkgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IFJFQURfUkVBRF9BSEVBRAogICAgICB0aGlzLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0KCiAgZHJhaW4gKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICB3aGlsZSAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1NUQVRVUykgPT09IFJFQURfUVVFVUVEICYmIChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9GTE9XSU5HKSAhPT0gMCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5zaGlmdCgpCiAgICAgIGlmICh0aGlzLnBpcGVUbyAhPT0gbnVsbCAmJiB0aGlzLnBpcGVUby53cml0ZShkYXRhKSA9PT0gZmFsc2UpIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9QSVBFX05PVF9EUkFJTkVECiAgICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRU1JVF9EQVRBKSAhPT0gMCkgc3RyZWFtLmVtaXQoJ2RhdGEnLCBkYXRhKQogICAgfQogIH0KCiAgdXBkYXRlICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1VQREFUSU5HCgogICAgZG8gewogICAgICB0aGlzLmRyYWluKCkKCiAgICAgIHdoaWxlICh0aGlzLmJ1ZmZlcmVkIDwgdGhpcy5oaWdoV2F0ZXJNYXJrICYmIChzdHJlYW0uX2R1cGxleFN0YXRlICYgU0hPVUxEX05PVF9SRUFEKSA9PT0gUkVBRF9SRUFEX0FIRUFEKSB7CiAgICAgICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX0FDVElWRV9BTkRfTkVFRFNfUFVTSAogICAgICAgIHN0cmVhbS5fcmVhZCh0aGlzLmFmdGVyUmVhZCkKICAgICAgICB0aGlzLmRyYWluKCkKICAgICAgfQoKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9SRUFEQUJMRV9TVEFUVVMpID09PSBSRUFEX0VNSVRfUkVBREFCTEVfQU5EX1FVRVVFRCkgewogICAgICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gUkVBRF9FTUlUVEVEX1JFQURBQkxFCiAgICAgICAgc3RyZWFtLmVtaXQoJ3JlYWRhYmxlJykKICAgICAgfQoKICAgICAgaWYgKChzdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9QUklNQVJZX0FORF9BQ1RJVkUpID09PSAwKSB0aGlzLnVwZGF0ZU5vblByaW1hcnkoKQogICAgfSB3aGlsZSAodGhpcy5jb250aW51ZVVwZGF0ZSgpID09PSB0cnVlKQoKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT1RfVVBEQVRJTkcKICB9CgogIHVwZGF0ZU5vblByaW1hcnkgKCkgewogICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0VORElOR19TVEFUVVMpID09PSBSRUFEX0VORElORykgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBSRUFEX0RPTkUpICYgUkVBRF9OT1RfRU5ESU5HCiAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKQogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBVVRPX0RFU1RST1kpID09PSBET05FKSBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IERFU1RST1lJTkcKICAgICAgaWYgKHRoaXMucGlwZVRvICE9PSBudWxsKSB0aGlzLnBpcGVUby5lbmQoKQogICAgfQoKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSA9PT0gREVTVFJPWUlORykgewogICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBQ1RJVkVfT1JfVElDS0lORykgPT09IDApIHsKICAgICAgICBzdHJlYW0uX2R1cGxleFN0YXRlIHw9IEFDVElWRQogICAgICAgIHN0cmVhbS5fZGVzdHJveShhZnRlckRlc3Ryb3kuYmluZCh0aGlzKSkKICAgICAgfQogICAgICByZXR1cm4KICAgIH0KCiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBJU19PUEVOSU5HKSA9PT0gT1BFTklORykgewogICAgICBzdHJlYW0uX2R1cGxleFN0YXRlID0gKHN0cmVhbS5fZHVwbGV4U3RhdGUgfCBBQ1RJVkUpICYgTk9UX09QRU5JTkcKICAgICAgc3RyZWFtLl9vcGVuKGFmdGVyT3Blbi5iaW5kKHRoaXMpKQogICAgfQogIH0KCiAgY29udGludWVVcGRhdGUgKCkgewogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX05FWFRfVElDSykgPT09IDApIHJldHVybiBmYWxzZQogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9UX05FWFRfVElDSwogICAgcmV0dXJuIHRydWUKICB9CgogIHVwZGF0ZUNhbGxiYWNrICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9VUERBVEVfU1lOQ19TVEFUVVMpID09PSBSRUFEX1BSSU1BUlkpIHRoaXMudXBkYXRlKCkKICAgIGVsc2UgdGhpcy51cGRhdGVOZXh0VGljaygpCiAgfQoKICB1cGRhdGVOZXh0VGlja0lmT3BlbiAoKSB7CiAgICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfTkVYVF9USUNLX09SX09QRU5JTkcpICE9PSAwKSByZXR1cm4KICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX05FWFRfVElDSwogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1VQREFUSU5HKSA9PT0gMCkgcW10KHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljaykKICB9CgogIHVwZGF0ZU5leHRUaWNrICgpIHsKICAgIGlmICgodGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICYgUkVBRF9ORVhUX1RJQ0spICE9PSAwKSByZXR1cm4KICAgIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX05FWFRfVElDSwogICAgaWYgKCh0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1VQREFUSU5HKSA9PT0gMCkgcW10KHRoaXMuYWZ0ZXJVcGRhdGVOZXh0VGljaykKICB9Cn0KCmNsYXNzIFRyYW5zZm9ybVN0YXRlIHsKICBjb25zdHJ1Y3RvciAoc3RyZWFtKSB7CiAgICB0aGlzLmRhdGEgPSBudWxsCiAgICB0aGlzLmFmdGVyVHJhbnNmb3JtID0gYWZ0ZXJUcmFuc2Zvcm0uYmluZChzdHJlYW0pCiAgICB0aGlzLmFmdGVyRmluYWwgPSBudWxsCiAgfQp9CgpjbGFzcyBQaXBlbGluZSB7CiAgY29uc3RydWN0b3IgKHNyYywgZHN0LCBjYikgewogICAgdGhpcy5mcm9tID0gc3JjCiAgICB0aGlzLnRvID0gZHN0CiAgICB0aGlzLmFmdGVyUGlwZSA9IGNiCiAgICB0aGlzLmVycm9yID0gbnVsbAogICAgdGhpcy5waXBlVG9GaW5pc2hlZCA9IGZhbHNlCiAgfQoKICBmaW5pc2hlZCAoKSB7CiAgICB0aGlzLnBpcGVUb0ZpbmlzaGVkID0gdHJ1ZQogIH0KCiAgZG9uZSAoc3RyZWFtLCBlcnIpIHsKICAgIGlmIChlcnIpIHRoaXMuZXJyb3IgPSBlcnIKCiAgICBpZiAoc3RyZWFtID09PSB0aGlzLnRvKSB7CiAgICAgIHRoaXMudG8gPSBudWxsCgogICAgICBpZiAodGhpcy5mcm9tICE9PSBudWxsKSB7CiAgICAgICAgaWYgKCh0aGlzLmZyb20uX2R1cGxleFN0YXRlICYgUkVBRF9ET05FKSA9PT0gMCB8fCAhdGhpcy5waXBlVG9GaW5pc2hlZCkgewogICAgICAgICAgdGhpcy5mcm9tLmRlc3Ryb3kodGhpcy5lcnJvciB8fCBuZXcgRXJyb3IoJ1dyaXRhYmxlIHN0cmVhbSBjbG9zZWQgcHJlbWF0dXJlbHknKSkKICAgICAgICB9CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3RyZWFtID09PSB0aGlzLmZyb20pIHsKICAgICAgdGhpcy5mcm9tID0gbnVsbAoKICAgICAgaWYgKHRoaXMudG8gIT09IG51bGwpIHsKICAgICAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX0RPTkUpID09PSAwKSB7CiAgICAgICAgICB0aGlzLnRvLmRlc3Ryb3kodGhpcy5lcnJvciB8fCBuZXcgRXJyb3IoJ1JlYWRhYmxlIHN0cmVhbSBjbG9zZWQgYmVmb3JlIGVuZGluZycpKQogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLmFmdGVyUGlwZSAhPT0gbnVsbCkgdGhpcy5hZnRlclBpcGUodGhpcy5lcnJvcikKICAgIHRoaXMudG8gPSB0aGlzLmZyb20gPSB0aGlzLmFmdGVyUGlwZSA9IG51bGwKICB9Cn0KCmZ1bmN0aW9uIGFmdGVyRHJhaW4gKCkgewogIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1BJUEVfRFJBSU5FRAogIHRoaXMudXBkYXRlQ2FsbGJhY2soKQp9CgpmdW5jdGlvbiBhZnRlckZpbmFsIChlcnIpIHsKICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQogIGlmIChlcnIpIHN0cmVhbS5kZXN0cm95KGVycikKICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBERVNUUk9ZX1NUQVRVUykgPT09IDApIHsKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfRE9ORQogICAgc3RyZWFtLmVtaXQoJ2ZpbmlzaCcpCiAgfQogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIEFVVE9fREVTVFJPWSkgPT09IERPTkUpIHsKICAgIHN0cmVhbS5fZHVwbGV4U3RhdGUgfD0gREVTVFJPWUlORwogIH0KCiAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9OT1RfRklOSVNISU5HCgogIC8vIG5vIG5lZWQgdG8gd2FpdCB0aGUgZXh0cmEgdGljayBoZXJlLCBzbyB3ZSBzaG9ydCBjaXJjdWl0IHRoYXQKICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9VUERBVElORykgPT09IDApIHRoaXMudXBkYXRlKCkKICBlbHNlIHRoaXMudXBkYXRlTmV4dFRpY2soKQp9CgpmdW5jdGlvbiBhZnRlckRlc3Ryb3kgKGVycikgewogIGNvbnN0IHN0cmVhbSA9IHRoaXMuc3RyZWFtCgogIGlmICghZXJyICYmIHRoaXMuZXJyb3IgIT09IFNUUkVBTV9ERVNUUk9ZRUQpIGVyciA9IHRoaXMuZXJyb3IKICBpZiAoZXJyKSBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpCiAgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBERVNUUk9ZRUQKICBzdHJlYW0uZW1pdCgnY2xvc2UnKQoKICBjb25zdCBycyA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZQogIGNvbnN0IHdzID0gc3RyZWFtLl93cml0YWJsZVN0YXRlCgogIGlmIChycyAhPT0gbnVsbCAmJiBycy5waXBlbGluZSAhPT0gbnVsbCkgcnMucGlwZWxpbmUuZG9uZShzdHJlYW0sIGVycikKCiAgaWYgKHdzICE9PSBudWxsKSB7CiAgICB3aGlsZSAod3MuZHJhaW5zICE9PSBudWxsICYmIHdzLmRyYWlucy5sZW5ndGggPiAwKSB3cy5kcmFpbnMuc2hpZnQoKS5yZXNvbHZlKGZhbHNlKQogICAgaWYgKHdzLnBpcGVsaW5lICE9PSBudWxsKSB3cy5waXBlbGluZS5kb25lKHN0cmVhbSwgZXJyKQogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJXcml0ZSAoZXJyKSB7CiAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW0KCiAgaWYgKGVycikgc3RyZWFtLmRlc3Ryb3koZXJyKQogIHN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX0FDVElWRQoKICBpZiAodGhpcy5kcmFpbnMgIT09IG51bGwpIHRpY2tEcmFpbnModGhpcy5kcmFpbnMpCgogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX0RSQUlOX1NUQVRVUykgPT09IFdSSVRFX1VORFJBSU5FRCkgewogICAgc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBXUklURV9EUkFJTkVECiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBXUklURV9FTUlUX0RSQUlOKSA9PT0gV1JJVEVfRU1JVF9EUkFJTikgewogICAgICBzdHJlYW0uZW1pdCgnZHJhaW4nKQogICAgfQogIH0KCiAgdGhpcy51cGRhdGVDYWxsYmFjaygpCn0KCmZ1bmN0aW9uIGFmdGVyUmVhZCAoZXJyKSB7CiAgaWYgKGVycikgdGhpcy5zdHJlYW0uZGVzdHJveShlcnIpCiAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFJFQURfTk9UX0FDVElWRQogIGlmICh0aGlzLnJlYWRBaGVhZCA9PT0gZmFsc2UgJiYgKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfUkVTVU1FRCkgPT09IDApIHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PX1JFQURfQUhFQUQKICB0aGlzLnVwZGF0ZUNhbGxiYWNrKCkKfQoKZnVuY3Rpb24gdXBkYXRlUmVhZE5UICgpIHsKICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfVVBEQVRJTkcpID09PSAwKSB7CiAgICB0aGlzLnN0cmVhbS5fZHVwbGV4U3RhdGUgJj0gUkVBRF9OT1RfTkVYVF9USUNLCiAgICB0aGlzLnVwZGF0ZSgpCiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVXcml0ZU5UICgpIHsKICBpZiAoKHRoaXMuc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1VQREFUSU5HKSA9PT0gMCkgewogICAgdGhpcy5zdHJlYW0uX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9ORVhUX1RJQ0sKICAgIHRoaXMudXBkYXRlKCkKICB9Cn0KCmZ1bmN0aW9uIHRpY2tEcmFpbnMgKGRyYWlucykgewogIGZvciAobGV0IGkgPSAwOyBpIDwgZHJhaW5zLmxlbmd0aDsgaSsrKSB7CiAgICAvLyBkcmFpbnMud3JpdGVzIGFyZSBtb25vdG9uaWMsIHNvIGlmIG9uZSBpcyAwIGl0cyBhbHdheXMgdGhlIGZpcnN0IG9uZQogICAgaWYgKC0tZHJhaW5zW2ldLndyaXRlcyA9PT0gMCkgewogICAgICBkcmFpbnMuc2hpZnQoKS5yZXNvbHZlKHRydWUpCiAgICAgIGktLQogICAgfQogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJPcGVuIChlcnIpIHsKICBjb25zdCBzdHJlYW0gPSB0aGlzLnN0cmVhbQoKICBpZiAoZXJyKSBzdHJlYW0uZGVzdHJveShlcnIpCgogIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lJTkcpID09PSAwKSB7CiAgICBpZiAoKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBSRUFEX1BSSU1BUllfU1RBVFVTKSA9PT0gMCkgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBSRUFEX1BSSU1BUlkKICAgIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFdSSVRFX1BSSU1BUllfU1RBVFVTKSA9PT0gMCkgc3RyZWFtLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9QUklNQVJZCiAgICBzdHJlYW0uZW1pdCgnb3BlbicpCiAgfQoKICBzdHJlYW0uX2R1cGxleFN0YXRlICY9IE5PVF9BQ1RJVkUKCiAgaWYgKHN0cmVhbS5fd3JpdGFibGVTdGF0ZSAhPT0gbnVsbCkgewogICAgc3RyZWFtLl93cml0YWJsZVN0YXRlLnVwZGF0ZUNhbGxiYWNrKCkKICB9CgogIGlmIChzdHJlYW0uX3JlYWRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgIHN0cmVhbS5fcmVhZGFibGVTdGF0ZS51cGRhdGVDYWxsYmFjaygpCiAgfQp9CgpmdW5jdGlvbiBhZnRlclRyYW5zZm9ybSAoZXJyLCBkYXRhKSB7CiAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCAmJiBkYXRhICE9PSBudWxsKSB0aGlzLnB1c2goZGF0YSkKICB0aGlzLl93cml0YWJsZVN0YXRlLmFmdGVyV3JpdGUoZXJyKQp9CgpmdW5jdGlvbiBuZXdMaXN0ZW5lciAobmFtZSkgewogIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICBpZiAobmFtZSA9PT0gJ2RhdGEnKSB7CiAgICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IChSRUFEX0VNSVRfREFUQSB8IFJFQURfUkVTVU1FRF9SRUFEX0FIRUFEKQogICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICAgIGlmIChuYW1lID09PSAncmVhZGFibGUnKSB7CiAgICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFJFQURfRU1JVF9SRUFEQUJMRQogICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICB9CgogIGlmICh0aGlzLl93cml0YWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICBpZiAobmFtZSA9PT0gJ2RyYWluJykgewogICAgICB0aGlzLl9kdXBsZXhTdGF0ZSB8PSBXUklURV9FTUlUX0RSQUlOCiAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgfQogIH0KfQoKY2xhc3MgU3RyZWFtIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgc3VwZXIoKQoKICAgIHRoaXMuX2R1cGxleFN0YXRlID0gMAogICAgdGhpcy5fcmVhZGFibGVTdGF0ZSA9IG51bGwKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBudWxsCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMub3BlbikgdGhpcy5fb3BlbiA9IG9wdHMub3BlbgogICAgICBpZiAob3B0cy5kZXN0cm95KSB0aGlzLl9kZXN0cm95ID0gb3B0cy5kZXN0cm95CiAgICAgIGlmIChvcHRzLnByZWRlc3Ryb3kpIHRoaXMuX3ByZWRlc3Ryb3kgPSBvcHRzLnByZWRlc3Ryb3kKICAgICAgaWYgKG9wdHMuc2lnbmFsKSB7CiAgICAgICAgb3B0cy5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBhYm9ydC5iaW5kKHRoaXMpKQogICAgICB9CiAgICB9CgogICAgdGhpcy5vbignbmV3TGlzdGVuZXInLCBuZXdMaXN0ZW5lcikKICB9CgogIF9vcGVuIChjYikgewogICAgY2IobnVsbCkKICB9CgogIF9kZXN0cm95IChjYikgewogICAgY2IobnVsbCkKICB9CgogIF9wcmVkZXN0cm95ICgpIHsKICAgIC8vIGRvZXMgbm90aGluZwogIH0KCiAgZ2V0IHJlYWRhYmxlICgpIHsKICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsID8gdHJ1ZSA6IHVuZGVmaW5lZAogIH0KCiAgZ2V0IHdyaXRhYmxlICgpIHsKICAgIHJldHVybiB0aGlzLl93cml0YWJsZVN0YXRlICE9PSBudWxsID8gdHJ1ZSA6IHVuZGVmaW5lZAogIH0KCiAgZ2V0IGRlc3Ryb3llZCAoKSB7CiAgICByZXR1cm4gKHRoaXMuX2R1cGxleFN0YXRlICYgREVTVFJPWUVEKSAhPT0gMAogIH0KCiAgZ2V0IGRlc3Ryb3lpbmcgKCkgewogICAgcmV0dXJuICh0aGlzLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lfU1RBVFVTKSAhPT0gMAogIH0KCiAgZGVzdHJveSAoZXJyKSB7CiAgICBpZiAoKHRoaXMuX2R1cGxleFN0YXRlICYgREVTVFJPWV9TVEFUVVMpID09PSAwKSB7CiAgICAgIGlmICghZXJyKSBlcnIgPSBTVFJFQU1fREVTVFJPWUVECiAgICAgIHRoaXMuX2R1cGxleFN0YXRlID0gKHRoaXMuX2R1cGxleFN0YXRlIHwgREVTVFJPWUlORykgJiBOT05fUFJJTUFSWQoKICAgICAgaWYgKHRoaXMuX3JlYWRhYmxlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLmhpZ2hXYXRlck1hcmsgPSAwCiAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lcnJvciA9IGVycgogICAgICB9CiAgICAgIGlmICh0aGlzLl93cml0YWJsZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrID0gMAogICAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuZXJyb3IgPSBlcnIKICAgICAgfQoKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gUFJFREVTVFJPWUlORwogICAgICB0aGlzLl9wcmVkZXN0cm95KCkKICAgICAgdGhpcy5fZHVwbGV4U3RhdGUgJj0gTk9UX1BSRURFU1RST1lJTkcKCiAgICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlICE9PSBudWxsKSB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgICAgaWYgKHRoaXMuX3dyaXRhYmxlU3RhdGUgIT09IG51bGwpIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgfQogIH0KfQoKY2xhc3MgUmVhZGFibGUgZXh0ZW5kcyBTdHJlYW0gewogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IE9QRU5JTkcgfCBXUklURV9ET05FIHwgUkVBRF9SRUFEX0FIRUFECiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlID0gbmV3IFJlYWRhYmxlU3RhdGUodGhpcywgb3B0cykKCiAgICBpZiAob3B0cykgewogICAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZS5yZWFkQWhlYWQgPT09IGZhbHNlKSB0aGlzLl9kdXBsZXhTdGF0ZSAmPSBSRUFEX05PX1JFQURfQUhFQUQKICAgICAgaWYgKG9wdHMucmVhZCkgdGhpcy5fcmVhZCA9IG9wdHMucmVhZAogICAgICBpZiAob3B0cy5lYWdlck9wZW4pIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgICBpZiAob3B0cy5lbmNvZGluZykgdGhpcy5zZXRFbmNvZGluZyhvcHRzLmVuY29kaW5nKQogICAgfQogIH0KCiAgc2V0RW5jb2RpbmcgKGVuY29kaW5nKSB7CiAgICBjb25zdCBkZWMgPSBuZXcgVGV4dERlY29kZXIoZW5jb2RpbmcpCiAgICBjb25zdCBtYXAgPSB0aGlzLl9yZWFkYWJsZVN0YXRlLm1hcCB8fCBlY2hvCiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLm1hcCA9IG1hcE9yU2tpcAogICAgcmV0dXJuIHRoaXMKCiAgICBmdW5jdGlvbiBtYXBPclNraXAgKGRhdGEpIHsKICAgICAgY29uc3QgbmV4dCA9IGRlYy5wdXNoKGRhdGEpCiAgICAgIHJldHVybiBuZXh0ID09PSAnJyAmJiAoZGF0YS5ieXRlTGVuZ3RoICE9PSAwIHx8IGRlYy5yZW1haW5pbmcgPiAwKSA/IG51bGwgOiBtYXAobmV4dCkKICAgIH0KICB9CgogIF9yZWFkIChjYikgewogICAgY2IobnVsbCkKICB9CgogIHBpcGUgKGRlc3QsIGNiKSB7CiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUucGlwZShkZXN0LCBjYikKICAgIHJldHVybiBkZXN0CiAgfQoKICByZWFkICgpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUucmVhZCgpCiAgfQoKICBwdXNoIChkYXRhKSB7CiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrSWZPcGVuKCkKICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlLnB1c2goZGF0YSkKICB9CgogIHVuc2hpZnQgKGRhdGEpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2tJZk9wZW4oKQogICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUudW5zaGlmdChkYXRhKQogIH0KCiAgcmVzdW1lICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFJFQURfUkVTVU1FRF9SRUFEX0FIRUFECiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHJldHVybiB0aGlzCiAgfQoKICBwYXVzZSAoKSB7CiAgICB0aGlzLl9kdXBsZXhTdGF0ZSAmPSAodGhpcy5fcmVhZGFibGVTdGF0ZS5yZWFkQWhlYWQgPT09IGZhbHNlID8gUkVBRF9QQVVTRURfTk9fUkVBRF9BSEVBRCA6IFJFQURfUEFVU0VEKQogICAgcmV0dXJuIHRoaXMKICB9CgogIHN0YXRpYyBfZnJvbUFzeW5jSXRlcmF0b3IgKGl0ZSwgb3B0cykgewogICAgbGV0IGRlc3Ryb3kKCiAgICBjb25zdCBycyA9IG5ldyBSZWFkYWJsZSh7CiAgICAgIC4uLm9wdHMsCiAgICAgIHJlYWQgKGNiKSB7CiAgICAgICAgaXRlLm5leHQoKS50aGVuKHB1c2gpLnRoZW4oY2IuYmluZChudWxsLCBudWxsKSkuY2F0Y2goY2IpCiAgICAgIH0sCiAgICAgIHByZWRlc3Ryb3kgKCkgewogICAgICAgIGRlc3Ryb3kgPSBpdGUucmV0dXJuKCkKICAgICAgfSwKICAgICAgZGVzdHJveSAoY2IpIHsKICAgICAgICBpZiAoIWRlc3Ryb3kpIHJldHVybiBjYihudWxsKQogICAgICAgIGRlc3Ryb3kudGhlbihjYi5iaW5kKG51bGwsIG51bGwpKS5jYXRjaChjYikKICAgICAgfQogICAgfSkKCiAgICByZXR1cm4gcnMKCiAgICBmdW5jdGlvbiBwdXNoIChkYXRhKSB7CiAgICAgIGlmIChkYXRhLmRvbmUpIHJzLnB1c2gobnVsbCkKICAgICAgZWxzZSBycy5wdXNoKGRhdGEudmFsdWUpCiAgICB9CiAgfQoKICBzdGF0aWMgZnJvbSAoZGF0YSwgb3B0cykgewogICAgaWYgKGlzUmVhZFN0cmVhbXgoZGF0YSkpIHJldHVybiBkYXRhCiAgICBpZiAoZGF0YVthc3luY0l0ZXJhdG9yXSkgcmV0dXJuIHRoaXMuX2Zyb21Bc3luY0l0ZXJhdG9yKGRhdGFbYXN5bmNJdGVyYXRvcl0oKSwgb3B0cykKICAgIGlmICghQXJyYXkuaXNBcnJheShkYXRhKSkgZGF0YSA9IGRhdGEgPT09IHVuZGVmaW5lZCA/IFtdIDogW2RhdGFdCgogICAgbGV0IGkgPSAwCiAgICByZXR1cm4gbmV3IFJlYWRhYmxlKHsKICAgICAgLi4ub3B0cywKICAgICAgcmVhZCAoY2IpIHsKICAgICAgICB0aGlzLnB1c2goaSA9PT0gZGF0YS5sZW5ndGggPyBudWxsIDogZGF0YVtpKytdKQogICAgICAgIGNiKG51bGwpCiAgICAgIH0KICAgIH0pCiAgfQoKICBzdGF0aWMgaXNCYWNrcHJlc3N1cmVkIChycykgewogICAgcmV0dXJuIChycy5fZHVwbGV4U3RhdGUgJiBSRUFEX0JBQ0tQUkVTU1VSRV9TVEFUVVMpICE9PSAwIHx8IHJzLl9yZWFkYWJsZVN0YXRlLmJ1ZmZlcmVkID49IHJzLl9yZWFkYWJsZVN0YXRlLmhpZ2hXYXRlck1hcmsKICB9CgogIHN0YXRpYyBpc1BhdXNlZCAocnMpIHsKICAgIHJldHVybiAocnMuX2R1cGxleFN0YXRlICYgUkVBRF9SRVNVTUVEKSA9PT0gMAogIH0KCiAgW2FzeW5jSXRlcmF0b3JdICgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMKCiAgICBsZXQgZXJyb3IgPSBudWxsCiAgICBsZXQgcHJvbWlzZVJlc29sdmUgPSBudWxsCiAgICBsZXQgcHJvbWlzZVJlamVjdCA9IG51bGwKCiAgICB0aGlzLm9uKCdlcnJvcicsIChlcnIpID0+IHsgZXJyb3IgPSBlcnIgfSkKICAgIHRoaXMub24oJ3JlYWRhYmxlJywgb25yZWFkYWJsZSkKICAgIHRoaXMub24oJ2Nsb3NlJywgb25jbG9zZSkKCiAgICByZXR1cm4gewogICAgICBbYXN5bmNJdGVyYXRvcl0gKCkgewogICAgICAgIHJldHVybiB0aGlzCiAgICAgIH0sCiAgICAgIG5leHQgKCkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBwcm9taXNlUmVzb2x2ZSA9IHJlc29sdmUKICAgICAgICAgIHByb21pc2VSZWplY3QgPSByZWplY3QKICAgICAgICAgIGNvbnN0IGRhdGEgPSBzdHJlYW0ucmVhZCgpCiAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkgb25kYXRhKGRhdGEpCiAgICAgICAgICBlbHNlIGlmICgoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIERFU1RST1lFRCkgIT09IDApIG9uZGF0YShudWxsKQogICAgICAgIH0pCiAgICAgIH0sCiAgICAgIHJldHVybiAoKSB7CiAgICAgICAgcmV0dXJuIGRlc3Ryb3kobnVsbCkKICAgICAgfSwKICAgICAgdGhyb3cgKGVycikgewogICAgICAgIHJldHVybiBkZXN0cm95KGVycikKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG9ucmVhZGFibGUgKCkgewogICAgICBpZiAocHJvbWlzZVJlc29sdmUgIT09IG51bGwpIG9uZGF0YShzdHJlYW0ucmVhZCgpKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UgKCkgewogICAgICBpZiAocHJvbWlzZVJlc29sdmUgIT09IG51bGwpIG9uZGF0YShudWxsKQogICAgfQoKICAgIGZ1bmN0aW9uIG9uZGF0YSAoZGF0YSkgewogICAgICBpZiAocHJvbWlzZVJlamVjdCA9PT0gbnVsbCkgcmV0dXJuCiAgICAgIGlmIChlcnJvcikgcHJvbWlzZVJlamVjdChlcnJvcikKICAgICAgZWxzZSBpZiAoZGF0YSA9PT0gbnVsbCAmJiAoc3RyZWFtLl9kdXBsZXhTdGF0ZSAmIFJFQURfRE9ORSkgPT09IDApIHByb21pc2VSZWplY3QoU1RSRUFNX0RFU1RST1lFRCkKICAgICAgZWxzZSBwcm9taXNlUmVzb2x2ZSh7IHZhbHVlOiBkYXRhLCBkb25lOiBkYXRhID09PSBudWxsIH0pCiAgICAgIHByb21pc2VSZWplY3QgPSBwcm9taXNlUmVzb2x2ZSA9IG51bGwKICAgIH0KCiAgICBmdW5jdGlvbiBkZXN0cm95IChlcnIpIHsKICAgICAgc3RyZWFtLmRlc3Ryb3koZXJyKQogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGlmIChzdHJlYW0uX2R1cGxleFN0YXRlICYgREVTVFJPWUVEKSByZXR1cm4gcmVzb2x2ZSh7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSkKICAgICAgICBzdHJlYW0ub25jZSgnY2xvc2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKQogICAgICAgICAgZWxzZSByZXNvbHZlKHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9KQogICAgICAgIH0pCiAgICAgIH0pCiAgICB9CiAgfQp9CgpjbGFzcyBXcml0YWJsZSBleHRlbmRzIFN0cmVhbSB7CiAgY29uc3RydWN0b3IgKG9wdHMpIHsKICAgIHN1cGVyKG9wdHMpCgogICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gT1BFTklORyB8IFJFQURfRE9ORQogICAgdGhpcy5fd3JpdGFibGVTdGF0ZSA9IG5ldyBXcml0YWJsZVN0YXRlKHRoaXMsIG9wdHMpCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMud3JpdGV2KSB0aGlzLl93cml0ZXYgPSBvcHRzLndyaXRldgogICAgICBpZiAob3B0cy53cml0ZSkgdGhpcy5fd3JpdGUgPSBvcHRzLndyaXRlCiAgICAgIGlmIChvcHRzLmZpbmFsKSB0aGlzLl9maW5hbCA9IG9wdHMuZmluYWwKICAgICAgaWYgKG9wdHMuZWFnZXJPcGVuKSB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIH0KICB9CgogIGNvcmsgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgfD0gV1JJVEVfQ09SS0VECiAgfQoKICB1bmNvcmsgKCkgewogICAgdGhpcy5fZHVwbGV4U3RhdGUgJj0gV1JJVEVfTk9UX0NPUktFRAogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgfQoKICBfd3JpdGV2IChiYXRjaCwgY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfd3JpdGUgKGRhdGEsIGNiKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLmF1dG9CYXRjaChkYXRhLCBjYikKICB9CgogIF9maW5hbCAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBzdGF0aWMgaXNCYWNrcHJlc3N1cmVkICh3cykgewogICAgcmV0dXJuICh3cy5fZHVwbGV4U3RhdGUgJiBXUklURV9CQUNLUFJFU1NVUkVfU1RBVFVTKSAhPT0gMAogIH0KCiAgc3RhdGljIGRyYWluZWQgKHdzKSB7CiAgICBpZiAod3MuZGVzdHJveWVkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKQogICAgY29uc3Qgc3RhdGUgPSB3cy5fd3JpdGFibGVTdGF0ZQogICAgY29uc3QgcGVuZGluZyA9IChpc1dyaXRldih3cykgPyBNYXRoLm1pbigxLCBzdGF0ZS5xdWV1ZS5sZW5ndGgpIDogc3RhdGUucXVldWUubGVuZ3RoKQogICAgY29uc3Qgd3JpdGVzID0gcGVuZGluZyArICgod3MuX2R1cGxleFN0YXRlICYgV1JJVEVfV1JJVElORykgPyAxIDogMCkKICAgIGlmICh3cml0ZXMgPT09IDApIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSkKICAgIGlmIChzdGF0ZS5kcmFpbnMgPT09IG51bGwpIHN0YXRlLmRyYWlucyA9IFtdCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgc3RhdGUuZHJhaW5zLnB1c2goeyB3cml0ZXMsIHJlc29sdmUgfSkKICAgIH0pCiAgfQoKICB3cml0ZSAoZGF0YSkgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS51cGRhdGVOZXh0VGljaygpCiAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZS5wdXNoKGRhdGEpCiAgfQoKICBlbmQgKGRhdGEpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5lbmQoZGF0YSkKICAgIHJldHVybiB0aGlzCiAgfQp9CgpjbGFzcyBEdXBsZXggZXh0ZW5kcyBSZWFkYWJsZSB7IC8vIGFuZCBXcml0YWJsZQogIGNvbnN0cnVjdG9yIChvcHRzKSB7CiAgICBzdXBlcihvcHRzKQoKICAgIHRoaXMuX2R1cGxleFN0YXRlID0gT1BFTklORyB8ICh0aGlzLl9kdXBsZXhTdGF0ZSAmIFJFQURfUkVBRF9BSEVBRCkKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBuZXcgV3JpdGFibGVTdGF0ZSh0aGlzLCBvcHRzKQoKICAgIGlmIChvcHRzKSB7CiAgICAgIGlmIChvcHRzLndyaXRldikgdGhpcy5fd3JpdGV2ID0gb3B0cy53cml0ZXYKICAgICAgaWYgKG9wdHMud3JpdGUpIHRoaXMuX3dyaXRlID0gb3B0cy53cml0ZQogICAgICBpZiAob3B0cy5maW5hbCkgdGhpcy5fZmluYWwgPSBvcHRzLmZpbmFsCiAgICB9CiAgfQoKICBjb3JrICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlIHw9IFdSSVRFX0NPUktFRAogIH0KCiAgdW5jb3JrICgpIHsKICAgIHRoaXMuX2R1cGxleFN0YXRlICY9IFdSSVRFX05PVF9DT1JLRUQKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogIH0KCiAgX3dyaXRldiAoYmF0Y2gsIGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgX3dyaXRlIChkYXRhLCBjYikgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5hdXRvQmF0Y2goZGF0YSwgY2IpCiAgfQoKICBfZmluYWwgKGNiKSB7CiAgICBjYihudWxsKQogIH0KCiAgd3JpdGUgKGRhdGEpIHsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUudXBkYXRlTmV4dFRpY2soKQogICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlU3RhdGUucHVzaChkYXRhKQogIH0KCiAgZW5kIChkYXRhKSB7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLnVwZGF0ZU5leHRUaWNrKCkKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuZW5kKGRhdGEpCiAgICByZXR1cm4gdGhpcwogIH0KfQoKY2xhc3MgVHJhbnNmb3JtIGV4dGVuZHMgRHVwbGV4IHsKICBjb25zdHJ1Y3RvciAob3B0cykgewogICAgc3VwZXIob3B0cykKICAgIHRoaXMuX3RyYW5zZm9ybVN0YXRlID0gbmV3IFRyYW5zZm9ybVN0YXRlKHRoaXMpCgogICAgaWYgKG9wdHMpIHsKICAgICAgaWYgKG9wdHMudHJhbnNmb3JtKSB0aGlzLl90cmFuc2Zvcm0gPSBvcHRzLnRyYW5zZm9ybQogICAgICBpZiAob3B0cy5mbHVzaCkgdGhpcy5fZmx1c2ggPSBvcHRzLmZsdXNoCiAgICB9CiAgfQoKICBfd3JpdGUgKGRhdGEsIGNiKSB7CiAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZS5idWZmZXJlZCA+PSB0aGlzLl9yZWFkYWJsZVN0YXRlLmhpZ2hXYXRlck1hcmspIHsKICAgICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSA9IGRhdGEKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3RyYW5zZm9ybShkYXRhLCB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlclRyYW5zZm9ybSkKICAgIH0KICB9CgogIF9yZWFkIChjYikgewogICAgaWYgKHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEgIT09IG51bGwpIHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuX3RyYW5zZm9ybVN0YXRlLmRhdGEKICAgICAgdGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSA9IG51bGwKICAgICAgY2IobnVsbCkKICAgICAgdGhpcy5fdHJhbnNmb3JtKGRhdGEsIHRoaXMuX3RyYW5zZm9ybVN0YXRlLmFmdGVyVHJhbnNmb3JtKQogICAgfSBlbHNlIHsKICAgICAgY2IobnVsbCkKICAgIH0KICB9CgogIGRlc3Ryb3kgKGVycikgewogICAgc3VwZXIuZGVzdHJveShlcnIpCiAgICBpZiAodGhpcy5fdHJhbnNmb3JtU3RhdGUuZGF0YSAhPT0gbnVsbCkgewogICAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5kYXRhID0gbnVsbAogICAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlclRyYW5zZm9ybSgpCiAgICB9CiAgfQoKICBfdHJhbnNmb3JtIChkYXRhLCBjYikgewogICAgY2IobnVsbCwgZGF0YSkKICB9CgogIF9mbHVzaCAoY2IpIHsKICAgIGNiKG51bGwpCiAgfQoKICBfZmluYWwgKGNiKSB7CiAgICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5hZnRlckZpbmFsID0gY2IKICAgIHRoaXMuX2ZsdXNoKHRyYW5zZm9ybUFmdGVyRmx1c2guYmluZCh0aGlzKSkKICB9Cn0KCmNsYXNzIFBhc3NUaHJvdWdoIGV4dGVuZHMgVHJhbnNmb3JtIHt9CgpmdW5jdGlvbiB0cmFuc2Zvcm1BZnRlckZsdXNoIChlcnIsIGRhdGEpIHsKICBjb25zdCBjYiA9IHRoaXMuX3RyYW5zZm9ybVN0YXRlLmFmdGVyRmluYWwKICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKQogIGlmIChkYXRhICE9PSBudWxsICYmIGRhdGEgIT09IHVuZGVmaW5lZCkgdGhpcy5wdXNoKGRhdGEpCiAgdGhpcy5wdXNoKG51bGwpCiAgY2IobnVsbCkKfQoKZnVuY3Rpb24gcGlwZWxpbmVQcm9taXNlICguLi5zdHJlYW1zKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIHJldHVybiBwaXBlbGluZSguLi5zdHJlYW1zLCAoZXJyKSA9PiB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKQogICAgICByZXNvbHZlKCkKICAgIH0pCiAgfSkKfQoKZnVuY3Rpb24gcGlwZWxpbmUgKHN0cmVhbSwgLi4uc3RyZWFtcykgewogIGNvbnN0IGFsbCA9IEFycmF5LmlzQXJyYXkoc3RyZWFtKSA/IFsuLi5zdHJlYW0sIC4uLnN0cmVhbXNdIDogW3N0cmVhbSwgLi4uc3RyZWFtc10KICBjb25zdCBkb25lID0gKGFsbC5sZW5ndGggJiYgdHlwZW9mIGFsbFthbGwubGVuZ3RoIC0gMV0gPT09ICdmdW5jdGlvbicpID8gYWxsLnBvcCgpIDogbnVsbAoKICBpZiAoYWxsLmxlbmd0aCA8IDIpIHRocm93IG5ldyBFcnJvcignUGlwZWxpbmUgcmVxdWlyZXMgYXQgbGVhc3QgMiBzdHJlYW1zJykKCiAgbGV0IHNyYyA9IGFsbFswXQogIGxldCBkZXN0ID0gbnVsbAogIGxldCBlcnJvciA9IG51bGwKCiAgZm9yIChsZXQgaSA9IDE7IGkgPCBhbGwubGVuZ3RoOyBpKyspIHsKICAgIGRlc3QgPSBhbGxbaV0KCiAgICBpZiAoaXNTdHJlYW14KHNyYykpIHsKICAgICAgc3JjLnBpcGUoZGVzdCwgb25lcnJvcikKICAgIH0gZWxzZSB7CiAgICAgIGVycm9ySGFuZGxlKHNyYywgdHJ1ZSwgaSA+IDEsIG9uZXJyb3IpCiAgICAgIHNyYy5waXBlKGRlc3QpCiAgICB9CgogICAgc3JjID0gZGVzdAogIH0KCiAgaWYgKGRvbmUpIHsKICAgIGxldCBmaW4gPSBmYWxzZQoKICAgIGNvbnN0IGF1dG9EZXN0cm95ID0gaXNTdHJlYW14KGRlc3QpIHx8ICEhKGRlc3QuX3dyaXRhYmxlU3RhdGUgJiYgZGVzdC5fd3JpdGFibGVTdGF0ZS5hdXRvRGVzdHJveSkKCiAgICBkZXN0Lm9uKCdlcnJvcicsIChlcnIpID0+IHsKICAgICAgaWYgKGVycm9yID09PSBudWxsKSBlcnJvciA9IGVycgogICAgfSkKCiAgICBkZXN0Lm9uKCdmaW5pc2gnLCAoKSA9PiB7CiAgICAgIGZpbiA9IHRydWUKICAgICAgaWYgKCFhdXRvRGVzdHJveSkgZG9uZShlcnJvcikKICAgIH0pCgogICAgaWYgKGF1dG9EZXN0cm95KSB7CiAgICAgIGRlc3Qub24oJ2Nsb3NlJywgKCkgPT4gZG9uZShlcnJvciB8fCAoZmluID8gbnVsbCA6IFBSRU1BVFVSRV9DTE9TRSkpKQogICAgfQogIH0KCiAgcmV0dXJuIGRlc3QKCiAgZnVuY3Rpb24gZXJyb3JIYW5kbGUgKHMsIHJkLCB3ciwgb25lcnJvcikgewogICAgcy5vbignZXJyb3InLCBvbmVycm9yKQogICAgcy5vbignY2xvc2UnLCBvbmNsb3NlKQoKICAgIGZ1bmN0aW9uIG9uY2xvc2UgKCkgewogICAgICBpZiAocmQgJiYgcy5fcmVhZGFibGVTdGF0ZSAmJiAhcy5fcmVhZGFibGVTdGF0ZS5lbmRlZCkgcmV0dXJuIG9uZXJyb3IoUFJFTUFUVVJFX0NMT1NFKQogICAgICBpZiAod3IgJiYgcy5fd3JpdGFibGVTdGF0ZSAmJiAhcy5fd3JpdGFibGVTdGF0ZS5lbmRlZCkgcmV0dXJuIG9uZXJyb3IoUFJFTUFUVVJFX0NMT1NFKQogICAgfQogIH0KCiAgZnVuY3Rpb24gb25lcnJvciAoZXJyKSB7CiAgICBpZiAoIWVyciB8fCBlcnJvcikgcmV0dXJuCiAgICBlcnJvciA9IGVycgoKICAgIGZvciAoY29uc3QgcyBvZiBhbGwpIHsKICAgICAgcy5kZXN0cm95KGVycikKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGVjaG8gKHMpIHsKICByZXR1cm4gcwp9CgpmdW5jdGlvbiBpc1N0cmVhbSAoc3RyZWFtKSB7CiAgcmV0dXJuICEhc3RyZWFtLl9yZWFkYWJsZVN0YXRlIHx8ICEhc3RyZWFtLl93cml0YWJsZVN0YXRlCn0KCmZ1bmN0aW9uIGlzU3RyZWFteCAoc3RyZWFtKSB7CiAgcmV0dXJuIHR5cGVvZiBzdHJlYW0uX2R1cGxleFN0YXRlID09PSAnbnVtYmVyJyAmJiBpc1N0cmVhbShzdHJlYW0pCn0KCmZ1bmN0aW9uIGlzRW5kZWQgKHN0cmVhbSkgewogIHJldHVybiAhIXN0cmVhbS5fcmVhZGFibGVTdGF0ZSAmJiBzdHJlYW0uX3JlYWRhYmxlU3RhdGUuZW5kZWQKfQoKZnVuY3Rpb24gaXNGaW5pc2hlZCAoc3RyZWFtKSB7CiAgcmV0dXJuICEhc3RyZWFtLl93cml0YWJsZVN0YXRlICYmIHN0cmVhbS5fd3JpdGFibGVTdGF0ZS5lbmRlZAp9CgpmdW5jdGlvbiBnZXRTdHJlYW1FcnJvciAoc3RyZWFtLCBvcHRzID0ge30pIHsKICBjb25zdCBlcnIgPSAoc3RyZWFtLl9yZWFkYWJsZVN0YXRlICYmIHN0cmVhbS5fcmVhZGFibGVTdGF0ZS5lcnJvcikgfHwgKHN0cmVhbS5fd3JpdGFibGVTdGF0ZSAmJiBzdHJlYW0uX3dyaXRhYmxlU3RhdGUuZXJyb3IpCgogIC8vIGF2b2lkIGltcGxpY2l0IGVycm9ycyBieSBkZWZhdWx0CiAgcmV0dXJuICghb3B0cy5hbGwgJiYgZXJyID09PSBTVFJFQU1fREVTVFJPWUVEKSA/IG51bGwgOiBlcnIKfQoKZnVuY3Rpb24gaXNSZWFkU3RyZWFteCAoc3RyZWFtKSB7CiAgcmV0dXJuIGlzU3RyZWFteChzdHJlYW0pICYmIHN0cmVhbS5yZWFkYWJsZQp9CgpmdW5jdGlvbiBpc0Rpc3R1cmJlZCAoc3RyZWFtKSB7CiAgcmV0dXJuIChzdHJlYW0uX2R1cGxleFN0YXRlICYgT1BFTklORykgIT09IE9QRU5JTkcgfHwgKHN0cmVhbS5fZHVwbGV4U3RhdGUgJiBBQ1RJVkVfT1JfVElDS0lORykgIT09IDAKfQoKZnVuY3Rpb24gaXNUeXBlZEFycmF5IChkYXRhKSB7CiAgcmV0dXJuIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiBkYXRhICE9PSBudWxsICYmIHR5cGVvZiBkYXRhLmJ5dGVMZW5ndGggPT09ICdudW1iZXInCn0KCmZ1bmN0aW9uIGRlZmF1bHRCeXRlTGVuZ3RoIChkYXRhKSB7CiAgcmV0dXJuIGlzVHlwZWRBcnJheShkYXRhKSA/IGRhdGEuYnl0ZUxlbmd0aCA6IDEwMjQKfQoKZnVuY3Rpb24gbm9vcCAoKSB7fQoKZnVuY3Rpb24gYWJvcnQgKCkgewogIHRoaXMuZGVzdHJveShuZXcgRXJyb3IoJ1N0cmVhbSBhYm9ydGVkLicpKQp9CgpmdW5jdGlvbiBpc1dyaXRldiAocykgewogIHJldHVybiBzLl93cml0ZXYgIT09IFdyaXRhYmxlLnByb3RvdHlwZS5fd3JpdGV2ICYmIHMuX3dyaXRldiAhPT0gRHVwbGV4LnByb3RvdHlwZS5fd3JpdGV2Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIHBpcGVsaW5lLAogIHBpcGVsaW5lUHJvbWlzZSwKICBpc1N0cmVhbSwKICBpc1N0cmVhbXgsCiAgaXNFbmRlZCwKICBpc0ZpbmlzaGVkLAogIGlzRGlzdHVyYmVkLAogIGdldFN0cmVhbUVycm9yLAogIFN0cmVhbSwKICBXcml0YWJsZSwKICBSZWFkYWJsZSwKICBEdXBsZXgsCiAgVHJhbnNmb3JtLAogIC8vIEV4cG9ydCBQYXNzVGhyb3VnaCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIE5vZGUuanMgY29yZSdzIHN0cmVhbSBtb2R1bGUKICBQYXNzVGhyb3VnaAp9CnsKICAibmFtZSI6ICJzdHJlYW14IiwKICAidmVyc2lvbiI6ICIyLjIzLjAiLAogICJkZXNjcmlwdGlvbiI6ICJBbiBpdGVyYXRpb24gb2YgdGhlIE5vZGUuanMgY29yZSBzdHJlYW1zIHdpdGggYSBzZXJpZXMgb2YgaW1wcm92ZW1lbnRzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJldmVudHMtdW5pdmVyc2FsIjogIl4xLjAuMCIsCiAgICAiZmFzdC1maWZvIjogIl4xLjMuMiIsCiAgICAidGV4dC1kZWNvZGVyIjogIl4xLjEuMCIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjYuNiIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjEiLAogICAgImVuZC1vZi1zdHJlYW0iOiAiXjEuNC40IiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBub2RlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmJhcmUiOiAic3RhbmRhcmQgJiYgYmFyZSB0ZXN0L2FsbC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zdHJlYW14LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC9zdHJlYW14L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3N0cmVhbXgiCn0KY29uc3QgY29kZWNzID0gcmVxdWlyZSgnY29kZWNzJykKY29uc3QgYiA9IHJlcXVpcmUoJ2I0YScpCgpjb25zdCBTRVAgPSBiLmFsbG9jKDEpCmNvbnN0IFNFUF9CVU1QRUQgPSBiLmZyb20oWzB4MV0pCmNvbnN0IEVNUFRZID0gYi5hbGxvYygwKQoKbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBTdWJFbmNvZGVyIHsKICBjb25zdHJ1Y3RvciAocHJlZml4LCBlbmNvZGluZywgcGFyZW50ID0gbnVsbCkgewogICAgdGhpcy51c2VyRW5jb2RpbmcgPSBjb2RlY3MoZW5jb2RpbmcpCiAgICB0aGlzLnByZWZpeCA9IHByZWZpeCAhPSBudWxsID8gY3JlYXRlUHJlZml4KHByZWZpeCwgcGFyZW50KSA6IG51bGwKICAgIHRoaXMubHQgPSB0aGlzLnByZWZpeCAmJiBiLmNvbmNhdChbdGhpcy5wcmVmaXguc3ViYXJyYXkoMCwgdGhpcy5wcmVmaXguYnl0ZUxlbmd0aCAtIDEpLCBTRVBfQlVNUEVEXSkKICB9CgogIF9lbmNvZGVSYW5nZVVzZXIgKHIpIHsKICAgIGlmICh0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGVSYW5nZSkgcmV0dXJuIHRoaXMudXNlckVuY29kaW5nLmVuY29kZVJhbmdlKHIpCgogICAgY29uc3QgcmVzID0ge30KICAgIGlmIChyLmd0ICE9IG51bGwpIHJlcy5ndCA9IHRoaXMudXNlckVuY29kaW5nLmVuY29kZShyLmd0KQogICAgaWYgKHIuZ3RlICE9IG51bGwpIHJlcy5ndGUgPSB0aGlzLnVzZXJFbmNvZGluZy5lbmNvZGUoci5ndGUpCiAgICBpZiAoci5sdGUgIT0gbnVsbCkgcmVzLmx0ZSA9IHRoaXMudXNlckVuY29kaW5nLmVuY29kZShyLmx0ZSkKICAgIGlmIChyLmx0ICE9IG51bGwpIHJlcy5sdCA9IHRoaXMudXNlckVuY29kaW5nLmVuY29kZShyLmx0KQoKICAgIHJldHVybiByZXMKICB9CgogIF9hZGRQcmVmaXggKGtleSkgewogICAgcmV0dXJuIHRoaXMucHJlZml4ID8gYi5jb25jYXQoW3RoaXMucHJlZml4LCBrZXldKSA6IGtleQogIH0KCiAgZW5jb2RlIChrZXkpIHsKICAgIHJldHVybiB0aGlzLl9hZGRQcmVmaXgodGhpcy51c2VyRW5jb2RpbmcuZW5jb2RlKGtleSkpCiAgfQoKICBlbmNvZGVSYW5nZSAocmFuZ2UpIHsKICAgIGNvbnN0IHIgPSB0aGlzLl9lbmNvZGVSYW5nZVVzZXIocmFuZ2UpCgogICAgaWYgKHIuZ3QpIHIuZ3QgPSB0aGlzLl9hZGRQcmVmaXgoci5ndCkKICAgIGVsc2UgaWYgKHIuZ3RlKSByLmd0ZSA9IHRoaXMuX2FkZFByZWZpeChyLmd0ZSkKICAgIGVsc2UgaWYgKHRoaXMucHJlZml4KSByLmd0ZSA9IHRoaXMucHJlZml4CgogICAgaWYgKHIubHQpIHIubHQgPSB0aGlzLl9hZGRQcmVmaXgoci5sdCkKICAgIGVsc2UgaWYgKHIubHRlKSByLmx0ZSA9IHRoaXMuX2FkZFByZWZpeChyLmx0ZSkKICAgIGVsc2UgaWYgKHRoaXMucHJlZml4KSByLmx0ID0gdGhpcy5sdAoKICAgIHJldHVybiByCiAgfQoKICBkZWNvZGUgKGtleSkgewogICAgcmV0dXJuIHRoaXMudXNlckVuY29kaW5nLmRlY29kZSh0aGlzLnByZWZpeCA/IGtleS5zdWJhcnJheSh0aGlzLnByZWZpeC5ieXRlTGVuZ3RoKSA6IGtleSkKICB9CgogIHN1YiAocHJlZml4LCBlbmNvZGluZykgewogICAgcmV0dXJuIG5ldyBTdWJFbmNvZGVyKHByZWZpeCB8fCBFTVBUWSwgY29tcGF0KGVuY29kaW5nKSwgdGhpcy5wcmVmaXgpCiAgfQp9CgpmdW5jdGlvbiBjcmVhdGVQcmVmaXggKHByZWZpeCwgcGFyZW50KSB7CiAgcHJlZml4ID0gdHlwZW9mIHByZWZpeCA9PT0gJ3N0cmluZycgPyBiLmZyb20ocHJlZml4KSA6IHByZWZpeAoKICBpZiAocHJlZml4ICYmIHBhcmVudCkgcmV0dXJuIGIuY29uY2F0KFtwYXJlbnQsIHByZWZpeCwgU0VQXSkKICBpZiAocHJlZml4KSByZXR1cm4gYi5jb25jYXQoW3ByZWZpeCwgU0VQXSkKICBpZiAocGFyZW50KSByZXR1cm4gYi5jb25jYXQoW3BhcmVudCwgU0VQXSkKICByZXR1cm4gU0VQCn0KCmZ1bmN0aW9uIGNvbXBhdCAoZW5jKSB7CiAgaWYgKGVuYyAmJiBlbmMua2V5RW5jb2RpbmcpIHJldHVybiBlbmMua2V5RW5jb2RpbmcKICByZXR1cm4gZW5jCn0KewogICJuYW1lIjogInN1Yi1lbmNvZGVyIiwKICAidmVyc2lvbiI6ICIyLjEuMyIsCiAgImRlc2NyaXB0aW9uIjogIkdlbmVyYXRlIHN1YiBlbmNvZGluZ3MgZm9yIGtleS92YWx1ZSBzdG9yZXMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC8qLmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQraHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3N1Yi1lbmNvZGVyLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJrdi1zdG9yZSIsCiAgICAiZW5jb2RpbmciLAogICAgImh5cGVyYmVlIgogIF0sCiAgImF1dGhvciI6ICJBbmRyZXcgT3NoZXJvZmYgPGFuZHJld29zaEBnbWFpbC5jb20+IiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3N1Yi1lbmNvZGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vc3ViLWVuY29kZXIjcmVhZG1lIiwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMS4xIiwKICAgICJjb21wYWN0LWVuY29kaW5nIjogIl4yLjEyLjAiLAogICAgImh5cGVyYmVlIjogIl4yLjExLjAiLAogICAgImh5cGVyY29yZSI6ICJeMTAuMy4yIiwKICAgICJpbmRleC1lbmNvZGVyIjogIl4zLjAuMCIsCiAgICAicmFuZG9tLWFjY2Vzcy1tZW1vcnkiOiAiXjYuMC4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIiwKICAgICJjb2RlY3MiOiAiXjMuMS4wIgogIH0KfQpjb25zdCBQYXNzVGhyb3VnaERlY29kZXIgPSByZXF1aXJlKCcuL2xpYi9wYXNzLXRocm91Z2gtZGVjb2RlcicpCmNvbnN0IFVURjhEZWNvZGVyID0gcmVxdWlyZSgnLi9saWIvdXRmOC1kZWNvZGVyJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGV4dERlY29kZXIgewogIGNvbnN0cnVjdG9yIChlbmNvZGluZyA9ICd1dGY4JykgewogICAgdGhpcy5lbmNvZGluZyA9IG5vcm1hbGl6ZUVuY29kaW5nKGVuY29kaW5nKQoKICAgIHN3aXRjaCAodGhpcy5lbmNvZGluZykgewogICAgICBjYXNlICd1dGY4JzoKICAgICAgICB0aGlzLmRlY29kZXIgPSBuZXcgVVRGOERlY29kZXIoKQogICAgICAgIGJyZWFrCiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgZW5jb2Rpbmc6ICcgKyB0aGlzLmVuY29kaW5nKQogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuZGVjb2RlciA9IG5ldyBQYXNzVGhyb3VnaERlY29kZXIodGhpcy5lbmNvZGluZykKICAgIH0KICB9CgogIGdldCByZW1haW5pbmcgKCkgewogICAgcmV0dXJuIHRoaXMuZGVjb2Rlci5yZW1haW5pbmcKICB9CgogIHB1c2ggKGRhdGEpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHJldHVybiBkYXRhCiAgICByZXR1cm4gdGhpcy5kZWNvZGVyLmRlY29kZShkYXRhKQogIH0KCiAgLy8gRm9yIE5vZGUuanMgY29tcGF0aWJpbGl0eQogIHdyaXRlIChkYXRhKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoKGRhdGEpCiAgfQoKICBlbmQgKGRhdGEpIHsKICAgIGxldCByZXN1bHQgPSAnJwogICAgaWYgKGRhdGEpIHJlc3VsdCA9IHRoaXMucHVzaChkYXRhKQogICAgcmVzdWx0ICs9IHRoaXMuZGVjb2Rlci5mbHVzaCgpCiAgICByZXR1cm4gcmVzdWx0CiAgfQp9CgpmdW5jdGlvbiBub3JtYWxpemVFbmNvZGluZyAoZW5jb2RpbmcpIHsKICBlbmNvZGluZyA9IGVuY29kaW5nLnRvTG93ZXJDYXNlKCkKCiAgc3dpdGNoIChlbmNvZGluZykgewogICAgY2FzZSAndXRmOCc6CiAgICBjYXNlICd1dGYtOCc6CiAgICAgIHJldHVybiAndXRmOCcKICAgIGNhc2UgJ3VjczInOgogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndXRmMTZsZSc6CiAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgIHJldHVybiAndXRmMTZsZScKICAgIGNhc2UgJ2xhdGluMSc6CiAgICBjYXNlICdiaW5hcnknOgogICAgICByZXR1cm4gJ2xhdGluMScKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICBjYXNlICdhc2NpaSc6CiAgICBjYXNlICdoZXgnOgogICAgICByZXR1cm4gZW5jb2RpbmcKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogIH0KfTsKY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCm1vZHVsZS5leHBvcnRzID0gY2xhc3MgUGFzc1Rocm91Z2hEZWNvZGVyIHsKICBjb25zdHJ1Y3RvciAoZW5jb2RpbmcpIHsKICAgIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZwogIH0KCiAgZ2V0IHJlbWFpbmluZyAoKSB7CiAgICByZXR1cm4gMAogIH0KCiAgZGVjb2RlICh0YWlsKSB7CiAgICByZXR1cm4gYjRhLnRvU3RyaW5nKHRhaWwsIHRoaXMuZW5jb2RpbmcpCiAgfQoKICBmbHVzaCAoKSB7CiAgICByZXR1cm4gJycKICB9Cn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCi8qKgogKiBodHRwczovL2VuY29kaW5nLnNwZWMud2hhdHdnLm9yZy8jdXRmLTgtZGVjb2RlcgogKi8KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBVVEY4RGVjb2RlciB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5jb2RlUG9pbnQgPSAwCiAgICB0aGlzLmJ5dGVzU2VlbiA9IDAKICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAwCiAgICB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDgwCiAgICB0aGlzLnVwcGVyQm91bmRhcnkgPSAweGJmCiAgfQoKICBnZXQgcmVtYWluaW5nICgpIHsKICAgIHJldHVybiB0aGlzLmJ5dGVzU2VlbgogIH0KCiAgZGVjb2RlIChkYXRhKSB7CiAgICAvLyBJZiB3ZSBoYXZlIGEgZmFzdCBwYXRoLCBqdXN0IHNuaWZmIGlmIHRoZSBsYXN0IHBhcnQgaXMgYSBib3VuZGFyeQogICAgaWYgKHRoaXMuYnl0ZXNOZWVkZWQgPT09IDApIHsKICAgICAgbGV0IGlzQm91bmRhcnkgPSB0cnVlCgogICAgICBmb3IgKGxldCBpID0gTWF0aC5tYXgoMCwgZGF0YS5ieXRlTGVuZ3RoIC0gNCksIG4gPSBkYXRhLmJ5dGVMZW5ndGg7IGkgPCBuICYmIGlzQm91bmRhcnk7IGkrKykgewogICAgICAgIGlzQm91bmRhcnkgPSBkYXRhW2ldIDw9IDB4N2YKICAgICAgfQoKICAgICAgaWYgKGlzQm91bmRhcnkpIHJldHVybiBiNGEudG9TdHJpbmcoZGF0YSwgJ3V0ZjgnKQogICAgfQoKICAgIGxldCByZXN1bHQgPSAnJwoKICAgIGZvciAobGV0IGkgPSAwLCBuID0gZGF0YS5ieXRlTGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IGJ5dGUgPSBkYXRhW2ldCgogICAgICBpZiAodGhpcy5ieXRlc05lZWRlZCA9PT0gMCkgewogICAgICAgIGlmIChieXRlIDw9IDB4N2YpIHsKICAgICAgICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGUpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYnl0ZXNTZWVuID0gMQoKICAgICAgICAgIGlmIChieXRlID49IDB4YzIgJiYgYnl0ZSA8PSAweGRmKSB7CiAgICAgICAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAyCiAgICAgICAgICAgIHRoaXMuY29kZVBvaW50ID0gYnl0ZSAmIDB4MWYKICAgICAgICAgIH0gZWxzZSBpZiAoYnl0ZSA+PSAweGUwICYmIGJ5dGUgPD0gMHhlZikgewogICAgICAgICAgICBpZiAoYnl0ZSA9PT0gMHhlMCkgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHhhMAogICAgICAgICAgICBlbHNlIGlmIChieXRlID09PSAweGVkKSB0aGlzLnVwcGVyQm91bmRhcnkgPSAweDlmCiAgICAgICAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAzCiAgICAgICAgICAgIHRoaXMuY29kZVBvaW50ID0gYnl0ZSAmIDB4ZgogICAgICAgICAgfSBlbHNlIGlmIChieXRlID49IDB4ZjAgJiYgYnl0ZSA8PSAweGY0KSB7CiAgICAgICAgICAgIGlmIChieXRlID09PSAweGYwKSB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDkwCiAgICAgICAgICAgIGlmIChieXRlID09PSAweGY0KSB0aGlzLnVwcGVyQm91bmRhcnkgPSAweDhmCiAgICAgICAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSA0CiAgICAgICAgICAgIHRoaXMuY29kZVBvaW50ID0gYnl0ZSAmIDB4NwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ICs9ICdcdWZmZmQnCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICBpZiAoYnl0ZSA8IHRoaXMubG93ZXJCb3VuZGFyeSB8fCBieXRlID4gdGhpcy51cHBlckJvdW5kYXJ5KSB7CiAgICAgICAgdGhpcy5jb2RlUG9pbnQgPSAwCiAgICAgICAgdGhpcy5ieXRlc05lZWRlZCA9IDAKICAgICAgICB0aGlzLmJ5dGVzU2VlbiA9IDAKICAgICAgICB0aGlzLmxvd2VyQm91bmRhcnkgPSAweDgwCiAgICAgICAgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHhiZgoKICAgICAgICByZXN1bHQgKz0gJ1x1ZmZmZCcKCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHg4MAogICAgICB0aGlzLnVwcGVyQm91bmRhcnkgPSAweGJmCgogICAgICB0aGlzLmNvZGVQb2ludCA9ICh0aGlzLmNvZGVQb2ludCA8PCA2KSB8IChieXRlICYgMHgzZikKICAgICAgdGhpcy5ieXRlc1NlZW4rKwoKICAgICAgaWYgKHRoaXMuYnl0ZXNTZWVuICE9PSB0aGlzLmJ5dGVzTmVlZGVkKSBjb250aW51ZQoKICAgICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ29kZVBvaW50KHRoaXMuY29kZVBvaW50KQoKICAgICAgdGhpcy5jb2RlUG9pbnQgPSAwCiAgICAgIHRoaXMuYnl0ZXNOZWVkZWQgPSAwCiAgICAgIHRoaXMuYnl0ZXNTZWVuID0gMAogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9CgogIGZsdXNoICgpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYnl0ZXNOZWVkZWQgPiAwID8gJ1x1ZmZmZCcgOiAnJwoKICAgIHRoaXMuY29kZVBvaW50ID0gMAogICAgdGhpcy5ieXRlc05lZWRlZCA9IDAKICAgIHRoaXMuYnl0ZXNTZWVuID0gMAogICAgdGhpcy5sb3dlckJvdW5kYXJ5ID0gMHg4MAogICAgdGhpcy51cHBlckJvdW5kYXJ5ID0gMHhiZgoKICAgIHJldHVybiByZXN1bHQKICB9Cn0KewogICJuYW1lIjogInRleHQtZGVjb2RlciIsCiAgInZlcnNpb24iOiAiMS4yLjMiLAogICJkZXNjcmlwdGlvbiI6ICJTdHJlYW1pbmcgdGV4dCBkZWNvZGVyIHRoYXQgcHJlc2VydmVzIG11bHRpYnl0ZSBVbmljb2RlIGNoYXJhY3RlcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiLAogICAgImxpYiIKICBdLAogICJicm93c2VyIjogewogICAgIi4vbGliL3Bhc3MtdGhyb3VnaC1kZWNvZGVyLmpzIjogIi4vbGliL2Jyb3dzZXItZGVjb2Rlci5qcyIsCiAgICAiLi9saWIvdXRmOC1kZWNvZGVyLmpzIjogIi4vbGliL2Jyb3dzZXItZGVjb2Rlci5qcyIKICB9LAogICJyZWFjdC1uYXRpdmUiOiB7CiAgICAiLi9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiOiAiLi9saWIvcGFzcy10aHJvdWdoLWRlY29kZXIuanMiLAogICAgIi4vbGliL3V0ZjgtZGVjb2Rlci5qcyI6ICIuL2xpYi91dGY4LWRlY29kZXIuanMiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by90ZXh0LWRlY29kZXIuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2giLAogICJsaWNlbnNlIjogIkFwYWNoZS0yLjAiLAogICJidWdzIjogewogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdGV4dC1kZWNvZGVyL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdGV4dC1kZWNvZGVyI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi40IgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjMuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjAuMCIKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBUaW1lT3JkZXJlZFNldCB7CiAgY29uc3RydWN0b3IgKCkgewogICAgdGhpcy5vbGRlc3QgPSBudWxsCiAgICB0aGlzLmxhdGVzdCA9IG51bGwKICAgIHRoaXMubGVuZ3RoID0gMAogIH0KCiAgaGFzIChub2RlKSB7CiAgICByZXR1cm4gISEobm9kZS5uZXh0IHx8IG5vZGUucHJldikgfHwgbm9kZSA9PT0gdGhpcy5vbGRlc3QKICB9CgogIGFkZCAobm9kZSkgewogICAgaWYgKHRoaXMuaGFzKG5vZGUpKSB0aGlzLnJlbW92ZShub2RlKQoKICAgIGlmICghdGhpcy5sYXRlc3QgJiYgIXRoaXMub2xkZXN0KSB7CiAgICAgIHRoaXMubGF0ZXN0ID0gdGhpcy5vbGRlc3QgPSBub2RlCiAgICAgIG5vZGUucHJldiA9IG5vZGUubmV4dCA9IG51bGwKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubGF0ZXN0Lm5leHQgPSBub2RlCiAgICAgIG5vZGUucHJldiA9IHRoaXMubGF0ZXN0CiAgICAgIG5vZGUubmV4dCA9IG51bGwKICAgICAgdGhpcy5sYXRlc3QgPSBub2RlCiAgICB9CgogICAgdGhpcy5sZW5ndGgrKwoKICAgIHJldHVybiBub2RlCiAgfQoKICByZW1vdmUgKG5vZGUpIHsKICAgIGlmICghdGhpcy5oYXMobm9kZSkpIHJldHVybiBub2RlCgogICAgaWYgKHRoaXMub2xkZXN0ICE9PSBub2RlICYmIHRoaXMubGF0ZXN0ICE9PSBub2RlKSB7CiAgICAgIG5vZGUucHJldi5uZXh0ID0gbm9kZS5uZXh0CiAgICAgIG5vZGUubmV4dC5wcmV2ID0gbm9kZS5wcmV2CiAgICB9IGVsc2UgewogICAgICBpZiAodGhpcy5vbGRlc3QgPT09IG5vZGUpIHsKICAgICAgICB0aGlzLm9sZGVzdCA9IG5vZGUubmV4dAogICAgICAgIGlmICh0aGlzLm9sZGVzdCkgdGhpcy5vbGRlc3QucHJldiA9IG51bGwKICAgICAgfQogICAgICBpZiAodGhpcy5sYXRlc3QgPT09IG5vZGUpIHsKICAgICAgICB0aGlzLmxhdGVzdCA9IG5vZGUucHJldgogICAgICAgIGlmICh0aGlzLmxhdGVzdCkgdGhpcy5sYXRlc3QubmV4dCA9IG51bGwKICAgICAgfQogICAgfQoKICAgIG5vZGUubmV4dCA9IG5vZGUucHJldiA9IG51bGwKICAgIHRoaXMubGVuZ3RoLS0KCiAgICByZXR1cm4gbm9kZQogIH0KCiAgdG9BcnJheSAoeyBsaW1pdCA9IEluZmluaXR5LCByZXZlcnNlID0gZmFsc2UgfSA9IHt9KSB7CiAgICBjb25zdCBsaXN0ID0gW10KCiAgICBpZiAocmV2ZXJzZSkgewogICAgICBsZXQgbm9kZSA9IHRoaXMubGF0ZXN0CiAgICAgIHdoaWxlIChub2RlICYmIGxpbWl0LS0pIHsKICAgICAgICBsaXN0LnB1c2gobm9kZSkKICAgICAgICBub2RlID0gbm9kZS5wcmV2CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGxldCBub2RlID0gdGhpcy5vbGRlc3QKICAgICAgd2hpbGUgKG5vZGUgJiYgbGltaXQtLSkgewogICAgICAgIGxpc3QucHVzaChub2RlKQogICAgICAgIG5vZGUgPSBub2RlLm5leHQKICAgICAgfQogICAgfQoKICAgIHJldHVybiBsaXN0CiAgfQp9CnsKICAibmFtZSI6ICJ0aW1lLW9yZGVyZWQtc2V0IiwKICAidmVyc2lvbiI6ICIyLjAuMSIsCiAgImRlc2NyaXB0aW9uIjogIkVmZmljaWVudGx5IG1haW50YWluIGEgc2V0IG9mIG5vZGVzIG9yZGVyZWQgYnkgdGhlIHRpbWUgdGhleSB3ZXJlIGFkZGVkIHRvIHRoZSBzZXQiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgImJyaXR0bGUiOiAiXjMuMC4wIiwKICAgICJzdGFuZGFyZCI6ICJeMTcuMS4yIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiBicml0dGxlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZS1vcmRlcmVkLXNldC5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZS1vcmRlcmVkLXNldC9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lLW9yZGVyZWQtc2V0Igp9Cm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGltZXJCcm93c2VyIHsKICBjb25zdHJ1Y3RvciAobXMsIGZuLCBjdHggPSBudWxsLCBpbnRlcnZhbCA9IGZhbHNlKSB7CiAgICB0aGlzLm1zID0gbXMKICAgIHRoaXMub250aW1lb3V0ID0gZm4KICAgIHRoaXMuY29udGV4dCA9IGN0eCB8fCBudWxsCiAgICB0aGlzLmludGVydmFsID0gaW50ZXJ2YWwKICAgIHRoaXMuZG9uZSA9IGZhbHNlCgogICAgdGhpcy5fdGltZXIgPSBpbnRlcnZhbAogICAgICA/IHNldEludGVydmFsKGNhbGxJbnRlcnZhbCwgbXMsIHRoaXMpCiAgICAgIDogc2V0VGltZW91dChjYWxsVGltZW91dCwgbXMsIHRoaXMpCiAgfQoKICB1bnJlZiAoKSB7fQoKICByZWYgKCkge30KCiAgcmVmcmVzaCAoKSB7CiAgICBpZiAodGhpcy5kb25lKSByZXR1cm4KCiAgICBpZiAodGhpcy5pbnRlcnZhbCkgewogICAgICBjbGVhckludGVydmFsKHRoaXMuX3RpbWVyKQogICAgICB0aGlzLl90aW1lciA9IHNldEludGVydmFsKGNhbGxJbnRlcnZhbCwgdGhpcy5tcywgdGhpcykKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lcikKICAgICAgdGhpcy5fdGltZXIgPSBzZXRUaW1lb3V0KGNhbGxUaW1lb3V0LCB0aGlzLm1zLCB0aGlzKQogICAgfQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLmRvbmUgPSB0cnVlCiAgICB0aGlzLm9udGltZW91dCA9IG51bGwKCiAgICBpZiAodGhpcy5pbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl90aW1lcikKICAgIGVsc2UgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKQogIH0KCiAgc3RhdGljIG9uY2UgKG1zLCBmbiwgY3R4KSB7CiAgICByZXR1cm4gbmV3IHRoaXMobXMsIGZuLCBjdHgsIGZhbHNlKQogIH0KCiAgc3RhdGljIG9uIChtcywgZm4sIGN0eCkgewogICAgcmV0dXJuIG5ldyB0aGlzKG1zLCBmbiwgY3R4LCB0cnVlKQogIH0KfQoKZnVuY3Rpb24gY2FsbFRpbWVvdXQgKHNlbGYpIHsKICBzZWxmLmRvbmUgPSB0cnVlCiAgc2VsZi5vbnRpbWVvdXQuY2FsbChzZWxmLmNvbnRleHQpCn0KCmZ1bmN0aW9uIGNhbGxJbnRlcnZhbCAoc2VsZikgewogIHNlbGYub250aW1lb3V0LmNhbGwoc2VsZi5jb250ZXh0KQp9Cm1vZHVsZS5leHBvcnRzID0gaXNOb2RlKCkKICA/IHJlcXVpcmUoJy4vbm9kZScpCiAgOiByZXF1aXJlKCcuL2Jyb3dzZXInKQoKZnVuY3Rpb24gaXNOb2RlICgpIHsKICBjb25zdCB0byA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge30sIDEwMDApCiAgY2xlYXJUaW1lb3V0KHRvKQogIHJldHVybiAhIXRvLnJlZnJlc2gKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFRpbWVyIHsKICBjb25zdHJ1Y3RvciAobXMsIGZuLCBjdHggPSBudWxsLCBpbnRlcnZhbCA9IGZhbHNlKSB7CiAgICB0aGlzLm1zID0gbXMKICAgIHRoaXMub250aW1lb3V0ID0gZm4KICAgIHRoaXMuY29udGV4dCA9IGN0eAogICAgdGhpcy5pbnRlcnZhbCA9IGludGVydmFsCiAgICB0aGlzLmRvbmUgPSBmYWxzZQoKICAgIHRoaXMuX3RpbWVyID0gaW50ZXJ2YWwKICAgICAgPyBzZXRJbnRlcnZhbChjYWxsSW50ZXJ2YWwsIG1zLCB0aGlzKQogICAgICA6IHNldFRpbWVvdXQoY2FsbFRpbWVvdXQsIG1zLCB0aGlzKQogIH0KCiAgdW5yZWYgKCkgewogICAgdGhpcy5fdGltZXIudW5yZWYoKQogIH0KCiAgcmVmICgpIHsKICAgIHRoaXMuX3RpbWVyLnJlZigpCiAgfQoKICByZWZyZXNoICgpIHsKICAgIGlmICh0aGlzLmRvbmUgIT09IHRydWUpIHRoaXMuX3RpbWVyLnJlZnJlc2goKQogIH0KCiAgZGVzdHJveSAoKSB7CiAgICB0aGlzLmRvbmUgPSB0cnVlCiAgICB0aGlzLm9udGltZW91dCA9IG51bGwKICAgIGlmICh0aGlzLmludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX3RpbWVyKQogICAgZWxzZSBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpCiAgfQoKICBzdGF0aWMgb25jZSAobXMsIGZuLCBjdHgpIHsKICAgIHJldHVybiBuZXcgdGhpcyhtcywgZm4sIGN0eCwgZmFsc2UpCiAgfQoKICBzdGF0aWMgb24gKG1zLCBmbiwgY3R4KSB7CiAgICByZXR1cm4gbmV3IHRoaXMobXMsIGZuLCBjdHgsIHRydWUpCiAgfQp9CgpmdW5jdGlvbiBjYWxsVGltZW91dCAoc2VsZikgewogIHNlbGYuZG9uZSA9IHRydWUKICBzZWxmLm9udGltZW91dC5jYWxsKHNlbGYuY29udGV4dCkKfQoKZnVuY3Rpb24gY2FsbEludGVydmFsIChzZWxmKSB7CiAgc2VsZi5vbnRpbWVvdXQuY2FsbChzZWxmLmNvbnRleHQpCn0KewogICJuYW1lIjogInRpbWVvdXQtcmVmcmVzaCIsCiAgInZlcnNpb24iOiAiMi4wLjEiLAogICJkZXNjcmlwdGlvbiI6ICJFZmZpY2llbnRseSByZWZyZXNoIGEgdGltZXIiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTYuMC40IiwKICAgICJ0YXBlIjogIl41LjUuMiIKICB9LAogICJicm93c2VyIjogIi4vYnJvd3Nlci5qcyIsCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCAmJiB0YXBlIHRlc3QuanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZW91dC1yZWZyZXNoLmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC90aW1lb3V0LXJlZnJlc2gvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvdGltZW91dC1yZWZyZXNoIgp9CmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIEJ1ZmZlck1hcCB7CiAgY29uc3RydWN0b3IgKG90aGVyKSB7CiAgICB0aGlzLm0gPSBvdGhlciA/IG5ldyBNYXAoWy4uLm90aGVyLm1dKSA6IG5ldyBNYXAoKQogIH0KCiAgZ2V0IHNpemUgKCkgewogICAgcmV0dXJuIHRoaXMubS5zaXplCiAgfQoKICBnZXQgKGtleSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXkpKSBrZXkgPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIHJldHVybiB0aGlzLm0uZ2V0KGtleSkKICB9CgogIHNldCAoa2V5LCB2YWx1ZSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXkpKSBrZXkgPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIHJldHVybiB0aGlzLm0uc2V0KGtleSwgdmFsdWUpCiAgfQoKICBkZWxldGUgKGtleSkgewogICAgaWYgKGI0YS5pc0J1ZmZlcihrZXkpKSBrZXkgPSBiNGEudG9TdHJpbmcoa2V5LCAnaGV4JykKICAgIHJldHVybiB0aGlzLm0uZGVsZXRlKGtleSkKICB9CgogIGhhcyAoa2V5KSB7CiAgICBpZiAoYjRhLmlzQnVmZmVyKGtleSkpIGtleSA9IGI0YS50b1N0cmluZyhrZXksICdoZXgnKQogICAgcmV0dXJuIHRoaXMubS5oYXMoa2V5KQogIH0KCiAgKiBbU3ltYm9sLml0ZXJhdG9yXSAoKSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0aGlzLm0pIHsKICAgICAgeWllbGQgW2I0YS5mcm9tKGtleSwgJ2hleCcpLCB2YWx1ZV0KICAgIH0KICB9CgogICoga2V5cyAoKSB7CiAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLm0ua2V5cygpKSB7CiAgICAgIHlpZWxkIGI0YS5mcm9tKGtleSwgJ2hleCcpCiAgICB9CiAgfQoKICB2YWx1ZXMgKCkgewogICAgcmV0dXJuIHRoaXMubS52YWx1ZXMoKQogIH0KCiAgY2xlYXIgKCkgewogICAgcmV0dXJuIHRoaXMubS5jbGVhcigpCiAgfQp9CnsKICAibmFtZSI6ICJ0aW55LWJ1ZmZlci1tYXAiLAogICJ2ZXJzaW9uIjogIjEuMS4xIiwKICAiZGVzY3JpcHRpb24iOiAiQSB2ZXJ5IHNpbXBsZSBtYXAgZm9yIEJ1ZmZlcnMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogImJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiZ2l0K2h0dHBzOi8vZ2l0aHViLmNvbS9hbmRyZXdvc2gvdGlueS1idWZmZXItbWFwLmdpdCIKICB9LAogICJrZXl3b3JkcyI6IFsKICAgICJidWZmZXIiLAogICAgIm1hcCIKICBdLAogICJhdXRob3IiOiAiQW5kcmV3IE9zaGVyb2ZmIDxhbmRyZXdvc2hAZ21haWwuY29tPiIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2FuZHJld29zaC90aW55LWJ1ZmZlci1tYXAvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9hbmRyZXdvc2gvdGlueS1idWZmZXItbWFwI3JlYWRtZSIsCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjAuNCIKICB9Cn0KcmVxdWlyZS5hZGRvbiA9IHJlcXVpcmUoJ3JlcXVpcmUtYWRkb24nKQoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlLmFkZG9uKCcuJywgX19maWxlbmFtZSkKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKY29uc3QgdjRTZWcgPSAnKD86WzAtOV18WzEtOV1bMC05XXwxWzAtOV1bMC05XXwyWzAtNF1bMC05XXwyNVswLTVdKScKY29uc3QgdjRTdHIgPSBgKCR7djRTZWd9Wy5dKXszfSR7djRTZWd9YApjb25zdCBJUHY0UGF0dGVybiA9IG5ldyBSZWdFeHAoYF4ke3Y0U3RyfSRgKQoKY29uc3QgdjZTZWcgPSAnKD86WzAtOWEtZkEtRl17MSw0fSknCmNvbnN0IElQdjZQYXR0ZXJuID0gbmV3IFJlZ0V4cCgKICAnXignICsKICAgIGAoPzoke3Y2U2VnfTopezd9KD86JHt2NlNlZ318Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXs2fSg/OiR7djRTdHJ9fDoke3Y2U2VnfXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezV9KD86OiR7djRTdHJ9fCg6JHt2NlNlZ30pezEsMn18Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXs0fSg/Oig6JHt2NlNlZ30pezAsMX06JHt2NFN0cn18KDoke3Y2U2VnfSl7MSwzfXw6KXxgICsKICAgIGAoPzoke3Y2U2VnfTopezN9KD86KDoke3Y2U2VnfSl7MCwyfToke3Y0U3RyfXwoOiR7djZTZWd9KXsxLDR9fDopfGAgKwogICAgYCg/OiR7djZTZWd9Oil7Mn0oPzooOiR7djZTZWd9KXswLDN9OiR7djRTdHJ9fCg6JHt2NlNlZ30pezEsNX18Oil8YCArCiAgICBgKD86JHt2NlNlZ306KXsxfSg/Oig6JHt2NlNlZ30pezAsNH06JHt2NFN0cn18KDoke3Y2U2VnfSl7MSw2fXw6KXxgICsKICAgIGAoPzo6KCg/Ojoke3Y2U2VnfSl7MCw1fToke3Y0U3RyfXwoPzo6JHt2NlNlZ30pezEsN318OikpYCArCiAgICAnKSglWzAtOWEtekEtWi0uOl17MSx9KT8kJwopCgpjb25zdCBpc0lQdjQgPSAoZXhwb3J0cy5pc0lQdjQgPSBmdW5jdGlvbiBpc0lQdjQoaG9zdCkgewogIHJldHVybiBJUHY0UGF0dGVybi50ZXN0KGhvc3QpCn0pCgpjb25zdCBpc0lQdjYgPSAoZXhwb3J0cy5pc0lQdjYgPSBmdW5jdGlvbiBpc0lQdjYoaG9zdCkgewogIHJldHVybiBJUHY2UGF0dGVybi50ZXN0KGhvc3QpCn0pCgpleHBvcnRzLmlzSVAgPSBmdW5jdGlvbiBpc0lQKGhvc3QpIHsKICBpZiAoaXNJUHY0KGhvc3QpKSByZXR1cm4gNAogIGlmIChpc0lQdjYoaG9zdCkpIHJldHVybiA2CiAgcmV0dXJuIDAKfQpjb25zdCBldmVudHMgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE5ldHdvcmtJbnRlcmZhY2VzIGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IodWR4KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy5faGFuZGxlID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX2ludGVyZmFjZV9ldmVudF90KQogICAgdGhpcy5fd2F0Y2hpbmcgPSBmYWxzZQogICAgdGhpcy5fZGVzdHJveWluZyA9IG51bGwKCiAgICBiaW5kaW5nLnVkeF9uYXBpX2ludGVyZmFjZV9ldmVudF9pbml0KAogICAgICB1ZHguX2hhbmRsZSwKICAgICAgdGhpcy5faGFuZGxlLAogICAgICB0aGlzLAogICAgICB0aGlzLl9vbmV2ZW50LAogICAgICB0aGlzLl9vbmNsb3NlCiAgICApCgogICAgdGhpcy5pbnRlcmZhY2VzID0gYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfZ2V0X2FkZHJzKHRoaXMuX2hhbmRsZSkKICB9CgogIF9vbmNsb3NlKCkgewogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfb25ldmVudCgpIHsKICAgIHRoaXMuaW50ZXJmYWNlcyA9IGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X2dldF9hZGRycyh0aGlzLl9oYW5kbGUpCgogICAgdGhpcy5lbWl0KCdjaGFuZ2UnLCB0aGlzLmludGVyZmFjZXMpCiAgfQoKICB3YXRjaCgpIHsKICAgIGlmICh0aGlzLl93YXRjaGluZykgcmV0dXJuIHRoaXMKICAgIHRoaXMuX3dhdGNoaW5nID0gdHJ1ZQoKICAgIGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X3N0YXJ0KHRoaXMuX2hhbmRsZSkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdW53YXRjaCgpIHsKICAgIGlmICghdGhpcy5fd2F0Y2hpbmcpIHJldHVybiB0aGlzCiAgICB0aGlzLl93YXRjaGluZyA9IGZhbHNlCgogICAgYmluZGluZy51ZHhfbmFwaV9pbnRlcmZhY2VfZXZlbnRfc3RvcCh0aGlzLl9oYW5kbGUpCgogICAgcmV0dXJuIHRoaXMKICB9CgogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5fZGVzdHJveWluZykgcmV0dXJuIHRoaXMuX2Rlc3Ryb3lpbmcKICAgIHRoaXMuX2Rlc3Ryb3lpbmcgPSBldmVudHMub25jZSh0aGlzLCAnY2xvc2UnKQoKICAgIGJpbmRpbmcudWR4X25hcGlfaW50ZXJmYWNlX2V2ZW50X2Nsb3NlKHRoaXMuX2hhbmRsZSkKCiAgICByZXR1cm4gdGhpcy5fZGVzdHJveWluZwogIH0KCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5pbnRlcmZhY2VzW1N5bWJvbC5pdGVyYXRvcl0oKQogIH0KfQpjb25zdCBldmVudHMgPSByZXF1aXJlKCdldmVudHMnKQpjb25zdCBiNGEgPSByZXF1aXJlKCdiNGEnKQpjb25zdCBiaW5kaW5nID0gcmVxdWlyZSgnLi4vYmluZGluZycpCmNvbnN0IGlwID0gcmVxdWlyZSgnLi9pcCcpCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVEWFNvY2tldCBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKHVkeCwgb3B0cyA9IHt9KSB7CiAgICBzdXBlcigpCgogICAgdGhpcy51ZHggPSB1ZHgKCiAgICB0aGlzLl9oYW5kbGUgPSBiNGEuYWxsb2MoYmluZGluZy5zaXplb2ZfdWR4X25hcGlfc29ja2V0X3QpCiAgICB0aGlzLl9pbml0ZWQgPSBmYWxzZQogICAgdGhpcy5faG9zdCA9IG51bGwKICAgIHRoaXMuX2ZhbWlseSA9IDAKICAgIHRoaXMuX2lwdjZPbmx5ID0gb3B0cy5pcHY2T25seSA9PT0gdHJ1ZQogICAgdGhpcy5fcmV1c2VBZGRyZXNzID0gb3B0cy5yZXVzZUFkZHJlc3MgPT09IHRydWUKICAgIHRoaXMuX3BvcnQgPSAwCiAgICB0aGlzLl9yZXFzID0gW10KICAgIHRoaXMuX2ZyZWUgPSBbXQogICAgdGhpcy5fY2xvc2luZyA9IG51bGwKICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlCgogICAgdGhpcy5fdmlldzY0ID0gbmV3IEJpZ1VpbnQ2NEFycmF5KAogICAgICB0aGlzLl9oYW5kbGUuYnVmZmVyLAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZU9mZnNldCwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVMZW5ndGggPj4gMwogICAgKQoKICAgIHRoaXMuc3RyZWFtcyA9IG5ldyBTZXQoKQoKICAgIHRoaXMudXNlckRhdGEgPSBudWxsCiAgfQoKICBnZXQgYm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy5fcG9ydCAhPT0gMAogIH0KCiAgZ2V0IGNsb3NpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fY2xvc2luZyAhPT0gbnVsbAogIH0KCiAgZ2V0IGlkbGUoKSB7CiAgICByZXR1cm4gdGhpcy5zdHJlYW1zLnNpemUgPT09IDAKICB9CgogIGdldCBidXN5KCkgewogICAgcmV0dXJuIHRoaXMuc3RyZWFtcy5zaXplID4gMAogIH0KCiAgZ2V0IGJ5dGVzVHJhbnNtaXR0ZWQoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkICE9PSB0cnVlKSByZXR1cm4gMAogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc29ja2V0X3RfYnl0ZXNfdHggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c1RyYW5zbWl0dGVkKCkgewogICAgaWYgKHRoaXMuX2luaXRlZCAhPT0gdHJ1ZSkgcmV0dXJuIDAKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3NvY2tldF90X3BhY2tldHNfdHggPj4gM10pCiAgfQoKICBnZXQgYnl0ZXNSZWNlaXZlZCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQgIT09IHRydWUpIHJldHVybiAwCiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF9zb2NrZXRfdF9ieXRlc19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzUmVjZWl2ZWQoKSB7CiAgICBpZiAodGhpcy5faW5pdGVkICE9PSB0cnVlKSByZXR1cm4gMAogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfc29ja2V0X3RfcGFja2V0c19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzRHJvcHBlZEJ5S2VybmVsKCkgewogICAgaWYgKHRoaXMuX2luaXRlZCAhPT0gdHJ1ZSkgcmV0dXJuIDAKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3NvY2tldF90X3BhY2tldHNfZHJvcHBlZF9ieV9rZXJuZWwgPj4gM10pCiAgfQoKICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBib3VuZDogdGhpcy5ib3VuZCwKICAgICAgY2xvc2luZzogdGhpcy5jbG9zaW5nLAogICAgICBzdHJlYW1zOiB0aGlzLnN0cmVhbXMuc2l6ZSwKICAgICAgYWRkcmVzczogdGhpcy5hZGRyZXNzKCksCiAgICAgIGlwdjZPbmx5OiB0aGlzLl9pcHY2T25seSwKICAgICAgcmV1c2VBZGRyZXNzOiB0aGlzLl9yZXVzZUFkZHJlc3MsCiAgICAgIGlkbGU6IHRoaXMuaWRsZSwKICAgICAgYnVzeTogdGhpcy5idXN5CiAgICB9CiAgfQoKICBfaW5pdCgpIHsKICAgIGlmICh0aGlzLl9pbml0ZWQpIHJldHVybgoKICAgIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2luaXQoCiAgICAgIHRoaXMudWR4Ll9oYW5kbGUsCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgdGhpcywKICAgICAgdGhpcy5fb25zZW5kLAogICAgICB0aGlzLl9vbm1lc3NhZ2UsCiAgICAgIHRoaXMuX29uY2xvc2UsCiAgICAgIHRoaXMuX3JlYWxsb2NNZXNzYWdlCiAgICApCgogICAgdGhpcy5faW5pdGVkID0gdHJ1ZQogIH0KCiAgX29uc2VuZChpZCwgZXJyKSB7CiAgICBjb25zdCByZXEgPSB0aGlzLl9yZXFzW2lkXQoKICAgIGNvbnN0IG9uZmx1c2ggPSByZXEub25mbHVzaAoKICAgIHJlcS5idWZmZXIgPSBudWxsCiAgICByZXEub25mbHVzaCA9IG51bGwKCiAgICB0aGlzLl9mcmVlLnB1c2goaWQpCgogICAgb25mbHVzaChlcnIgPj0gMCkKCiAgICAvLyBnYyB0aGUgZnJlZSBsaXN0CiAgICBpZiAodGhpcy5fZnJlZS5sZW5ndGggPj0gMTYgJiYgdGhpcy5fZnJlZS5sZW5ndGggPT09IHRoaXMuX3JlcXMubGVuZ3RoKSB7CiAgICAgIHRoaXMuX2ZyZWUgPSBbXQogICAgICB0aGlzLl9yZXFzID0gW10KICAgIH0KICB9CgogIF9vbm1lc3NhZ2UobGVuLCBwb3J0LCBob3N0LCBmYW1pbHkpIHsKICAgIHRoaXMuZW1pdCgnbWVzc2FnZScsIHRoaXMudWR4Ll9jb25zdW1lTWVzc2FnZShsZW4pLCB7IGhvc3QsIGZhbWlseSwgcG9ydCB9KQogICAgcmV0dXJuIHRoaXMudWR4Ll9idWZmZXIKICB9CgogIF9vbmNsb3NlKCkgewogICAgdGhpcy5lbWl0KCdjbG9zZScpCiAgfQoKICBfcmVhbGxvY01lc3NhZ2UoKSB7CiAgICByZXR1cm4gdGhpcy51ZHguX3JlYWxsb2NNZXNzYWdlKCkKICB9CgogIF9vbmlkbGUoKSB7CiAgICB0aGlzLmVtaXQoJ2lkbGUnKQogIH0KCiAgX29uYnVzeSgpIHsKICAgIHRoaXMuZW1pdCgnYnVzeScpCiAgfQoKICBfYWRkU3RyZWFtKHN0cmVhbSkgewogICAgaWYgKHRoaXMuc3RyZWFtcy5oYXMoc3RyZWFtKSkgcmV0dXJuIGZhbHNlCiAgICB0aGlzLnN0cmVhbXMuYWRkKHN0cmVhbSkKICAgIGlmICh0aGlzLnN0cmVhbXMuc2l6ZSA9PT0gMSkgdGhpcy5fb25idXN5KCkKICAgIHJldHVybiB0cnVlCiAgfQoKICBfcmVtb3ZlU3RyZWFtKHN0cmVhbSkgewogICAgaWYgKCF0aGlzLnN0cmVhbXMuaGFzKHN0cmVhbSkpIHJldHVybiBmYWxzZQogICAgdGhpcy5zdHJlYW1zLmRlbGV0ZShzdHJlYW0pCiAgICBjb25zdCBjbG9zZWQgPSB0aGlzLl9jbG9zZU1heWJlKCkKICAgIGlmICh0aGlzLmlkbGUgJiYgIWNsb3NlZCkgdGhpcy5fb25pZGxlKCkKICAgIHJldHVybiB0cnVlCiAgfQoKICBhZGRyZXNzKCkgewogICAgaWYgKCF0aGlzLmJvdW5kKSByZXR1cm4gbnVsbAogICAgcmV0dXJuIHsgaG9zdDogdGhpcy5faG9zdCwgZmFtaWx5OiB0aGlzLl9mYW1pbHksIHBvcnQ6IHRoaXMuX3BvcnQgfQogIH0KCiAgYmluZChwb3J0LCBob3N0KSB7CiAgICBpZiAodGhpcy5ib3VuZCkgdGhyb3cgbmV3IEVycm9yKCdBbHJlYWR5IGJvdW5kJykKICAgIGlmICh0aGlzLmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignU29ja2V0IGlzIGNsb3NlZCcpCgogICAgaWYgKCFwb3J0KSBwb3J0ID0gMAoKICAgIGxldCBmbGFncyA9IDAKICAgIGlmICh0aGlzLl9pcHY2T25seSkgZmxhZ3MgfD0gYmluZGluZy5VVl9VRFBfSVBWNk9OTFkKICAgIGlmICh0aGlzLl9yZXVzZUFkZHJlc3MpIGZsYWdzIHw9IGJpbmRpbmcuVVZfVURQX1JFVVNFQUREUgoKICAgIGxldCBmYW1pbHkKCiAgICBpZiAoaG9zdCkgewogICAgICBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICAgIGlmICghZmFtaWx5KSB0aHJvdyBuZXcgRXJyb3IoYCR7aG9zdH0gaXMgbm90IGEgdmFsaWQgSVAgYWRkcmVzc2ApCgogICAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhpcy5faW5pdCgpCgogICAgICB0aGlzLl9wb3J0ID0gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfYmluZCh0aGlzLl9oYW5kbGUsIHBvcnQsIGhvc3QsIGZhbWlseSwgZmxhZ3MpCiAgICB9IGVsc2UgewogICAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhpcy5faW5pdCgpCgogICAgICB0cnkgewogICAgICAgIGhvc3QgPSAnOjonCiAgICAgICAgZmFtaWx5ID0gNgogICAgICAgIHRoaXMuX3BvcnQgPSBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9iaW5kKHRoaXMuX2hhbmRsZSwgcG9ydCwgaG9zdCwgZmFtaWx5LCBmbGFncykKICAgICAgfSBjYXRjaCB7CiAgICAgICAgaG9zdCA9ICcwLjAuMC4wJwogICAgICAgIGZhbWlseSA9IDQKICAgICAgICB0aGlzLl9wb3J0ID0gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfYmluZCh0aGlzLl9oYW5kbGUsIHBvcnQsIGhvc3QsIGZhbWlseSwgZmxhZ3MpCiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9ob3N0ID0gaG9zdAogICAgdGhpcy5fZmFtaWx5ID0gZmFtaWx5CgogICAgdGhpcy5lbWl0KCdsaXN0ZW5pbmcnKQogIH0KCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5fY2xvc2luZykgcmV0dXJuIHRoaXMuX2Nsb3NpbmcKICAgIHRoaXMuX2Nsb3NpbmcgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gdGhpcy5vbmNlKCdjbG9zZScsIHJlc29sdmUpKQogICAgdGhpcy5fY2xvc2VNYXliZSgpCiAgICByZXR1cm4gdGhpcy5fY2xvc2luZwogIH0KCiAgX2Nsb3NlTWF5YmUoKSB7CiAgICBpZiAodGhpcy5fY2xvc2VkIHx8IHRoaXMuX2Nsb3NpbmcgPT09IG51bGwpIHJldHVybiB0aGlzLl9jbG9zZWQKCiAgICBpZiAoIXRoaXMuX2luaXRlZCkgewogICAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCiAgICAgIHRoaXMuZW1pdCgnY2xvc2UnKQogICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGlmICh0aGlzLmlkbGUpIHsKICAgICAgYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfY2xvc2UodGhpcy5faGFuZGxlKQogICAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCiAgICB9CgogICAgcmV0dXJuIHRoaXMuX2Nsb3NlZAogIH0KCiAgc2V0VFRMKHR0bCkgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X3R0bCh0aGlzLl9oYW5kbGUsIHR0bCkKICB9CgogIGdldFJlY3ZCdWZmZXJTaXplKCkgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X2dldF9yZWN2X2J1ZmZlcl9zaXplKHRoaXMuX2hhbmRsZSkKICB9CgogIHNldFJlY3ZCdWZmZXJTaXplKHNpemUpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZXRfcmVjdl9idWZmZXJfc2l6ZSh0aGlzLl9oYW5kbGUsIHNpemUpCiAgfQoKICBnZXRTZW5kQnVmZmVyU2l6ZSgpIHsKICAgIGlmICghdGhpcy5faW5pdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBub3QgYWN0aXZlJykKICAgIHJldHVybiBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9nZXRfc2VuZF9idWZmZXJfc2l6ZSh0aGlzLl9oYW5kbGUpCiAgfQoKICBzZXRTZW5kQnVmZmVyU2l6ZShzaXplKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X3NlbmRfYnVmZmVyX3NpemUodGhpcy5faGFuZGxlLCBzaXplKQogIH0KCiAgYWRkTWVtYmVyc2hpcChncm91cCwgaWZhY2VBZGRyZXNzKSB7CiAgICBpZiAoIXRoaXMuX2luaXRlZCkgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgbm90IGFjdGl2ZScpCiAgICByZXR1cm4gYmluZGluZy51ZHhfbmFwaV9zb2NrZXRfc2V0X21lbWJlcnNoaXAodGhpcy5faGFuZGxlLCBncm91cCwgaWZhY2VBZGRyZXNzIHx8ICcnLCB0cnVlKQogIH0KCiAgZHJvcE1lbWJlcnNoaXAoZ3JvdXAsIGlmYWNlQWRkcmVzcykgewogICAgaWYgKCF0aGlzLl9pbml0ZWQpIHRocm93IG5ldyBFcnJvcignU29ja2V0IG5vdCBhY3RpdmUnKQogICAgcmV0dXJuIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NldF9tZW1iZXJzaGlwKHRoaXMuX2hhbmRsZSwgZ3JvdXAsIGlmYWNlQWRkcmVzcyB8fCAnJywgZmFsc2UpCiAgfQoKICBhc3luYyBzZW5kKGJ1ZmZlciwgcG9ydCwgaG9zdCwgdHRsKSB7CiAgICBpZiAodGhpcy5jbG9zaW5nKSByZXR1cm4gZmFsc2UKCiAgICBpZiAoIWhvc3QpIGhvc3QgPSAnMTI3LjAuMC4xJwoKICAgIGNvbnN0IGZhbWlseSA9IGlwLmlzSVAoaG9zdCkKICAgIGlmICghZmFtaWx5KSB0aHJvdyBuZXcgRXJyb3IoYCR7aG9zdH0gaXMgbm90IGEgdmFsaWQgSVAgYWRkcmVzc2ApCgogICAgaWYgKCF0aGlzLmJvdW5kKSB0aGlzLmJpbmQoMCkKCiAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jU2VuZCgpCiAgICBjb25zdCByZXEgPSB0aGlzLl9yZXFzW2lkXQoKICAgIHJlcS5idWZmZXIgPSBidWZmZXIKCiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgcmVxLm9uZmx1c2ggPSByZXNvbHZlCiAgICB9KQoKICAgIGJpbmRpbmcudWR4X25hcGlfc29ja2V0X3NlbmRfdHRsKAogICAgICB0aGlzLl9oYW5kbGUsCiAgICAgIHJlcS5oYW5kbGUsCiAgICAgIGlkLAogICAgICBidWZmZXIsCiAgICAgIHBvcnQsCiAgICAgIGhvc3QsCiAgICAgIGZhbWlseSwKICAgICAgdHRsIHx8IDAKICAgICkKCiAgICByZXR1cm4gcHJvbWlzZQogIH0KCiAgdHJ5U2VuZChidWZmZXIsIHBvcnQsIGhvc3QsIHR0bCkgewogICAgaWYgKHRoaXMuY2xvc2luZykgcmV0dXJuCgogICAgaWYgKCFob3N0KSBob3N0ID0gJzEyNy4wLjAuMScKCiAgICBjb25zdCBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICBpZiAoIWZhbWlseSkgdGhyb3cgbmV3IEVycm9yKGAke2hvc3R9IGlzIG5vdCBhIHZhbGlkIElQIGFkZHJlc3NgKQoKICAgIGlmICghdGhpcy5ib3VuZCkgdGhpcy5iaW5kKDApCgogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1NlbmQoKQogICAgY29uc3QgcmVxID0gdGhpcy5fcmVxc1tpZF0KCiAgICByZXEuYnVmZmVyID0gYnVmZmVyCiAgICByZXEub25mbHVzaCA9IG5vb3AKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3NvY2tldF9zZW5kX3R0bCgKICAgICAgdGhpcy5faGFuZGxlLAogICAgICByZXEuaGFuZGxlLAogICAgICBpZCwKICAgICAgYnVmZmVyLAogICAgICBwb3J0LAogICAgICBob3N0LAogICAgICBmYW1pbHksCiAgICAgIHR0bCB8fCAwCiAgICApCiAgfQoKICBfYWxsb2NTZW5kKCkgewogICAgaWYgKHRoaXMuX2ZyZWUubGVuZ3RoID4gMCkgcmV0dXJuIHRoaXMuX2ZyZWUucG9wKCkKICAgIGNvbnN0IGhhbmRsZSA9IGI0YS5hbGxvY1Vuc2FmZShiaW5kaW5nLnNpemVvZl91ZHhfc29ja2V0X3NlbmRfdCkKICAgIHJldHVybiB0aGlzLl9yZXFzLnB1c2goeyBoYW5kbGUsIGJ1ZmZlcjogbnVsbCwgb25mbHVzaDogbnVsbCB9KSAtIDEKICB9Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQpjb25zdCBzdHJlYW14ID0gcmVxdWlyZSgnc3RyZWFteCcpCmNvbnN0IGI0YSA9IHJlcXVpcmUoJ2I0YScpCmNvbnN0IGJpbmRpbmcgPSByZXF1aXJlKCcuLi9iaW5kaW5nJykKY29uc3QgaXAgPSByZXF1aXJlKCcuL2lwJykKCmNvbnN0IE1BWF9QQUNLRVQgPSAyMDQ4CmNvbnN0IEJVRkZFUl9TSVpFID0gNjU1MzYgKyBNQVhfUEFDS0VUCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVEWFN0cmVhbSBleHRlbmRzIHN0cmVhbXguRHVwbGV4IHsKICBjb25zdHJ1Y3Rvcih1ZHgsIGlkLCBvcHRzID0ge30pIHsKICAgIHN1cGVyKHsgbWFwV3JpdGFibGU6IHRvQnVmZmVyLCBlYWdlck9wZW46IHRydWUgfSkKCiAgICB0aGlzLnVkeCA9IHVkeAogICAgdGhpcy5zb2NrZXQgPSBudWxsCgogICAgdGhpcy5faGFuZGxlID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX3N0cmVhbV90KQogICAgdGhpcy5fdmlldyA9IG5ldyBVaW50MzJBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDIKICAgICkKICAgIHRoaXMuX3ZpZXcxNiA9IG5ldyBVaW50MTZBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDEKICAgICkKICAgIHRoaXMuX3ZpZXc2NCA9IG5ldyBCaWdVaW50NjRBcnJheSgKICAgICAgdGhpcy5faGFuZGxlLmJ1ZmZlciwKICAgICAgdGhpcy5faGFuZGxlLmJ5dGVPZmZzZXQsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlTGVuZ3RoID4+IDMKICAgICkKCiAgICB0aGlzLl93cmVxcyA9IFtdCiAgICB0aGlzLl93ZnJlZSA9IFtdCgogICAgdGhpcy5fc3JlcXMgPSBbXQogICAgdGhpcy5fc2ZyZWUgPSBbXQogICAgdGhpcy5fY2xvc2VkID0gZmFsc2UKCiAgICB0aGlzLl9mbHVzaGluZyA9IDAKICAgIHRoaXMuX2ZsdXNoZXMgPSBbXQoKICAgIHRoaXMuX2J1ZmZlciA9IG51bGwKICAgIHRoaXMuX3JlYWxsb2NEYXRhKCkKCiAgICB0aGlzLl9vbndyaXRlID0gbnVsbAogICAgdGhpcy5fb25kZXN0cm95ID0gbnVsbAogICAgdGhpcy5fZmlyZXdhbGwgPSBvcHRzLmZpcmV3YWxsIHx8IGZpcmV3YWxsQWxsCgogICAgdGhpcy5fcmVtb3RlQ2hhbmdpbmcgPSBudWxsCiAgICB0aGlzLl9wcmV2aW91c1NvY2tldCA9IG51bGwKCiAgICB0aGlzLmlkID0gaWQKICAgIHRoaXMucmVtb3RlSWQgPSAwCiAgICB0aGlzLnJlbW90ZUhvc3QgPSBudWxsCiAgICB0aGlzLnJlbW90ZUZhbWlseSA9IDAKICAgIHRoaXMucmVtb3RlUG9ydCA9IDAKCiAgICB0aGlzLnVzZXJEYXRhID0gbnVsbAoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX2luaXQoCiAgICAgIHRoaXMudWR4Ll9oYW5kbGUsCiAgICAgIHRoaXMuX2hhbmRsZSwKICAgICAgaWQsCiAgICAgIG9wdHMuZnJhbWVkID8gMSA6IDAsCiAgICAgIHRoaXMsCiAgICAgIHRoaXMuX29uZGF0YSwKICAgICAgdGhpcy5fb25lbmQsCiAgICAgIHRoaXMuX29uZHJhaW4sCiAgICAgIHRoaXMuX29uYWNrLAogICAgICB0aGlzLl9vbnNlbmQsCiAgICAgIHRoaXMuX29ubWVzc2FnZSwKICAgICAgdGhpcy5fb25jbG9zZSwKICAgICAgdGhpcy5fb25maXJld2FsbCwKICAgICAgdGhpcy5fb25yZW1vdGVjaGFuZ2VkLAogICAgICB0aGlzLl9yZWFsbG9jRGF0YSwKICAgICAgdGhpcy5fcmVhbGxvY01lc3NhZ2UKICAgICkKCiAgICBpZiAob3B0cy5zZXEpIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3NldF9zZXEodGhpcy5faGFuZGxlLCBvcHRzLnNlcSkKCiAgICBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9yZWN2X3N0YXJ0KHRoaXMuX2hhbmRsZSwgdGhpcy5fYnVmZmVyKQogIH0KCiAgZ2V0IGNvbm5lY3RlZCgpIHsKICAgIHJldHVybiB0aGlzLnNvY2tldCAhPT0gbnVsbAogIH0KCiAgZ2V0IG10dSgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3MTZbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3RfbXR1ID4+IDFdCiAgfQoKICBnZXQgcnR0KCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXdbYmluZGluZy5vZmZzZXRvZl91ZHhfc3RyZWFtX3Rfc3J0dCA+PiAyXQogIH0KCiAgZ2V0IGN3bmQoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlld1tiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9jd25kID4+IDJdCiAgfQoKICBnZXQgcnRvQ291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzE2W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3J0b19jb3VudCA+PiAxXQogIH0KCiAgZ2V0IHJldHJhbnNtaXRzKCkgewogICAgcmV0dXJuIHRoaXMuX3ZpZXcxNltiaW5kaW5nLm9mZnNldG9mX3VkeF9zdHJlYW1fdF9yZXRyYW5zbWl0X2NvdW50ID4+IDFdCiAgfQoKICBnZXQgZmFzdFJlY292ZXJpZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzE2W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2Zhc3RfcmVjb3ZlcnlfY291bnQgPj4gMV0KICB9CgogIGdldCBpbmZsaWdodCgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2luZmxpZ2h0ID4+IDJdCiAgfQoKICBnZXQgYnl0ZXNUcmFuc21pdHRlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2J5dGVzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNUcmFuc21pdHRlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3BhY2tldHNfdHggPj4gM10pCiAgfQoKICBnZXQgYnl0ZXNSZWNlaXZlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X2J5dGVzX3J4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNSZWNlaXZlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3N0cmVhbV90X3BhY2tldHNfcnggPj4gM10pCiAgfQoKICBnZXQgbG9jYWxIb3N0KCkgewogICAgcmV0dXJuIHRoaXMuc29ja2V0ID8gdGhpcy5zb2NrZXQuYWRkcmVzcygpLmhvc3QgOiBudWxsCiAgfQoKICBnZXQgbG9jYWxGYW1pbHkoKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQgPyB0aGlzLnNvY2tldC5hZGRyZXNzKCkuZmFtaWx5IDogMAogIH0KCiAgZ2V0IGxvY2FsUG9ydCgpIHsKICAgIHJldHVybiB0aGlzLnNvY2tldCA/IHRoaXMuc29ja2V0LmFkZHJlc3MoKS5wb3J0IDogMAogIH0KCiAgc2V0SW50ZXJhY3RpdmUoYm9vbCkgewogICAgaWYgKCF0aGlzLl9jbG9zZWQpIHJldHVybgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2V0X21vZGUodGhpcy5faGFuZGxlLCBib29sID8gMCA6IDEpCiAgfQoKICBjb25uZWN0KHNvY2tldCwgcmVtb3RlSWQsIHBvcnQsIGhvc3QsIG9wdHMgPSB7fSkgewogICAgaWYgKHRoaXMuX2Nsb3NlZCkgcmV0dXJuCgogICAgaWYgKHRoaXMuY29ubmVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ0FscmVhZHkgY29ubmVjdGVkJykKICAgIGlmIChzb2NrZXQuY2xvc2luZykgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgaXMgY2xvc2VkJykKCiAgICBpZiAodHlwZW9mIGhvc3QgPT09ICdvYmplY3QnKSB7CiAgICAgIG9wdHMgPSBob3N0CiAgICAgIGhvc3QgPSBudWxsCiAgICB9CgogICAgaWYgKCFob3N0KSBob3N0ID0gJzEyNy4wLjAuMScKCiAgICBjb25zdCBmYW1pbHkgPSBpcC5pc0lQKGhvc3QpCiAgICBpZiAoIWZhbWlseSkgdGhyb3cgbmV3IEVycm9yKGAke2hvc3R9IGlzIG5vdCBhIHZhbGlkIElQIGFkZHJlc3NgKQogICAgaWYgKCEocG9ydCA+IDAgJiYgcG9ydCA8IDY1NTM2KSkgdGhyb3cgbmV3IEVycm9yKGAke3BvcnR9IGlzIG5vdCBhIHZhbGlkIHBvcnRgKQoKICAgIGlmICghc29ja2V0LmJvdW5kKSBzb2NrZXQuYmluZCgwKQoKICAgIHRoaXMucmVtb3RlSWQgPSByZW1vdGVJZAogICAgdGhpcy5yZW1vdGVQb3J0ID0gcG9ydAogICAgdGhpcy5yZW1vdGVIb3N0ID0gaG9zdAogICAgdGhpcy5yZW1vdGVGYW1pbHkgPSBmYW1pbHkKICAgIHRoaXMuc29ja2V0ID0gc29ja2V0CgogICAgaWYgKG9wdHMuYWNrKSBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV9zZXRfYWNrKHRoaXMuX2hhbmRsZSwgb3B0cy5hY2spCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fY29ubmVjdCh0aGlzLl9oYW5kbGUsIHNvY2tldC5faGFuZGxlLCByZW1vdGVJZCwgcG9ydCwgaG9zdCwgZmFtaWx5KQoKICAgIHRoaXMuc29ja2V0Ll9hZGRTdHJlYW0odGhpcykKCiAgICB0aGlzLmVtaXQoJ2Nvbm5lY3QnKQogIH0KCiAgY2hhbmdlUmVtb3RlKHNvY2tldCwgcmVtb3RlSWQsIHBvcnQsIGhvc3QpIHsKICAgIGlmICh0aGlzLl9yZW1vdGVDaGFuZ2luZykgdGhyb3cgbmV3IEVycm9yKCdSZW1vdGUgYWxyZWFkeSBjaGFuZ2luZycpCgogICAgaWYgKCF0aGlzLmNvbm5lY3RlZCkgdGhyb3cgbmV3IEVycm9yKCdOb3QgeWV0IGNvbm5lY3RlZCcpCiAgICBpZiAoc29ja2V0LmNsb3NpbmcpIHRocm93IG5ldyBFcnJvcignU29ja2V0IGlzIGNsb3NlZCcpCgogICAgaWYgKHRoaXMuc29ja2V0LnVkeCAhPT0gc29ja2V0LnVkeCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjaGFuZ2UgdG8gYSBzb2NrZXQgb24gYW5vdGhlciBVRFggaW5zdGFuY2UnKQogICAgfQoKICAgIGlmICghaG9zdCkgaG9zdCA9ICcxMjcuMC4wLjEnCgogICAgY29uc3QgZmFtaWx5ID0gaXAuaXNJUChob3N0KQogICAgaWYgKCFmYW1pbHkpIHRocm93IG5ldyBFcnJvcihgJHtob3N0fSBpcyBub3QgYSB2YWxpZCBJUCBhZGRyZXNzYCkKICAgIGlmICghKHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikpIHRocm93IG5ldyBFcnJvcihgJHtwb3J0fSBpcyBub3QgYSB2YWxpZCBwb3J0YCkKCiAgICBpZiAodGhpcy5zb2NrZXQgIT09IHNvY2tldCkgdGhpcy5fcHJldmlvdXNTb2NrZXQgPSB0aGlzLnNvY2tldAoKICAgIHRoaXMucmVtb3RlSWQgPSByZW1vdGVJZAogICAgdGhpcy5yZW1vdGVQb3J0ID0gcG9ydAogICAgdGhpcy5yZW1vdGVIb3N0ID0gaG9zdAogICAgdGhpcy5yZW1vdGVGYW1pbHkgPSBmYW1pbHkKICAgIHRoaXMuc29ja2V0ID0gc29ja2V0CgogICAgdGhpcy5fcmVtb3RlQ2hhbmdpbmcgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IG9uY2hhbmdlZCA9ICgpID0+IHsKICAgICAgICB0aGlzLm9mZignY2xvc2UnLCBvbmNsb3NlKQogICAgICAgIHJlc29sdmUoKQogICAgICB9CgogICAgICBjb25zdCBvbmNsb3NlID0gKCkgPT4gewogICAgICAgIHRoaXMub2ZmKCdyZW1vdGUtY2hhbmdlZCcsIG9uY2hhbmdlZCkKICAgICAgICByZWplY3QobmV3IEVycm9yKCdTdHJlYW0gaXMgY2xvc2VkJykpCiAgICAgIH0KCiAgICAgIHRoaXMub25jZSgncmVtb3RlLWNoYW5nZWQnLCBvbmNoYW5nZWQpLm9uY2UoJ2Nsb3NlJywgb25jbG9zZSkKICAgIH0pCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fY2hhbmdlX3JlbW90ZSgKICAgICAgdGhpcy5faGFuZGxlLAogICAgICBzb2NrZXQuX2hhbmRsZSwKICAgICAgcmVtb3RlSWQsCiAgICAgIHBvcnQsCiAgICAgIGhvc3QsCiAgICAgIGZhbWlseQogICAgKQoKICAgIHRoaXMuc29ja2V0Ll9hZGRTdHJlYW0odGhpcykKCiAgICByZXR1cm4gdGhpcy5fcmVtb3RlQ2hhbmdpbmcKICB9CgogIHJlbGF5VG8oZGVzdGluYXRpb24pIHsKICAgIGlmICh0aGlzLl9jbG9zZWQpIHJldHVybgoKICAgIGJpbmRpbmcudWR4X25hcGlfc3RyZWFtX3JlbGF5X3RvKHRoaXMuX2hhbmRsZSwgZGVzdGluYXRpb24uX2hhbmRsZSkKICB9CgogIGFzeW5jIHNlbmQoYnVmZmVyKSB7CiAgICBpZiAoIXRoaXMuY29ubmVjdGVkIHx8IHRoaXMuX2Nsb3NlZCkgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1NlbmQoKQogICAgY29uc3QgcmVxID0gdGhpcy5fc3JlcXNbaWRdCgogICAgcmVxLmJ1ZmZlciA9IGJ1ZmZlcgoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICByZXEub25mbHVzaCA9IHJlc29sdmUKICAgIH0pCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2VuZCh0aGlzLl9oYW5kbGUsIHJlcS5oYW5kbGUsIGlkLCBidWZmZXIpCgogICAgcmV0dXJuIHByb21pc2UKICB9CgogIHRyeVNlbmQoYnVmZmVyKSB7CiAgICBpZiAoIXRoaXMuY29ubmVjdGVkIHx8IHRoaXMuX2Nsb3NlZCkgcmV0dXJuCgogICAgY29uc3QgaWQgPSB0aGlzLl9hbGxvY1NlbmQoKQogICAgY29uc3QgcmVxID0gdGhpcy5fc3JlcXNbaWRdCgogICAgcmVxLmJ1ZmZlciA9IGJ1ZmZlcgogICAgcmVxLm9uZmx1c2ggPSBub29wCgogICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fc2VuZCh0aGlzLl9oYW5kbGUsIHJlcS5oYW5kbGUsIGlkLCBidWZmZXIpCiAgfQoKICBhc3luYyBmbHVzaCgpIHsKICAgIGlmICgoYXdhaXQgc3RyZWFteC5Xcml0YWJsZS5kcmFpbmVkKHRoaXMpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZQogICAgaWYgKHRoaXMuZGVzdHJveWluZykgcmV0dXJuIGZhbHNlCgogICAgY29uc3QgbWlzc2luZyA9IHRoaXMuX3dyZXFzLmxlbmd0aCAtIHRoaXMuX3dmcmVlLmxlbmd0aAogICAgaWYgKG1pc3NpbmcgPT09IDApIHJldHVybiB0cnVlCgogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHRoaXMuX2ZsdXNoZXMucHVzaCh7IGZsdXNoOiB0aGlzLl9mbHVzaGluZysrLCBtaXNzaW5nLCByZXNvbHZlIH0pCiAgICB9KQogIH0KCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgaWQ6IHRoaXMuaWQsCiAgICAgIGNvbm5lY3RlZDogdGhpcy5jb25uZWN0ZWQsCiAgICAgIGRlc3Ryb3lpbmc6IHRoaXMuZGVzdHJveWluZywKICAgICAgZGVzdHJveWVkOiB0aGlzLmRlc3Ryb3llZCwKICAgICAgcmVtb3RlSWQ6IHRoaXMucmVtb3RlSWQsCiAgICAgIHJlbW90ZUhvc3Q6IHRoaXMucmVtb3RlSG9zdCwKICAgICAgcmVtb3RlRmFtaWx5OiB0aGlzLnJlbW90ZUZhbWlseSwKICAgICAgcmVtb3RlUG9ydDogdGhpcy5yZW1vdGVQb3J0LAogICAgICBtdHU6IHRoaXMubXR1LAogICAgICBydHQ6IHRoaXMucnR0LAogICAgICBjd25kOiB0aGlzLmN3bmQsCiAgICAgIGluZmxpZ2h0OiB0aGlzLmluZmxpZ2h0LAogICAgICBzb2NrZXQ6IHRoaXMuc29ja2V0ID8gdGhpcy5zb2NrZXQudG9KU09OKCkgOiBudWxsCiAgICB9CiAgfQoKICBfcmVhZChjYikgewogICAgY2IobnVsbCkKICB9CgogIF93cml0ZUNvbnRpbnVlKGVycikgewogICAgaWYgKHRoaXMuX29ud3JpdGUgPT09IG51bGwpIHJldHVybgogICAgY29uc3QgY2IgPSB0aGlzLl9vbndyaXRlCiAgICB0aGlzLl9vbndyaXRlID0gbnVsbAogICAgY2IoZXJyKQogIH0KCiAgX2Rlc3Ryb3lDb250aW51ZShlcnIpIHsKICAgIGlmICh0aGlzLl9vbmRlc3Ryb3kgPT09IG51bGwpIHJldHVybgogICAgY29uc3QgY2IgPSB0aGlzLl9vbmRlc3Ryb3kKICAgIHRoaXMuX29uZGVzdHJveSA9IG51bGwKICAgIGNiKGVycikKICB9CgogIF93cml0ZXYoYnVmZmVycywgY2IpIHsKICAgIGlmICghdGhpcy5jb25uZWN0ZWQpCiAgICAgIHRocm93IGN1c3RvbUVycm9yKCdXcml0aW5nIHdoaWxlIG5vdCBjb25uZWN0ZWQgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQnLCAnRVJSX0FTU0VSVElPTicpCgogICAgbGV0IGRyYWluZWQgPSB0cnVlCgogICAgaWYgKGJ1ZmZlcnMubGVuZ3RoID09PSAxKSB7CiAgICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NXcml0ZSgxKQogICAgICBjb25zdCByZXEgPSB0aGlzLl93cmVxc1tpZF0KCiAgICAgIHJlcS5mbHVzaCA9IHRoaXMuX2ZsdXNoaW5nCiAgICAgIHJlcS5idWZmZXIgPSBidWZmZXJzWzBdCgogICAgICBkcmFpbmVkID0gYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGUodGhpcy5faGFuZGxlLCByZXEuaGFuZGxlLCBpZCwgcmVxLmJ1ZmZlcikgIT09IDAKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGlkID0gdGhpcy5fYWxsb2NXcml0ZShuZXh0QmF0Y2hTaXplKGJ1ZmZlcnMubGVuZ3RoKSkKICAgICAgY29uc3QgcmVxID0gdGhpcy5fd3JlcXNbaWRdCgogICAgICByZXEuZmx1c2ggPSB0aGlzLl9mbHVzaGluZwogICAgICByZXEuYnVmZmVycyA9IGJ1ZmZlcnMKCiAgICAgIGRyYWluZWQgPSBiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV93cml0ZXYodGhpcy5faGFuZGxlLCByZXEuaGFuZGxlLCBpZCwgcmVxLmJ1ZmZlcnMpICE9PSAwCiAgICB9CgogICAgaWYgKGRyYWluZWQpIGNiKG51bGwpCiAgICBlbHNlIHRoaXMuX29ud3JpdGUgPSBjYgogIH0KCiAgX2ZpbmFsKGNiKSB7CiAgICBjb25zdCBpZCA9IHRoaXMuX2FsbG9jV3JpdGUoMSkKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3dyZXFzW2lkXQoKICAgIHJlcS5mbHVzaCA9IHRoaXMuX2ZsdXNoZXMKICAgIHJlcS5idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoMCkKCiAgICBjb25zdCBkcmFpbmVkID0KICAgICAgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGVfZW5kKHRoaXMuX2hhbmRsZSwgcmVxLmhhbmRsZSwgaWQsIHJlcS5idWZmZXIpICE9PSAwCgogICAgaWYgKGRyYWluZWQpIGNiKG51bGwpCiAgICBlbHNlIHRoaXMuX29ud3JpdGUgPSBjYgogIH0KCiAgX3ByZWRlc3Ryb3koKSB7CiAgICBpZiAoIXRoaXMuX2Nsb3NlZCkgYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fZGVzdHJveSh0aGlzLl9oYW5kbGUpCiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlCiAgICB0aGlzLl93cml0ZUNvbnRpbnVlKG51bGwpCiAgfQoKICBfZGVzdHJveShjYikgewogICAgaWYgKHRoaXMuY29ubmVjdGVkKSB0aGlzLl9vbmRlc3Ryb3kgPSBjYgogICAgZWxzZSBjYihudWxsKQogIH0KCiAgX29uZGF0YShyZWFkKSB7CiAgICB0aGlzLnB1c2godGhpcy5fY29uc3VtZURhdGEocmVhZCkpCiAgICByZXR1cm4gdGhpcy5fYnVmZmVyCiAgfQoKICBfb25lbmQocmVhZCkgewogICAgaWYgKHJlYWQgPiAwKSB0aGlzLnB1c2godGhpcy5fY29uc3VtZURhdGEocmVhZCkpCiAgICB0aGlzLnB1c2gobnVsbCkKICB9CgogIF9vbmRyYWluKCkgewogICAgdGhpcy5fd3JpdGVDb250aW51ZShudWxsKQogIH0KCiAgX2ZsdXNoQWNrKGZsdXNoKSB7CiAgICBmb3IgKGxldCBpID0gdGhpcy5fZmx1c2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBmID0gdGhpcy5fZmx1c2hlc1tpXQogICAgICBpZiAoZi5mbHVzaCA8IGZsdXNoKSBicmVhawogICAgICBmLm1pc3NpbmctLQogICAgfQoKICAgIHdoaWxlICh0aGlzLl9mbHVzaGVzLmxlbmd0aCA+IDAgJiYgdGhpcy5fZmx1c2hlc1swXS5taXNzaW5nID09PSAwKSB7CiAgICAgIHRoaXMuX2ZsdXNoZXMuc2hpZnQoKS5yZXNvbHZlKHRydWUpCiAgICB9CiAgfQoKICBfb25hY2soaWQpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3dyZXFzW2lkXQoKICAgIHJlcS5idWZmZXJzID0gcmVxLmJ1ZmZlciA9IG51bGwKICAgIHRoaXMuX3dmcmVlLnB1c2goaWQpCgogICAgaWYgKHRoaXMuX2ZsdXNoZXMubGVuZ3RoID4gMCkgdGhpcy5fZmx1c2hBY2socmVxLmZsdXNoKQoKICAgIC8vIGdjIHRoZSBmcmVlIGxpc3QKICAgIGlmICh0aGlzLl93ZnJlZS5sZW5ndGggPj0gNjQgJiYgdGhpcy5fd2ZyZWUubGVuZ3RoID09PSB0aGlzLl93cmVxcy5sZW5ndGgpIHsKICAgICAgdGhpcy5fd2ZyZWUgPSBbXQogICAgICB0aGlzLl93cmVxcyA9IFtdCiAgICB9CiAgfQoKICBfb25zZW5kKGlkLCBlcnIpIHsKICAgIGNvbnN0IHJlcSA9IHRoaXMuX3NyZXFzW2lkXQoKICAgIGNvbnN0IG9uZmx1c2ggPSByZXEub25mbHVzaAoKICAgIHJlcS5idWZmZXIgPSBudWxsCiAgICByZXEub25mbHVzaCA9IG51bGwKCiAgICB0aGlzLl9zZnJlZS5wdXNoKGlkKQoKICAgIG9uZmx1c2goZXJyID49IDApCgogICAgLy8gZ2MgdGhlIGZyZWUgbGlzdAogICAgaWYgKHRoaXMuX3NmcmVlLmxlbmd0aCA+PSAxNiAmJiB0aGlzLl9zZnJlZS5sZW5ndGggPT09IHRoaXMuX3NyZXFzLmxlbmd0aCkgewogICAgICB0aGlzLl9zZnJlZSA9IFtdCiAgICAgIHRoaXMuX3NyZXFzID0gW10KICAgIH0KICB9CgogIF9vbm1lc3NhZ2UobGVuKSB7CiAgICB0aGlzLmVtaXQoJ21lc3NhZ2UnLCB0aGlzLnVkeC5fY29uc3VtZU1lc3NhZ2UobGVuKSkKICAgIHJldHVybiB0aGlzLnVkeC5fYnVmZmVyCiAgfQoKICBfb25jbG9zZShlcnIpIHsKICAgIHRoaXMuX2Nsb3NlZCA9IHRydWUKCiAgICBpZiAodGhpcy5zb2NrZXQpIHsKICAgICAgdGhpcy5zb2NrZXQuX3JlbW92ZVN0cmVhbSh0aGlzKQogICAgICB0aGlzLnNvY2tldCA9IG51bGwKICAgIH0KCiAgICBpZiAodGhpcy5fcHJldmlvdXNTb2NrZXQpIHsKICAgICAgdGhpcy5fcHJldmlvdXNTb2NrZXQuX3JlbW92ZVN0cmVhbSh0aGlzKQogICAgICB0aGlzLl9wcmV2aW91c1NvY2tldCA9IG51bGwKICAgIH0KCiAgICAvLyBubyBlcnJvciwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgaWYgKCFlcnIpIHJldHVybiB0aGlzLl9kZXN0cm95Q29udGludWUobnVsbCkKCiAgICBpZiAodGhpcy5fb25kZXN0cm95ID09PSBudWxsKSB0aGlzLmRlc3Ryb3koZXJyKQogICAgZWxzZSB0aGlzLl9kZXN0cm95Q29udGludWUoZXJyKQogIH0KCiAgX29uZmlyZXdhbGwoc29ja2V0LCBwb3J0LCBob3N0LCBmYW1pbHkpIHsKICAgIHJldHVybiB0aGlzLl9maXJld2FsbChzb2NrZXQsIHBvcnQsIGhvc3QsIGZhbWlseSkgPyAxIDogMAogIH0KCiAgX29ucmVtb3RlY2hhbmdlZCgpIHsKICAgIGlmICh0aGlzLl9wcmV2aW91c1NvY2tldCkgewogICAgICB0aGlzLl9wcmV2aW91c1NvY2tldC5fcmVtb3ZlU3RyZWFtKHRoaXMpCiAgICAgIHRoaXMuX3ByZXZpb3VzU29ja2V0ID0gbnVsbAogICAgfQoKICAgIHRoaXMuX3JlbW90ZUNoYW5naW5nID0gbnVsbAogICAgdGhpcy5lbWl0KCdyZW1vdGUtY2hhbmdlZCcpCiAgfQoKICBfY29uc3VtZURhdGEobGVuKSB7CiAgICBjb25zdCBuZXh0ID0gdGhpcy5fYnVmZmVyLnN1YmFycmF5KDAsIGxlbikKICAgIHRoaXMuX2J1ZmZlciA9IHRoaXMuX2J1ZmZlci5zdWJhcnJheShsZW4pCiAgICBpZiAodGhpcy5fYnVmZmVyLmJ5dGVMZW5ndGggPCBNQVhfUEFDS0VUKSB0aGlzLl9yZWFsbG9jRGF0YSgpCiAgICByZXR1cm4gbmV4dAogIH0KCiAgX3JlYWxsb2NEYXRhKCkgewogICAgdGhpcy5fYnVmZmVyID0gYjRhLmFsbG9jVW5zYWZlKEJVRkZFUl9TSVpFKQogICAgcmV0dXJuIHRoaXMuX2J1ZmZlcgogIH0KCiAgX3JlYWxsb2NNZXNzYWdlKCkgewogICAgcmV0dXJuIHRoaXMudWR4Ll9yZWFsbG9jTWVzc2FnZSgpCiAgfQoKICBfYWxsb2NXcml0ZShzaXplKSB7CiAgICBpZiAodGhpcy5fd2ZyZWUubGVuZ3RoID09PSAwKSB7CiAgICAgIGNvbnN0IGhhbmRsZSA9IGI0YS5hbGxvY1Vuc2FmZShiaW5kaW5nLnVkeF9uYXBpX3N0cmVhbV93cml0ZV9zaXplb2Yoc2l6ZSkpCiAgICAgIHJldHVybiAoCiAgICAgICAgdGhpcy5fd3JlcXMucHVzaCh7CiAgICAgICAgICBoYW5kbGUsCiAgICAgICAgICBzaXplLAogICAgICAgICAgYnVmZmVyczogbnVsbCwKICAgICAgICAgIGJ1ZmZlcjogbnVsbCwKICAgICAgICAgIGZsdXNoOiAwCiAgICAgICAgfSkgLSAxCiAgICAgICkKICAgIH0KCiAgICBjb25zdCBmcmVlID0gdGhpcy5fd2ZyZWUucG9wKCkKICAgIGlmIChzaXplID09PSAxKSByZXR1cm4gZnJlZQoKICAgIGNvbnN0IG5leHQgPSB0aGlzLl93cmVxc1tmcmVlXQogICAgaWYgKG5leHQuc2l6ZSA8IHNpemUpIHsKICAgICAgbmV4dC5oYW5kbGUgPSBiNGEuYWxsb2NVbnNhZmUoYmluZGluZy51ZHhfbmFwaV9zdHJlYW1fd3JpdGVfc2l6ZW9mKHNpemUpKQogICAgICBuZXh0LnNpemUgPSBzaXplCiAgICB9CgogICAgcmV0dXJuIGZyZWUKICB9CgogIF9hbGxvY1NlbmQoKSB7CiAgICBpZiAodGhpcy5fc2ZyZWUubGVuZ3RoID4gMCkgcmV0dXJuIHRoaXMuX3NmcmVlLnBvcCgpCiAgICBjb25zdCBoYW5kbGUgPSBiNGEuYWxsb2NVbnNhZmUoYmluZGluZy5zaXplb2ZfdWR4X3N0cmVhbV9zZW5kX3QpCiAgICByZXR1cm4gdGhpcy5fc3JlcXMucHVzaCh7IGhhbmRsZSwgYnVmZmVyOiBudWxsLCByZXNvbHZlOiBudWxsLCByZWplY3Q6IG51bGwgfSkgLSAxCiAgfQp9CgpmdW5jdGlvbiBub29wKCkge30KCmZ1bmN0aW9uIHRvQnVmZmVyKGRhdGEpIHsKICByZXR1cm4gdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnID8gYjRhLmZyb20oZGF0YSkgOiBkYXRhCn0KCmZ1bmN0aW9uIGZpcmV3YWxsQWxsKHNvY2tldCwgcG9ydCwgaG9zdCkgewogIHJldHVybiB0cnVlCn0KCmZ1bmN0aW9uIGN1c3RvbUVycm9yKG1lc3NhZ2UsIGNvZGUpIHsKICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKQogIGVycm9yLmNvZGUgPSBjb2RlCiAgcmV0dXJuIGVycm9yCn0KCmZ1bmN0aW9uIG5leHRCYXRjaFNpemUobikgewogIC8vIHRyeSB0byBjb2VyY2UgdGhlIHRoZSB3cml0ZXZzIGludG8gc2FtZWlzaCBzaXplCiAgaWYgKG4gPT09IDEpIHJldHVybiAxCiAgLy8gZ3JvdXAgYWxsIDwgOCB0byB0aGUgc2FtZSBzaXplLCBsb3cgbWVtIG92ZXJoZWFkIGJ1dCBzYXZlIHNvbWUgc21hbGwgYWxsb2NzCiAgaWYgKG4gPCA4KSByZXR1cm4gOAogIGlmIChuIDwgMTYpIHJldHVybiAxNgogIGlmIChuIDwgMzIpIHJldHVybiAzMgogIGlmIChuIDwgNjQpIHJldHVybiA2NAogIHJldHVybiBuCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKY29uc3QgYmluZGluZyA9IHJlcXVpcmUoJy4uL2JpbmRpbmcnKQpjb25zdCBpcCA9IHJlcXVpcmUoJy4vaXAnKQpjb25zdCBTb2NrZXQgPSByZXF1aXJlKCcuL3NvY2tldCcpCmNvbnN0IFN0cmVhbSA9IHJlcXVpcmUoJy4vc3RyZWFtJykKY29uc3QgTmV0d29ya0ludGVyZmFjZXMgPSByZXF1aXJlKCcuL25ldHdvcmstaW50ZXJmYWNlcycpCgpjb25zdCBNQVhfTUVTU0FHRSA9IDQwOTYKY29uc3QgQlVGRkVSX1NJWkUgPSA2NTUzNiArIE1BWF9NRVNTQUdFCgptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFVEWCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLl9oYW5kbGUgPSBiNGEuYWxsb2MoYmluZGluZy5zaXplb2ZfdWR4X25hcGlfdCkKICAgIHRoaXMuX3dhdGNoZXJzID0gbmV3IFNldCgpCiAgICB0aGlzLl92aWV3NjQgPSBuZXcgQmlnVWludDY0QXJyYXkoCiAgICAgIHRoaXMuX2hhbmRsZS5idWZmZXIsCiAgICAgIHRoaXMuX2hhbmRsZS5ieXRlT2Zmc2V0LAogICAgICB0aGlzLl9oYW5kbGUuYnl0ZUxlbmd0aCA+PiAzCiAgICApCgogICAgdGhpcy5fYnVmZmVyID0gbnVsbAogICAgdGhpcy5fcmVhbGxvY01lc3NhZ2UoKQoKICAgIGJpbmRpbmcudWR4X25hcGlfaW5pdCh0aGlzLl9oYW5kbGUsIHRoaXMuX2J1ZmZlcikKICB9CgogIHN0YXRpYyBpc0lQdjQoaG9zdCkgewogICAgcmV0dXJuIGlwLmlzSVB2NChob3N0KQogIH0KCiAgc3RhdGljIGlzSVB2Nihob3N0KSB7CiAgICByZXR1cm4gaXAuaXNJUHY2KGhvc3QpCiAgfQoKICBzdGF0aWMgaXNJUChob3N0KSB7CiAgICByZXR1cm4gaXAuaXNJUChob3N0KQogIH0KCiAgZ2V0IGJ5dGVzVHJhbnNtaXR0ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF90X2J5dGVzX3R4ID4+IDNdKQogIH0KCiAgZ2V0IHBhY2tldHNUcmFuc21pdHRlZCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3RfcGFja2V0c190eCA+PiAzXSkKICB9CgogIGdldCBieXRlc1JlY2VpdmVkKCkgewogICAgcmV0dXJuIE51bWJlcih0aGlzLl92aWV3NjRbYmluZGluZy5vZmZzZXRvZl91ZHhfdF9ieXRlc19yeCA+PiAzXSkKICB9CgogIGdldCBwYWNrZXRzUmVjZWl2ZWQoKSB7CiAgICByZXR1cm4gTnVtYmVyKHRoaXMuX3ZpZXc2NFtiaW5kaW5nLm9mZnNldG9mX3VkeF90X3BhY2tldHNfcnggPj4gM10pCiAgfQoKICBnZXQgcGFja2V0c0Ryb3BwZWRCeUtlcm5lbCgpIHsKICAgIHJldHVybiBOdW1iZXIodGhpcy5fdmlldzY0W2JpbmRpbmcub2Zmc2V0b2ZfdWR4X3RfcGFja2V0c19kcm9wcGVkX2J5X2tlcm5lbCA+PiAzXSkKICB9CgogIF9jb25zdW1lTWVzc2FnZShsZW4pIHsKICAgIGNvbnN0IG5leHQgPSB0aGlzLl9idWZmZXIuc3ViYXJyYXkoMCwgbGVuKQogICAgdGhpcy5fYnVmZmVyID0gdGhpcy5fYnVmZmVyLnN1YmFycmF5KGxlbikKICAgIGlmICh0aGlzLl9idWZmZXIuYnl0ZUxlbmd0aCA8IE1BWF9NRVNTQUdFKSB0aGlzLl9yZWFsbG9jTWVzc2FnZSgpCiAgICByZXR1cm4gbmV4dAogIH0KCiAgX3JlYWxsb2NNZXNzYWdlKCkgewogICAgLy8gVE9ETzogbW92ZSByZWFsbG9jYXRpb24gdG8gbmF0aXZlCiAgICB0aGlzLl9idWZmZXIgPSBiNGEuYWxsb2NVbnNhZmUoQlVGRkVSX1NJWkUpCiAgICByZXR1cm4gdGhpcy5fYnVmZmVyCiAgfQoKICBjcmVhdGVTb2NrZXQob3B0cykgewogICAgcmV0dXJuIG5ldyBTb2NrZXQodGhpcywgb3B0cykKICB9CgogIGNyZWF0ZVN0cmVhbShpZCwgb3B0cykgewogICAgcmV0dXJuIG5ldyBTdHJlYW0odGhpcywgaWQsIG9wdHMpCiAgfQoKICBuZXR3b3JrSW50ZXJmYWNlcygpIHsKICAgIGxldCBbd2F0Y2hlciA9IG51bGxdID0gdGhpcy5fd2F0Y2hlcnMKICAgIGlmICh3YXRjaGVyKSByZXR1cm4gd2F0Y2hlci5pbnRlcmZhY2VzCgogICAgd2F0Y2hlciA9IG5ldyBOZXR3b3JrSW50ZXJmYWNlcyh0aGlzKQogICAgd2F0Y2hlci5kZXN0cm95KCkKCiAgICByZXR1cm4gd2F0Y2hlci5pbnRlcmZhY2VzCiAgfQoKICB3YXRjaE5ldHdvcmtJbnRlcmZhY2VzKG9uY2hhbmdlKSB7CiAgICBjb25zdCB3YXRjaGVyID0gbmV3IE5ldHdvcmtJbnRlcmZhY2VzKHRoaXMpCgogICAgdGhpcy5fd2F0Y2hlcnMuYWRkKHdhdGNoZXIpCiAgICB3YXRjaGVyLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgdGhpcy5fd2F0Y2hlcnMuZGVsZXRlKHdhdGNoZXIpCiAgICB9KQoKICAgIGlmIChvbmNoYW5nZSkgd2F0Y2hlci5vbignY2hhbmdlJywgb25jaGFuZ2UpCgogICAgcmV0dXJuIHdhdGNoZXIud2F0Y2goKQogIH0KCiAgYXN5bmMgbG9va3VwKGhvc3QsIG9wdHMgPSB7fSkgewogICAgY29uc3QgeyBmYW1pbHkgPSAwIH0gPSBvcHRzCgogICAgY29uc3QgcmVxID0gYjRhLmFsbG9jKGJpbmRpbmcuc2l6ZW9mX3VkeF9uYXBpX2xvb2t1cF90KQogICAgY29uc3QgY3R4ID0gewogICAgICByZXEsCiAgICAgIHJlc29sdmU6IG51bGwsCiAgICAgIHJlamVjdDogbnVsbAogICAgfQoKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGN0eC5yZXNvbHZlID0gcmVzb2x2ZQogICAgICBjdHgucmVqZWN0ID0gcmVqZWN0CiAgICB9KQoKICAgIGJpbmRpbmcudWR4X25hcGlfbG9va3VwKHRoaXMuX2hhbmRsZSwgcmVxLCBob3N0LCBmYW1pbHksIGN0eCwgb25sb29rdXApCgogICAgcmV0dXJuIHByb21pc2UKICB9Cn0KCmZ1bmN0aW9uIG9ubG9va3VwKGVyciwgaG9zdCwgZmFtaWx5KSB7CiAgaWYgKGVycikgdGhpcy5yZWplY3QoZXJyKQogIGVsc2UgdGhpcy5yZXNvbHZlKHsgaG9zdCwgZmFtaWx5IH0pCn0KewogICJuYW1lIjogInVkeC1uYXRpdmUiLAogICJ2ZXJzaW9uIjogIjEuMTkuMiIsCiAgImRlc2NyaXB0aW9uIjogInVkeCBpcyByZWxpYWJsZSwgbXVsdGlwbGV4ZWQsIGFuZCBjb25nZXN0aW9uLWNvbnRyb2xsZWQgc3RyZWFtcyBvdmVyIHVkcCIsCiAgIm1haW4iOiAibGliL3VkeC5qcyIsCiAgImZpbGVzIjogWwogICAgImxpYiIsCiAgICAicHJlYnVpbGRzIiwKICAgICJiaW5kaW5nLmNjIiwKICAgICJiaW5kaW5nLmpzIiwKICAgICJDTWFrZUxpc3RzLnR4dCIKICBdLAogICJpbXBvcnRzIjogewogICAgImV2ZW50cyI6IHsKICAgICAgImJhcmUiOiAiYmFyZS1ldmVudHMiLAogICAgICAiZGVmYXVsdCI6ICJldmVudHMiCiAgICB9CiAgfSwKICAiYWRkb24iOiB0cnVlLAogICJzY3JpcHRzIjogewogICAgImZvcm1hdCI6ICJwcmV0dGllciAtLXdyaXRlIC4iLAogICAgImxpbnQiOiAicHJldHRpZXIgLS1jaGVjayAuIiwKICAgICJ0ZXN0IjogIm5wbSBydW4gbGludCAmJiBucG0gcnVuIHRlc3Q6YmFyZSAmJiBucG0gcnVuIHRlc3Q6bm9kZSIsCiAgICAidGVzdDpub2RlIjogIm5vZGUgdGVzdC9hbGwuanMiLAogICAgInRlc3Q6YmFyZSI6ICJiYXJlIHRlc3QvYWxsLmpzIiwKICAgICJ0ZXN0OmFsbCI6ICJicml0dGxlIHRlc3QvKi5qcyB0ZXN0L3Nsb3cvKi5qcyIsCiAgICAidGVzdDpnZW5lcmF0ZSI6ICJicml0dGxlIC1yIHRlc3QvYWxsLmpzIHRlc3QvKi5qcyIsCiAgICAiYmVuY2giOiAiYnJpdHRsZSB0ZXN0L2JlbmNoLyouanMiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImdpdCtodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdWR4LW5hdGl2ZS5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAidGNwIiwKICAgICJ1ZHAiLAogICAgInN0cmVhbSIsCiAgICAicmVsaWFibGUiCiAgXSwKICAiYXV0aG9yIjogIkhvbGVwdW5jaCBJbmMuIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3VkeC1uYXRpdmUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by91ZHgtbmF0aXZlI3JlYWRtZSIsCiAgImVuZ2luZXMiOiB7CiAgICAiYmFyZSI6ICI+PTEuMTcuNCIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjUuMCIsCiAgICAiYmFyZS1ldmVudHMiOiAiXjIuMi4wIiwKICAgICJyZXF1aXJlLWFkZG9uIjogIl4xLjEuMCIsCiAgICAic3RyZWFteCI6ICJeMi4yMi4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJiYXJlLWNvbXBhdC1uYXBpIjogIl4xLjMuMCIsCiAgICAiYnJpdHRsZSI6ICJeMy4xLjAiLAogICAgImNtYWtlLWJhcmUiOiAiXjEuMS4xMCIsCiAgICAiY21ha2UtZmV0Y2giOiAiXjEuMC4xIiwKICAgICJjbWFrZS1uYXBpIjogIl4xLjAuNSIsCiAgICAiaXMtY2kiOiAiXjMuMC4xIiwKICAgICJwcmV0dGllciI6ICJeMy42LjIiLAogICAgInByZXR0aWVyLWNvbmZpZy1ob2xlcHVuY2giOiAiXjIuMC4wIiwKICAgICJ0aW55LWJ5dGUtc2l6ZSI6ICJeMS4xLjAiCiAgfQp9CmV4cG9ydHMuYWRkID0gYWRkCmV4cG9ydHMuaGFzID0gaGFzCmV4cG9ydHMucmVtb3ZlID0gcmVtb3ZlCmV4cG9ydHMuc3dhcCA9IHN3YXAKCmZ1bmN0aW9uIGFkZCAobGlzdCwgaXRlbSkgewogIGlmIChoYXMobGlzdCwgaXRlbSkpIHJldHVybiBpdGVtCiAgaXRlbS5faW5kZXggPSBsaXN0Lmxlbmd0aAogIGxpc3QucHVzaChpdGVtKQogIHJldHVybiBpdGVtCn0KCmZ1bmN0aW9uIGhhcyAobGlzdCwgaXRlbSkgewogIHJldHVybiBpdGVtLl9pbmRleCA8IGxpc3QubGVuZ3RoICYmIGxpc3RbaXRlbS5faW5kZXhdID09PSBpdGVtCn0KCmZ1bmN0aW9uIHJlbW92ZSAobGlzdCwgaXRlbSkgewogIGlmICghaGFzKGxpc3QsIGl0ZW0pKSByZXR1cm4gbnVsbAoKICB2YXIgbGFzdCA9IGxpc3QucG9wKCkKICBpZiAobGFzdCAhPT0gaXRlbSkgewogICAgbGlzdFtpdGVtLl9pbmRleF0gPSBsYXN0CiAgICBsYXN0Ll9pbmRleCA9IGl0ZW0uX2luZGV4CiAgfQoKICByZXR1cm4gaXRlbQp9CgpmdW5jdGlvbiBzd2FwIChsaXN0LCBhLCBiKSB7CiAgaWYgKCFoYXMobGlzdCwgYSkgfHwgIWhhcyhsaXN0LCBiKSkgcmV0dXJuCiAgdmFyIHRtcCA9IGEuX2luZGV4CiAgYS5faW5kZXggPSBiLl9pbmRleAogIGxpc3RbYS5faW5kZXhdID0gYQogIGIuX2luZGV4ID0gdG1wCiAgbGlzdFtiLl9pbmRleF0gPSBiCn0KewogICJuYW1lIjogInVub3JkZXJlZC1zZXQiLAogICJ2ZXJzaW9uIjogIjIuMC4xIiwKICAiZGVzY3JpcHRpb24iOiAiQSBjb3VwbGUgb2YgZnVuY3Rpb25zIHRoYXQgbWFrZSBpdCBlYXN5IHRvIG1haW50YWluIGFuIHVub3JkZXJlZCBzZXQgYXMgYW4gYXJyYXkgaW4gYW4gZWZmaWNpZW50IHdheSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7fSwKICAiZGV2RGVwZW5kZW5jaWVzIjogewogICAgInN0YW5kYXJkIjogIl42LjAuNCIsCiAgICAidGFwZSI6ICJeNC40LjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIHRhcGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC91bm9yZGVyZWQtc2V0LmdpdCIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC91bm9yZGVyZWQtc2V0L2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vbWFmaW50b3NoL3Vub3JkZXJlZC1zZXQiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCnVuc2xhYi5hbGwgPSBhbGwKdW5zbGFiLmlzID0gaXMKCm1vZHVsZS5leHBvcnRzID0gdW5zbGFiCgpmdW5jdGlvbiB1bnNsYWIgKGJ1ZikgewogIGlmIChidWYgPT09IG51bGwgfHwgYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoID09PSBidWYuYnl0ZUxlbmd0aCkgcmV0dXJuIGJ1ZgogIGNvbnN0IGNvcHkgPSBiNGEuYWxsb2NVbnNhZmVTbG93KGJ1Zi5ieXRlTGVuZ3RoKQogIGNvcHkuc2V0KGJ1ZiwgMCkKICByZXR1cm4gY29weQp9CgpmdW5jdGlvbiBpcyAoYnVmKSB7CiAgcmV0dXJuIGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aCAhPT0gYnVmLmJ5dGVMZW5ndGgKfQoKZnVuY3Rpb24gYWxsIChsaXN0KSB7CiAgbGV0IHNpemUgPSAwCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBidWYgPSBsaXN0W2ldCiAgICBzaXplICs9IGJ1ZiA9PT0gbnVsbCB8fCBidWYuYnVmZmVyLmJ5dGVMZW5ndGggPT09IGJ1Zi5ieXRlTGVuZ3RoID8gMCA6IGJ1Zi5ieXRlTGVuZ3RoCiAgfQoKICBjb25zdCBjb3B5ID0gYjRhLmFsbG9jVW5zYWZlU2xvdyhzaXplKQogIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShsaXN0Lmxlbmd0aCkKCiAgbGV0IG9mZnNldCA9IDAKICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgIGxldCBidWYgPSBsaXN0W2ldCgogICAgaWYgKGJ1ZiAhPT0gbnVsbCAmJiBidWYuYnVmZmVyLmJ5dGVMZW5ndGggIT09IGJ1Zi5ieXRlTGVuZ3RoKSB7CiAgICAgIGNvcHkuc2V0KGJ1Ziwgb2Zmc2V0KQogICAgICBidWYgPSBjb3B5LnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICs9IGJ1Zi5ieXRlTGVuZ3RoKQogICAgfQoKICAgIHJlc3VsdFtpXSA9IGJ1ZgogIH0KCiAgcmV0dXJuIHJlc3VsdAp9CnsKICAibmFtZSI6ICJ1bnNsYWIiLAogICJ2ZXJzaW9uIjogIjEuMy4wIiwKICAiZGVzY3JpcHRpb24iOiAiVW5zbGFiIHNvbWUgc2xhYidlZCBidWZmZXJzIiwKICAibWFpbiI6ICJpbmRleC5qcyIsCiAgImZpbGVzIjogWwogICAgImluZGV4LmpzIgogIF0sCiAgImRlcGVuZGVuY2llcyI6IHsKICAgICJiNGEiOiAiXjEuNi42IgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJicml0dGxlIjogIl4zLjUuMiIsCiAgICAic3RhbmRhcmQiOiAiXjE3LjEuMCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vdW5zbGFiLmdpdCIKICB9LAogICJhdXRob3IiOiAiSG9sZXB1bmNoIiwKICAibGljZW5zZSI6ICJBcGFjaGUtMi4wIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Vuc2xhYi9pc3N1ZXMiCiAgfSwKICAiaG9tZXBhZ2UiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3Vuc2xhYiIKfQptb2R1bGUuZXhwb3J0cyA9IHJlYWQKCnZhciBNU0IgPSAweDgwCiAgLCBSRVNUID0gMHg3RgoKZnVuY3Rpb24gcmVhZChidWYsIG9mZnNldCkgewogIHZhciByZXMgICAgPSAwCiAgICAsIG9mZnNldCA9IG9mZnNldCB8fCAwCiAgICAsIHNoaWZ0ICA9IDAKICAgICwgY291bnRlciA9IG9mZnNldAogICAgLCBiCiAgICAsIGwgPSBidWYubGVuZ3RoCgogIGRvIHsKICAgIGlmIChjb3VudGVyID49IGwpIHsKICAgICAgcmVhZC5ieXRlcyA9IDAKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0NvdWxkIG5vdCBkZWNvZGUgdmFyaW50JykKICAgIH0KICAgIGIgPSBidWZbY291bnRlcisrXQogICAgcmVzICs9IHNoaWZ0IDwgMjgKICAgICAgPyAoYiAmIFJFU1QpIDw8IHNoaWZ0CiAgICAgIDogKGIgJiBSRVNUKSAqIE1hdGgucG93KDIsIHNoaWZ0KQogICAgc2hpZnQgKz0gNwogIH0gd2hpbGUgKGIgPj0gTVNCKQoKICByZWFkLmJ5dGVzID0gY291bnRlciAtIG9mZnNldAoKICByZXR1cm4gcmVzCn0KbW9kdWxlLmV4cG9ydHMgPSBlbmNvZGUKCnZhciBNU0IgPSAweDgwCiAgLCBSRVNUID0gMHg3RgogICwgTVNCQUxMID0gflJFU1QKICAsIElOVCA9IE1hdGgucG93KDIsIDMxKQoKZnVuY3Rpb24gZW5jb2RlKG51bSwgb3V0LCBvZmZzZXQpIHsKICBvdXQgPSBvdXQgfHwgW10KICBvZmZzZXQgPSBvZmZzZXQgfHwgMAogIHZhciBvbGRPZmZzZXQgPSBvZmZzZXQKCiAgd2hpbGUobnVtID49IElOVCkgewogICAgb3V0W29mZnNldCsrXSA9IChudW0gJiAweEZGKSB8IE1TQgogICAgbnVtIC89IDEyOAogIH0KICB3aGlsZShudW0gJiBNU0JBTEwpIHsKICAgIG91dFtvZmZzZXQrK10gPSAobnVtICYgMHhGRikgfCBNU0IKICAgIG51bSA+Pj49IDcKICB9CiAgb3V0W29mZnNldF0gPSBudW0gfCAwCiAgCiAgZW5jb2RlLmJ5dGVzID0gb2Zmc2V0IC0gb2xkT2Zmc2V0ICsgMQogIAogIHJldHVybiBvdXQKfQptb2R1bGUuZXhwb3J0cyA9IHsKICAgIGVuY29kZTogcmVxdWlyZSgnLi9lbmNvZGUuanMnKQogICwgZGVjb2RlOiByZXF1aXJlKCcuL2RlY29kZS5qcycpCiAgLCBlbmNvZGluZ0xlbmd0aDogcmVxdWlyZSgnLi9sZW5ndGguanMnKQp9Cgp2YXIgTjEgPSBNYXRoLnBvdygyLCAgNykKdmFyIE4yID0gTWF0aC5wb3coMiwgMTQpCnZhciBOMyA9IE1hdGgucG93KDIsIDIxKQp2YXIgTjQgPSBNYXRoLnBvdygyLCAyOCkKdmFyIE41ID0gTWF0aC5wb3coMiwgMzUpCnZhciBONiA9IE1hdGgucG93KDIsIDQyKQp2YXIgTjcgPSBNYXRoLnBvdygyLCA0OSkKdmFyIE44ID0gTWF0aC5wb3coMiwgNTYpCnZhciBOOSA9IE1hdGgucG93KDIsIDYzKQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4gKAogICAgdmFsdWUgPCBOMSA/IDEKICA6IHZhbHVlIDwgTjIgPyAyCiAgOiB2YWx1ZSA8IE4zID8gMwogIDogdmFsdWUgPCBONCA/IDQKICA6IHZhbHVlIDwgTjUgPyA1CiAgOiB2YWx1ZSA8IE42ID8gNgogIDogdmFsdWUgPCBONyA/IDcKICA6IHZhbHVlIDwgTjggPyA4CiAgOiB2YWx1ZSA8IE45ID8gOQogIDogICAgICAgICAgICAgIDEwCiAgKQp9CnsKICAibmFtZSI6ICJ2YXJpbnQiLAogICJ2ZXJzaW9uIjogIjUuMC4wIiwKICAiZGVzY3JpcHRpb24iOiAicHJvdG9idWYtc3R5bGUgdmFyaW50IGJ5dGVzIC0gdXNlIG1zYiB0byBjcmVhdGUgaW50ZWdlciB2YWx1ZXMgb2YgdmFyeWluZyBzaXplcyIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAibm9kZSB0ZXN0LmpzIgogIH0sCiAgInJlcG9zaXRvcnkiOiB7CiAgICAidHlwZSI6ICJnaXQiLAogICAgInVybCI6ICJnaXQ6Ly9naXRodWIuY29tL2NocmlzZGlja2luc29uL3ZhcmludC5naXQiCiAgfSwKICAia2V5d29yZHMiOiBbCiAgICAidmFyaW50IiwKICAgICJwcm90b2J1ZiIsCiAgICAiZW5jb2RlIiwKICAgICJkZWNvZGUiCiAgXSwKICAiYXV0aG9yIjogIkNocmlzIERpY2tpbnNvbiA8Y2hyaXNAbmV2ZXJzYXcudXM+IiwKICAibGljZW5zZSI6ICJNSVQiLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAidGFwZSI6ICJ+Mi4xMi4zIgogIH0KfQpjb25zdCB7IHJ1bnRpbWUsIHBsYXRmb3JtLCBhcmNoIH0gPSB0eXBlb2YgQmFyZSAhPT0gJ3VuZGVmaW5lZCcKICA/IHsgcnVudGltZTogJ2JhcmUnLCBwbGF0Zm9ybTogZ2xvYmFsLkJhcmUucGxhdGZvcm0sIGFyY2g6IGdsb2JhbC5CYXJlLmFyY2ggfQogIDogdHlwZW9mIHByb2Nlc3MgIT09ICd1bmRlZmluZWQnCiAgICA/IHsgcnVudGltZTogJ25vZGUnLCBwbGF0Zm9ybTogZ2xvYmFsLnByb2Nlc3MucGxhdGZvcm0sIGFyY2g6IGdsb2JhbC5wcm9jZXNzLmFyY2ggfQogICAgOiB0eXBlb2YgV2luZG93ICE9PSAndW5kZWZpbmVkJwogICAgICA/IHsgcnVudGltZTogJ2Jyb3dzZXInLCBwbGF0Zm9ybTogJ3Vua25vd24nLCBhcmNoOiAndW5rbm93bicgfQogICAgICA6IHsgcnVudGltZTogJ3Vua25vd24nLCBwbGF0Zm9ybTogJ3Vua25vd24nLCBhcmNoOiAndW5rbm93bicgfQoKZXhwb3J0cy5ydW50aW1lID0gcnVudGltZQpleHBvcnRzLnBsYXRmb3JtID0gcGxhdGZvcm0KZXhwb3J0cy5hcmNoID0gYXJjaApleHBvcnRzLmlzQmFyZSA9IHJ1bnRpbWUgPT09ICdiYXJlJwpleHBvcnRzLmlzQmFyZUtpdCA9IGV4cG9ydHMuaXNCYXJlICYmIHR5cGVvZiBCYXJlS2l0ICE9PSAndW5kZWZpbmVkJwpleHBvcnRzLmlzUGVhciA9IHR5cGVvZiBQZWFyICE9PSAndW5kZWZpbmVkJwpleHBvcnRzLmlzTm9kZSA9IHJ1bnRpbWUgPT09ICdub2RlJwpleHBvcnRzLmlzQnJvd3NlciA9IHJ1bnRpbWUgPT09ICdicm93c2VyJwpleHBvcnRzLmlzV2luZG93cyA9IHBsYXRmb3JtID09PSAnd2luMzInCmV4cG9ydHMuaXNMaW51eCA9IHBsYXRmb3JtID09PSAnbGludXgnCmV4cG9ydHMuaXNNYWMgPSBwbGF0Zm9ybSA9PT0gJ2RhcndpbicKZXhwb3J0cy5pc0lPUyA9IHBsYXRmb3JtID09PSAnaW9zJyB8fCBwbGF0Zm9ybSA9PT0gJ2lvcy1zaW11bGF0b3InCmV4cG9ydHMuaXNBbmRyb2lkID0gcGxhdGZvcm0gPT09ICdhbmRyb2lkJwpleHBvcnRzLmlzRWxlY3Ryb24gPSB0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYgISFnbG9iYWwucHJvY2Vzcy52ZXJzaW9ucz8uZWxlY3Ryb24KZXhwb3J0cy5pc0VsZWN0cm9uUmVuZGVyZXIgPSBleHBvcnRzLmlzRWxlY3Ryb24gJiYgZ2xvYmFsLnByb2Nlc3MudHlwZSA9PT0gJ3JlbmRlcmVyJwpleHBvcnRzLmlzRWxlY3Ryb25Xb3JrZXIgPSBleHBvcnRzLmlzRWxlY3Ryb24gJiYgZ2xvYmFsLnByb2Nlc3MudHlwZSA9PT0gJ3dvcmtlcicKewogICJuYW1lIjogIndoaWNoLXJ1bnRpbWUiLAogICJ2ZXJzaW9uIjogIjEuMy4yIiwKICAiZGVzY3JpcHRpb24iOiAiRGV0ZWN0IGlmIHlvdSBhcmUgaW4gQmFyZSBvciBOb2RlIGFuZCB3aGljaCBvcyBldGMiLAogICJtYWluIjogImluZGV4LmpzIiwKICAiZmlsZXMiOiBbCiAgICAiaW5kZXguanMiCiAgXSwKICAiZGVwZW5kZW5jaWVzIjoge30sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJzdGFuZGFyZCI6ICJeMTcuMC4wIgogIH0sCiAgInNjcmlwdHMiOiB7CiAgICAidGVzdCI6ICJzdGFuZGFyZCIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2hvbGVwdW5jaHRvL3doaWNoLXJ1bnRpbWUuZ2l0IgogIH0sCiAgImF1dGhvciI6ICJIb2xlcHVuY2ggSW5jLiIsCiAgImxpY2Vuc2UiOiAiQXBhY2hlLTIuMCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9ob2xlcHVuY2h0by93aGljaC1ydW50aW1lL2lzc3VlcyIKICB9LAogICJob21lcGFnZSI6ICJodHRwczovL2dpdGh1Yi5jb20vaG9sZXB1bmNodG8vd2hpY2gtcnVudGltZSIKfQptb2R1bGUuZXhwb3J0cyA9IGNsYXNzIE1heENhY2hlIHsKICBjb25zdHJ1Y3RvciAoeyBtYXhTaXplLCBtYXhBZ2UsIGNyZWF0ZU1hcCwgb25nYyB9KSB7CiAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplCiAgICB0aGlzLm1heEFnZSA9IG1heEFnZQogICAgdGhpcy5vbmdjID0gb25nYyB8fCBudWxsCgogICAgdGhpcy5fY3JlYXRlTWFwID0gY3JlYXRlTWFwIHx8IGRlZmF1bHRDcmVhdGVNYXAKICAgIHRoaXMuX2xhdGVzdCA9IHRoaXMuX2NyZWF0ZU1hcCgpCiAgICB0aGlzLl9vbGRlc3QgPSB0aGlzLl9jcmVhdGVNYXAoKQogICAgdGhpcy5fcmV0YWluZWQgPSB0aGlzLl9jcmVhdGVNYXAoKQogICAgdGhpcy5fZ2NlZCA9IGZhbHNlCiAgICB0aGlzLl9pbnRlcnZhbCA9IG51bGwKCiAgICBpZiAodGhpcy5tYXhBZ2UgPiAwICYmIHRoaXMubWF4QWdlIDwgSW5maW5pdHkpIHsKICAgICAgY29uc3QgdGljayA9IE1hdGguY2VpbCgyIC8gMyAqIHRoaXMubWF4QWdlKQogICAgICB0aGlzLl9pbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuX2djQXV0by5iaW5kKHRoaXMpLCB0aWNrKQogICAgICBpZiAodGhpcy5faW50ZXJ2YWwudW5yZWYpIHRoaXMuX2ludGVydmFsLnVucmVmKCkKICAgIH0KICB9CgogICogW1N5bWJvbC5pdGVyYXRvcl0gKCkgewogICAgZm9yIChjb25zdCBpdCBvZiBbdGhpcy5fbGF0ZXN0LCB0aGlzLl9vbGRlc3QsIHRoaXMuX3JldGFpbmVkXSkgewogICAgICB5aWVsZCAqIGl0CiAgICB9CiAgfQoKICAqIGtleXMgKCkgewogICAgZm9yIChjb25zdCBpdCBvZiBbdGhpcy5fbGF0ZXN0LCB0aGlzLl9vbGRlc3QsIHRoaXMuX3JldGFpbmVkXSkgewogICAgICB5aWVsZCAqIGl0LmtleXMoKQogICAgfQogIH0KCiAgKiB2YWx1ZXMgKCkgewogICAgZm9yIChjb25zdCBpdCBvZiBbdGhpcy5fbGF0ZXN0LCB0aGlzLl9vbGRlc3QsIHRoaXMuX3JldGFpbmVkXSkgewogICAgICB5aWVsZCAqIGl0LnZhbHVlcygpCiAgICB9CiAgfQoKICBkZXN0cm95ICgpIHsKICAgIHRoaXMuY2xlYXIoKQogICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pbnRlcnZhbCkKICAgIHRoaXMuX2ludGVydmFsID0gbnVsbAogIH0KCiAgY2xlYXIgKCkgewogICAgdGhpcy5fZ2NlZCA9IHRydWUKICAgIHRoaXMuX2xhdGVzdC5jbGVhcigpCiAgICB0aGlzLl9vbGRlc3QuY2xlYXIoKQogICAgdGhpcy5fcmV0YWluZWQuY2xlYXIoKQogIH0KCiAgc2V0IChrLCB2KSB7CiAgICBpZiAodGhpcy5fcmV0YWluZWQuaGFzKGspKSByZXR1cm4gdGhpcwogICAgdGhpcy5fbGF0ZXN0LnNldChrLCB2KQogICAgdGhpcy5fb2xkZXN0LmRlbGV0ZShrKSB8fCB0aGlzLl9yZXRhaW5lZC5kZWxldGUoaykKICAgIGlmICh0aGlzLl9sYXRlc3Quc2l6ZSA+PSB0aGlzLm1heFNpemUpIHRoaXMuX2djKCkKICAgIHJldHVybiB0aGlzCiAgfQoKICByZXRhaW4gKGssIHYpIHsKICAgIHRoaXMuX3JldGFpbmVkLnNldChrLCB2KQogICAgdGhpcy5fbGF0ZXN0LmRlbGV0ZShrKSB8fCB0aGlzLl9vbGRlc3QuZGVsZXRlKGspCiAgICByZXR1cm4gdGhpcwogIH0KCiAgZGVsZXRlIChrKSB7CiAgICByZXR1cm4gdGhpcy5fbGF0ZXN0LmRlbGV0ZShrKSB8fCB0aGlzLl9vbGRlc3QuZGVsZXRlKGspIHx8IHRoaXMuX3JldGFpbmVkLmRlbGV0ZShrKQogIH0KCiAgaGFzIChrKSB7CiAgICByZXR1cm4gdGhpcy5fbGF0ZXN0LmhhcyhrKSB8fCB0aGlzLl9vbGRlc3QuaGFzKGspIHx8IHRoaXMuX3JldGFpbmVkLmhhcyhrKQogIH0KCiAgZ2V0IChrKSB7CiAgICBpZiAodGhpcy5fbGF0ZXN0LmhhcyhrKSkgewogICAgICByZXR1cm4gdGhpcy5fbGF0ZXN0LmdldChrKQogICAgfQoKICAgIGlmICh0aGlzLl9vbGRlc3QuaGFzKGspKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLl9vbGRlc3QuZ2V0KGspCiAgICAgIHRoaXMuX2xhdGVzdC5zZXQoaywgdikKICAgICAgdGhpcy5fb2xkZXN0LmRlbGV0ZShrKQogICAgICByZXR1cm4gdgogICAgfQoKICAgIGlmICh0aGlzLl9yZXRhaW5lZC5oYXMoaykpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JldGFpbmVkLmdldChrKQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfQoKICBfZ2NBdXRvICgpIHsKICAgIGlmICghdGhpcy5fZ2NlZCkgdGhpcy5fZ2MoKQogICAgdGhpcy5fZ2NlZCA9IGZhbHNlCiAgfQoKICBfZ2MgKCkgewogICAgdGhpcy5fZ2NlZCA9IHRydWUKICAgIGlmICh0aGlzLm9uZ2MgIT09IG51bGwgJiYgdGhpcy5fb2xkZXN0LnNpemUgPiAwKSB0aGlzLm9uZ2ModGhpcy5fb2xkZXN0KQogICAgdGhpcy5fb2xkZXN0ID0gdGhpcy5fbGF0ZXN0CiAgICB0aGlzLl9sYXRlc3QgPSB0aGlzLl9jcmVhdGVNYXAoKQogIH0KfQoKZnVuY3Rpb24gZGVmYXVsdENyZWF0ZU1hcCAoKSB7CiAgcmV0dXJuIG5ldyBNYXAoKQp9CnsKICAibmFtZSI6ICJ4YWNoZSIsCiAgInZlcnNpb24iOiAiMS4yLjEiLAogICJkZXNjcmlwdGlvbiI6ICJZZXQgYW5vdGhlciBhdXRvIGV4cGlyaW5nLCBtYXggc2l6YWJsZSBjYWNoZSIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJmaWxlcyI6IFsKICAgICJpbmRleC5qcyIKICBdLAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYnJpdHRsZSI6ICJeMy4zLjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4xLjAiCiAgfSwKICAic2NyaXB0cyI6IHsKICAgICJ0ZXN0IjogInN0YW5kYXJkICYmIGJyaXR0bGUgdGVzdC5qcyIKICB9LAogICJyZXBvc2l0b3J5IjogewogICAgInR5cGUiOiAiZ2l0IiwKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC94YWNoZS5naXQiCiAgfSwKICAiYXV0aG9yIjogIk1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkiLAogICJsaWNlbnNlIjogIk1JVCIsCiAgImJ1Z3MiOiB7CiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gveGFjaGUvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gveGFjaGUiCn0KY29uc3QgYjRhID0gcmVxdWlyZSgnYjRhJykKCmNvbnN0IEFMUEhBQkVUID0gJ3libmRyZmc4ZWprbWNwcXhvdDF1d2lzemEzNDVoNzY5Jwpjb25zdCBNSU4gPSAweDMxIC8vIDEKY29uc3QgTUFYID0gMHg3YSAvLyB6CmNvbnN0IFJFVkVSU0UgPSBuZXcgSW50OEFycmF5KDEgKyBNQVggLSBNSU4pCgpSRVZFUlNFLmZpbGwoLTEpCgpmb3IgKGxldCBpID0gMDsgaSA8IEFMUEhBQkVULmxlbmd0aDsgaSsrKSB7CiAgY29uc3QgdiA9IEFMUEhBQkVULmNoYXJDb2RlQXQoaSkgLSBNSU4KICBSRVZFUlNFW3ZdID0gaQp9CgpleHBvcnRzLmVuY29kZSA9IGVuY29kZQpleHBvcnRzLmRlY29kZSA9IGRlY29kZQpleHBvcnRzLkFMUEhBQkVUID0gQUxQSEFCRVQKCmZ1bmN0aW9uIGRlY29kZSAocywgb3V0KSB7CiAgbGV0IHBiID0gMAogIGxldCBwcyA9IDAKCiAgY29uc3QgciA9IHMubGVuZ3RoICYgNwogIGNvbnN0IHEgPSAocy5sZW5ndGggLSByKSAvIDgKCiAgaWYgKCFvdXQpIG91dCA9IGI0YS5hbGxvY1Vuc2FmZShNYXRoLmNlaWwocy5sZW5ndGggKiA1IC8gOCkpCgogIC8vIDAgNSAyIDcgNCAxIDYgMyAoKzUgbW9kIDgpCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBxOyBpKyspIHsKICAgIGNvbnN0IGEgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBiID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgYyA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGQgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBlID0gcXVpbnRldChzLCBwcysrKQogICAgY29uc3QgZiA9IHF1aW50ZXQocywgcHMrKykKICAgIGNvbnN0IGcgPSBxdWludGV0KHMsIHBzKyspCiAgICBjb25zdCBoID0gcXVpbnRldChzLCBwcysrKQoKICAgIG91dFtwYisrXSA9IChhIDw8IDMpIHwgKGIgPj4+IDIpCiAgICBvdXRbcGIrK10gPSAoKGIgJiAwYjExKSA8PCA2KSB8IChjIDw8IDEpIHwgKGQgPj4+IDQpCiAgICBvdXRbcGIrK10gPSAoKGQgJiAwYjExMTEpIDw8IDQpIHwgKGUgPj4+IDEpCiAgICBvdXRbcGIrK10gPSAoKGUgJiAwYjEpIDw8IDcpIHwgKGYgPDwgMikgfCAoZyA+Pj4gMykKICAgIG91dFtwYisrXSA9ICgoZyAmIDBiMTExKSA8PCA1KSB8IGgKICB9CgogIGlmIChyID09PSAwKSByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQoKICBjb25zdCBhID0gcXVpbnRldChzLCBwcysrKQogIGNvbnN0IGIgPSBxdWludGV0KHMsIHBzKyspCgogIG91dFtwYisrXSA9IChhIDw8IDMpIHwgKGIgPj4+IDIpCgogIGlmIChyIDw9IDIpIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGMgPSBxdWludGV0KHMsIHBzKyspCiAgY29uc3QgZCA9IHF1aW50ZXQocywgcHMrKykKCiAgb3V0W3BiKytdID0gKChiICYgMGIxMSkgPDwgNikgfCAoYyA8PCAxKSB8IChkID4+PiA0KQoKICBpZiAociA8PSA0KSByZXR1cm4gb3V0LnN1YmFycmF5KDAsIHBiKQoKICBjb25zdCBlID0gcXVpbnRldChzLCBwcysrKQoKICBvdXRbcGIrK10gPSAoKGQgJiAwYjExMTEpIDw8IDQpIHwgKGUgPj4+IDEpCgogIGlmIChyIDw9IDUpIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGYgPSBxdWludGV0KHMsIHBzKyspCiAgY29uc3QgZyA9IHF1aW50ZXQocywgcHMrKykKCiAgb3V0W3BiKytdID0gKChlICYgMGIxKSA8PCA3KSB8IChmIDw8IDIpIHwgKGcgPj4+IDMpCgogIGlmIChyIDw9IDcpIHJldHVybiBvdXQuc3ViYXJyYXkoMCwgcGIpCgogIGNvbnN0IGggPSBxdWludGV0KHMsIHBzKyspCgogIG91dFtwYisrXSA9ICgoZyAmIDBiMTExKSA8PCA1KSB8IGgKCiAgcmV0dXJuIG91dC5zdWJhcnJheSgwLCBwYikKfQoKZnVuY3Rpb24gZW5jb2RlIChidWYpIHsKICBpZiAodHlwZW9mIGJ1ZiA9PT0gJ3N0cmluZycpIGJ1ZiA9IGI0YS5mcm9tKGJ1ZikKCiAgY29uc3QgbWF4ID0gYnVmLmJ5dGVMZW5ndGggKiA4CgogIGxldCBzID0gJycKCiAgZm9yIChsZXQgcCA9IDA7IHAgPCBtYXg7IHAgKz0gNSkgewogICAgY29uc3QgaSA9IHAgPj4+IDMKICAgIGNvbnN0IGogPSBwICYgNwoKICAgIGlmIChqIDw9IDMpIHsKICAgICAgcyArPSBBTFBIQUJFVFsoYnVmW2ldID4+PiAoMyAtIGopKSAmIDBiMTExMTFdCiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgY29uc3Qgb2YgPSBqIC0gMwogICAgY29uc3QgaCA9IChidWZbaV0gPDwgb2YpICYgMGIxMTExMQogICAgY29uc3QgbCA9IChpID49IGJ1Zi5ieXRlTGVuZ3RoID8gMCA6IGJ1ZltpICsgMV0pID4+PiAoOCAtIG9mKQoKICAgIHMgKz0gQUxQSEFCRVRbaCB8IGxdCiAgfQoKICByZXR1cm4gcwp9CgpmdW5jdGlvbiBxdWludGV0IChzLCBpKSB7CiAgaWYgKGkgPiBzLmxlbmd0aCkgewogICAgcmV0dXJuIDAKICB9CgogIGNvbnN0IHYgPSBzLmNoYXJDb2RlQXQoaSkKCiAgaWYgKHYgPCBNSU4gfHwgdiA+IE1BWCkgewogICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgY2hhcmFjdGVyIGluIGJhc2UzMiBpbnB1dDogIicgKyBzW2ldICsgJyIgYXQgcG9zaXRpb24gJyArIGkpCiAgfQoKICBjb25zdCBiaXRzID0gUkVWRVJTRVt2IC0gTUlOXQoKICBpZiAoYml0cyA9PT0gLTEpIHsKICAgIHRocm93IEVycm9yKCdJbnZhbGlkIGNoYXJhY3RlciBpbiBiYXNlMzIgaW5wdXQ6ICInICsgc1tpXSArICciIGF0IHBvc2l0aW9uICcgKyBpKQogIH0KCiAgcmV0dXJuIGJpdHMKfQp7CiAgIm5hbWUiOiAiejMyIiwKICAidmVyc2lvbiI6ICIxLjEuMCIsCiAgImRlc2NyaXB0aW9uIjogIkVuY29kZSAmIGRlY29kZSB6LWJhc2UzMiIsCiAgIm1haW4iOiAiaW5kZXguanMiLAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiYjRhIjogIl4xLjUuMyIKICB9LAogICJkZXZEZXBlbmRlbmNpZXMiOiB7CiAgICAiYmFzZS14IjogIl40LjAuMCIsCiAgICAiYmFzZTMyIjogIjAuMC43IiwKICAgICJicml0dGxlIjogIl4zLjEuMyIsCiAgICAibmFub2JlbmNoIjogIl4zLjAuMCIsCiAgICAicmZjNDY0OCI6ICJeMS41LjIiLAogICAgInN0YW5kYXJkIjogIl4xNy4wLjAiCiAgfSwKICAicmVwb3NpdG9yeSI6IHsKICAgICJ0eXBlIjogImdpdCIsCiAgICAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvejMyLmdpdCIKICB9LAogICJzY3JpcHRzIjogewogICAgInRlc3QiOiAic3RhbmRhcmQgJiYgYnJpdHRsZSB0ZXN0LmpzIiwKICAgICJiZW5jaCI6ICJub2RlIGJlbmNobWFyay5qcyIKICB9LAogICJhdXRob3IiOiAiTWF0aGlhcyBCdXVzIChAbWFmaW50b3NoKSIsCiAgImxpY2Vuc2UiOiAiTUlUIiwKICAiYnVncyI6IHsKICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL21hZmludG9zaC96MzIvaXNzdWVzIgogIH0sCiAgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvejMyIgp9CnsKICAicHJpdmF0ZSI6IHRydWUsCiAgIm5hbWUiOiAibGlzdGFtIiwKICAiZGVzY3JpcHRpb24iOiAiQSBtaW5pbWFsaXN0aWMgcDJwIGxpc3QgYXBwIiwKICAibWFpbiI6ICJleHBvLXJvdXRlci9lbnRyeSIsCiAgInNjcmlwdHMiOiB7CiAgICAic3RhcnQiOiAiZXhwbyBzdGFydCIsCiAgICAiYW5kcm9pZCI6ICJucG0gcnVuIGJ1bmRsZTpiYWNrZW5kOmFuZHJvaWQgJiYgZXhwbyBydW46YW5kcm9pZCIsCiAgICAiYW5kcm9pZDpyZWxlYXNlIjogImNkIGFuZHJvaWQgJiYgLi9ncmFkbGV3IGJ1bmRsZVJlbGVhc2UiLAogICAgImlvcyI6ICJucG0gcnVuIGJ1bmRsZTpiYWNrZW5kOmlvcyAmJiBleHBvIHJ1bjppb3MgLS1kZXZpY2UiLAogICAgImJ1bmRsZTpiYWNrZW5kOmlvcyI6ICJucHggYmFyZS1wYWNrIC0tdGFyZ2V0IGlvcyAtLWxpbmtlZCBiYWNrZW5kL2JhY2tlbmQubWpzIC0tZW5jb2RpbmcgYmFzZTY0IC0tb3V0IGFwcC9hcHAuaW9zLmJ1bmRsZSAmJiBub2RlIHNjcmlwdHMvd3JhcC1iYXJlLWJ1bmRsZS5tanMgYXBwL2FwcC5pb3MuYnVuZGxlIGFwcC9hcHAuaW9zLmJ1bmRsZS5tanMiLAogICAgImJ1bmRsZTpiYWNrZW5kOmFuZHJvaWQiOiAibnB4IGJhcmUtcGFjayAtLXRhcmdldCBhbmRyb2lkIC0tbGlua2VkIGJhY2tlbmQvYmFja2VuZC5tanMgLS1lbmNvZGluZyBiYXNlNjQgLS1vdXQgYXBwL2Fzc2V0cy9iYWNrZW5kLmFuZHJvaWQuYnVuZGxlICYmIG5vZGUgc2NyaXB0cy93cmFwLWJhcmUtYnVuZGxlLm1qcyBhcHAvYXNzZXRzL2JhY2tlbmQuYW5kcm9pZC5idW5kbGUgYXBwL2Fzc2V0cy9iYWNrZW5kLmFuZHJvaWQuYnVuZGxlLm1qcyIKICB9LAogICJkZXBlbmRlbmNpZXMiOiB7CiAgICAiQGlucXVpcmVyL3Byb21wdHMiOiAiXjcuOC4xIiwKICAgICJAcmVhY3QtbmF0aXZlLWFzeW5jLXN0b3JhZ2UvYXN5bmMtc3RvcmFnZSI6ICIyLjIuMCIsCiAgICAiQHJlYWN0LW5hdGl2ZS1jbGlwYm9hcmQvY2xpcGJvYXJkIjogIjEuMTYuMyIsCiAgICAiYXV0b2Jhc2UiOiAiXjcuMjAuMCIsCiAgICAiYXV0b3Bhc3MiOiAiXjIuMi4xIiwKICAgICJiNGEiOiAiXjEuNy4xIiwKICAgICJiYXJlLWNyeXB0byI6ICJeMS4xMi4wIiwKICAgICJiYXJlLWZzIjogIl40LjQuNCIsCiAgICAiYmFyZS1ycGMiOiAiXjAuMi4xMiIsCiAgICAiYmFzZTY0LWpzIjogIl4xLjUuMSIsCiAgICAiYmxpbmQtcGFpcmluZyI6ICJeMi4zLjEiLAogICAgImJsaW5kLXBlZXJpbmciOiAiXjEuMTMuMCIsCiAgICAiY29yZXN0b3JlIjogIl43LjUuMCIsCiAgICAiZXhwbyI6ICJ+NTQuMC4zMSIsCiAgICAiZXhwby1idWlsZC1wcm9wZXJ0aWVzIjogIjEuMC4xMCIsCiAgICAiZXhwby1jb25zdGFudHMiOiAifjE4LjAuMTMiLAogICAgImV4cG8tZmlsZS1zeXN0ZW0iOiAifjE5LjAuMjEiLAogICAgImV4cG8taGFwdGljcyI6ICJ+MTUuMC44IiwKICAgICJleHBvLWxpbmtpbmciOiAiOC4wLjExIiwKICAgICJleHBvLXJvdXRlciI6ICI2LjAuMjEiLAogICAgImV4cG8tc3lzdGVtLXVpIjogIjYuMC45IiwKICAgICJoeXBlcmNvcmUtY3J5cHRvIjogIl4zLjYuMSIsCiAgICAiaHlwZXJkYiI6ICJeNC4xOS4wIiwKICAgICJoeXBlcmRpc3BhdGNoIjogIl4xLjQuNCIsCiAgICAiaHlwZXJzY2hlbWEiOiAiXjEuMTcuMCIsCiAgICAiaHlwZXJzd2FybSI6ICJeNC4xMi4xIiwKICAgICJsdWNpZGUtcmVhY3QtbmF0aXZlIjogIl4wLjU1My4wIiwKICAgICJtYWtlLWRpciI6ICJeNS4xLjAiLAogICAgInByb3RvbXV4LXdha2V1cCI6ICJeMi42LjEiLAogICAgInJlYWN0IjogIjE5LjEuMCIsCiAgICAicmVhY3QtZG9tIjogIjE5LjEuMCIsCiAgICAicmVhY3QtbmF0aXZlIjogIjAuODEuNSIsCiAgICAicmVhY3QtbmF0aXZlLWI0YSI6ICIwLjAuNCIsCiAgICAicmVhY3QtbmF0aXZlLWJhcmUta2l0IjogIjAuMTEuNSIsCiAgICAicmVhY3QtbmF0aXZlLWlhcCI6ICJeMTQuNy43IiwKICAgICJyZWFjdC1uYXRpdmUtcmVhbmltYXRlZCI6ICJ+NC4xLjEiLAogICAgInJlYWN0LW5hdGl2ZS1zYWZlLWFyZWEtY29udGV4dCI6ICI1LjYuMiIsCiAgICAicmVhY3QtbmF0aXZlLXdvcmtsZXRzIjogIjAuNS4xIiwKICAgICJ6MzIiOiAiXjEuMS4wIgogIH0sCiAgImRldkRlcGVuZGVuY2llcyI6IHsKICAgICJAcmVhY3QtbmF0aXZlLWNvbW11bml0eS9jbGkiOiAibGF0ZXN0IiwKICAgICJAdHlwZXMvYjRhIjogIjEuNi41IiwKICAgICJAdHlwZXMvcmVhY3QiOiAiMTkuMi43IiwKICAgICJiYWJlbC1wbHVnaW4tbW9kdWxlLXJlc29sdmVyIjogIl41LjAuMiIsCiAgICAiYmFyZS1wYWNrIjogIjEuNS4xIiwKICAgICJwcmV0dGllciI6ICIzLjcuNCIsCiAgICAicHJldHRpZXItY29uZmlnLWhvbGVwdW5jaCI6ICIyLjAuMCIsCiAgICAidHlwZXNjcmlwdCI6ICI1LjkuMyIKICB9Cn0KZXhwb3J0IGNvbnN0IFJQQ19SRVNFVCA9IDAKZXhwb3J0IGNvbnN0IFJQQ19NRVNTQUdFID0gMQpleHBvcnQgY29uc3QgUlBDX0FERCA9IDIKZXhwb3J0IGNvbnN0IFJQQ19VUERBVEUgPSAzCmV4cG9ydCBjb25zdCBSUENfREVMRVRFID0gNApleHBvcnQgY29uc3QgUlBDX0dFVF9LRVkgPSA1CmV4cG9ydCBjb25zdCBTWU5DX0xJU1QgPSA2CmV4cG9ydCBjb25zdCBSUENfSk9JTl9LRVkgPSA3CmV4cG9ydCBjb25zdCBSUENfQUREX0ZST01fQkFDS0VORCA9IDgKZXhwb3J0IGNvbnN0IFJQQ19VUERBVEVfRlJPTV9CQUNLRU5EID0gOQpleHBvcnQgY29uc3QgUlBDX0RFTEVURV9GUk9NX0JBQ0tFTkQgPSAxMApleHBvcnQgY29uc3QgUlBDX1JFUVVFU1RfU1lOQyA9IDExCmV4cG9ydCBjb25zdCBSUENfQ1JFQVRFX0lOVklURSA9IDEyCg=="];
export default chunks.join('');
